
const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');
const express = require('express');

// === TOKENS proporcionados por ti ===
const TELEGRAM_TOKEN = '7165007562:AAGSnBCz8SK5tH58SGcwyC7ZMxVXjtaz2lI';
const ANKAREX_API_TOKEN = 'MSL3-YQPV-M4LP-ACF3-HNHG-ZMLR-QR7J-6S8U';
const ANKAREX_API = 'https://rest.ankarex.ltd';

// === ADMINISTRADOR ===
const ADMIN_CHAT_ID = 6615027684; // @Balonxsistema

// Inicializar bot
const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });

// Estado por usuario
const estados = {};

// Sistema de cr√©ditos (en memoria - en producci√≥n usar base de datos)
const creditos = {};

// Funci√≥n para obtener cr√©ditos de un usuario
function obtenerCreditos(chatId) {
  return creditos[chatId] || 0;
}

// Funci√≥n para agregar cr√©ditos (solo admin)
function agregarCreditos(chatId, cantidad) {
  if (!creditos[chatId]) creditos[chatId] = 0;
  creditos[chatId] += cantidad;
  return creditos[chatId];
}

// Funci√≥n para usar cr√©ditos
function usarCreditos(chatId, cantidad) {
  if (!creditos[chatId]) creditos[chatId] = 0;
  if (creditos[chatId] >= cantidad) {
    creditos[chatId] -= cantidad;
    return true;
  }
  return false;
}

// Comando para agregar cr√©ditos (solo admin)
bot.onText(/\/agrega(\d+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const cantidadCreditos = parseInt(match[1]);

  // Verificar si es el administrador
  if (chatId !== ADMIN_CHAT_ID) {
    return bot.sendMessage(chatId, '‚ùå No tienes permisos para usar este comando.');
  }

  if (!cantidadCreditos || cantidadCreditos <= 0) {
    return bot.sendMessage(chatId, '‚ùå Cantidad de cr√©ditos inv√°lida. Ejemplo: /agrega100');
  }

  // Guardar la cantidad y esperar el chat ID
  estados[chatId] = {
    esperando: 'chat_id_creditos',
    cantidadCreditos: cantidadCreditos
  };

  bot.sendMessage(chatId, `üí∞ *Agregar ${cantidadCreditos} cr√©ditos*

üìù Env√≠a el *Chat ID* del usuario al que deseas agregar cr√©ditos:

‚ÑπÔ∏è Tip: Los usuarios pueden obtener su Chat ID escribiendo /michatid`, {
    parse_mode: 'Markdown'
  });
});

// Comando para que los usuarios obtengan su Chat ID
bot.onText(/\/michatid/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, `üÜî Tu Chat ID es: \`${chatId}\`

üìã Comp√°rtelo con el administrador para recibir cr√©ditos.`, {
    parse_mode: 'Markdown'
  });
});

// Comando para verificar cr√©ditos
bot.onText(/\/creditos/, (msg) => {
  const chatId = msg.chat.id;
  const creditosUsuario = obtenerCreditos(chatId);
  
  bot.sendMessage(chatId, `üí∞ *Tus cr√©ditos:* ${creditosUsuario}

üí° 1 cr√©dito = 1 mensaje SMS
${creditosUsuario === 0 ? '\n‚ö†Ô∏è Necesitas cr√©ditos para enviar mensajes. Contacta al administrador.' : ''}`, {
    parse_mode: 'Markdown'
  });
});

bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const creditosUsuario = obtenerCreditos(chatId);
  estados[chatId] = {};
  
  bot.sendMessage(chatId, `
üöÄ‚ö°Ô∏è¬°Bienvenido a *SMS Bullet Balonx*‚öΩÔ∏èüì©!‚ö°Ô∏èüöÄ

üí∞ *Cr√©ditos disponibles:* ${creditosUsuario}
üì£ Env√≠o de hasta *250 SMS* por interacci√≥n.

üëâ Por favor, elige una opci√≥n para empezar: üëà
`, {
    parse_mode: 'Markdown',
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üì® Enviar mensaje', callback_data: 'enviar_mensaje' }],
        [{ text: 'üí∞ Ver cr√©ditos', callback_data: 'ver_creditos' }],
        [{ text: 'üÜî Mi Chat ID', callback_data: 'mi_chat_id' }],
        [{ text: 'üìû Contactar', callback_data: 'contactar' }],
        [{ text: '‚ÑπÔ∏è Informaci√≥n', callback_data: 'info' }]
      ]
    }
  });
});

// Manejar callbacks de botones
bot.on('callback_query', async (callbackQuery) => {
  const msg = callbackQuery.message;
  const chatId = msg.chat.id;
  const data = callbackQuery.data;

  // Responder al callback para quitar el "loading"
  bot.answerCallbackQuery(callbackQuery.id);

  if (data === 'ver_creditos') {
    const creditosUsuario = obtenerCreditos(chatId);
    bot.sendMessage(chatId, `üí∞ *Tus cr√©ditos:* ${creditosUsuario}

üí° 1 cr√©dito = 1 mensaje SMS
${creditosUsuario === 0 ? '\n‚ö†Ô∏è Necesitas cr√©ditos para enviar mensajes. Contacta al administrador @Balonxsistema' : ''}`, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Volver al men√∫', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  if (data === 'mi_chat_id') {
    bot.sendMessage(chatId, `üÜî Tu Chat ID es: \`${chatId}\`

üìã Comp√°rtelo con el administrador @Balonxsistema para recibir cr√©ditos.`, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Volver al men√∫', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  if (data === 'enviar_mensaje') {
    const creditosUsuario = obtenerCreditos(chatId);
    
    if (creditosUsuario === 0) {
      bot.sendMessage(chatId, `‚ùå *Sin cr√©ditos*

üí∞ Necesitas cr√©ditos para enviar mensajes.
üÜî Tu Chat ID: \`${chatId}\`

üìû Contacta al administrador @Balonxsistema para obtener cr√©ditos.`, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üîô Volver al men√∫', callback_data: 'menu_principal' }]
          ]
        }
      });
      return;
    }

    estados[chatId] = {};
    bot.sendMessage(chatId, `üí∞ Cr√©ditos disponibles: *${creditosUsuario}*

üî¢ Ingresa tu *prefijo* (ejemplo: \`+52\`):`, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üá≤üáΩ M√©xico (+52)', callback_data: 'prefijo_+52' }],
          [{ text: 'üá∫üá∏ USA (+1)', callback_data: 'prefijo_+1' }],
          [{ text: 'üá®üá¥ Colombia (+57)', callback_data: 'prefijo_+57' }],
          [{ text: '‚úèÔ∏è Escribir otro', callback_data: 'prefijo_manual' }]
        ]
      }
    });
    estados[chatId].esperando = 'prefijo';
    return;
  }

  if (data === 'contactar') {
    bot.sendMessage(chatId, 'üìû Puedes contactar al due√±o del bot en: @Balonxsistema', {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Volver al men√∫', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  if (data === 'info') {
    bot.sendMessage(chatId, `
‚ÑπÔ∏è *Informaci√≥n del Bot*

ü§ñ *SMS Bullet Balonx*
üì± Env√≠a hasta 250 SMS por sesi√≥n
üåê Compatible con m√∫ltiples pa√≠ses
‚ö°Ô∏è Env√≠o r√°pido y confiable
üí∞ Sistema de cr√©ditos (1 cr√©dito = 1 SMS)

üí° *C√≥mo usar:*
1. Obt√©n cr√©ditos del administrador @Balonxsistema
2. Selecciona "Enviar mensaje"
3. Elige tu prefijo de pa√≠s
4. Ingresa los n√∫meros (separados por coma)
5. Escribe tu mensaje
6. ¬°Env√≠a!
`, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Volver al men√∫', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  if (data === 'menu_principal') {
    const creditosUsuario = obtenerCreditos(chatId);
    estados[chatId] = {};
    bot.sendMessage(chatId, `
üöÄ‚ö°Ô∏è¬°Bienvenido a *SMS Bullet Balonx*‚öΩÔ∏èüì©!‚ö°Ô∏èüöÄ

üí∞ *Cr√©ditos disponibles:* ${creditosUsuario}
üì£ Env√≠o de hasta *250 SMS* por interacci√≥n.

üëâ Por favor, elige una opci√≥n para empezar: üëà
`, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üì® Enviar mensaje', callback_data: 'enviar_mensaje' }],
          [{ text: 'üí∞ Ver cr√©ditos', callback_data: 'ver_creditos' }],
          [{ text: 'üÜî Mi Chat ID', callback_data: 'mi_chat_id' }],
          [{ text: 'üìû Contactar', callback_data: 'contactar' }],
          [{ text: '‚ÑπÔ∏è Informaci√≥n', callback_data: 'info' }]
        ]
      }
    });
    return;
  }

  if (data.startsWith('prefijo_')) {
    const prefijo = data.replace('prefijo_', '');
    if (prefijo === 'manual') {
      // Asegurar que el estado existe
      if (!estados[chatId]) estados[chatId] = {};
      estados[chatId].esperando = 'prefijo';
      bot.sendMessage(chatId, '‚úèÔ∏è Escribe tu prefijo personalizado (ejemplo: `+52`):', { parse_mode: 'Markdown' });
      return;
    }
    
    // Asegurar que el estado existe antes de asignar propiedades
    if (!estados[chatId]) estados[chatId] = {};
    estados[chatId].prefijo = prefijo;
    estados[chatId].esperando = 'numeros';
    bot.sendMessage(chatId, `‚úÖ Prefijo seleccionado: *${prefijo}*

üì± Ingresa hasta *250 n√∫meros* separados por coma (sin espacios):

Ej: \`5512345678,5523456789\``, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Cambiar prefijo', callback_data: 'enviar_mensaje' }],
          [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }
});

bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  // Ignorar comandos para evitar interferencia
  if (text && text.startsWith('/')) return;

  const estado = estados[chatId];
  if (!estado) return;

  // MANEJO PARA AGREGAR CR√âDITOS (SOLO ADMIN)
  if (estado.esperando === 'chat_id_creditos' && chatId === ADMIN_CHAT_ID) {
    const targetChatId = parseInt(text);
    if (isNaN(targetChatId)) {
      return bot.sendMessage(chatId, '‚ùå Chat ID inv√°lido. Debe ser un n√∫mero.');
    }

    const creditosAgregados = agregarCreditos(targetChatId, estado.cantidadCreditos);
    
    bot.sendMessage(chatId, `‚úÖ *Cr√©ditos agregados exitosamente*

üë§ Chat ID: ${targetChatId}
üí∞ Cr√©ditos agregados: ${estado.cantidadCreditos}
üí∞ Total de cr√©ditos: ${creditosAgregados}`, {
      parse_mode: 'Markdown'
    });

    // Notificar al usuario que recibi√≥ cr√©ditos
    try {
      bot.sendMessage(targetChatId, `üéâ *¬°Has recibido cr√©ditos!*

üí∞ Cr√©ditos recibidos: ${estado.cantidadCreditos}
üí∞ Total de cr√©ditos: ${creditosAgregados}

üöÄ Ya puedes usar el bot para enviar mensajes SMS.`, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üì® Enviar mensaje', callback_data: 'enviar_mensaje' }],
            [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
          ]
        }
      });
    } catch (error) {
      bot.sendMessage(chatId, `‚ö†Ô∏è Cr√©ditos agregados pero no se pudo notificar al usuario. Puede que haya bloqueado el bot.`);
    }

    delete estados[chatId];
    return;
  }

  // PREFIJO (solo para entrada manual)
  if (estado.esperando === 'prefijo') {
    if (!text.startsWith('+')) {
      return bot.sendMessage(chatId, '‚ùóÔ∏è Prefijo inv√°lido. Aseg√∫rate de incluir el s√≠mbolo `+` (ej: +52)', {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üîô Seleccionar prefijo', callback_data: 'enviar_mensaje' }]
          ]
        }
      });
    }
    estado.prefijo = text;
    estado.esperando = 'numeros';
    bot.sendMessage(chatId, `‚úÖ Prefijo configurado: *${text}*

üì± Ingresa hasta *250 n√∫meros* separados por coma (sin espacios):

Ej: \`5512345678,5523456789\``, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Cambiar prefijo', callback_data: 'enviar_mensaje' }],
          [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  // N√öMEROS
  if (estado.esperando === 'numeros') {
    const numeros = text.split(',').map(n => n.trim()).filter(n => /^\d{10}$/.test(n));
    const creditosUsuario = obtenerCreditos(chatId);
    
    if (numeros.length === 0 || numeros.length > 250) {
      return bot.sendMessage(chatId, `‚ùå Debes ingresar entre 1 y 250 n√∫meros v√°lidos de 10 d√≠gitos, separados por coma.`, {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üîô Cambiar prefijo', callback_data: 'enviar_mensaje' }],
            [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
          ]
        }
      });
    }

    if (numeros.length > creditosUsuario) {
      return bot.sendMessage(chatId, `‚ùå *Cr√©ditos insuficientes*

üì± N√∫meros a enviar: ${numeros.length}
üí∞ Cr√©ditos disponibles: ${creditosUsuario}
‚ùóÔ∏è Necesitas ${numeros.length - creditosUsuario} cr√©ditos m√°s.

üìû Contacta al administrador @Balonxsistema`, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üîô Cambiar n√∫meros', callback_data: 'cambiar_numeros' }],
            [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
          ]
        }
      });
    }

    estado.numeros = numeros;
    estado.esperando = 'mensaje';
    bot.sendMessage(chatId, `‚úÖ *${numeros.length} n√∫meros* configurados correctamente
üí∞ Costo: ${numeros.length} cr√©ditos

‚úèÔ∏è Ingresa el *mensaje* que deseas enviar (m√°x. 160 caracteres):`, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Cambiar n√∫meros', callback_data: 'cambiar_numeros' }],
          [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }

  // MENSAJE
  if (estado.esperando === 'mensaje') {
    if (text.length > 160) {
      return bot.sendMessage(chatId, `‚ùóÔ∏è El mensaje tiene ${text.length} caracteres. Debe ser de m√°ximo 160.`, {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üîô Cambiar n√∫meros', callback_data: 'cambiar_numeros' }],
            [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
          ]
        }
      });
    }

    estado.mensaje = text;
    estado.esperando = 'confirmacion';
    const creditosUsuario = obtenerCreditos(chatId);

    bot.sendMessage(chatId, `
üìã *Resumen de env√≠o:*

üìû Prefijo: \`${estado.prefijo}\`
üì± N√∫meros: *${estado.numeros.length}*
üì© Mensaje: "${estado.mensaje}"
üí∞ Costo: ${estado.numeros.length} cr√©ditos
üí∞ Cr√©ditos actuales: ${creditosUsuario}
üí∞ Cr√©ditos restantes: ${creditosUsuario - estado.numeros.length}

¬øConfirmas el env√≠o?
`, { 
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [
            { text: '‚úÖ Confirmar env√≠o', callback_data: 'confirmar_envio' },
            { text: '‚ùå Cancelar', callback_data: 'menu_principal' }
          ],
          [{ text: '‚úèÔ∏è Editar mensaje', callback_data: 'editar_mensaje' }]
        ]
      }
    });
    return;
  }
});

// Manejar callback de confirmaci√≥n de env√≠o
bot.on('callback_query', async (callbackQuery) => {
  const msg = callbackQuery.message;
  const chatId = msg.chat.id;
  const data = callbackQuery.data;
  
  bot.answerCallbackQuery(callbackQuery.id);

  if (data === 'confirmar_envio') {
    const estado = estados[chatId];
    if (!estado || !estado.mensaje) return;

    const creditosNecesarios = estado.numeros.length;
    const creditosUsuario = obtenerCreditos(chatId);

    // Verificar cr√©ditos antes del env√≠o
    if (creditosUsuario < creditosNecesarios) {
      return bot.sendMessage(chatId, `‚ùå *Cr√©ditos insuficientes*

üí∞ Necesitas: ${creditosNecesarios} cr√©ditos
üí∞ Tienes: ${creditosUsuario} cr√©ditos

üìû Contacta al administrador @Balonxsistema`, {
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
          ]
        }
      });
    }

    bot.sendMessage(chatId, `‚úÖ Enviando mensaje a *${estado.numeros.length} n√∫meros*...
üí∞ Descontando ${creditosNecesarios} cr√©ditos...

üì© Mensaje: "${estado.mensaje}"`, { parse_mode: 'Markdown' });

    // Crear lista de n√∫meros con prefijo para env√≠o bulk
    const numerosCompletos = estado.numeros.map(numero => `${estado.prefijo}${numero}`);
    const numerosString = numerosCompletos.join(',');
    
    let exitosos = 0;
    let fallidos = 0;
    let creditosDescontados = false;
    
    try {
      console.log('Enviando a Ankarex API...');
      console.log('URL:', ANKAREX_API);
      console.log('N√∫meros:', numerosString);
      console.log('Mensaje:', estado.mensaje);
      
      const response = await axios.post(ANKAREX_API, {
        token: ANKAREX_API_TOKEN,
        send: "bulk",
        to: numerosString,
        sender_id: "SMS",
        message_content: estado.mensaje,
        unicode: false
      }, {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'User-Agent': 'Ankarex-Rest-0.22'
        },
        timeout: 30000
      });
      
      console.log('API Response Status:', response.status);
      console.log('API Response Data:', response.data);
      
      if (response.status === 200 && response.data) {
        // Ankarex responde con diferentes formatos exitosos:
        // Formato 1: {"error": "false", "info": "CAMPAIGN_SENT", "id": 4}
        // Formato 2: {"info": "SENT", "campaign_id": 562498}
        const isSuccess = (
          (response.data.error === "false") || 
          (response.data.info === "SENT") || 
          (response.data.info === "CAMPAIGN_SENT") ||
          (response.data.campaign_id)
        );
        
        if (isSuccess) {
          exitosos = estado.numeros.length;
          // Descontar cr√©ditos solo si el env√≠o fue exitoso
          usarCreditos(chatId, creditosNecesarios);
          creditosDescontados = true;
          const campaignId = response.data.id || response.data.campaign_id || 'N/A';
          console.log(`‚úÖ Campa√±a enviada exitosamente. ID: ${campaignId}`);
        } else {
          fallidos = estado.numeros.length;
          console.log(`‚ùå Error en API: ${response.data.info || 'Error desconocido'}`);
        }
      } else {
        fallidos = estado.numeros.length;
        console.log(`‚ö†Ô∏è Respuesta no exitosa:`, response.data);
      }
    } catch (err) {
      fallidos = estado.numeros.length;
      console.error(`‚ùå Error al enviar:`, err.response?.data || err.message);
      
      // Log detallado del error para debugging
      if (err.response) {
        console.error(`Status: ${err.response.status}`);
        console.error(`Headers:`, err.response.headers);
        console.error(`Data:`, err.response.data);
      } else {
        console.error('Error de conexi√≥n:', err.message);
      }
    }

    const creditosRestantes = obtenerCreditos(chatId);

    bot.sendMessage(chatId, `üìä *Resumen de env√≠o:*

‚úÖ Exitosos: ${exitosos}
‚ùå Fallidos: ${fallidos}
üì± Total: ${estado.numeros.length}
üí∞ Cr√©ditos ${creditosDescontados ? 'descontados' : 'conservados'}: ${creditosDescontados ? creditosNecesarios : 0}
üí∞ Cr√©ditos restantes: ${creditosRestantes}

${exitosos > 0 ? 'üéâ ¬°Env√≠o completado!' : '‚ö†Ô∏è Revisa la configuraci√≥n de la API'}`, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üì® Enviar otro mensaje', callback_data: 'enviar_mensaje' }],
          [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
        ]
      }
    });
    delete estados[chatId];
    return;
  }

  if (data === 'editar_mensaje') {
    const estado = estados[chatId];
    if (!estado) return;
    
    estado.esperando = 'mensaje';
    bot.sendMessage(chatId, '‚úèÔ∏è Ingresa el nuevo *mensaje* (m√°x. 160 caracteres):', {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Volver al resumen', callback_data: 'volver_resumen' }]
        ]
      }
    });
    return;
  }

  if (data === 'cambiar_numeros') {
    const estado = estados[chatId];
    if (!estado) return;
    
    estado.esperando = 'numeros';
    const creditosUsuario = obtenerCreditos(chatId);
    bot.sendMessage(chatId, `üì± Ingresa los nuevos n√∫meros (hasta 250, separados por coma):
üí∞ Cr√©ditos disponibles: ${creditosUsuario}

Prefijo actual: *${estado.prefijo}*

Ej: \`5512345678,5523456789\``, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [
          [{ text: 'üîô Cambiar prefijo', callback_data: 'enviar_mensaje' }],
          [{ text: 'üè† Men√∫ principal', callback_data: 'menu_principal' }]
        ]
      }
    });
    return;
  }
});

// HTTP server for Autoscale deployment
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.json());
app.use(express.static('.'));

// Servir la interfaz web
app.get('/', (req, res) => {
  res.sendFile(__dirname + '/web.html');
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ 
    status: 'Bot is running', 
    timestamp: new Date().toISOString(),
    name: 'SMS Bullet Balonx'
  });
});

// API endpoint para enviar SMS desde la web
app.post('/api/send-sms', async (req, res) => {
  try {
    const { prefix, phoneNumbers, message } = req.body;

    // Validaciones
    if (!prefix || !prefix.startsWith('+')) {
      return res.status(400).json({ success: false, message: 'Prefijo inv√°lido' });
    }

    if (!phoneNumbers || !Array.isArray(phoneNumbers) || phoneNumbers.length === 0) {
      return res.status(400).json({ success: false, message: 'N√∫meros de tel√©fono requeridos' });
    }

    if (phoneNumbers.length > 250) {
      return res.status(400).json({ success: false, message: 'M√°ximo 250 n√∫meros permitidos' });
    }

    if (!message || message.length > 160) {
      return res.status(400).json({ success: false, message: 'Mensaje inv√°lido (m√°x. 160 caracteres)' });
    }

    // Crear lista de n√∫meros con prefijo
    const numerosCompletos = phoneNumbers.map(numero => `${prefix}${numero}`);
    const numerosString = numerosCompletos.join(',');
    
    console.log('üåê Enviando SMS desde interfaz web...');
    console.log('üì± N√∫meros:', numerosString);
    console.log('üí¨ Mensaje:', message);
    
    // Enviar a la API de Ankarex
    const response = await axios.post(ANKAREX_API, {
      token: ANKAREX_API_TOKEN,
      send: "bulk",
      to: numerosString,
      sender_id: "SMS",
      message_content: message,
      unicode: false
    }, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'User-Agent': 'Ankarex-Rest-0.22'
      },
      timeout: 30000
    });
    
    console.log('üì° API Response Status:', response.status);
    console.log('üì° API Response Data:', response.data);
    
    if (response.status === 200 && response.data) {
      const isSuccess = (
        (response.data.error === "false") || 
        (response.data.info === "SENT") || 
        (response.data.info === "CAMPAIGN_SENT") ||
        (response.data.campaign_id)
      );
      
      if (isSuccess) {
        const campaignId = response.data.id || response.data.campaign_id || 'N/A';
        console.log(`‚úÖ Campa√±a web enviada exitosamente. ID: ${campaignId}`);
        
        return res.json({ 
          success: true, 
          sent: phoneNumbers.length,
          campaignId: campaignId,
          message: 'SMS enviados exitosamente' 
        });
      } else {
        console.log(`‚ùå Error en API web: ${response.data.info || 'Error desconocido'}`);
        return res.status(400).json({ 
          success: false, 
          message: response.data.info || 'Error en el env√≠o' 
        });
      }
    } else {
      console.log(`‚ö†Ô∏è Respuesta no exitosa web:`, response.data);
      return res.status(500).json({ 
        success: false, 
        message: 'Error en la API de SMS' 
      });
    }
  } catch (error) {
    console.error(`‚ùå Error al enviar SMS web:`, error.response?.data || error.message);
    
    return res.status(500).json({ 
      success: false, 
      message: 'Error interno del servidor' 
    });
  }
});

// Start HTTP server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`üåê HTTP server listening on port ${PORT}`);
  console.log(`üåç Interfaz web disponible en: http://localhost:${PORT}`);
  console.log('ü§ñ Bot SMS Bullet Balonx iniciado correctamente con sistema de cr√©ditos...');
});
